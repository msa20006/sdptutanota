{"version":3,"file":"SearchUtils.js","sourceRoot":"","sources":["../../../../../../src/calendar-app/calendar/search/model/SearchUtils.ts"],"names":[],"mappings":"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","sourcesContent":["import m from \"mithril\"\nimport {\n\tbase64ToBase64Url,\n\tbase64UrlToBase64,\n\tdecodeBase64,\n\tfilterInt,\n\tgetEndOfDay,\n\tgetStartOfDay,\n\tincrementMonth,\n\tstringToBase64,\n} from \"@tutao/tutanota-utils\"\nimport { RouteSetFn, throttleRoute } from \"../../../../common/misc/RouteChange\"\nimport type { SearchRestriction } from \"../../../../common/api/worker/search/SearchTypes\"\nimport { assertMainOrNode } from \"../../../../common/api/common/Env\"\nimport { CalendarEvent, CalendarEventTypeRef } from \"../../../../common/api/entities/tutanota/TypeRefs\"\nimport { getElementId } from \"../../../../common/api/common/utils/EntityUtils.js\"\n\nassertMainOrNode()\n\nconst FIXED_FREE_SEARCH_DAYS = 28\n\nexport const enum SearchCategoryTypes {\n\tcalendar = \"calendar\",\n}\n\nconst routeSetThrottled: RouteSetFn = throttleRoute()\n\nexport function setSearchUrl(url: string) {\n\tif (url !== m.route.get()) {\n\t\trouteSetThrottled(url, {})\n\t}\n}\n\nexport function getSearchUrl(\n\tquery: string | null,\n\trestriction: SearchRestriction,\n\tselectionKey: string | null,\n): {\n\tpath: string\n\tparams: Record<string, string | number | Array<string>>\n} {\n\tconst params: Record<string, string | number | Array<string>> = {\n\t\tquery: query ?? \"\",\n\t\tcategory: SearchCategoryTypes.calendar,\n\t}\n\t// a bit annoying but avoids putting unnecessary things into the url (if we woudl put undefined into it)\n\tif (restriction.start) {\n\t\tparams.start = restriction.start\n\t}\n\tif (restriction.end) {\n\t\tparams.end = restriction.end\n\t}\n\tif (restriction.folderIds.length > 0) {\n\t\tparams.folder = restriction.folderIds\n\t}\n\n\tif (restriction.eventSeries != null) {\n\t\tparams.eventSeries = String(restriction.eventSeries)\n\t}\n\n\treturn {\n\t\tpath: \"/search/:category\" + (selectionKey ? \"/\" + selectionKey : \"\"),\n\t\tparams: params,\n\t}\n}\n\n/**\n * Adjusts the restriction according to the account type if necessary\n */\nexport function createRestriction(start: number | null, end: number | null, folderIds: Array<string>, eventSeries: boolean): SearchRestriction {\n\treturn {\n\t\ttype: CalendarEventTypeRef,\n\t\tstart: start,\n\t\tend: end,\n\t\tfield: null,\n\t\tattributeIds: null,\n\t\tfolderIds,\n\t\teventSeries,\n\t}\n}\n\n/**\n * Adjusts the restriction according to the account type if necessary\n */\nexport function getRestriction(route: string): SearchRestriction {\n\tlet start: number | null = null\n\tlet end: number | null = null\n\tlet folderIds: Array<string> = []\n\tlet eventSeries: boolean = true\n\n\tif (route.startsWith(\"/calendar\") || route.startsWith(\"/search/calendar\")) {\n\t\tconst { params } = m.parsePathname(route)\n\n\t\ttry {\n\t\t\tif (typeof params[\"eventSeries\"] === \"boolean\") {\n\t\t\t\teventSeries = params[\"eventSeries\"]\n\t\t\t}\n\n\t\t\tif (typeof params[\"start\"] === \"string\") {\n\t\t\t\tstart = filterInt(params[\"start\"])\n\t\t\t}\n\n\t\t\tif (typeof params[\"end\"] === \"string\") {\n\t\t\t\tend = filterInt(params[\"end\"])\n\t\t\t}\n\n\t\t\tconst folder = params[\"folder\"]\n\t\t\tif (Array.isArray(folder)) {\n\t\t\t\tfolderIds = folder\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tconsole.log(\"invalid query: \" + route, e)\n\t\t}\n\n\t\tif (start == null) {\n\t\t\tconst now = new Date()\n\t\t\tnow.setDate(1)\n\t\t\tstart = getStartOfDay(now).getTime()\n\t\t}\n\n\t\tif (end == null) {\n\t\t\tconst endDate = incrementMonth(new Date(start), 3)\n\t\t\tendDate.setDate(0)\n\t\t\tend = getEndOfDay(endDate).getTime()\n\t\t}\n\t} else {\n\t\tthrow new Error(\"invalid type \" + route)\n\t}\n\n\treturn createRestriction(start, end, folderIds, eventSeries)\n}\n\nexport function decodeCalendarSearchKey(searchKey: string): { id: Id; start: number } {\n\treturn JSON.parse(decodeBase64(\"utf-8\", base64UrlToBase64(searchKey))) as { id: Id; start: number }\n}\n\nexport function encodeCalendarSearchKey(event: CalendarEvent): string {\n\tconst eventStartTime = event.startTime.getTime()\n\treturn base64ToBase64Url(stringToBase64(JSON.stringify({ start: eventStartTime, id: getElementId(event) })))\n}\n"]}