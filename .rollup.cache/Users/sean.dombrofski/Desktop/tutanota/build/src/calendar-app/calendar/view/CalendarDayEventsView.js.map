{"version":3,"file":"CalendarDayEventsView.js","sourceRoot":"","sources":["../../../../../src/calendar-app/calendar/view/CalendarDayEventsView.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { ChildArray, Children, Component, Vnode } from \"mithril\"\nimport { px, size } from \"../../../common/gui/size\"\nimport { DAY_IN_MILLIS, downcast, getEndOfDay, getStartOfDay, mapNullable, neverNull, numberRange } from \"@tutao/tutanota-utils\"\nimport {\n\teventEndsAfterDay,\n\teventStartsBefore,\n\tgetTimeTextFormatForLongEvent,\n\tgetTimeZone,\n\thasAlarmsForTheUser,\n\tisClientOnlyCalendar,\n} from \"../../../common/calendar/date/CalendarUtils\"\nimport { CalendarEventBubble } from \"./CalendarEventBubble\"\nimport type { CalendarEvent } from \"../../../common/api/entities/tutanota/TypeRefs.js\"\nimport { Time } from \"../../../common/calendar/date/Time.js\"\nimport { getPosAndBoundsFromMouseEvent } from \"../../../common/gui/base/GuiUtils\"\nimport {\n\tEventLayoutMode,\n\texpandEvent,\n\tformatEventTime,\n\tgetEventColor,\n\tgetDisplayEventTitle,\n\tgetTimeFromMousePos,\n\tlayOutEvents,\n\tTEMPORARY_EVENT_OPACITY,\n} from \"../gui/CalendarGuiUtils.js\"\nimport type { CalendarEventBubbleClickHandler, CalendarEventBubbleKeyDownHandler } from \"./CalendarViewModel\"\nimport type { GroupColors } from \"./CalendarView\"\nimport { styles } from \"../../../common/gui/styles\"\nimport { locator } from \"../../../common/api/main/CommonLocator.js\"\nimport { CalendarTimeIndicator } from \"./CalendarTimeIndicator.js\"\nimport { listIdPart } from \"../../../common/api/common/utils/EntityUtils.js\"\n\nexport type Attrs = {\n\tonEventClicked: CalendarEventBubbleClickHandler\n\tonEventKeyDown: CalendarEventBubbleKeyDownHandler\n\tgroupColors: GroupColors\n\tevents: Array<CalendarEvent>\n\tdisplayTimeIndicator: boolean\n\tonTimePressed: (hours: number, minutes: number) => unknown\n\tonTimeContextPressed: (hours: number, minutes: number) => unknown\n\tday: Date\n\tsetCurrentDraggedEvent: (ev: CalendarEvent) => unknown\n\tsetTimeUnderMouse: (time: Time) => unknown\n\tisTemporaryEvent: (event: CalendarEvent) => boolean\n\tisDragging: boolean\n\tfullViewWidth?: number\n\tdisabled?: boolean\n}\nexport const calendarDayTimes: Array<Time> = numberRange(0, 23).map((number) => new Time(number, 0))\nconst allHoursHeight = size.calendar_hour_height * calendarDayTimes.length\n\nexport class CalendarDayEventsView implements Component<Attrs> {\n\tprivate dayDom: HTMLElement | null = null\n\n\tview({ attrs }: Vnode<Attrs>): Children {\n\t\treturn m(\n\t\t\t\".col.rel\",\n\t\t\t{\n\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\tthis.dayDom = vnode.dom as HTMLElement\n\t\t\t\t\tm.redraw()\n\t\t\t\t},\n\t\t\t\tonmousemove: (mouseEvent: MouseEvent) => {\n\t\t\t\t\tdowncast(mouseEvent).redraw = false\n\t\t\t\t\tconst time = getTimeFromMousePos(getPosAndBoundsFromMouseEvent(mouseEvent), 4)\n\t\t\t\t\tattrs.setTimeUnderMouse(time)\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tcalendarDayTimes.map((time) =>\n\t\t\t\t\tm(\".calendar-hour.flex.cursor-pointer\", {\n\t\t\t\t\t\tonclick: (e: MouseEvent) => {\n\t\t\t\t\t\t\te.stopPropagation()\n\t\t\t\t\t\t\tconst { hour, minute } = getTimeFromClickInteraction(e, time)\n\t\t\t\t\t\t\tattrs.onTimePressed(hour, minute)\n\t\t\t\t\t\t},\n\t\t\t\t\t\toncontextmenu: (e: MouseEvent) => {\n\t\t\t\t\t\t\tconst { hour, minute } = getTimeFromClickInteraction(e, time)\n\t\t\t\t\t\t\tattrs.onTimeContextPressed(hour, minute)\n\t\t\t\t\t\t\te.preventDefault()\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t),\n\t\t\t\tthis.dayDom ? this.renderEvents(attrs, attrs.events) : null,\n\t\t\t\tthis.renderTimeIndicator(attrs),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderTimeIndicator(attrs: Attrs): Children {\n\t\tconst now = new Date()\n\n\t\tif (!attrs.displayTimeIndicator) {\n\t\t\treturn null\n\t\t}\n\n\t\tconst top = getTimeIndicatorPosition(now)\n\t\treturn m(\".abs\", { style: { top: px(top), left: 0, right: 0 } }, m(CalendarTimeIndicator))\n\t}\n\n\tprivate renderEvents(attrs: Attrs, events: Array<CalendarEvent>): Children {\n\t\treturn layOutEvents(events, getTimeZone(), (columns) => this.renderColumns(attrs, columns), EventLayoutMode.TimeBasedColumn)\n\t}\n\n\tprivate renderEvent(attrs: Attrs, ev: CalendarEvent, columnIndex: number, columns: Array<Array<CalendarEvent>>, columnWidth: number): Children {\n\t\t// If an event starts in the previous day or ends in the next, we want to clamp top/height to fit within just this day\n\t\tconst zone = getTimeZone()\n\t\tconst startOfEvent = eventStartsBefore(attrs.day, zone, ev) ? getStartOfDay(attrs.day) : ev.startTime\n\t\tconst endOfEvent = eventEndsAfterDay(attrs.day, zone, ev) ? getEndOfDay(attrs.day) : ev.endTime\n\t\tconst startTime = (startOfEvent.getHours() * 60 + startOfEvent.getMinutes()) * 60 * 1000\n\t\tconst height = ((endOfEvent.getTime() - startOfEvent.getTime()) / (1000 * 60 * 60)) * size.calendar_hour_height - size.calendar_event_border\n\t\tconst fullViewWidth = attrs.fullViewWidth\n\t\tconst maxWidth = fullViewWidth != null ? px(styles.isDesktopLayout() ? fullViewWidth / 2 : fullViewWidth) : \"none\"\n\t\tconst colSpan = expandEvent(ev, columnIndex, columns)\n\t\tconst eventTitle = getDisplayEventTitle(ev.summary)\n\t\treturn m(\n\t\t\t\".abs.darker-hover\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\tmaxWidth,\n\t\t\t\t\tleft: px(columnWidth * columnIndex),\n\t\t\t\t\twidth: px(columnWidth * colSpan),\n\t\t\t\t\ttop: px((startTime / DAY_IN_MILLIS) * allHoursHeight),\n\t\t\t\t\theight: px(height),\n\t\t\t\t},\n\t\t\t\tonmousedown: () => {\n\t\t\t\t\tif (!attrs.isTemporaryEvent(ev)) {\n\t\t\t\t\t\tattrs.setCurrentDraggedEvent(ev)\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\tm(CalendarEventBubble, {\n\t\t\t\ttext: eventTitle,\n\t\t\t\tsecondLineText: mapNullable(getTimeTextFormatForLongEvent(ev, attrs.day, attrs.day, zone), (option) => formatEventTime(ev, option)),\n\t\t\t\tcolor: getEventColor(ev, attrs.groupColors),\n\t\t\t\tclick: (domEvent) => attrs.onEventClicked(ev, domEvent),\n\t\t\t\tkeyDown: (domEvent) => attrs.onEventKeyDown(ev, domEvent),\n\t\t\t\theight: height - size.calendar_day_event_padding,\n\t\t\t\thasAlarm: hasAlarmsForTheUser(locator.logins.getUserController().user, ev),\n\t\t\t\tisAltered: ev.recurrenceId != null,\n\t\t\t\tverticalPadding: size.calendar_day_event_padding,\n\t\t\t\tfadeIn: !attrs.isTemporaryEvent(ev),\n\t\t\t\topacity: attrs.isTemporaryEvent(ev) ? TEMPORARY_EVENT_OPACITY : 1,\n\t\t\t\tenablePointerEvents: !attrs.isTemporaryEvent(ev) && !attrs.isDragging && !attrs.disabled,\n\t\t\t\tisClientOnly: isClientOnlyCalendar(listIdPart(ev._id)),\n\t\t\t}),\n\t\t)\n\t}\n\n\tprivate renderColumns(attrs: Attrs, columns: Array<Array<CalendarEvent>>): ChildArray {\n\t\tconst columnWidth = neverNull(this.dayDom).clientWidth / columns.length\n\t\treturn columns.map((column, index) => {\n\t\t\treturn column.map((event) => {\n\t\t\t\treturn this.renderEvent(attrs, event, index, columns, Math.floor(columnWidth))\n\t\t\t})\n\t\t})\n\t}\n}\n\nfunction getTimeIndicatorPosition(now: Date): number {\n\tconst passedMillisInDay = (now.getHours() * 60 + now.getMinutes()) * 60 * 1000\n\treturn (passedMillisInDay / DAY_IN_MILLIS) * allHoursHeight\n}\n\nfunction getTimeFromClickInteraction(e: MouseEvent, time: Time): Time {\n\tconst rect = (e.target as HTMLElement).getBoundingClientRect()\n\tconst mousePositionRelativeToRectHeight = Math.abs(rect.top - e.clientY)\n\tif (mousePositionRelativeToRectHeight > rect.height / 2) return new Time(time.hour, time.minute + 30)\n\treturn time\n}\n"]}