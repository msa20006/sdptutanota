{"version":3,"file":"EditCalendarDialog.js","sourceRoot":"","sources":["../../../../../src/calendar-app/calendar/gui/EditCalendarDialog.ts"],"names":[],"mappings":"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","sourcesContent":["import { Dialog } from \"../../../common/gui/base/Dialog.js\"\nimport m, { Children } from \"mithril\"\nimport stream from \"mithril/stream\"\nimport Stream from \"mithril/stream\"\nimport { TextField, TextFieldType } from \"../../../common/gui/base/TextField.js\"\nimport { lang, type TranslationKey } from \"../../../common/misc/LanguageViewModel.js\"\nimport type { TranslationKeyType } from \"../../../common/misc/TranslationKey.js\"\nimport { deepEqual, isNotNull } from \"@tutao/tutanota-utils\"\nimport { AlarmInterval, CalendarType, isExternalCalendarType, isNormalCalendarType } from \"../../../common/calendar/date/CalendarUtils.js\"\nimport { RemindersEditor } from \"./RemindersEditor.js\"\nimport { checkURLString, isIcal } from \"../../../common/calendar/import/ImportExportUtils.js\"\nimport { locator } from \"../../../common/api/main/CommonLocator.js\"\nimport type { CalendarModel } from \"../model/CalendarModel.js\"\nimport { DEFAULT_ERROR } from \"../../../common/api/common/TutanotaConstants.js\"\nimport { LoginButton } from \"../../../common/gui/base/buttons/LoginButton.js\"\nimport { ColorPickerView } from \"../../../common/gui/base/colorPicker/ColorPickerView\"\nimport { generateRandomColor } from \"./CalendarGuiUtils.js\"\n\nexport type CalendarProperties = {\n\tname: string\n\tcolor: string\n\talarms: AlarmInterval[]\n\tsourceUrl: string | null\n}\n\nexport const defaultCalendarProperties: CalendarProperties = {\n\tname: \"\",\n\tcolor: \"\",\n\talarms: [],\n\tsourceUrl: \"\",\n}\n\nexport async function handleUrlSubscription(calendarModel: CalendarModel, url: string): Promise<string | Error> {\n\tif (!locator.logins.isFullyLoggedIn()) return new Error(\"notFullyLoggedIn_msg\")\n\n\tconst externalIcalStr: string | Error = await calendarModel.fetchExternalCalendar(url).catch((e) => e as Error)\n\tif (externalIcalStr instanceof Error || externalIcalStr.trim() === \"\") return new Error(\"fetchingExternalCalendar_error\")\n\n\tif (!isIcal(externalIcalStr)) return new Error(\"invalidICal_error\")\n\treturn externalIcalStr\n}\n\nfunction sourceUrlInputField(urlStream: Stream<string>, errorMessageStream: Stream<string>) {\n\tconst errorMessage = errorMessageStream().trim()\n\tlet helperMessage = \"\"\n\tif (urlStream().trim() === \"\") helperMessage = \"E.g: https://tuta.com/ics/example.ics\"\n\telse if (isNotNull(errorMessage) && errorMessage !== DEFAULT_ERROR) helperMessage = errorMessage\n\treturn m(TextField, {\n\t\tclass: `pt pb ${helperMessage.length ? \"\" : \"mb-small-line-height\"}`,\n\t\tvalue: urlStream(),\n\t\toninput: (url: string, inputElement: HTMLInputElement) => {\n\t\t\tconst assertionResult = checkURLString(url)\n\t\t\turlStream(url)\n\t\t\tif (assertionResult instanceof URL) {\n\t\t\t\terrorMessageStream(\"\")\n\t\t\t\treturn\n\t\t\t}\n\t\t\terrorMessageStream(lang.get(assertionResult))\n\t\t},\n\t\tlabel: \"url_label\",\n\t\ttype: TextFieldType.Url,\n\t\thelpLabel: () => m(\"small.block.content-fg\", helperMessage),\n\t})\n}\n\nfunction createEditCalendarComponent(\n\tnameStream: Stream<string>,\n\tcolorStream: Stream<string>,\n\tshared: boolean,\n\tcalendarType: CalendarType,\n\talarms: AlarmInterval[],\n\turlStream: Stream<string>,\n\terrorMessageStream: Stream<string>,\n) {\n\treturn m.fragment({}, [\n\t\tm(TextField, {\n\t\t\tvalue: nameStream(),\n\t\t\toninput: nameStream,\n\t\t\tlabel: \"calendarName_label\",\n\t\t}),\n\t\tm(\".small.mt.mb-xs\", lang.get(\"color_label\")),\n\t\tm(ColorPickerView, {\n\t\t\tvalue: colorStream(),\n\t\t\tonselect: (color: string) => {\n\t\t\t\tcolorStream(color)\n\t\t\t},\n\t\t}),\n\t\t!shared && isNormalCalendarType(calendarType)\n\t\t\t? m(RemindersEditor, {\n\t\t\t\t\talarms,\n\t\t\t\t\taddAlarm: (alarm: AlarmInterval) => {\n\t\t\t\t\t\talarms?.push(alarm)\n\t\t\t\t\t},\n\t\t\t\t\tremoveAlarm: (alarm: AlarmInterval) => {\n\t\t\t\t\t\tconst index = alarms?.findIndex((a: AlarmInterval) => deepEqual(a, alarm))\n\t\t\t\t\t\tif (index !== -1) alarms?.splice(index, 1)\n\t\t\t\t\t},\n\t\t\t\t\tlabel: \"calendarDefaultReminder_label\",\n\t\t\t\t\tuseNewEditor: false,\n\t\t\t  })\n\t\t\t: null,\n\t\tisExternalCalendarType(calendarType) ? sourceUrlInputField(urlStream, errorMessageStream) : null,\n\t])\n}\n\nexport interface CreateEditDialogAttrs {\n\tcalendarType: CalendarType\n\ttitleTextId: TranslationKeyType\n\tshared: boolean\n\tokAction: (dialog: Dialog, calendarProperties: CalendarProperties, calendarModel?: CalendarModel) => unknown\n\tokTextId: TranslationKeyType\n\twarningMessage?: () => Children\n\tcalendarProperties?: CalendarProperties\n\tisNewCalendar?: boolean\n\tcalendarModel?: CalendarModel\n}\n\nexport function showCreateEditCalendarDialog({\n\tcalendarType,\n\ttitleTextId,\n\tshared,\n\tokAction,\n\tokTextId,\n\twarningMessage,\n\tcalendarProperties: { name, color, alarms, sourceUrl } = defaultCalendarProperties,\n\tisNewCalendar = true,\n\tcalendarModel,\n}: CreateEditDialogAttrs) {\n\tif (color !== \"\") {\n\t\tcolor = \"#\" + color\n\t} else if (isNewCalendar && isExternalCalendarType(calendarType)) {\n\t\tcolor = generateRandomColor()\n\t}\n\n\tconst nameStream = stream(name)\n\tconst colorStream = stream(color)\n\tconst urlStream = stream(sourceUrl ?? \"\")\n\tconst errorMessageStream = stream(DEFAULT_ERROR)\n\n\tconst externalCalendarValidator = async () => {\n\t\tconst assertionResult = checkURLString(urlStream())\n\n\t\tif (!calendarModel) throw new Error(\"Missing model\")\n\n\t\tif (assertionResult instanceof URL) {\n\t\t\tconst externalCalendarResult: string | Error = await handleUrlSubscription(calendarModel, urlStream())\n\t\t\tif (externalCalendarResult instanceof Error) return externalCalendarResult.message as TranslationKey\n\t\t} else {\n\t\t\treturn assertionResult as TranslationKey\n\t\t}\n\t\treturn null\n\t}\n\n\tconst doAction = async (dialog: Dialog) => {\n\t\tokAction(\n\t\t\tdialog,\n\t\t\t{\n\t\t\t\tname: nameStream(),\n\t\t\t\tcolor: colorStream().substring(1),\n\t\t\t\talarms,\n\t\t\t\tsourceUrl: urlStream().trim(),\n\t\t\t},\n\t\t\tcalendarModel,\n\t\t)\n\t}\n\n\tconst externalCalendarDialogProps = {\n\t\ttitle: \"\",\n\t\tchild: {\n\t\t\tview: () =>\n\t\t\t\tm(\".flex.col\", [\n\t\t\t\t\tm(\".mt.mb.h6.b\", lang.get(titleTextId)),\n\t\t\t\t\twarningMessage ? warningMessage() : null,\n\t\t\t\t\tsourceUrlInputField(urlStream, errorMessageStream),\n\t\t\t\t\tm(LoginButton, {\n\t\t\t\t\t\tlabel: okTextId,\n\t\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\t\texternalCalendarValidator()\n\t\t\t\t\t\t\t\t.then((validatorResult) => {\n\t\t\t\t\t\t\t\t\tif (validatorResult) {\n\t\t\t\t\t\t\t\t\t\tDialog.message(validatorResult as TranslationKey)\n\t\t\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tdoAction(dialog)\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.catch((e) => Dialog.message(lang.makeTranslation(\"error_message\", e.message)))\n\t\t\t\t\t\t},\n\t\t\t\t\t\tclass: errorMessageStream().trim() !== \"\" ? \"mt-s no-hover button-bg\" : \"mt-s\",\n\t\t\t\t\t\tdisabled: errorMessageStream().trim() !== \"\",\n\t\t\t\t\t}),\n\t\t\t\t]),\n\t\t},\n\t\tokAction: null,\n\t}\n\n\tconst dialog = Dialog.createActionDialog(\n\t\tObject.assign(\n\t\t\t{\n\t\t\t\tallowOkWithReturn: true,\n\t\t\t\tokActionTextId: okTextId,\n\t\t\t\ttitle: titleTextId,\n\t\t\t\tchild: {\n\t\t\t\t\tview: () =>\n\t\t\t\t\t\tm(\".flex.col\", [\n\t\t\t\t\t\t\twarningMessage ? warningMessage() : null,\n\t\t\t\t\t\t\tcreateEditCalendarComponent(nameStream, colorStream, shared, calendarType, alarms, urlStream, errorMessageStream),\n\t\t\t\t\t\t]),\n\t\t\t\t},\n\t\t\t\tokAction: doAction,\n\t\t\t},\n\t\t\tisNewCalendar && isExternalCalendarType(calendarType) ? externalCalendarDialogProps : {},\n\t\t),\n\t)\n\tdialog.show()\n}\n"]}