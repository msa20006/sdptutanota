{"version":3,"file":"CalendarEventPopup.js","sourceRoot":"","sources":["../../../../../../src/calendar-app/calendar/gui/eventpopup/CalendarEventPopup.ts"],"names":[],"mappings":"AACA,OAAO,CAAe,MAAM,SAAS,CAAA;AACrC,OAAO,EAAE,EAAE,EAAE,MAAM,gCAAgC,CAAA;AAGnD,OAAO,EAAE,KAAK,EAAE,MAAM,sCAAsC,CAAA;AAC5D,OAAO,EAAE,gBAAgB,EAAyB,MAAM,uBAAuB,CAAA;AAC/E,OAAO,EAAE,MAAM,EAAE,MAAM,uCAAuC,CAAA;AAC9D,OAAO,EAAE,mBAAmB,EAAE,eAAe,EAAW,YAAY,EAAE,MAAM,yCAAyC,CAAA;AACrH,OAAO,EAAE,IAAI,EAAE,MAAM,oDAAoD,CAAA;AAEzE,OAAO,EAAE,0BAA0B,EAAE,MAAM,mDAAmD,CAAA;AAE9F,OAAO,EAAE,UAAU,EAAE,MAAM,2CAA2C,CAAA;AACtE,OAAO,EAAE,iBAAiB,EAAE,MAAM,sCAAsC,CAAA;AAExE,OAAO,EAAE,eAAe,EAAE,MAAM,wBAAwB,CAAA;AAExD;;;;;;;;;GASG;AACH,MAAM,OAAO,kBAAkB;IAWD;IAAuD;IAVnE,UAAU,GAAe,EAAE,CAAA;IAC3B,oBAAoB,CAAQ;IACrC,GAAG,GAAuB,IAAI,CAAA;IAC9B,kBAAkB,GAAuB,IAAI,CAAA;IAErD;;;;OAIG;IACH,YAA6B,KAAoC,EAAmB,eAAwB,EAAE,aAA4B;QAA7G,UAAK,GAAL,KAAK,CAA+B;QAAmB,oBAAe,GAAf,eAAe,CAAS;QAC3G,qIAAqI;QACrI,IAAI,CAAC,oBAAoB,GAAG,0BAA0B,CACrD,KAAK,CAAC,aAAa,CAAC,WAAW,EAC/B,CAAC,CAAC,EAAE,EAAE,CACL,aAAa,CAAC,YAAY,CAAC,iBAAiB,CAAC,CAAC,CAAC,EAAE;YAChD,oBAAoB,EAAE,IAAI;SAC1B,CAAC,CAAC,IAAI,CACR,CAAA;QAED,IAAI,CAAC,cAAc,EAAE,CAAA;QACrB,IAAI,CAAC,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;IACjC,CAAC;IAEgB,uBAAuB,GAAoD,KAAK,EAAE,EAAc,EAAE,QAAqB,EAAE,EAAE;QAC3I,eAAe,CAAC,IAAI,CAAC,KAAK,EAAE,EAAE,EAAE,QAAQ,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC,CAAA;IAC9D,CAAC,CAAA;IAEgB,qBAAqB,GAAoD,CAAC,EAAc,EAAE,QAAqB,EAAE,EAAE;QACnI,IAAI,IAAI,CAAC,KAAK,CAAC,qBAAqB,EAAE,CAAC;YACtC,mBAAmB,CAAC;gBACnB,WAAW,EAAE,GAAG,EAAE,CACjB,OAAO,CAAC,OAAO,CAAC;oBACf;wBACC,KAAK,EAAE,+BAA+B;wBACtC,KAAK,EAAE,GAAG,EAAE;4BACX,wCAAwC;4BACxC,IAAI,CAAC,KAAK,CAAC,UAAU,EAAE,CAAA;4BACvB,IAAI,CAAC,KAAK,EAAE,CAAA;wBACb,CAAC;qBACD;oBACD;wBACC,KAAK,EAAE,gCAAgC;wBACvC,KAAK,EAAE,GAAG,EAAE;4BACX,wCAAwC;4BACxC,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,CAAA;4BACpB,IAAI,CAAC,KAAK,EAAE,CAAA;wBACb,CAAC;qBACD;iBACD,CAAC;gBACH,KAAK,EAAE,GAAG;aACV,CAAC,CAAC,EAAE,EAAE,QAAQ,CAAC,CAAA;QACjB,CAAC;aAAM,CAAC;YACP,wCAAwC;YACxC,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,CAAA;YACpB,IAAI,CAAC,KAAK,EAAE,CAAA;QACb,CAAC;IACF,CAAC,CAAA;IAED,0EAA0E;IACzD,sBAAsB,GAAe,KAAK,IAAI,EAAE;QAChE,MAAM,SAAS,GAAG,MAAM,MAAM,CAAC,OAAO,CAAC,iBAAiB,CAAC,CAAA;QACzD,IAAI,SAAS;YAAE,MAAM,IAAI,CAAC,KAAK,CAAC,WAAW,EAAE,CAAA;QAC7C,IAAI,CAAC,KAAK,EAAE,CAAA;IACb,CAAC,CAAA;IAED,IAAI;QACH,OAAO,CAAC,CACP,wEAAwE,EACxE;YACC,KAAK,EAAE;gBACN,2DAA2D;gBAC3D,KAAK,EAAE,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,UAAU,GAAG,eAAe,GAAG,CAAC,EAAE,GAAG,CAAC,CAAC;gBACjE,6BAA6B;gBAC7B,OAAO,EAAE,GAAG;gBACZ,mEAAmE;gBACnE,MAAM,EAAE,KAAK;aACb;YACD,QAAQ,EAAE,CAAC,KAAK,EAAE,EAAE;gBACnB,IAAI,CAAC,GAAG,GAAG,KAAK,CAAC,GAAkB,CAAA;gBACnC,qHAAqH;gBACrH,QAAQ;gBACR,UAAU,CAAC,GAAG,EAAE;oBACf,YAAY,CAAC,IAAI,CAAC,eAAe,EAAE,IAAI,CAAC,GAAI,EAAE,IAAI,CAAC,GAAI,CAAC,YAAY,EAAE,GAAG,CAAC,CAAA;oBAC1E,oEAAoE;oBACpE,MAAM,WAAW,GAAG,KAAK,CAAC,GAAG,CAAC,iBAAiB,EAAE,iBAA4C,CAAA;oBAC7F,WAAW,EAAE,KAAK,EAAE,CAAA;gBACrB,CAAC,EAAE,EAAE,CAAC,CAAA;YACP,CAAC;SACD,EACD;YACC,CAAC,CAAC,gBAAgB,EAAE,CAAC,IAAI,CAAC,sBAAsB,EAAE,EAAE,IAAI,CAAC,gBAAgB,EAAE,EAAE,IAAI,CAAC,kBAAkB,EAAE,EAAE,IAAI,CAAC,iBAAiB,EAAE,CAAC,CAAC;YAClI,CAAC,CAAC,qCAAqC,EAAE;gBACxC,CAAC,CAAC,gBAAgB,EAAE;oBACnB,KAAK,EAAE,IAAI,CAAC,KAAK,CAAC,aAAa;oBAC/B,oBAAoB,EAAE,IAAI,CAAC,oBAAoB;oBAC/C,0EAA0E;oBAC1E,+EAA+E;oBAC/E,kCAAkC;oBAClC,aAAa,EAAE,IAAI,CAAC,KAAK,CAAC,6BAA6B,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC;iBAC3C,CAAC;aAClC,CAAC;SACF,CACD,CAAA;IACF,CAAC;IAEO,gBAAgB;QACvB,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,OAAO;YAAE,OAAO,IAAI,CAAA;QACpC,OAAO,CAAC,CAAC,UAAU,EAAE,EAAE,KAAK,EAAE,aAAa,EAAE,IAAI,yBAAY,EAAE,KAAK,EAAE,IAAI,CAAC,qBAAqB,EAAE,CAAC,CAAA;IACpG,CAAC;IAEO,kBAAkB;QACzB,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS;YAAE,OAAO,IAAI,CAAA;QACtC,OAAO,CAAC,CAAC,UAAU,EAAE,EAAE,KAAK,EAAE,eAAe,EAAE,IAAI,2BAAa,EAAE,KAAK,EAAE,IAAI,CAAC,uBAAuB,EAAE,CAAC,CAAA;IACzG,CAAC;IAEO,sBAAsB;QAC7B,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,cAAc;YAAE,OAAO,IAAI,CAAA;QAC3C,OAAO,CAAC,CAAC,UAAU,EAAE;YACpB,KAAK,EAAE,mBAAmB;YAC1B,KAAK,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,sBAAsB,EAAE;YAC1C,IAAI,6BAAgB;SACpB,CAAC,CAAA;IACH,CAAC;IAEO,iBAAiB;QACxB,OAAO,CAAC,CAAC,UAAU,EAAE;YACpB,KAAK,EAAE,WAAW;YAClB,KAAK,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,EAAE;YACzB,IAAI,6BAAc;SAClB,CAAC,CAAA;IACH,CAAC;IAED,IAAI;QACH,IAAI,CAAC,kBAAkB,GAAG,QAAQ,CAAC,aAA4B,CAAA;QAC/D,KAAK,CAAC,OAAO,CAAC,IAAI,EAAE,KAAK,CAAC,CAAA;IAC3B,CAAC;IAEO,KAAK;QACZ,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,CAAA;IACnB,CAAC;IAED,eAAe,CAAC,CAAa;QAC5B,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,CAAA;IACnB,CAAC;IAED,aAAa;QACZ,OAAO,OAAO,CAAC,OAAO,EAAE,CAAA;IACzB,CAAC;IAED,OAAO;QACN,IAAI,CAAC,KAAK,EAAE,CAAA;IACb,CAAC;IAED,SAAS;QACR,OAAO,IAAI,CAAC,UAAU,CAAA;IACvB,CAAC;IAED,QAAQ,CAAC,CAAQ;QAChB,KAAK,CAAC,MAAM,CAAC,IAAI,CAAC,CAAA;QAClB,OAAO,KAAK,CAAA;IACb,CAAC;IAED,cAAc;QACb,OAAO,IAAI,CAAC,kBAAkB,CAAA;IAC/B,CAAC;IAEO,cAAc;QACrB,MAAM,KAAK,GAAa;YACvB,GAAG,EAAE,IAAI,CAAC,GAAG;YACb,IAAI,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,EAAE;YACxB,IAAI,EAAE,WAAW;SACjB,CAAA;QACD,MAAM,IAAI,GAAa;YACtB,GAAG,EAAE,IAAI,CAAC,CAAC;YACX,IAAI,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,qBAAqB,CAAC,IAAI,UAAU,CAAC,OAAO,EAAE,EAAE,CAAC,EAAE,IAAI,CAAC,GAAI,CAAC;YAC9E,IAAI,EAAE,aAAa;SACnB,CAAA;QACD,MAAM,WAAW,GAAa;YAC7B,GAAG,EAAE,IAAI,CAAC,CAAC;YACX,IAAI,EAAE,IAAI,CAAC,sBAAsB;YACjC,IAAI,EAAE,mBAAmB;SACzB,CAAA;QACD,MAAM,MAAM,GAAa;YACxB,GAAG,EAAE,IAAI,CAAC,MAAM;YAChB,IAAI,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,uBAAuB,CAAC,IAAI,UAAU,CAAC,OAAO,EAAE,EAAE,CAAC,EAAE,IAAI,CAAC,GAAI,CAAC;YAChF,IAAI,EAAE,eAAe;SACrB,CAAA;QAED,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,KAAK,CAAC,CAAA;QAE3B,IAAI,IAAI,CAAC,KAAK,CAAC,cAAc,EAAE,CAAC;YAC/B,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,WAAW,CAAC,CAAA;QAClC,CAAC;QAED,IAAI,IAAI,CAAC,KAAK,CAAC,OAAO,EAAE,CAAC;YACxB,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAA;QAC3B,CAAC;QAED,IAAI,IAAI,CAAC,KAAK,CAAC,SAAS,EAAE,CAAC;YAC1B,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,MAAM,CAAC,CAAA;QAC7B,CAAC;IACF,CAAC;CACD","sourcesContent":["import type { Shortcut } from \"../../../../common/misc/KeyManager.js\"\nimport m, { Children } from \"mithril\"\nimport { px } from \"../../../../common/gui/size.js\"\nimport { Icons } from \"../../../../common/gui/base/icons/Icons.js\"\nimport type { ModalComponent } from \"../../../../common/gui/base/Modal.js\"\nimport { modal } from \"../../../../common/gui/base/Modal.js\"\nimport { EventPreviewView, EventPreviewViewAttrs } from \"./EventPreviewView.js\"\nimport { Dialog } from \"../../../../common/gui/base/Dialog.js\"\nimport { createAsyncDropdown, DROPDOWN_MARGIN, PosRect, showDropdown } from \"../../../../common/gui/base/Dropdown.js\"\nimport { Keys } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport type { HtmlSanitizer } from \"../../../../common/misc/HtmlSanitizer.js\"\nimport { prepareCalendarDescription } from \"../../../../common/calendar/date/CalendarUtils.js\"\nimport { BootIcons } from \"../../../../common/gui/base/icons/BootIcons.js\"\nimport { IconButton } from \"../../../../common/gui/base/IconButton.js\"\nimport { convertTextToHtml } from \"../../../../common/misc/Formatter.js\"\nimport { CalendarEventPreviewViewModel } from \"./CalendarEventPreviewViewModel.js\"\nimport { showDeletePopup } from \"../CalendarGuiUtils.js\"\n\n/**\n * small modal displaying all relevant information about an event in a compact fashion. offers limited editing capabilities to participants in the\n * form of quick response buttons to set attendance and adding exclusions.\n *\n * It is the first line of defense against invalid edit operations since it's the only way to open a\n * calendar editor for an event that's not brand new or to delete an event/parts of it.\n *\n * it is also responsible for divining the users intent before starting any operations so we can make sure we have the right\n * information available, like when editing all event occurrences or only some.\n */\nexport class CalendarEventPopup implements ModalComponent {\n\tprivate readonly _shortcuts: Shortcut[] = []\n\tprivate readonly sanitizedDescription: string\n\tprivate dom: HTMLElement | null = null\n\tprivate focusedBeforeShown: HTMLElement | null = null\n\n\t/**\n\t * @param model\n\t * @param eventBubbleRect the rect where the event bubble was displayed that was clicked (if any)\n\t * @param htmlSanitizer\n\t */\n\tconstructor(private readonly model: CalendarEventPreviewViewModel, private readonly eventBubbleRect: PosRect, htmlSanitizer: HtmlSanitizer) {\n\t\t// We receive the HtmlSanitizer from outside and do the sanitization inside, so that we don't have to just assume it was already done\n\t\tthis.sanitizedDescription = prepareCalendarDescription(\n\t\t\tmodel.calendarEvent.description,\n\t\t\t(s) =>\n\t\t\t\thtmlSanitizer.sanitizeHTML(convertTextToHtml(s), {\n\t\t\t\t\tblockExternalContent: true,\n\t\t\t\t}).html,\n\t\t)\n\n\t\tthis.setupShortcuts()\n\t\tthis.view = this.view.bind(this)\n\t}\n\n\tprivate readonly handleDeleteButtonClick: (ev: MouseEvent, receiver: HTMLElement) => void = async (ev: MouseEvent, receiver: HTMLElement) => {\n\t\tshowDeletePopup(this.model, ev, receiver, () => this.close())\n\t}\n\n\tprivate readonly handleEditButtonClick: (ev: MouseEvent, receiver: HTMLElement) => void = (ev: MouseEvent, receiver: HTMLElement) => {\n\t\tif (this.model.isRepeatingForEditing) {\n\t\t\tcreateAsyncDropdown({\n\t\t\t\tlazyButtons: () =>\n\t\t\t\t\tPromise.resolve([\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: \"updateOneCalendarEvent_action\",\n\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t// noinspection JSIgnoredPromiseFromCall\n\t\t\t\t\t\t\t\tthis.model.editSingle()\n\t\t\t\t\t\t\t\tthis.close()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: \"updateAllCalendarEvents_action\",\n\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t// noinspection JSIgnoredPromiseFromCall\n\t\t\t\t\t\t\t\tthis.model.editAll()\n\t\t\t\t\t\t\t\tthis.close()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t]),\n\t\t\t\twidth: 300,\n\t\t\t})(ev, receiver)\n\t\t} else {\n\t\t\t// noinspection JSIgnoredPromiseFromCall\n\t\t\tthis.model.editAll()\n\t\t\tthis.close()\n\t\t}\n\t}\n\n\t// we handle askForUpdates here to avoid making a request if not necessary\n\tprivate readonly handleSendUpdatesClick: () => void = async () => {\n\t\tconst confirmed = await Dialog.confirm(\"sendUpdates_msg\")\n\t\tif (confirmed) await this.model.sendUpdates()\n\t\tthis.close()\n\t}\n\n\tview(): Children {\n\t\treturn m(\n\t\t\t\".abs.elevated-bg.plr.pb.border-radius.dropdown-shadow.flex.flex-column\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\t// minus margin, need to apply it now to not overflow later\n\t\t\t\t\twidth: px(Math.min(window.innerWidth - DROPDOWN_MARGIN * 2, 400)),\n\t\t\t\t\t// see hack description below\n\t\t\t\t\topacity: \"0\",\n\t\t\t\t\t// because calendar event bubbles have 1px border, we want to align\n\t\t\t\t\tmargin: \"1px\",\n\t\t\t\t},\n\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\tthis.dom = vnode.dom as HTMLElement\n\t\t\t\t\t// This is a hack to get \"natural\" view size but render it without opacity first and then show dropdown with inferred\n\t\t\t\t\t// size.\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tshowDropdown(this.eventBubbleRect, this.dom!, this.dom!.offsetHeight, 400)\n\t\t\t\t\t\t// Move the keyboard focus into the popup's buttons when it is shown\n\t\t\t\t\t\tconst firstButton = vnode.dom.firstElementChild?.firstElementChild as HTMLInputElement | null\n\t\t\t\t\t\tfirstButton?.focus()\n\t\t\t\t\t}, 24)\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(\".flex.flex-end\", [this.renderSendUpdateButton(), this.renderEditButton(), this.renderDeleteButton(), this.renderCloseButton()]),\n\t\t\t\tm(\".flex-grow.scroll.visible-scrollbar\", [\n\t\t\t\t\tm(EventPreviewView, {\n\t\t\t\t\t\tevent: this.model.calendarEvent,\n\t\t\t\t\t\tsanitizedDescription: this.sanitizedDescription,\n\t\t\t\t\t\t// closing this since repeated edit operations from the popup would always\n\t\t\t\t\t\t// use the version of the event the popup was opened with, which means the next\n\t\t\t\t\t\t// click uses an outdated version.\n\t\t\t\t\t\tparticipation: this.model.getParticipationSetterAndThen(() => this.close()),\n\t\t\t\t\t} satisfies EventPreviewViewAttrs),\n\t\t\t\t]),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderEditButton(): Children {\n\t\tif (!this.model.canEdit) return null\n\t\treturn m(IconButton, { title: \"edit_action\", icon: Icons.Edit, click: this.handleEditButtonClick })\n\t}\n\n\tprivate renderDeleteButton(): Children {\n\t\tif (!this.model.canDelete) return null\n\t\treturn m(IconButton, { title: \"delete_action\", icon: Icons.Trash, click: this.handleDeleteButtonClick })\n\t}\n\n\tprivate renderSendUpdateButton(): Children {\n\t\tif (!this.model.canSendUpdates) return null\n\t\treturn m(IconButton, {\n\t\t\ttitle: \"sendUpdates_label\",\n\t\t\tclick: () => this.handleSendUpdatesClick(),\n\t\t\ticon: BootIcons.Mail,\n\t\t})\n\t}\n\n\tprivate renderCloseButton(): Children {\n\t\treturn m(IconButton, {\n\t\t\ttitle: \"close_alt\",\n\t\t\tclick: () => this.close(),\n\t\t\ticon: Icons.Cancel,\n\t\t})\n\t}\n\n\tshow() {\n\t\tthis.focusedBeforeShown = document.activeElement as HTMLElement\n\t\tmodal.display(this, false)\n\t}\n\n\tprivate close() {\n\t\tmodal.remove(this)\n\t}\n\n\tbackgroundClick(e: MouseEvent): void {\n\t\tmodal.remove(this)\n\t}\n\n\thideAnimation(): Promise<void> {\n\t\treturn Promise.resolve()\n\t}\n\n\tonClose(): void {\n\t\tthis.close()\n\t}\n\n\tshortcuts(): Shortcut[] {\n\t\treturn this._shortcuts\n\t}\n\n\tpopState(e: Event): boolean {\n\t\tmodal.remove(this)\n\t\treturn false\n\t}\n\n\tcallingElement(): HTMLElement | null {\n\t\treturn this.focusedBeforeShown\n\t}\n\n\tprivate setupShortcuts() {\n\t\tconst close: Shortcut = {\n\t\t\tkey: Keys.ESC,\n\t\t\texec: () => this.close(),\n\t\t\thelp: \"close_alt\",\n\t\t}\n\t\tconst edit: Shortcut = {\n\t\t\tkey: Keys.E,\n\t\t\texec: () => this.handleEditButtonClick(new MouseEvent(\"click\", {}), this.dom!),\n\t\t\thelp: \"edit_action\",\n\t\t}\n\t\tconst sendUpdates: Shortcut = {\n\t\t\tkey: Keys.R,\n\t\t\texec: this.handleSendUpdatesClick,\n\t\t\thelp: \"sendUpdates_label\",\n\t\t}\n\t\tconst remove: Shortcut = {\n\t\t\tkey: Keys.DELETE,\n\t\t\texec: () => this.handleDeleteButtonClick(new MouseEvent(\"click\", {}), this.dom!),\n\t\t\thelp: \"delete_action\",\n\t\t}\n\n\t\tthis._shortcuts.push(close)\n\n\t\tif (this.model.canSendUpdates) {\n\t\t\tthis._shortcuts.push(sendUpdates)\n\t\t}\n\n\t\tif (this.model.canEdit) {\n\t\t\tthis._shortcuts.push(edit)\n\t\t}\n\n\t\tif (this.model.canDelete) {\n\t\t\tthis._shortcuts.push(remove)\n\t\t}\n\t}\n}\n"]}