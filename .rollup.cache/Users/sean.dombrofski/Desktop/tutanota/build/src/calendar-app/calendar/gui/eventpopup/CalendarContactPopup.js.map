{"version":3,"file":"CalendarContactPopup.js","sourceRoot":"","sources":["../../../../../../src/calendar-app/calendar/gui/eventpopup/CalendarContactPopup.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Shortcut } from \"../../../../common/misc/KeyManager.js\"\nimport m, { Children } from \"mithril\"\nimport { px } from \"../../../../common/gui/size.js\"\nimport { Icons } from \"../../../../common/gui/base/icons/Icons.js\"\nimport type { ModalComponent } from \"../../../../common/gui/base/Modal.js\"\nimport { modal } from \"../../../../common/gui/base/Modal.js\"\nimport { DROPDOWN_MARGIN, PosRect, showDropdown } from \"../../../../common/gui/base/Dropdown.js\"\nimport { Keys } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport { IconButton } from \"../../../../common/gui/base/IconButton.js\"\nimport { CalendarContactPreviewViewModel } from \"./CalendarContactPreviewViewModel.js\"\nimport { ContactPreviewView } from \"./ContactPreviewView.js\"\nimport { client } from \"../../../../common/misc/ClientDetector.js\"\nimport { ContactEditor } from \"../../../../mail-app/contacts/ContactEditor.js\"\nimport { locator } from \"../../../../common/api/main/CommonLocator.js\"\nimport { listIdPart } from \"../../../../common/api/common/utils/EntityUtils.js\"\nimport { stringToBase64 } from \"@tutao/tutanota-utils\"\nimport { calendarLocator } from \"../../../calendarLocator.js\"\nimport { Dialog } from \"../../../../common/gui/base/Dialog.js\"\n\n/**\n * small modal displaying all relevant information about a contact in a compact fashion. offers limited editing capabilities to participants in the\n * form with quick action buttons such as edit contact.\n */\nexport class ContactEventPopup implements ModalComponent {\n\tprivate readonly _shortcuts: Shortcut[] = []\n\tprivate dom: HTMLElement | null = null\n\tprivate focusedBeforeShown: HTMLElement | null = null\n\n\t/**\n\t * @param model\n\t * @param eventBubbleRect the rect where the event bubble was displayed that was clicked (if any)\n\t */\n\tconstructor(private readonly model: CalendarContactPreviewViewModel, private readonly eventBubbleRect: PosRect) {\n\t\tthis.setupShortcuts()\n\t\tthis.view = this.view.bind(this)\n\t}\n\n\tprivate readonly handleEditButtonClick: (ev: MouseEvent, receiver: HTMLElement) => void = async (ev: MouseEvent, receiver: HTMLElement) => {\n\t\tif (client.isCalendarApp()) {\n\t\t\tif (!(await Dialog.confirm(\"openMailApp_msg\", \"yes_label\"))) return\n\n\t\t\tconst query = `contactId=${stringToBase64(this.model.contact._id.join(\"/\"))}`\n\t\t\tcalendarLocator.systemFacade.openMailApp(stringToBase64(query))\n\t\t\treturn\n\t\t}\n\t\tnew ContactEditor(locator.entityClient, this.model.contact, listIdPart(this.model.contact._id), m.redraw).show()\n\t}\n\n\tview(): Children {\n\t\treturn m(\n\t\t\t\".abs.elevated-bg.plr.pb.border-radius.dropdown-shadow.flex.flex-column\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\t// minus margin, need to apply it now to not overflow later\n\t\t\t\t\twidth: px(Math.min(window.innerWidth - DROPDOWN_MARGIN * 2, 400)),\n\t\t\t\t\t// see hack description below\n\t\t\t\t\topacity: \"0\",\n\t\t\t\t\t// because calendar event bubbles have 1px border, we want to align\n\t\t\t\t\tmargin: \"1px\",\n\t\t\t\t},\n\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\tthis.dom = vnode.dom as HTMLElement\n\t\t\t\t\t// This is a hack to get \"natural\" view size but render it without opacity first and then show dropdown with inferred\n\t\t\t\t\t// size.\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tshowDropdown(this.eventBubbleRect, this.dom!, this.dom!.offsetHeight, 400)\n\t\t\t\t\t\t// Move the keyboard focus into the popup's buttons when it is shown\n\t\t\t\t\t\tconst firstButton = vnode.dom.firstElementChild?.firstElementChild as HTMLInputElement | null\n\t\t\t\t\t\tfirstButton?.focus()\n\t\t\t\t\t}, 24)\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(\".flex.flex-end\", [this.renderEditButton(), this.renderCloseButton()]),\n\t\t\t\tm(\".flex-grow\", [\n\t\t\t\t\tm(ContactPreviewView, {\n\t\t\t\t\t\tevent: this.model.event,\n\t\t\t\t\t\tcontact: this.model.contact,\n\t\t\t\t\t}),\n\t\t\t\t]),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderEditButton(): Children {\n\t\tif (!this.model.canEdit) return null\n\t\treturn m(IconButton, { title: \"edit_action\", icon: Icons.ManageContact, click: this.handleEditButtonClick })\n\t}\n\n\tprivate renderCloseButton(): Children {\n\t\treturn m(IconButton, {\n\t\t\ttitle: \"close_alt\",\n\t\t\tclick: () => this.close(),\n\t\t\ticon: Icons.Cancel,\n\t\t})\n\t}\n\n\tshow() {\n\t\tthis.focusedBeforeShown = document.activeElement as HTMLElement\n\t\tmodal.display(this, false)\n\t}\n\n\tprivate close() {\n\t\tmodal.remove(this)\n\t}\n\n\tbackgroundClick(e: MouseEvent): void {\n\t\tmodal.remove(this)\n\t}\n\n\thideAnimation(): Promise<void> {\n\t\treturn Promise.resolve()\n\t}\n\n\tonClose(): void {\n\t\tthis.close()\n\t}\n\n\tshortcuts(): Shortcut[] {\n\t\treturn this._shortcuts\n\t}\n\n\tpopState(e: Event): boolean {\n\t\tmodal.remove(this)\n\t\treturn false\n\t}\n\n\tcallingElement(): HTMLElement | null {\n\t\treturn this.focusedBeforeShown\n\t}\n\n\tprivate setupShortcuts() {\n\t\tconst close: Shortcut = {\n\t\t\tkey: Keys.ESC,\n\t\t\texec: () => this.close(),\n\t\t\thelp: \"close_alt\",\n\t\t}\n\t\tconst edit: Shortcut = {\n\t\t\tkey: Keys.E,\n\t\t\texec: () => this.handleEditButtonClick(new MouseEvent(\"click\", {}), this.dom!),\n\t\t\thelp: \"edit_action\",\n\t\t}\n\n\t\tthis._shortcuts.push(close)\n\n\t\tif (this.model.canEdit) {\n\t\t\tthis._shortcuts.push(edit)\n\t\t}\n\t}\n}\n"]}