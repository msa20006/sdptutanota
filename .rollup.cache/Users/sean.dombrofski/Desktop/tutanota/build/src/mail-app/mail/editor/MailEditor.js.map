{"version":3,"file":"MailEditor.js","sourceRoot":"","sources":["../../../../../src/mail-app/mail/editor/MailEditor.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Children, Component, Vnode } from \"mithril\"\nimport stream from \"mithril/stream\"\nimport Stream from \"mithril/stream\"\nimport { Editor, ImagePasteEvent } from \"../../../common/gui/editor/Editor\"\nimport type { Attachment, InitAsResponseArgs, SendMailModel } from \"../../../common/mailFunctionality/SendMailModel.js\"\nimport { Dialog } from \"../../../common/gui/base/Dialog\"\nimport { InfoLink, lang } from \"../../../common/misc/LanguageViewModel\"\nimport type { MailboxDetail } from \"../../../common/mailFunctionality/MailboxModel.js\"\nimport { checkApprovalStatus } from \"../../../common/misc/LoginUtils\"\nimport { locator } from \"../../../common/api/main/CommonLocator\"\nimport {\n\tALLOWED_IMAGE_FORMATS,\n\tConversationType,\n\tExternalImageRule,\n\tFeatureType,\n\tKeys,\n\tMailAuthenticationStatus,\n\tMailMethod,\n} from \"../../../common/api/common/TutanotaConstants\"\nimport { TooManyRequestsError } from \"../../../common/api/common/error/RestError\"\nimport type { DialogHeaderBarAttrs } from \"../../../common/gui/base/DialogHeaderBar\"\nimport { ButtonType } from \"../../../common/gui/base/Button.js\"\nimport { attachDropdown, createDropdown, DropdownChildAttrs } from \"../../../common/gui/base/Dropdown.js\"\nimport { isApp, isBrowser, isDesktop } from \"../../../common/api/common/Env\"\nimport { Icons } from \"../../../common/gui/base/icons/Icons\"\nimport { AnimationPromise, animations, height, opacity } from \"../../../common/gui/animation/Animations\"\nimport type { TextFieldAttrs } from \"../../../common/gui/base/TextField.js\"\nimport { Autocomplete, TextField } from \"../../../common/gui/base/TextField.js\"\nimport { chooseAndAttachFile, cleanupInlineAttachments, createAttachmentBubbleAttrs, getConfidentialStateMessage } from \"./MailEditorViewModel\"\nimport { ExpanderPanel } from \"../../../common/gui/base/Expander\"\nimport { windowFacade } from \"../../../common/misc/WindowFacade\"\nimport { UserError } from \"../../../common/api/main/UserError\"\nimport { showProgressDialog } from \"../../../common/gui/dialogs/ProgressDialog\"\nimport { htmlSanitizer } from \"../../../common/misc/HtmlSanitizer\"\nimport { DropDownSelector } from \"../../../common/gui/base/DropDownSelector.js\"\nimport {\n\tContact,\n\tContactTypeRef,\n\tcreateTranslationGetIn,\n\tFile as TutanotaFile,\n\tMail,\n\tMailboxProperties,\n\tMailDetails,\n} from \"../../../common/api/entities/tutanota/TypeRefs.js\"\nimport { FileOpenError } from \"../../../common/api/common/error/FileOpenError\"\nimport type { lazy } from \"@tutao/tutanota-utils\"\nimport { assertNotNull, cleanMatch, downcast, isNotNull, noOp, ofClass, typedValues } from \"@tutao/tutanota-utils\"\nimport { createInlineImage, isMailContrastFixNeeded, replaceCidsWithInlineImages, replaceInlineImagesWithCids } from \"../view/MailGuiUtils\"\nimport { client } from \"../../../common/misc/ClientDetector\"\nimport { appendEmailSignature } from \"../signature/Signature\"\nimport { showTemplatePopupInEditor } from \"../../templates/view/TemplatePopup\"\nimport { registerTemplateShortcutListener } from \"../../templates/view/TemplateShortcutListener\"\nimport { TemplatePopupModel } from \"../../templates/model/TemplatePopupModel\"\nimport { createKnowledgeBaseDialogInjection } from \"../../knowledgebase/view/KnowledgeBaseDialog\"\nimport { KnowledgeBaseModel } from \"../../knowledgebase/model/KnowledgeBaseModel\"\nimport { styles } from \"../../../common/gui/styles\"\nimport { showMinimizedMailEditor } from \"../view/MinimizedMailEditorOverlay\"\nimport { SaveErrorReason, SaveStatus, SaveStatusEnum } from \"../model/MinimizedMailEditorViewModel\"\nimport { fileListToArray, FileReference, isTutanotaFile } from \"../../../common/api/common/utils/FileUtils\"\nimport { parseMailtoUrl } from \"../../../common/misc/parsing/MailAddressParser\"\nimport { CancelledError } from \"../../../common/api/common/error/CancelledError\"\nimport { Shortcut } from \"../../../common/misc/KeyManager\"\nimport { Recipients, RecipientType } from \"../../../common/api/common/recipients/Recipient\"\nimport { showUserError } from \"../../../common/misc/ErrorHandlerImpl\"\nimport { MailRecipientsTextField } from \"../../../common/gui/MailRecipientsTextField.js\"\nimport { getContactDisplayName } from \"../../../common/contactsFunctionality/ContactUtils.js\"\nimport { ResolvableRecipient } from \"../../../common/api/main/RecipientsModel\"\n\nimport { animateToolbar, RichTextToolbar } from \"../../../common/gui/base/RichTextToolbar.js\"\nimport { readLocalFiles } from \"../../../common/file/FileController\"\nimport { IconButton, IconButtonAttrs } from \"../../../common/gui/base/IconButton.js\"\nimport { ToggleButton, ToggleButtonAttrs } from \"../../../common/gui/base/buttons/ToggleButton.js\"\nimport { BootIcons } from \"../../../common/gui/base/icons/BootIcons.js\"\nimport { ButtonSize } from \"../../../common/gui/base/ButtonSize.js\"\nimport { DialogInjectionRightAttrs } from \"../../../common/gui/base/DialogInjectionRight.js\"\nimport { KnowledgebaseDialogContentAttrs } from \"../../knowledgebase/view/KnowledgeBaseDialogContent.js\"\nimport { RecipientsSearchModel } from \"../../../common/misc/RecipientsSearchModel.js\"\nimport { createDataFile, DataFile } from \"../../../common/api/common/DataFile.js\"\nimport { AttachmentBubble } from \"../../../common/gui/AttachmentBubble.js\"\nimport { ContentBlockingStatus } from \"../view/MailViewerViewModel.js\"\nimport { canSeeTutaLinks } from \"../../../common/gui/base/GuiUtils.js\"\nimport { BannerButtonAttrs, InfoBanner } from \"../../../common/gui/base/InfoBanner.js\"\nimport { isCustomizationEnabledForCustomer } from \"../../../common/api/common/utils/CustomerUtils.js\"\nimport { isOfflineError } from \"../../../common/api/common/utils/ErrorUtils.js\"\nimport { TranslationService } from \"../../../common/api/entities/tutanota/Services.js\"\nimport { PasswordField } from \"../../../common/misc/passwords/PasswordField.js\"\nimport { InlineImages } from \"../../../common/mailFunctionality/inlineImagesUtils.js\"\nimport {\n\tcheckAttachmentSize,\n\tcreateNewContact,\n\tdialogTitleTranslationKey,\n\tgetEnabledMailAddressesWithUser,\n\tgetMailAddressDisplayText,\n\tRecipientField,\n} from \"../../../common/mailFunctionality/SharedMailUtils.js\"\nimport { mailLocator } from \"../../mailLocator.js\"\n\nimport { handleRatingByEvent } from \"../../../common/ratings/InAppRatingDialog.js\"\n\nexport type MailEditorAttrs = {\n\tmodel: SendMailModel\n\tdoBlockExternalContent: Stream<boolean>\n\tdoShowToolbar: Stream<boolean>\n\tonload?: (editor: Editor) => void\n\tonclose?: (...args: Array<any>) => any\n\tselectedNotificationLanguage: Stream<string>\n\tdialog: lazy<Dialog>\n\ttemplateModel: TemplatePopupModel | null\n\tknowledgeBaseInjection: (editor: Editor) => Promise<DialogInjectionRightAttrs<KnowledgebaseDialogContentAttrs> | null>\n\tsearch: RecipientsSearchModel\n\talwaysBlockExternalContent: boolean\n}\n\nexport function createMailEditorAttrs(\n\tmodel: SendMailModel,\n\tdoBlockExternalContent: boolean,\n\tdoFocusEditorOnLoad: boolean,\n\tdialog: lazy<Dialog>,\n\ttemplateModel: TemplatePopupModel | null,\n\tknowledgeBaseInjection: (editor: Editor) => Promise<DialogInjectionRightAttrs<KnowledgebaseDialogContentAttrs> | null>,\n\tsearch: RecipientsSearchModel,\n\talwaysBlockExternalContent: boolean,\n): MailEditorAttrs {\n\treturn {\n\t\tmodel,\n\t\tdoBlockExternalContent: stream(doBlockExternalContent),\n\t\tdoShowToolbar: stream<boolean>(false),\n\t\tselectedNotificationLanguage: stream(\"\"),\n\t\tdialog,\n\t\ttemplateModel,\n\t\tknowledgeBaseInjection: knowledgeBaseInjection,\n\t\tsearch,\n\t\talwaysBlockExternalContent,\n\t}\n}\n\nexport class MailEditor implements Component<MailEditorAttrs> {\n\tprivate attrs: MailEditorAttrs\n\n\teditor: Editor\n\n\tprivate readonly recipientFieldTexts = {\n\t\tto: stream(\"\"),\n\t\tcc: stream(\"\"),\n\t\tbcc: stream(\"\"),\n\t}\n\n\tmentionedInlineImages: Array<string>\n\tinlineImageElements: Array<HTMLElement>\n\ttemplateModel: TemplatePopupModel | null\n\tknowledgeBaseInjection: DialogInjectionRightAttrs<KnowledgebaseDialogContentAttrs> | null = null\n\tsendMailModel: SendMailModel\n\tprivate areDetailsExpanded: boolean\n\tprivate recipientShowConfidential: Map<string, boolean> = new Map()\n\tprivate blockExternalContent: boolean\n\tprivate readonly alwaysBlockExternalContent: boolean = false\n\t// if we're set to block external content, but there is no content to block,\n\t// we don't want to show the banner.\n\tprivate blockedExternalContent: number = 0\n\n\tconstructor(vnode: Vnode<MailEditorAttrs>) {\n\t\tconst a = vnode.attrs\n\t\tthis.attrs = a\n\t\tthis.inlineImageElements = []\n\t\tthis.mentionedInlineImages = []\n\t\tconst model = a.model\n\t\tthis.sendMailModel = model\n\t\tthis.templateModel = a.templateModel\n\t\tthis.blockExternalContent = a.doBlockExternalContent()\n\t\tthis.alwaysBlockExternalContent = a.alwaysBlockExternalContent\n\n\t\t// if we have any CC/BCC recipients, we should show these so, should the user send the mail, they know where it will be going to\n\t\tthis.areDetailsExpanded = model.bccRecipients().length + model.ccRecipients().length > 0\n\n\t\tthis.editor = new Editor(\n\t\t\t200,\n\t\t\t(html, isPaste) => {\n\t\t\t\tconst sanitized = htmlSanitizer.sanitizeFragment(html, {\n\t\t\t\t\tblockExternalContent: !isPaste && this.blockExternalContent,\n\t\t\t\t})\n\t\t\t\tthis.blockedExternalContent = sanitized.blockedExternalContent\n\n\t\t\t\tthis.mentionedInlineImages = sanitized.inlineImageCids\n\t\t\t\treturn sanitized.fragment\n\t\t\t},\n\t\t\tnull,\n\t\t)\n\n\t\tconst onEditorChanged = () => {\n\t\t\tcleanupInlineAttachments(this.editor.getDOM(), this.inlineImageElements, model.getAttachments())\n\t\t\tmodel.markAsChangedIfNecessary(true)\n\t\t\tm.redraw()\n\t\t}\n\n\t\t// call this async because the editor is not initialized before this mail editor dialog is shown\n\t\tthis.editor.initialized.promise.then(() => {\n\t\t\tthis.editor.setHTML(model.getBody())\n\n\t\t\tconst editorDom = this.editor.getDOM()\n\t\t\tconst contrastFixNeeded = isMailContrastFixNeeded(editorDom)\n\t\t\t// If mail body cannot be displayed as-is on the dark background then apply the background and text color\n\t\t\t// fix. This class will change tutanota-quote's inside of it.\n\t\t\tif (contrastFixNeeded) {\n\t\t\t\teditorDom.classList.add(\"bg-fix-quoted\")\n\t\t\t}\n\n\t\t\tthis.processInlineImages()\n\n\t\t\t// Add mutation observer to remove attachments when corresponding DOM element is removed\n\t\t\tnew MutationObserver(onEditorChanged).observe(this.editor.getDOM(), {\n\t\t\t\tattributes: false,\n\t\t\t\tchildList: true,\n\t\t\t\tsubtree: true,\n\t\t\t})\n\t\t\t// since the editor is the source for the body text, the model won't know if the body has changed unless we tell it\n\t\t\tthis.editor.addChangeListener(() => model.setBody(replaceInlineImagesWithCids(this.editor.getDOM()).innerHTML))\n\t\t\tthis.editor.addEventListener(\"pasteImage\", ({ detail }: ImagePasteEvent) => {\n\t\t\t\tconst items = Array.from(detail.clipboardData.items)\n\t\t\t\tconst imageItems = items.filter((item) => /image/.test(item.type))\n\t\t\t\tif (!imageItems.length) {\n\t\t\t\t\treturn false\n\t\t\t\t}\n\t\t\t\tconst file = imageItems[0]?.getAsFile()\n\t\t\t\tif (file == null) {\n\t\t\t\t\treturn false\n\t\t\t\t}\n\t\t\t\tconst reader = new FileReader()\n\t\t\t\treader.onload = () => {\n\t\t\t\t\tif (reader.result == null || \"string\" === typeof reader.result) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tconst newInlineImages = [createDataFile(file.name, file.type, new Uint8Array(reader.result))]\n\t\t\t\t\tmodel.attachFiles(newInlineImages)\n\t\t\t\t\tthis.insertInlineImages(model, newInlineImages)\n\t\t\t\t}\n\t\t\t\treader.readAsArrayBuffer(file)\n\t\t\t})\n\n\t\t\tif (a.templateModel) {\n\t\t\t\ta.templateModel.init().then((templateModel) => {\n\t\t\t\t\t// add this event listener to handle quick selection of templates inside the editor\n\t\t\t\t\tregisterTemplateShortcutListener(this.editor, templateModel)\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\n\t\tmodel.onMailChanged.map(() => m.redraw())\n\t\t// Leftover text in recipient field is an error\n\t\tmodel.setOnBeforeSendFunction(() => {\n\t\t\tlet invalidText = \"\"\n\t\t\tfor (const leftoverText of typedValues(this.recipientFieldTexts)) {\n\t\t\t\tif (leftoverText().trim() !== \"\") {\n\t\t\t\t\tinvalidText += \"\\n\" + leftoverText().trim()\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (invalidText !== \"\") {\n\t\t\t\tthrow new UserError(lang.makeTranslation(\"invalidRecipients_msg\", lang.get(\"invalidRecipients_msg\") + invalidText))\n\t\t\t}\n\t\t})\n\t\tconst dialog = a.dialog()\n\n\t\tif (model.getConversationType() === ConversationType.REPLY || model.toRecipients().length) {\n\t\t\tdialog.setFocusOnLoadFunction(() => {\n\t\t\t\tthis.editor.initialized.promise.then(() => this.editor.focus())\n\t\t\t})\n\t\t}\n\n\t\tconst shortcuts: Shortcut[] = [\n\t\t\t{\n\t\t\t\tkey: Keys.SPACE,\n\t\t\t\tctrlOrCmd: true,\n\t\t\t\texec: () => this.openTemplates(),\n\t\t\t\thelp: \"openTemplatePopup_msg\",\n\t\t\t}, // B (bold), I (italic), and U (underline) are handled by squire\n\t\t\t{\n\t\t\t\tkey: Keys.B,\n\t\t\t\tctrlOrCmd: true,\n\t\t\t\texec: noOp,\n\t\t\t\thelp: \"formatTextBold_msg\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.I,\n\t\t\t\tctrlOrCmd: true,\n\t\t\t\texec: noOp,\n\t\t\t\thelp: \"formatTextItalic_msg\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.U,\n\t\t\t\tctrlOrCmd: true,\n\t\t\t\texec: noOp,\n\t\t\t\thelp: \"formatTextUnderline_msg\",\n\t\t\t},\n\t\t]\n\t\tfor (const shortcut of shortcuts) {\n\t\t\tdialog.addShortcut(shortcut)\n\t\t}\n\t\tthis.editor.initialized.promise.then(() => {\n\t\t\ta.knowledgeBaseInjection(this.editor).then((injection) => {\n\t\t\t\tthis.knowledgeBaseInjection = injection\n\t\t\t\tm.redraw()\n\t\t\t})\n\t\t})\n\t}\n\n\tprivate downloadInlineImage(model: SendMailModel, cid: string) {\n\t\tconst tutanotaFiles = model.getAttachments().filter((attachment) => isTutanotaFile(attachment))\n\t\tconst inlineAttachment = tutanotaFiles.find((attachment) => attachment.cid === cid)\n\n\t\tif (inlineAttachment && isTutanotaFile(inlineAttachment)) {\n\t\t\tlocator.fileController.open(inlineAttachment).catch(ofClass(FileOpenError, () => Dialog.message(\"canNotOpenFileOnDevice_msg\")))\n\t\t}\n\t}\n\n\tview(vnode: Vnode<MailEditorAttrs>): Children {\n\t\tconst a = vnode.attrs\n\t\tthis.attrs = a\n\t\tconst { model } = a\n\t\tthis.sendMailModel = model\n\n\t\tconst showConfidentialButton = model.containsExternalRecipients()\n\t\tconst isConfidential = model.isConfidential() && showConfidentialButton\n\t\tconst confidentialButtonAttrs: ToggleButtonAttrs = {\n\t\t\ttitle: \"confidential_action\",\n\t\t\tonToggled: (_, e) => {\n\t\t\t\te.stopPropagation()\n\t\t\t\tmodel.setConfidential(!model.isConfidential())\n\t\t\t},\n\t\t\ticon: model.isConfidential() ? Icons.Lock : Icons.Unlock,\n\t\t\ttoggled: model.isConfidential(),\n\t\t\tsize: ButtonSize.Compact,\n\t\t}\n\t\tconst attachFilesButtonAttrs: IconButtonAttrs = {\n\t\t\ttitle: \"attachFiles_action\",\n\t\t\tclick: (ev, dom) => chooseAndAttachFile(model, dom.getBoundingClientRect()).then(() => m.redraw()),\n\t\t\ticon: Icons.Attachment,\n\t\t\tsize: ButtonSize.Compact,\n\t\t}\n\t\tconst plaintextFormatting = locator.logins.getUserController().props.sendPlaintextOnly\n\t\tthis.editor.setCreatesLists(!plaintextFormatting)\n\n\t\tconst toolbarButton = () =>\n\t\t\t!plaintextFormatting\n\t\t\t\t? m(ToggleButton, {\n\t\t\t\t\t\ttitle: \"showRichTextToolbar_action\",\n\t\t\t\t\t\ticon: Icons.FontSize,\n\t\t\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\t\t\ttoggled: a.doShowToolbar(),\n\t\t\t\t\t\tonToggled: (_, e) => {\n\t\t\t\t\t\t\ta.doShowToolbar(!a.doShowToolbar())\n\t\t\t\t\t\t\t// Stop the subject bar from being focused\n\t\t\t\t\t\t\te.stopPropagation()\n\t\t\t\t\t\t\tthis.editor.focus()\n\t\t\t\t\t\t},\n\t\t\t\t  })\n\t\t\t\t: null\n\n\t\tconst subjectFieldAttrs: TextFieldAttrs = {\n\t\t\tlabel: \"subject_label\",\n\t\t\thelpLabel: () => getConfidentialStateMessage(model.isConfidential()),\n\t\t\tvalue: model.getSubject(),\n\t\t\toninput: (val) => model.setSubject(val),\n\t\t\tinjectionsRight: () =>\n\t\t\t\tm(\".flex.end.ml-between-s.items-center\", [\n\t\t\t\t\tshowConfidentialButton ? m(ToggleButton, confidentialButtonAttrs) : null,\n\t\t\t\t\tthis.knowledgeBaseInjection ? this.renderToggleKnowledgeBase(this.knowledgeBaseInjection) : null,\n\t\t\t\t\tm(IconButton, attachFilesButtonAttrs),\n\t\t\t\t\ttoolbarButton(),\n\t\t\t\t]),\n\t\t}\n\n\t\tconst attachmentBubbleAttrs = createAttachmentBubbleAttrs(model, this.inlineImageElements)\n\n\t\tlet editCustomNotificationMailAttrs: IconButtonAttrs | null = null\n\n\t\tif (locator.logins.getUserController().isGlobalAdmin()) {\n\t\t\teditCustomNotificationMailAttrs = attachDropdown({\n\t\t\t\tmainButtonAttrs: {\n\t\t\t\t\ttitle: \"more_label\",\n\t\t\t\t\ticon: Icons.More,\n\t\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\t},\n\t\t\t\tchildAttrs: () => [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: \"add_action\",\n\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\timport(\"../../../common/settings/EditNotificationEmailDialog.js\").then(({ showAddOrEditNotificationEmailDialog }) =>\n\t\t\t\t\t\t\t\tshowAddOrEditNotificationEmailDialog(locator.logins.getUserController()),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: \"edit_action\",\n\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\timport(\"../../../common/settings/EditNotificationEmailDialog.js\").then(({ showAddOrEditNotificationEmailDialog }) =>\n\t\t\t\t\t\t\t\tshowAddOrEditNotificationEmailDialog(locator.logins.getUserController(), model.getSelectedNotificationLanguageCode()),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t})\n\t\t}\n\n\t\treturn m(\n\t\t\t\"#mail-editor.full-height.text.touch-callout.flex.flex-column\",\n\t\t\t{\n\t\t\t\tonclick: (e: MouseEvent) => {\n\t\t\t\t\tif (e.target === this.editor.getDOM()) {\n\t\t\t\t\t\tthis.editor.focus()\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tondragover: (ev: DragEvent) => {\n\t\t\t\t\t// do not check the data transfer here because it is not always filled, e.g. in Safari\n\t\t\t\t\tev.stopPropagation()\n\t\t\t\t\tev.preventDefault()\n\t\t\t\t},\n\t\t\t\tondrop: (ev: DragEvent) => {\n\t\t\t\t\tif (ev.dataTransfer?.files && ev.dataTransfer.files.length > 0) {\n\t\t\t\t\t\tlet nativeFiles = fileListToArray(ev.dataTransfer.files)\n\t\t\t\t\t\treadLocalFiles(nativeFiles)\n\t\t\t\t\t\t\t.then((dataFiles) => {\n\t\t\t\t\t\t\t\tmodel.attachFiles(dataFiles as any)\n\t\t\t\t\t\t\t\tm.redraw()\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch((e) => {\n\t\t\t\t\t\t\t\tconsole.log(e)\n\t\t\t\t\t\t\t\treturn Dialog.message(\"couldNotAttachFile_msg\")\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\tev.stopPropagation()\n\t\t\t\t\t\tev.preventDefault()\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(\".rel\", this.renderRecipientField(RecipientField.TO, this.recipientFieldTexts.to, a.search)),\n\t\t\t\tm(\n\t\t\t\t\t\".rel\",\n\t\t\t\t\tm(\n\t\t\t\t\t\tExpanderPanel,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\texpanded: this.areDetailsExpanded,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tm(\".details\", [\n\t\t\t\t\t\t\tthis.renderRecipientField(RecipientField.CC, this.recipientFieldTexts.cc, a.search),\n\t\t\t\t\t\t\tthis.renderRecipientField(RecipientField.BCC, this.recipientFieldTexts.bcc, a.search),\n\t\t\t\t\t\t]),\n\t\t\t\t\t),\n\t\t\t\t),\n\t\t\t\tm(\".wrapping-row\", [\n\t\t\t\t\tm(\n\t\t\t\t\t\t\"\",\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\"min-width\": \"250px\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\tm(DropDownSelector, {\n\t\t\t\t\t\t\tlabel: \"sender_label\",\n\t\t\t\t\t\t\titems: getEnabledMailAddressesWithUser(model.mailboxDetails, model.user().userGroupInfo)\n\t\t\t\t\t\t\t\t.sort()\n\t\t\t\t\t\t\t\t.map((mailAddress) => ({\n\t\t\t\t\t\t\t\t\tname: mailAddress,\n\t\t\t\t\t\t\t\t\tvalue: mailAddress,\n\t\t\t\t\t\t\t\t})),\n\t\t\t\t\t\t\tselectedValue: a.model.getSender(),\n\t\t\t\t\t\t\tselectedValueDisplay: getMailAddressDisplayText(a.model.getSenderName(), a.model.getSender(), false),\n\t\t\t\t\t\t\tselectionChangedHandler: (selection: string) => model.setSender(selection),\n\t\t\t\t\t\t\tdropdownWidth: 250,\n\t\t\t\t\t\t}),\n\t\t\t\t\t),\n\t\t\t\t\tisConfidential\n\t\t\t\t\t\t? m(\n\t\t\t\t\t\t\t\t\".flex\",\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\t\"min-width\": \"250px\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\t\t\t\t\t\tconst htmlDom = vnode.dom as HTMLElement\n\t\t\t\t\t\t\t\t\t\thtmlDom.style.opacity = \"0\"\n\t\t\t\t\t\t\t\t\t\treturn animations.add(htmlDom, opacity(0, 1, true))\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tonbeforeremove: (vnode) => {\n\t\t\t\t\t\t\t\t\t\tconst htmlDom = vnode.dom as HTMLElement\n\t\t\t\t\t\t\t\t\t\thtmlDom.style.opacity = \"1\"\n\t\t\t\t\t\t\t\t\t\treturn animations.add(htmlDom, opacity(1, 0, true))\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t[\n\t\t\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\t\t\".flex-grow\",\n\t\t\t\t\t\t\t\t\t\tm(DropDownSelector, {\n\t\t\t\t\t\t\t\t\t\t\tlabel: \"notificationMailLanguage_label\",\n\t\t\t\t\t\t\t\t\t\t\titems: model.getAvailableNotificationTemplateLanguages().map((language) => {\n\t\t\t\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\t\t\t\tname: lang.get(language.textId),\n\t\t\t\t\t\t\t\t\t\t\t\t\tvalue: language.code,\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t\t\t\tselectedValue: model.getSelectedNotificationLanguageCode(),\n\t\t\t\t\t\t\t\t\t\t\tselectionChangedHandler: (v: string) => model.setSelectedNotificationLanguageCode(v),\n\t\t\t\t\t\t\t\t\t\t\tdropdownWidth: 250,\n\t\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\teditCustomNotificationMailAttrs\n\t\t\t\t\t\t\t\t\t\t? m(\".pt.flex-no-grow.flex-end.border-bottom.flex.items-center\", m(IconButton, editCustomNotificationMailAttrs))\n\t\t\t\t\t\t\t\t\t\t: null,\n\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t: null,\n\t\t\t\t]),\n\t\t\t\tisConfidential ? this.renderPasswordFields() : null,\n\t\t\t\tm(\".row\", m(TextField, subjectFieldAttrs)),\n\t\t\t\tm(\n\t\t\t\t\t\".flex-start.flex-wrap.mt-s.mb-s.gap-hpad\",\n\t\t\t\t\tattachmentBubbleAttrs.map((a) => m(AttachmentBubble, a)),\n\t\t\t\t),\n\t\t\t\tmodel.getAttachments().length > 0 ? m(\"hr.hr\") : null,\n\t\t\t\tthis.renderExternalContentBanner(this.attrs),\n\t\t\t\ta.doShowToolbar() ? this.renderToolbar(model) : null,\n\t\t\t\tm(\n\t\t\t\t\t\".pt-s.text.scroll-x.break-word-links.flex.flex-column.flex-grow\",\n\t\t\t\t\t{\n\t\t\t\t\t\tonclick: () => this.editor.focus(),\n\t\t\t\t\t},\n\t\t\t\t\tm(this.editor),\n\t\t\t\t),\n\t\t\t\tm(\".pb\"),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderExternalContentBanner(attrs: MailEditorAttrs): Children | null {\n\t\tif (!this.blockExternalContent || this.alwaysBlockExternalContent || this.blockedExternalContent === 0) {\n\t\t\treturn null\n\t\t}\n\n\t\tconst showButton: BannerButtonAttrs = {\n\t\t\tlabel: \"showBlockedContent_action\",\n\t\t\tclick: () => {\n\t\t\t\tthis.updateExternalContentStatus(ContentBlockingStatus.Show)\n\t\t\t\tthis.processInlineImages()\n\t\t\t},\n\t\t}\n\n\t\treturn m(InfoBanner, {\n\t\t\tmessage: \"contentBlocked_msg\",\n\t\t\ticon: Icons.Picture,\n\t\t\thelpLink: canSeeTutaLinks(attrs.model.logins) ? InfoLink.LoadImages : null,\n\t\t\tbuttons: [showButton],\n\t\t})\n\t}\n\n\tprivate updateExternalContentStatus(status: ContentBlockingStatus) {\n\t\tthis.blockExternalContent = status === ContentBlockingStatus.Block || status === ContentBlockingStatus.AlwaysBlock\n\n\t\tconst sanitized = htmlSanitizer.sanitizeHTML(this.editor.getHTML(), {\n\t\t\tblockExternalContent: this.blockExternalContent,\n\t\t})\n\n\t\tthis.editor.setHTML(sanitized.html)\n\t}\n\n\tprivate processInlineImages() {\n\t\tthis.inlineImageElements = replaceCidsWithInlineImages(this.editor.getDOM(), this.sendMailModel.loadedInlineImages, (cid, event, dom) => {\n\t\t\tconst downloadClickHandler = createDropdown({\n\t\t\t\tlazyButtons: () => [\n\t\t\t\t\t{\n\t\t\t\t\t\tlabel: \"download_action\",\n\t\t\t\t\t\tclick: () => this.downloadInlineImage(this.sendMailModel, cid),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t})\n\t\t\tdownloadClickHandler(downcast(event), dom)\n\t\t})\n\t}\n\n\tprivate renderToggleKnowledgeBase(knowledgeBaseInjection: DialogInjectionRightAttrs<KnowledgebaseDialogContentAttrs>) {\n\t\treturn m(ToggleButton, {\n\t\t\ttitle: \"openKnowledgebase_action\",\n\t\t\ttoggled: knowledgeBaseInjection.visible(),\n\t\t\tonToggled: () => {\n\t\t\t\tif (knowledgeBaseInjection.visible()) {\n\t\t\t\t\tknowledgeBaseInjection.visible(false)\n\t\t\t\t} else {\n\t\t\t\t\tknowledgeBaseInjection.componentAttrs.model.sortEntriesByMatchingKeywords(this.editor.getValue())\n\t\t\t\t\tknowledgeBaseInjection.visible(true)\n\t\t\t\t\tknowledgeBaseInjection.componentAttrs.model.init()\n\t\t\t\t}\n\t\t\t},\n\t\t\ticon: Icons.Book,\n\t\t\tsize: ButtonSize.Compact,\n\t\t})\n\t}\n\n\tprivate renderToolbar(model: SendMailModel): Children {\n\t\t// Toolbar is not removed from DOM directly, only it's parent (array) is so we have to animate it manually.\n\t\t// m.fragment() gives us a vnode without actual DOM element so that we can run callback on removal\n\t\treturn m.fragment(\n\t\t\t{\n\t\t\t\tonbeforeremove: ({ dom }) => animateToolbar(dom.children[0] as HTMLElement, false),\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(RichTextToolbar, {\n\t\t\t\t\teditor: this.editor,\n\t\t\t\t\timageButtonClickHandler: isApp()\n\t\t\t\t\t\t? null\n\t\t\t\t\t\t: (event: Event) => this.imageButtonClickHandler(model, (event.target as HTMLElement).getBoundingClientRect()),\n\t\t\t\t\tcustomButtonAttrs: this.templateModel\n\t\t\t\t\t\t? [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\ttitle: \"openTemplatePopup_msg\",\n\t\t\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t\t\tthis.openTemplates()\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\ticon: Icons.ListAlt,\n\t\t\t\t\t\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t  ]\n\t\t\t\t\t\t: [],\n\t\t\t\t}),\n\t\t\t\tm(\"hr.hr\"),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate async imageButtonClickHandler(model: SendMailModel, rect: DOMRect): Promise<void> {\n\t\tconst files = await chooseAndAttachFile(model, rect, ALLOWED_IMAGE_FORMATS)\n\t\tif (!files || files.length === 0) return\n\t\treturn await this.insertInlineImages(model, files)\n\t}\n\n\tprivate async insertInlineImages(model: SendMailModel, files: ReadonlyArray<DataFile | FileReference>): Promise<void> {\n\t\tfor (const file of files) {\n\t\t\tconst img = createInlineImage(file as DataFile)\n\t\t\tmodel.loadedInlineImages.set(img.cid, img)\n\t\t\tthis.inlineImageElements.push(\n\t\t\t\tthis.editor.insertImage(img.objectUrl, {\n\t\t\t\t\tcid: img.cid,\n\t\t\t\t\tstyle: \"max-width: 100%\",\n\t\t\t\t}),\n\t\t\t)\n\t\t}\n\t\tm.redraw()\n\t}\n\n\tprivate renderPasswordFields(): Children {\n\t\treturn m(\n\t\t\t\".external-recipients.overflow-hidden\",\n\t\t\t{\n\t\t\t\toncreate: (vnode) => this.animateHeight(vnode.dom as HTMLElement, true),\n\t\t\t\tonbeforeremove: (vnode) => this.animateHeight(vnode.dom as HTMLElement, false),\n\t\t\t},\n\t\t\tthis.sendMailModel\n\t\t\t\t.allRecipients()\n\t\t\t\t.filter((r) => r.type === RecipientType.EXTERNAL)\n\t\t\t\t.map((recipient) => {\n\t\t\t\t\tif (!this.recipientShowConfidential.has(recipient.address)) this.recipientShowConfidential.set(recipient.address, false)\n\n\t\t\t\t\treturn m(PasswordField, {\n\t\t\t\t\t\toncreate: (vnode) => this.animateHeight(vnode.dom as HTMLElement, true),\n\t\t\t\t\t\tonbeforeremove: (vnode) => this.animateHeight(vnode.dom as HTMLElement, false),\n\t\t\t\t\t\tlabel: lang.getTranslation(\"passwordFor_label\", { \"{1}\": recipient.address }),\n\t\t\t\t\t\tvalue: this.sendMailModel.getPassword(recipient.address),\n\t\t\t\t\t\tpasswordStrength: this.sendMailModel.getPasswordStrength(recipient),\n\t\t\t\t\t\tstatus: \"auto\",\n\t\t\t\t\t\tautocompleteAs: Autocomplete.off,\n\t\t\t\t\t\toninput: (val) => this.sendMailModel.setPassword(recipient.address, val),\n\t\t\t\t\t})\n\t\t\t\t}),\n\t\t)\n\t}\n\n\tprivate renderRecipientField(field: RecipientField, fieldText: Stream<string>, search: RecipientsSearchModel): Children {\n\t\tconst label = (\n\t\t\t{\n\t\t\t\tto: \"to_label\",\n\t\t\t\tcc: \"cc_label\",\n\t\t\t\tbcc: \"bcc_label\",\n\t\t\t} as const\n\t\t)[field]\n\n\t\treturn m(MailRecipientsTextField, {\n\t\t\tlabel,\n\t\t\ttext: fieldText(),\n\t\t\tonTextChanged: (text) => fieldText(text),\n\t\t\trecipients: this.sendMailModel.getRecipientList(field),\n\t\t\tonRecipientAdded: async (address, name) => {\n\t\t\t\ttry {\n\t\t\t\t\tawait this.sendMailModel.addRecipient(field, { address, name })\n\t\t\t\t} catch (e) {\n\t\t\t\t\tif (isOfflineError(e)) {\n\t\t\t\t\t\t// we are offline but we want to show the error dialog only when we click on send.\n\t\t\t\t\t} else if (e instanceof TooManyRequestsError) {\n\t\t\t\t\t\tawait Dialog.message(\"tooManyAttempts_msg\")\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthrow e\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\tonRecipientRemoved: (address) => this.sendMailModel.removeRecipientByAddress(address, field),\n\t\t\tgetRecipientClickedDropdownAttrs: (address) => {\n\t\t\t\tconst recipient = this.sendMailModel.getRecipient(field, address)!\n\t\t\t\treturn this.getRecipientClickedContextButtons(recipient, field)\n\t\t\t},\n\t\t\tdisabled: !this.sendMailModel.logins.isInternalUserLoggedIn(),\n\t\t\tinjectionsRight:\n\t\t\t\tfield === RecipientField.TO && this.sendMailModel.logins.isInternalUserLoggedIn()\n\t\t\t\t\t? m(\n\t\t\t\t\t\t\t\"\",\n\t\t\t\t\t\t\tm(ToggleButton, {\n\t\t\t\t\t\t\t\ttitle: \"show_action\",\n\t\t\t\t\t\t\t\ticon: BootIcons.Expand,\n\t\t\t\t\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\t\t\t\t\ttoggled: this.areDetailsExpanded,\n\t\t\t\t\t\t\t\tonToggled: (_, e) => {\n\t\t\t\t\t\t\t\t\te.stopPropagation()\n\t\t\t\t\t\t\t\t\tthis.areDetailsExpanded = !this.areDetailsExpanded\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t  )\n\t\t\t\t\t: null,\n\t\t\tsearch,\n\t\t})\n\t}\n\n\tprivate async getRecipientClickedContextButtons(recipient: ResolvableRecipient, field: RecipientField): Promise<DropdownChildAttrs[]> {\n\t\tconst { entity, contactModel } = this.sendMailModel\n\n\t\tconst canEditBubbleRecipient = locator.logins.getUserController().isInternalUser() && !locator.logins.isEnabled(FeatureType.DisableContacts)\n\n\t\tconst canRemoveBubble = locator.logins.getUserController().isInternalUser()\n\n\t\tconst createdContactReceiver = (contactElementId: Id) => {\n\t\t\tconst mailAddress = recipient.address\n\n\t\t\tcontactModel.getContactListId().then((contactListId: string) => {\n\t\t\t\tif (!contactListId) return\n\t\t\t\tconst id: IdTuple = [contactListId, contactElementId]\n\t\t\t\tentity.load(ContactTypeRef, id).then((contact: Contact) => {\n\t\t\t\t\tif (contact.mailAddresses.some((ma) => cleanMatch(ma.address, mailAddress))) {\n\t\t\t\t\t\trecipient.setName(getContactDisplayName(contact))\n\t\t\t\t\t\trecipient.setContact(contact)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.sendMailModel.removeRecipient(recipient, field, false)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t}\n\n\t\tconst contextButtons: Array<DropdownChildAttrs> = []\n\n\t\tif (canEditBubbleRecipient) {\n\t\t\tif (recipient.contact && recipient.contact._id) {\n\t\t\t\tcontextButtons.push({\n\t\t\t\t\tlabel: \"editContact_label\",\n\t\t\t\t\tclick: () => {\n\t\t\t\t\t\timport(\"../../contacts/ContactEditor\").then(({ ContactEditor }) => new ContactEditor(entity, recipient.contact).show())\n\t\t\t\t\t},\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tcontextButtons.push({\n\t\t\t\t\tlabel: \"createContact_action\",\n\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t// contact list\n\t\t\t\t\t\tcontactModel.getContactListId().then((contactListId: Id) => {\n\t\t\t\t\t\t\tconst newContact = createNewContact(locator.logins.getUserController().user, recipient.address, recipient.name)\n\t\t\t\t\t\t\timport(\"../../contacts/ContactEditor\").then(({ ContactEditor }) => {\n\t\t\t\t\t\t\t\t// external users don't see edit buttons\n\t\t\t\t\t\t\t\tnew ContactEditor(entity, newContact, assertNotNull(contactListId), createdContactReceiver).show()\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t})\n\t\t\t\t\t},\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\n\t\tif (canRemoveBubble) {\n\t\t\tcontextButtons.push({\n\t\t\t\tlabel: \"remove_action\",\n\t\t\t\tclick: () => this.sendMailModel.removeRecipient(recipient, field, false),\n\t\t\t})\n\t\t}\n\n\t\treturn contextButtons\n\t}\n\n\tprivate openTemplates() {\n\t\tif (this.templateModel) {\n\t\t\tthis.templateModel.init().then((templateModel) => {\n\t\t\t\tshowTemplatePopupInEditor(templateModel, this.editor, null, this.editor.getSelectedText())\n\t\t\t})\n\t\t}\n\t}\n\n\tprivate animateHeight(domElement: HTMLElement, fadein: boolean): AnimationPromise {\n\t\tlet childHeight = domElement.offsetHeight\n\t\treturn animations.add(domElement, fadein ? height(0, childHeight) : height(childHeight, 0)).then(() => {\n\t\t\tdomElement.style.height = \"\"\n\t\t})\n\t}\n}\n\n/**\n * Creates a new Dialog with a MailEditor inside.\n * @param model\n * @param blockExternalContent\n * @param alwaysBlockExternalContent\n * @returns {Dialog}\n * @private\n */\nasync function createMailEditorDialog(model: SendMailModel, blockExternalContent = false, alwaysBlockExternalContent = false): Promise<Dialog> {\n\tlet dialog: Dialog\n\tlet mailEditorAttrs: MailEditorAttrs\n\n\tconst save = (showProgress: boolean = true) => {\n\t\tconst savePromise = model.saveDraft(true, MailMethod.NONE)\n\n\t\tif (showProgress) {\n\t\t\treturn showProgressDialog(\"save_msg\", savePromise)\n\t\t} else {\n\t\t\treturn savePromise\n\t\t}\n\t}\n\n\tconst send = async () => {\n\t\tif (model.isSharedMailbox() && model.containsExternalRecipients() && model.isConfidential()) {\n\t\t\tawait Dialog.message(\"sharedMailboxCanNotSendConfidentialExternal_msg\")\n\t\t\treturn\n\t\t}\n\n\t\ttry {\n\t\t\tconst success = await model.send(MailMethod.NONE, Dialog.confirm, showProgressDialog)\n\t\t\tif (success) {\n\t\t\t\tdispose()\n\t\t\t\tdialog.close()\n\n\t\t\t\tawait handleRatingByEvent()\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tif (e instanceof UserError) {\n\t\t\t\tshowUserError(e)\n\t\t\t} else {\n\t\t\t\tthrow e\n\t\t\t}\n\t\t}\n\t}\n\n\t// keep track of things we need to dispose of when the editor is completely closed\n\tconst disposables: { dispose: () => unknown }[] = []\n\n\tconst dispose = () => {\n\t\tmodel.dispose()\n\t\tif (templatePopupModel) templatePopupModel.dispose()\n\t\tfor (const disposable of disposables) {\n\t\t\tdisposable.dispose()\n\t\t}\n\t}\n\n\tconst minimize = () => {\n\t\tlet saveStatus = stream<SaveStatus>({ status: SaveStatusEnum.Saving })\n\t\tif (model.hasMailChanged()) {\n\t\t\tsave(false)\n\t\t\t\t.then(() => saveStatus({ status: SaveStatusEnum.Saved }))\n\t\t\t\t.catch((e) => {\n\t\t\t\t\tconst reason = isOfflineError(e) ? SaveErrorReason.ConnectionLost : SaveErrorReason.Unknown\n\n\t\t\t\t\tsaveStatus({ status: SaveStatusEnum.NotSaved, reason })\n\n\t\t\t\t\t// If we don't show the error in the minimized error dialog,\n\t\t\t\t\t// Then we need to communicate it in a dialog or as an unhandled error\n\t\t\t\t\tif (reason === SaveErrorReason.Unknown) {\n\t\t\t\t\t\tif (e instanceof UserError) {\n\t\t\t\t\t\t\tshowUserError(e)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthrow e\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.finally(() => m.redraw())\n\t\t} else if (!model.draft) {\n\t\t\t// If the mail is unchanged and there was no preexisting draft, close instead of saving and return to not show minimized mail editor\n\t\t\tdispose()\n\t\t\tdialog.close()\n\t\t\treturn\n\t\t}\n\t\t// If the mail is unchanged and there /is/ a preexisting draft, there was no change and the mail is already saved\n\t\telse saveStatus = stream<SaveStatus>({ status: SaveStatusEnum.Saved })\n\t\tshowMinimizedMailEditor(dialog, model, mailLocator.minimizedMailModel, locator.eventController, dispose, saveStatus)\n\t}\n\n\tlet windowCloseUnsubscribe = () => {}\n\n\tconst headerBarAttrs: DialogHeaderBarAttrs = {\n\t\tleft: [\n\t\t\t{\n\t\t\t\tlabel: \"close_alt\",\n\t\t\t\tclick: () => minimize(),\n\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t},\n\t\t],\n\t\tright: [\n\t\t\t{\n\t\t\t\tlabel: \"send_action\",\n\t\t\t\tclick: () => {\n\t\t\t\t\tsend()\n\t\t\t\t},\n\t\t\t\ttype: ButtonType.Primary,\n\t\t\t},\n\t\t],\n\t\tmiddle: dialogTitleTranslationKey(model.getConversationType()),\n\t\tcreate: () => {\n\t\t\tif (isBrowser()) {\n\t\t\t\t// Have a simple listener on browser, so their browser will make the user ask if they are sure they want to close when closing the tab/window\n\t\t\t\twindowCloseUnsubscribe = windowFacade.addWindowCloseListener(() => {})\n\t\t\t} else if (isDesktop()) {\n\t\t\t\t// Simulate clicking the Close button when on the desktop so they can see they can save a draft rather than completely closing it\n\t\t\t\twindowCloseUnsubscribe = windowFacade.addWindowCloseListener(() => {\n\t\t\t\t\tminimize()\n\t\t\t\t})\n\t\t\t}\n\t\t},\n\t\tremove: () => {\n\t\t\twindowCloseUnsubscribe()\n\t\t},\n\t}\n\tconst templatePopupModel =\n\t\tlocator.logins.isInternalUserLoggedIn() && client.isDesktopDevice()\n\t\t\t? new TemplatePopupModel(locator.eventController, locator.logins, locator.entityClient)\n\t\t\t: null\n\n\tconst createKnowledgebaseButtonAttrs = async (editor: Editor) => {\n\t\tif (locator.logins.isInternalUserLoggedIn()) {\n\t\t\tconst customer = await locator.logins.getUserController().loadCustomer()\n\t\t\t// only create knowledgebase button for internal users with valid template group and enabled KnowledgebaseFeature\n\t\t\tif (\n\t\t\t\tstyles.isDesktopLayout() &&\n\t\t\t\ttemplatePopupModel &&\n\t\t\t\tlocator.logins.getUserController().getTemplateMemberships().length > 0 &&\n\t\t\t\tisCustomizationEnabledForCustomer(customer, FeatureType.KnowledgeBase)\n\t\t\t) {\n\t\t\t\tconst knowledgebaseModel = new KnowledgeBaseModel(locator.eventController, locator.entityClient, locator.logins.getUserController())\n\t\t\t\tawait knowledgebaseModel.init()\n\n\t\t\t\t// make sure we dispose knowledbaseModel once the editor is closed\n\t\t\t\tdisposables.push(knowledgebaseModel)\n\n\t\t\t\tconst knowledgebaseInjection = createKnowledgeBaseDialogInjection(knowledgebaseModel, templatePopupModel, editor)\n\t\t\t\tdialog.setInjectionRight(knowledgebaseInjection)\n\t\t\t\treturn knowledgebaseInjection\n\t\t\t} else {\n\t\t\t\treturn null\n\t\t\t}\n\t\t} else {\n\t\t\treturn null\n\t\t}\n\t}\n\n\tmailEditorAttrs = createMailEditorAttrs(\n\t\tmodel,\n\t\tblockExternalContent,\n\t\tmodel.toRecipients().length !== 0,\n\t\t() => dialog,\n\t\ttemplatePopupModel,\n\t\tcreateKnowledgebaseButtonAttrs,\n\t\tawait locator.recipientsSearchModel(),\n\t\talwaysBlockExternalContent,\n\t)\n\tconst shortcuts: Shortcut[] = [\n\t\t{\n\t\t\tkey: Keys.ESC,\n\t\t\texec: () => {\n\t\t\t\tminimize()\n\t\t\t},\n\t\t\thelp: \"close_alt\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.S,\n\t\t\tctrlOrCmd: true,\n\t\t\texec: () => {\n\t\t\t\tsave().catch(ofClass(UserError, showUserError))\n\t\t\t},\n\t\t\thelp: \"save_action\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.S,\n\t\t\tctrlOrCmd: true,\n\t\t\tshift: true,\n\t\t\texec: () => {\n\t\t\t\tsend()\n\t\t\t},\n\t\t\thelp: \"send_action\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.RETURN,\n\t\t\tctrlOrCmd: true,\n\t\t\texec: () => {\n\t\t\t\tsend()\n\t\t\t},\n\t\t\thelp: \"send_action\",\n\t\t},\n\t]\n\tdialog = Dialog.editDialog(headerBarAttrs, MailEditor, mailEditorAttrs)\n\tdialog.setCloseHandler(() => minimize())\n\n\tfor (let shortcut of shortcuts) {\n\t\tdialog.addShortcut(shortcut)\n\t}\n\n\treturn dialog\n}\n\n/**\n * open a MailEditor\n * @param mailboxDetails details to use when sending an email\n * @returns {*}\n * @private\n * @throws PermissionError\n */\nexport async function newMailEditor(mailboxDetails: MailboxDetail): Promise<Dialog> {\n\t// We check approval status so as to get a dialog informing the user that they cannot send mails\n\t// but we still want to open the mail editor because they should still be able to contact sales@tutao.de\n\tawait checkApprovalStatus(locator.logins, false)\n\tconst { appendEmailSignature } = await import(\"../signature/Signature\")\n\tconst signature = appendEmailSignature(\"\", locator.logins.getUserController().props)\n\tconst detailsProperties = await getMailboxDetailsAndProperties(mailboxDetails)\n\treturn newMailEditorFromTemplate(detailsProperties.mailboxDetails, {}, \"\", signature)\n}\n\nasync function getExternalContentRulesForEditor(model: SendMailModel, currentStatus: boolean) {\n\tlet contentRules\n\tconst previousMail = model.getPreviousMail()\n\n\tif (!previousMail) {\n\t\tcontentRules = {\n\t\t\talwaysBlockExternalContent: false,\n\t\t\t// external content in a mail for which we don't have a\n\t\t\t// previous mail must have been put there by us.\n\t\t\tblockExternalContent: false,\n\t\t}\n\t} else {\n\t\tconst externalImageRule = await locator.configFacade.getExternalImageRule(previousMail.sender.address).catch((e: unknown) => {\n\t\t\tconsole.log(\"Error getting external image rule:\", e)\n\t\t\treturn ExternalImageRule.None\n\t\t})\n\n\t\tlet isAuthenticatedMail\n\t\tif (previousMail.authStatus !== null) {\n\t\t\tisAuthenticatedMail = previousMail.authStatus === MailAuthenticationStatus.AUTHENTICATED\n\t\t} else {\n\t\t\tconst mailDetails = await locator.mailFacade.loadMailDetailsBlob(previousMail)\n\t\t\tisAuthenticatedMail = mailDetails.authStatus === MailAuthenticationStatus.AUTHENTICATED\n\t\t}\n\n\t\tif (externalImageRule === ExternalImageRule.Block || (externalImageRule === ExternalImageRule.None && model.isUserPreviousSender())) {\n\t\t\tcontentRules = {\n\t\t\t\t// When we have an explicit rule for blocking images we don´t\n\t\t\t\t// want to prompt the user about showing images again\n\t\t\t\talwaysBlockExternalContent: externalImageRule === ExternalImageRule.Block,\n\t\t\t\tblockExternalContent: true,\n\t\t\t}\n\t\t} else if (externalImageRule === ExternalImageRule.Allow && isAuthenticatedMail) {\n\t\t\tcontentRules = {\n\t\t\t\talwaysBlockExternalContent: false,\n\t\t\t\tblockExternalContent: false,\n\t\t\t}\n\t\t} else {\n\t\t\tcontentRules = {\n\t\t\t\talwaysBlockExternalContent: false,\n\t\t\t\tblockExternalContent: currentStatus,\n\t\t\t}\n\t\t}\n\t}\n\n\treturn contentRules\n}\n\nexport async function newMailEditorAsResponse(\n\targs: InitAsResponseArgs,\n\tblockExternalContent: boolean,\n\tinlineImages: InlineImages,\n\tmailboxDetails?: MailboxDetail,\n): Promise<Dialog> {\n\tconst detailsProperties = await getMailboxDetailsAndProperties(mailboxDetails)\n\tconst model = await locator.sendMailModel(detailsProperties.mailboxDetails, detailsProperties.mailboxProperties)\n\tawait model.initAsResponse(args, inlineImages)\n\n\tconst externalImageRules = await getExternalContentRulesForEditor(model, blockExternalContent)\n\treturn createMailEditorDialog(model, externalImageRules?.blockExternalContent, externalImageRules?.alwaysBlockExternalContent)\n}\n\nexport async function newMailEditorFromDraft(\n\tmail: Mail,\n\tmailDetails: MailDetails,\n\tattachments: TutanotaFile[],\n\tinlineImages: InlineImages,\n\tblockExternalContent: boolean,\n\tmailboxDetails?: MailboxDetail,\n): Promise<Dialog> {\n\tconst detailsProperties = await getMailboxDetailsAndProperties(mailboxDetails)\n\tconst model = await locator.sendMailModel(detailsProperties.mailboxDetails, detailsProperties.mailboxProperties)\n\tawait model.initWithDraft(mail, mailDetails, attachments, inlineImages)\n\tconst externalImageRules = await getExternalContentRulesForEditor(model, blockExternalContent)\n\treturn createMailEditorDialog(model, externalImageRules?.blockExternalContent, externalImageRules?.alwaysBlockExternalContent)\n}\n\nexport async function newMailtoUrlMailEditor(mailtoUrl: string, confidential: boolean, mailboxDetails?: MailboxDetail): Promise<Dialog> {\n\tconst detailsProperties = await getMailboxDetailsAndProperties(mailboxDetails)\n\tconst mailTo = parseMailtoUrl(mailtoUrl)\n\tlet dataFiles: Attachment[] = []\n\n\tif (mailTo.attach) {\n\t\tconst attach = mailTo.attach\n\n\t\tif (isDesktop()) {\n\t\t\tconst files = await Promise.all(attach.map((uri) => locator.fileApp.readDataFile(uri)))\n\t\t\tdataFiles = files.filter(isNotNull)\n\t\t}\n\t\t// make sure the user is aware that (and which) files have been attached\n\t\tconst keepAttachments =\n\t\t\tdataFiles.length === 0 ||\n\t\t\t(await Dialog.confirm(\"attachmentWarning_msg\", \"attachFiles_action\", () =>\n\t\t\t\tdataFiles.map((df, i) =>\n\t\t\t\t\tm(\n\t\t\t\t\t\t\".text-break.selectable.mt-xs\",\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttitle: attach[i],\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdf.name,\n\t\t\t\t\t),\n\t\t\t\t),\n\t\t\t))\n\n\t\tif (keepAttachments) {\n\t\t\tconst sizeCheckResult = checkAttachmentSize(dataFiles)\n\t\t\tdataFiles = sizeCheckResult.attachableFiles\n\n\t\t\tif (sizeCheckResult.tooBigFiles.length > 0) {\n\t\t\t\tawait Dialog.message(\"tooBigAttachment_msg\", () => sizeCheckResult.tooBigFiles.map((file) => m(\".text-break.selectable\", file)))\n\t\t\t}\n\t\t} else {\n\t\t\tthrow new CancelledError(\"user cancelled opening mail editor with attachments\")\n\t\t}\n\t}\n\n\treturn newMailEditorFromTemplate(\n\t\tdetailsProperties.mailboxDetails,\n\t\tmailTo.recipients,\n\t\tmailTo.subject || \"\",\n\t\tappendEmailSignature(mailTo.body || \"\", locator.logins.getUserController().props),\n\t\tdataFiles,\n\t\tconfidential,\n\t\tundefined,\n\t\ttrue, // emails created with mailto should always save as draft\n\t)\n}\n\nexport async function newMailEditorFromTemplate(\n\tmailboxDetails: MailboxDetail,\n\trecipients: Recipients,\n\tsubject: string,\n\tbodyText: string,\n\tattachments?: ReadonlyArray<Attachment>,\n\tconfidential?: boolean,\n\tsenderMailAddress?: string,\n\tinitialChangedState?: boolean,\n): Promise<Dialog> {\n\tconst mailboxProperties = await locator.mailboxModel.getMailboxProperties(mailboxDetails.mailboxGroupRoot)\n\treturn locator\n\t\t.sendMailModel(mailboxDetails, mailboxProperties)\n\t\t.then((model) => model.initWithTemplate(recipients, subject, bodyText, attachments, confidential, senderMailAddress, initialChangedState))\n\t\t.then((model) => createMailEditorDialog(model))\n}\n\n/**\n * Create and show a new mail editor with an invite message\n * @param referralLink\n * @returns {*}\n */\nexport async function writeInviteMail(referralLink: string) {\n\tconst detailsProperties = await getMailboxDetailsAndProperties(null)\n\tconst username = locator.logins.getUserController().userGroupInfo.name\n\tconst body = lang.get(\"invitationMailBody_msg\", {\n\t\t\"{registrationLink}\": referralLink,\n\t\t\"{username}\": username,\n\t})\n\tconst { invitationSubject } = await locator.serviceExecutor.get(TranslationService, createTranslationGetIn({ lang: lang.code }))\n\tconst dialog = await newMailEditorFromTemplate(detailsProperties.mailboxDetails, {}, invitationSubject, body, [], false)\n\tdialog.show()\n}\n\n/**\n * Create and show a new mail editor with an invite message\n * @param link the link to the giftcard\n * @param mailboxDetails\n * @returns {*}\n */\nexport async function writeGiftCardMail(link: string, mailboxDetails?: MailboxDetail) {\n\tconst detailsProperties = await getMailboxDetailsAndProperties(mailboxDetails)\n\tconst bodyText = lang\n\t\t.get(\"defaultShareGiftCardBody_msg\", {\n\t\t\t\"{link}\": '<a href=\"' + link + '\">' + link + \"</a>\",\n\t\t\t\"{username}\": locator.logins.getUserController().userGroupInfo.name,\n\t\t})\n\t\t.split(\"\\n\")\n\t\t.join(\"<br />\")\n\tconst { giftCardSubject } = await locator.serviceExecutor.get(TranslationService, createTranslationGetIn({ lang: lang.code }))\n\tlocator\n\t\t.sendMailModel(detailsProperties.mailboxDetails, detailsProperties.mailboxProperties)\n\t\t.then((model) => model.initWithTemplate({}, giftCardSubject, appendEmailSignature(bodyText, locator.logins.getUserController().props), [], false))\n\t\t.then((model) => createMailEditorDialog(model, false))\n\t\t.then((dialog) => dialog.show())\n}\n\nasync function getMailboxDetailsAndProperties(\n\tmailboxDetails: MailboxDetail | null | undefined,\n): Promise<{ mailboxDetails: MailboxDetail; mailboxProperties: MailboxProperties }> {\n\tmailboxDetails = mailboxDetails ?? (await locator.mailboxModel.getUserMailboxDetails())\n\tconst mailboxProperties = await locator.mailboxModel.getMailboxProperties(mailboxDetails.mailboxGroupRoot)\n\treturn { mailboxDetails, mailboxProperties }\n}\n"]}