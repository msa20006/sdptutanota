{"version":3,"file":"MinimizedEditorOverlay.js","sourceRoot":"","sources":["../../../../../src/mail-app/mail/view/MinimizedEditorOverlay.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Children, Component, Vnode } from \"mithril\"\nimport { CounterBadge } from \"../../../common/gui/base/CounterBadge\"\nimport { getNavButtonIconBackground, theme } from \"../../../common/gui/theme\"\nimport { lang } from \"../../../common/misc/LanguageViewModel\"\nimport { Button, ButtonColor, ButtonType } from \"../../../common/gui/base/Button.js\"\nimport type { MinimizedEditor, MinimizedMailEditorViewModel } from \"../model/MinimizedMailEditorViewModel\"\nimport { SaveErrorReason, SaveStatus, SaveStatusEnum } from \"../model/MinimizedMailEditorViewModel\"\nimport { px } from \"../../../common/gui/size\"\nimport { Icons } from \"../../../common/gui/base/icons/Icons\"\nimport { styles } from \"../../../common/gui/styles\"\nimport { promptAndDeleteMails } from \"./MailGuiUtils\"\nimport { MailTypeRef } from \"../../../common/api/entities/tutanota/TypeRefs.js\"\nimport { OperationType } from \"../../../common/api/common/TutanotaConstants\"\nimport { isSameId } from \"../../../common/api/common/utils/EntityUtils\"\nimport { noOp, promiseMap } from \"@tutao/tutanota-utils\"\nimport { EntityUpdateData, isUpdateForTypeRef } from \"../../../common/api/common/utils/EntityUpdateUtils.js\"\nimport { EntityEventsListener, EventController } from \"../../../common/api/main/EventController.js\"\nimport { IconButton } from \"../../../common/gui/base/IconButton.js\"\nimport { mailLocator } from \"../../mailLocator.js\"\n\nconst COUNTER_POS_OFFSET = px(-8)\nexport type MinimizedEditorOverlayAttrs = {\n\tviewModel: MinimizedMailEditorViewModel\n\tminimizedEditor: MinimizedEditor\n\teventController: EventController\n}\n\nexport class MinimizedEditorOverlay implements Component<MinimizedEditorOverlayAttrs> {\n\t_listener: EntityEventsListener\n\t_eventController: EventController\n\n\tconstructor(vnode: Vnode<MinimizedEditorOverlayAttrs>) {\n\t\tconst { minimizedEditor, viewModel, eventController } = vnode.attrs\n\t\tthis._eventController = eventController\n\n\t\tthis._listener = (updates: ReadonlyArray<EntityUpdateData>, eventOwnerGroupId: Id): Promise<unknown> => {\n\t\t\treturn promiseMap(updates, (update) => {\n\t\t\t\tif (isUpdateForTypeRef(MailTypeRef, update) && update.operation === OperationType.DELETE) {\n\t\t\t\t\tlet draft = minimizedEditor.sendMailModel.getDraft()\n\n\t\t\t\t\tif (draft && isSameId(draft._id, [update.instanceListId, update.instanceId])) {\n\t\t\t\t\t\tviewModel.removeMinimizedEditor(minimizedEditor)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\n\t\teventController.addEntityListener(this._listener)\n\t}\n\n\tonremove() {\n\t\tthis._eventController.removeEntityListener(this._listener)\n\t}\n\n\tview(vnode: Vnode<MinimizedEditorOverlayAttrs>): Children {\n\t\tconst { minimizedEditor, viewModel, eventController } = vnode.attrs\n\t\tconst subject = minimizedEditor.sendMailModel.getSubject()\n\t\treturn m(\".elevated-bg.pl.border-radius\", [\n\t\t\tm(CounterBadge, {\n\t\t\t\tcount: viewModel.getMinimizedEditors().indexOf(minimizedEditor) + 1,\n\t\t\t\tposition: {\n\t\t\t\t\ttop: COUNTER_POS_OFFSET,\n\t\t\t\t\tright: COUNTER_POS_OFFSET,\n\t\t\t\t},\n\t\t\t\tcolor: theme.navigation_button_icon,\n\t\t\t\tbackground: getNavButtonIconBackground(),\n\t\t\t}),\n\t\t\tm(\".flex.justify-between.pb-xs.pt-xs\", [\n\t\t\t\tm(\n\t\t\t\t\t\".flex.col.justify-center.min-width-0.flex-grow\",\n\t\t\t\t\t{\n\t\t\t\t\t\tonclick: () => viewModel.reopenMinimizedEditor(minimizedEditor),\n\t\t\t\t\t},\n\t\t\t\t\t[\n\t\t\t\t\t\tm(\".b.text-ellipsis\", subject ? subject : lang.get(\"newMail_action\")),\n\t\t\t\t\t\tm(\".small.text-ellipsis\", getStatusMessage(minimizedEditor.saveStatus())),\n\t\t\t\t\t],\n\t\t\t\t),\n\t\t\t\tm(\".flex.items-center.justify-right\", [\n\t\t\t\t\t!styles.isSingleColumnLayout()\n\t\t\t\t\t\t? m(IconButton, {\n\t\t\t\t\t\t\t\ttitle: \"edit_action\",\n\t\t\t\t\t\t\t\tclick: () => viewModel.reopenMinimizedEditor(minimizedEditor),\n\t\t\t\t\t\t\t\ticon: Icons.Edit,\n\t\t\t\t\t\t  })\n\t\t\t\t\t\t: null,\n\t\t\t\t\tm(IconButton, {\n\t\t\t\t\t\ttitle: \"delete_action\",\n\t\t\t\t\t\tclick: () => this._onDeleteClicked(minimizedEditor, viewModel),\n\t\t\t\t\t\ticon: Icons.Trash,\n\t\t\t\t\t}),\n\t\t\t\t\tm(IconButton, {\n\t\t\t\t\t\ttitle: \"close_alt\",\n\t\t\t\t\t\tclick: () => viewModel.removeMinimizedEditor(minimizedEditor),\n\t\t\t\t\t\ticon: Icons.Cancel,\n\t\t\t\t\t}),\n\t\t\t\t]),\n\t\t\t]),\n\t\t])\n\t}\n\n\tprivate _onDeleteClicked(minimizedEditor: MinimizedEditor, viewModel: MinimizedMailEditorViewModel) {\n\t\tconst model = minimizedEditor.sendMailModel\n\t\tviewModel.removeMinimizedEditor(minimizedEditor)\n\t\t// only delete once save has finished\n\t\tminimizedEditor.saveStatus.map(async ({ status }) => {\n\t\t\tif (status !== SaveStatusEnum.Saving) {\n\t\t\t\tconst draft = model.draft\n\n\t\t\t\tif (draft) {\n\t\t\t\t\tawait promptAndDeleteMails(mailLocator.mailModel, [draft], noOp)\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t}\n}\n\nfunction getStatusMessage(saveStatus: SaveStatus): string {\n\tswitch (saveStatus.status) {\n\t\tcase SaveStatusEnum.Saving:\n\t\t\treturn lang.get(\"save_msg\")\n\t\tcase SaveStatusEnum.NotSaved:\n\t\t\tswitch (saveStatus.reason) {\n\t\t\t\tcase SaveErrorReason.ConnectionLost:\n\t\t\t\t\treturn lang.get(\"draftNotSavedConnectionLost_msg\")\n\t\t\t\tdefault:\n\t\t\t\t\treturn lang.get(\"draftNotSaved_msg\")\n\t\t\t}\n\t\tcase SaveStatusEnum.Saved:\n\t\t\treturn lang.get(\"draftSaved_msg\")\n\t\tdefault:\n\t\t\treturn \"\"\n\t}\n}\n"]}