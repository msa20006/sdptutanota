{"version":3,"file":"MailViewerUtils.js","sourceRoot":"","sources":["../../../../../src/mail-app/mail/view/MailViewerUtils.ts"],"names":[],"mappings":"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","sourcesContent":["import { Keys, MailReportType, MailState, ReplyType, SYSTEM_GROUP_MAIL_ADDRESS } from \"../../../common/api/common/TutanotaConstants\"\nimport { assertNotNull, neverNull, ofClass } from \"@tutao/tutanota-utils\"\nimport { InfoLink, lang } from \"../../../common/misc/LanguageViewModel\"\nimport { Dialog } from \"../../../common/gui/base/Dialog\"\nimport m from \"mithril\"\nimport { Button, ButtonType } from \"../../../common/gui/base/Button.js\"\nimport { progressIcon } from \"../../../common/gui/base/Icon.js\"\nimport { checkApprovalStatus } from \"../../../common/misc/LoginUtils.js\"\nimport { locator } from \"../../../common/api/main/CommonLocator.js\"\nimport { UserError } from \"../../../common/api/main/UserError.js\"\nimport { showUserError } from \"../../../common/misc/ErrorHandlerImpl.js\"\nimport { ContentBlockingStatus, MailViewerViewModel } from \"./MailViewerViewModel.js\"\nimport { DropdownButtonAttrs } from \"../../../common/gui/base/Dropdown.js\"\nimport { Icons } from \"../../../common/gui/base/icons/Icons.js\"\nimport { client } from \"../../../common/misc/ClientDetector.js\"\nimport { showProgressDialog } from \"../../../common/gui/dialogs/ProgressDialog.js\"\nimport { LockedError } from \"../../../common/api/common/error/RestError.js\"\nimport { ifAllowedTutaLinks } from \"../../../common/gui/base/GuiUtils.js\"\nimport { ExternalLink } from \"../../../common/gui/base/ExternalLink.js\"\nimport { SourceCodeViewer } from \"./SourceCodeViewer.js\"\nimport { getMailAddressDisplayText, hasValidEncryptionAuthForTeamOrSystemMail } from \"../../../common/mailFunctionality/SharedMailUtils.js\"\nimport { mailLocator } from \"../../mailLocator.js\"\nimport { Mail, MailDetails } from \"../../../common/api/entities/tutanota/TypeRefs.js\"\nimport { getDisplayedSender } from \"../../../common/api/common/CommonMailUtils.js\"\nimport { MailFacade } from \"../../../common/api/worker/facades/lazy/MailFacade.js\"\n\nimport { ListFilter } from \"../../../common/misc/ListModel.js\"\nimport { isDesktop } from \"../../../common/api/common/Env.js\"\nimport { isDraft } from \"../model/MailChecks.js\"\n\nexport async function showHeaderDialog(headersPromise: Promise<string | null>) {\n\tlet state: { state: \"loading\" } | { state: \"loaded\"; headers: string | null } = { state: \"loading\" }\n\n\theadersPromise.then((headers) => {\n\t\tstate = { state: \"loaded\", headers }\n\t\tm.redraw()\n\t})\n\n\tlet mailHeadersDialog: Dialog\n\tconst closeHeadersAction = () => {\n\t\tmailHeadersDialog?.close()\n\t}\n\n\tmailHeadersDialog = Dialog.largeDialog(\n\t\t{\n\t\t\tright: [\n\t\t\t\t{\n\t\t\t\t\tlabel: \"ok_action\",\n\t\t\t\t\tclick: closeHeadersAction,\n\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t},\n\t\t\t],\n\t\t\tmiddle: \"mailHeaders_title\",\n\t\t},\n\t\t{\n\t\t\tview: () =>\n\t\t\t\tm(\n\t\t\t\t\t\".white-space-pre.pt.pb.selectable\",\n\t\t\t\t\tstate.state === \"loading\" ? m(\".center\", progressIcon()) : state.headers ?? m(\".center\", lang.get(\"noEntries_msg\")),\n\t\t\t\t),\n\t\t},\n\t)\n\t\t.addShortcut({\n\t\t\tkey: Keys.ESC,\n\t\t\texec: closeHeadersAction,\n\t\t\thelp: \"close_alt\",\n\t\t})\n\t\t.setCloseHandler(closeHeadersAction)\n\t\t.show()\n}\n\nexport async function loadMailDetails(mailFacade: MailFacade, mail: Mail): Promise<MailDetails> {\n\tif (isDraft(mail)) {\n\t\tconst detailsDraftId = assertNotNull(mail.mailDetailsDraft)\n\t\treturn mailFacade.loadMailDetailsDraft(mail)\n\t} else {\n\t\tconst mailDetailsId = neverNull(mail.mailDetails)\n\t\treturn mailFacade.loadMailDetailsBlob(mail)\n\t}\n}\n\nexport async function editDraft(viewModel: MailViewerViewModel): Promise<void> {\n\tconst sendAllowed = await checkApprovalStatus(locator.logins, false)\n\tif (sendAllowed) {\n\t\t// check if to be opened draft has already been minimized, iff that is the case, re-open it\n\t\tconst minimizedEditor = mailLocator.minimizedMailModel.getEditorForDraft(viewModel.mail)\n\n\t\tif (minimizedEditor) {\n\t\t\tmailLocator.minimizedMailModel.reopenMinimizedEditor(minimizedEditor)\n\t\t} else {\n\t\t\ttry {\n\t\t\t\tconst [mailboxDetails, { newMailEditorFromDraft }] = await Promise.all([\n\t\t\t\t\tviewModel.mailModel.getMailboxDetailsForMail(viewModel.mail),\n\t\t\t\t\timport(\"../editor/MailEditor\"),\n\t\t\t\t])\n\t\t\t\tif (mailboxDetails == null) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tconst editorDialog = await newMailEditorFromDraft(\n\t\t\t\t\tviewModel.mail,\n\t\t\t\t\tawait loadMailDetails(locator.mailFacade, viewModel.mail),\n\t\t\t\t\tviewModel.getAttachments(),\n\t\t\t\t\tviewModel.getLoadedInlineImages(),\n\t\t\t\t\tviewModel.isBlockingExternalImages(),\n\t\t\t\t\tmailboxDetails,\n\t\t\t\t)\n\t\t\t\teditorDialog.show()\n\t\t\t} catch (e) {\n\t\t\t\tif (e instanceof UserError) {\n\t\t\t\t\tawait showUserError(e)\n\t\t\t\t} else {\n\t\t\t\t\tthrow e\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport async function showSourceDialog(rawHtml: string) {\n\treturn Dialog.viewerDialog(\"emailSourceCode_title\", SourceCodeViewer, { rawHtml })\n}\n\nexport function mailViewerMoreActions(viewModel: MailViewerViewModel, showReadButton: boolean = true): Array<DropdownButtonAttrs> {\n\tconst moreButtons: Array<DropdownButtonAttrs> = []\n\tif (showReadButton) {\n\t\tif (viewModel.isUnread()) {\n\t\t\tmoreButtons.push({\n\t\t\t\tlabel: \"markRead_action\",\n\t\t\t\tclick: () => viewModel.setUnread(false),\n\t\t\t\ticon: Icons.Eye,\n\t\t\t})\n\t\t} else {\n\t\t\tmoreButtons.push({\n\t\t\t\tlabel: \"markUnread_action\",\n\t\t\t\tclick: () => viewModel.setUnread(true),\n\t\t\t\ticon: Icons.NoEye,\n\t\t\t})\n\t\t}\n\t}\n\n\tif (viewModel.canPersistBlockingStatus() && viewModel.isShowingExternalContent()) {\n\t\tmoreButtons.push({\n\t\t\tlabel: \"disallowExternalContent_action\",\n\t\t\tclick: () => viewModel.setContentBlockingStatus(ContentBlockingStatus.Block),\n\t\t\ticon: Icons.Picture,\n\t\t})\n\t}\n\n\tif (viewModel.canPersistBlockingStatus() && viewModel.isBlockingExternalImages()) {\n\t\tmoreButtons.push({\n\t\t\tlabel: \"showImages_action\",\n\t\t\tclick: () => viewModel.setContentBlockingStatus(ContentBlockingStatus.Show),\n\t\t\ticon: Icons.Picture,\n\t\t})\n\t}\n\n\tif (viewModel.isListUnsubscribe()) {\n\t\tmoreButtons.push({\n\t\t\tlabel: \"unsubscribe_action\",\n\t\t\tclick: () => unsubscribe(viewModel),\n\t\t\ticon: Icons.Cancel,\n\t\t})\n\t}\n\n\tif (!client.isMobileDevice() && viewModel.canExport()) {\n\t\tmoreButtons.push({\n\t\t\tlabel: \"export_action\",\n\t\t\tclick: () => showProgressDialog(\"pleaseWait_msg\", viewModel.exportMail()),\n\t\t\ticon: Icons.Export,\n\t\t})\n\t}\n\n\tif (!client.isMobileDevice() && typeof window.print === \"function\" && viewModel.canPrint()) {\n\t\tmoreButtons.push({\n\t\t\tlabel: \"print_action\",\n\t\t\tclick: () => window.print(),\n\t\t\ticon: Icons.Print,\n\t\t})\n\t}\n\n\tif (viewModel.canShowHeaders()) {\n\t\tmoreButtons.push({\n\t\t\tlabel: \"showHeaders_action\",\n\t\t\tclick: () => showHeaderDialog(viewModel.getHeaders()),\n\t\t\ticon: Icons.ListUnordered,\n\t\t})\n\t}\n\n\tif (viewModel.canReport()) {\n\t\tmoreButtons.push({\n\t\t\tlabel: \"reportEmail_action\",\n\t\t\tclick: () => reportMail(viewModel),\n\t\t\ticon: Icons.Warning,\n\t\t})\n\t}\n\n\t// adding more optional buttons? put them above the report action so the new button\n\t// is not sometimes where the report action usually sits.\n\n\treturn moreButtons\n}\n\nfunction unsubscribe(viewModel: MailViewerViewModel): Promise<void> {\n\treturn showProgressDialog(\"pleaseWait_msg\", viewModel.unsubscribe())\n\t\t.then((success) => {\n\t\t\tif (success) {\n\t\t\t\treturn Dialog.message(\"unsubscribeSuccessful_msg\")\n\t\t\t}\n\t\t})\n\t\t.catch((e) => {\n\t\t\tif (e instanceof LockedError) {\n\t\t\t\treturn Dialog.message(\"operationStillActive_msg\")\n\t\t\t} else {\n\t\t\t\treturn Dialog.message(\"unsubscribeFailed_msg\")\n\t\t\t}\n\t\t})\n}\n\nfunction reportMail(viewModel: MailViewerViewModel) {\n\tconst sendReport = (reportType: MailReportType) => {\n\t\tviewModel\n\t\t\t.reportMail(reportType)\n\t\t\t.catch(ofClass(LockedError, () => Dialog.message(\"operationStillActive_msg\")))\n\t\t\t.finally(m.redraw)\n\t}\n\n\tconst dialog = Dialog.showActionDialog({\n\t\ttitle: \"reportEmail_action\",\n\t\tchild: () =>\n\t\t\tm(\n\t\t\t\t\".flex.col.mt-m\",\n\t\t\t\t{\n\t\t\t\t\t// So that space below buttons doesn't look huge\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tmarginBottom: \"-10px\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t[\n\t\t\t\t\tm(\"div\", lang.get(\"phishingReport_msg\")),\n\t\t\t\t\tifAllowedTutaLinks(locator.logins, InfoLink.Phishing, (link) =>\n\t\t\t\t\t\tm(ExternalLink, {\n\t\t\t\t\t\t\thref: link,\n\t\t\t\t\t\t\ttext: lang.get(\"whatIsPhishing_msg\"),\n\t\t\t\t\t\t\tisCompanySite: true,\n\t\t\t\t\t\t\tclass: \"mt-s\",\n\t\t\t\t\t\t}),\n\t\t\t\t\t),\n\t\t\t\t\tm(\".flex-wrap.flex-end\", [\n\t\t\t\t\t\tm(Button, {\n\t\t\t\t\t\t\tlabel: \"reportPhishing_action\",\n\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\tsendReport(MailReportType.PHISHING)\n\t\t\t\t\t\t\t\tdialog.close()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tm(Button, {\n\t\t\t\t\t\t\tlabel: \"reportSpam_action\",\n\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\tsendReport(MailReportType.SPAM)\n\t\t\t\t\t\t\t\tdialog.close()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t\t\t}),\n\t\t\t\t\t]),\n\t\t\t\t],\n\t\t\t),\n\t\tokAction: null,\n\t})\n}\n\nexport function isNoReplyTeamAddress(address: string): boolean {\n\treturn address === \"no-reply@tutao.de\" || address === \"no-reply@tutanota.de\"\n}\n\n/**\n * Is this a system notification?\n */\nexport function isSystemNotification(mail: Mail): boolean {\n\tconst { confidential, sender, state } = mail\n\treturn (\n\t\tstate === MailState.RECEIVED &&\n\t\tconfidential &&\n\t\thasValidEncryptionAuthForTeamOrSystemMail(mail) &&\n\t\t(sender.address === SYSTEM_GROUP_MAIL_ADDRESS ||\n\t\t\t// New emails will have sender set to system and will only have replyTo set to no-reply\n\t\t\t// but we should keep displaying old emails correctly.\n\t\t\tisNoReplyTeamAddress(sender.address))\n\t)\n}\n\nexport function getRecipientHeading(mail: Mail, preferNameOnly: boolean) {\n\tlet recipientCount = parseInt(mail.recipientCount)\n\tif (recipientCount > 0) {\n\t\tlet recipient = neverNull(mail.firstRecipient)\n\t\treturn getMailAddressDisplayText(recipient.name, recipient.address, preferNameOnly) + (recipientCount > 1 ? \", ...\" : \"\")\n\t} else {\n\t\treturn \"\"\n\t}\n}\n\nexport function getSenderOrRecipientHeading(mail: Mail, preferNameOnly: boolean): string {\n\tif (isSystemNotification(mail)) {\n\t\treturn \"\"\n\t} else if (mail.state === MailState.RECEIVED) {\n\t\tconst sender = getDisplayedSender(mail)\n\t\treturn getMailAddressDisplayText(sender.name, sender.address, preferNameOnly)\n\t} else {\n\t\treturn getRecipientHeading(mail, preferNameOnly)\n\t}\n}\n\nexport enum MailFilterType {\n\tUnread,\n\tRead,\n\tWithAttachments,\n}\n\nexport function getMailFilterForType(filter: MailFilterType | null): ListFilter<Mail> | null {\n\tswitch (filter) {\n\t\tcase MailFilterType.Read:\n\t\t\treturn (mail) => !mail.unread\n\t\tcase MailFilterType.Unread:\n\t\t\treturn (mail) => mail.unread\n\t\tcase MailFilterType.WithAttachments:\n\t\t\treturn (mail) => mail.attachments.length > 0\n\t\tcase null:\n\t\t\treturn null\n\t}\n}\n\n/**\n * @returns {boolean} true if the given mail was already replied to. Otherwise false.\n * Note that it also returns true if the mail was replied to AND forwarded.\n */\nexport function isRepliedTo(mail: Mail): boolean {\n\treturn mail.replyType === ReplyType.REPLY || mail.replyType === ReplyType.REPLY_FORWARD\n}\n\nexport function canDoDragAndDropExport(): boolean {\n\treturn isDesktop()\n}\n"]}