{"version":3,"file":"SearchBar.js","sourceRoot":"","sources":["../../../../src/mail-app/search/SearchBar.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Component, Vnode } from \"mithril\"\nimport { px, size } from \"../../common/gui/size\"\nimport stream from \"mithril/stream\"\nimport Stream from \"mithril/stream\"\nimport type { PositionRect } from \"../../common/gui/base/Overlay\"\nimport { displayOverlay } from \"../../common/gui/base/Overlay\"\nimport type { CalendarEvent, Contact, Mail } from \"../../common/api/entities/tutanota/TypeRefs.js\"\nimport { CalendarEventTypeRef, ContactTypeRef, MailTypeRef } from \"../../common/api/entities/tutanota/TypeRefs.js\"\nimport type { Shortcut } from \"../../common/misc/KeyManager\"\nimport { isKeyPressed, keyManager } from \"../../common/misc/KeyManager\"\nimport { encodeCalendarSearchKey, getRestriction } from \"./model/SearchUtils\"\nimport { Dialog } from \"../../common/gui/base/Dialog\"\nimport type { WhitelabelChild } from \"../../common/api/entities/sys/TypeRefs.js\"\nimport { FULL_INDEXED_TIMESTAMP, Keys } from \"../../common/api/common/TutanotaConstants\"\nimport { assertMainOrNode, isApp } from \"../../common/api/common/Env\"\nimport { styles } from \"../../common/gui/styles\"\nimport { client } from \"../../common/misc/ClientDetector\"\nimport { debounce, downcast, isSameTypeRef, memoized, mod, ofClass, TypeRef } from \"@tutao/tutanota-utils\"\nimport { BrowserType } from \"../../common/misc/ClientConstants\"\nimport { hasMoreResults } from \"./model/SearchModel\"\nimport { SearchBarOverlay } from \"./SearchBarOverlay\"\nimport { IndexingNotSupportedError } from \"../../common/api/common/error/IndexingNotSupportedError\"\nimport type { SearchIndexStateInfo, SearchRestriction, SearchResult } from \"../../common/api/worker/search/SearchTypes\"\nimport { assertIsEntity, getElementId } from \"../../common/api/common/utils/EntityUtils\"\nimport { compareContacts } from \"../contacts/view/ContactGuiUtils\"\nimport { LayerType } from \"../../RootView\"\nimport { BaseSearchBar, BaseSearchBarAttrs } from \"../../common/gui/base/BaseSearchBar.js\"\nimport { SearchRouter } from \"../../common/search/view/SearchRouter.js\"\nimport { PageSize } from \"../../common/gui/base/ListUtils.js\"\nimport { generateCalendarInstancesInRange, isClientOnlyCalendar, retrieveClientOnlyEventsForUser } from \"../../common/calendar/date/CalendarUtils.js\"\nimport { ListElementEntity } from \"../../common/api/common/EntityTypes.js\"\n\nimport { loadMultipleFromLists } from \"../../common/api/common/EntityClient.js\"\nimport { mailLocator } from \"../mailLocator.js\"\n\nassertMainOrNode()\nexport type ShowMoreAction = {\n\tresultCount: number\n\tshownCount: number\n\tindexTimestamp: number\n\tallowShowMore: boolean\n}\nexport type SearchBarAttrs = {\n\tplaceholder?: string | null\n\treturnListener?: (() => unknown) | null\n\tdisabled?: boolean\n}\n\nconst MAX_SEARCH_PREVIEW_RESULTS = 10\nexport type Entry = Mail | Contact | CalendarEvent | WhitelabelChild | ShowMoreAction\ntype Entries = Array<Entry>\nexport type SearchBarState = {\n\tquery: string\n\tsearchResult: SearchResult | null\n\tindexState: SearchIndexStateInfo\n\tentities: Entries\n\tselected: Entry | null\n}\n\n// create our own copy which is not perfect because we don't benefit from the shared cache but currently there's no way to get async dependencies into\n// singletons like this (without top-level await at least)\n// once SearchBar is rewritten this should be removed\nconst searchRouter = new SearchRouter(mailLocator.throttledRouter())\n\nexport class SearchBar implements Component<SearchBarAttrs> {\n\tfocused: boolean = false\n\tprivate readonly state: Stream<SearchBarState>\n\tbusy: boolean = false\n\tprivate lastSelectedWhitelabelChildrenInfoResult: Stream<WhitelabelChild> = stream()\n\tprivate closeOverlayFunction: (() => void) | null = null\n\tprivate readonly overlayContentComponent: Component\n\tprivate confirmDialogShown: boolean = false\n\tprivate domWrapper!: HTMLElement\n\tprivate domInput!: HTMLElement\n\tprivate indexStateStream: Stream<unknown> | null = null\n\tprivate stateStream: Stream<unknown> | null = null\n\tprivate lastQueryStream: Stream<unknown> | null = null\n\n\tconstructor() {\n\t\tthis.state = stream<SearchBarState>({\n\t\t\tquery: \"\",\n\t\t\tsearchResult: null,\n\t\t\tindexState: mailLocator.search?.indexState(),\n\t\t\tentities: [] as Entries,\n\t\t\tselected: null,\n\t\t})\n\t\tthis.overlayContentComponent = {\n\t\t\tview: () => {\n\t\t\t\treturn m(SearchBarOverlay, {\n\t\t\t\t\tstate: this.state(),\n\t\t\t\t\tisQuickSearch: this.isQuickSearch(),\n\t\t\t\t\tisFocused: this.focused,\n\t\t\t\t\tselectResult: (selected) => this.selectResult(selected),\n\t\t\t\t})\n\t\t\t},\n\t\t}\n\n\t\tthis.view = this.view.bind(this)\n\t\tthis.oncreate = this.oncreate.bind(this)\n\t\tthis.onremove = this.onremove.bind(this)\n\t}\n\n\t/**\n\t * this reacts to URL changes by clearing the suggestions - the selected item may have changed (in the mail view maybe)\n\t * that shouldn't clear our current state, but if the URL changed in a way that makes the previous state outdated, we clear it.\n\t */\n\tprivate readonly onPathChange = memoized((newPath: string) => {\n\t\tif (mailLocator.search.isNewSearch(this.state().query, getRestriction(newPath))) {\n\t\t\tthis.updateState({\n\t\t\t\tsearchResult: null,\n\t\t\t\tselected: null,\n\t\t\t\tentities: [],\n\t\t\t})\n\t\t}\n\t})\n\n\tview(vnode: Vnode<SearchBarAttrs>) {\n\t\tthis.onPathChange(m.route.get())\n\n\t\treturn m(\n\t\t\t// form wrapper to isolate the search input and prevent it from being autofilled when unrelated buttons are clicked on chrome\n\t\t\t// this is done because chrome doesn't appear to respect `autocomplete=\"off\"` and will autofill the field anyway\n\t\t\t\"form.full-width\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\t\"max-width\": styles.isUsingBottomNavigation() ? \"\" : px(350),\n\t\t\t\t},\n\t\t\t\tonsubmit: (e: SubmitEvent) => {\n\t\t\t\t\te.stopPropagation()\n\t\t\t\t\te.preventDefault()\n\t\t\t\t},\n\t\t\t},\n\t\t\tm(BaseSearchBar, {\n\t\t\t\tplaceholder: vnode.attrs.placeholder,\n\t\t\t\ttext: this.state().query,\n\t\t\t\tbusy: this.busy,\n\t\t\t\tdisabled: vnode.attrs.disabled,\n\t\t\t\tonInput: (text) => this.search(text),\n\t\t\t\tonSearchClick: () => this.handleSearchClick(),\n\t\t\t\tonClear: () => {\n\t\t\t\t\tthis.clear()\n\t\t\t\t},\n\t\t\t\tonWrapperCreated: (dom) => {\n\t\t\t\t\tthis.domWrapper = dom\n\t\t\t\t\tthis.showOverlay()\n\t\t\t\t},\n\t\t\t\tonInputCreated: (dom) => {\n\t\t\t\t\tthis.domInput = dom\n\t\t\t\t},\n\t\t\t\tonFocus: () => (this.focused = true),\n\t\t\t\tonBlur: () => this.onBlur(),\n\t\t\t\tonKeyDown: (e) => this.onkeydown(e),\n\t\t\t} satisfies BaseSearchBarAttrs),\n\t\t)\n\t}\n\n\tprivate readonly onkeydown = (e: KeyboardEvent) => {\n\t\tconst { selected, entities } = this.state()\n\n\t\tconst keyHandlers = [\n\t\t\t{\n\t\t\t\tkey: Keys.F1,\n\t\t\t\texec: () => keyManager.openF1Help(),\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.ESC,\n\t\t\t\texec: () => this.clear(),\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.RETURN,\n\t\t\t\texec: () => {\n\t\t\t\t\tif (selected) {\n\t\t\t\t\t\tthis.selectResult(selected)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.search()\n\t\t\t\t\t}\n\t\t\t\t\t// blur() is used to hide keyboard on return button click\n\t\t\t\t\tthis.domInput.blur()\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.UP,\n\t\t\t\texec: () => {\n\t\t\t\t\tif (entities.length > 0) {\n\t\t\t\t\t\tlet oldSelected = selected || entities[0]\n\n\t\t\t\t\t\tthis.updateState({\n\t\t\t\t\t\t\tselected: entities[mod(entities.indexOf(oldSelected) - 1, entities.length)],\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.DOWN,\n\t\t\t\texec: () => {\n\t\t\t\t\tif (entities.length > 0) {\n\t\t\t\t\t\tlet newSelected = selected || entities[0]\n\n\t\t\t\t\t\tthis.updateState({\n\t\t\t\t\t\t\tselected: entities[mod(entities.indexOf(newSelected) + 1, entities.length)],\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t]\n\t\tlet keyHandler = keyHandlers.find((handler) => isKeyPressed(e.key, handler.key))\n\n\t\tif (keyHandler) {\n\t\t\tkeyHandler.exec()\n\t\t\te.preventDefault()\n\t\t}\n\n\t\t// disable shortcuts\n\t\te.stopPropagation()\n\t\treturn true\n\t}\n\n\toncreate() {\n\t\tif (isApp()) {\n\t\t\t// only focus in the mobile app, the search bar always exists in desktop/web and will always be grabbing attention\n\t\t\tthis.onFocus()\n\t\t}\n\t\tkeyManager.registerShortcuts(this.shortcuts)\n\t\tthis.indexStateStream = mailLocator.search.indexState.map((indexState) => {\n\t\t\t// When we finished indexing, search again forcibly to not confuse anyone with old results\n\t\t\tconst currentResult = this.state().searchResult\n\n\t\t\tif (\n\t\t\t\t!indexState.failedIndexingUpTo &&\n\t\t\t\tcurrentResult &&\n\t\t\t\tthis.state().indexState.progress !== 0 &&\n\t\t\t\tindexState.progress === 0 &&\n\t\t\t\t//if period is changed from search view a new search is triggered there,  and we do not want to overwrite its result\n\t\t\t\t!this.timePeriodHasChanged(currentResult.restriction.end, indexState.aimedMailIndexTimestamp)\n\t\t\t) {\n\t\t\t\tthis.doSearch(this.state().query, currentResult.restriction, m.redraw)\n\t\t\t}\n\n\t\t\tthis.updateState({\n\t\t\t\tindexState,\n\t\t\t})\n\t\t})\n\n\t\tthis.stateStream = this.state.map((state) => m.redraw())\n\t\tthis.lastQueryStream = mailLocator.search.lastQueryString.map((value) => {\n\t\t\t// Set value from the model when it's set from the URL e.g. reloading the page on the search screen\n\t\t\tif (value) {\n\t\t\t\tthis.updateState({\n\t\t\t\t\tquery: value,\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\t}\n\n\tonremove() {\n\t\tthis.focused = false\n\n\t\tif (this.shortcuts) keyManager.unregisterShortcuts(this.shortcuts)\n\n\t\tthis.stateStream?.end(true)\n\n\t\tthis.lastQueryStream?.end(true)\n\n\t\tthis.indexStateStream?.end(true)\n\n\t\tthis.closeOverlay()\n\t}\n\n\tprivate timePeriodHasChanged(oldEnd: number | null, aimedEnd: number): boolean {\n\t\treturn oldEnd !== aimedEnd\n\t}\n\n\t/**\n\t * Ensure that overlay exists in DOM\n\t */\n\tprivate showOverlay() {\n\t\tif (this.closeOverlayFunction == null && this.domWrapper != null) {\n\t\t\tthis.closeOverlayFunction = displayOverlay(\n\t\t\t\t() => this.makeOverlayRect(),\n\t\t\t\tthis.overlayContentComponent,\n\t\t\t\tundefined,\n\t\t\t\tundefined,\n\t\t\t\t\"dropdown-shadow border-radius\",\n\t\t\t)\n\t\t} else {\n\t\t\tm.redraw()\n\t\t}\n\t}\n\n\tprivate closeOverlay() {\n\t\tif (this.closeOverlayFunction) {\n\t\t\tthis.closeOverlayFunction()\n\n\t\t\tthis.closeOverlayFunction = null\n\t\t}\n\t}\n\n\tprivate makeOverlayRect(): PositionRect {\n\t\t// note: this is called on every render which probably thrashes our layout constantly.\n\t\t// we should at least not do it while we don't have anything to show\n\t\tlet overlayRect: PositionRect\n\n\t\tconst domRect = this.domWrapper.getBoundingClientRect()\n\n\t\tif (styles.isDesktopLayout()) {\n\t\t\toverlayRect = {\n\t\t\t\ttop: px(domRect.bottom + 5),\n\t\t\t\tright: px(window.innerWidth - domRect.right),\n\t\t\t\twidth: px(350),\n\t\t\t\tzIndex: LayerType.LowPriorityOverlay,\n\t\t\t}\n\t\t} else if (window.innerWidth < 500) {\n\t\t\toverlayRect = {\n\t\t\t\ttop: px(size.navbar_height_mobile + 6),\n\t\t\t\tleft: px(16),\n\t\t\t\tright: px(16),\n\t\t\t\tzIndex: LayerType.LowPriorityOverlay,\n\t\t\t}\n\t\t} else {\n\t\t\toverlayRect = {\n\t\t\t\ttop: px(size.navbar_height_mobile + 6),\n\t\t\t\tleft: px(domRect.left),\n\t\t\t\tright: px(window.innerWidth - domRect.right),\n\t\t\t\tzIndex: LayerType.LowPriorityOverlay,\n\t\t\t}\n\t\t}\n\n\t\treturn overlayRect\n\t}\n\n\tprivate readonly shortcuts: ReadonlyArray<Shortcut> = [\n\t\t{\n\t\t\tkey: Keys.F,\n\t\t\tenabled: () => true,\n\t\t\texec: () => {\n\t\t\t\tthis.onFocus()\n\t\t\t\tm.redraw()\n\t\t\t},\n\t\t\thelp: \"search_label\",\n\t\t},\n\t]\n\n\tprivate selectResult(result: (Mail | null) | Contact | WhitelabelChild | CalendarEvent | ShowMoreAction) {\n\t\tconst { query } = this.state()\n\n\t\tif (result != null) {\n\t\t\tlet type: TypeRef<any> | null = \"_type\" in result ? result._type : null\n\n\t\t\tif (!type) {\n\t\t\t\t// click on SHOW MORE button\n\t\t\t\tif ((result as ShowMoreAction).allowShowMore) {\n\t\t\t\t\tthis.updateSearchUrl(query)\n\t\t\t\t}\n\t\t\t} else if (isSameTypeRef(MailTypeRef, type)) {\n\t\t\t\tthis.updateSearchUrl(query, downcast(result))\n\t\t\t} else if (isSameTypeRef(ContactTypeRef, type)) {\n\t\t\t\tthis.updateSearchUrl(query, downcast(result))\n\t\t\t} else if (isSameTypeRef(CalendarEventTypeRef, type)) {\n\t\t\t\tthis.updateSearchUrl(query, downcast(result))\n\t\t\t}\n\t\t}\n\t}\n\n\thandleSearchClick() {\n\t\tif (!this.focused) {\n\t\t\tthis.onFocus()\n\t\t} else {\n\t\t\tthis.search()\n\t\t}\n\t}\n\n\tprivate getRestriction(): SearchRestriction {\n\t\treturn getRestriction(m.route.get())\n\t}\n\n\tprivate updateSearchUrl(query: string, selected?: ListElementEntity) {\n\t\tif (selected && assertIsEntity(selected, CalendarEventTypeRef)) {\n\t\t\tsearchRouter.routeTo(query, this.getRestriction(), selected && encodeCalendarSearchKey(selected))\n\t\t} else {\n\t\t\tsearchRouter.routeTo(query, this.getRestriction(), selected && getElementId(selected))\n\t\t}\n\t}\n\n\tprivate search(query?: string) {\n\t\tlet oldQuery = this.state().query\n\n\t\tif (query != null) {\n\t\t\tthis.updateState({\n\t\t\t\tquery,\n\t\t\t})\n\t\t} else {\n\t\t\tquery = oldQuery\n\t\t}\n\n\t\tlet restriction = this.getRestriction()\n\n\t\tif (!mailLocator.search.indexState().mailIndexEnabled && restriction && isSameTypeRef(restriction.type, MailTypeRef) && !this.confirmDialogShown) {\n\t\t\tthis.focused = false\n\t\t\tthis.confirmDialogShown = true\n\t\t\tDialog.confirm(\"enableSearchMailbox_msg\", \"search_label\")\n\t\t\t\t.then((confirmed) => {\n\t\t\t\t\tif (confirmed) {\n\t\t\t\t\t\tmailLocator.indexerFacade\n\t\t\t\t\t\t\t.enableMailIndexing()\n\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\tthis.search()\n\t\t\t\t\t\t\t\tthis.onFocus()\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch(\n\t\t\t\t\t\t\t\tofClass(IndexingNotSupportedError, () => {\n\t\t\t\t\t\t\t\t\tDialog.message(isApp() ? \"searchDisabledApp_msg\" : \"searchDisabled_msg\")\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.finally(() => (this.confirmDialogShown = false))\n\t\t} else {\n\t\t\t// Skip the search if the user is trying to bypass the search dialog\n\t\t\tif (!mailLocator.search.indexState().mailIndexEnabled && isSameTypeRef(restriction.type, MailTypeRef)) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tif (!mailLocator.search.isNewSearch(query, restriction) && oldQuery === query) {\n\t\t\t\tconst result = mailLocator.search.result()\n\n\t\t\t\tif (this.isQuickSearch() && result) {\n\t\t\t\t\tthis.showResultsInOverlay(result)\n\t\t\t\t}\n\n\t\t\t\tthis.busy = false\n\t\t\t} else {\n\t\t\t\tif (query.trim() !== \"\") {\n\t\t\t\t\tthis.busy = true\n\t\t\t\t}\n\n\t\t\t\tthis.doSearch(query, restriction, () => {\n\t\t\t\t\tthis.busy = false\n\t\t\t\t\tm.redraw()\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate readonly doSearch = debounce(300, (query: string, restriction: SearchRestriction, cb: () => void) => {\n\t\tif (!this.isQuickSearch()) {\n\t\t\t// if we're already on the search view, we don't want to wait until there's a new result to update the\n\t\t\t// UI. we can directly go to the URL and let the SearchViewModel do its thing from there.\n\t\t\tsearchRouter.routeTo(query, restriction)\n\t\t\treturn cb()\n\t\t}\n\n\t\tlet useSuggestions = m.route.get().startsWith(\"/settings\")\n\t\t// We don't limit contacts because we need to download all of them to sort them. They should be cached anyway.\n\t\tconst limit = isSameTypeRef(MailTypeRef, restriction.type) ? (this.isQuickSearch() ? MAX_SEARCH_PREVIEW_RESULTS : PageSize) : null\n\n\t\tmailLocator.search\n\t\t\t.search(\n\t\t\t\t{\n\t\t\t\t\tquery: query ?? \"\",\n\t\t\t\t\trestriction,\n\t\t\t\t\tminSuggestionCount: useSuggestions ? 10 : 0,\n\t\t\t\t\tmaxResults: limit,\n\t\t\t\t},\n\t\t\t\tmailLocator.progressTracker,\n\t\t\t)\n\t\t\t.then((result) => this.loadAndDisplayResult(query, result ? result : null, limit))\n\t\t\t.finally(() => cb())\n\t})\n\n\t/** Given the result from the search load additional results if needed and then display them or set URL. */\n\tprivate loadAndDisplayResult(query: string, result: SearchResult | null, limit: number | null) {\n\t\tconst safeResult = result,\n\t\t\tsafeLimit = limit\n\n\t\tthis.updateState({\n\t\t\tsearchResult: safeResult,\n\t\t})\n\n\t\tif (!safeResult || mailLocator.search.isNewSearch(query, safeResult.restriction)) {\n\t\t\treturn\n\t\t}\n\n\t\tif (this.isQuickSearch()) {\n\t\t\tif (safeLimit && hasMoreResults(safeResult) && safeResult.results.length < safeLimit) {\n\t\t\t\tmailLocator.searchFacade.getMoreSearchResults(safeResult, safeLimit - safeResult.results.length).then((moreResults) => {\n\t\t\t\t\tif (mailLocator.search.isNewSearch(query, moreResults.restriction)) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.loadAndDisplayResult(query, moreResults, limit)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tthis.showResultsInOverlay(safeResult)\n\t\t\t}\n\t\t} else {\n\t\t\t// instances will be displayed as part of the list of the search view, when the search view is displayed\n\t\t\tsearchRouter.routeTo(query, safeResult.restriction)\n\t\t}\n\t}\n\n\tprivate clear() {\n\t\tif (m.route.get().startsWith(\"/search\")) {\n\t\t\t// this needs to happen in this order, otherwise the list's result subscription will override our\n\t\t\t// routing.\n\t\t\tthis.updateSearchUrl(\"\")\n\t\t\tmailLocator.search.result(null)\n\t\t}\n\n\t\tthis.updateState({\n\t\t\tquery: \"\",\n\t\t\tentities: [],\n\t\t\tselected: null,\n\t\t\tsearchResult: null,\n\t\t})\n\t}\n\n\tprivate async showResultsInOverlay(result: SearchResult): Promise<void> {\n\t\tconst filteredEvents = result.results.filter(([calendarId, eventId]) => !isClientOnlyCalendar(calendarId))\n\n\t\tconst eventsRepository = await mailLocator.calendarEventsRepository()\n\t\tconst entries = [\n\t\t\t...(await loadMultipleFromLists(result.restriction.type, mailLocator.entityClient, filteredEvents)),\n\t\t\t...(await retrieveClientOnlyEventsForUser(mailLocator.logins, result.results, eventsRepository.getBirthdayEvents())),\n\t\t]\n\n\t\t// If there was no new search while we've been downloading the result\n\t\tif (!mailLocator.search.isNewSearch(result.query, result.restriction)) {\n\t\t\tconst { filteredEntries, couldShowMore } = this.filterResults(entries, result.restriction)\n\n\t\t\tif (\n\t\t\t\tresult.query.trim() !== \"\" &&\n\t\t\t\t(filteredEntries.length === 0 || hasMoreResults(result) || couldShowMore || result.currentIndexTimestamp !== FULL_INDEXED_TIMESTAMP)\n\t\t\t) {\n\t\t\t\tconst moreEntry: ShowMoreAction = {\n\t\t\t\t\tresultCount: result.results.length,\n\t\t\t\t\tshownCount: filteredEntries.length,\n\t\t\t\t\tindexTimestamp: result.currentIndexTimestamp,\n\t\t\t\t\tallowShowMore: true,\n\t\t\t\t}\n\t\t\t\tfilteredEntries.push(moreEntry)\n\t\t\t}\n\n\t\t\tthis.updateState({\n\t\t\t\tentities: filteredEntries,\n\t\t\t\tselected: filteredEntries[0],\n\t\t\t})\n\t\t}\n\t}\n\n\tprivate isQuickSearch(): boolean {\n\t\treturn !m.route.get().startsWith(\"/search\")\n\t}\n\n\tprivate filterResults(instances: Array<Entry>, restriction: SearchRestriction): { filteredEntries: Entries; couldShowMore: boolean } {\n\t\tif (isSameTypeRef(restriction.type, ContactTypeRef)) {\n\t\t\t// Sort contacts by name\n\t\t\treturn {\n\t\t\t\tfilteredEntries: instances\n\t\t\t\t\t.slice() // we can't modify the given array\n\t\t\t\t\t.sort((o1, o2) => compareContacts(o1 as any, o2 as any))\n\t\t\t\t\t.slice(0, MAX_SEARCH_PREVIEW_RESULTS),\n\t\t\t\tcouldShowMore: instances.length > MAX_SEARCH_PREVIEW_RESULTS,\n\t\t\t}\n\t\t} else if (isSameTypeRef(restriction.type, CalendarEventTypeRef)) {\n\t\t\tconst range = { start: restriction.start ?? 0, end: restriction.end ?? 0 }\n\t\t\tconst generatedInstances = generateCalendarInstancesInRange(downcast(instances), range, MAX_SEARCH_PREVIEW_RESULTS + 1)\n\t\t\treturn {\n\t\t\t\tfilteredEntries: generatedInstances.slice(0, MAX_SEARCH_PREVIEW_RESULTS),\n\t\t\t\tcouldShowMore: generatedInstances.length > MAX_SEARCH_PREVIEW_RESULTS,\n\t\t\t}\n\t\t}\n\t\treturn { filteredEntries: instances.slice(0, MAX_SEARCH_PREVIEW_RESULTS), couldShowMore: instances.length > MAX_SEARCH_PREVIEW_RESULTS }\n\t}\n\n\tprivate onFocus() {\n\t\tif (!mailLocator.search.indexingSupported) {\n\t\t\tDialog.message(isApp() ? \"searchDisabledApp_msg\" : \"searchDisabled_msg\")\n\t\t} else if (!this.focused) {\n\t\t\tthis.focused = true\n\t\t\t// setTimeout to fix bug in current Safari with losing focus\n\t\t\tsetTimeout(\n\t\t\t\t() => {\n\t\t\t\t\tthis.domInput.focus()\n\n\t\t\t\t\tthis.search()\n\t\t\t\t},\n\t\t\t\tclient.browser === BrowserType.SAFARI ? 200 : 0,\n\t\t\t)\n\t\t}\n\t}\n\n\tprivate onBlur() {\n\t\tthis.focused = false\n\n\t\tif (this.state().query === \"\") {\n\t\t\tif (m.route.get().startsWith(\"/search\")) {\n\t\t\t\tconst restriction = searchRouter.getRestriction()\n\t\t\t\tsearchRouter.routeTo(\"\", restriction)\n\t\t\t}\n\t\t}\n\t\tm.redraw()\n\t}\n\n\tprivate updateState(update: Partial<SearchBarState>): SearchBarState {\n\t\tconst newState = Object.assign({}, this.state(), update)\n\n\t\tthis.state(newState)\n\n\t\treturn newState\n\t}\n}\n\n// Should be changed to not be a singleton and be proper component (instantiated by mithril).\n// We need to extract some state of it into some kind of viewModel, pluggable depending on the current view but this requires complete rewrite of SearchBar.\nexport const searchBar = new SearchBar()\n"]}