{"version":3,"file":"LabelsPopup.js","sourceRoot":"","sources":["../../../../../src/mail-app/mail/view/LabelsPopup.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Children, VnodeDOM } from \"mithril\"\nimport { modal, ModalComponent } from \"../../../common/gui/base/Modal.js\"\nimport { focusNext, focusPrevious, Shortcut } from \"../../../common/misc/KeyManager.js\"\nimport { BaseButton, BaseButtonAttrs } from \"../../../common/gui/base/buttons/BaseButton.js\"\nimport { PosRect, showDropdown } from \"../../../common/gui/base/Dropdown.js\"\nimport { MailFolder } from \"../../../common/api/entities/tutanota/TypeRefs.js\"\nimport { size } from \"../../../common/gui/size.js\"\nimport { AllIcons, Icon, IconSize } from \"../../../common/gui/base/Icon.js\"\nimport { Icons } from \"../../../common/gui/base/icons/Icons.js\"\nimport { theme } from \"../../../common/gui/theme.js\"\nimport { Keys, MAX_LABELS_PER_MAIL, TabIndex } from \"../../../common/api/common/TutanotaConstants.js\"\nimport { getElementId } from \"../../../common/api/common/utils/EntityUtils.js\"\nimport { getLabelColor } from \"../../../common/gui/base/Label.js\"\nimport { LabelState } from \"../model/MailModel.js\"\nimport { AriaRole } from \"../../../common/gui/AriaUtils.js\"\nimport { lang } from \"../../../common/misc/LanguageViewModel.js\"\nimport { noOp } from \"@tutao/tutanota-utils\"\n\n/**\n * Popup that displays assigned labels and allows changing them\n */\nexport class LabelsPopup implements ModalComponent {\n\tprivate dom: HTMLElement | null = null\n\tprivate isMaxLabelsReached: boolean\n\n\tconstructor(\n\t\tprivate readonly sourceElement: HTMLElement,\n\t\tprivate readonly origin: PosRect,\n\t\tprivate readonly width: number,\n\t\tprivate readonly labelsForMails: ReadonlyMap<Id, ReadonlyArray<MailFolder>>,\n\t\tprivate readonly labels: { label: MailFolder; state: LabelState }[],\n\t\tprivate readonly onLabelsApplied: (addedLabels: MailFolder[], removedLabels: MailFolder[]) => unknown,\n\t) {\n\t\tthis.view = this.view.bind(this)\n\t\tthis.oncreate = this.oncreate.bind(this)\n\t\tthis.isMaxLabelsReached = this.checkIsMaxLabelsReached()\n\t}\n\n\tasync hideAnimation(): Promise<void> {}\n\n\tonClose(): void {\n\t\tmodal.remove(this)\n\t}\n\n\tshortcuts(): Shortcut[] {\n\t\treturn this.shortCuts\n\t}\n\n\tbackgroundClick(e: MouseEvent): void {\n\t\tmodal.remove(this)\n\t}\n\n\tpopState(e: Event): boolean {\n\t\treturn true\n\t}\n\n\tcallingElement(): HTMLElement | null {\n\t\treturn this.sourceElement\n\t}\n\n\tview(): void | Children {\n\t\treturn m(\".flex.col.elevated-bg.abs.dropdown-shadow.pt-s.border-radius\", { tabindex: TabIndex.Programmatic, role: AriaRole.Menu }, [\n\t\t\tm(\n\t\t\t\t\".pb-s.scroll\",\n\t\t\t\tthis.labels.map((labelState) => {\n\t\t\t\t\tconst { label, state } = labelState\n\t\t\t\t\tconst color = theme.content_button\n\t\t\t\t\tconst canToggleLabel = state === LabelState.Applied || state === LabelState.AppliedToSome || !this.isMaxLabelsReached\n\t\t\t\t\tconst opacity = !canToggleLabel ? 0.5 : undefined\n\n\t\t\t\t\treturn m(\n\t\t\t\t\t\t\"label-item.flex.items-center.plr.state-bg.cursor-pointer\",\n\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\"data-labelid\": getElementId(label),\n\t\t\t\t\t\t\trole: AriaRole.MenuItemCheckbox,\n\t\t\t\t\t\t\ttabindex: TabIndex.Default,\n\t\t\t\t\t\t\t\"aria-checked\": ariaCheckedForState(state),\n\t\t\t\t\t\t\t\"aria-disabled\": !canToggleLabel,\n\t\t\t\t\t\t\tonclick: canToggleLabel ? () => this.toggleLabel(labelState) : noOp,\n\t\t\t\t\t\t},\n\t\t\t\t\t\t[\n\t\t\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\t\t\ticon: this.iconForState(state),\n\t\t\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\tfill: getLabelColor(label.color),\n\t\t\t\t\t\t\t\t\topacity,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\tm(\".button-height.flex.items-center.ml.overflow-hidden\", { style: { color, opacity } }, m(\".text-ellipsis\", label.name)),\n\t\t\t\t\t\t],\n\t\t\t\t\t)\n\t\t\t\t}),\n\t\t\t),\n\t\t\tthis.isMaxLabelsReached && m(\".small.center.pb-s\", lang.get(\"maximumLabelsPerMailReached_msg\")),\n\t\t\tm(BaseButton, {\n\t\t\t\tlabel: \"apply_action\",\n\t\t\t\ttext: lang.get(\"apply_action\"),\n\t\t\t\tclass: \"limit-width noselect bg-transparent button-height text-ellipsis content-accent-fg flex items-center plr-button button-content justify-center border-top state-bg\",\n\t\t\t\tonclick: () => {\n\t\t\t\t\tthis.applyLabels()\n\t\t\t\t},\n\t\t\t} satisfies BaseButtonAttrs),\n\t\t\tm(BaseButton, {\n\t\t\t\tlabel: \"close_alt\",\n\t\t\t\ttext: lang.get(\"close_alt\"),\n\t\t\t\tclass: \"hidden-until-focus content-accent-fg button-content\",\n\t\t\t\tonclick: () => {\n\t\t\t\t\tmodal.remove(this)\n\t\t\t\t},\n\t\t\t}),\n\t\t])\n\t}\n\n\tprivate iconForState(state: LabelState): AllIcons {\n\t\tswitch (state) {\n\t\t\tcase LabelState.AppliedToSome:\n\t\t\t\treturn Icons.LabelPartial\n\t\t\tcase LabelState.Applied:\n\t\t\t\treturn Icons.Label\n\t\t\tcase LabelState.NotApplied:\n\t\t\t\treturn Icons.LabelOutline\n\t\t}\n\t}\n\n\tprivate checkIsMaxLabelsReached(): boolean {\n\t\tconst { addedLabels, removedLabels } = this.getSortedLabels()\n\t\tif (addedLabels.length >= MAX_LABELS_PER_MAIL) {\n\t\t\treturn true\n\t\t}\n\n\t\tfor (const [, labels] of this.labelsForMails) {\n\t\t\tconst labelsOnMail = new Set<Id>(labels.map((label) => getElementId(label)))\n\n\t\t\tfor (const label of removedLabels) {\n\t\t\t\tlabelsOnMail.delete(getElementId(label))\n\t\t\t}\n\t\t\tif (labelsOnMail.size >= MAX_LABELS_PER_MAIL) {\n\t\t\t\treturn true\n\t\t\t}\n\n\t\t\tfor (const label of addedLabels) {\n\t\t\t\tlabelsOnMail.add(getElementId(label))\n\t\t\t\tif (labelsOnMail.size >= MAX_LABELS_PER_MAIL) {\n\t\t\t\t\treturn true\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn false\n\t}\n\n\tprivate getSortedLabels(): Record<\"addedLabels\" | \"removedLabels\", MailFolder[]> {\n\t\tconst removedLabels: MailFolder[] = []\n\t\tconst addedLabels: MailFolder[] = []\n\t\tfor (const { label, state } of this.labels) {\n\t\t\tif (state === LabelState.Applied) {\n\t\t\t\taddedLabels.push(label)\n\t\t\t} else if (state === LabelState.NotApplied) {\n\t\t\t\tremovedLabels.push(label)\n\t\t\t}\n\t\t}\n\t\treturn { addedLabels, removedLabels }\n\t}\n\n\tprivate applyLabels() {\n\t\tconst { addedLabels, removedLabels } = this.getSortedLabels()\n\t\tthis.onLabelsApplied(addedLabels, removedLabels)\n\t\tmodal.remove(this)\n\t}\n\n\toncreate(vnode: VnodeDOM) {\n\t\tthis.dom = vnode.dom as HTMLElement\n\n\t\t// restrict label height to showing maximum 6 labels to avoid overflow\n\t\tconst displayedLabels = Math.min(this.labels.length, 6)\n\t\tconst height = (displayedLabels + 1) * size.button_height + size.vpad_small * 2\n\t\tshowDropdown(this.origin, this.dom, height, this.width).then(() => {\n\t\t\tconst firstLabel = vnode.dom.getElementsByTagName(\"label-item\").item(0)\n\t\t\tif (firstLabel !== null) {\n\t\t\t\t;(firstLabel as HTMLElement).focus()\n\t\t\t} else {\n\t\t\t\t;(vnode.dom as HTMLElement).focus()\n\t\t\t}\n\t\t})\n\t}\n\n\tprivate readonly shortCuts: Array<Shortcut> = [\n\t\t{\n\t\t\tkey: Keys.ESC,\n\t\t\texec: () => this.onClose(),\n\t\t\thelp: \"close_alt\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.TAB,\n\t\t\tshift: true,\n\t\t\texec: () => (this.dom ? focusPrevious(this.dom) : false),\n\t\t\thelp: \"selectPrevious_action\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.TAB,\n\t\t\tshift: false,\n\t\t\texec: () => (this.dom ? focusNext(this.dom) : false),\n\t\t\thelp: \"selectNext_action\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.UP,\n\t\t\texec: () => (this.dom ? focusPrevious(this.dom) : false),\n\t\t\thelp: \"selectPrevious_action\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.DOWN,\n\t\t\texec: () => (this.dom ? focusNext(this.dom) : false),\n\t\t\thelp: \"selectNext_action\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.RETURN,\n\t\t\texec: () => this.applyLabels(),\n\t\t\thelp: \"ok_action\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.SPACE,\n\t\t\texec: () => {\n\t\t\t\tconst labelId = document.activeElement?.getAttribute(\"data-labelid\")\n\t\t\t\tif (labelId) {\n\t\t\t\t\tconst labelItem = this.labels.find((item) => getElementId(item.label) === labelId)\n\t\t\t\t\tif (labelItem) {\n\t\t\t\t\t\tthis.toggleLabel(labelItem)\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\treturn true\n\t\t\t\t}\n\t\t\t},\n\t\t\thelp: \"ok_action\",\n\t\t},\n\t]\n\n\tshow() {\n\t\tmodal.displayUnique(this, false)\n\t}\n\n\tprivate toggleLabel(labelState: { label: MailFolder; state: LabelState }) {\n\t\tswitch (labelState.state) {\n\t\t\tcase LabelState.AppliedToSome:\n\t\t\t\tlabelState.state = this.isMaxLabelsReached ? LabelState.NotApplied : LabelState.Applied\n\t\t\t\tbreak\n\t\t\tcase LabelState.NotApplied:\n\t\t\t\tlabelState.state = LabelState.Applied\n\t\t\t\tbreak\n\t\t\tcase LabelState.Applied:\n\t\t\t\tlabelState.state = LabelState.NotApplied\n\t\t\t\tbreak\n\t\t}\n\n\t\tthis.isMaxLabelsReached = this.checkIsMaxLabelsReached()\n\t}\n}\n\nfunction ariaCheckedForState(state: LabelState): string {\n\tswitch (state) {\n\t\tcase LabelState.Applied:\n\t\t\treturn \"true\"\n\t\tcase LabelState.AppliedToSome:\n\t\t\treturn \"mixed\"\n\t\tcase LabelState.NotApplied:\n\t\t\treturn \"false\"\n\t}\n}\n"]}