{"version":3,"file":"ConversationViewer.js","sourceRoot":"","sources":["../../../../../src/mail-app/mail/view/ConversationViewer.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Children, Component, Vnode } from \"mithril\"\nimport { ConversationItem, ConversationViewModel } from \"./ConversationViewModel.js\"\nimport { MailViewer } from \"./MailViewer.js\"\nimport { lang } from \"../../../common/misc/LanguageViewModel.js\"\nimport { theme } from \"../../../common/gui/theme.js\"\nimport { Button, ButtonType } from \"../../../common/gui/base/Button.js\"\nimport { elementIdPart, isSameId } from \"../../../common/api/common/utils/EntityUtils.js\"\nimport { CollapsedMailView } from \"./CollapsedMailView.js\"\nimport { MailViewerViewModel } from \"./MailViewerViewModel.js\"\nimport { px, size } from \"../../../common/gui/size.js\"\nimport { Keys } from \"../../../common/api/common/TutanotaConstants.js\"\nimport { keyManager, Shortcut } from \"../../../common/misc/KeyManager.js\"\nimport { styles } from \"../../../common/gui/styles.js\"\nimport { responsiveCardHMargin } from \"../../../common/gui/cards.js\"\n\nexport interface ConversationViewerAttrs {\n\tviewModel: ConversationViewModel\n\tdelayBodyRendering: Promise<unknown>\n}\n\nconst SCROLL_FACTOR = 4 / 5\n\nexport const conversationCardMargin = size.hpad_large\n\n/**\n * Displays mails in a conversation\n */\nexport class ConversationViewer implements Component<ConversationViewerAttrs> {\n\tprivate containerDom: HTMLElement | null = null\n\tprivate didScroll = false\n\t/** items from the last render, we need them to calculate the right subject based on the scroll position without the full re-render. */\n\tprivate lastItems: readonly ConversationItem[] | null = null\n\n\tprivate readonly shortcuts: Shortcut[] = [\n\t\t{\n\t\t\tkey: Keys.PAGE_UP,\n\t\t\texec: () => this.scrollUp(),\n\t\t\thelp: \"scrollUp_action\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.PAGE_DOWN,\n\t\t\texec: () => this.scrollDown(),\n\t\t\thelp: \"scrollDown_action\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.HOME,\n\t\t\texec: () => this.scrollToTop(),\n\t\t\thelp: \"scrollToTop_action\",\n\t\t},\n\t\t{\n\t\t\tkey: Keys.END,\n\t\t\texec: () => this.scrollToBottom(),\n\t\t\thelp: \"scrollToBottom_action\",\n\t\t},\n\t]\n\n\toncreate() {\n\t\tkeyManager.registerShortcuts(this.shortcuts)\n\t}\n\n\tonremove() {\n\t\tkeyManager.unregisterShortcuts(this.shortcuts)\n\t}\n\n\tview(vnode: Vnode<ConversationViewerAttrs>): Children {\n\t\tconst { viewModel, delayBodyRendering } = vnode.attrs\n\n\t\tviewModel.init(delayBodyRendering)\n\n\t\tthis.lastItems = viewModel.conversationItems()\n\t\tthis.doScroll(viewModel, this.lastItems)\n\n\t\treturn m(\".fill-absolute.nav-bg.flex.col\", [\n\t\t\t// see comment for .scrollbar-gutter-stable-or-fallback\n\t\t\tm(\n\t\t\t\t\".flex-grow.overflow-y-scroll\",\n\t\t\t\t{\n\t\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\t\tthis.containerDom = vnode.dom as HTMLElement\n\t\t\t\t\t},\n\t\t\t\t\tonremove: () => {\n\t\t\t\t\t\tconsole.log(\"remove container\")\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tthis.renderItems(viewModel, this.lastItems),\n\t\t\t\tthis.renderLoadingState(viewModel),\n\t\t\t\tthis.renderFooter(),\n\t\t\t),\n\t\t])\n\t}\n\n\tprivate renderFooter() {\n\t\t// Having more room at the bottom allows the last email so it is (almost) always in the same place on the screen.\n\t\t// We reduce space by 100 for the header of the viewer and a bit more\n\t\tconst height =\n\t\t\tdocument.body.offsetHeight - (styles.isUsingBottomNavigation() ? size.navbar_height_mobile + size.bottom_nav_bar : size.navbar_height) - 300\n\t\treturn m(\".mt-l.noprint\", {\n\t\t\tstyle: {\n\t\t\t\theight: px(height),\n\t\t\t},\n\t\t})\n\t}\n\n\tprivate renderItems(viewModel: ConversationViewModel, entries: readonly ConversationItem[]): Children {\n\t\treturn entries.map((entry, position) => {\n\t\t\tswitch (entry.type) {\n\t\t\t\tcase \"mail\": {\n\t\t\t\t\tconst mailViewModel = entry.viewModel\n\t\t\t\t\tconst isPrimary = mailViewModel === viewModel.primaryViewModel()\n\t\t\t\t\t// only pass in position if we do have an actual conversation position\n\t\t\t\t\treturn this.renderViewer(mailViewModel, isPrimary, viewModel.isFinished() ? position : null)\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t}\n\n\tprivate renderLoadingState(viewModel: ConversationViewModel): Children {\n\t\treturn viewModel.isConnectionLost()\n\t\t\t? m(\n\t\t\t\t\t\".center\",\n\t\t\t\t\tm(Button, {\n\t\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t\t\tlabel: \"retry_action\",\n\t\t\t\t\t\tclick: () => viewModel.retry(),\n\t\t\t\t\t}),\n\t\t\t  )\n\t\t\t: !viewModel.isFinished()\n\t\t\t? m(\n\t\t\t\t\t\".font-weight-600.center.mt-l\" + \".\" + responsiveCardHMargin(),\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tcolor: theme.content_button,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tlang.get(\"loading_msg\"),\n\t\t\t  )\n\t\t\t: null\n\t}\n\n\tprivate renderViewer(mailViewModel: MailViewerViewModel, isPrimary: boolean, position: number | null): Children {\n\t\treturn m(\n\t\t\t\".mlr-safe-inset\",\n\t\t\tm(\n\t\t\t\t\".border-radius-big.rel\",\n\t\t\t\t{\n\t\t\t\t\tclass: responsiveCardHMargin(),\n\t\t\t\t\tkey: elementIdPart(mailViewModel.mail.conversationEntry),\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tbackgroundColor: theme.content_bg,\n\t\t\t\t\t\tmarginTop: px(position == null || position === 0 ? 0 : conversationCardMargin),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tmailViewModel.isCollapsed()\n\t\t\t\t\t? m(CollapsedMailView, {\n\t\t\t\t\t\t\tviewModel: mailViewModel,\n\t\t\t\t\t  })\n\t\t\t\t\t: m(MailViewer, {\n\t\t\t\t\t\t\tviewModel: mailViewModel,\n\t\t\t\t\t\t\tisPrimary: isPrimary,\n\t\t\t\t\t\t\t// we want to expand for the first email like when it's a forwarded email\n\t\t\t\t\t\t\tdefaultQuoteBehavior: position === 0 ? \"expand\" : \"collapse\",\n\t\t\t\t\t  }),\n\t\t\t),\n\t\t)\n\t}\n\n\tprivate doScroll(viewModel: ConversationViewModel, items: readonly ConversationItem[]) {\n\t\tconst containerDom = this.containerDom\n\t\tif (!this.didScroll && containerDom && viewModel.isFinished()) {\n\t\t\tconst conversationId = viewModel.primaryMail.conversationEntry\n\n\t\t\tthis.didScroll = true\n\t\t\t// We need to do this at the end of the frame when every change is already applied.\n\t\t\t// Promise.resolve() schedules a microtask exactly where we need it.\n\t\t\t// RAF is too long and would flash the wrong frame\n\t\t\tPromise.resolve().then(() => {\n\t\t\t\t// There's a chance that item are not in sync with dom but it's very unlikely, this is the same frame after the last render we used the items\n\t\t\t\t// and viewModel is finished.\n\t\t\t\tconst itemIndex = items.findIndex((e) => e.type === \"mail\" && isSameId(e.entryId, conversationId))\n\t\t\t\t// Don't scroll if it's already the first (or if we didn't find it but that would be weird)\n\t\t\t\tif (itemIndex > 0) {\n\t\t\t\t\tconst childDom = containerDom.childNodes[itemIndex] as HTMLElement\n\t\t\t\t\tconst parentTop = containerDom.getBoundingClientRect().top\n\t\t\t\t\tconst childTop = childDom.getBoundingClientRect().top\n\t\t\t\t\tconst relativeTop = childTop - parentTop\n\t\t\t\t\tconst top = relativeTop - conversationCardMargin * 2 - 10\n\t\t\t\t\tcontainerDom.scrollTo({ top: top })\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\t}\n\n\tprivate scrollUp(): void {\n\t\tif (this.containerDom) {\n\t\t\tthis.containerDom.scrollBy({ top: -this.containerDom.clientHeight * SCROLL_FACTOR, behavior: \"smooth\" })\n\t\t}\n\t}\n\n\tprivate scrollDown(): void {\n\t\tif (this.containerDom) {\n\t\t\tthis.containerDom.scrollBy({ top: this.containerDom.clientHeight * SCROLL_FACTOR, behavior: \"smooth\" })\n\t\t}\n\t}\n\n\tprivate scrollToTop(): void {\n\t\tif (this.containerDom) {\n\t\t\tthis.containerDom.scrollTo({ top: 0, behavior: \"smooth\" })\n\t\t}\n\t}\n\n\tprivate scrollToBottom(): void {\n\t\tif (this.containerDom) {\n\t\t\tthis.containerDom.scrollTo({ top: this.containerDom.scrollHeight - this.containerDom.offsetHeight, behavior: \"smooth\" })\n\t\t}\n\t}\n}\n"]}