{"version":3,"file":"MailEditorViewModel.js","sourceRoot":"","sources":["../../../../../src/mail-app/mail/editor/MailEditorViewModel.ts"],"names":[],"mappings":"AAAA,OAAO,CAAC,MAAM,SAAS,CAAA;AAGvB,OAAO,EAAE,QAAQ,EAAE,gBAAgB,EAAE,SAAS,EAAE,OAAO,EAAE,MAAM,EAAE,MAAM,uBAAuB,CAAA;AAC9F,OAAO,EAAE,IAAI,EAAE,MAAM,gCAAgC,CAAA;AACrD,OAAO,EAAE,eAAe,EAAE,MAAM,kDAAkD,CAAA;AAClF,OAAO,EAAE,MAAM,EAAE,MAAM,iCAAiC,CAAA;AACxD,OAAO,EAAE,iBAAiB,EAAE,MAAM,oDAAoD,CAAA;AACtF,OAAO,EAAE,IAAI,EAAE,MAAM,wCAAwC,CAAA;AAC7D,OAAO,EAAE,aAAa,EAAE,MAAM,gDAAgD,CAAA;AAC9E,OAAO,EAAE,SAAS,EAAE,MAAM,oCAAoC,CAAA;AAC9D,OAAO,EAAE,aAAa,EAAE,MAAM,uCAAuC,CAAA;AACrE,OAAO,EAAE,OAAO,EAAE,MAAM,wCAAwC,CAAA;AAChE,OAAO,EAAiB,UAAU,EAAE,eAAe,EAAE,cAAc,EAAE,MAAM,4CAA4C,CAAA;AAEvH,OAAO,EAAE,eAAe,EAAE,MAAM,wCAAwC,CAAA;AACxE,OAAO,EAAE,gBAAgB,EAAE,MAAM,sDAAsD,CAAA;AACvF,OAAO,EAAyB,cAAc,EAAE,MAAM,yCAAyC,CAAA;AAE/F,MAAM,CAAC,KAAK,UAAU,mBAAmB,CACxC,KAAoB,EACpB,YAAwB,EACxB,SAAyB;IAEzB,YAAY,CAAC,MAAM,GAAG,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,MAAM,CAAC,CAAA;IACrD,YAAY,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,KAAK,CAAC,CAAA;IACnD,YAAY,CAAC,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC,CAAC,CAAA;IAC3C,YAAY,CAAC,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC,CAAC,CAAA;IAC3C,IAAI,CAAC;QACJ,MAAM,KAAK,GAAG,MAAM,6BAA6B,CAAC,YAAY,EAAE,SAAS,CAAC,CAAA;QAC1E,IAAI,CAAC,KAAK,IAAI,KAAK,CAAC,MAAM,KAAK,CAAC;YAAE,OAAM;QACxC,QAAQ,GAAG,CAAC,IAAI,EAAE,CAAC;YAClB,KAAK,IAAI,CAAC,GAAG;gBACZ,0CAA0C;gBAC1C,KAAK,CAAC,WAAW,CAAC,KAAK,CAAC,CAAA;gBACxB,OAAO,KAAK,CAAA;YACb,KAAK,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC;gBACnB,+HAA+H;gBAC/H,MAAM,SAAS,GAAoB,CAClC,MAAM,OAAO,CAAC,GAAG,CAAE,KAA8B,CAAC,GAAG,CAAC,KAAK,EAAE,CAAC,EAAE,EAAE,CAAC,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,CAAC,QAAQ,CAAC,CAAC,CAAC,CAC7G,CAAC,MAAM,CAAC,SAAS,CAAC,CAAA;gBACnB,KAAK,CAAC,WAAW,CAAC,SAAS,CAAC,CAAA;gBAC5B,OAAO,SAAS,CAAA;YACjB,CAAC;YACD;gBACC,2CAA2C;gBAC3C,KAAK,CAAC,WAAW,CAAC,KAAK,CAAC,CAAA;gBACxB,OAAO,KAAK,CAAA;QACd,CAAC;IACF,CAAC;IAAC,OAAO,CAAC,EAAE,CAAC;QACZ,IAAI,CAAC,YAAY,SAAS,EAAE,CAAC;YAC5B,MAAM,aAAa,CAAC,CAAC,CAAC,CAAA;QACvB,CAAC;aAAM,CAAC;YACP,MAAM,GAAG,GAAG,CAAC,CAAC,OAAO,IAAI,eAAe,CAAA;YACxC,OAAO,CAAC,KAAK,CAAC,yBAAyB,EAAE,GAAG,CAAC,CAAA;QAC9C,CAAC;IACF,CAAC;AACF,CAAC;AAED,MAAM,UAAU,6BAA6B,CAAC,YAAwB,EAAE,SAAyB;IAChG,MAAM,YAAY,GAAG,CAAC,IAAI,CAAC,GAAG,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,IAAI,CAAC;QAC/D,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,eAAe,CAAC,YAAY,EAAE,SAAS,CAAC;QAC1D,CAAC,CAAC,eAAe,CAAC,IAAI,EAAE,SAAS,CAAC,CAAA;IACnC,OAAO,YAAY;SACjB,KAAK,CACL,OAAO,CAAC,eAAe,EAAE,GAAG,EAAE;QAC7B,MAAM,CAAC,OAAO,CAAC,4BAA4B,CAAC,CAAA;IAC7C,CAAC,CAAC,CACF;SACA,KAAK,CACL,OAAO,CAAC,iBAAiB,EAAE,GAAG,EAAE;QAC/B,MAAM,CAAC,OAAO,CAAC,wBAAwB,CAAC,CAAA;IACzC,CAAC,CAAC,CACF,CAAA;AACH,CAAC;AAED,MAAM,UAAU,2BAA2B,CAAC,KAAoB,EAAE,mBAAuC;IACxG,OAAO,KAAK,CAAC,cAAc,EAAE,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,EAAE,CAAC,CAAC;QAClD,UAAU;QACV,IAAI,EAAE,IAAI;QACV,QAAQ,EAAE,GAAG,EAAE,CAAC,mBAAmB,CAAC,UAAU,CAAC;QAC/C,MAAM,EAAE,GAAG,EAAE;YACZ,KAAK,CAAC,gBAAgB,CAAC,UAAU,CAAC,CAAA;YAElC,oFAAoF;YACpF,IAAI,UAAU,CAAC,GAAG,EAAE,CAAC;gBACpB,MAAM,YAAY,GAAG,mBAAmB,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,YAAY,CAAC,KAAK,CAAC,KAAK,UAAU,CAAC,GAAG,CAAC,CAAA;gBAE9F,IAAI,YAAY,EAAE,CAAC;oBAClB,YAAY,CAAC,MAAM,EAAE,CAAA;oBACrB,MAAM,CAAC,mBAAmB,EAAE,YAAY,CAAC,CAAA;gBAC1C,CAAC;YACF,CAAC;YAED,CAAC,CAAC,MAAM,EAAE,CAAA;QACX,CAAC;QACD,UAAU,EAAE,IAAI;QAChB,IAAI,EAAE,cAAc,CAAC,OAAO;KAC5B,CAAC,CAAC,CAAA;AACJ,CAAC;AAED,KAAK,UAAU,mBAAmB,CAAC,UAAsB;IACxD,IAAI,CAAC;QACJ,IAAI,eAAe,CAAC,UAAU,CAAC,EAAE,CAAC;YACjC,MAAM,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,UAAU,CAAC,CAAA;QACvC,CAAC;aAAM,IAAI,UAAU,CAAC,UAAU,CAAC,EAAE,CAAC;YACnC,MAAM,OAAO,CAAC,cAAc,CAAC,YAAY,CAAC,UAAU,CAAC,CAAA;QACtD,CAAC;aAAM,IAAI,cAAc,CAAC,UAAU,CAAC,EAAE,CAAC;YACvC,MAAM,OAAO,CAAC,cAAc,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAA;QAClD,CAAC;aAAM,CAAC;YACP,MAAM,IAAI,gBAAgB,CAAC,6DAA6D,CAAC,CAAA;QAC1F,CAAC;IACF,CAAC;IAAC,OAAO,CAAC,EAAE,CAAC;QACZ,IAAI,CAAC,YAAY,aAAa,EAAE,CAAC;YAChC,OAAO,MAAM,CAAC,OAAO,CAAC,4BAA4B,CAAC,CAAA;QACpD,CAAC;aAAM,CAAC;YACP,MAAM,GAAG,GAAG,CAAC,CAAC,OAAO,IAAI,eAAe,CAAA;YACxC,OAAO,CAAC,KAAK,CAAC,sBAAsB,EAAE,GAAG,CAAC,CAAA;YAC1C,OAAO,MAAM,CAAC,OAAO,CAAC,yBAAyB,CAAC,CAAA;QACjD,CAAC;IACF,CAAC;AACF,CAAC;AAED,MAAM,CAAC,MAAM,wBAAwB,GAAmF,QAAQ,CAC/H,EAAE,EACF,CAAC,UAAuB,EAAE,mBAAuC,EAAE,WAA8B,EAAE,EAAE;IACpG,4GAA4G;IAC5G,oHAAoH;IACpH,kEAAkE;IAClE,qHAAqH;IACrH,gCAAgC;IAChC,EAAE;IACF,sHAAsH;IACtH,oEAAoE;IACpE,oHAAoH;IACpH,kHAAkH;IAClH,6BAA6B;IAC7B,MAAM,gBAAgB,GAAkB,EAAE,CAAA;IAC1C,KAAK,MAAM,WAAW,IAAI,mBAAmB,EAAE,CAAC;QAC/C,IAAI,UAAU,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,WAAW,CAAC,EAAE,CAAC;YACrD,MAAM,GAAG,GAAG,WAAW,CAAC,YAAY,CAAC,KAAK,CAAC,CAAA;YAC3C,MAAM,eAAe,GAAG,WAAW,CAAC,SAAS,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,GAAG,KAAK,GAAG,CAAC,CAAA;YAEnE,IAAI,eAAe,KAAK,CAAC,CAAC,EAAE,CAAC;gBAC5B,WAAW,CAAC,MAAM,CAAC,eAAe,EAAE,CAAC,CAAC,CAAA;gBACtC,gBAAgB,CAAC,IAAI,CAAC,WAAW,CAAC,CAAA;gBAClC,CAAC,CAAC,MAAM,EAAE,CAAA;YACX,CAAC;QACF,CAAC;IACF,CAAC;IACD,gBAAgB,CAAC,mBAAmB,EAAE,CAAC,YAAY,EAAE,EAAE,CAAC,gBAAgB,CAAC,QAAQ,CAAC,YAAY,CAAC,CAAC,CAAA;AACjG,CAAC,CACD,CAAA;AAED,MAAM,UAAU,2BAA2B,CAAC,cAAuB;IAClE,OAAO,cAAc,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,wBAAwB,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,2BAA2B,CAAC,CAAA;AACnG,CAAC","sourcesContent":["import m from \"mithril\"\nimport type { Attachment } from \"../../../common/mailFunctionality/SendMailModel.js\"\nimport { SendMailModel } from \"../../../common/mailFunctionality/SendMailModel.js\"\nimport { debounce, findAllAndRemove, isNotNull, ofClass, remove } from \"@tutao/tutanota-utils\"\nimport { Mode } from \"../../../common/api/common/Env\"\nimport { PermissionError } from \"../../../common/api/common/error/PermissionError\"\nimport { Dialog } from \"../../../common/gui/base/Dialog\"\nimport { FileNotFoundError } from \"../../../common/api/common/error/FileNotFoundError\"\nimport { lang } from \"../../../common/misc/LanguageViewModel\"\nimport { FileOpenError } from \"../../../common/api/common/error/FileOpenError\"\nimport { UserError } from \"../../../common/api/main/UserError\"\nimport { showUserError } from \"../../../common/misc/ErrorHandlerImpl\"\nimport { locator } from \"../../../common/api/main/CommonLocator\"\nimport { FileReference, isDataFile, isFileReference, isTutanotaFile } from \"../../../common/api/common/utils/FileUtils\"\nimport { DataFile } from \"../../../common/api/common/DataFile\"\nimport { showFileChooser } from \"../../../common/file/FileController.js\"\nimport { ProgrammingError } from \"../../../common/api/common/error/ProgrammingError.js\"\nimport { AttachmentBubbleAttrs, AttachmentType } from \"../../../common/gui/AttachmentBubble.js\"\n\nexport async function chooseAndAttachFile(\n\tmodel: SendMailModel,\n\tboundingRect: ClientRect,\n\tfileTypes?: Array<string>,\n): Promise<ReadonlyArray<DataFile | FileReference> | void> {\n\tboundingRect.height = Math.round(boundingRect.height)\n\tboundingRect.width = Math.round(boundingRect.width)\n\tboundingRect.x = Math.round(boundingRect.x)\n\tboundingRect.y = Math.round(boundingRect.y)\n\ttry {\n\t\tconst files = await showFileChooserForAttachments(boundingRect, fileTypes)\n\t\tif (!files || files.length === 0) return\n\t\tswitch (env.mode) {\n\t\t\tcase Mode.App:\n\t\t\t\t// we have file refs and want to keep them\n\t\t\t\tmodel.attachFiles(files)\n\t\t\t\treturn files\n\t\t\tcase Mode.Desktop: {\n\t\t\t\t// this is important for the desktop client so it can attach them as inline images. // we have file refs and want to read them.\n\t\t\t\tconst dataFiles: Array<DataFile> = (\n\t\t\t\t\tawait Promise.all((files as Array<FileReference>).map(async (f) => locator.fileApp.readDataFile(f.location)))\n\t\t\t\t).filter(isNotNull)\n\t\t\t\tmodel.attachFiles(dataFiles)\n\t\t\t\treturn dataFiles\n\t\t\t}\n\t\t\tdefault:\n\t\t\t\t// we have data files and want to keep them\n\t\t\t\tmodel.attachFiles(files)\n\t\t\t\treturn files\n\t\t}\n\t} catch (e) {\n\t\tif (e instanceof UserError) {\n\t\t\tawait showUserError(e)\n\t\t} else {\n\t\t\tconst msg = e.message || \"unknown error\"\n\t\t\tconsole.error(\"could not attach files:\", msg)\n\t\t}\n\t}\n}\n\nexport function showFileChooserForAttachments(boundingRect: ClientRect, fileTypes?: Array<string>): Promise<ReadonlyArray<FileReference | DataFile> | void> {\n\tconst fileSelector = [Mode.App, Mode.Desktop].includes(env.mode)\n\t\t? locator.fileApp.openFileChooser(boundingRect, fileTypes)\n\t\t: showFileChooser(true, fileTypes)\n\treturn fileSelector\n\t\t.catch(\n\t\t\tofClass(PermissionError, () => {\n\t\t\t\tDialog.message(\"fileAccessDeniedMobile_msg\")\n\t\t\t}),\n\t\t)\n\t\t.catch(\n\t\t\tofClass(FileNotFoundError, () => {\n\t\t\t\tDialog.message(\"couldNotAttachFile_msg\")\n\t\t\t}),\n\t\t)\n}\n\nexport function createAttachmentBubbleAttrs(model: SendMailModel, inlineImageElements: Array<HTMLElement>): Array<AttachmentBubbleAttrs> {\n\treturn model.getAttachments().map((attachment) => ({\n\t\tattachment,\n\t\topen: null,\n\t\tdownload: () => _downloadAttachment(attachment),\n\t\tremove: () => {\n\t\t\tmodel.removeAttachment(attachment)\n\n\t\t\t// If an attachment has a cid it means it could be in the editor's inline images too\n\t\t\tif (attachment.cid) {\n\t\t\t\tconst imageElement = inlineImageElements.find((e) => e.getAttribute(\"cid\") === attachment.cid)\n\n\t\t\t\tif (imageElement) {\n\t\t\t\t\timageElement.remove()\n\t\t\t\t\tremove(inlineImageElements, imageElement)\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tm.redraw()\n\t\t},\n\t\tfileImport: null,\n\t\ttype: AttachmentType.GENERIC,\n\t}))\n}\n\nasync function _downloadAttachment(attachment: Attachment) {\n\ttry {\n\t\tif (isFileReference(attachment)) {\n\t\t\tawait locator.fileApp.open(attachment)\n\t\t} else if (isDataFile(attachment)) {\n\t\t\tawait locator.fileController.saveDataFile(attachment)\n\t\t} else if (isTutanotaFile(attachment)) {\n\t\t\tawait locator.fileController.download(attachment)\n\t\t} else {\n\t\t\tthrow new ProgrammingError(\"attachment is neither reference, datafile nor tutanotafile!\")\n\t\t}\n\t} catch (e) {\n\t\tif (e instanceof FileOpenError) {\n\t\t\treturn Dialog.message(\"canNotOpenFileOnDevice_msg\")\n\t\t} else {\n\t\t\tconst msg = e.message || \"unknown error\"\n\t\t\tconsole.error(\"could not open file:\", msg)\n\t\t\treturn Dialog.message(\"errorDuringFileOpen_msg\")\n\t\t}\n\t}\n}\n\nexport const cleanupInlineAttachments: (arg0: HTMLElement, arg1: Array<HTMLElement>, arg2: Array<Attachment>) => void = debounce(\n\t50,\n\t(domElement: HTMLElement, inlineImageElements: Array<HTMLElement>, attachments: Array<Attachment>) => {\n\t\t// Previously we replied on subtree option of MutationObserver to receive info when nested child is removed.\n\t\t// It works but it doesn't work if the parent of the nested child is removed, we would have to go over each mutation\n\t\t// and check each descendant and if it's an image with CID or not.\n\t\t// It's easier and faster to just go over each inline image that we know about. It's more bookkeeping but it's easier\n\t\t// code which touches less dome.\n\t\t//\n\t\t// Alternative would be observe the parent of each inline image but that's more complexity and we need to take care of\n\t\t// new (just inserted) inline images and also assign listener there.\n\t\t// Doing this check instead of relying on mutations also helps with the case when node is removed but inserted again\n\t\t// briefly, e.g. if some text is inserted before/after the element, Squire would put it into another diff and this\n\t\t// means removal + insertion.\n\t\tconst elementsToRemove: HTMLElement[] = []\n\t\tfor (const inlineImage of inlineImageElements) {\n\t\t\tif (domElement && !domElement.contains(inlineImage)) {\n\t\t\t\tconst cid = inlineImage.getAttribute(\"cid\")\n\t\t\t\tconst attachmentIndex = attachments.findIndex((a) => a.cid === cid)\n\n\t\t\t\tif (attachmentIndex !== -1) {\n\t\t\t\t\tattachments.splice(attachmentIndex, 1)\n\t\t\t\t\telementsToRemove.push(inlineImage)\n\t\t\t\t\tm.redraw()\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tfindAllAndRemove(inlineImageElements, (imageElement) => elementsToRemove.includes(imageElement))\n\t},\n)\n\nexport function getConfidentialStateMessage(isConfidential: boolean): string {\n\treturn isConfidential ? lang.get(\"confidentialStatus_msg\") : lang.get(\"nonConfidentialStatus_msg\")\n}\n"]}