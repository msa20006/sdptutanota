{"version":3,"file":"NotificationPermissionsDialog.js","sourceRoot":"","sources":["../../../../src/common/settings/NotificationPermissionsDialog.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Component, Vnode } from \"mithril\"\nimport { lang, TranslationKey } from \"../misc/LanguageViewModel.js\"\nimport { isAndroidApp } from \"../api/common/Env.js\"\nimport { Dialog } from \"../gui/base/Dialog.js\"\nimport { DialogHeaderBarAttrs } from \"../gui/base/DialogHeaderBar.js\"\nimport { ButtonType } from \"../gui/base/Button.js\"\nimport { ClickHandler } from \"../gui/base/GuiUtils.js\"\nimport { PermissionType } from \"../native/common/generatedipc/PermissionType.js\"\nimport { locator } from \"../api/main/CommonLocator.js\"\nimport { renderSettingsBannerButton } from \"./SettingsBannerButton.js\"\n\nfunction renderPermissionButton(permissionName: TranslationKey, isPermissionGranted: boolean, onclick: ClickHandler) {\n\treturn renderSettingsBannerButton(isPermissionGranted ? \"granted_msg\" : permissionName, onclick, isPermissionGranted)\n}\n\n/// Shows a dialog that allows the user to set the notification and battery permissions on mobile.\n/// It shows the same screen as the notifications page in the onboarding wizard\nexport async function renderNotificationPermissionsDialog(onClose: () => void) {\n\tlet isNotificationPermissionGranted = await locator.systemPermissionHandler.hasPermission(PermissionType.Notification)\n\tlet isBatteryPermissionGranted = await locator.systemPermissionHandler.hasPermission(PermissionType.IgnoreBatteryOptimization)\n\n\tconst headerBarAttrs: DialogHeaderBarAttrs = {\n\t\tleft: [\n\t\t\t{\n\t\t\t\tlabel: \"close_alt\",\n\t\t\t\tclick: () => dialog.close(),\n\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t},\n\t\t],\n\t\tmiddle: \"permissions_label\",\n\t\tremove: () => onClose(),\n\t}\n\tconst dialog = Dialog.editSmallDialog(headerBarAttrs, () =>\n\t\tm(NotificationPermissionsBody, {\n\t\t\tisNotificationPermissionGranted,\n\t\t\tisBatteryPermissionGranted,\n\t\t\taskForNotificationPermission: (isGranted) => {\n\t\t\t\tisNotificationPermissionGranted = isGranted\n\t\t\t\tm.redraw()\n\t\t\t},\n\t\t\taskForBatteryNotificationPermission: async (isGranted) => {\n\t\t\t\tisBatteryPermissionGranted = isGranted\n\t\t\t\tm.redraw()\n\t\t\t},\n\t\t}),\n\t)\n\tdialog.show()\n}\n\nexport interface NotificationPermissionsBodyAttrs {\n\tisNotificationPermissionGranted: boolean\n\tisBatteryPermissionGranted: boolean\n\taskForNotificationPermission: (isGranted: boolean) => void\n\taskForBatteryNotificationPermission: (isGranted: boolean) => void\n}\n\n/// Displays buttons to grant the notification and battery permissions with explaining paragraphs\nexport class NotificationPermissionsBody implements Component<NotificationPermissionsBodyAttrs> {\n\tview({ attrs }: Vnode<NotificationPermissionsBodyAttrs>) {\n\t\treturn [\n\t\t\tm(\"p.mb-s\", lang.get(\"allowNotifications_msg\")),\n\t\t\trenderPermissionButton(\"grant_notification_permission_action\", attrs.isNotificationPermissionGranted, async () => {\n\t\t\t\t// Ask for the notification permission\n\t\t\t\tconst isNotificationPermissionGranted = await locator.systemPermissionHandler.requestPermission(\n\t\t\t\t\tPermissionType.Notification,\n\t\t\t\t\t\"grant_notification_permission_action\",\n\t\t\t\t)\n\t\t\t\t// Register the push notifications if granted\n\t\t\t\tif (isNotificationPermissionGranted) {\n\t\t\t\t\tlocator.pushService.register()\n\t\t\t\t}\n\t\t\t\tattrs.askForNotificationPermission(isNotificationPermissionGranted)\n\t\t\t}),\n\t\t\t!isAndroidApp()\n\t\t\t\t? null\n\t\t\t\t: m(\"section.mt-s.mb\", [\n\t\t\t\t\t\tm(\"p.mb-s.mt-s\", lang.get(\"allowBatteryPermission_msg\")),\n\t\t\t\t\t\trenderPermissionButton(\"grant_battery_permission_action\", attrs.isBatteryPermissionGranted, async () => {\n\t\t\t\t\t\t\t// Ask for permission to disable battery optimisations\n\t\t\t\t\t\t\tconst isBatteryPermissionGranted = await locator.systemPermissionHandler.requestPermission(\n\t\t\t\t\t\t\t\tPermissionType.IgnoreBatteryOptimization,\n\t\t\t\t\t\t\t\t\"allowBatteryPermission_msg\",\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tattrs.askForBatteryNotificationPermission(isBatteryPermissionGranted)\n\t\t\t\t\t\t}),\n\t\t\t\t  ]),\n\t\t]\n\t}\n}\n"]}