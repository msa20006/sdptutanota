{"version":3,"file":"MailAddressParser.js","sourceRoot":"","sources":["../../../../../src/common/misc/parsing/MailAddressParser.ts"],"names":[],"mappings":"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","sourcesContent":["import { isMailAddress } from \"../FormatValidator\"\nimport { PartialRecipient } from \"../../api/common/recipients/Recipient\"\nimport { convertTextToHtml } from \"../Formatter.js\"\n\nexport type ParsedMailto = {\n\trecipients: {\n\t\tto?: PartialRecipient[]\n\t\tcc?: PartialRecipient[]\n\t\tbcc?: PartialRecipient[]\n\t}\n\tsubject: string | null\n\tbody: string | null\n\tattach: Array<string> | null\n}\n\n/**\n * takes a URL of the form mailto:a@b.c?body=hello%20world&attach=file:///home/user/cute%20cat.jpg&attach=file:///home/user/ugly%20dog.jpg\n * and returns an object representing the structured information that should be passed to the mail editor for this URL\n *\n * if a param is not given, it is set to null. if it is given, but empty, it will be set to an empty string/array.\n *\n * @param mailtoUrl {string}\n * @returns {ParsedMailto}\n */\nexport function parseMailtoUrl(mailtoUrl: string): ParsedMailto {\n\tlet url = new URL(mailtoUrl)\n\n\tconst createMailAddressFromString = (address: string): PartialRecipient | null => {\n\t\tconst nameAndMailAddress = stringToNameAndMailAddress(address)\n\t\tif (!nameAndMailAddress) return null\n\t\treturn {\n\t\t\tname: nameAndMailAddress.name,\n\t\t\taddress: nameAndMailAddress.mailAddress,\n\t\t}\n\t}\n\n\tconst addresses = url.pathname\n\t\t.split(\",\")\n\t\t.map((address) => {\n\t\t\tif (!address) return null\n\t\t\tconst decodedAddress = decodeURIComponent(address)\n\t\t\tif (!decodedAddress) return null\n\t\t\treturn createMailAddressFromString(decodedAddress)\n\t\t})\n\t\t.filter(Boolean)\n\tconst result: any = {\n\t\trecipients: {\n\t\t\tto: addresses.length > 0 ? addresses : undefined,\n\t\t\tcc: undefined,\n\t\t\tbcc: undefined,\n\t\t},\n\t\tattach: null,\n\t\tsubject: null,\n\t\tbody: null,\n\t}\n\t// @ts-ignore Missing definition\n\tif (!url.searchParams || typeof url.searchParams.entries !== \"function\") return result\n\n\t// @ts-ignore\n\tfor (let pair of url.searchParams.entries()) {\n\t\tlet paramName = pair[0].toLowerCase()\n\t\tlet paramValue = pair[1]\n\n\t\tswitch (paramName) {\n\t\t\tcase \"subject\":\n\t\t\t\tresult.subject = paramValue\n\t\t\t\tbreak\n\n\t\t\tcase \"body\":\n\t\t\t\tresult.body = convertTextToHtml(paramValue)\n\t\t\t\tbreak\n\n\t\t\tcase \"to\":\n\t\t\tcase \"cc\":\n\t\t\tcase \"bcc\": {\n\t\t\t\tif (result.recipients[paramName] == null) result.recipients[paramName] = []\n\t\t\t\tconst nextAddresses = paramValue\n\t\t\t\t\t.split(\",\")\n\t\t\t\t\t.map((address: string) => createMailAddressFromString(address))\n\t\t\t\t\t.filter(Boolean)\n\t\t\t\tresult.recipients[paramName].push(...nextAddresses)\n\t\t\t\tbreak\n\t\t\t}\n\n\t\t\tcase \"attach\":\n\t\t\t\tif (result.attach == null) result.attach = []\n\t\t\t\tresult.attach.push(paramValue)\n\t\t\t\tbreak\n\n\t\t\tdefault:\n\t\t\t\tconsole.warn(\"unexpected mailto param, ignoring\")\n\t\t}\n\t}\n\n\treturn result\n}\n\n/**\n * Parses the given string for a name and mail address. The following formats are recognized: [name][<]mailAddress[>]\n * Additionally, whitespaces at any positions outside name and mailAddress are ignored.\n * @param string The string to check.\n * @return an object with the attributes \"name\" and \"mailAddress\" or null if nothing was found.\n */\nexport function stringToNameAndMailAddress(string: string):\n\t| {\n\t\t\tname: string\n\t\t\tmailAddress: string\n\t  }\n\t| null\n\t| undefined {\n\tstring = string.trim()\n\n\tif (string === \"\") {\n\t\treturn null\n\t}\n\n\tlet startIndex = string.indexOf(\"<\")\n\n\tif (startIndex !== -1) {\n\t\tconst endIndex = string.indexOf(\">\", startIndex)\n\n\t\tif (endIndex === -1) {\n\t\t\treturn null\n\t\t}\n\n\t\tconst cleanedMailAddress = getCleanedMailAddress(string.substring(startIndex + 1, endIndex))\n\n\t\tif (cleanedMailAddress == null || !isMailAddress(cleanedMailAddress, false)) {\n\t\t\treturn null\n\t\t}\n\n\t\tconst name = string.substring(0, startIndex).trim()\n\t\treturn {\n\t\t\tname: name,\n\t\t\tmailAddress: cleanedMailAddress,\n\t\t}\n\t} else {\n\t\tstartIndex = string.lastIndexOf(\" \")\n\t\tstartIndex++\n\t\tconst cleanedMailAddress = getCleanedMailAddress(string.substring(startIndex))\n\n\t\tif (cleanedMailAddress == null || !isMailAddress(cleanedMailAddress, false)) {\n\t\t\treturn null\n\t\t}\n\n\t\tconst name = string.substring(0, startIndex).trim()\n\t\treturn {\n\t\t\tname: name,\n\t\t\tmailAddress: cleanedMailAddress,\n\t\t}\n\t}\n}\n\n/**\n * Returns a cleaned mail address from the input mail address. Removes leading or trailing whitespaces and converters\n * the address to lower case.\n * @param mailAddress The input mail address.\n * @return The cleaned mail address.\n */\nexport function getCleanedMailAddress(mailAddress: string): string | null {\n\tconst cleanedMailAddress = mailAddress.toLowerCase().trim()\n\n\tif (isMailAddress(cleanedMailAddress, false)) {\n\t\treturn cleanedMailAddress\n\t}\n\n\treturn null\n}\n\nexport function getDomainPart(mailAddress: string): string | null {\n\tconst cleanedMailAddress = getCleanedMailAddress(mailAddress)\n\n\tif (cleanedMailAddress) {\n\t\tconst parts = mailAddress.split(\"@\")\n\n\t\tif (parts.length === 2) {\n\t\t\treturn parts[1]\n\t\t} else {\n\t\t\treturn null\n\t\t}\n\t} else {\n\t\treturn null\n\t}\n}\n\n/**\n * Parses the given string for a fist name and a last name separated by whitespace. If there is only one part it is regarded as first name. If there are more than two parts, only the first one is regarded as first name.\n * @param fullName The full name to check.\n * @return Returns an object with the attributes \"firstName\" and \"lastName\".\n */\nexport function fullNameToFirstAndLastName(fullName: string): {\n\tfirstName: string\n\tlastName: string\n} {\n\tfullName = fullName.trim()\n\n\tif (fullName === \"\") {\n\t\treturn {\n\t\t\tfirstName: \"\",\n\t\t\tlastName: \"\",\n\t\t}\n\t}\n\n\tconst separator = fullName.indexOf(\" \")\n\n\tif (separator !== -1) {\n\t\treturn {\n\t\t\tfirstName: fullName.substring(0, separator),\n\t\t\tlastName: fullName.substring(separator + 1),\n\t\t}\n\t} else {\n\t\treturn {\n\t\t\tfirstName: fullName,\n\t\t\tlastName: \"\",\n\t\t}\n\t}\n}\n\n/**\n * Parses the given email address for a fist name and a last name separated by whitespace, comma, dot or underscore.\n * @param mailAddress The email address to check.\n * @return Returns an object with the attributes \"firstName\" and \"lastName\".\n */\nexport function mailAddressToFirstAndLastName(mailAddress: string): {\n\tfirstName: string\n\tlastName: string\n} {\n\tconst addr = mailAddress.substring(0, mailAddress.indexOf(\"@\"))\n\tlet nameData\n\n\tif (addr.indexOf(\".\") !== -1) {\n\t\tnameData = addr.split(\".\")\n\t} else if (addr.indexOf(\"_\") !== -1) {\n\t\tnameData = addr.split(\"_\")\n\t} else if (addr.indexOf(\"-\") !== -1) {\n\t\tnameData = addr.split(\"-\")\n\t} else {\n\t\tnameData = [addr]\n\t}\n\n\t// first character upper case\n\tfor (let i = 0; i < nameData.length; i++) {\n\t\tif (nameData[i].length > 0) {\n\t\t\tnameData[i] = nameData[i].substring(0, 1).toUpperCase() + nameData[i].substring(1)\n\t\t}\n\t}\n\n\treturn {\n\t\tfirstName: nameData[0],\n\t\tlastName: nameData.slice(1).join(\" \"),\n\t}\n}\n"]}