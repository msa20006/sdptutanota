{"version":3,"file":"SecondFactorEditDialog.js","sourceRoot":"","sources":["../../../../../../src/common/settings/login/secondfactor/SecondFactorEditDialog.ts"],"names":[],"mappings":"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","sourcesContent":["import { showProgressDialog } from \"../../../gui/dialogs/ProgressDialog.js\"\nimport { SecondFactorType } from \"../../../api/common/TutanotaConstants.js\"\nimport type { DropDownSelectorAttrs } from \"../../../gui/base/DropDownSelector.js\"\nimport { DropDownSelector } from \"../../../gui/base/DropDownSelector.js\"\nimport { lang } from \"../../../misc/LanguageViewModel.js\"\nimport type { TextFieldAttrs } from \"../../../gui/base/TextField.js\"\nimport { Autocomplete, TextField } from \"../../../gui/base/TextField.js\"\nimport { isApp } from \"../../../api/common/Env.js\"\nimport m, { Children } from \"mithril\"\nimport { copyToClipboard } from \"../../../misc/ClipboardUtils.js\"\nimport { Icons } from \"../../../gui/base/icons/Icons.js\"\nimport { Dialog } from \"../../../gui/base/Dialog.js\"\nimport { Icon, IconSize, progressIcon } from \"../../../gui/base/Icon.js\"\nimport { theme } from \"../../../gui/theme.js\"\nimport type { User } from \"../../../api/entities/sys/TypeRefs.js\"\nimport { assertNotNull, LazyLoaded } from \"@tutao/tutanota-utils\"\nimport { locator } from \"../../../api/main/CommonLocator.js\"\nimport * as RecoverCodeDialog from \"../RecoverCodeDialog.js\"\nimport { EntityClient } from \"../../../api/common/EntityClient.js\"\nimport { ProgrammingError } from \"../../../api/common/error/ProgrammingError.js\"\nimport { IconButton, IconButtonAttrs } from \"../../../gui/base/IconButton.js\"\nimport { ButtonSize } from \"../../../gui/base/ButtonSize.js\"\nimport { NameValidationStatus, SecondFactorEditModel, SecondFactorTypeToNameTextId, VerificationStatus } from \"./SecondFactorEditModel.js\"\nimport { UserError } from \"../../../api/main/UserError.js\"\nimport { LoginButton } from \"../../../gui/base/buttons/LoginButton.js\"\nimport { NotAuthorizedError } from \"../../../api/common/error/RestError\"\n\nexport class SecondFactorEditDialog {\n\tprivate readonly dialog: Dialog\n\n\tconstructor(private readonly model: SecondFactorEditModel) {\n\t\tthis.dialog = Dialog.createActionDialog({\n\t\t\ttitle: \"add_action\",\n\t\t\tallowOkWithReturn: true,\n\t\t\tchild: {\n\t\t\t\tview: () => this.render(),\n\t\t\t},\n\t\t\tokAction: () => showProgressDialog(\"pleaseWait_msg\", this.okAction()),\n\t\t\tallowCancel: true,\n\t\t\tokActionTextId: \"save_action\",\n\t\t\tcancelAction: () => this.model.abort(),\n\t\t\tvalidator: () => this.model.validationMessage(),\n\t\t})\n\t}\n\n\tasync okAction(): Promise<void> {\n\t\ttry {\n\t\t\tconst user = await this.model.save()\n\t\t\tif (user != null) this.finalize(user)\n\t\t} catch (e) {\n\t\t\tif (e instanceof UserError) {\n\t\t\t\t// noinspection ES6MissingAwait\n\t\t\t\tDialog.message(lang.makeTranslation(\"error_msg\", e.message))\n\t\t\t} else if (e instanceof NotAuthorizedError) {\n\t\t\t\tthis.dialog.close()\n\t\t\t\tDialog.message(\"contactFormSubmitError_msg\")\n\t\t\t\treturn\n\t\t\t} else {\n\t\t\t\tthrow e\n\t\t\t}\n\t\t}\n\t}\n\n\tfinalize(user: User): void {\n\t\tthis.dialog.close()\n\t\tRecoverCodeDialog.showRecoverCodeDialogAfterPasswordVerificationAndInfoDialog(user)\n\t}\n\n\tstatic async loadAndShow(entityClient: EntityClient, lazyUser: LazyLoaded<User>, token?: string): Promise<void> {\n\t\tconst dialog: SecondFactorEditDialog = await showProgressDialog(\"pleaseWait_msg\", this.loadWebauthnClient(entityClient, lazyUser, token))\n\t\tdialog.dialog.show()\n\t}\n\n\tprivate render(): Children {\n\t\tconst optionsItems = this.model.getFactorTypesOptions().map((o) => ({\n\t\t\tname: lang.get(SecondFactorTypeToNameTextId[o]),\n\t\t\tvalue: o,\n\t\t}))\n\n\t\tconst typeDropdownAttrs: DropDownSelectorAttrs<SecondFactorType> = {\n\t\t\tlabel: \"type_label\",\n\t\t\tselectedValue: this.model.selectedType,\n\t\t\tselectionChangedHandler: (newValue) => this.model.onTypeSelected(newValue),\n\t\t\titems: optionsItems,\n\t\t\tdropdownWidth: 300,\n\t\t}\n\t\tconst nameFieldAttrs: TextFieldAttrs = {\n\t\t\tlabel: \"name_label\",\n\t\t\thelpLabel: () => this.renderHelpLabel(),\n\t\t\tvalue: this.model.name,\n\t\t\toninput: (value) => this.model.onNameChange(value),\n\t\t}\n\t\treturn [m(DropDownSelector, typeDropdownAttrs), m(TextField, nameFieldAttrs), this.renderTypeSpecificFields()]\n\t}\n\n\tprivate renderHelpLabel(): Children {\n\t\treturn this.model.nameValidationStatus === NameValidationStatus.Valid\n\t\t\t? m(\"\", lang.get(\"secondFactorNameInfo_msg\"))\n\t\t\t: m(\".b.content-accent-fg\", lang.get(\"textTooLong_msg\"))\n\t}\n\n\tprivate renderTypeSpecificFields(): Children {\n\t\tswitch (this.model.selectedType) {\n\t\t\tcase SecondFactorType.totp:\n\t\t\t\treturn this.renderOtpFields()\n\n\t\t\tcase SecondFactorType.webauthn:\n\t\t\t\treturn this.renderU2FFields()\n\n\t\t\tdefault:\n\t\t\t\tthrow new ProgrammingError(`Invalid 2fa type: ${this.model.selectedType}`)\n\t\t}\n\t}\n\n\tprivate renderU2FFields(): Children {\n\t\treturn this.model.verificationStatus === VerificationStatus.Initial\n\t\t\t? null\n\t\t\t: m(\"p.flex.items-center\", [m(\".mr-s\", this.statusIcon()), m(\"\", this.statusMessage())])\n\t}\n\n\tprivate renderOtpFields(): Children {\n\t\tconst copyButtonAttrs: IconButtonAttrs = {\n\t\t\ttitle: \"copy_action\",\n\t\t\tclick: () => copyToClipboard(this.model.totpKeys.readableKey),\n\t\t\ticon: Icons.Clipboard,\n\t\t\tsize: ButtonSize.Compact,\n\t\t}\n\t\treturn m(\".mb\", [\n\t\t\tm(TextField, {\n\t\t\t\tlabel: \"totpSecret_label\",\n\t\t\t\thelpLabel: () => lang.get(isApp() ? \"totpTransferSecretApp_msg\" : \"totpTransferSecret_msg\"),\n\t\t\t\tvalue: this.model.totpKeys.readableKey,\n\t\t\t\tinjectionsRight: () => m(IconButton, copyButtonAttrs),\n\t\t\t\tisReadOnly: true,\n\t\t\t}),\n\t\t\tisApp()\n\t\t\t\t? m(\n\t\t\t\t\t\t\".pt\",\n\t\t\t\t\t\tm(LoginButton, {\n\t\t\t\t\t\t\tlabel: \"addOpenOTPApp_action\",\n\t\t\t\t\t\t\tonclick: () => this.openOtpLink(),\n\t\t\t\t\t\t}),\n\t\t\t\t  )\n\t\t\t\t: this.renderOtpQrCode(),\n\t\t\tm(TextField, {\n\t\t\t\tlabel: \"totpCode_label\",\n\t\t\t\tvalue: this.model.totpCode,\n\t\t\t\thelpLabel: () => this.statusMessage(),\n\t\t\t\tautocompleteAs: Autocomplete.oneTimeCode,\n\t\t\t\toninput: (newValue) => this.model.onTotpValueChange(newValue),\n\t\t\t}),\n\t\t])\n\t}\n\n\tprivate renderOtpQrCode(): Children {\n\t\tconst otpInfo = this.model.otpInfo.getSync()\n\n\t\tif (otpInfo) {\n\t\t\tconst qrCodeSvg = assertNotNull(otpInfo.qrCodeSvg)\n\t\t\t// sanitized in the model\n\t\t\treturn m(\".flex-center.pt\", m.trust(qrCodeSvg))\n\t\t} else {\n\t\t\treturn null\n\t\t}\n\t}\n\n\tprivate async openOtpLink() {\n\t\tconst { url } = await this.model.otpInfo.getAsync()\n\t\tconst successful = await locator.systemFacade.openLink(url)\n\n\t\tif (!successful) {\n\t\t\t// noinspection ES6MissingAwait\n\t\t\tDialog.message(\"noAppAvailable_msg\")\n\t\t}\n\t}\n\n\tprivate static async loadWebauthnClient(entityClient: EntityClient, lazyUser: LazyLoaded<User>, token?: string): Promise<SecondFactorEditDialog> {\n\t\tconst totpKeys = await locator.loginFacade.generateTotpSecret()\n\t\tconst user = await lazyUser.getAsync()\n\t\tconst webauthnSupported = await locator.webAuthn.isSupported()\n\t\tconst model = new SecondFactorEditModel(\n\t\t\tentityClient,\n\t\t\tuser,\n\t\t\tlocator.webAuthn,\n\t\t\ttotpKeys,\n\t\t\twebauthnSupported,\n\t\t\tlocator.loginFacade,\n\t\t\tlocation.hostname,\n\t\t\tlocator.domainConfigProvider().getCurrentDomainConfig(),\n\t\t\tm.redraw,\n\t\t\ttoken,\n\t\t)\n\t\treturn new SecondFactorEditDialog(model)\n\t}\n\n\tprivate statusIcon(): Children {\n\t\tswitch (this.model.verificationStatus) {\n\t\t\tcase VerificationStatus.Progress:\n\t\t\t\treturn progressIcon()\n\n\t\t\tcase VerificationStatus.Success:\n\t\t\t\treturn m(Icon, {\n\t\t\t\t\ticon: Icons.Checkmark,\n\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tfill: theme.content_accent,\n\t\t\t\t\t},\n\t\t\t\t})\n\n\t\t\tcase VerificationStatus.Failed:\n\t\t\t\treturn m(Icon, {\n\t\t\t\t\ticon: Icons.Cancel,\n\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tfill: theme.content_accent,\n\t\t\t\t\t},\n\t\t\t\t})\n\n\t\t\tdefault:\n\t\t\t\treturn null\n\t\t}\n\t}\n\n\tprivate statusMessage(): string {\n\t\tif (this.model.selectedType === SecondFactorType.webauthn) {\n\t\t\treturn this.model.verificationStatus === VerificationStatus.Success ? lang.get(\"registeredU2fDevice_msg\") : lang.get(\"unrecognizedU2fDevice_msg\")\n\t\t} else {\n\t\t\tif (this.model.verificationStatus === VerificationStatus.Success) {\n\t\t\t\treturn lang.get(\"totpCodeConfirmed_msg\")\n\t\t\t} else if (this.model.verificationStatus === VerificationStatus.Failed) {\n\t\t\t\treturn lang.get(\"totpCodeWrong_msg\")\n\t\t\t} else {\n\t\t\t\treturn lang.get(\"totpCodeEnter_msg\")\n\t\t\t}\n\t\t}\n\t}\n}\n"]}