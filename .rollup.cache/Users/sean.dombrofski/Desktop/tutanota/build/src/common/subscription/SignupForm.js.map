{"version":3,"file":"SignupForm.js","sourceRoot":"","sources":["../../../../src/common/subscription/SignupForm.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Children, Component, Vnode } from \"mithril\"\nimport stream from \"mithril/stream\"\nimport Stream from \"mithril/stream\"\nimport { Dialog } from \"../gui/base/Dialog\"\nimport { Autocomplete, TextField } from \"../gui/base/TextField.js\"\nimport { getWhitelabelRegistrationDomains } from \"../login/LoginView.js\"\nimport type { NewAccountData } from \"./UpgradeSubscriptionWizard\"\nimport { SelectMailAddressForm, SelectMailAddressFormAttrs } from \"../../common/settings/SelectMailAddressForm.js\"\nimport {\n\tAccountType,\n\tDEFAULT_FREE_MAIL_ADDRESS_SIGNUP_DOMAIN,\n\tDEFAULT_PAID_MAIL_ADDRESS_SIGNUP_DOMAIN,\n\tTUTA_MAIL_ADDRESS_SIGNUP_DOMAINS,\n} from \"../api/common/TutanotaConstants\"\n\nimport type { CheckboxAttrs } from \"../gui/base/Checkbox.js\"\nimport { Checkbox } from \"../gui/base/Checkbox.js\"\nimport type { lazy } from \"@tutao/tutanota-utils\"\nimport { getFirstOrThrow, ofClass } from \"@tutao/tutanota-utils\"\nimport type { TranslationKey } from \"../misc/LanguageViewModel\"\nimport { InfoLink, lang } from \"../misc/LanguageViewModel\"\nimport { showProgressDialog } from \"../gui/dialogs/ProgressDialog\"\nimport { InvalidDataError } from \"../api/common/error/RestError\"\nimport { locator } from \"../api/main/CommonLocator\"\nimport { CURRENT_PRIVACY_VERSION, CURRENT_TERMS_VERSION, renderTermsAndConditionsButton, TermsSection } from \"./TermsAndConditions\"\nimport { UsageTest } from \"@tutao/tutanota-usagetests\"\nimport { runCaptchaFlow } from \"./Captcha.js\"\nimport { EmailDomainData, isPaidPlanDomain } from \"../settings/mailaddress/MailAddressesUtils.js\"\nimport { LoginButton } from \"../gui/base/buttons/LoginButton.js\"\nimport { ExternalLink } from \"../gui/base/ExternalLink.js\"\nimport { PasswordForm, PasswordModel } from \"../settings/PasswordForm.js\"\nimport { client } from \"../misc/ClientDetector\"\nimport { SubscriptionApp } from \"./SubscriptionViewer\"\n\nexport type SignupFormAttrs = {\n\t/** Handle a new account signup. if readonly then the argument will always be null */\n\tonComplete: (arg0: NewAccountData | null) => void\n\tonChangePlan: () => void\n\tisBusinessUse: lazy<boolean>\n\tisPaidSubscription: lazy<boolean>\n\tcampaign: lazy<string | null>\n\t// only used if readonly is true\n\tprefilledMailAddress?: string | undefined\n\treadonly: boolean\n}\n\nexport class SignupForm implements Component<SignupFormAttrs> {\n\tprivate readonly passwordModel: PasswordModel\n\tprivate readonly _confirmTerms: Stream<boolean>\n\tprivate readonly _confirmAge: Stream<boolean>\n\tprivate readonly _code: Stream<string>\n\tprivate selectedDomain: EmailDomainData\n\tprivate _mailAddressFormErrorId: TranslationKey | null = null\n\tprivate _mailAddress!: string\n\tprivate _isMailVerificationBusy: boolean\n\tprivate readonly __mailValid: Stream<boolean>\n\tprivate readonly __lastMailValidationError: Stream<TranslationKey | null>\n\tprivate __signupFreeTest?: UsageTest\n\tprivate __signupPaidTest?: UsageTest\n\n\tprivate readonly availableDomains: readonly EmailDomainData[] = (locator.domainConfigProvider().getCurrentDomainConfig().firstPartyDomain\n\t\t? TUTA_MAIL_ADDRESS_SIGNUP_DOMAINS\n\t\t: getWhitelabelRegistrationDomains()\n\t).map((domain) => ({ domain, isPaid: isPaidPlanDomain(domain) }))\n\n\tconstructor(vnode: Vnode<SignupFormAttrs>) {\n\t\tthis.selectedDomain = getFirstOrThrow(this.availableDomains)\n\t\t// tuta.com gets preference user is signing up for a paid account and it is available\n\t\tif (vnode.attrs.isPaidSubscription()) {\n\t\t\tthis.selectedDomain = this.availableDomains.find((domain) => domain.domain === DEFAULT_PAID_MAIL_ADDRESS_SIGNUP_DOMAIN) ?? this.selectedDomain\n\t\t} else {\n\t\t\tthis.selectedDomain = this.availableDomains.find((domain) => domain.domain === DEFAULT_FREE_MAIL_ADDRESS_SIGNUP_DOMAIN) ?? this.selectedDomain\n\t\t}\n\n\t\tthis.__mailValid = stream(false)\n\t\tthis.__lastMailValidationError = stream(null)\n\t\tthis.passwordModel = new PasswordModel(\n\t\t\tlocator.usageTestController,\n\t\t\tlocator.logins,\n\t\t\t{\n\t\t\t\tcheckOldPassword: false,\n\t\t\t\tenforceStrength: true,\n\t\t\t\treservedStrings: () => (this._mailAddress ? [this._mailAddress.split(\"@\")[0]] : []),\n\t\t\t},\n\t\t\tthis.__mailValid,\n\t\t)\n\n\t\tthis.__signupFreeTest = locator.usageTestController.getTest(\"signup.free\")\n\t\tthis.__signupPaidTest = locator.usageTestController.getTest(\"signup.paid\")\n\n\t\tthis._confirmTerms = stream<boolean>(false)\n\t\tthis._confirmAge = stream<boolean>(false)\n\t\tthis._code = stream(\"\")\n\t\tthis._isMailVerificationBusy = false\n\t\tthis._mailAddressFormErrorId = \"mailAddressNeutral_msg\"\n\t}\n\n\tview(vnode: Vnode<SignupFormAttrs>): Children {\n\t\tconst a = vnode.attrs\n\n\t\tconst mailAddressFormAttrs: SelectMailAddressFormAttrs = {\n\t\t\tselectedDomain: this.selectedDomain,\n\t\t\tonDomainChanged: (domain) => {\n\t\t\t\tif (!domain.isPaid || a.isPaidSubscription()) {\n\t\t\t\t\tthis.selectedDomain = domain\n\t\t\t\t} else {\n\t\t\t\t\tDialog.confirm(lang.makeTranslation(\"confirm_msg\", `${lang.get(\"paidEmailDomainSignup_msg\")}\\n${lang.get(\"changePaidPlan_msg\")}`)).then(\n\t\t\t\t\t\t(confirmed) => {\n\t\t\t\t\t\t\tif (confirmed) {\n\t\t\t\t\t\t\t\tvnode.attrs.onChangePlan()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t},\n\t\t\tavailableDomains: this.availableDomains,\n\t\t\tonValidationResult: (email, validationResult) => {\n\t\t\t\tthis.__mailValid(validationResult.isValid)\n\n\t\t\t\tif (validationResult.isValid) {\n\t\t\t\t\tthis._mailAddress = email\n\t\t\t\t\tthis.passwordModel.recalculatePasswordStrength()\n\t\t\t\t\tthis._mailAddressFormErrorId = null\n\t\t\t\t} else {\n\t\t\t\t\tthis._mailAddressFormErrorId = validationResult.errorId\n\t\t\t\t}\n\t\t\t},\n\t\t\tonBusyStateChanged: (isBusy) => {\n\t\t\t\tthis._isMailVerificationBusy = isBusy\n\t\t\t},\n\t\t}\n\t\tconst confirmTermsCheckBoxAttrs: CheckboxAttrs = {\n\t\t\tlabel: renderTermsLabel,\n\t\t\tchecked: this._confirmTerms(),\n\t\t\tonChecked: this._confirmTerms,\n\t\t}\n\t\tconst confirmAgeCheckBoxAttrs: CheckboxAttrs = {\n\t\t\tlabel: () => lang.get(\"ageConfirmation_msg\"),\n\t\t\tchecked: this._confirmAge(),\n\t\t\tonChecked: this._confirmAge,\n\t\t}\n\n\t\tconst submit = () => {\n\t\t\tif (this._isMailVerificationBusy) return\n\n\t\t\tif (a.readonly) {\n\t\t\t\t// Email field is read-only, account has already been created but user switched from different subscription.\n\t\t\t\tthis.__completePreviousStages()\n\n\t\t\t\treturn a.onComplete(null)\n\t\t\t}\n\n\t\t\tconst errorMessage =\n\t\t\t\tthis._mailAddressFormErrorId || this.passwordModel.getErrorMessageId() || (!this._confirmTerms() ? \"termsAcceptedNeutral_msg\" : null)\n\n\t\t\tif (errorMessage) {\n\t\t\t\tDialog.message(errorMessage)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst ageConfirmPromise = this._confirmAge() ? Promise.resolve(true) : Dialog.confirm(\"parentConfirmation_msg\", \"paymentDataValidation_action\")\n\t\t\tageConfirmPromise.then((confirmed) => {\n\t\t\t\tif (confirmed) {\n\t\t\t\t\tthis.__completePreviousStages()\n\n\t\t\t\t\treturn signup(\n\t\t\t\t\t\tthis._mailAddress,\n\t\t\t\t\t\tthis.passwordModel.getNewPassword(),\n\t\t\t\t\t\tthis._code(),\n\t\t\t\t\t\ta.isBusinessUse(),\n\t\t\t\t\t\ta.isPaidSubscription(),\n\t\t\t\t\t\ta.campaign(),\n\t\t\t\t\t).then((newAccountData) => {\n\t\t\t\t\t\ta.onComplete(newAccountData ? newAccountData : null)\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t}\n\n\t\treturn m(\n\t\t\t\"#signup-account-dialog.flex-center\",\n\t\t\tm(\".flex-grow-shrink-auto.max-width-m.pt.pb.plr-l\", [\n\t\t\t\ta.readonly\n\t\t\t\t\t? m(TextField, {\n\t\t\t\t\t\t\tlabel: \"mailAddress_label\",\n\t\t\t\t\t\t\tvalue: a.prefilledMailAddress ?? \"\",\n\t\t\t\t\t\t\tautocompleteAs: Autocomplete.newPassword,\n\t\t\t\t\t\t\tisReadOnly: true,\n\t\t\t\t\t  })\n\t\t\t\t\t: [\n\t\t\t\t\t\t\tm(SelectMailAddressForm, mailAddressFormAttrs), // Leave as is\n\t\t\t\t\t\t\ta.isPaidSubscription()\n\t\t\t\t\t\t\t\t? m(\".small.mt-s\", lang.get(\"configureCustomDomainAfterSignup_msg\"), [\n\t\t\t\t\t\t\t\t\t\tm(ExternalLink, { href: InfoLink.DomainInfo, isCompanySite: true }),\n\t\t\t\t\t\t\t\t  ])\n\t\t\t\t\t\t\t\t: null,\n\t\t\t\t\t\t\tm(PasswordForm, {\n\t\t\t\t\t\t\t\tmodel: this.passwordModel,\n\t\t\t\t\t\t\t\tpasswordInfoKey: \"passwordImportance_msg\",\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\tgetWhitelabelRegistrationDomains().length > 0\n\t\t\t\t\t\t\t\t? m(TextField, {\n\t\t\t\t\t\t\t\t\t\tvalue: this._code(),\n\t\t\t\t\t\t\t\t\t\toninput: this._code,\n\t\t\t\t\t\t\t\t\t\tlabel: \"whitelabelRegistrationCode_label\",\n\t\t\t\t\t\t\t\t  })\n\t\t\t\t\t\t\t\t: null,\n\t\t\t\t\t\t\tm(Checkbox, confirmTermsCheckBoxAttrs),\n\t\t\t\t\t\t\tm(\"div\", renderTermsAndConditionsButton(TermsSection.Terms, CURRENT_TERMS_VERSION)),\n\t\t\t\t\t\t\tm(\"div\", renderTermsAndConditionsButton(TermsSection.Privacy, CURRENT_PRIVACY_VERSION)),\n\t\t\t\t\t\t\tm(Checkbox, confirmAgeCheckBoxAttrs),\n\t\t\t\t\t  ],\n\t\t\t\tm(\n\t\t\t\t\t\".mt-l.mb-l\",\n\t\t\t\t\tm(LoginButton, {\n\t\t\t\t\t\tlabel: \"next_action\",\n\t\t\t\t\t\tonclick: submit,\n\t\t\t\t\t}),\n\t\t\t\t),\n\t\t\t]),\n\t\t)\n\t}\n\n\tprivate async __completePreviousStages() {\n\t\t// Only the started test's (either free or paid clicked) stages are completed here\n\t\tif (this.__signupFreeTest) {\n\t\t\t// Make sure that the previous two pings (valid email + valid passwords) have been sent in the correct order\n\t\t\tawait this.__signupFreeTest.getStage(2).complete()\n\t\t\tawait this.__signupFreeTest.getStage(3).complete()\n\n\t\t\t// Credentials confirmation (click on next)\n\t\t\tawait this.__signupFreeTest.getStage(4).complete()\n\t\t}\n\n\t\tif (this.__signupPaidTest) {\n\t\t\t// Make sure that the previous two pings (valid email + valid passwords) have been sent in the correct order\n\t\t\tawait this.__signupPaidTest.getStage(1).complete()\n\t\t\tawait this.__signupPaidTest.getStage(2).complete()\n\n\t\t\t// Credentials confirmation (click on next)\n\t\t\tawait this.__signupPaidTest.getStage(3).complete()\n\t\t}\n\t}\n}\n\nfunction renderTermsLabel(): Children {\n\treturn lang.get(\"termsAndConditions_label\")\n}\n\n/**\n * @return Signs the user up, if no captcha is needed or it has been solved correctly\n */\nfunction signup(\n\tmailAddress: string,\n\tpw: string,\n\tregistrationCode: string,\n\tisBusinessUse: boolean,\n\tisPaidSubscription: boolean,\n\tcampaign: string | null,\n): Promise<NewAccountData | void> {\n\tconst { customerFacade } = locator\n\tconst operation = locator.operationProgressTracker.startNewOperation()\n\treturn showProgressDialog(\n\t\t\"createAccountRunning_msg\",\n\t\tcustomerFacade.generateSignupKeys(operation.id).then((keyPairs) => {\n\t\t\treturn runCaptchaFlow(mailAddress, isBusinessUse, isPaidSubscription, campaign).then(async (regDataId) => {\n\t\t\t\tif (regDataId) {\n\t\t\t\t\tconst app = client.isCalendarApp() ? SubscriptionApp.Calendar : SubscriptionApp.Mail\n\t\t\t\t\treturn customerFacade\n\t\t\t\t\t\t.signup(keyPairs, AccountType.FREE, regDataId, mailAddress, pw, registrationCode, lang.code, app)\n\t\t\t\t\t\t.then((recoverCode) => {\n\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\tmailAddress,\n\t\t\t\t\t\t\t\tpassword: pw,\n\t\t\t\t\t\t\t\trecoverCode,\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t}),\n\t\toperation.progress,\n\t)\n\t\t.catch(\n\t\t\tofClass(InvalidDataError, () => {\n\t\t\t\tDialog.message(\"invalidRegistrationCode_msg\")\n\t\t\t}),\n\t\t)\n\t\t.finally(() => operation.done())\n}\n"]}