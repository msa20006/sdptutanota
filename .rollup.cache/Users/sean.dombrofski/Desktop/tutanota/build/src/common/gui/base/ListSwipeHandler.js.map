{"version":3,"file":"ListSwipeHandler.js","sourceRoot":"","sources":["../../../../../src/common/gui/base/ListSwipeHandler.ts"],"names":[],"mappings":"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","sourcesContent":["import { Coordinate2D, SwipeHandler } from \"./SwipeHandler.js\"\nimport { assertNotNull } from \"@tutao/tutanota-utils\"\nimport { animations, DefaultAnimationTime, opacity, transform, TransformEnum } from \"../animation/Animations.js\"\nimport { ease } from \"../animation/Easing.js\"\nimport { ListRow, ListSwipeDecision, ViewHolder } from \"./List.js\"\nimport { ACTION_DISTANCE } from \"./ListUtils.js\"\n\n/** Detects swipe gestures for list elements. On mobile some lists have actions on swiping, e.g. deleting an email. */\nexport class ListSwipeHandler<ElementType, VH extends ViewHolder<ElementType>> extends SwipeHandler {\n\tprivate virtualElement: ListRow<ElementType, VH> | null = null\n\tprivate xoffset!: number\n\n\tconstructor(\n\t\ttouchArea: HTMLElement,\n\t\tprivate readonly config: {\n\t\t\tdomSwipeSpacerLeft: () => HTMLElement\n\t\t\tdomSwipeSpacerRight: () => HTMLElement\n\t\t\twidth: () => number\n\t\t\tgetRowForPosition: (clientCoordinates: Coordinate2D) => ListRow<ElementType, VH> | null\n\t\t\tonSwipeLeft: (entity: ElementType) => Promise<ListSwipeDecision>\n\t\t\tonSwipeRight: (entity: ElementType) => Promise<ListSwipeDecision>\n\t\t},\n\t) {\n\t\tsuper(touchArea)\n\t}\n\n\tonHorizontalDrag(xDelta: number, yDelta: number) {\n\t\tsuper.onHorizontalDrag(xDelta, yDelta)\n\t\t// get it *before* raf so that we don't pick an element after reset() again\n\t\tconst ve = this.getVirtualElement()\n\t\t// Animate the row with following touch\n\t\twindow.requestAnimationFrame(() => {\n\t\t\t// Do not animate the swipe gesture more than necessary\n\t\t\tthis.xoffset = xDelta < 0 ? Math.max(xDelta, -ACTION_DISTANCE) : Math.min(xDelta, ACTION_DISTANCE)\n\n\t\t\tif (!this.isAnimating && ve && ve.domElement && ve.entity) {\n\t\t\t\tve.domElement.style.transform = `translateX(${this.xoffset}px) translateY(${ve.top}px)`\n\t\t\t\tthis.config.domSwipeSpacerLeft().style.transform = `translateX(${this.xoffset - this.width()}px) translateY(${ve.top}px)`\n\t\t\t\tthis.config.domSwipeSpacerRight().style.transform = `\n\t\t\t\ttranslateX(${this.xoffset + this.width()}px) translateY(${ve.top}px)`\n\t\t\t}\n\t\t})\n\t}\n\n\tonHorizontalGestureCompleted(delta: { x: number; y: number }): Promise<unknown> {\n\t\tif (this.virtualElement && this.virtualElement.entity && Math.abs(delta.x) > ACTION_DISTANCE) {\n\t\t\t// the gesture is completed\n\t\t\treturn this.finish(this.virtualElement, this.virtualElement.entity, delta)\n\t\t} else {\n\t\t\treturn this.reset(delta)\n\t\t}\n\t}\n\n\tprivate async finish(\n\t\tvirtualElement: ListRow<ElementType, VH>,\n\t\tentity: ElementType,\n\t\tdelta: {\n\t\t\tx: number\n\t\t\ty: number\n\t\t},\n\t): Promise<unknown> {\n\t\tif (this.xoffset === 0) {\n\t\t\treturn\n\t\t}\n\t\ttry {\n\t\t\tconst listTargetPosition = this.xoffset < 0 ? -this.width() : this.width()\n\n\t\t\tawait Promise.all([\n\t\t\t\t// animate swipe action to full width\n\t\t\t\tvirtualElement.domElement &&\n\t\t\t\t\tanimations.add(\n\t\t\t\t\t\tvirtualElement.domElement,\n\t\t\t\t\t\ttransform(TransformEnum.TranslateX, this.xoffset, listTargetPosition).chain(\n\t\t\t\t\t\t\tTransformEnum.TranslateY,\n\t\t\t\t\t\t\tvirtualElement.top,\n\t\t\t\t\t\t\tvirtualElement.top,\n\t\t\t\t\t\t),\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\teasing: ease.inOut,\n\t\t\t\t\t\t\tduration: DefaultAnimationTime * 2,\n\t\t\t\t\t\t},\n\t\t\t\t\t),\n\t\t\t\tanimations.add(\n\t\t\t\t\tthis.config.domSwipeSpacerLeft(),\n\t\t\t\t\ttransform(TransformEnum.TranslateX, this.xoffset - this.width(), listTargetPosition - this.width()).chain(\n\t\t\t\t\t\tTransformEnum.TranslateY,\n\t\t\t\t\t\tvirtualElement.top,\n\t\t\t\t\t\tvirtualElement.top,\n\t\t\t\t\t),\n\t\t\t\t\t{\n\t\t\t\t\t\teasing: ease.inOut,\n\t\t\t\t\t\tduration: DefaultAnimationTime * 2,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t\tanimations.add(\n\t\t\t\t\tthis.config.domSwipeSpacerRight(),\n\t\t\t\t\ttransform(TransformEnum.TranslateX, this.xoffset + this.width(), listTargetPosition + this.width()).chain(\n\t\t\t\t\t\tTransformEnum.TranslateY,\n\t\t\t\t\t\tvirtualElement.top,\n\t\t\t\t\t\tvirtualElement.top,\n\t\t\t\t\t),\n\t\t\t\t\t{\n\t\t\t\t\t\teasing: ease.inOut,\n\t\t\t\t\t\tduration: DefaultAnimationTime * 2,\n\t\t\t\t\t},\n\t\t\t\t),\n\t\t\t])\n\n\t\t\tthis.xoffset = listTargetPosition\n\n\t\t\tlet swipeDecision: ListSwipeDecision\n\t\t\ttry {\n\t\t\t\tif (delta.x < 0) {\n\t\t\t\t\tswipeDecision = await this.config.onSwipeLeft(entity)\n\t\t\t\t} else {\n\t\t\t\t\tswipeDecision = await this.config.onSwipeRight(entity)\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error(\"rejection in swipe action\", e)\n\t\t\t\tswipeDecision = ListSwipeDecision.Cancel\n\t\t\t}\n\n\t\t\tif (swipeDecision === ListSwipeDecision.Cancel) {\n\t\t\t\tawait this.reset(delta)\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\t// fade out element\n\t\t\tthis.xoffset = 0\n\n\t\t\tif (virtualElement.domElement) {\n\t\t\t\tvirtualElement.domElement.style.transform = `translateX(${this.xoffset}px) translateY(${virtualElement.top}px)`\n\t\t\t}\n\n\t\t\tawait Promise.all([\n\t\t\t\tanimations.add(this.config.domSwipeSpacerLeft(), opacity(1, 0, true)),\n\t\t\t\tanimations.add(this.config.domSwipeSpacerRight(), opacity(1, 0, true)),\n\t\t\t])\n\n\t\t\t// set swipe element to initial configuration\n\t\t\t// with different zoom levels Blink does weird things and shows parts of elements that it shouldn't so we shift them around by a pixel\n\t\t\tthis.config.domSwipeSpacerLeft().style.transform = `translateX(${this.xoffset - this.width() - 1}px) translateY(${virtualElement.top}px)`\n\t\t\tthis.config.domSwipeSpacerRight().style.transform = `translateX(${this.xoffset + this.width() + 1}px) translateY(${virtualElement.top}px)`\n\t\t\tthis.config.domSwipeSpacerRight().style.opacity = \"\"\n\t\t\tthis.config.domSwipeSpacerLeft().style.opacity = \"\"\n\t\t} finally {\n\t\t\tthis.virtualElement = null\n\t\t}\n\t}\n\n\tprivate width() {\n\t\treturn this.config.width()\n\t}\n\n\tprivate getVirtualElement(): ListRow<ElementType, VH> | null {\n\t\tif (!this.virtualElement) {\n\t\t\t// touch coordinates are based on clientX so they are relative to the viewport and we need to adjust them by the position of the list\n\t\t\tthis.virtualElement = this.config.getRowForPosition(this.startPos)\n\t\t}\n\n\t\treturn this.virtualElement\n\t}\n\n\treset(delta: { x: number; y: number }): Promise<unknown> {\n\t\ttry {\n\t\t\tif (this.xoffset !== 0) {\n\t\t\t\tconst ve = this.virtualElement\n\n\t\t\t\tif (ve && ve.domElement && ve.entity) {\n\t\t\t\t\treturn Promise.all([\n\t\t\t\t\t\tanimations.add(ve.domElement, transform(TransformEnum.TranslateX, this.xoffset, 0).chain(TransformEnum.TranslateY, ve.top, ve.top), {\n\t\t\t\t\t\t\teasing: ease.inOut,\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tanimations.add(\n\t\t\t\t\t\t\tthis.config.domSwipeSpacerLeft(),\n\t\t\t\t\t\t\ttransform(TransformEnum.TranslateX, this.xoffset - this.width(), -this.width()).chain(TransformEnum.TranslateY, ve.top, ve.top),\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\teasing: ease.inOut,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t),\n\t\t\t\t\t\tanimations.add(\n\t\t\t\t\t\t\tthis.config.domSwipeSpacerRight(),\n\t\t\t\t\t\t\ttransform(TransformEnum.TranslateX, this.xoffset + this.width(), this.width()).chain(TransformEnum.TranslateY, ve.top, ve.top),\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\teasing: ease.inOut,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t),\n\t\t\t\t\t])\n\t\t\t\t}\n\n\t\t\t\tthis.xoffset = 0\n\t\t\t}\n\t\t} finally {\n\t\t\tthis.virtualElement = null\n\t\t}\n\n\t\treturn Promise.resolve()\n\t}\n}\n"]}