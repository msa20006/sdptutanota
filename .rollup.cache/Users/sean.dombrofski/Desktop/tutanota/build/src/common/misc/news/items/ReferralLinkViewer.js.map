{"version":3,"file":"ReferralLinkViewer.js","sourceRoot":"","sources":["../../../../../../src/common/misc/news/items/ReferralLinkViewer.ts"],"names":[],"mappings":"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","sourcesContent":["import { InfoLink, lang } from \"../../LanguageViewModel.js\"\nimport { isApp } from \"../../../api/common/Env.js\"\nimport { locator } from \"../../../api/main/CommonLocator.js\"\nimport { copyToClipboard } from \"../../ClipboardUtils.js\"\nimport { showSnackBar } from \"../../../gui/base/SnackBar.js\"\nimport { createReferralCodePostIn } from \"../../../api/entities/sys/TypeRefs.js\"\nimport { ReferralCodeService } from \"../../../api/entities/sys/Services.js\"\nimport { TextField, TextFieldAttrs } from \"../../../gui/base/TextField.js\"\nimport m, { Children, Component, Vnode } from \"mithril\"\nimport { IconButton } from \"../../../gui/base/IconButton.js\"\nimport { BootIcons } from \"../../../gui/base/icons/BootIcons.js\"\nimport { ButtonSize } from \"../../../gui/base/ButtonSize.js\"\nimport { Icons } from \"../../../gui/base/icons/Icons.js\"\nimport { ifAllowedTutaLinks } from \"../../../gui/base/GuiUtils.js\"\nimport { UserController } from \"../../../api/main/UserController.js\"\nimport { MoreInfoLink } from \"../MoreInfoLink.js\"\n\nexport type ReferralLinkAttrs = {\n\treferralLink: string\n}\n\n/**\n * Component to display the sharable referral link.\n */\nexport class ReferralLinkViewer implements Component<ReferralLinkAttrs> {\n\tview(vnode: Vnode<ReferralLinkAttrs>): Children {\n\t\treturn m(\".scroll\", [\n\t\t\tm(\".h4\", lang.get(\"referralSettings_label\")),\n\t\t\tm(\"\", lang.get(\"referralLinkLong_msg\")),\n\t\t\tm(TextField, this.getReferralLinkTextFieldAttrs(vnode.attrs.referralLink)),\n\t\t])\n\t}\n\n\tgetReferralLinkTextFieldAttrs(referralLink: string): TextFieldAttrs {\n\t\treturn {\n\t\t\tisReadOnly: true,\n\t\t\tlabel: \"referralLink_label\",\n\t\t\tvalue: referralLink,\n\t\t\tinjectionsRight: () => this.renderButtons(referralLink),\n\t\t\thelpLabel: () => ifAllowedTutaLinks(locator.logins, InfoLink.ReferralLink, (link) => [m(MoreInfoLink, { link: link })]),\n\t\t}\n\t}\n\n\tprivate renderButtons(referralLink: string): Children {\n\t\tif (referralLink === \"\") {\n\t\t\treturn [] // referral link not available yet\n\t\t}\n\n\t\treturn [\n\t\t\tm(IconButton, {\n\t\t\t\ttitle: \"copy_action\",\n\t\t\t\tclick: () => this.copyAction(referralLink),\n\t\t\t\ticon: Icons.Copy,\n\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t}),\n\t\t\tm(IconButton, {\n\t\t\t\ttitle: \"share_action\",\n\t\t\t\tclick: () => this.shareAction(referralLink),\n\t\t\t\ticon: BootIcons.Share,\n\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t}),\n\t\t]\n\t}\n\n\tprivate async copyAction(referralLink: string): Promise<void> {\n\t\tawait copyToClipboard(referralLink)\n\t\tawait showSnackBar({\n\t\t\tmessage: \"linkCopied_msg\",\n\t\t\tbutton: {\n\t\t\t\tlabel: \"close_alt\",\n\t\t\t\tclick: () => {},\n\t\t\t},\n\t\t})\n\t}\n\n\tprivate async shareAction(referralLink: string): Promise<void> {\n\t\tif (isApp()) {\n\t\t\t// open native share dialog on mobile\n\t\t\tconst shareMessage = this.getReferralLinkMessage(referralLink)\n\t\t\treturn locator.systemFacade.shareText(shareMessage, lang.get(\"referralSettings_label\")).then()\n\t\t} else {\n\t\t\t// otherwise share via MailEditor\n\t\t\timport(\"../../../../mail-app/mail/editor/MailEditor.js\").then((mailEditorModule) => mailEditorModule.writeInviteMail(referralLink))\n\t\t}\n\t}\n\n\tprivate getReferralLinkMessage(referralLink: string): string {\n\t\treturn lang.get(\"referralLinkShare_msg\", {\n\t\t\t\"{referralLink}\": referralLink,\n\t\t})\n\t}\n}\n\n/**\n * Get the referral link for the logged-in user\n */\nexport async function getReferralLink(userController: UserController): Promise<string> {\n\tconst customer = await userController.loadCustomer()\n\tconst referralCode = customer.referralCode ? customer.referralCode : await requestNewReferralCode()\n\tconst referralBaseUrl = locator.domainConfigProvider().getCurrentDomainConfig().referralBaseUrl\n\tconst referralUrl = new URL(referralBaseUrl)\n\treferralUrl.searchParams.set(\"ref\", referralCode)\n\treturn referralUrl.href\n}\n\nasync function requestNewReferralCode(): Promise<string> {\n\tconst { referralCode } = await locator.serviceExecutor.post(ReferralCodeService, createReferralCodePostIn({}))\n\treturn referralCode\n}\n"]}