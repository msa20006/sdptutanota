{"version":3,"file":"InAppRatingDialog.js","sourceRoot":"","sources":["../../../../src/common/ratings/InAppRatingDialog.ts"],"names":[],"mappings":"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","sourcesContent":["import { Dialog, DialogType } from \"../gui/base/Dialog.js\"\nimport m from \"mithril\"\nimport { deviceConfig } from \"../misc/DeviceConfig.js\"\nimport { createEvent, getRatingAllowed, isEventHappyMoment, RatingCheckResult } from \"./InAppRatingUtils.js\"\nimport { isIOSApp } from \"../api/common/Env.js\"\nimport { locator } from \"../api/main/CommonLocator.js\"\nimport { Button, ButtonType } from \"../gui/base/Button.js\"\nimport { DefaultAnimationTime } from \"../gui/animation/Animations.js\"\nimport { neverNull, resolveMaybeLazy } from \"@tutao/tutanota-utils\"\nimport { Keys } from \"../api/common/TutanotaConstants.js\"\nimport { DialogHeaderBarAttrs } from \"../gui/base/DialogHeaderBar.js\"\nimport { BaseButton, BaseButtonAttrs } from \"../gui/base/buttons/BaseButton.js\"\nimport { theme } from \"../gui/theme.js\"\nimport { px, size } from \"../gui/size.js\"\nimport { client } from \"../misc/ClientDetector.js\"\nimport { lang } from \"../misc/LanguageViewModel.js\"\nimport { DateTime } from \"luxon\"\n\nconst enum AppRatingValue {\n\tHappy = \"happy\",\n\tUnhappy = \"unhappy\",\n\tNotNow = \"notNow\",\n}\n\n/**\n * Displays the application rating dialog to the user and handles their selection.\n *\n * The dialog provides options for users to rate their experience as positive or negative,\n * or to dismiss the dialog with actions such as \"Not now\".\" Based on\n * the user's choice, appropriate follow-up actions are taken:\n *\n * - **Happy**: Prompts the user to leave a review on the App Store. Will not ask for a review again within one year.\n * - **Unhappy**: No immediate action; the user is not redirected. Will not ask for a review again within one year.\n * - **Not now**: Prevents the dialog from being shown for one month.\n *\n * @returns {Promise<void>} Resolves after the user makes a selection and associated actions are completed.\n */\nexport async function showAppRatingDialog(): Promise<void> {\n\tconst selectedValue: AppRatingValue = await new Promise((resolve) => {\n\t\tconst choose = (choice: AppRatingValue) => {\n\t\t\tdialog.close()\n\t\t\tsetTimeout(() => resolve(choice), DefaultAnimationTime)\n\t\t}\n\n\t\tconst headerBarProps: DialogHeaderBarAttrs = {\n\t\t\tright: [\n\t\t\t\t{\n\t\t\t\t\tlabel: \"notNow_label\",\n\t\t\t\t\tclick: () => choose(AppRatingValue.NotNow),\n\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t},\n\t\t\t],\n\t\t}\n\n\t\tconst columnClass = \".flex-half.overflow-hidden\"\n\n\t\tconst dialog = new Dialog(DialogType.EditSmall, {\n\t\t\tview: () =>\n\t\t\t\tm(\"\", [\n\t\t\t\t\tm(\".dialog-header.plr-l.flex-space-between.dialog-header-line-height\", [\n\t\t\t\t\t\tm(columnClass + \".ml-negative-s\"),\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\tcolumnClass + \".mr-negative-s.flex.justify-end\",\n\t\t\t\t\t\t\tresolveMaybeLazy(neverNull(headerBarProps.right)).map((a) => m(Button, a)),\n\t\t\t\t\t\t),\n\t\t\t\t\t]),\n\t\t\t\t\tm(\n\t\t\t\t\t\t\".plr-l.pb-ml.text-break\",\n\t\t\t\t\t\tm(\".flex.flex-column\", [\n\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\"#dialog-message.dialog-max-height.text-break.text-prewrap.selectable.scroll\",\n\t\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\t\"\",\n\t\t\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\t\t\".flex-center.mt-m\",\n\t\t\t\t\t\t\t\t\t\tm(\"img.pb.pt.block.height-100p\", {\n\t\t\t\t\t\t\t\t\t\t\tsrc: `${window.tutao.appState.prefixWithoutFile}/images/rating/${client.isCalendarApp() ? \"calendar\" : \"mail\"}.png`,\n\t\t\t\t\t\t\t\t\t\t\talt: \"\",\n\t\t\t\t\t\t\t\t\t\t\trel: \"noreferrer\",\n\t\t\t\t\t\t\t\t\t\t\tloading: \"lazy\",\n\t\t\t\t\t\t\t\t\t\t\tdecoding: \"async\",\n\t\t\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\t\t\twidth: \"80%\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\tm(\"h1.text-center\", lang.get(\"ratingHowAreWeDoing_title\")),\n\t\t\t\t\t\t\t\t\tm(\"p.text-center\", lang.get(\"ratingExplanation_msg\")),\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\".flex.flex-column.mt\",\n\t\t\t\t\t\t\t\t{ style: { gap: \"1em\" } },\n\t\t\t\t\t\t\t\tm(BaseButton, {\n\t\t\t\t\t\t\t\t\tlabel: \"ratingLoveIt_label\",\n\t\t\t\t\t\t\t\t\ttext: lang.get(\"ratingLoveIt_label\"),\n\t\t\t\t\t\t\t\t\tonclick: () => choose(AppRatingValue.Happy),\n\t\t\t\t\t\t\t\t\tclass: `full-width border-radius-small center b flash accent-bg button-content`,\n\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\theight: px(size.button_height + size.vpad_xs * 1.5),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t} satisfies BaseButtonAttrs),\n\n\t\t\t\t\t\t\t\tm(BaseButton, {\n\t\t\t\t\t\t\t\t\tlabel: \"ratingNeedsWork_label\",\n\t\t\t\t\t\t\t\t\ttext: lang.get(\"ratingNeedsWork_label\"),\n\t\t\t\t\t\t\t\t\tonclick: () => choose(AppRatingValue.Unhappy),\n\t\t\t\t\t\t\t\t\tclass: `full-width border-radius-small center b flash`,\n\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${theme.content_accent}`,\n\t\t\t\t\t\t\t\t\t\theight: px(size.button_height + size.vpad_xs * 1.5),\n\t\t\t\t\t\t\t\t\t\tcolor: theme.content_accent,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t} satisfies BaseButtonAttrs),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t]),\n\t\t\t\t\t),\n\t\t\t\t]),\n\t\t}).addShortcut({\n\t\t\thelp: \"close_alt\",\n\t\t\tkey: Keys.ESC,\n\t\t\texec: () => choose(AppRatingValue.NotNow),\n\t\t})\n\n\t\tdialog.show()\n\t})\n\n\thandleRatingDialogSelection(selectedValue)\n}\n\nfunction handleRatingDialogSelection(selectedValue: AppRatingValue) {\n\tswitch (selectedValue) {\n\t\tcase AppRatingValue.Unhappy:\n\t\t\tdeviceConfig.setLastRatingPromptedDate(new Date())\n\t\t\tbreak\n\t\tcase AppRatingValue.NotNow:\n\t\t\t// Ask again in minimum one month from now.\n\t\t\tdeviceConfig.setRetryRatingPromptAfter(DateTime.now().plus({ months: 1 }).toJSDate())\n\t\t\tbreak\n\t\tcase AppRatingValue.Happy: {\n\t\t\tdeviceConfig.setLastRatingPromptedDate(new Date())\n\n\t\t\tvoid locator.systemFacade.requestInAppRating()\n\t\t\tbreak\n\t\t}\n\t}\n}\n\n/**\n * If the client is on iOS, we save the current date as an event to determine if we want to trigger a \"rate Tuta\" dialog.\n */\nexport async function handleRatingByEvent() {\n\tconst isTheIOSApp = isIOSApp()\n\n\tif (isTheIOSApp) {\n\t\tcreateEvent(deviceConfig)\n\t}\n\n\tconst now = new Date()\n\n\tif ((await getRatingAllowed(now, deviceConfig, isTheIOSApp)) === RatingCheckResult.RATING_ALLOWED) {\n\t\tif (isEventHappyMoment(now, deviceConfig)) {\n\t\t\tvoid showAppRatingDialog()\n\t\t}\n\t}\n}\n"]}