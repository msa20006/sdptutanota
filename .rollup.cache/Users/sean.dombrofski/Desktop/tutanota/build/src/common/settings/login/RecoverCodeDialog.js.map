{"version":3,"file":"RecoverCodeDialog.js","sourceRoot":"","sources":["../../../../../src/common/settings/login/RecoverCodeDialog.ts"],"names":[],"mappings":"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","sourcesContent":["import { InfoLink, lang, TranslationKey } from \"../../misc/LanguageViewModel.js\"\nimport { Dialog, DialogType } from \"../../gui/base/Dialog.js\"\nimport { assertNotNull, Hex, noOp, ofClass } from \"@tutao/tutanota-utils\"\nimport m, { Child, Children, Vnode } from \"mithril\"\nimport { assertMainOrNode, isApp } from \"../../api/common/Env.js\"\nimport { copyToClipboard } from \"../../misc/ClipboardUtils.js\"\nimport { AccessBlockedError, NotAuthenticatedError } from \"../../api/common/error/RestError.js\"\nimport { locator } from \"../../api/main/CommonLocator.js\"\nimport { Icons } from \"../../gui/base/icons/Icons.js\"\nimport { User } from \"../../api/entities/sys/TypeRefs.js\"\nimport { getEtId, isSameId } from \"../../api/common/utils/EntityUtils.js\"\nimport { GroupType } from \"../../api/common/TutanotaConstants.js\"\nimport { IconButton } from \"../../gui/base/IconButton.js\"\nimport { MoreInfoLink } from \"../../misc/news/MoreInfoLink.js\"\nimport { showRequestPasswordDialog } from \"../../misc/passwords/PasswordRequestDialog.js\"\n\ntype Action = \"get\" | \"create\"\nassertMainOrNode()\n\nexport function showRecoverCodeDialogAfterPasswordVerificationAndInfoDialog(user: User) {\n\t// We only show the recovery code if it is for the current user and it is a global admin\n\tif (!isSameId(getEtId(locator.logins.getUserController().user), getEtId(user)) || !user.memberships.some((gm) => gm.groupType === GroupType.Admin)) {\n\t\treturn\n\t}\n\n\tconst isRecoverCodeAvailable = user.auth && user.auth.recoverCode != null\n\tDialog.showActionDialog({\n\t\ttitle: \"recoveryCode_label\",\n\t\ttype: DialogType.EditMedium,\n\t\tchild: () => m(\".pt\", lang.get(\"recoveryCode_msg\")),\n\t\tallowOkWithReturn: true,\n\t\tokAction: (dialog: Dialog) => {\n\t\t\tdialog.close()\n\t\t\tshowRecoverCodeDialogAfterPasswordVerification(isRecoverCodeAvailable ? \"get\" : \"create\", false)\n\t\t},\n\t\tokActionTextId: isRecoverCodeAvailable ? \"show_action\" : \"setUp_action\",\n\t})\n}\n\nexport function showRecoverCodeDialogAfterPasswordVerification(action: Action, showMessage: boolean = true) {\n\tconst recoverCodeFacade = locator.recoverCodeFacade\n\tconst dialog = showRequestPasswordDialog({\n\t\taction: (pw) => {\n\t\t\treturn (action === \"get\" ? recoverCodeFacade.getRecoverCodeHex(pw) : recoverCodeFacade.createRecoveryCode(pw))\n\t\t\t\t.then((recoverCode) => {\n\t\t\t\t\tdialog.close()\n\t\t\t\t\tshowRecoverCodeDialog(recoverCode, showMessage)\n\t\t\t\t\treturn \"\"\n\t\t\t\t})\n\t\t\t\t.catch(ofClass(NotAuthenticatedError, () => lang.get(\"invalidPassword_msg\")))\n\t\t\t\t.catch(ofClass(AccessBlockedError, () => lang.get(\"tooManyAttempts_msg\")))\n\t\t},\n\t\tcancel: {\n\t\t\ttextId: \"cancel_action\",\n\t\t\taction: noOp,\n\t\t},\n\t})\n}\n\nexport function showRecoverCodeDialog(recoverCode: Hex, showMessage: boolean): Promise<void> {\n\treturn new Promise((resolve) => {\n\t\tDialog.showActionDialog({\n\t\t\ttitle: \"recoveryCode_label\",\n\t\t\tchild: {\n\t\t\t\tview: () => {\n\t\t\t\t\treturn m(RecoverCodeField, {\n\t\t\t\t\t\tshowMessage,\n\t\t\t\t\t\trecoverCode,\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t},\n\t\t\tallowCancel: false,\n\t\t\tallowOkWithReturn: true,\n\t\t\tokAction: (dialog: Dialog) => {\n\t\t\t\tdialog.close()\n\t\t\t\tresolve()\n\t\t\t},\n\t\t\ttype: DialogType.EditMedium,\n\t\t})\n\t})\n}\n\nexport type RecoverCodeFieldAttrs = {\n\tshowMessage: boolean\n\trecoverCode: Hex\n\tshowButtons?: boolean\n\timage?: {\n\t\tsrc: string\n\t\talt: TranslationKey\n\t}\n}\n\nexport class RecoverCodeField {\n\tview(vnode: Vnode<RecoverCodeFieldAttrs>): Children {\n\t\tlet { recoverCode, showButtons, showMessage, image } = vnode.attrs\n\t\tshowButtons = showButtons ?? true\n\n\t\tconst splitRecoverCode = assertNotNull(recoverCode.match(/.{4}/g)).join(\" \")\n\t\treturn [\n\t\t\tshowMessage\n\t\t\t\t? image\n\t\t\t\t\t? m(\".flex-space-around.flex-wrap\", [\n\t\t\t\t\t\t\tm(\".flex-grow-shrink-half.plr-l.flex-center.align-self-center\", this.renderRecoveryText()),\n\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\".flex-grow-shrink-half.plr-l.flex-center.align-self-center\",\n\t\t\t\t\t\t\t\tm(\"img.pt.bg-white.pt.pb\", {\n\t\t\t\t\t\t\t\t\tsrc: image.src,\n\t\t\t\t\t\t\t\t\talt: lang.getTranslationText(image.alt),\n\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\twidth: \"200px\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t  ])\n\t\t\t\t\t: this.renderRecoveryText()\n\t\t\t\t: m(\"\", lang.get(\"emptyString_msg\")),\n\t\t\tm(\".text-break.monospace.selectable.flex.flex-wrap.border.pt.pb.plr\", splitRecoverCode),\n\t\t\tshowButtons\n\t\t\t\t? m(\".flex.flex-end.mt-m\", [\n\t\t\t\t\t\tm(IconButton, {\n\t\t\t\t\t\t\ttitle: \"copy_action\",\n\t\t\t\t\t\t\ticon: Icons.Clipboard,\n\t\t\t\t\t\t\tclick: () => copyToClipboard(splitRecoverCode),\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tisApp() || typeof window.print !== \"function\"\n\t\t\t\t\t\t\t? null\n\t\t\t\t\t\t\t: m(IconButton, {\n\t\t\t\t\t\t\t\t\ttitle: \"print_action\",\n\t\t\t\t\t\t\t\t\ticon: Icons.Print,\n\t\t\t\t\t\t\t\t\tclick: () => window.print(),\n\t\t\t\t\t\t\t  }),\n\t\t\t\t  ])\n\t\t\t\t: null,\n\t\t]\n\t}\n\n\tprivate renderRecoveryText(): Child {\n\t\tconst link = InfoLink.RecoverCode\n\t\treturn m(\".pt.pb\", [lang.get(\"recoveryCode_msg\"), m(\"\", [m(MoreInfoLink, { link, isSmall: true })])])\n\t}\n}\n"]}