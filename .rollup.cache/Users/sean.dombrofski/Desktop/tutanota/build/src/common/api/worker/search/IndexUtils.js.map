{"version":3,"file":"IndexUtils.js","sourceRoot":"","sources":["../../../../../../src/common/api/worker/search/IndexUtils.ts"],"names":[],"mappings":"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","sourcesContent":["import { Base64, concat, stringToUtf8Uint8Array, TypeRef, uint8ArrayToBase64, utf8Uint8ArrayToString } from \"@tutao/tutanota-utils\"\nimport type {\n\tDecryptedSearchIndexEntry,\n\tEncryptedSearchIndexEntry,\n\tIndexUpdate,\n\tSearchIndexEntry,\n\tSearchIndexMetaDataDbRow,\n\tSearchIndexMetadataEntry,\n\tSearchIndexMetaDataRow,\n} from \"./SearchTypes\"\nimport { GroupType } from \"../../common/TutanotaConstants\"\nimport { calculateNeededSpaceForNumber, calculateNeededSpaceForNumbers, decodeNumberBlock, decodeNumbers, encodeNumbers } from \"./SearchIndexEncoding\"\nimport { typeModels as tutanotaTypeModels } from \"../../entities/tutanota/TypeModels\"\nimport type { GroupMembership, User } from \"../../entities/sys/TypeRefs.js\"\nimport type { TypeModel } from \"../../common/EntityTypes\"\nimport { isTest } from \"../../common/Env\"\nimport { aes256EncryptSearchIndexEntry, Aes256Key, unauthenticatedAesDecrypt } from \"@tutao/tutanota-crypto\"\n\nexport function encryptIndexKeyBase64(key: Aes256Key, indexKey: string, dbIv: Uint8Array): Base64 {\n\treturn uint8ArrayToBase64(encryptIndexKeyUint8Array(key, indexKey, dbIv))\n}\n\nexport function encryptIndexKeyUint8Array(key: Aes256Key, indexKey: string, dbIv: Uint8Array): Uint8Array {\n\treturn aes256EncryptSearchIndexEntry(key, stringToUtf8Uint8Array(indexKey), dbIv, true).slice(dbIv.length)\n}\n\nexport function decryptIndexKey(key: Aes256Key, encIndexKey: Uint8Array, dbIv: Uint8Array): string {\n\treturn utf8Uint8ArrayToString(unauthenticatedAesDecrypt(key, concat(dbIv, encIndexKey), true))\n}\n\nexport function encryptSearchIndexEntry(key: Aes256Key, entry: SearchIndexEntry, encryptedInstanceId: Uint8Array): EncryptedSearchIndexEntry {\n\tlet searchIndexEntryNumberValues = [entry.attribute].concat(entry.positions)\n\tconst neededSpace = calculateNeededSpaceForNumbers(searchIndexEntryNumberValues)\n\tconst block = new Uint8Array(neededSpace)\n\tencodeNumbers(searchIndexEntryNumberValues, block, 0)\n\tconst encData = aes256EncryptSearchIndexEntry(key, block)\n\tconst resultArray = new Uint8Array(encryptedInstanceId.length + encData.length)\n\tresultArray.set(encryptedInstanceId)\n\tresultArray.set(encData, 16)\n\treturn resultArray\n}\n\nexport function decryptSearchIndexEntry(key: Aes256Key, entry: EncryptedSearchIndexEntry, dbIv: Uint8Array): DecryptedSearchIndexEntry {\n\tconst encId = getIdFromEncSearchIndexEntry(entry)\n\tlet id = decryptIndexKey(key, encId, dbIv)\n\tconst data = unauthenticatedAesDecrypt(key, entry.subarray(16), true)\n\tlet offset = 0\n\tconst attribute = decodeNumberBlock(data, offset)\n\toffset += calculateNeededSpaceForNumber(attribute)\n\tconst positions = decodeNumbers(data, offset)\n\treturn {\n\t\tid: id,\n\t\tencId,\n\t\tattribute,\n\t\tpositions,\n\t}\n}\n\nconst metaEntryFieldsNumber = 5\n\nexport function encryptMetaData(key: Aes256Key, metaData: SearchIndexMetaDataRow): SearchIndexMetaDataDbRow {\n\tconst numbers = new Array(metaData.rows.length * metaEntryFieldsNumber)\n\n\tfor (let i = 0; i < metaData.rows.length; i++) {\n\t\tconst entry = metaData.rows[i]\n\t\tconst offset = i * metaEntryFieldsNumber\n\t\tnumbers[offset] = entry.app\n\t\tnumbers[offset + 1] = entry.type\n\t\tnumbers[offset + 2] = entry.key\n\t\tnumbers[offset + 3] = entry.size\n\t\tnumbers[offset + 4] = entry.oldestElementTimestamp\n\t}\n\n\tconst numberBlock = new Uint8Array(calculateNeededSpaceForNumbers(numbers))\n\tencodeNumbers(numbers, numberBlock)\n\tconst encryptedRows = aes256EncryptSearchIndexEntry(key, numberBlock)\n\treturn {\n\t\tid: metaData.id,\n\t\tword: metaData.word,\n\t\trows: encryptedRows,\n\t}\n}\n\nexport function decryptMetaData(key: Aes256Key, encryptedMeta: SearchIndexMetaDataDbRow): SearchIndexMetaDataRow {\n\t// Initially we write empty data block there. In this case we can't get IV from it and decrypt it\n\tif (encryptedMeta.rows.length === 0) {\n\t\treturn {\n\t\t\tid: encryptedMeta.id,\n\t\t\tword: encryptedMeta.word,\n\t\t\trows: [],\n\t\t}\n\t}\n\n\tconst numbersBlock = unauthenticatedAesDecrypt(key, encryptedMeta.rows, true)\n\tconst numbers = decodeNumbers(numbersBlock)\n\tconst rows: SearchIndexMetadataEntry[] = []\n\n\tfor (let i = 0; i < numbers.length; i += metaEntryFieldsNumber) {\n\t\trows.push({\n\t\t\tapp: numbers[i],\n\t\t\ttype: numbers[i + 1],\n\t\t\tkey: numbers[i + 2],\n\t\t\tsize: numbers[i + 3],\n\t\t\toldestElementTimestamp: numbers[i + 4],\n\t\t})\n\t}\n\n\treturn {\n\t\tid: encryptedMeta.id,\n\t\tword: encryptedMeta.word,\n\t\trows,\n\t}\n}\n\nexport type TypeInfo = {\n\tappId: number\n\ttypeId: number\n\tattributeIds: number[]\n}\nconst typeInfos = {\n\ttutanota: {\n\t\tMail: {\n\t\t\tappId: 1,\n\t\t\ttypeId: tutanotaTypeModels.Mail.id,\n\t\t\tattributeIds: getAttributeIds(tutanotaTypeModels.Mail),\n\t\t},\n\t\tContact: {\n\t\t\tappId: 1,\n\t\t\ttypeId: tutanotaTypeModels.Contact.id,\n\t\t\tattributeIds: getAttributeIds(tutanotaTypeModels.Contact),\n\t\t},\n\t},\n}\n\nexport function getAttributeIds(model: TypeModel) {\n\treturn Object.keys(model.values)\n\t\t.map((name) => model.values[name].id)\n\t\t.concat(Object.keys(model.associations).map((name) => model.associations[name].id))\n}\n\nexport function typeRefToTypeInfo(typeRef: TypeRef<any>): TypeInfo {\n\t// @ts-ignore\n\tconst app = typeInfos[typeRef.app]\n\n\tif (!app) {\n\t\tthrow new Error(\"No TypeInfo for app: \" + app)\n\t}\n\n\tconst typeInfo = app[typeRef.type]\n\n\tif (!typeInfo) {\n\t\tthrow new Error(`No TypeInfo for TypeRef ${typeRef.app} : ${typeRef.type}`)\n\t}\n\n\treturn typeInfo\n}\n\nexport function userIsGlobalAdmin(user: User): boolean {\n\treturn user.memberships.some((m) => m.groupType === GroupType.Admin)\n}\n\nexport function filterIndexMemberships(user: User): GroupMembership[] {\n\treturn user.memberships.filter(\n\t\t(m) => m.groupType === GroupType.Mail || m.groupType === GroupType.Contact || m.groupType === GroupType.Customer || m.groupType === GroupType.Admin,\n\t)\n}\n\nexport function filterMailMemberships(user: User): GroupMembership[] {\n\treturn user.memberships.filter((m) => m.groupType === GroupType.Mail)\n}\n\nexport function _createNewIndexUpdate(typeInfo: TypeInfo): IndexUpdate {\n\treturn {\n\t\ttypeInfo,\n\t\tcreate: {\n\t\t\tencInstanceIdToElementData: new Map(),\n\t\t\tindexMap: new Map(),\n\t\t},\n\t\tmove: [],\n\t\tdelete: {\n\t\t\tsearchMetaRowToEncInstanceIds: new Map(),\n\t\t\tencInstanceIds: [],\n\t\t},\n\t}\n}\n\nexport function htmlToText(html: string | null): string {\n\tif (html == null) return \"\"\n\tlet text = html.replace(/<[^>]*>?/gm, \" \")\n\treturn text.replace(/&[#0-9a-zA-Z]+;/g, (match) => {\n\t\tlet replacement\n\n\t\tif (match.startsWith(\"&#\")) {\n\t\t\tlet charCode = Number(match.substring(2, match.length - 1)) // remove &# and ;\n\n\t\t\tif (!isNaN(charCode)) {\n\t\t\t\treplacement = String.fromCharCode(charCode)\n\t\t\t}\n\t\t} else {\n\t\t\t// @ts-ignore\n\t\t\treplacement = HTML_ENTITIES[match]\n\t\t}\n\n\t\treturn replacement ? replacement : match\n\t})\n}\n\nconst HTML_ENTITIES = {\n\t\"&nbsp;\": \" \",\n\t\"&amp;\": \"&\",\n\t\"&lt;\": \"<\",\n\t\"&gt;\": \">\",\n\t\"&Agrave;\": \"À\",\n\t\"&Aacute;\": \"Á\",\n\t\"&Acirc;\": \"Â\",\n\t\"&Atilde;\": \"Ã\",\n\t\"&Auml;\": \"Ä\",\n\t\"&Aring;\": \"Å\",\n\t\"&AElig;\": \"Æ\",\n\t\"&Ccedil;\": \"Ç\",\n\t\"&Egrave;\": \"È\",\n\t\"&Eacute;\": \"É\",\n\t\"&Ecirc;\": \"Ê\",\n\t\"&Euml;\": \"Ë\",\n\t\"&Igrave;\": \"Ì\",\n\t\"&Iacute;\": \"Í\",\n\t\"&Icirc;\": \"Î\",\n\t\"&Iuml;\": \"Ï\",\n\t\"&ETH;\": \"Ð\",\n\t\"&Ntilde;\": \"Ñ\",\n\t\"&Ograve;\": \"Ò\",\n\t\"&Oacute;\": \"Ó\",\n\t\"&Ocirc;\": \"Ô\",\n\t\"&Otilde;\": \"Õ\",\n\t\"&Ouml;\": \"Ö\",\n\t\"&Oslash;\": \"Ø\",\n\t\"&Ugrave;\": \"Ù\",\n\t\"&Uacute;\": \"Ú\",\n\t\"&Ucirc;\": \"Û\",\n\t\"&Uuml;\": \"Ü\",\n\t\"&Yacute;\": \"Ý\",\n\t\"&THORN;\": \"Þ\",\n\t\"&szlig;\": \"ß\",\n\t\"&agrave;\": \"à\",\n\t\"&aacute;\": \"á\",\n\t\"&acirc;\": \"â\",\n\t\"&atilde;\": \"ã\",\n\t\"&auml;\": \"ä\",\n\t\"&aring;\": \"å\",\n\t\"&aelig;\": \"æ\",\n\t\"&ccedil;\": \"ç\",\n\t\"&egrave;\": \"è\",\n\t\"&eacute;\": \"é\",\n\t\"&ecirc;\": \"ê\",\n\t\"&euml;\": \"ë\",\n\t\"&igrave;\": \"ì\",\n\t\"&iacute;\": \"í\",\n\t\"&icirc;\": \"î\",\n\t\"&iuml;\": \"ï\",\n\t\"&eth;\": \"ð\",\n\t\"&ntilde;\": \"ñ\",\n\t\"&ograve;\": \"ò\",\n\t\"&oacute;\": \"ó\",\n\t\"&ocirc;\": \"ô\",\n\t\"&otilde;\": \"õ\",\n\t\"&ouml;\": \"ö\",\n\t\"&oslash;\": \"ø\",\n\t\"&ugrave;\": \"ù\",\n\t\"&uacute;\": \"ú\",\n\t\"&ucirc;\": \"û\",\n\t\"&uuml;\": \"ü\",\n\t\"&yacute;\": \"ý\",\n\t\"&thorn;\": \"þ\",\n\t\"&yuml;\": \"ÿ\",\n\t\"&Alpha;\": \"Α\",\n\t\"&Beta;\": \"Β\",\n\t\"&Gamma;\": \"Γ\",\n\t\"&Delta;\": \"Δ\",\n\t\"&Epsilon;\": \"Ε\",\n\t\"&Zeta;\": \"Ζ\",\n\t\"&Eta;\": \"Η\",\n\t\"&Theta;\": \"Θ\",\n\t\"&Iota;\": \"Ι\",\n\t\"&Kappa;\": \"Κ\",\n\t\"&Lambda;\": \"Λ\",\n\t\"&Mu;\": \"Μ\",\n\t\"&Nu;\": \"Ν\",\n\t\"&Xi;\": \"Ξ\",\n\t\"&Omicron;\": \"Ο\",\n\t\"&Pi;\": \"Π\",\n\t\"&Rho;\": \"Ρ\",\n\t\"&Sigma;\": \"Σ\",\n\t\"&Tau;\": \"Τ\",\n\t\"&Upsilon;\": \"Υ\",\n\t\"&Phi;\": \"Φ\",\n\t\"&Chi;\": \"Χ\",\n\t\"&Psi;\": \"Ψ\",\n\t\"&Omega;\": \"Ω\",\n\t\"&alpha;\": \"α\",\n\t\"&beta;\": \"β\",\n\t\"&gamma;\": \"γ\",\n\t\"&delta;\": \"δ\",\n\t\"&epsilon;\": \"ε\",\n\t\"&zeta;\": \"ζ\",\n\t\"&eta;\": \"η\",\n\t\"&theta;\": \"θ\",\n\t\"&iota;\": \"ι\",\n\t\"&kappa;\": \"κ\",\n\t\"&lambda;\": \"λ\",\n\t\"&mu;\": \"μ\",\n\t\"&nu;\": \"ν\",\n\t\"&xi;\": \"ξ\",\n\t\"&omicron;\": \"ο\",\n\t\"&pi;\": \"π\",\n\t\"&rho;\": \"ρ\",\n\t\"&sigmaf;\": \"ς\",\n\t\"&sigma;\": \"σ\",\n\t\"&tau;\": \"τ\",\n\t\"&upsilon;\": \"υ\",\n\t\"&phi;\": \"φ\",\n\t\"&chi;\": \"χ\",\n\t\"&psi;\": \"ψ\",\n\t\"&omega;\": \"ω\",\n\t\"&thetasym;\": \"ϑ\",\n\t\"&upsih;\": \"ϒ\",\n\t\"&piv;\": \"ϖ\",\n}\n\nexport function getPerformanceTimestamp(): number {\n\treturn typeof performance === \"undefined\" ? Date.now() : performance.now() // performance is not available in Safari 10 worker scope\n}\n\nexport function getIdFromEncSearchIndexEntry(entry: Uint8Array): Uint8Array {\n\treturn entry.subarray(0, 16)\n}\n\nexport function compareMetaEntriesOldest(left: SearchIndexMetadataEntry, right: SearchIndexMetadataEntry): number {\n\treturn left.oldestElementTimestamp - right.oldestElementTimestamp\n}\n\nexport function printMeasure(prefix: string, names: string[]) {\n\tif (!shouldMeasure()) return\n\n\tfor (let name of names) {\n\t\ttry {\n\t\t\tperformance.clearMeasures(name)\n\t\t\tperformance.clearMarks(name + \"-end\")\n\t\t\tperformance.clearMarks(name + \"-start\")\n\t\t} catch (e) {\n\t\t\t/* empty */\n\t\t}\n\t}\n}\n\nexport function markStart(name: string) {\n\tif (shouldMeasure()) performance.mark(name + \"-start\")\n}\n\nexport function markEnd(name: string) {\n\tif (!shouldMeasure()) return\n\n\ttry {\n\t\tperformance.mark(name + \"-end\")\n\t\tperformance.measure(name, name + \"-start\", name + \"-end\")\n\t} catch (e) {\n\t\t/* empty */\n\t}\n}\n\nexport function shouldMeasure(): boolean {\n\treturn !env.dist && !isTest()\n}\n"]}