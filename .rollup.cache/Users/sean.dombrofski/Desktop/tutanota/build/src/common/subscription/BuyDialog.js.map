{"version":3,"file":"BuyDialog.js","sourceRoot":"","sources":["../../../../src/common/subscription/BuyDialog.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Children, Component, Vnode } from \"mithril\"\nimport { assertNotNull, filterInt, incrementDate, ofClass } from \"@tutao/tutanota-utils\"\nimport { TextField, TextFieldType } from \"../gui/base/TextField.js\"\nimport { Dialog, DialogType } from \"../gui/base/Dialog.js\"\nimport { lang, TranslationKey } from \"../misc/LanguageViewModel.js\"\nimport { BookingItemFeatureType, FeatureType } from \"../api/common/TutanotaConstants.js\"\nimport { formatDate } from \"../misc/Formatter.js\"\nimport type { PriceData, PriceServiceReturn } from \"../api/entities/sys/TypeRefs.js\"\nimport { AccountingInfoTypeRef, PriceItemData } from \"../api/entities/sys/TypeRefs.js\"\nimport { NotAuthorizedError } from \"../api/common/error/RestError.js\"\nimport { asPaymentInterval, formatPrice, getPriceItem, PaymentInterval } from \"./PriceUtils.js\"\nimport { showProgressDialog } from \"../gui/dialogs/ProgressDialog.js\"\nimport { locator } from \"../api/main/CommonLocator.js\"\nimport { assertMainOrNode } from \"../api/common/Env.js\"\n\nassertMainOrNode()\n\nexport interface BookingParams {\n\tfeatureType: BookingItemFeatureType\n\tbookingText: TranslationKey\n\tcount: number\n\tfreeAmount: number\n\treactivate: boolean\n}\n\n/**\n * Returns true if the order is accepted by the user, false otherwise.\n */\nexport async function showBuyDialog(params: BookingParams): Promise<boolean> {\n\tif (locator.logins.isEnabled(FeatureType.HideBuyDialogs)) {\n\t\treturn true\n\t}\n\tconst priceChangeModel = await showProgressDialog(\"pleaseWait_msg\", prepareDialog(params))\n\tif (priceChangeModel) {\n\t\treturn showDialog(priceChangeModel.getActionLabel(), () =>\n\t\t\tm(ConfirmSubscriptionView, { priceChangeModel, count: params.count, freeAmount: params.freeAmount, bookingText: params.bookingText }),\n\t\t)\n\t} else {\n\t\treturn false\n\t}\n}\n\nasync function prepareDialog({ featureType, count, reactivate }: BookingParams): Promise<PriceChangeModel | null> {\n\tconst price = await locator.bookingFacade.getPrice(featureType, count, reactivate)\n\tconst priceChangeModel = new PriceChangeModel(price, featureType)\n\tconst customerInfo = await locator.logins.getUserController().loadCustomerInfo()\n\tconst accountingInfo = await locator.entityClient.load(AccountingInfoTypeRef, customerInfo.accountingInfo).catch(ofClass(NotAuthorizedError, () => null))\n\tif (accountingInfo && accountingInfo.paymentMethod == null) {\n\t\tconst confirm = await Dialog.confirm(\"enterPaymentDataFirst_msg\")\n\t\tif (confirm) {\n\t\t\tm.route.set(\"/settings/invoice\")\n\t\t}\n\n\t\treturn null\n\t} else {\n\t\treturn priceChangeModel\n\t}\n}\n\nfunction showDialog(okLabel: TranslationKey, view: () => Children) {\n\treturn new Promise<boolean>((resolve) => {\n\t\tlet dialog: Dialog\n\n\t\tconst doAction = (res: boolean) => {\n\t\t\tdialog.close()\n\t\t\tresolve(res)\n\t\t}\n\n\t\tdialog = Dialog.showActionDialog({\n\t\t\tokActionTextId: okLabel,\n\t\t\ttitle: \"bookingSummary_label\",\n\t\t\tchild: () => view(),\n\t\t\tokAction: () => doAction(true),\n\t\t\tcancelAction: () => doAction(false),\n\t\t\ttype: DialogType.EditSmall,\n\t\t})\n\t})\n}\n\ninterface ConfirmAttrs {\n\tpriceChangeModel: PriceChangeModel\n\tcount: number\n\tfreeAmount: number\n\tbookingText: TranslationKey\n}\n\nclass ConfirmSubscriptionView implements Component<ConfirmAttrs> {\n\tview({ attrs }: Vnode<ConfirmAttrs>): Children {\n\t\tconst { priceChangeModel, count, freeAmount } = attrs\n\t\tconst chargeDate = incrementDate(priceChangeModel.periodEndDate(), 1)\n\n\t\treturn m(\"\", [\n\t\t\tm(TextField, {\n\t\t\t\tlabel: \"bookingOrder_label\",\n\t\t\t\tvalue: lang.get(attrs.bookingText, {\n\t\t\t\t\t\"{1}\": Math.abs(count),\n\t\t\t\t}),\n\t\t\t\ttype: TextFieldType.Area,\n\t\t\t\tisReadOnly: true,\n\t\t\t}),\n\t\t\tpriceChangeModel.isBuy()\n\t\t\t\t? m(TextField, {\n\t\t\t\t\t\tlabel: \"subscription_label\",\n\t\t\t\t\t\thelpLabel: () => lang.get(\"nextChargeOn_label\", { \"{chargeDate}\": formatDate(chargeDate) }),\n\t\t\t\t\t\tvalue: this.getSubscriptionText(priceChangeModel),\n\t\t\t\t\t\tisReadOnly: true,\n\t\t\t\t  })\n\t\t\t\t: null,\n\t\t\tm(TextField, {\n\t\t\t\tlabel: \"price_label\",\n\t\t\t\thelpLabel: () => this.getPriceInfoText(priceChangeModel),\n\t\t\t\tvalue: this.getPriceText(priceChangeModel),\n\t\t\t\tisReadOnly: true,\n\t\t\t}),\n\t\t])\n\t}\n\n\tprivate getSubscriptionText(model: PriceChangeModel): string {\n\t\tif (model.isYearly()) {\n\t\t\treturn lang.get(\"pricing.yearly_label\")\n\t\t} else {\n\t\t\treturn lang.get(\"pricing.monthly_label\")\n\t\t}\n\t}\n\n\tprivate getPriceText(model: PriceChangeModel): string {\n\t\tlet netGrossText = model.taxIncluded() ? lang.get(\"gross_label\") : lang.get(\"net_label\")\n\t\tlet periodText = model.isYearly() ? lang.get(\"pricing.perYear_label\") : lang.get(\"pricing.perMonth_label\")\n\n\t\tconst futurePriceNextPeriod = model.futurePrice\n\t\tlet currentPriceNextPeriod = model.currentPrice\n\n\t\tif (model.isSinglePriceType()) {\n\t\t\tconst priceDiff = futurePriceNextPeriod - currentPriceNextPeriod\n\t\t\treturn `${formatPrice(priceDiff, true)} ${periodText} (${netGrossText})`\n\t\t} else {\n\t\t\treturn `${formatPrice(futurePriceNextPeriod, true)} ${periodText} (${netGrossText})`\n\t\t}\n\t}\n\n\tprivate getPriceInfoText(model: PriceChangeModel): string {\n\t\tif (model.isUnbuy()) {\n\t\t\treturn lang.get(\"priceChangeValidFrom_label\", {\n\t\t\t\t\"{1}\": formatDate(model.periodEndDate()),\n\t\t\t})\n\t\t} else if (model.addedPriceForCurrentPeriod() > 0) {\n\t\t\treturn lang.get(\"priceForCurrentAccountingPeriod_label\", {\n\t\t\t\t\"{1}\": formatPrice(model.addedPriceForCurrentPeriod(), true),\n\t\t\t})\n\t\t} else {\n\t\t\treturn \"\"\n\t\t}\n\t}\n}\n\nclass PriceChangeModel {\n\treadonly currentItem: PriceItemData | null\n\treadonly futureItem: PriceItemData | null\n\treadonly currentPrice: number\n\treadonly futurePrice: number\n\treadonly additionalFeatures: ReadonlySet<BookingItemFeatureType>\n\n\tconstructor(private readonly price: PriceServiceReturn, readonly featureType: BookingItemFeatureType) {\n\t\tthis.currentItem = getPriceItem(price.currentPriceNextPeriod, featureType)\n\t\tthis.futureItem = getPriceItem(price.futurePriceNextPeriod, featureType)\n\t\tthis.currentPrice = this.getPriceFromPriceData(price.currentPriceNextPeriod, featureType)\n\t\tthis.futurePrice = this.getPriceFromPriceData(price.futurePriceNextPeriod, featureType)\n\n\t\tif (this.featureType === BookingItemFeatureType.LegacyUsers) {\n\t\t\tthis.additionalFeatures = new Set(\n\t\t\t\t[BookingItemFeatureType.Whitelabel, BookingItemFeatureType.Sharing, BookingItemFeatureType.Business].filter((f) => this.getFuturePrice(f) > 0),\n\t\t\t)\n\t\t} else {\n\t\t\tthis.additionalFeatures = new Set()\n\t\t}\n\t}\n\n\tgetActionLabel(): TranslationKey {\n\t\tif (!this.isPriceChange()) {\n\t\t\treturn \"accept_action\"\n\t\t}\n\t\tif (this.isBuy()) {\n\t\t\treturn \"buy_action\"\n\t\t}\n\t\treturn \"order_action\"\n\t}\n\n\tisBuy() {\n\t\treturn this.currentPrice < this.futurePrice\n\t}\n\n\tisUnbuy() {\n\t\treturn this.currentPrice > this.futurePrice\n\t}\n\n\tisPriceChange() {\n\t\treturn this.currentPrice !== this.futurePrice\n\t}\n\n\tisSinglePriceType() {\n\t\treturn this.anyItem().singleType\n\t}\n\n\tgetCurrentCount(): number {\n\t\treturn filterInt(assertNotNull(this.currentItem).count)\n\t}\n\n\tgetFutureCount(): number {\n\t\treturn filterInt(assertNotNull(this.futureItem).count)\n\t}\n\n\tisYearly(): boolean {\n\t\tconst period = assertNotNull(this.price.futurePriceNextPeriod ?? this.price.currentPriceNextPeriod)\n\t\treturn asPaymentInterval(period.paymentInterval) === PaymentInterval.Yearly\n\t}\n\n\ttaxIncluded(): boolean {\n\t\treturn assertNotNull(this.price.futurePriceNextPeriod).taxIncluded\n\t}\n\n\tperiodEndDate(): Date {\n\t\t// return a copy to prevent the date from being changed by the caller\n\t\treturn new Date(this.price.periodEndDate)\n\t}\n\n\taddedPriceForCurrentPeriod(): number {\n\t\treturn this.price.currentPeriodAddedPrice ? filterInt(this.price.currentPeriodAddedPrice) : 0\n\t}\n\n\tprivate anyItem() {\n\t\treturn assertNotNull(this.futureItem ?? this.currentItem)\n\t}\n\n\tprivate getFuturePrice(featureType: BookingItemFeatureType) {\n\t\treturn this.getPriceFromPriceData(this.price.futurePriceNextPeriod, featureType)\n\t}\n\n\t/**\n\t * Returns the price for the feature type from the price data if available, otherwise 0.\n\t */\n\tprivate getPriceFromPriceData(priceData: PriceData | null, featureType: NumberString): number {\n\t\tlet item = getPriceItem(priceData, featureType)\n\t\tlet itemPrice = item ? Number(item.price) : 0\n\n\t\tif (featureType === BookingItemFeatureType.LegacyUsers) {\n\t\t\titemPrice += this.getPriceFromPriceData(priceData, BookingItemFeatureType.Whitelabel)\n\t\t\titemPrice += this.getPriceFromPriceData(priceData, BookingItemFeatureType.Sharing)\n\t\t\titemPrice += this.getPriceFromPriceData(priceData, BookingItemFeatureType.Business)\n\t\t}\n\n\t\treturn itemPrice\n\t}\n}\n"]}