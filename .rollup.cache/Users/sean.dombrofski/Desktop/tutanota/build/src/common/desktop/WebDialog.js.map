{"version":3,"file":"WebDialog.js","sourceRoot":"","sources":["../../../../src/common/desktop/WebDialog.ts"],"names":[],"mappings":"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","sourcesContent":["import { app, BrowserWindow, WebContents } from \"electron\"\nimport path from \"node:path\"\nimport { defer } from \"@tutao/tutanota-utils\"\nimport { ElectronWebContentsTransport } from \"./ipc/ElectronWebContentsTransport.js\"\nimport { NativeToWebRequest, WebToNativeRequest } from \"../native/main/WebauthnNativeBridge.js\"\nimport { MessageDispatcher } from \"../api/common/threading/MessageDispatcher.js\"\nimport { exposeRemote } from \"../api/common/WorkerProxy.js\"\nimport { CancelledError } from \"../api/common/error/CancelledError.js\"\nimport { register } from \"./electron-localshortcut/LocalShortcut.js\"\nimport { ProgrammingError } from \"../api/common/error/ProgrammingError.js\"\n\nexport const webauthnIpcConfig = Object.freeze({\n\trenderToMainEvent: \"to-main-webdialog\",\n\tmainToRenderEvent: \"to-renderer-webdialog\",\n})\n\nexport type WebDialogIpcConfig = typeof webauthnIpcConfig\n\n/** A dialog which was already loaded. Allows sending one request or closing it. */\nexport class WebDialog<FacadeType extends object> {\n\tconstructor(private facade: FacadeType, private closedPromise: Promise<never>, private browserWindow: BrowserWindow) {}\n\n\tmakeRequest<T>(requestSender: (facade: FacadeType) => Promise<T>): Promise<T> {\n\t\treturn Promise.race([this.closedPromise, requestSender(this.facade)])\n\t\t\t.catch((e) => {\n\t\t\t\tconsole.log(\"web dialog error!\", e)\n\t\t\t\tthrow e\n\t\t\t})\n\t\t\t.finally(() => {\n\t\t\t\tthis.close()\n\t\t\t})\n\t}\n\n\tcancel() {\n\t\tthis.close()\n\t}\n\n\tprivate close() {\n\t\tif (!this.browserWindow.isDestroyed()) this.browserWindow.close()\n\t}\n}\n\n/**\n * a browserWindow wrapper that\n * * opens a specific website\n * * installs a nativeBrigde\n * * sends a request to the webContents\n * * returns the result of the call\n */\nexport class WebDialogController {\n\tasync create<FacadeType extends object>(parentWindowId: number, urlToOpen: URL): Promise<WebDialog<FacadeType>> {\n\t\tconst bw = await this.createBrowserWindow(parentWindowId)\n\t\t// Holding a separate reference on purpose. When BrowserWindow is destroyed and WebContents fire \"destroyed\" event, we can't get WebContents from\n\t\t// BrowserWindow anymore.\n\t\tconst { webContents } = bw\n\t\tconst closeDefer = defer<never>()\n\t\tbw.on(\"closed\", () => {\n\t\t\tconsole.log(\"web dialog window closed\")\n\t\t\tcloseDefer.reject(new CancelledError(\"Window closed\"))\n\t\t})\n\n\t\tregister(bw, \"F12\", () => {\n\t\t\twebContents.openDevTools()\n\t\t})\n\n\t\tbw.once(\"ready-to-show\", () => bw.show())\n\t\twebContents.on(\"did-fail-load\", () => closeDefer.reject(new Error(`Could not load web dialog at ${urlToOpen}`)))\n\n\t\t// Don't wait for the facade to init here, because that only happens after we call `bw.loadUrl`\n\t\t// But we need setup the listener beforehand in case the app in the webDialog loads too fast and we miss it\n\t\tconst facadePromise = this.initRemoteFacade<FacadeType>(bw.webContents)\n\t\tawait bw.loadURL(urlToOpen.toString())\n\n\t\t// We can confidently await here because we're sure that the bridge will be finished being setup in the webDialog\n\t\tconst facade = await facadePromise\n\t\treturn new WebDialog(facade, closeDefer.promise, bw)\n\t}\n\n\tprivate async createBrowserWindow(parentWindowId: number) {\n\t\tconst active = BrowserWindow.fromId(parentWindowId)\n\n\t\tconst window = new BrowserWindow({\n\t\t\tparent: active ?? undefined,\n\t\t\tmodal: true,\n\t\t\tskipTaskbar: true,\n\t\t\tresizable: false,\n\t\t\tmovable: false,\n\t\t\talwaysOnTop: true,\n\t\t\tfullscreenable: false,\n\t\t\troundedCorners: false,\n\t\t\tframe: false,\n\t\t\twidth: 400,\n\t\t\theight: 200,\n\t\t\tautoHideMenuBar: true,\n\t\t\tshow: false,\n\t\t\twebPreferences: {\n\t\t\t\tnodeIntegration: false,\n\t\t\t\tnodeIntegrationInWorker: false,\n\t\t\t\tnodeIntegrationInSubFrames: false,\n\t\t\t\tsandbox: true,\n\t\t\t\tcontextIsolation: true,\n\t\t\t\twebSecurity: true,\n\t\t\t\t// @ts-ignore see: https://github.com/electron/electron/issues/30789\n\t\t\t\tenableRemoteModule: false,\n\t\t\t\tallowRunningInsecureContent: false,\n\t\t\t\tpreload: path.join(app.getAppPath(), \"./desktop/preload-webdialog.js\"),\n\t\t\t\twebgl: false,\n\t\t\t\tplugins: false,\n\t\t\t\texperimentalFeatures: false,\n\t\t\t\twebviewTag: false,\n\t\t\t\tdisableDialogs: true,\n\t\t\t\tnavigateOnDragDrop: false,\n\t\t\t\tautoplayPolicy: \"user-gesture-required\",\n\t\t\t\tenableWebSQL: false,\n\t\t\t\tspellcheck: false,\n\t\t\t\tpartition: \"webdialog\",\n\t\t\t},\n\t\t})\n\t\tconst session = window.webContents.session\n\t\t// Intercepts all file:// requests and forbids them\n\t\tif (!session.protocol.isProtocolIntercepted(\"file\")) {\n\t\t\tconst intercepting = session.protocol.interceptFileProtocol(\"file\", (request, cb) => {\n\t\t\t\tcb({ statusCode: 403 })\n\t\t\t})\n\t\t\tif (!intercepting) {\n\t\t\t\tthrow new ProgrammingError(\"Cannot intercept file: protocol for WebDialog!\")\n\t\t\t}\n\t\t}\n\n\t\treturn window\n\t}\n\n\t/**\n\t * initialize the facade impl that's displayed in the webContents\n\t */\n\tprivate async initRemoteFacade<FacadeType>(webContents: WebContents): Promise<FacadeType> {\n\t\tconst deferred = defer<void>()\n\t\tconst transport = new ElectronWebContentsTransport<WebDialogIpcConfig, \"facade\", \"init\">(webContents, webauthnIpcConfig)\n\t\tconst dispatcher = new MessageDispatcher<NativeToWebRequest, WebToNativeRequest>(\n\t\t\ttransport,\n\t\t\t{\n\t\t\t\tinit: () => {\n\t\t\t\t\tdeferred.resolve()\n\t\t\t\t\treturn Promise.resolve()\n\t\t\t\t},\n\t\t\t},\n\t\t\t\"node-webauthn\",\n\t\t)\n\t\tconst facade = exposeRemote<FacadeType>((req) => dispatcher.postRequest(req))\n\t\tawait deferred.promise\n\t\treturn facade\n\t}\n}\n"]}