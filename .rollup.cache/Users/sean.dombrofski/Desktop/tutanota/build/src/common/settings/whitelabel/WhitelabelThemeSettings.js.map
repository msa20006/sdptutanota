{"version":3,"file":"WhitelabelThemeSettings.js","sourceRoot":"","sources":["../../../../../src/common/settings/whitelabel/WhitelabelThemeSettings.ts"],"names":[],"mappings":"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","sourcesContent":["import { lang } from \"../../misc/LanguageViewModel\"\nimport { Dialog } from \"../../gui/base/Dialog\"\nimport { assertNotNull, contains, downcast, uint8ArrayToBase64, utf8Uint8ArrayToString } from \"@tutao/tutanota-utils\"\nimport { Icons } from \"../../gui/base/icons/Icons.js\"\nimport { ALLOWED_IMAGE_FORMATS, MAX_LOGO_SIZE } from \"../../../common/api/common/TutanotaConstants\"\nimport m, { Children, Component, Vnode } from \"mithril\"\nimport { TextField, TextFieldAttrs } from \"../../gui/base/TextField.js\"\nimport * as EditCustomColorsDialog from \"./EditCustomColorsDialog\"\nimport { CustomColorsEditorViewModel } from \"./CustomColorsEditorViewModel\"\nimport type { DomainInfo, WhitelabelConfig } from \"../../../common/api/entities/sys/TypeRefs.js\"\nimport type { ThemeCustomizations } from \"../../misc/WhitelabelCustomizations.js\"\nimport { locator } from \"../../api/main/CommonLocator.js\"\nimport { showFileChooser } from \"../../file/FileController.js\"\nimport { IconButton } from \"../../gui/base/IconButton.js\"\nimport { ButtonSize } from \"../../gui/base/ButtonSize.js\"\n\nexport type WhitelabelData = {\n\tcustomTheme: ThemeCustomizations\n\twhitelabelConfig: WhitelabelConfig\n\twhitelabelDomainInfo: DomainInfo\n}\nexport type WhitelabelThemeSettingsAttrs = {\n\twhitelabelData: null | WhitelabelData\n}\n\nexport class WhitelabelThemeSettings implements Component<WhitelabelThemeSettingsAttrs> {\n\tview(vnode: Vnode<WhitelabelThemeSettingsAttrs>): Children {\n\t\tconst { whitelabelData } = vnode.attrs\n\t\treturn [this.renderCustomColorsField(whitelabelData), this.renderCustomLogoField(whitelabelData)]\n\t}\n\n\tprivate renderCustomColorsField(data: WhitelabelData | null): Children {\n\t\treturn m(TextField, {\n\t\t\tlabel: \"customColors_label\",\n\t\t\tvalue: this.areCustomColorsDefined(data?.customTheme ?? null) ? lang.get(\"activated_label\") : lang.get(\"deactivated_label\"),\n\t\t\tisReadOnly: true,\n\t\t\tinjectionsRight: () => (data ? this.renderCustomColorsFieldButtons(data) : null),\n\t\t})\n\t}\n\n\tprivate renderCustomColorsFieldButtons(whitelabelData: WhitelabelData): Children {\n\t\treturn [\n\t\t\tthis.areCustomColorsDefined(whitelabelData.customTheme)\n\t\t\t\t? m(IconButton, {\n\t\t\t\t\t\ttitle: \"deactivate_action\",\n\t\t\t\t\t\tclick: () => this.deactivateCustomColors(whitelabelData),\n\t\t\t\t\t\ticon: Icons.Cancel,\n\t\t\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\t  })\n\t\t\t\t: null,\n\t\t\tm(IconButton, {\n\t\t\t\ttitle: \"edit_action\",\n\t\t\t\tclick: () => this.showCustomColorsDialog(whitelabelData),\n\t\t\t\ticon: Icons.Edit,\n\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t}),\n\t\t]\n\t}\n\n\tprivate async deactivateCustomColors({ customTheme, whitelabelConfig, whitelabelDomainInfo }: WhitelabelData) {\n\t\tconst confirmed = await Dialog.confirm(\"confirmDeactivateCustomColors_msg\")\n\n\t\tif (confirmed) {\n\t\t\tfor (const key of Object.keys(customTheme)) {\n\t\t\t\tif (key !== \"logo\") {\n\t\t\t\t\tdelete downcast(customTheme)[key]\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis.saveCustomTheme(customTheme, whitelabelConfig, whitelabelDomainInfo)\n\n\t\t\tif (locator.logins.isWhitelabel()) {\n\t\t\t\tawait locator.themeController.applyCustomizations(customTheme)\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate renderCustomLogoField(data: WhitelabelData | null): Children {\n\t\tconst customLogoTextfieldAttrs: TextFieldAttrs = {\n\t\t\tlabel: \"customLogo_label\",\n\t\t\thelpLabel: () => lang.get(\"customLogoInfo_msg\"),\n\t\t\tvalue: lang.get(data?.customTheme.logo != null ? \"activated_label\" : \"deactivated_label\"),\n\t\t\tisReadOnly: true,\n\t\t\tinjectionsRight: () => (data ? this.renderCustomLogoFieldButtons(data) : null),\n\t\t}\n\t\treturn m(TextField, customLogoTextfieldAttrs)\n\t}\n\n\tprivate renderCustomLogoFieldButtons(whitelabelData: WhitelabelData): Children {\n\t\treturn [\n\t\t\twhitelabelData.customTheme.logo\n\t\t\t\t? m(IconButton, {\n\t\t\t\t\t\ttitle: \"deactivate_action\",\n\t\t\t\t\t\tclick: async () => {\n\t\t\t\t\t\t\tawait this.deactivateCustomLogo(whitelabelData)\n\t\t\t\t\t\t},\n\t\t\t\t\t\ticon: Icons.Cancel,\n\t\t\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\t  })\n\t\t\t\t: null,\n\t\t\tm(IconButton, {\n\t\t\t\ttitle: \"edit_action\",\n\t\t\t\tclick: () => this.editCustomLogo(whitelabelData),\n\t\t\t\ticon: Icons.Edit,\n\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t}),\n\t\t]\n\t}\n\n\tprivate async editCustomLogo({ customTheme, whitelabelConfig, whitelabelDomainInfo }: WhitelabelData) {\n\t\tconst files = await showFileChooser(false)\n\t\tlet extension = files[0].name.toLowerCase().substring(files[0].name.lastIndexOf(\".\") + 1)\n\n\t\tif (files[0].size > MAX_LOGO_SIZE || !contains(ALLOWED_IMAGE_FORMATS, extension)) {\n\t\t\tDialog.message(\"customLogoInfo_msg\")\n\t\t} else {\n\t\t\tlet imageData: string\n\n\t\t\tif (extension === \"svg\") {\n\t\t\t\timageData = utf8Uint8ArrayToString(files[0].data)\n\t\t\t} else {\n\t\t\t\tconst ext = extension === \"jpeg\" ? \"jpg\" : extension\n\t\t\t\tconst b64 = uint8ArrayToBase64(files[0].data)\n\t\t\t\timageData = `<img src=\"data:image/${ext};base64,${b64}\">`\n\t\t\t}\n\n\t\t\tcustomTheme.logo = imageData\n\t\t\tthis.saveCustomTheme(customTheme, whitelabelConfig, whitelabelDomainInfo)\n\n\t\t\tif (locator.logins.isWhitelabel()) {\n\t\t\t\tawait locator.themeController.applyCustomizations(customTheme)\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async deactivateCustomLogo({ customTheme, whitelabelConfig, whitelabelDomainInfo }: WhitelabelData) {\n\t\tconst confirmed = await Dialog.confirm(\"confirmDeactivateCustomLogo_msg\")\n\n\t\tif (confirmed) {\n\t\t\tdelete customTheme.logo\n\t\t\tthis.saveCustomTheme(customTheme, whitelabelConfig, whitelabelDomainInfo)\n\n\t\t\tif (locator.logins.isWhitelabel()) {\n\t\t\t\tawait locator.themeController.applyCustomizations(customTheme)\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async showCustomColorsDialog({ customTheme, whitelabelConfig, whitelabelDomainInfo }: WhitelabelData) {\n\t\tconst currentTheme = locator.themeController.getCurrentTheme()\n\t\tconst viewModel = new CustomColorsEditorViewModel(\n\t\t\tcurrentTheme,\n\t\t\tcustomTheme,\n\t\t\twhitelabelConfig,\n\t\t\tassertNotNull(whitelabelDomainInfo),\n\t\t\tlocator.themeController,\n\t\t\tlocator.entityClient,\n\t\t\tlocator.logins,\n\t\t)\n\t\tEditCustomColorsDialog.show(viewModel)\n\t}\n\n\tprivate areCustomColorsDefined(theme: ThemeCustomizations | null): boolean {\n\t\tif (theme) {\n\t\t\treturn Object.keys(theme).some(\n\t\t\t\t(key) =>\n\t\t\t\t\tkey !== \"logo\" &&\n\t\t\t\t\t// @ts-ignore\n\t\t\t\t\ttheme?.[key],\n\t\t\t)\n\t\t} else {\n\t\t\treturn false\n\t\t}\n\t}\n\n\tprivate saveCustomTheme(customTheme: ThemeCustomizations, whitelabelConfig: WhitelabelConfig, whitelabelDomainInfo: DomainInfo) {\n\t\twhitelabelConfig.jsonTheme = JSON.stringify(customTheme)\n\t\tlocator.entityClient.update(whitelabelConfig)\n\t\tcustomTheme.themeId = whitelabelDomainInfo.domain\n\t}\n}\n"]}