{"version":3,"file":"SearchInPageOverlay.js","sourceRoot":"","sources":["../../../../src/common/gui/SearchInPageOverlay.ts"],"names":[],"mappings":"AAAA,OAAO,CAA0B,MAAM,SAAS,CAAA;AAEhD,OAAO,EAAE,cAAc,EAAE,MAAM,gBAAgB,CAAA;AAC/C,OAAO,EAAE,EAAE,EAAE,IAAI,EAAE,MAAM,QAAQ,CAAA;AAEjC,OAAO,EAAE,gBAAgB,EAAE,MAAM,mBAAmB,CAAA;AACpD,OAAO,EAAE,IAAI,EAAE,MAAM,2BAA2B,CAAA;AAEhD,OAAO,EAAE,IAAI,EAAE,MAAM,iCAAiC,CAAA;AACtD,OAAO,EAAE,OAAO,EAAE,MAAM,2BAA2B,CAAA;AAEnD,OAAO,EAAE,YAAY,EAAE,MAAM,uBAAuB,CAAA;AACpD,OAAO,EAAE,UAAU,EAAE,MAAM,sBAAsB,CAAA;AACjD,OAAO,EAAE,YAAY,EAAE,MAAM,gCAAgC,CAAA;AAC7D,OAAO,EAAE,MAAM,EAAE,MAAM,aAAa,CAAA;AACpC,OAAO,EAAE,sBAAsB,EAAE,MAAM,gBAAgB,CAAA;AAEvD,gBAAgB,EAAE,CAAA;AAElB;;;GAGG;AACH,MAAM,OAAO,mBAAmB;IACvB,aAAa,CAAqB;IAClC,QAAQ,CAAmB;IAC3B,SAAS,GAAY,KAAK,CAAA;IAC1B,eAAe,GAAW,CAAC,CAAA;IAC3B,YAAY,GAAW,CAAC,CAAA;IACxB,YAAY,GAAY,KAAK,CAAA;IAErC;QACC,IAAI,CAAC,aAAa,GAAG,IAAI,CAAA;IAC1B,CAAC;IAED,IAAI;QACH,IAAI,OAAO,CAAC,MAAM,CAAC,cAAc,EAAE,EAAE,CAAC;YACrC,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC;gBACzB,IAAI,CAAC,aAAa,GAAG,cAAc,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,OAAO,EAAE,EAAE,IAAI,CAAC,YAAY,EAAE,EAAE,cAAc,CAAC,CAAA;YAC/F,CAAC;iBAAM,CAAC;gBACP,uBAAuB;gBACvB,OAAO,CAAC,GAAG,CAAC,YAAY,CAAC,CAAA;gBAEzB,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAA;gBAErB,IAAI,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAA;YACvB,CAAC;YAED,CAAC,CAAC,MAAM,EAAE,CAAA;QACX,CAAC;IACF,CAAC;IAED,KAAK;QACJ,IAAI,IAAI,CAAC,aAAa,EAAE,CAAC;YACxB,IAAI,CAAC,aAAa,EAAE,CAAA;YACpB,OAAO,CAAC,gBAAgB,CAAC,cAAc,EAAE,CAAA;YACzC,IAAI,CAAC,aAAa,GAAG,IAAI,CAAA;QAC1B,CAAC;QAED,CAAC,CAAC,MAAM,EAAE,CAAA;IACX,CAAC;IAEO,OAAO;QACd,MAAM,eAAe,GAAG,IAAI,CAAC,cAAc,GAAG,sBAAsB,EAAE,CAAA;QACtE,OAAO;YACN,MAAM,EAAE,EAAE,CAAC,IAAI,CAAC,oBAAoB,CAAC;YACrC,wDAAwD;YACxD,MAAM,EAAE,EAAE,CAAC,MAAM,CAAC,uBAAuB,EAAE,CAAC,CAAC,CAAC,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC,CAAC;YACnE,KAAK,EAAE,EAAE,CAAC,CAAC,CAAC;YACZ,IAAI,EAAE,EAAE,CAAC,CAAC,CAAC;SACX,CAAA;IACF,CAAC;IAEO,UAAU,GAAmB,GAAG,EAAE;QACzC,OAAO,CAAC,CACP,qFAAqF,EACrF;YACC,WAAW,EAAE,IAAI,CAAC,GAAG,CAAC,mBAAmB,CAAC;YAC1C,QAAQ,EAAE,CAAC,KAAK,EAAE,EAAE;gBACnB,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC,GAAuB,CAAA;gBAE7C,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAA;YACtB,CAAC;YACD,MAAM,EAAE,GAAG,EAAE;gBACZ,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;oBACvB,IAAI,CAAC,YAAY,GAAG,KAAK,CAAA;oBAEzB,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAA;gBACtB,CAAC;qBAAM,CAAC;oBACP,OAAO,CAAC,gBAAgB,CAAC,qBAAqB,CAAC,KAAK,EAAE,KAAK,CAAC,CAAA;gBAC7D,CAAC;YACF,CAAC;YACD,OAAO,EAAE,GAAG,EAAE,CAAC,OAAO,CAAC,gBAAgB,CAAC,qBAAqB,CAAC,IAAI,EAAE,KAAK,CAAC;YAC1E,OAAO,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC;YACpC,KAAK,EAAE;gBACN,KAAK,EAAE,EAAE,CAAC,GAAG,CAAC;gBACd,GAAG,EAAE,CAAC;gBACN,MAAM,EAAE,EAAE,CAAC,IAAI,CAAC,aAAa,CAAC;gBAC9B,IAAI,EAAE,CAAC;aACP;SACD,EACD,EAAE,CACF,CAAA;IACF,CAAC,CAAA;IACO,IAAI,GAA2D,KAAK,EAAE,OAAO,EAAE,QAAQ,EAAE,EAAE;QAClG,IAAI,CAAC,YAAY,GAAG,IAAI,CAAA;QACxB,MAAM,CAAC,GAAG,MAAM,OAAO,CAAC,gBAAgB,CAAC,UAAU,CAAC,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,OAAO,EAAE,IAAI,CAAC,SAAS,EAAE,QAAQ,CAAC,CAAA;QAC3G,IAAI,CAAC,eAAe,CAAC,CAAC,CAAC,CAAA;IACxB,CAAC,CAAA;IAED,eAAe,CAAC,MAA6B;QAC5C,IAAI,MAAM,IAAI,IAAI,EAAE,CAAC;YACpB,IAAI,CAAC,eAAe,GAAG,CAAC,CAAA;YACxB,IAAI,CAAC,YAAY,GAAG,CAAC,CAAA;QACtB,CAAC;aAAM,CAAC;YACP,MAAM,EAAE,kBAAkB,EAAE,OAAO,EAAE,GAAG,MAAM,CAAA;YAE9C,IAAI,OAAO,KAAK,CAAC,EAAE,CAAC;gBACnB;;0CAE0B;gBAC1B,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE,CAAA;gBAEpB,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE,CAAA;YACtB,CAAC;YAED,IAAI,CAAC,eAAe,GAAG,OAAO,GAAG,CAAC,CAAA;YAClC,IAAI,CAAC,YAAY,GAAG,kBAAkB,GAAG,CAAC,CAAA;QAC3C,CAAC;QAED,CAAC,CAAC,MAAM,EAAE,CAAA;IACX,CAAC;IAED,YAAY;QACX,MAAM,aAAa,GAAG,CAAC,KAAiB,EAAE,EAAE,CAAC,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAA;QAEtE,OAAO;YACN,IAAI,EAAE,CAAC,CAAC,EAAE,EAAE;gBACX,OAAO,CAAC,CACP,0BAA0B,EAC1B;oBACC,QAAQ,EAAE,GAAG,EAAE,CAAC,MAAM,CAAC,gBAAgB,CAAC,SAAS,EAAE,aAAa,CAAC;oBACjE,QAAQ,EAAE,GAAG,EAAE,CAAC,MAAM,CAAC,mBAAmB,CAAC,SAAS,EAAE,aAAa,CAAC;iBACpE,EACD;oBACC,CAAC,CACA,+BAA+B,EAC/B;wBACC,SAAS,EAAE,CAAC,CAAgB,EAAE,EAAE;4BAC/B,IAAI,YAAY,CAAC,CAAC,CAAC,GAAG,EAAE,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC;gCACnC,IAAI,CAAC,KAAK,EAAE,CAAA;4BACb,CAAC;4BAED,uDAAuD;4BACvD,CAAC,CAAC,eAAe,EAAE,CAAA;4BACnB,OAAO,IAAI,CAAA;wBACZ,CAAC;qBACD,EACD;wBACC,IAAI,CAAC,UAAU,EAAE;wBACjB,CAAC,CAAC,UAAU,EAAE;4BACb,KAAK,EAAE,iBAAiB;4BACxB,IAAI,2CAAqB;4BACzB,KAAK,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC;yBACnC,CAAC;wBACF,CAAC,CAAC,UAAU,EAAE;4BACb,KAAK,EAAE,aAAa;4BACpB,IAAI,yCAAoB;4BACxB,KAAK,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,IAAI,CAAC;yBAClC,CAAC;wBACF,CAAC,CAAC,YAAY,EAAE;4BACf,KAAK,EAAE,eAAe;4BACtB,IAAI,mCAAiB;4BACrB,OAAO,EAAE,IAAI,CAAC,SAAS;4BACvB,SAAS,EAAE,GAAG,EAAE;gCACf,IAAI,CAAC,SAAS,GAAG,CAAC,IAAI,CAAC,SAAS,CAAA;gCAEhC,IAAI,CAAC,IAAI,CAAC,IAAI,EAAE,KAAK,CAAC,CAAA;4BACvB,CAAC;yBACD,CAAC;wBACF,CAAC,CAAC,UAAU,EAAE,IAAI,CAAC,eAAe,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,YAAY,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,qBAAqB,CAAC,CAAC;qBAC1H,CACD;oBACD,CAAC,CAAC,UAAU,EAAE;wBACb,KAAK,EAAE,WAAW;wBAClB,IAAI,6BAAc;wBAClB,KAAK,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,KAAK,EAAE;qBACzB,CAAC;iBACF,CACD,CAAA;YACF,CAAC;SACD,CAAA;IACF,CAAC;IAED;;;;;;;OAOG;IACH,aAAa,CAAC,CAAQ;QACrB,IAAI,CAAC,CAAC,CAAC,CAAC,MAAM,YAAY,OAAO,IAAI,CAAC,CAAC,MAAM,CAAC,EAAE,KAAK,sBAAsB,CAAC;YAAE,OAAM;QACpF,OAAO,CAAC,gBAAgB,CAAC,qBAAqB,CAAC,KAAK,EAAE,IAAI,CAAC,CAAA;IAC5D,CAAC;CACD;AAED,MAAM,CAAC,MAAM,mBAAmB,GAAwB,IAAI,mBAAmB,EAAE,CAAA","sourcesContent":["import m, { Children, Component } from \"mithril\"\nimport type { PositionRect } from \"./base/Overlay\"\nimport { displayOverlay } from \"./base/Overlay\"\nimport { px, size } from \"./size\"\nimport { Icons } from \"./base/icons/Icons\"\nimport { assertMainOrNode } from \"../api/common/Env\"\nimport { lang } from \"../misc/LanguageViewModel\"\nimport { transform, TransformEnum } from \"./animation/Animations\"\nimport { Keys } from \"../api/common/TutanotaConstants\"\nimport { locator } from \"../api/main/CommonLocator\"\nimport { ElectronResult } from \"../native/common/generatedipc/ElectronResult.js\"\nimport { isKeyPressed } from \"../misc/KeyManager.js\"\nimport { IconButton } from \"./base/IconButton.js\"\nimport { ToggleButton } from \"./base/buttons/ToggleButton.js\"\nimport { styles } from \"./styles.js\"\nimport { getSafeAreaInsetBottom } from \"./HtmlUtils.js\"\n\nassertMainOrNode()\n\n/**\n * search bar for the Ctrl+F in-page search of the Desktop client\n * gets loaded asynchronously, shouldn't be in the web bundle\n */\nexport class SearchInPageOverlay {\n\tprivate closeFunction: (() => void) | null\n\tprivate domInput!: HTMLInputElement\n\tprivate matchCase: boolean = false\n\tprivate numberOfMatches: number = 0\n\tprivate currentMatch: number = 0\n\tprivate skipNextBlur: boolean = false\n\n\tconstructor() {\n\t\tthis.closeFunction = null\n\t}\n\n\topen() {\n\t\tif (locator.logins.isUserLoggedIn()) {\n\t\t\tif (!this.closeFunction) {\n\t\t\t\tthis.closeFunction = displayOverlay(() => this.getRect(), this.getComponent(), \"slide-bottom\")\n\t\t\t} else {\n\t\t\t\t//already open, refocus\n\t\t\t\tconsole.log(\"refocusing\")\n\n\t\t\t\tthis.domInput.focus()\n\n\t\t\t\tthis.domInput.select()\n\t\t\t}\n\n\t\t\tm.redraw()\n\t\t}\n\t}\n\n\tclose() {\n\t\tif (this.closeFunction) {\n\t\t\tthis.closeFunction()\n\t\t\tlocator.searchTextFacade.stopFindInPage()\n\t\t\tthis.closeFunction = null\n\t\t}\n\n\t\tm.redraw()\n\t}\n\n\tprivate getRect(): PositionRect {\n\t\tconst bottomNavHeight = size.bottom_nav_bar + getSafeAreaInsetBottom()\n\t\treturn {\n\t\t\theight: px(size.navbar_height_mobile),\n\t\t\t// Place the search overlay on top of the bottom nav bar\n\t\t\tbottom: px(styles.isUsingBottomNavigation() ? -bottomNavHeight : 0),\n\t\t\tright: px(0),\n\t\t\tleft: px(0),\n\t\t}\n\t}\n\n\tprivate inputField: () => Children = () => {\n\t\treturn m(\n\t\t\t\"input#search-overlay-input.dropdown-bar.elevated-bg.pl-l.button-height.inputWrapper\",\n\t\t\t{\n\t\t\t\tplaceholder: lang.get(\"searchPage_action\"),\n\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\tthis.domInput = vnode.dom as HTMLInputElement\n\n\t\t\t\t\tthis.domInput.focus()\n\t\t\t\t},\n\t\t\t\tonblur: () => {\n\t\t\t\t\tif (this.skipNextBlur) {\n\t\t\t\t\t\tthis.skipNextBlur = false\n\n\t\t\t\t\t\tthis.domInput.focus()\n\t\t\t\t\t} else {\n\t\t\t\t\t\tlocator.searchTextFacade.setSearchOverlayState(false, false)\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tonfocus: () => locator.searchTextFacade.setSearchOverlayState(true, false),\n\t\t\t\toninput: () => this.find(true, true),\n\t\t\t\tstyle: {\n\t\t\t\t\twidth: px(250),\n\t\t\t\t\ttop: 0,\n\t\t\t\t\theight: px(size.button_height),\n\t\t\t\t\tleft: 0,\n\t\t\t\t},\n\t\t\t},\n\t\t\t\"\",\n\t\t)\n\t}\n\tprivate find: (forward: boolean, findNext: boolean) => Promise<void> = async (forward, findNext) => {\n\t\tthis.skipNextBlur = true\n\t\tconst r = await locator.searchTextFacade.findInPage(this.domInput.value, forward, this.matchCase, findNext)\n\t\tthis.applyNextResult(r)\n\t}\n\n\tapplyNextResult(result: ElectronResult | null): void {\n\t\tif (result == null) {\n\t\t\tthis.numberOfMatches = 0\n\t\t\tthis.currentMatch = 0\n\t\t} else {\n\t\t\tconst { activeMatchOrdinal, matches } = result\n\n\t\t\tif (matches === 1) {\n\t\t\t\t/* the search bar loses focus without any events when there\n\t\t\t\t *  are no results except for the search bar itself. this enables\n\t\t\t\t *  us to retain focus. */\n\t\t\t\tthis.domInput.blur()\n\n\t\t\t\tthis.domInput.focus()\n\t\t\t}\n\n\t\t\tthis.numberOfMatches = matches - 1\n\t\t\tthis.currentMatch = activeMatchOrdinal - 1\n\t\t}\n\n\t\tm.redraw()\n\t}\n\n\tgetComponent(): Component {\n\t\tconst handleMouseUp = (event: MouseEvent) => this.handleMouseUp(event)\n\n\t\treturn {\n\t\t\tview: (_) => {\n\t\t\t\treturn m(\n\t\t\t\t\t\".flex.flex-space-between\",\n\t\t\t\t\t{\n\t\t\t\t\t\toncreate: () => window.addEventListener(\"mouseup\", handleMouseUp),\n\t\t\t\t\t\tonremove: () => window.removeEventListener(\"mouseup\", handleMouseUp),\n\t\t\t\t\t},\n\t\t\t\t\t[\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\".flex-start.center-vertically\",\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tonkeydown: (e: KeyboardEvent) => {\n\t\t\t\t\t\t\t\t\tif (isKeyPressed(e.key, Keys.ESC)) {\n\t\t\t\t\t\t\t\t\t\tthis.close()\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t// prevent key from getting picked up by shortcuts etc.\n\t\t\t\t\t\t\t\t\te.stopPropagation()\n\t\t\t\t\t\t\t\t\treturn true\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t[\n\t\t\t\t\t\t\t\tthis.inputField(),\n\t\t\t\t\t\t\t\tm(IconButton, {\n\t\t\t\t\t\t\t\t\ttitle: \"previous_action\",\n\t\t\t\t\t\t\t\t\ticon: Icons.ArrowBackward,\n\t\t\t\t\t\t\t\t\tclick: () => this.find(false, true),\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\tm(IconButton, {\n\t\t\t\t\t\t\t\t\ttitle: \"next_action\",\n\t\t\t\t\t\t\t\t\ticon: Icons.ArrowForward,\n\t\t\t\t\t\t\t\t\tclick: () => this.find(true, true),\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\tm(ToggleButton, {\n\t\t\t\t\t\t\t\t\ttitle: \"matchCase_alt\",\n\t\t\t\t\t\t\t\t\ticon: Icons.MatchCase,\n\t\t\t\t\t\t\t\t\ttoggled: this.matchCase,\n\t\t\t\t\t\t\t\t\tonToggled: () => {\n\t\t\t\t\t\t\t\t\t\tthis.matchCase = !this.matchCase\n\n\t\t\t\t\t\t\t\t\t\tthis.find(true, false)\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\tm(\"div.pl-m\", this.numberOfMatches > 0 ? `${this.currentMatch}/${this.numberOfMatches}` : lang.get(\"searchNoResults_msg\")),\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t),\n\t\t\t\t\t\tm(IconButton, {\n\t\t\t\t\t\t\ttitle: \"close_alt\",\n\t\t\t\t\t\t\ticon: Icons.Cancel,\n\t\t\t\t\t\t\tclick: () => this.close(),\n\t\t\t\t\t\t}),\n\t\t\t\t\t],\n\t\t\t\t)\n\t\t\t},\n\t\t}\n\t}\n\n\t/*\n\t * we're catching enter key events on the main thread while the search overlay is open to enable\n\t * next-result-via-enter behaviour.\n\t *\n\t * since losing focus on the overlay via issuing a search request seems to be indistinguishable\n\t * from losing it via click/tab we need to check if anything else was clicked and tell the main thread to\n\t * not search the next result for enter key events (otherwise we couldn't type newlines while the overlay is open)\n\t */\n\thandleMouseUp(e: Event) {\n\t\tif (!(e.target instanceof Element && e.target.id !== \"search-overlay-input\")) return\n\t\tlocator.searchTextFacade.setSearchOverlayState(false, true)\n\t}\n}\n\nexport const searchInPageOverlay: SearchInPageOverlay = new SearchInPageOverlay()\n"]}