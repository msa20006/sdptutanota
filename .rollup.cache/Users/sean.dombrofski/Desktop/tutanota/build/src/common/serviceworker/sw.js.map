{"version":3,"file":"sw.js","sourceRoot":"","sources":["../../../../src/common/serviceworker/sw.ts"],"names":[],"mappings":"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","sourcesContent":["// set by the build script\nimport { getPathBases } from \"../../mail-app/ApplicationPaths.js\"\n\n// eslint-disable-next-line no-var\ndeclare var filesToCache: () => Array<string>\n// eslint-disable-next-line no-var\ndeclare var version: () => string\n// eslint-disable-next-line no-var\ndeclare var customDomainCacheExclusions: () => Array<string>\n\n// test case\nconst versionString = typeof version === \"undefined\" ? \"test\" : version()\n\n// The client prior or equal to this build date have incomplete service worker caches (missing liboqs.wasm and argon2.wasm)\n// We want to enforce service worker updates for them.\nconst LAST_INCOMPLETE_CACHE_DATE = 250206\n\n// either tuta.com or tutanota.com without or with a subdomain or a domain without dots (e.g. localhost).\n// otherwise it is a custom domain\nconst isTutanotaDomain = () => {\n\tconst hostname = self.location.hostname\n\treturn (\n\t\thostname === \"tutanota.com\" ||\n\t\thostname === \"tuta.com\" ||\n\t\thostname.endsWith(\".tutanota.com\") ||\n\t\thostname.endsWith(\".tuta.com\") ||\n\t\thostname.indexOf(\".\") === -1\n\t)\n}\n\nconst urlWithoutQuery = (urlString: string) => {\n\tconst queryIndex = urlString.indexOf(\"?\")\n\treturn queryIndex !== -1 ? urlString.substring(0, queryIndex) : urlString\n}\n\nexport class ServiceWorker {\n\t_caches: CacheStorage\n\t_cacheName: string\n\t_selfLocation: string\n\t_possibleRest: string\n\t_applicationPaths: string[]\n\t_isTutanotaDomain: boolean\n\t_urlsToCache: string[]\n\t_isBuggyChrome: boolean\n\n\tconstructor(urlsToCache: string[], caches: CacheStorage, cacheName: string, selfLocation: string, applicationPaths: string[], isTutanotaDomain: boolean) {\n\t\tthis._urlsToCache = urlsToCache\n\t\tthis._caches = caches\n\t\tthis._cacheName = cacheName\n\t\tthis._selfLocation = selfLocation\n\t\tthis._possibleRest = selfLocation + \"rest\"\n\t\tthis._applicationPaths = applicationPaths\n\t\tthis._isTutanotaDomain = isTutanotaDomain\n\t\tthis._isBuggyChrome = false\n\n\t\tif (typeof navigator !== \"undefined\") {\n\t\t\tconst results = navigator.userAgent.match(/Chrome\\/([0-9]*)\\./)\n\n\t\t\tif (results != null && results.length > 0) {\n\t\t\t\tconst numberVersion = Number(results[1])\n\n\t\t\t\tif (!isNaN(numberVersion) && numberVersion < 50) {\n\t\t\t\t\t// Chrome 44-49 has weird bug where ByteStreams from cache are not interpreted correctly\n\t\t\t\t\tconsole.log(\"Buggy Chrome version detected. Deferring to no-op sw.js\")\n\t\t\t\t\tthis._isBuggyChrome = true\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\trespond(evt: FetchEvent): void {\n\t\tif (this._isBuggyChrome) {\n\t\t\t// Defer to default browser behavior\n\t\t\treturn\n\t\t}\n\n\t\tconst urlWithoutParams = urlWithoutQuery(evt.request.url)\n\n\t\tif (this._urlsToCache.indexOf(urlWithoutParams) !== -1 || (this._isTutanotaDomain && this._selfLocation === urlWithoutParams)) {\n\t\t\tevt.respondWith(this._fromCache(urlWithoutParams))\n\t\t} else if (/translation-.+-.+\\.js/.test(urlWithoutParams)) {\n\t\t\tevt.respondWith(this.fromCacheOrFetchAndCache(evt.request))\n\t\t} else if (this._shouldRedirectToDefaultPage(urlWithoutParams)) {\n\t\t\tevt.respondWith(this._redirectToDefaultPage(evt.request.url))\n\t\t}\n\t}\n\n\tprecache(): Promise<any> {\n\t\treturn this._caches.open(this._cacheName).then((cache) =>\n\t\t\tthis._addAllToCache(cache, this._urlsToCache)\n\t\t\t\t.then(() => cache.match(\"index.html\"))\n\t\t\t\t.then((r: Response) => {\n\t\t\t\t\tif (!r) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\n\t\t\t\t\t// Reconstructing response to 1. Save it under different url 2. Get rid of redirect in response<<\n\t\t\t\t\tconst clonedResponse: Response = r.clone()\n\t\t\t\t\tconst bodyPromise = clonedResponse.body != null ? Promise.resolve(clonedResponse.body) : clonedResponse.blob()\n\t\t\t\t\treturn bodyPromise\n\t\t\t\t\t\t.then(\n\t\t\t\t\t\t\t(body: ReadableStream | Blob) =>\n\t\t\t\t\t\t\t\tnew Response(body, {\n\t\t\t\t\t\t\t\t\theaders: clonedResponse.headers,\n\t\t\t\t\t\t\t\t\tstatus: clonedResponse.status,\n\t\t\t\t\t\t\t\t\tstatusText: clonedResponse.statusText,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t)\n\t\t\t\t\t\t.then((r: Response) => cache.put(this._selfLocation, r))\n\t\t\t\t\t\t.then(() => cache.delete(\"index.html\"))\n\t\t\t\t}),\n\t\t)\n\t}\n\n\tdeleteOldCaches(): Promise<any> {\n\t\treturn this._caches\n\t\t\t.keys()\n\t\t\t.then((cacheNames) => Promise.all(cacheNames.map((cacheName) => (cacheName !== this._cacheName ? caches.delete(cacheName) : Promise.resolve()))))\n\t\t\t.catch((e) => {\n\t\t\t\tconsole.log(\"error while deleting old caches\", e)\n\t\t\t\tthrow e\n\t\t\t})\n\t}\n\n\tfromCacheOrFetchAndCache(request: Request): Promise<Response> {\n\t\treturn this._caches.open(this._cacheName).then((cache) => {\n\t\t\treturn cache.match(request.url).then((response) => {\n\t\t\t\tif (response) {\n\t\t\t\t\treturn response\n\t\t\t\t} else {\n\t\t\t\t\treturn fetch(request, {\n\t\t\t\t\t\tredirect: \"error\",\n\t\t\t\t\t}).then((networkResponse) => {\n\t\t\t\t\t\treturn cache.put(request, networkResponse.clone()).then(() => networkResponse)\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t})\n\t\t})\n\t}\n\n\t_fromCache(requestUrl: string): Promise<Response> {\n\t\treturn (\n\t\t\tthis._caches\n\t\t\t\t.open(this._cacheName)\n\t\t\t\t.then((cache) => cache.match(requestUrl)) // Cache magically disappears on iOS 12.1 after the browser restart.\n\t\t\t\t// See #758. See https://bugs.webkit.org/show_bug.cgi?id=190269\n\t\t\t\t.then((r) => r || fetch(requestUrl))\n\t\t)\n\t}\n\n\t// needed because FF fails to cache.addAll()\n\t_addAllToCache(cache: Cache, urlsToCache: string[]): Promise<any> {\n\t\treturn Promise.all(\n\t\t\turlsToCache.map((url) =>\n\t\t\t\tcache.add(url).catch((e) => {\n\t\t\t\t\tconsole.log(\"failed to add\", url, e)\n\t\t\t\t\tthrow e\n\t\t\t\t}),\n\t\t\t),\n\t\t)\n\t}\n\n\t_redirectToDefaultPage(url: string): Response {\n\t\t// We keep the hash in the url. This might lead to a situation where the client\n\t\t// has the hash twice (once encoded in \"r\" part and once in the url directly) but\n\t\t// the webapp has been trained to deal with it (see getStartUrl() in app.ts)\n\t\tconst withoutBasePath = url.substring(this._selfLocation.length)\n\t\tconst params = new URLSearchParams({\n\t\t\tr: withoutBasePath,\n\t\t})\n\t\treturn Response.redirect(`${this._selfLocation}?${params.toString()}`)\n\t}\n\n\t_shouldRedirectToDefaultPage(urlWithout: string): boolean {\n\t\treturn (\n\t\t\t!urlWithout.startsWith(this._possibleRest) &&\n\t\t\turlWithout.startsWith(this._selfLocation) &&\n\t\t\turlWithout !== this._selfLocation && // if we are already on the page we need\n\t\t\tthis._applicationPaths.includes(this._getFirstPathComponent(urlWithout))\n\t\t)\n\t}\n\n\t_getFirstPathComponent(url: string): string {\n\t\tconst pathElements = url.substring(this._selfLocation.length).split(\"/\")\n\t\treturn pathElements.length > 0 ? pathElements[0] : \"\"\n\t}\n\n\tasync shouldTakeOverImmediately(cacheStorage: CacheStorage): Promise<boolean> {\n\t\tconst allCacheName = await cacheStorage.keys()\n\t\tconst oldCacheEntries = allCacheName.filter((c) => c !== this._cacheName)\n\t\tif (oldCacheEntries.length === 0) return false\n\t\tconst oldCacheEntry = oldCacheEntries[0]\n\t\tconst oldCacheEntryNameParts = oldCacheEntry.split(\".\")\n\t\tif (oldCacheEntryNameParts.length !== 3) {\n\t\t\t// Cache name does not have the expected format.\n\t\t\treturn false\n\t\t} else {\n\t\t\t// the cache name is constructed based on the client version number. CODE_CACHE-v<major>.<minor>.<patch>\n\t\t\t// The minor part contains the build date, and we are interested in that to compare against MINIUM_INSTALLATION_DATE\n\t\t\tconst oldClientBuildDate = Number(oldCacheEntryNameParts[1])\n\t\t\treturn oldClientBuildDate <= LAST_INCOMPLETE_CACHE_DATE\n\t\t}\n\t}\n}\n\nconst init = (sw: ServiceWorker) => {\n\tconsole.log(\"sw init\", versionString)\n\tconst scope = self as unknown as ServiceWorkerGlobalScope\n\n\tscope.addEventListener(\"install\", (evt: ExtendableEvent) => {\n\t\tconsole.log(\"SW: being installed\", versionString)\n\t\tevt.waitUntil(\n\t\t\tsw.precache().then(async () => {\n\t\t\t\tif (await sw.shouldTakeOverImmediately(scope.caches)) {\n\t\t\t\t\tscope.skipWaiting()\n\t\t\t\t}\n\t\t\t}),\n\t\t)\n\t})\n\tscope.addEventListener(\"activate\", (event) => {\n\t\tconsole.log(\"sw activate\", versionString)\n\t\tevent.waitUntil(sw.deleteOldCaches().then(() => scope.clients.claim()))\n\t})\n\tscope.addEventListener(\"fetch\", (evt: FetchEvent) => {\n\t\tsw.respond(evt)\n\t})\n\tscope.addEventListener(\"message\", (event) => {\n\t\tconsole.log(\"sw message\", versionString, event)\n\n\t\tif (event.data === \"update\") {\n\t\t\tscope.skipWaiting()\n\t\t}\n\t})\n\tscope.addEventListener(\"error\", ({ error }) => {\n\t\tconst serializedError = {\n\t\t\tname: error.name,\n\t\t\tmessage: error.message,\n\t\t\tstack: error.stack,\n\t\t\tdata: error.data,\n\t\t}\n\t\treturn scope.clients.matchAll().then((allClients) => {\n\t\t\tfor (const c of allClients) {\n\t\t\t\tc.postMessage({\n\t\t\t\t\ttype: \"error\",\n\t\t\t\t\tvalue: serializedError,\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\t})\n}\n\n// Only exported for tests.\n// We export it like this because this file is standalone and not wrapped into module loader context when bundled.\n// With normal import Babel generates code which tries to set __esModule on exports but we have no exports in standalone.\n// We hack module in dist.js by prepending `self.module` = {} so that the line below actually works.\n// We should probably split the class and the actual content into separate files and just bundle them together during the build.\n// module.exports = {ServiceWorker}-\n// do not add listeners for Node tests. env is not set for production\nif (typeof env === \"undefined\" || env.mode !== \"Test\") {\n\tconst cacheName = \"CODE_CACHE-v\" + versionString\n\tconst selfLocation = self.location.href.substring(0, self.location.href.indexOf(\"sw.js\"))\n\tconst exclusions = customDomainCacheExclusions()\n\tconst urlsToCache = (isTutanotaDomain() ? filesToCache() : filesToCache().filter((file) => !exclusions.includes(file))).map((file) => selfLocation + file)\n\tconst applicationPaths = getPathBases()\n\tconst sw = new ServiceWorker(urlsToCache, caches, cacheName, selfLocation, applicationPaths, isTutanotaDomain())\n\tinit(sw)\n}\n"]}