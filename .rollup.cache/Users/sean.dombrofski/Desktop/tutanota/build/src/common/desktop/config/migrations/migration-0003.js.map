{"version":3,"file":"migration-0003.js","sourceRoot":"","sources":["../../../../../../src/common/desktop/config/migrations/migration-0003.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,QAAQ,EAAE,MAAM,uBAAuB,CAAA;AAEhD,OAAO,EAAE,GAAG,EAAE,MAAM,kBAAkB,CAAA;AAEtC,KAAK,UAAU,OAAO,CAAC,SAAiB,EAAE,MAAiC,EAAE,cAAqC;IACjH,MAAM,CAAC,MAAM,CAAC,SAAS,EAAE;QACxB,oBAAoB,EAAE,CAAC;KACvB,CAAC,CAAA;IAEF,IAAI,SAAS,CAAC,cAAc,EAAE,CAAC;QAC9B,IAAI,CAAC;YACJ,MAAM,SAAS,GAAG,MAAM,cAAc,CAAC,YAAY,EAAE,CAAA;YACrD,MAAM,CAAC,MAAM,CAAC,SAAS,EAAE;gBACxB,OAAO,EAAE,MAAM,CAAC,gBAAgB,CAAC,SAAS,EAAE,QAAQ,CAAC,SAAS,CAAC,cAAc,CAAC,CAAC;aAC/E,CAAC,CAAA;QACH,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACZ,8DAA8D;YAC9D,GAAG,CAAC,IAAI,CAAC,gEAAgE,EAAE,CAAC,CAAC,CAAA;QAC9E,CAAC;QAED,OAAO,SAAS,CAAC,cAAc,CAAA;IAChC,CAAC;AACF,CAAC;AAED,MAAM,CAAC,MAAM,aAAa,GAAG,OAAO,CAAA;AACpC,MAAM,CAAC,MAAM,YAAY,GAAG,OAAO,CAAA","sourcesContent":["import { DesktopNativeCryptoFacade } from \"../../DesktopNativeCryptoFacade\"\nimport type { Config } from \"../ConfigCommon\"\nimport { downcast } from \"@tutao/tutanota-utils\"\nimport type { DesktopKeyStoreFacade } from \"../../DesktopKeyStoreFacade.js\"\nimport { log } from \"../../DesktopLog\"\n\nasync function migrate(oldConfig: Config, crypto: DesktopNativeCryptoFacade, keyStoreFacade: DesktopKeyStoreFacade): Promise<void> {\n\tObject.assign(oldConfig, {\n\t\tdesktopConfigVersion: 3,\n\t})\n\n\tif (oldConfig.pushIdentifier) {\n\t\ttry {\n\t\t\tconst deviceKey = await keyStoreFacade.getDeviceKey()\n\t\t\tObject.assign(oldConfig, {\n\t\t\t\tsseInfo: crypto.aesEncryptObject(deviceKey, downcast(oldConfig.pushIdentifier)),\n\t\t\t})\n\t\t} catch (e) {\n\t\t\t// cannot read device key, just remove sseInfo from old config\n\t\t\tlog.warn(\"migration003: could not read device key, will not save sseInfo\", e)\n\t\t}\n\n\t\tdelete oldConfig.pushIdentifier\n\t}\n}\n\nexport const migrateClient = migrate\nexport const migrateAdmin = migrate\n"]}