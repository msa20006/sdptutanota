{"version":3,"file":"Expander.js","sourceRoot":"","sources":["../../../../../src/common/gui/base/Expander.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Children, Component, Vnode } from \"mithril\"\nimport type { TranslationKey, MaybeTranslation } from \"../../misc/LanguageViewModel\"\nimport { lang } from \"../../misc/LanguageViewModel\"\nimport { Icon, IconSize } from \"./Icon\"\nimport { Icons } from \"./icons/Icons\"\nimport { BootIcons } from \"./icons/BootIcons\"\nimport { theme } from \"../theme\"\nimport { px } from \"../size\"\nimport { DefaultAnimationTime } from \"../animation/Animations\"\nimport type { lazy } from \"@tutao/tutanota-utils\"\nimport { assertNotNull } from \"@tutao/tutanota-utils\"\nimport { isKeyPressed } from \"../../misc/KeyManager.js\"\nimport { Keys } from \"../../api/common/TutanotaConstants.js\"\n\nexport type ExpanderAttrs = {\n\tlabel: MaybeTranslation\n\texpanded: boolean\n\tonExpandedChange: (value: boolean) => unknown\n\tisPropagatingEvents?: boolean\n\tisBig?: boolean\n\tisUnformattedLabel?: boolean\n\tshowWarning?: boolean\n\tcolor?: string\n\tstyle?: Record<string, any>\n}\nexport type ExpanderPanelAttrs = {\n\texpanded: boolean\n}\n\nexport class ExpanderButton implements Component<ExpanderAttrs> {\n\tview(vnode: Vnode<ExpanderAttrs>): Children {\n\t\tconst a = vnode.attrs\n\t\tconst label = lang.getTranslationText(a.label)\n\t\treturn m(\n\t\t\t\".limit-width\",\n\t\t\tm(\n\t\t\t\t\"button.expander.bg-transparent.pt-s.hover-ul.limit-width.flex.items-center.b.text-ellipsis.flash\",\n\t\t\t\t{\n\t\t\t\t\tstyle: a.style,\n\t\t\t\t\tonclick: (event: MouseEvent) => {\n\t\t\t\t\t\ta.onExpandedChange(!a.expanded)\n\t\t\t\t\t\tif (!a.isPropagatingEvents) event.stopPropagation()\n\t\t\t\t\t},\n\t\t\t\t\tonkeydown: (e: KeyboardEvent) => {\n\t\t\t\t\t\tif (isKeyPressed(e.key, Keys.SPACE, Keys.RETURN)) {\n\t\t\t\t\t\t\ta.onExpandedChange(!a.expanded)\n\t\t\t\t\t\t\tif (!a.isPropagatingEvents) e.preventDefault()\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\t\"aria-expanded\": String(a.expanded),\n\t\t\t\t},\n\t\t\t\t[\n\t\t\t\t\ta.showWarning\n\t\t\t\t\t\t? m(Icon, {\n\t\t\t\t\t\t\t\ticon: Icons.Warning,\n\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\tfill: a.color ? a.color : theme.content_button,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t  })\n\t\t\t\t\t\t: null,\n\t\t\t\t\tm(\n\t\t\t\t\t\t`${a.isBig ? \"span\" : \"small\"}`,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\tcolor: a.color || theme.content_button,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\ta.isUnformattedLabel ? label : label.toUpperCase(),\n\t\t\t\t\t),\n\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\ticon: BootIcons.Expand,\n\t\t\t\t\t\tclass: \"flex-center items-center\",\n\t\t\t\t\t\tsize: a.isBig ? IconSize.Medium : IconSize.Normal,\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tfill: a.color ? a.color : theme.content_button,\n\t\t\t\t\t\t\t\"margin-right\": px(-4),\n\t\t\t\t\t\t\t// icon is has 4px whitespace to the right,\n\t\t\t\t\t\t\ttransform: `rotateZ(${a.expanded ? 180 : 0}deg)`,\n\t\t\t\t\t\t\ttransition: `transform ${DefaultAnimationTime}ms`,\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t],\n\t\t\t),\n\t\t)\n\t}\n}\n\n/**\n * Panel which shows or hides content depending on the attrs.expanded and animates transitions.\n */\nexport class ExpanderPanel implements Component<ExpanderPanelAttrs> {\n\tchildDiv: HTMLElement | null = null\n\t// There are some cases where the child div will be added to and a redraw won't be triggered, in which case\n\t// the expander panel won't update until some kind of interaction happens.\n\t// Unfortunately no one knows what these cases are anymore besides some direct mutation.\n\tobserver: MutationObserver | null = null\n\t// We calculate the height manually because we need concrete values for the transition (can't just transition from 0px to 100%)\n\tlastCalculatedHeight: number | null = null\n\t// We remove the children from the DOM to take them out of the taborder. Setting \"tabindex = -1\" on the element will not work because\n\t// it does not apply to any children\n\tchildrenInDom: boolean | null = null\n\tsetChildrenInDomTimeout: TimeoutID | null\n\n\toninit(vnode: Vnode<ExpanderPanelAttrs>) {\n\t\tthis.childrenInDom = vnode.attrs.expanded\n\t\tthis.observer = new MutationObserver((mutations) => {\n\t\t\t// redraw if a child has been added that won't be getting displayed\n\t\t\tif (this.childDiv && this.childDiv.getBoundingClientRect().height !== this.lastCalculatedHeight) {\n\t\t\t\tm.redraw()\n\t\t\t}\n\t\t})\n\t}\n\n\tonbeforeupdate(vnode: Vnode<ExpanderPanelAttrs>, old: Vnode<ExpanderPanelAttrs>): boolean {\n\t\tconst oldExpanded = old.attrs.expanded\n\t\tconst currentExpanded = vnode.attrs.expanded\n\n\t\tif (oldExpanded !== currentExpanded) {\n\t\t\tthis.handleExpansionStateChanged(currentExpanded)\n\t\t}\n\n\t\treturn true\n\t}\n\n\tview(vnode: Vnode<ExpanderPanelAttrs>): Children {\n\t\tconst expanded = vnode.attrs.expanded\n\t\t// getBoundingClientRect() gives us the correct size, with a fraction\n\t\tthis.lastCalculatedHeight = this.childDiv?.getBoundingClientRect().height ?? 0\n\t\treturn m(\n\t\t\t\".expander-panel\",\n\t\t\t// We want overflow while expanded in some specific cases like dropdowns, but generally we don't want it because we want to clip our children\n\t\t\t// for animation and sizing, so we enable it only when expanded\n\t\t\tm(\n\t\t\t\texpanded ? \"div\" : \".overflow-hidden\",\n\t\t\t\t{\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\topacity: expanded ? \"1\" : \"0\",\n\t\t\t\t\t\theight: expanded ? `${this.lastCalculatedHeight}px` : \"0px\",\n\t\t\t\t\t\ttransition: `opacity ${DefaultAnimationTime}ms ease-out, height ${DefaultAnimationTime}ms ease-out`,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t// we use this wrapper to measure the child reliably\n\t\t\t\t// just a marker class\n\t\t\t\tm(\n\t\t\t\t\t\".expander-child-wrapper\",\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t// one way to deal with collapsible margins.\n\t\t\t\t\t\t\t// CSS is fun in the way that it likes to collapse some vertical margins in some cases.\n\t\t\t\t\t\t\t// https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Box_Model/Mastering_margin_collapsing\n\t\t\t\t\t\t\t// One of such cases is when there's no content between the parent and the child and no margins or borders.\n\t\t\t\t\t\t\t// So assuming that the child we want to display inside has a margin-top set it would actually overflow our child-wrapper on the\n\t\t\t\t\t\t\t// top. Which means all our sizing is wrong.\n\t\t\t\t\t\t\t// There are few ways to prevent this, one of them is `display: flow-root`. It should have no side effects except for some\n\t\t\t\t\t\t\t// `display: float` items but if you are using `float` still you have no one to blame but yourself.\n\t\t\t\t\t\t\t// we could set `overflow: hidden` here instead but we do measure this element so we probably shouldn't\n\t\t\t\t\t\t\tdisplay: \"flow-root\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\t\t\tthis.childDiv = vnode.dom as HTMLElement\n\t\t\t\t\t\t\tassertNotNull(this.observer).observe(this.childDiv, {\n\t\t\t\t\t\t\t\tchildList: true,\n\t\t\t\t\t\t\t\tsubtree: true,\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonremove: () => {\n\t\t\t\t\t\t\tthis.observer?.disconnect()\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tthis.childrenInDom ? vnode.children : null,\n\t\t\t\t),\n\t\t\t),\n\t\t)\n\t}\n\n\tprivate handleExpansionStateChanged(expanded: boolean) {\n\t\tclearTimeout(this.setChildrenInDomTimeout)\n\n\t\tif (expanded) {\n\t\t\tthis.childrenInDom = true\n\t\t} else {\n\t\t\tthis.setChildrenInDomTimeout = setTimeout(() => {\n\t\t\t\tthis.childrenInDom = false\n\t\t\t\tm.redraw()\n\t\t\t}, DefaultAnimationTime)\n\t\t}\n\t}\n}\n"]}