{"version":3,"file":"AffiliateKpisViewer.js","sourceRoot":"","sources":["../../../../src/common/settings/AffiliateKpisViewer.ts"],"names":[],"mappings":"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","sourcesContent":["import { UpdatableSettingsDetailsViewer } from \"./Interfaces.js\"\nimport m from \"mithril\"\nimport { EntityUpdateData } from \"../api/common/utils/EntityUpdateUtils.js\"\nimport { ListColumnWrapper } from \"../gui/ListColumnWrapper.js\"\nimport { ColumnWidth, Table, TableLineAttrs } from \"../gui/base/Table.js\"\nimport { mailLocator } from \"../../mail-app/mailLocator.js\"\nimport { formatShortMonthYear2Digit } from \"../misc/Formatter.js\"\nimport { AffiliateViewModel } from \"./AffiliateViewModel.js\"\nimport { formatPrice } from \"../subscription/PriceUtils.js\"\nimport { lang } from \"../misc/LanguageViewModel.js\"\nimport { LazyLoaded } from \"@tutao/tutanota-utils\"\nimport { DateTime } from \"luxon\"\n\nexport class AffiliateKpisViewer implements UpdatableSettingsDetailsViewer {\n\tprivate readonly affiliateViewModel: LazyLoaded<AffiliateViewModel> = new LazyLoaded<AffiliateViewModel>(async () => await mailLocator.affiliateViewModel())\n\n\trenderView(): m.Children {\n\t\treturn m(\n\t\t\tListColumnWrapper,\n\t\t\tm(\n\t\t\t\t\".flex.flex-column.fill-absolute.plr-l\",\n\t\t\t\tm(\"h4.mt-l\", \"KPIs\"),\n\t\t\t\tm(\n\t\t\t\t\t\".overflow-auto.pt-s\",\n\t\t\t\t\t{ style: { height: \"100%\" } },\n\t\t\t\t\tm(\n\t\t\t\t\t\t\"\",\n\t\t\t\t\t\t{ style: { minWidth: \"800px\" } },\n\t\t\t\t\t\tm(Table, {\n\t\t\t\t\t\t\tcolumnHeading: [\n\t\t\t\t\t\t\t\t{ label: \"month_label\" },\n\t\t\t\t\t\t\t\t{ label: \"affiliateSettingsNewFree_label\", helpText: \"affiliateSettingsNewFree_msg\" },\n\t\t\t\t\t\t\t\t{ label: \"affiliateSettingsNewPaid_label\", helpText: \"affiliateSettingsNewPaid_msg\" },\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlabel: \"affiliateSettingsTotalFree_label\",\n\t\t\t\t\t\t\t\t\thelpText: \"affiliateSettingsTotalFree_msg\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlabel: \"affiliateSettingsTotalPaid_label\",\n\t\t\t\t\t\t\t\t\thelpText: \"affiliateSettingsTotalPaid_msg\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlabel: \"affiliateSettingsCommission_label\",\n\t\t\t\t\t\t\t\t\thelpText: \"affiliateSettingsCommission_msg\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tcolumnWidths: [\n\t\t\t\t\t\t\t\tColumnWidth.Largest,\n\t\t\t\t\t\t\t\tColumnWidth.Largest,\n\t\t\t\t\t\t\t\tColumnWidth.Largest,\n\t\t\t\t\t\t\t\tColumnWidth.Largest,\n\t\t\t\t\t\t\t\tColumnWidth.Largest,\n\t\t\t\t\t\t\t\tColumnWidth.Largest,\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tshowActionButtonColumn: false,\n\t\t\t\t\t\t\taddButtonAttrs: null,\n\t\t\t\t\t\t\tlines: this.renderRows(),\n\t\t\t\t\t\t}),\n\t\t\t\t\t),\n\t\t\t\t),\n\t\t\t),\n\t\t)\n\t}\n\n\tprivate renderRows(): TableLineAttrs[] {\n\t\tif (this.affiliateViewModel.isLoaded()) {\n\t\t\tconst avm = this.affiliateViewModel.getSync()!\n\t\t\treturn (avm.data?.kpis ?? [])\n\t\t\t\t.slice()\n\t\t\t\t.sort((a, b) => Number(b.monthTimestamp) - Number(a.monthTimestamp))\n\t\t\t\t.map((month) => {\n\t\t\t\t\tconst date = DateTime.fromJSDate(new Date(Number(month.monthTimestamp)))\n\t\t\t\t\t\t.minus({ day: 3 })\n\t\t\t\t\t\t.toJSDate() // Remove 3 days to avoid timezones issues (just in case), since the original date is the end of the month.\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tcells: [\n\t\t\t\t\t\t\tformatShortMonthYear2Digit(date),\n\t\t\t\t\t\t\tmonth.newFree,\n\t\t\t\t\t\t\tmonth.newPaid,\n\t\t\t\t\t\t\tmonth.totalFree,\n\t\t\t\t\t\t\tmonth.totalPaid,\n\t\t\t\t\t\t\tformatPrice(Number(month.commission), true),\n\t\t\t\t\t\t],\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t} else {\n\t\t\tthis.affiliateViewModel.getAsync().then(() => m.redraw())\n\t\t\treturn []\n\t\t}\n\t}\n\n\tentityEventsReceived(updates: readonly EntityUpdateData[]): Promise<unknown> {\n\t\treturn Promise.resolve()\n\t}\n}\n"]}