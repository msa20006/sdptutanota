{"version":3,"file":"WebMobileFacade.js","sourceRoot":"","sources":["../../../../../src/common/native/main/WebMobileFacade.ts"],"names":[],"mappings":"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","sourcesContent":["import m from \"mithril\"\nimport { assertMainOrNode } from \"../../api/common/Env\"\nimport { modal } from \"../../gui/base/Modal\"\nimport { CALENDAR_PREFIX, CONTACTS_PREFIX, MAIL_PREFIX, SEARCH_PREFIX, SETTINGS_PREFIX } from \"../../misc/RouteChange\"\nimport { last } from \"@tutao/tutanota-utils\"\nimport { CloseEventBusOption, MailSetKind, SECOND_MS } from \"../../api/common/TutanotaConstants.js\"\nimport { MobileFacade } from \"../common/generatedipc/MobileFacade.js\"\nimport { styles } from \"../../gui/styles\"\nimport { WebsocketConnectivityModel } from \"../../misc/WebsocketConnectivityModel.js\"\nimport { MailboxModel } from \"../../mailFunctionality/MailboxModel.js\"\nimport { TopLevelView } from \"../../../TopLevelView.js\"\nimport stream from \"mithril/stream\"\nimport { CalendarViewType } from \"../../api/common/utils/CommonCalendarUtils.js\"\n\nassertMainOrNode()\n\n/**\n * Handles press of the android back button. Returns true if the action has been processed by the application.\n * False if the caller must handle the button press (quit the application)\n */\nexport class WebMobileFacade implements MobileFacade {\n\tprivate disconnectTimeoutId: TimeoutID | null\n\n\tprivate isAppVisible: stream<boolean> = stream(false)\n\n\tconstructor(private readonly connectivityModel: WebsocketConnectivityModel, private readonly baseViewPrefix: string) {}\n\n\tpublic getIsAppVisible(): stream<boolean> {\n\t\treturn this.isAppVisible\n\t}\n\n\tasync handleBackPress(): Promise<boolean> {\n\t\tawait Promise.resolve()\n\t\tconst lastModalComponent = last(modal.components)\n\n\t\tif (lastModalComponent) {\n\t\t\t// first check if any modal dialog is visible\n\t\t\tlastModalComponent.component.onClose()\n\t\t\treturn true\n\t\t} else {\n\t\t\t// otherwise try to navigate back in the current view\n\t\t\tconst viewSlider = window.tutao.currentView?.getViewSlider?.()\n\n\t\t\tconst currentRoute = m.route.get()\n\n\t\t\t// If the sidebar is opened, close it\n\t\t\tif (viewSlider && viewSlider.isForegroundColumnFocused()) {\n\t\t\t\tviewSlider.focusNextColumn()\n\t\t\t\treturn true\n\t\t\t} else if (this.handlesBackButtonViaCurrentView()) {\n\t\t\t\treturn true\n\t\t\t} else if (\n\t\t\t\tviewSlider &&\n\t\t\t\tviewSlider.focusedColumn !== viewSlider.getMainColumn() &&\n\t\t\t\tstyles.isSingleColumnLayout() &&\n\t\t\t\tviewSlider.isFocusPreviousPossible()\n\t\t\t) {\n\t\t\t\t// current view can navigate back, a region column is focused (not main) and is in singleColumnLayout\n\t\t\t\tviewSlider.focusPreviousColumn()\n\t\t\t\treturn true\n\t\t\t} else if (currentRoute.startsWith(CALENDAR_PREFIX)) {\n\t\t\t\tif (history.state?.origin === CalendarViewType.MONTH) {\n\t\t\t\t\tconst date = history.state.dateString ?? new Date().toISOString().substring(0, 10)\n\t\t\t\t\tm.route.set(\"/calendar/:view/:date\", {\n\t\t\t\t\t\tview: CalendarViewType.MONTH,\n\t\t\t\t\t\tdate,\n\t\t\t\t\t})\n\t\t\t\t\treturn true\n\t\t\t\t}\n\n\t\t\t\tif (this.baseViewPrefix === CALENDAR_PREFIX) {\n\t\t\t\t\t// we are at the main view and want to exit the app\n\t\t\t\t\treturn false\n\t\t\t\t} else {\n\t\t\t\t\tm.route.set(this.baseViewPrefix)\n\t\t\t\t\treturn true\n\t\t\t\t}\n\t\t\t} else if (currentRoute.startsWith(CONTACTS_PREFIX) || currentRoute.startsWith(SETTINGS_PREFIX) || currentRoute.startsWith(SEARCH_PREFIX)) {\n\t\t\t\t// go back to mail or calendar from other paths\n\t\t\t\tm.route.set(this.baseViewPrefix)\n\t\t\t\treturn true\n\t\t\t} else {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate handlesBackButtonViaCurrentView(): boolean {\n\t\tconst currentView: TopLevelView | null = window.tutao.currentView\n\t\treturn currentView?.handleBackButton != null && currentView.handleBackButton()\n\t}\n\n\tasync visibilityChange(visibility: boolean): Promise<void> {\n\t\tconsole.log(\"native visibility change\", visibility)\n\t\tthis.isAppVisible(visibility)\n\n\t\tif (visibility) {\n\t\t\tif (this.disconnectTimeoutId != null) {\n\t\t\t\tclearTimeout(this.disconnectTimeoutId)\n\t\t\t\tthis.disconnectTimeoutId = null\n\t\t\t}\n\n\t\t\treturn this.connectivityModel.tryReconnect(false, true)\n\t\t} else {\n\t\t\tthis.disconnectTimeoutId = setTimeout(() => {\n\t\t\t\tthis.connectivityModel.close(CloseEventBusOption.Pause)\n\t\t\t}, 30 * SECOND_MS)\n\t\t}\n\t}\n\n\tasync keyboardSizeChanged(newSize: number): Promise<void> {\n\t\tconst { windowFacade } = await import(\"../../misc/WindowFacade.js\")\n\t\treturn windowFacade.onKeyboardSizeChanged(newSize)\n\t}\n}\n"]}