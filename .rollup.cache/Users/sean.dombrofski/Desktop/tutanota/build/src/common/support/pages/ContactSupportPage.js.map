{"version":3,"file":"ContactSupportPage.js","sourceRoot":"","sources":["../../../../../src/common/support/pages/ContactSupportPage.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Children, Component, Vnode } from \"mithril\"\nimport { getLocalisedCategoryName, getLocalisedTopicIssue, SupportDialogState } from \"../SupportDialog.js\"\nimport { clientInfoString, getLogAttachments } from \"../../misc/ErrorReporter.js\"\nimport { DataFile } from \"../../api/common/DataFile.js\"\nimport { Thunk } from \"@tutao/tutanota-utils\"\nimport { locator } from \"../../api/main/CommonLocator.js\"\nimport { lang } from \"../../misc/LanguageViewModel.js\"\nimport { Card } from \"../../gui/base/Card.js\"\nimport { LoginButton } from \"../../gui/base/buttons/LoginButton.js\"\nimport { htmlSanitizer } from \"../../misc/HtmlSanitizer.js\"\nimport { MailMethod, PlanTypeToName } from \"../../api/common/TutanotaConstants.js\"\nimport { SendMailModel } from \"../../mailFunctionality/SendMailModel.js\"\nimport { convertTextToHtml } from \"../../misc/Formatter.js\"\nimport { showProgressDialog } from \"../../gui/dialogs/ProgressDialog.js\"\nimport { Switch } from \"../../gui/base/Switch.js\"\nimport { SectionButton } from \"../../gui/base/buttons/SectionButton.js\"\nimport { Icons } from \"../../gui/base/icons/Icons.js\"\nimport { Icon, IconSize } from \"../../gui/base/Icon.js\"\nimport { BaseButton } from \"../../gui/base/buttons/BaseButton.js\"\nimport { ButtonColor, getColors } from \"../../gui/base/Button.js\"\nimport { px, size } from \"../../gui/size.js\"\nimport { chooseAndAttachFile } from \"../../../mail-app/mail/editor/MailEditorViewModel.js\"\n\nexport type Props = {\n\tdata: SupportDialogState\n\tgoToSuccessPage: Thunk\n}\n\nexport class ContactSupportPage implements Component<Props> {\n\tprivate sendMailModel: SendMailModel | undefined\n\n\toninit({ attrs: { data } }: Vnode<Props>) {\n\t\tthis.collectLogs().then((logs) => {\n\t\t\tdata.logs(logs)\n\t\t\tm.redraw()\n\t\t})\n\t}\n\n\tasync oncreate(): Promise<void> {\n\t\tthis.sendMailModel = await createSendMailModel()\n\t\tawait this.sendMailModel.initWithTemplate(\n\t\t\t{\n\t\t\t\tto: [\n\t\t\t\t\t{\n\t\t\t\t\t\tname: null,\n\t\t\t\t\t\taddress: \"helpdesk@tutao.de\",\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t},\n\t\t\t\"\",\n\t\t\t\"\",\n\t\t\t[],\n\t\t\tfalse,\n\t\t)\n\t}\n\n\t/**\n\t * Gets the subject of the support request considering the users current plan and the path they took to get to the contact form.\n\t * Appends the category and topic if present.\n\t *\n\t * **Example output: `Support Request - Unlimited - Account: I cannot login.`**\n\t */\n\tprivate async getSubject(data: SupportDialogState) {\n\t\tconst MAX_ISSUE_LENGTH = 60\n\t\tlet subject = `Support Request (${PlanTypeToName[await locator.logins.getUserController().getPlanType()]})`\n\n\t\tconst selectedCategory = data.selectedCategory()\n\t\tconst selectedTopic = data.selectedTopic()\n\n\t\tif (selectedCategory != null && selectedTopic != null) {\n\t\t\tconst localizedTopic = getLocalisedTopicIssue(selectedTopic, lang.languageTag)\n\t\t\tconst issue = localizedTopic.length > MAX_ISSUE_LENGTH ? localizedTopic.substring(0, MAX_ISSUE_LENGTH) + \"...\" : localizedTopic\n\t\t\tsubject += ` - ${getLocalisedCategoryName(selectedCategory, lang.languageTag)}: ${issue}`\n\t\t}\n\n\t\tif (selectedCategory != null && selectedTopic == null) {\n\t\t\tsubject += ` - ${getLocalisedCategoryName(selectedCategory, lang.languageTag)}`\n\t\t}\n\n\t\treturn subject\n\t}\n\n\tview({ attrs: { data, goToSuccessPage } }: Vnode<Props>): Children {\n\t\treturn m(\n\t\t\t\".flex.flex-column.pt.height-100p.gap-vpad\",\n\t\t\tm(Card, m(\"\", m(\"p.h4.m-0\", lang.get(\"supportForm_title\")), m(\"p.m-0.mt-s\", lang.get(\"supportForm_msg\")))),\n\t\t\tm(\n\t\t\t\tCard,\n\t\t\t\t{\n\t\t\t\t\tclasses: [\"child-text-editor\", \"rel\", \"height-100p\"],\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tpadding: \"0\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tm(data.htmlEditor),\n\t\t\t),\n\n\t\t\tm(\n\t\t\t\t\".flex.flex-column.gap-vpad.pb\",\n\t\t\t\t{\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tmarginTop: \"auto\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tm(\n\t\t\t\t\tCard,\n\t\t\t\t\t{\n\t\t\t\t\t\tshouldDivide: true,\n\t\t\t\t\t},\n\t\t\t\t\t[\n\t\t\t\t\t\tm(SectionButton, {\n\t\t\t\t\t\t\ttext: \"attachFiles_action\",\n\t\t\t\t\t\t\trightIcon: { icon: Icons.Attachment, title: \"attachFiles_action\" },\n\t\t\t\t\t\t\tonclick: async (_, dom) => {\n\t\t\t\t\t\t\t\tawait chooseAndAttachFile(this.sendMailModel!, dom.getBoundingClientRect())\n\t\t\t\t\t\t\t\tm.redraw()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}),\n\t\t\t\t\t\t(this.sendMailModel?.getAttachments() ?? []).map((attachment) =>\n\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\".flex.center-vertically.flex-space-between.pb-s.pt-s\",\n\t\t\t\t\t\t\t\t{ style: { paddingInline: px(size.vpad_small) } },\n\t\t\t\t\t\t\t\tm(\"span.smaller\", attachment.name),\n\t\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\tBaseButton,\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tlabel: \"remove_action\",\n\t\t\t\t\t\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\t\t\t\t\t\tthis.sendMailModel?.removeAttachment(attachment)\n\t\t\t\t\t\t\t\t\t\t\tm.redraw()\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\tclass: \"flex justify-between flash\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\t\t\t\t\ticon: Icons.Trash,\n\t\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\t\tfill: getColors(ButtonColor.Content).button,\n\t\t\t\t\t\t\t\t\t\t\tpaddingInline: px((size.icon_size_large - size.icon_size_medium) / 2),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\ttitle: lang.get(\"remove_action\"),\n\t\t\t\t\t\t\t\t\t\tsize: IconSize.Normal,\n\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t),\n\t\t\t\t\t],\n\t\t\t\t),\n\t\t\t\tm(\n\t\t\t\t\tCard,\n\t\t\t\t\tm(\".flex.gap-vpad-s.items-center\", [\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\tSwitch,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tchecked: data.shouldIncludeLogs(),\n\t\t\t\t\t\t\t\tonclick: (checked) => data.shouldIncludeLogs(checked),\n\t\t\t\t\t\t\t\tariaLabel: lang.get(\"sendLogs_action\"),\n\t\t\t\t\t\t\t\tvariant: \"expanded\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tlang.get(\"sendLogs_action\"),\n\t\t\t\t\t\t),\n\t\t\t\t\t]),\n\t\t\t\t),\n\t\t\t\tm(\n\t\t\t\t\t\".align-self-center.full-width\",\n\t\t\t\t\tm(LoginButton, {\n\t\t\t\t\t\tlabel: \"send_action\",\n\t\t\t\t\t\tonclick: async () => {\n\t\t\t\t\t\t\tif (!this.sendMailModel) {\n\t\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst message = data.htmlEditor.getValue()\n\t\t\t\t\t\t\tconst mailBody = data.shouldIncludeLogs() ? `${message}${clientInfoString(new Date(), true).message}` : message\n\n\t\t\t\t\t\t\tconst sanitisedBody = htmlSanitizer.sanitizeHTML(convertTextToHtml(mailBody), {\n\t\t\t\t\t\t\t\tblockExternalContent: true,\n\t\t\t\t\t\t\t}).html\n\n\t\t\t\t\t\t\tthis.sendMailModel.setBody(sanitisedBody)\n\t\t\t\t\t\t\tthis.sendMailModel.setSubject(await this.getSubject(data))\n\n\t\t\t\t\t\t\tif (data.shouldIncludeLogs()) {\n\t\t\t\t\t\t\t\tthis.sendMailModel.attachFiles(data.logs())\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tawait this.sendMailModel.send(MailMethod.NONE, () => Promise.resolve(true), showProgressDialog)\n\n\t\t\t\t\t\t\tgoToSuccessPage()\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t),\n\t\t\t),\n\t\t)\n\t}\n\n\tprivate async collectLogs(): Promise<DataFile[]> {\n\t\treturn await getLogAttachments(new Date())\n\t}\n}\n\nasync function createSendMailModel(): Promise<SendMailModel> {\n\tconst mailboxDetails = await locator.mailboxModel.getUserMailboxDetails()\n\tconst mailboxProperties = await locator.mailboxModel.getMailboxProperties(mailboxDetails.mailboxGroupRoot)\n\treturn await locator.sendMailModel(mailboxDetails, mailboxProperties)\n}\n"]}