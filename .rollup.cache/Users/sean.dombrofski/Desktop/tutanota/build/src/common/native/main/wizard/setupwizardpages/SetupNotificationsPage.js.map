{"version":3,"file":"SetupNotificationsPage.js","sourceRoot":"","sources":["../../../../../../../src/common/native/main/wizard/setupwizardpages/SetupNotificationsPage.ts"],"names":[],"mappings":"AAAA,OAAO,CAAiC,MAAM,SAAS,CAAA;AAGvD,OAAO,EAAE,YAAY,EAAE,MAAM,+BAA+B,CAAA;AAG5D,OAAO,EAAE,eAAe,EAAE,MAAM,sBAAsB,CAAA;AAEtD,OAAO,EAAE,2BAA2B,EAAE,MAAM,uDAAuD,CAAA;AAOnG,MAAM,OAAO,sBAAsB;IAClC,IAAI,CAAC,EAAE,KAAK,EAAsC;QACjD,OAAO,CAAC,CACP,eAAe,EACf,EAAE,KAAK,EAAE,eAAe,EAAE,EAC1B,CAAC,CAAC,2BAA2B,EAAE;YAC9B,+BAA+B,EAAE,KAAK,CAAC,IAAI,CAAC,+BAA+B;YAC3E,0BAA0B,EAAE,KAAK,CAAC,IAAI,CAAC,0BAA0B;YACjE,4BAA4B,EAAE,CAAC,SAAkB,EAAE,EAAE,CAAC,KAAK,CAAC,kCAAkC,CAAC,SAAS,CAAC;YACzG,mCAAmC,EAAE,CAAC,SAAS,EAAE,EAAE,CAAC,KAAK,CAAC,yCAAyC,CAAC,SAAS,CAAC;SAC9G,CAAC,CACF,CAAA;IACF,CAAC;CACD;AAED,MAAM,OAAO,2BAA2B;IASrB;IARlB,uBAAuB,GAAG,KAAK,CAAA;IAC/B,IAAI,CAA6B;IACjC,+EAA+E;IAC9D,aAAa,CAAS;IAEvC,YACC,cAA2C,EAC3C,eAAgC,EACf,uBAAgD;QAAhD,4BAAuB,GAAvB,uBAAuB,CAAyB;QAEjE,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,YAAY,CAAC,cAAc,CAAC,CAAA;QACtD,IAAI,CAAC,IAAI,GAAG,cAAc,CAAA;QAE1B,eAAe,CAAC,GAAG,CAAC,CAAC,SAAS,EAAE,EAAE;YACjC,oFAAoF;YACpF,IAAI,SAAS,EAAE,CAAC;gBACf,IAAI,CAAC,uBAAuB;qBAC1B,qBAAqB,CAAC,2FAAuE,CAAC;qBAC9F,IAAI,CAAC,CAAC,eAAe,EAAE,EAAE;oBACzB,IAAI,CAAC,IAAI,GAAG;wBACX,+BAA+B,EAAE,eAAe,CAAC,GAAG,uCAA6B,IAAI,KAAK;wBAC1F,0BAA0B,EAAE,eAAe,CAAC,GAAG,oDAA0C,IAAI,KAAK;qBAClG,CAAA;oBACD,CAAC,CAAC,MAAM,EAAE,CAAA;gBACX,CAAC,CAAC,CAAA;YACJ,CAAC;QACF,CAAC,CAAC,CAAA;IACH,CAAC;IAED,kCAAkC,CAAC,SAAkB;QACpD,IAAI,CAAC,IAAI,GAAG;YACX,GAAG,IAAI,CAAC,IAAI;YACZ,+BAA+B,EAAE,SAAS;SAC1C,CAAA;QACD,CAAC,CAAC,MAAM,EAAE,CAAA;IACX,CAAC;IAED,yCAAyC,CAAC,SAAkB;QAC3D,IAAI,CAAC,IAAI,GAAG;YACX,GAAG,IAAI,CAAC,IAAI;YACZ,0BAA0B,EAAE,SAAS;SACrC,CAAA;QACD,CAAC,CAAC,MAAM,EAAE,CAAA;IACX,CAAC;IAEO,YAAY,CAAC,IAAiC;QACrD,+DAA+D;QAC/D,IAAI,YAAY,EAAE,EAAE,CAAC;YACpB,OAAO,CAAC,IAAI,CAAC,+BAA+B,IAAI,CAAC,IAAI,CAAC,0BAA0B,CAAA;QACjF,CAAC;QACD,OAAO,CAAC,IAAI,CAAC,+BAA+B,CAAA;IAC7C,CAAC;IAED,WAAW;QACV,OAAO,6BAA6B,CAAA;IACrC,CAAC;IAED,UAAU,CAAC,WAAoB;QAC9B,0CAA0C;QAC1C,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAA;IAC7B,CAAC;IAED,eAAe;QACd,OAAO,KAAK,CAAA;IACb,CAAC;IAED,SAAS;QACR,OAAO,IAAI,CAAC,aAAa,CAAA;IAC1B,CAAC;CACD","sourcesContent":["import m, { Children, Component, Vnode } from \"mithril\"\nimport { WizardPageAttrs } from \"../../../../gui/base/WizardDialog.js\"\nimport { PermissionType } from \"../../../common/generatedipc/PermissionType.js\"\nimport { isAndroidApp } from \"../../../../api/common/Env.js\"\nimport { lang, type TranslationKey } from \"../../../../misc/LanguageViewModel.js\"\nimport Stream from \"mithril/stream\"\nimport { SetupPageLayout } from \"./SetupPageLayout.js\"\nimport { SystemPermissionHandler } from \"../../SystemPermissionHandler.js\"\nimport { NotificationPermissionsBody } from \"../../../../settings/NotificationPermissionsDialog.js\"\n\nexport interface NotificationPermissionsData {\n\tisNotificationPermissionGranted: boolean\n\tisBatteryPermissionGranted: boolean\n}\n\nexport class SetupNotificationsPage implements Component<SetupNotificationsPageAttrs> {\n\tview({ attrs }: Vnode<SetupNotificationsPageAttrs>): Children {\n\t\treturn m(\n\t\t\tSetupPageLayout,\n\t\t\t{ image: \"notifications\" },\n\t\t\tm(NotificationPermissionsBody, {\n\t\t\t\tisNotificationPermissionGranted: attrs.data.isNotificationPermissionGranted,\n\t\t\t\tisBatteryPermissionGranted: attrs.data.isBatteryPermissionGranted,\n\t\t\t\taskForNotificationPermission: (isGranted: boolean) => attrs.setIsNotificationPermissionGranted(isGranted),\n\t\t\t\taskForBatteryNotificationPermission: (isGranted) => attrs.setIsBatteryNotificationPermissionGranted(isGranted),\n\t\t\t}),\n\t\t)\n\t}\n}\n\nexport class SetupNotificationsPageAttrs implements WizardPageAttrs<NotificationPermissionsData> {\n\thidePagingButtonForPage = false\n\tdata: NotificationPermissionsData\n\t// Cache the permission values to avoid the page becoming disabled while on it.\n\tprivate readonly isPageVisible: boolean\n\n\tconstructor(\n\t\tpermissionData: NotificationPermissionsData,\n\t\tvisiblityStream: Stream<boolean>,\n\t\tprivate readonly systemPermissionHandler: SystemPermissionHandler,\n\t) {\n\t\tthis.isPageVisible = this.isPageNeeded(permissionData)\n\t\tthis.data = permissionData\n\n\t\tvisiblityStream.map((isVisible) => {\n\t\t\t// Redraw the page when the user resumes the app to check for changes in permissions\n\t\t\tif (isVisible) {\n\t\t\t\tthis.systemPermissionHandler\n\t\t\t\t\t.queryPermissionsState([PermissionType.Notification, PermissionType.IgnoreBatteryOptimization])\n\t\t\t\t\t.then((permissionState) => {\n\t\t\t\t\t\tthis.data = {\n\t\t\t\t\t\t\tisNotificationPermissionGranted: permissionState.get(PermissionType.Notification) ?? false,\n\t\t\t\t\t\t\tisBatteryPermissionGranted: permissionState.get(PermissionType.IgnoreBatteryOptimization) ?? false,\n\t\t\t\t\t\t}\n\t\t\t\t\t\tm.redraw()\n\t\t\t\t\t})\n\t\t\t}\n\t\t})\n\t}\n\n\tsetIsNotificationPermissionGranted(isGranted: boolean) {\n\t\tthis.data = {\n\t\t\t...this.data,\n\t\t\tisNotificationPermissionGranted: isGranted,\n\t\t}\n\t\tm.redraw()\n\t}\n\n\tsetIsBatteryNotificationPermissionGranted(isGranted: boolean) {\n\t\tthis.data = {\n\t\t\t...this.data,\n\t\t\tisBatteryPermissionGranted: isGranted,\n\t\t}\n\t\tm.redraw()\n\t}\n\n\tprivate isPageNeeded(data: NotificationPermissionsData): boolean {\n\t\t// Skip this page if the needed permissions are already granted\n\t\tif (isAndroidApp()) {\n\t\t\treturn !data.isNotificationPermissionGranted || !data.isBatteryPermissionGranted\n\t\t}\n\t\treturn !data.isNotificationPermissionGranted\n\t}\n\n\theaderTitle(): TranslationKey {\n\t\treturn \"notificationSettings_action\"\n\t}\n\n\tnextAction(showDialogs: boolean): Promise<boolean> {\n\t\t// next action not available for this page\n\t\treturn Promise.resolve(true)\n\t}\n\n\tisSkipAvailable(): boolean {\n\t\treturn false\n\t}\n\n\tisEnabled(): boolean {\n\t\treturn this.isPageVisible\n\t}\n}\n"]}