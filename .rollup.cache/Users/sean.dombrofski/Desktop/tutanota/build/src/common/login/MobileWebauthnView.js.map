{"version":3,"file":"MobileWebauthnView.js","sourceRoot":"","sources":["../../../../src/common/login/MobileWebauthnView.ts"],"names":[],"mappings":"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","sourcesContent":["import type { Children, Vnode } from \"mithril\"\nimport m from \"mithril\"\nimport { DialogHeaderBar, DialogHeaderBarAttrs } from \"../gui/base/DialogHeaderBar.js\"\nimport { SecondFactorImage } from \"../gui/base/icons/Icons.js\"\nimport { progressIcon } from \"../gui/base/Icon.js\"\nimport { lang } from \"../misc/LanguageViewModel.js\"\nimport { ButtonType } from \"../gui/base/Button.js\"\nimport { BrowserWebauthn } from \"../misc/2fa/webauthn/BrowserWebauthn.js\"\nimport { WebAuthnSignChallenge } from \"../native/common/generatedipc/WebAuthnSignChallenge.js\"\nimport { stringToBase64 } from \"@tutao/tutanota-utils\"\nimport { WebAuthnRegistrationChallenge } from \"../native/common/generatedipc/WebAuthnRegistrationChallenge.js\"\nimport { TopLevelAttrs, TopLevelView } from \"../../TopLevelView.js\"\n\nexport interface MobileWebauthnAttrs extends TopLevelAttrs {\n\tbrowserWebauthn: BrowserWebauthn\n}\n\n/**\n * This is a special view which is not used by the web client\n * directly but is loaded remotely by mobile client.\n * See AndroidWebauthnFacade and IosWebauthnFacade.\n */\nexport class MobileWebauthnView implements TopLevelView<MobileWebauthnAttrs> {\n\toncreate({ attrs }: Vnode<MobileWebauthnAttrs>) {\n\t\tif (attrs.args[\"action\"] === \"sign\") {\n\t\t\tthis.authenticate(attrs)\n\t\t} else if (attrs.args[\"action\"] === \"register\") {\n\t\t\tthis.register(attrs)\n\t\t} else {\n\t\t\tthrow new Error(\"Not implemented\")\n\t\t}\n\t}\n\n\tview({ attrs }: Vnode<MobileWebauthnAttrs>): Children {\n\t\tconst headerBarAttrs: DialogHeaderBarAttrs = {\n\t\t\tleft: [\n\t\t\t\t{\n\t\t\t\t\tlabel: \"cancel_action\",\n\t\t\t\t\tclick: () => window.close(),\n\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t},\n\t\t\t],\n\t\t\tright: [],\n\t\t\tmiddle: \"u2fSecurityKey_label\",\n\t\t}\n\n\t\treturn m(\n\t\t\t\".mt.flex.col.flex-center.center\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\tmargin: \"0 auto\",\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(\".flex.col.justify-center\", [\n\t\t\t\t\tm(DialogHeaderBar, headerBarAttrs),\n\t\t\t\t\tm(\".flex-center.mt-s\", m(\"img\", { src: SecondFactorImage })),\n\t\t\t\t\tm(\".mt.flex.col\", [m(\".flex.justify-center\", [m(\".mr-s\", progressIcon()), m(\"\", lang.get(\"waitingForU2f_msg\"))])]),\n\t\t\t\t]),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate async getParams(attrs: MobileWebauthnAttrs): Promise<{ challenge: string; cbUrlTemplate: string }> {\n\t\tif (!(await attrs.browserWebauthn.isSupported())) {\n\t\t\tthrow new Error(\"Webauthn not supported?\")\n\t\t}\n\t\tconst challenge = attrs.args[\"challenge\"]\n\t\tif (typeof challenge !== \"string\") {\n\t\t\tthrow new Error(\"Challenge is not passed\")\n\t\t}\n\t\tconst cbUrlTemplate = attrs.args[\"cbUrl\"]\n\t\tif (typeof cbUrlTemplate !== \"string\") {\n\t\t\tthrow new Error(\"cbUrl is not passed\")\n\t\t}\n\t\treturn { challenge, cbUrlTemplate }\n\t}\n\n\tprivate async sendSuccess(value: unknown, cbUrlTemplate: string) {\n\t\tawait this.sendResultObject({ type: \"success\", value }, cbUrlTemplate)\n\t}\n\n\tprivate async sendFailure(e: Error, cbUrlTemplate: string) {\n\t\tawait this.sendResultObject({ type: \"error\", name: e.name, stack: e.stack }, cbUrlTemplate)\n\t}\n\n\tprivate async sendResultObject(result: object, cbUrlTemplate: string) {\n\t\tconst { encodeValueForNative } = await import(\"../native/common/NativeLineProtocol.js\")\n\t\tconst serializedResult = encodeValueForNative(result)\n\t\tconst base64Result = stringToBase64(serializedResult)\n\t\tconst cbUrl = cbUrlTemplate.replace(\"{result}\", base64Result)\n\t\twindow.open(cbUrl, \"_self\")\n\t}\n\n\tasync authenticate(attrs: MobileWebauthnAttrs) {\n\t\tconst { challenge, cbUrlTemplate } = await this.getParams(attrs)\n\t\ttry {\n\t\t\tconst { decodeValueFromNative } = await import(\"../native/common/NativeLineProtocol.js\")\n\t\t\tconst rawChallengeObj = decodeValueFromNative(challenge) as WebAuthnSignChallenge\n\t\t\tconst signResult = await attrs.browserWebauthn.sign({\n\t\t\t\tchallenge: rawChallengeObj.challenge,\n\t\t\t\tdomain: rawChallengeObj.domain,\n\t\t\t\tkeys: rawChallengeObj.keys,\n\t\t\t})\n\t\t\tawait this.sendSuccess(signResult, cbUrlTemplate)\n\t\t} catch (e) {\n\t\t\tawait this.sendFailure(e, cbUrlTemplate)\n\t\t}\n\t}\n\n\tasync register(attrs: MobileWebauthnAttrs) {\n\t\tconst { challenge, cbUrlTemplate } = await this.getParams(attrs)\n\n\t\ttry {\n\t\t\tconst { decodeValueFromNative } = await import(\"../native/common/NativeLineProtocol.js\")\n\t\t\tconst rawChallengeObj = decodeValueFromNative(challenge) as WebAuthnRegistrationChallenge\n\t\t\tconst registrationResult = await attrs.browserWebauthn.register({\n\t\t\t\tchallenge: rawChallengeObj.challenge,\n\t\t\t\tdomain: rawChallengeObj.domain,\n\t\t\t\tname: rawChallengeObj.name,\n\t\t\t\tdisplayName: rawChallengeObj.displayName,\n\t\t\t\tuserId: rawChallengeObj.userId,\n\t\t\t})\n\t\t\tawait this.sendSuccess(registrationResult, cbUrlTemplate)\n\t\t} catch (e) {\n\t\t\tawait this.sendFailure(e, cbUrlTemplate)\n\t\t}\n\t}\n}\n"]}