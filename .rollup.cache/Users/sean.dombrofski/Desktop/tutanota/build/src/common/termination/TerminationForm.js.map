{"version":3,"file":"TerminationForm.js","sourceRoot":"","sources":["../../../../src/common/termination/TerminationForm.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { ChildArray, Children, Component, Vnode } from \"mithril\"\nimport { lang } from \"../misc/LanguageViewModel.js\"\nimport { client } from \"../misc/ClientDetector.js\"\nimport { assertNotNull } from \"@tutao/tutanota-utils\"\nimport { Autocomplete, TextField, TextFieldType } from \"../gui/base/TextField.js\"\nimport { DropDownSelector } from \"../gui/base/DropDownSelector.js\"\nimport { TerminationPeriodOptions } from \"../api/common/TutanotaConstants.js\"\nimport { DatePicker } from \"../../calendar-app/calendar/gui/pickers/DatePicker.js\"\nimport { liveDataAttrs } from \"../gui/AriaUtils.js\"\nimport { LoginButton } from \"../gui/base/buttons/LoginButton.js\"\nimport { Button, ButtonType } from \"../gui/base/Button.js\"\nimport { LeavingUserSurveyData, showLeavingUserSurveyWizard } from \"../subscription/LeavingUserSurveyWizard.js\"\nimport { PasswordField } from \"../misc/passwords/PasswordField.js\"\n\nexport interface TerminationFormAttrs {\n\tonSubmit: (surveyData: LeavingUserSurveyData | null) => unknown\n\tmailAddress: string\n\tonMailAddressChanged: (mailAddress: string) => unknown\n\tpassword: string\n\tonPasswordChanged: (password: string) => unknown\n\tdate: Date\n\tonDateChanged: (date: Date) => unknown\n\tterminationPeriodOption: TerminationPeriodOptions\n\tonTerminationPeriodOptionChanged: (option: TerminationPeriodOptions) => unknown\n\thelpText?: string\n}\n\nexport class TerminationForm implements Component<TerminationFormAttrs> {\n\tmailAddressTextField!: TextField\n\tpasswordTextField!: TextField\n\tsurveyResult: LeavingUserSurveyData | null = null\n\n\tonremove(vnode: Vnode<TerminationFormAttrs>) {\n\t\tthis.passwordTextField.domInput.value = \"\"\n\t}\n\n\tview(vnode: Vnode<TerminationFormAttrs>): Children {\n\t\tconst a = vnode.attrs\n\n\t\treturn m(\n\t\t\t\"form\",\n\t\t\t{\n\t\t\t\tonsubmit: (e: SubmitEvent) => {\n\t\t\t\t\t// do not post the form, the form is just here to enable browser auto-fill\n\t\t\t\t\te.preventDefault() // a.onSubmit(a.mailAddress(), a.password())\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(\".h3\", lang.get(\"terminationForm_title\")),\n\t\t\t\tm(\".mt-s\", lang.get(\"termination_text\")),\n\t\t\t\tm(\n\t\t\t\t\t\"\",\n\t\t\t\t\t{\n\t\t\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\t\t\tconst childArray = assertNotNull(vnode.children) as ChildArray\n\t\t\t\t\t\t\tconst child = childArray[0] as Vnode<unknown, TextField>\n\t\t\t\t\t\t\tthis.mailAddressTextField = child.state\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tm(TextField, {\n\t\t\t\t\t\tlabel: \"mailAddress_label\",\n\t\t\t\t\t\tvalue: a.mailAddress,\n\t\t\t\t\t\tautocompleteAs: Autocomplete.email,\n\t\t\t\t\t\toninput: (value) => {\n\t\t\t\t\t\t\tthis.handleAutofill(a)\n\t\t\t\t\t\t\ta.onMailAddressChanged(value)\n\t\t\t\t\t\t},\n\t\t\t\t\t\ttype: TextFieldType.Email,\n\t\t\t\t\t\tonDomInputCreated: (dom) => {\n\t\t\t\t\t\t\tif (!client.isMobileDevice()) {\n\t\t\t\t\t\t\t\tdom.focus() // have email address auto-focus so the user can immediately type their username (unless on mobile)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t),\n\t\t\t\tm(PasswordField, {\n\t\t\t\t\tvalue: a.password,\n\t\t\t\t\tautocompleteAs: Autocomplete.currentPassword,\n\t\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\t\tthis.passwordTextField = { ...vnode.state }\n\t\t\t\t\t},\n\t\t\t\t\tonDomInputCreated: (domInput) => {\n\t\t\t\t\t\tthis.passwordTextField.domInput = domInput\n\t\t\t\t\t},\n\t\t\t\t\toninput: (value) => {\n\t\t\t\t\t\tthis.handleAutofill(a)\n\t\t\t\t\t\ta.onPasswordChanged(value)\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tm(\".list-border-bottom.pb-l\", [\n\t\t\t\t\tm(\".h3.mt-l\", lang.get(\"terminationDateRequest_title\")),\n\t\t\t\t\tm(\".mt-s\", lang.get(\"terminationDateRequest_msg\")),\n\t\t\t\t\tm(DropDownSelector, {\n\t\t\t\t\t\tlabel: \"emptyString_msg\",\n\t\t\t\t\t\tclass: \"\", // by specifying an empty class attribute we remove the padding top for the DropDownSelector\n\t\t\t\t\t\titems: [\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tname: lang.get(\"endOfCurrentSubscriptionPeriod\"),\n\t\t\t\t\t\t\t\tvalue: TerminationPeriodOptions.EndOfCurrentPeriod,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tname: lang.get(\"futureDate\"),\n\t\t\t\t\t\t\t\tvalue: TerminationPeriodOptions.FutureDate,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t\tselectedValue: a.terminationPeriodOption,\n\t\t\t\t\t\tselectionChangedHandler: a.onTerminationPeriodOptionChanged,\n\t\t\t\t\t\tdropdownWidth: 350,\n\t\t\t\t\t\thelpLabel: () => this.renderTerminationDateInfo(a.terminationPeriodOption),\n\t\t\t\t\t}),\n\t\t\t\t\ta.terminationPeriodOption === TerminationPeriodOptions.FutureDate\n\t\t\t\t\t\t? m(DatePicker, {\n\t\t\t\t\t\t\t\tdate: a.date,\n\t\t\t\t\t\t\t\tonDateSelected: a.onDateChanged,\n\t\t\t\t\t\t\t\tstartOfTheWeekOffset: 0,\n\t\t\t\t\t\t\t\tlabel: \"date_label\",\n\t\t\t\t\t\t\t\tdisabled: false,\n\t\t\t\t\t\t  })\n\t\t\t\t\t\t: null,\n\t\t\t\t]),\n\t\t\t\tm(\".mt-l.text-center\", lang.get(\"surveySecondaryMessageDelete_label\")),\n\t\t\t\tm(\n\t\t\t\t\t\".mt.flex-center\",\n\t\t\t\t\tm(Button, {\n\t\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t\t\tlabel: \"surveyParticipate_action\",\n\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\tshowLeavingUserSurveyWizard(true, false).then((result) => (this.surveyResult = result))\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t),\n\t\t\t\tm(\n\t\t\t\t\t\".mt\",\n\t\t\t\t\tm(LoginButton, {\n\t\t\t\t\t\tlabel: \"termination_action\",\n\t\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\t\ta.onSubmit(this.surveyResult)\n\t\t\t\t\t\t},\n\t\t\t\t\t}),\n\t\t\t\t),\n\t\t\t\tm(\".small.center.statusTextColor.mt.mb\", liveDataAttrs(), [a.helpText]),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate handleAutofill(a: TerminationFormAttrs) {\n\t\t// When iOS does auto-filling (always in WebView as of iOS 12.2 and in older Safari)\n\t\t// it only sends one input/change event for all fields so we didn't know if fields\n\t\t// were updated. So we kindly ask our fields to update themselves with real DOM values.\n\t\trequestAnimationFrame(() => {\n\t\t\tconst oldAddress = a.mailAddress\n\t\t\tconst newAddress = this.mailAddressTextField.domInput.value\n\t\t\tconst oldPassword = a.password\n\t\t\tconst newPassword = this.passwordTextField.domInput.value\n\t\t\t// only update values when they are different or we get stuck in an infinite loop\n\t\t\tif (oldAddress !== newAddress) a.onMailAddressChanged(newAddress)\n\t\t\tif (oldPassword !== newPassword) a.onPasswordChanged(newPassword)\n\t\t})\n\t}\n\n\tprivate renderTerminationDateInfo(terminationPeriodOption: TerminationPeriodOptions): Children {\n\t\tlet infoMessage = lang.get(\n\t\t\tterminationPeriodOption === TerminationPeriodOptions.EndOfCurrentPeriod\n\t\t\t\t? \"terminationOptionEndOfSubscriptionInfo_msg\"\n\t\t\t\t: \"terminationOptionFutureDateInfo_msg\",\n\t\t)\n\t\treturn m(\".small\", infoMessage + \" \" + lang.get(\"terminationUseAccountUntilTermination_msg\"))\n\t}\n}\n"]}