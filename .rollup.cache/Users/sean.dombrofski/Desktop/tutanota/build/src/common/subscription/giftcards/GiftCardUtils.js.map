{"version":3,"file":"GiftCardUtils.js","sourceRoot":"","sources":["../../../../../src/common/subscription/giftcards/GiftCardUtils.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Children } from \"mithril\"\nimport { Icons } from \"../../gui/base/icons/Icons\"\nimport type { CustomerInfo, GiftCard } from \"../../api/entities/sys/TypeRefs.js\"\nimport { CustomerInfoTypeRef, CustomerTypeRef, GiftCardTypeRef } from \"../../api/entities/sys/TypeRefs.js\"\nimport { locator } from \"../../api/main/CommonLocator\"\nimport { lang, MaybeTranslation } from \"../../misc/LanguageViewModel\"\nimport { UserError } from \"../../api/main/UserError\"\nimport { Dialog } from \"../../gui/base/Dialog\"\nimport { ButtonType } from \"../../gui/base/Button.js\"\nimport { DefaultAnimationTime } from \"../../gui/animation/Animations\"\nimport { copyToClipboard } from \"../../misc/ClipboardUtils\"\nimport { BootIcons } from \"../../gui/base/icons/BootIcons\"\nimport { isAndroidApp, isApp } from \"../../api/common/Env\"\nimport { Checkbox } from \"../../gui/base/Checkbox.js\"\nimport { Keys } from \"../../api/common/TutanotaConstants\"\nimport { CURRENT_GIFT_CARD_TERMS_VERSION, renderTermsAndConditionsButton, TermsSection } from \"../TermsAndConditions\"\nimport { IconButton } from \"../../gui/base/IconButton.js\"\nimport { formatPrice } from \"../PriceUtils.js\"\nimport { htmlSanitizer } from \"../../misc/HtmlSanitizer.js\"\nimport { urlEncodeHtmlTags } from \"../../misc/Formatter.js\"\nimport QRCode from \"qrcode-svg\"\n\nexport const enum GiftCardStatus {\n\tDeactivated = \"0\",\n\tUsable = \"1\",\n\tRedeemed = \"2\",\n\tRefunded = \"3\",\n\tDisputed = \"4\",\n}\n\nexport async function getTokenFromUrl(url: string): Promise<{ id: Id; key: string }> {\n\tconst token = url.substring(url.indexOf(\"#\") + 1)\n\n\ttry {\n\t\tif (!token) {\n\t\t\tthrow new Error()\n\t\t}\n\n\t\treturn await locator.giftCardFacade.decodeGiftCardToken(token)\n\t} catch (e) {\n\t\tthrow new UserError(\"invalidGiftCard_msg\")\n\t}\n}\n\nexport function loadGiftCards(customerId: Id): Promise<GiftCard[]> {\n\tconst entityClient = locator.entityClient\n\treturn entityClient\n\t\t.load(CustomerTypeRef, customerId)\n\t\t.then((customer) => entityClient.load(CustomerInfoTypeRef, customer.customerInfo))\n\t\t.then((customerInfo: CustomerInfo) => {\n\t\t\tif (customerInfo.giftCards) {\n\t\t\t\treturn entityClient.loadAll(GiftCardTypeRef, customerInfo.giftCards.items)\n\t\t\t} else {\n\t\t\t\treturn Promise.resolve([])\n\t\t\t}\n\t\t})\n}\n\nexport async function generateGiftCardLink(giftCard: GiftCard): Promise<string> {\n\tconst token = await locator.giftCardFacade.encodeGiftCardToken(giftCard)\n\tconst giftCardBaseUrl = locator.domainConfigProvider().getCurrentDomainConfig().giftCardBaseUrl\n\tconst giftCardUrl = new URL(giftCardBaseUrl)\n\tgiftCardUrl.hash = token\n\treturn giftCardUrl.href\n}\n\nexport function showGiftCardToShare(giftCard: GiftCard) {\n\tgenerateGiftCardLink(giftCard).then((link) => {\n\t\tlet infoMessage: MaybeTranslation = \"emptyString_msg\"\n\t\tconst dialog: Dialog = Dialog.largeDialog(\n\t\t\t{\n\t\t\t\tright: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t\t\tlabel: \"close_alt\",\n\t\t\t\t\t\tclick: () => dialog.close(),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tmiddle: \"giftCard_label\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tview: () => [\n\t\t\t\t\tm(\n\t\t\t\t\t\t\".flex-center.full-width.pt.pb\",\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\".pt-l\", // Needed to center SVG\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\twidth: \"480px\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\trenderGiftCardSvg(parseFloat(giftCard.value), link, giftCard.message),\n\t\t\t\t\t\t),\n\t\t\t\t\t),\n\t\t\t\t\tm(\".flex-center\", [\n\t\t\t\t\t\tm(IconButton, {\n\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\tdialog.close()\n\t\t\t\t\t\t\t\tsetTimeout(\n\t\t\t\t\t\t\t\t\t() => import(\"../../../mail-app/mail/editor/MailEditor\").then((editor) => editor.writeGiftCardMail(link)),\n\t\t\t\t\t\t\t\t\tDefaultAnimationTime,\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttitle: \"shareViaEmail_action\",\n\t\t\t\t\t\t\ticon: BootIcons.Mail,\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tisAndroidApp()\n\t\t\t\t\t\t\t? m(IconButton, {\n\t\t\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t\t\tlocator.systemFacade.shareText(\n\t\t\t\t\t\t\t\t\t\t\tlang.get(\"nativeShareGiftCard_msg\", {\n\t\t\t\t\t\t\t\t\t\t\t\t\"{link}\": link,\n\t\t\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t\t\t\tlang.get(\"nativeShareGiftCard_label\"),\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\ttitle: \"share_action\",\n\t\t\t\t\t\t\t\t\ticon: BootIcons.Share,\n\t\t\t\t\t\t\t  })\n\t\t\t\t\t\t\t: m(IconButton, {\n\t\t\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t\t\tcopyToClipboard(link)\n\t\t\t\t\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\t\t\t\t\tinfoMessage = \"giftCardCopied_msg\"\n\t\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t\t\t.catch(() => {\n\t\t\t\t\t\t\t\t\t\t\t\tinfoMessage = \"copyLinkError_msg\"\n\t\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\ttitle: \"copyToClipboard_action\",\n\t\t\t\t\t\t\t\t\ticon: Icons.Clipboard,\n\t\t\t\t\t\t\t  }),\n\t\t\t\t\t\t!isApp()\n\t\t\t\t\t\t\t? m(IconButton, {\n\t\t\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t\t\tinfoMessage = \"emptyString_msg\"\n\t\t\t\t\t\t\t\t\t\twindow.print()\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\ttitle: \"print_action\",\n\t\t\t\t\t\t\t\t\ticon: Icons.Print,\n\t\t\t\t\t\t\t  })\n\t\t\t\t\t\t\t: null,\n\t\t\t\t\t]),\n\t\t\t\t\tm(\".flex-center\", m(\"small.noprint\", lang.getTranslationText(infoMessage))),\n\t\t\t\t],\n\t\t\t},\n\t\t)\n\t\t\t.addShortcut({\n\t\t\t\tkey: Keys.ESC,\n\t\t\t\texec: () => dialog.close(),\n\t\t\t\thelp: \"close_alt\",\n\t\t\t})\n\t\t\t.show()\n\t})\n}\n\n// Used to get gift-card.svg when `renderGiftCardSvg()` is called and cache it.\nconst giftCardSVGGetter = new (class GiftCardSVGGetter {\n\tprivate static giftCardSvg: string | null = null\n\tprivate static giftCardNoQrSvg: string | null = null\n\n\t// Returns a cached `gift-card.svg` or downloads it if online. Returns a placeholder if offline.\n\tgetWithQr(): string {\n\t\tif (GiftCardSVGGetter.giftCardSvg == null) {\n\t\t\tGiftCardSVGGetter.downloadSVG(\"gift-card\", (rawSVG) => {\n\t\t\t\tGiftCardSVGGetter.giftCardSvg = rawSVG\n\t\t\t\tm.redraw() // Rerender any calling views that use the SVG\n\t\t\t})\n\t\t\treturn GiftCardSVGGetter.getPlaceHolder(\"<rect id='qr-code' width='80' height='80' x='0' y='70'></rect>\")\n\t\t}\n\t\treturn GiftCardSVGGetter.giftCardSvg\n\t}\n\n\t// Returns a cached `gift-card-no-qr.svg` or downloads it if online. Returns a placeholder if offline.\n\tgetNoQr(): string {\n\t\tif (GiftCardSVGGetter.giftCardNoQrSvg == null) {\n\t\t\tGiftCardSVGGetter.downloadSVG(\"gift-card-no-qr\", (rawSVG) => {\n\t\t\t\tGiftCardSVGGetter.giftCardNoQrSvg = rawSVG\n\t\t\t\tm.redraw()\n\t\t\t})\n\t\t\treturn GiftCardSVGGetter.getPlaceHolder()\n\t\t}\n\t\treturn GiftCardSVGGetter.giftCardNoQrSvg\n\t}\n\n\t// Downloads an SVG from the images folder without returning a promise via using a callback\n\tprivate static downloadSVG(fileName: string, onComplete: (rawSVG: string) => void) {\n\t\tfetch(`${window.tutao.appState.prefixWithoutFile}/images/${fileName}.svg`).then(\n\t\t\tasync (res) => {\n\t\t\t\tonComplete(await res.text())\n\t\t\t},\n\t\t\t() => {},\n\t\t)\n\t}\n\n\t// Renders the placeholder gift card, optionally with extra HTML\n\tprivate static getPlaceHolder(extraElements: string = \"\"): string {\n\t\treturn `\n\t\t\t<svg width='480' height='600'>\n\t\t\t\t<text id='card-label' x='0' y='20'></text>\n\t\t\t\t<text id='message' x='0' y='40' fill='#fff'></text>\n\t\t\t\t<text id='price' x='0' y='60'></text>\n\t\t\t\t${extraElements}\n\t\t\t</svg>`\n\t}\n})()\n\nexport function renderGiftCardSvg(price: number, link: string | null, message: string): Children {\n\tconst svg = link == null ? giftCardSVGGetter.getNoQr() : giftCardSVGGetter.getWithQr()\n\tconst svgDocument: Document = new DOMParser().parseFromString(svg, \"image/svg+xml\")\n\n\t// Generate and replace the qrcode placeholder a QR Code to the link if provided\n\tif (link != null) {\n\t\tconst qrCodeElement = getGiftCardElement(svgDocument, \"qr-code\")\n\t\tconst qrCodeWidth = getNumberAttribute(qrCodeElement, \"width\")\n\t\tconst qrCodeHeight = getNumberAttribute(qrCodeElement, \"height\")\n\t\tconst qrCodeXPosition = getNumberAttribute(qrCodeElement, \"x\")\n\t\tconst qrCodeYPosition = getNumberAttribute(qrCodeElement, \"y\")\n\t\tqrCodeElement.outerHTML = renderQRCode(qrCodeXPosition, qrCodeYPosition, qrCodeWidth, qrCodeHeight, link)\n\t}\n\n\tconst labelElement = getGiftCardElement(svgDocument, \"card-label\")\n\tlabelElement.textContent = lang.get(\"giftCard_label\").toUpperCase()\n\n\tconst priceElement = getGiftCardElement(svgDocument, \"price\")\n\tpriceElement.textContent = formatPrice(price, false).replace(/\\s+/g, \"\") + \"€\"\n\t// Append the € symbol manually because in one particular language the € sign is being translated into \"EUR\" using `formatPrice` method\n\n\t// SVG text elements do not have word wrap, so we use an HTML `p` element to avoid word wrapping via JS ourselves\n\t// It would be nice to have this decoupled from the current design of the gift card\n\tconst messageElement = getGiftCardElement(svgDocument, \"message\")\n\tconst messageColor = getAttribute(messageElement, \"fill\")\n\tmessageElement.outerHTML = renderMessage(19, 61, 108, 70, messageColor, message)\n\n\treturn m.trust(svgDocument.documentElement.outerHTML)\n}\n\n// Gets an attribute of an element that has a type of number\nfunction getNumberAttribute(element: Element, attributeName: string): number {\n\tconst raw = element.getAttribute(attributeName)\n\tif (raw == null) {\n\t\tthrow new Error(`Error while rendering gift card: missing attribute ${attributeName} from ${element.id}`)\n\t}\n\treturn Number(raw)\n}\n\nfunction getAttribute(element: Element, attributeName: string): string {\n\tconst raw = element.getAttribute(attributeName)\n\tif (raw == null) {\n\t\tthrow new Error(`Error while rendering gift card: missing attribute ${attributeName} from ${element.id}`)\n\t}\n\treturn raw\n}\n\n// Gets one of the standard gift card elements from an SVG.\nfunction getGiftCardElement(svgDocument: Document, id: \"price\" | \"qr-code\" | \"message\" | \"card-label\"): SVGElement {\n\tconst element = svgDocument.getElementById(id) as SVGElement | null\n\tif (element == null) {\n\t\tthrow new Error(`Error while rendering gift card: missing element ${id}`)\n\t}\n\treturn element\n}\n\n/**\n * Renders a text with word wrapping in an SVG element. (0,0) is the top left.\n * @param x The position of the element on the X Axis.\n * @param y The position of the element on the Y Axis.\n * @param width The width of the text element.\n * @param height The height of the text element.\n * @param color The fill colour of the text element.\n * @param message The text to be displayed in the element.\n */\nfunction renderMessage(x: number, y: number, width: number, height: number, color: string, message: string): string {\n\tconst cleanMessage: string = htmlSanitizer.sanitizeHTML(urlEncodeHtmlTags(message)).html\n\n\tconst lineBreaks = cleanMessage.split(/\\r\\n|\\r|\\n/).length\n\tconst charLength = cleanMessage.length\n\n\tconst fontSizePx = lineBreaks > 4 || charLength > 80 ? \"6px\" : \"7px\"\n\n\treturn `\n\t\t<foreignObject x=\"${x}\" y=\"${y}\" width=\"${width}\" height=\"${height}\" fill=\"${color}\">\n\t\t\t<p xmlns=\"http://www.w3.org/1999/xhtml\"\n\t\t\t   class=\"text-preline text-break color-adjust-exact monospace\"\n\t\t\t   style=\"font-size: ${fontSizePx}; color: ${color}; margin: auto 0 0 0\">\n\t\t\t\t${cleanMessage}\n\t\t\t</p>\n\t\t</foreignObject>`\n}\n\n/**\n * Generates a black-on-white QR Code in SVG form\n * @param x The position on the X Axis of the QR Code. 0 is the far left.\n * @param y The position on the Y Axis of the QR Code. 0 is the top.\n * @param link The link that the generated QR code will lead to when scanned\n * @param height The height in pixels of the resulting QR code\n * @param width The width in pixels of the resulting QR code\n * @return the SVG element of the generated QR code as a `string`\n */\nfunction renderQRCode(x: number, y: number, width: number, height: number, link: string): string {\n\tconst svg = new QRCode({\n\t\theight,\n\t\twidth,\n\t\tcontent: link,\n\t\tbackground: \"#ffffff\",\n\t\tcolor: \"#000000\",\n\t\txmlDeclaration: false,\n\t\tcontainer: \"none\",\n\t\tpadding: 0,\n\t\tjoin: true,\n\t\tpretty: false,\n\t}).svg()\n\tconst qrCode = htmlSanitizer.sanitizeSVG(svg).html\n\n\treturn `<svg x=\"${x}\" y=\"${y}\" width=\"${width}\" height=\"${height}\">${qrCode}</svg>`\n}\n\nexport function renderAcceptGiftCardTermsCheckbox(checked: boolean, onChecked: (checked: boolean) => void, classes?: string): Children {\n\treturn m(Checkbox, {\n\t\tchecked,\n\t\tonChecked,\n\t\tclass: classes,\n\t\tlabel: () => [lang.get(\"termsAndConditions_label\"), m(\"div\", renderTermsAndConditionsButton(TermsSection.GiftCards, CURRENT_GIFT_CARD_TERMS_VERSION))],\n\t})\n}\n"]}