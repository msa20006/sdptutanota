{"version":3,"file":"RecoveryCodeNews.js","sourceRoot":"","sources":["../../../../../../src/common/misc/news/items/RecoveryCodeNews.ts"],"names":[],"mappings":"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","sourcesContent":["import { NewsListItem } from \"../NewsListItem.js\"\nimport m, { Children } from \"mithril\"\nimport { NewsId } from \"../../../api/entities/tutanota/TypeRefs.js\"\nimport { lang } from \"../../LanguageViewModel.js\"\nimport { Button, ButtonType } from \"../../../gui/base/Button.js\"\nimport { NewsModel } from \"../NewsModel.js\"\nimport { Dialog, DialogType } from \"../../../gui/base/Dialog.js\"\nimport { AccessBlockedError, NotAuthenticatedError } from \"../../../api/common/error/RestError.js\"\nimport { daysToMillis, LazyLoaded, noOp, ofClass } from \"@tutao/tutanota-utils\"\nimport { copyToClipboard } from \"../../ClipboardUtils.js\"\nimport { UserController } from \"../../../api/main/UserController.js\"\nimport { progressIcon } from \"../../../gui/base/Icon.js\"\nimport { UserManagementFacade } from \"../../../api/worker/facades/lazy/UserManagementFacade.js\"\nimport { isApp } from \"../../../api/common/Env.js\"\nimport { showRequestPasswordDialog } from \"../../passwords/PasswordRequestDialog.js\"\nimport { RecoverCodeFacade } from \"../../../api/worker/facades/lazy/RecoverCodeFacade.js\"\n\n/**\n * News item that informs admin users about their recovery code.\n */\nexport class RecoveryCodeNews implements NewsListItem {\n\tprivate recoveryCode: string | null = null\n\tprivate readonly recoverCodeField = new LazyLoaded(async () => {\n\t\tconst { RecoverCodeField } = await import(\"../../../settings/login/RecoverCodeDialog.js\")\n\t\tm.redraw()\n\t\treturn RecoverCodeField\n\t})\n\n\tconstructor(\n\t\tprivate readonly newsModel: NewsModel,\n\t\tprivate readonly userController: UserController,\n\t\tprivate readonly recoverCodeFacade: RecoverCodeFacade,\n\t) {}\n\n\tisShown(newsId: NewsId): Promise<boolean> {\n\t\tconst customerCreationTime = this.userController.userGroupInfo.created.getTime()\n\t\treturn Promise.resolve(this.userController.isGlobalAdmin() && Date.now() - customerCreationTime > daysToMillis(14))\n\t}\n\n\trender(newsId: NewsId): Children {\n\t\tconst recoveryCode = this.recoveryCode\n\t\t// toggle the load if it's not started yet\n\t\tthis.recoverCodeField.getAsync()\n\n\t\t// Will (always) be null on the first call of render() since getAsync() was just called for the first time.\n\t\t// When the redraw is triggered in the load function, it will be populated and rendered correctly.\n\t\tconst RecoverCodeField = this.recoverCodeField.getSync()\n\n\t\treturn m(\".full-width\", [\n\t\t\tm(\n\t\t\t\t\".h4\",\n\t\t\t\t{\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\"text-transform\": \"capitalize\",\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tlang.get(\"recoveryCode_label\"),\n\t\t\t),\n\t\t\tm(\"\", lang.get(\"recoveryCodeReminder_msg\")),\n\t\t\trecoveryCode\n\t\t\t\t? RecoverCodeField\n\t\t\t\t\t? m(RecoverCodeField, {\n\t\t\t\t\t\t\tshowMessage: false,\n\t\t\t\t\t\t\trecoverCode: recoveryCode as string,\n\t\t\t\t\t\t\tshowButtons: false,\n\t\t\t\t\t  })\n\t\t\t\t\t: m(\".flex.justify-center\", progressIcon())\n\t\t\t\t: null,\n\t\t\tm(\".flex-end.flex-no-grow-no-shrink-auto.flex-wrap\", [\n\t\t\t\trecoveryCode\n\t\t\t\t\t? [this.renderCopyButton(recoveryCode), this.renderPrintButton(), this.confirmButton(newsId)]\n\t\t\t\t\t: [this.renderDoneButton(newsId), this.renderDisplayButton()],\n\t\t\t]),\n\t\t])\n\t}\n\n\tprivate renderDoneButton(newsId: NewsId) {\n\t\treturn m(Button, {\n\t\t\tlabel: \"done_action\",\n\t\t\ttype: ButtonType.Secondary,\n\t\t\tclick: () =>\n\t\t\t\tDialog.showActionDialog({\n\t\t\t\t\ttype: DialogType.EditSmall,\n\t\t\t\t\tokAction: async (dialog) => {\n\t\t\t\t\t\tdialog.close()\n\t\t\t\t\t\tthis.newsModel.acknowledgeNews(newsId.newsItemId).then(m.redraw)\n\t\t\t\t\t},\n\t\t\t\t\ttitle: \"recoveryCode_label\",\n\t\t\t\t\tallowCancel: true,\n\t\t\t\t\tchild: () => m(\"p\", lang.get(\"recoveryCodeConfirmation_msg\")),\n\t\t\t\t}),\n\t\t})\n\t}\n\n\tprivate renderPrintButton(): Children {\n\t\tif (isApp() || typeof window.print !== \"function\") {\n\t\t\treturn null\n\t\t}\n\n\t\treturn m(Button, {\n\t\t\tlabel: \"print_action\",\n\t\t\ttype: ButtonType.Secondary,\n\t\t\tclick: () => {\n\t\t\t\twindow.print()\n\t\t\t},\n\t\t})\n\t}\n\n\tprivate renderCopyButton(recoveryCode: string): Children {\n\t\treturn m(Button, {\n\t\t\tlabel: \"copy_action\",\n\t\t\ttype: ButtonType.Secondary,\n\t\t\tclick: () => {\n\t\t\t\tcopyToClipboard(recoveryCode)\n\t\t\t},\n\t\t})\n\t}\n\n\tprivate renderDisplayButton(): Children {\n\t\treturn m(Button, {\n\t\t\tlabel: \"recoveryCodeDisplay_action\",\n\t\t\tclick: async () => {\n\t\t\t\tthis.getRecoverCodeDialogAfterPasswordVerification(this.userController)\n\t\t\t},\n\t\t\ttype: ButtonType.Primary,\n\t\t})\n\t}\n\n\tprivate confirmButton(newsId: NewsId): Children {\n\t\treturn m(Button, {\n\t\t\tlabel: \"paymentDataValidation_action\",\n\t\t\tclick: async () => {\n\t\t\t\tawait this.newsModel.acknowledgeNews(newsId.newsItemId)\n\t\t\t\tm.redraw()\n\t\t\t},\n\t\t\ttype: ButtonType.Primary,\n\t\t})\n\t}\n\n\tprivate getRecoverCodeDialogAfterPasswordVerification(userController: UserController) {\n\t\tconst dialog = showRequestPasswordDialog({\n\t\t\taction: (pw) => {\n\t\t\t\tconst hasRecoveryCode = !!userController.user.auth?.recoverCode\n\n\t\t\t\treturn (hasRecoveryCode ? this.recoverCodeFacade.getRecoverCodeHex(pw) : this.recoverCodeFacade.createRecoveryCode(pw))\n\t\t\t\t\t.then((recoverCode) => {\n\t\t\t\t\t\tdialog.close()\n\t\t\t\t\t\tthis.recoveryCode = recoverCode\n\t\t\t\t\t\treturn \"\"\n\t\t\t\t\t})\n\t\t\t\t\t.catch(ofClass(NotAuthenticatedError, () => lang.get(\"invalidPassword_msg\")))\n\t\t\t\t\t.catch(ofClass(AccessBlockedError, () => lang.get(\"tooManyAttempts_msg\")))\n\t\t\t\t\t.finally(m.redraw)\n\t\t\t},\n\t\t\tcancel: {\n\t\t\t\ttextId: \"cancel_action\",\n\t\t\t\taction: noOp,\n\t\t\t},\n\t\t})\n\t}\n}\n"]}