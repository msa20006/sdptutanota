{"version":3,"file":"PaymentViewer.js","sourceRoot":"","sources":["../../../../src/common/subscription/PaymentViewer.ts"],"names":[],"mappings":"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","sourcesContent":["import m, { Children } from \"mithril\"\nimport { assertMainOrNode, isIOSApp } from \"../api/common/Env\"\nimport { assertNotNull, last, neverNull, ofClass } from \"@tutao/tutanota-utils\"\nimport { InfoLink, lang, TranslationKey } from \"../misc/LanguageViewModel\"\nimport {\n\tAccountingInfo,\n\tAccountingInfoTypeRef,\n\tBookingTypeRef,\n\tcreateDebitServicePutData,\n\tCustomer,\n\tCustomerTypeRef,\n\tInvoiceInfo,\n\tInvoiceInfoTypeRef,\n} from \"../api/entities/sys/TypeRefs.js\"\nimport { HtmlEditor, HtmlEditorMode } from \"../gui/editor/HtmlEditor\"\nimport { formatPrice, getPaymentMethodInfoText, getPaymentMethodName } from \"./PriceUtils\"\nimport * as InvoiceDataDialog from \"./InvoiceDataDialog\"\nimport { Icons } from \"../gui/base/icons/Icons\"\nimport { ColumnWidth, Table, TableLineAttrs } from \"../gui/base/Table.js\"\nimport { ButtonType } from \"../gui/base/Button.js\"\nimport { formatDate } from \"../misc/Formatter\"\nimport {\n\tAccountType,\n\tAvailablePlans,\n\tgetDefaultPaymentMethod,\n\tgetPaymentMethodType,\n\tNewPaidPlans,\n\tPaymentMethodType,\n\tPostingType,\n} from \"../api/common/TutanotaConstants\"\nimport { BadGatewayError, LockedError, PreconditionFailedError, TooManyRequestsError } from \"../api/common/error/RestError\"\nimport { Dialog, DialogType } from \"../gui/base/Dialog\"\nimport { getByAbbreviation } from \"../api/common/CountryList\"\nimport * as PaymentDataDialog from \"./PaymentDataDialog\"\nimport { showProgressDialog } from \"../gui/dialogs/ProgressDialog\"\nimport { getPreconditionFailedPaymentMsg, hasRunningAppStoreSubscription } from \"./SubscriptionUtils\"\nimport type { DialogHeaderBarAttrs } from \"../gui/base/DialogHeaderBar\"\nimport { DialogHeaderBar } from \"../gui/base/DialogHeaderBar\"\nimport { TextField } from \"../gui/base/TextField.js\"\nimport type { CustomerAccountPosting } from \"../api/entities/accounting/TypeRefs\"\nimport { ExpanderButton, ExpanderPanel } from \"../gui/base/Expander\"\nimport { locator } from \"../api/main/CommonLocator\"\nimport { createNotAvailableForFreeClickHandler } from \"../misc/SubscriptionDialogs\"\nimport { TranslationKeyType } from \"../misc/TranslationKey\"\nimport { CustomerAccountService } from \"../api/entities/accounting/Services\"\nimport { DebitService } from \"../api/entities/sys/Services\"\nimport { IconButton } from \"../gui/base/IconButton.js\"\nimport { ButtonSize } from \"../gui/base/ButtonSize.js\"\nimport { formatNameAndAddress } from \"../api/common/utils/CommonFormatter.js\"\nimport { client } from \"../misc/ClientDetector.js\"\nimport { DeviceType } from \"../misc/ClientConstants.js\"\nimport { EntityUpdateData, isUpdateForTypeRef } from \"../api/common/utils/EntityUpdateUtils.js\"\nimport { LoginButton } from \"../gui/base/buttons/LoginButton.js\"\nimport type { UpdatableSettingsViewer } from \"../settings/Interfaces.js\"\nimport { ProgrammingError } from \"../api/common/error/ProgrammingError.js\"\nimport { showSwitchDialog } from \"./SwitchSubscriptionDialog.js\"\nimport { GENERATED_MAX_ID } from \"../api/common/utils/EntityUtils.js\"\nimport { createDropdown } from \"../gui/base/Dropdown.js\"\n\nassertMainOrNode()\n\n/**\n * Displays payment method/invoice data and allows changing them.\n */\nexport class PaymentViewer implements UpdatableSettingsViewer {\n\tprivate readonly invoiceAddressField: HtmlEditor\n\tprivate customer: Customer | null = null\n\tprivate accountingInfo: AccountingInfo | null = null\n\tprivate postings: readonly CustomerAccountPosting[] = []\n\tprivate outstandingBookingsPrice: number | null = null\n\tprivate balance: number = 0\n\tprivate invoiceInfo: InvoiceInfo | null = null\n\tprivate postingsExpanded: boolean = false\n\n\tconstructor() {\n\t\tthis.invoiceAddressField = new HtmlEditor()\n\t\t\t.setMinHeight(140)\n\t\t\t.showBorders()\n\t\t\t.setMode(HtmlEditorMode.HTML)\n\t\t\t.setHtmlMonospace(false)\n\t\t\t.setReadOnly(true)\n\t\t\t.setPlaceholderId(\"invoiceAddress_label\")\n\t\tthis.loadData()\n\t\tthis.view = this.view.bind(this)\n\t}\n\n\tview(): Children {\n\t\treturn m(\n\t\t\t\"#invoicing-settings.fill-absolute.scroll.plr-l\",\n\t\t\t{\n\t\t\t\trole: \"group\",\n\t\t\t},\n\t\t\t[this.renderInvoiceData(), this.renderPaymentMethod(), this.renderPostings()],\n\t\t)\n\t}\n\n\tprivate async loadData() {\n\t\tthis.customer = await locator.logins.getUserController().loadCustomer()\n\t\tconst customerInfo = await locator.logins.getUserController().loadCustomerInfo()\n\n\t\tconst accountingInfo = await locator.entityClient.load(AccountingInfoTypeRef, customerInfo.accountingInfo)\n\t\tthis.updateAccountingInfoData(accountingInfo)\n\t\tthis.invoiceInfo = await locator.entityClient.load(InvoiceInfoTypeRef, neverNull(accountingInfo.invoiceInfo))\n\t\tm.redraw()\n\t\tawait this.loadPostings()\n\t}\n\n\tprivate renderPaymentMethod(): Children {\n\t\tconst paymentMethodHelpLabel = () => {\n\t\t\tif (this.accountingInfo && getPaymentMethodType(this.accountingInfo) === PaymentMethodType.Invoice) {\n\t\t\t\treturn lang.get(\"paymentProcessingTime_msg\")\n\t\t\t}\n\n\t\t\treturn \"\"\n\t\t}\n\n\t\tconst paymentMethod = this.accountingInfo\n\t\t\t? getPaymentMethodName(getPaymentMethodType(neverNull(this.accountingInfo))) + \" \" + getPaymentMethodInfoText(neverNull(this.accountingInfo))\n\t\t\t: lang.get(\"loading_msg\")\n\n\t\treturn m(TextField, {\n\t\t\tlabel: \"paymentMethod_label\",\n\t\t\tvalue: paymentMethod,\n\t\t\thelpLabel: paymentMethodHelpLabel,\n\t\t\tisReadOnly: true,\n\t\t\tinjectionsRight: () =>\n\t\t\t\tm(IconButton, {\n\t\t\t\t\ttitle: \"paymentMethod_label\",\n\t\t\t\t\tclick: (e, dom) => this.handlePaymentMethodClick(e, dom),\n\t\t\t\t\ticon: Icons.Edit,\n\t\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\t}),\n\t\t})\n\t}\n\n\tprivate async handlePaymentMethodClick(e: MouseEvent, dom: HTMLElement) {\n\t\tif (this.accountingInfo == null) {\n\t\t\treturn\n\t\t}\n\t\tconst currentPaymentMethod: PaymentMethodType | null = getPaymentMethodType(this.accountingInfo)\n\t\tif (isIOSApp()) {\n\t\t\t// Paid users trying to change payment method on iOS with an active subscription\n\t\t\tif (currentPaymentMethod !== PaymentMethodType.AppStore && this.customer?.type === AccountType.PAID) {\n\t\t\t\treturn Dialog.message(lang.getTranslation(\"storePaymentMethodChange_msg\", { \"{AppStorePaymentChange}\": InfoLink.AppStorePaymentChange }))\n\t\t\t}\n\n\t\t\treturn locator.mobilePaymentsFacade.showSubscriptionConfigView()\n\t\t} else if (hasRunningAppStoreSubscription(this.accountingInfo)) {\n\t\t\treturn showManageThroughAppStoreDialog()\n\t\t} else if (currentPaymentMethod == PaymentMethodType.AppStore && this.customer?.type === AccountType.PAID) {\n\t\t\t// For now we do not allow changing payment method for Paid accounts that use AppStore,\n\t\t\t// they must downgrade to Free first.\n\n\t\t\tconst isResubscribe = await Dialog.choice(\n\t\t\t\tlang.getTranslation(\"storeDowngradeOrResubscribe_msg\", { \"{AppStoreDowngrade}\": InfoLink.AppStoreDowngrade }),\n\t\t\t\t[\n\t\t\t\t\t{\n\t\t\t\t\t\ttext: \"changePlan_action\",\n\t\t\t\t\t\tvalue: false,\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\ttext: \"resubscribe_action\",\n\t\t\t\t\t\tvalue: true,\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t)\n\t\t\tif (isResubscribe) {\n\t\t\t\treturn showManageThroughAppStoreDialog()\n\t\t\t} else {\n\t\t\t\tconst customerInfo = await locator.logins.getUserController().loadCustomerInfo()\n\t\t\t\tconst bookings = await locator.entityClient.loadRange(BookingTypeRef, assertNotNull(customerInfo.bookings).items, GENERATED_MAX_ID, 1, true)\n\t\t\t\tconst lastBooking = last(bookings)\n\t\t\t\tif (lastBooking == null) {\n\t\t\t\t\tconsole.warn(\"No booking but payment method is AppStore?\")\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\treturn showSwitchDialog(this.customer, customerInfo, this.accountingInfo, lastBooking, AvailablePlans, null)\n\t\t\t}\n\t\t} else {\n\t\t\tconst showPaymentMethodDialog = createNotAvailableForFreeClickHandler(\n\t\t\t\tNewPaidPlans,\n\t\t\t\t() => this.accountingInfo && this.changePaymentMethod(),\n\t\t\t\t// iOS app is checked above\n\t\t\t\t() => locator.logins.getUserController().isPaidAccount(),\n\t\t\t)\n\n\t\t\tshowPaymentMethodDialog(e, dom)\n\t\t}\n\t}\n\n\tprivate changeInvoiceData() {\n\t\tif (this.accountingInfo) {\n\t\t\tconst accountingInfo = neverNull(this.accountingInfo)\n\t\t\tconst invoiceCountry = accountingInfo.invoiceCountry ? getByAbbreviation(accountingInfo.invoiceCountry) : null\n\t\t\tInvoiceDataDialog.show(\n\t\t\t\tneverNull(neverNull(this.customer).businessUse),\n\t\t\t\t{\n\t\t\t\t\tinvoiceAddress: formatNameAndAddress(accountingInfo.invoiceName, accountingInfo.invoiceAddress),\n\t\t\t\t\tcountry: invoiceCountry,\n\t\t\t\t\tvatNumber: accountingInfo.invoiceVatIdNo,\n\t\t\t\t},\n\t\t\t\taccountingInfo,\n\t\t\t)\n\t\t}\n\t}\n\n\tprivate changePaymentMethod() {\n\t\tif (this.accountingInfo && hasRunningAppStoreSubscription(this.accountingInfo)) {\n\t\t\tthrow new ProgrammingError(\"Active AppStore subscription\")\n\t\t}\n\n\t\tlet nextPayment = this.amountOwed() * -1\n\t\tshowProgressDialog(\n\t\t\t\"pleaseWait_msg\",\n\t\t\tlocator.bookingFacade.getCurrentPrice().then((priceServiceReturn) => {\n\t\t\t\treturn Math.max(\n\t\t\t\t\tnextPayment,\n\t\t\t\t\tNumber(neverNull(priceServiceReturn.currentPriceThisPeriod).price),\n\t\t\t\t\tNumber(neverNull(priceServiceReturn.currentPriceNextPeriod).price),\n\t\t\t\t)\n\t\t\t}),\n\t\t)\n\t\t\t.then((price) =>\n\t\t\t\tgetDefaultPaymentMethod().then((paymentMethod) => {\n\t\t\t\t\treturn { price, paymentMethod }\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.then(({ price, paymentMethod }) => {\n\t\t\t\treturn PaymentDataDialog.show(neverNull(this.customer), neverNull(this.accountingInfo), price, paymentMethod).then((success) => {\n\t\t\t\t\tif (success) {\n\t\t\t\t\t\tif (this.isPayButtonVisible()) {\n\t\t\t\t\t\t\treturn this.showPayDialog(this.amountOwed())\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t}\n\n\tprivate renderPostings(): Children {\n\t\tif (!this.postings || this.postings.length === 0) {\n\t\t\treturn null\n\t\t} else {\n\t\t\tconst balance = this.balance\n\t\t\treturn [\n\t\t\t\tm(\".h4.mt-l\", lang.get(\"currentBalance_label\")),\n\t\t\t\tm(\".flex.center-horizontally.center-vertically.col\", [\n\t\t\t\t\tm(\n\t\t\t\t\t\t\"div.h4.pt.pb\" + (this.isAmountOwed() ? \".content-accent-fg\" : \"\"),\n\t\t\t\t\t\tformatPrice(balance, true) + (this.accountBalance() !== balance ? ` (${formatPrice(this.accountBalance(), true)})` : \"\"),\n\t\t\t\t\t),\n\t\t\t\t\tthis.accountBalance() !== balance\n\t\t\t\t\t\t? m(\n\t\t\t\t\t\t\t\t\".small\" + (this.accountBalance() < 0 ? \".content-accent-fg\" : \"\"),\n\t\t\t\t\t\t\t\tlang.get(\"unprocessedBookings_msg\", {\n\t\t\t\t\t\t\t\t\t\"{amount}\": formatPrice(assertNotNull(this.outstandingBookingsPrice), true),\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t: null,\n\t\t\t\t\tthis.isPayButtonVisible()\n\t\t\t\t\t\t? m(\n\t\t\t\t\t\t\t\t\".pb\",\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\twidth: \"200px\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tm(LoginButton, {\n\t\t\t\t\t\t\t\t\tlabel: \"invoicePay_action\",\n\t\t\t\t\t\t\t\t\tonclick: () => this.showPayDialog(this.amountOwed()),\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t: null,\n\t\t\t\t]),\n\t\t\t\tthis.accountingInfo &&\n\t\t\t\tthis.accountingInfo.paymentMethod !== PaymentMethodType.Invoice &&\n\t\t\t\t(this.isAmountOwed() || (this.invoiceInfo && this.invoiceInfo.paymentErrorInfo))\n\t\t\t\t\t? this.invoiceInfo && this.invoiceInfo.paymentErrorInfo\n\t\t\t\t\t\t? m(\".small.underline.b\", lang.get(getPreconditionFailedPaymentMsg(this.invoiceInfo.paymentErrorInfo.errorCode)))\n\t\t\t\t\t\t: m(\".small.underline.b\", lang.get(\"failedDebitAttempt_msg\"))\n\t\t\t\t\t: null,\n\t\t\t\tm(\".flex-space-between.items-center.mt-l.mb-s\", [\n\t\t\t\t\tm(\".h4\", lang.get(\"postings_label\")),\n\t\t\t\t\tm(ExpanderButton, {\n\t\t\t\t\t\tlabel: \"show_action\",\n\t\t\t\t\t\texpanded: this.postingsExpanded,\n\t\t\t\t\t\tonExpandedChange: (expanded) => (this.postingsExpanded = expanded),\n\t\t\t\t\t}),\n\t\t\t\t]),\n\t\t\t\tm(\n\t\t\t\t\tExpanderPanel,\n\t\t\t\t\t{\n\t\t\t\t\t\texpanded: this.postingsExpanded,\n\t\t\t\t\t},\n\t\t\t\t\tm(Table, {\n\t\t\t\t\t\tcolumnHeading: [\"type_label\", \"amount_label\"],\n\t\t\t\t\t\tcolumnWidths: [ColumnWidth.Largest, ColumnWidth.Small, ColumnWidth.Small],\n\t\t\t\t\t\tcolumnAlignments: [false, true, false],\n\t\t\t\t\t\tshowActionButtonColumn: true,\n\t\t\t\t\t\tlines: this.postings.map((posting: CustomerAccountPosting) => this.postingLineAttrs(posting)),\n\t\t\t\t\t}),\n\t\t\t\t),\n\t\t\t\tm(\".small\", lang.get(\"invoiceSettingDescription_msg\") + \" \" + lang.get(\"laterInvoicingInfo_msg\")),\n\t\t\t]\n\t\t}\n\t}\n\n\tprivate postingLineAttrs(posting: CustomerAccountPosting): TableLineAttrs {\n\t\treturn {\n\t\t\tcells: () => [\n\t\t\t\t{\n\t\t\t\t\tmain: getPostingTypeText(posting),\n\t\t\t\t\tinfo: [formatDate(posting.valueDate)],\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tmain: formatPrice(Number(posting.amount), true),\n\t\t\t\t},\n\t\t\t],\n\t\t\tactionButtonAttrs:\n\t\t\t\tposting.type === PostingType.UsageFee || posting.type === PostingType.Credit || posting.type === PostingType.SalesCommission\n\t\t\t\t\t? {\n\t\t\t\t\t\t\ttitle: \"download_action\",\n\t\t\t\t\t\t\ticon: Icons.Download,\n\t\t\t\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\t\t\t\tclick: (e, dom) => {\n\t\t\t\t\t\t\t\tif (this.customer?.businessUse) {\n\t\t\t\t\t\t\t\t\tcreateDropdown({\n\t\t\t\t\t\t\t\t\t\twidth: 300,\n\t\t\t\t\t\t\t\t\t\tlazyButtons: () => [\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\tlabel: \"downloadInvoicePdf_action\",\n\t\t\t\t\t\t\t\t\t\t\t\tclick: () => this.doPdfInvoiceDownload(posting),\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\tlabel: \"downloadInvoiceXml_action\",\n\t\t\t\t\t\t\t\t\t\t\t\tclick: () => this.doXrechnungInvoiceDownload(posting),\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\t})(e, dom)\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tthis.doPdfInvoiceDownload(posting)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t  }\n\t\t\t\t\t: null,\n\t\t}\n\t}\n\n\tprivate async doPdfInvoiceDownload(posting: CustomerAccountPosting): Promise<unknown> {\n\t\tif (client.compressionStreamSupported()) {\n\t\t\treturn showProgressDialog(\"pleaseWait_msg\", locator.customerFacade.generatePdfInvoice(neverNull(posting.invoiceNumber))).then((pdfInvoice) =>\n\t\t\t\tlocator.fileController.saveDataFile(pdfInvoice),\n\t\t\t)\n\t\t} else {\n\t\t\tif (client.device == DeviceType.ANDROID) {\n\t\t\t\treturn Dialog.message(\"invoiceFailedWebview_msg\", () => m(\"div\", m(\"a\", { href: InfoLink.Webview, target: \"_blank\" }, InfoLink.Webview)))\n\t\t\t} else if (client.isIos()) {\n\t\t\t\treturn Dialog.message(\"invoiceFailedIOS_msg\")\n\t\t\t} else {\n\t\t\t\treturn Dialog.message(\"invoiceFailedBrowser_msg\")\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async doXrechnungInvoiceDownload(posting: CustomerAccountPosting) {\n\t\treturn showProgressDialog(\n\t\t\t\"pleaseWait_msg\",\n\t\t\tlocator.customerFacade.generateXRechnungInvoice(neverNull(posting.invoiceNumber)).then((xInvoice) => locator.fileController.saveDataFile(xInvoice)),\n\t\t)\n\t}\n\n\tprivate updateAccountingInfoData(accountingInfo: AccountingInfo) {\n\t\tthis.accountingInfo = accountingInfo\n\n\t\tthis.invoiceAddressField.setValue(\n\t\t\tformatNameAndAddress(accountingInfo.invoiceName, accountingInfo.invoiceAddress, accountingInfo.invoiceCountry ?? undefined),\n\t\t)\n\n\t\tm.redraw()\n\t}\n\n\tprivate accountBalance(): number {\n\t\treturn this.balance - assertNotNull(this.outstandingBookingsPrice)\n\t}\n\n\tprivate amountOwed(): number {\n\t\tif (this.balance != null) {\n\t\t\tlet balance = this.balance\n\n\t\t\tif (balance < 0) {\n\t\t\t\treturn balance\n\t\t\t}\n\t\t}\n\n\t\treturn 0\n\t}\n\n\tprivate isAmountOwed(): boolean {\n\t\treturn this.amountOwed() < 0\n\t}\n\n\tprivate loadPostings(): Promise<void> {\n\t\treturn locator.serviceExecutor.get(CustomerAccountService, null).then((result) => {\n\t\t\tthis.postings = result.postings\n\t\t\tthis.outstandingBookingsPrice = Number(result.outstandingBookingsPrice)\n\t\t\tthis.balance = Number(result.balance)\n\t\t\tm.redraw()\n\t\t})\n\t}\n\n\tasync entityEventsReceived(updates: ReadonlyArray<EntityUpdateData>): Promise<void> {\n\t\tfor (const update of updates) {\n\t\t\tawait this.processEntityUpdate(update)\n\t\t}\n\t}\n\n\tprivate async processEntityUpdate(update: EntityUpdateData): Promise<void> {\n\t\tconst { instanceId } = update\n\n\t\tif (isUpdateForTypeRef(AccountingInfoTypeRef, update)) {\n\t\t\tconst accountingInfo = await locator.entityClient.load(AccountingInfoTypeRef, instanceId)\n\t\t\tthis.updateAccountingInfoData(accountingInfo)\n\t\t} else if (isUpdateForTypeRef(CustomerTypeRef, update)) {\n\t\t\tthis.customer = await locator.logins.getUserController().loadCustomer()\n\t\t\tm.redraw()\n\t\t} else if (isUpdateForTypeRef(InvoiceInfoTypeRef, update)) {\n\t\t\tthis.invoiceInfo = await locator.entityClient.load(InvoiceInfoTypeRef, instanceId)\n\t\t\tm.redraw()\n\t\t}\n\t}\n\n\tprivate isPayButtonVisible(): boolean {\n\t\treturn (\n\t\t\tthis.accountingInfo != null &&\n\t\t\t(this.accountingInfo.paymentMethod === PaymentMethodType.CreditCard || this.accountingInfo.paymentMethod === PaymentMethodType.Paypal) &&\n\t\t\tthis.isAmountOwed()\n\t\t)\n\t}\n\n\tprivate showPayDialog(openBalance: number): Promise<void> {\n\t\treturn showPayConfirmDialog(openBalance)\n\t\t\t.then((confirmed) => {\n\t\t\t\tif (confirmed) {\n\t\t\t\t\treturn showProgressDialog(\n\t\t\t\t\t\t\"pleaseWait_msg\",\n\t\t\t\t\t\tlocator.serviceExecutor\n\t\t\t\t\t\t\t.put(DebitService, createDebitServicePutData({ invoice: null }))\n\t\t\t\t\t\t\t.catch(ofClass(LockedError, () => \"operationStillActive_msg\" as TranslationKey))\n\t\t\t\t\t\t\t.catch(ofClass(PreconditionFailedError, (error) => getPreconditionFailedPaymentMsg(error.data)))\n\t\t\t\t\t\t\t.catch(ofClass(BadGatewayError, () => \"paymentProviderNotAvailableError_msg\" as TranslationKey))\n\t\t\t\t\t\t\t.catch(ofClass(TooManyRequestsError, () => \"tooManyAttempts_msg\" as TranslationKey)),\n\t\t\t\t\t)\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then((errorId: TranslationKeyType | void) => {\n\t\t\t\tif (errorId) {\n\t\t\t\t\treturn Dialog.message(errorId)\n\t\t\t\t} else {\n\t\t\t\t\treturn this.loadPostings()\n\t\t\t\t}\n\t\t\t})\n\t}\n\n\tprivate renderInvoiceData(): Children {\n\t\treturn [\n\t\t\tm(\".flex-space-between.items-center.mt-l.mb-s\", [\n\t\t\t\tm(\".h4\", lang.get(\"invoiceData_msg\")),\n\t\t\t\tm(IconButton, {\n\t\t\t\t\ttitle: \"invoiceData_msg\",\n\t\t\t\t\tclick: createNotAvailableForFreeClickHandler(\n\t\t\t\t\t\tNewPaidPlans,\n\t\t\t\t\t\t() => this.changeInvoiceData(),\n\t\t\t\t\t\t() => locator.logins.getUserController().isPaidAccount(),\n\t\t\t\t\t),\n\t\t\t\t\ticon: Icons.Edit,\n\t\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\t}),\n\t\t\t]),\n\t\t\tm(this.invoiceAddressField),\n\t\t\tthis.accountingInfo && this.accountingInfo.invoiceVatIdNo.trim().length > 0\n\t\t\t\t? m(TextField, {\n\t\t\t\t\t\tlabel: \"invoiceVatIdNo_label\",\n\t\t\t\t\t\tvalue: this.accountingInfo ? this.accountingInfo.invoiceVatIdNo : lang.get(\"loading_msg\"),\n\t\t\t\t\t\tisReadOnly: true,\n\t\t\t\t  })\n\t\t\t\t: null,\n\t\t]\n\t}\n}\n\nfunction showPayConfirmDialog(price: number): Promise<boolean> {\n\treturn new Promise((resolve) => {\n\t\tlet dialog: Dialog\n\n\t\tconst doAction = (res: boolean) => {\n\t\t\tdialog.close()\n\t\t\tresolve(res)\n\t\t}\n\n\t\tconst actionBarAttrs: DialogHeaderBarAttrs = {\n\t\t\tleft: [\n\t\t\t\t{\n\t\t\t\t\tlabel: \"cancel_action\",\n\t\t\t\t\tclick: () => doAction(false),\n\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t},\n\t\t\t],\n\t\t\tright: [\n\t\t\t\t{\n\t\t\t\t\tlabel: \"invoicePay_action\",\n\t\t\t\t\tclick: () => doAction(true),\n\t\t\t\t\ttype: ButtonType.Primary,\n\t\t\t\t},\n\t\t\t],\n\t\t\tmiddle: \"adminPayment_action\",\n\t\t}\n\t\tdialog = new Dialog(DialogType.EditSmall, {\n\t\t\tview: (): Children => [\n\t\t\t\tm(DialogHeaderBar, actionBarAttrs),\n\t\t\t\tm(\n\t\t\t\t\t\".plr-l.pb\",\n\t\t\t\t\tm(\"\", [\n\t\t\t\t\t\tm(\".pt\", lang.get(\"invoicePayConfirm_msg\")),\n\t\t\t\t\t\tm(TextField, {\n\t\t\t\t\t\t\tlabel: \"price_label\",\n\t\t\t\t\t\t\tvalue: formatPrice(-price, true),\n\t\t\t\t\t\t\tisReadOnly: true,\n\t\t\t\t\t\t}),\n\t\t\t\t\t]),\n\t\t\t\t),\n\t\t\t],\n\t\t})\n\t\t\t.setCloseHandler(() => doAction(false))\n\t\t\t.show()\n\t})\n}\n\nfunction getPostingTypeText(posting: CustomerAccountPosting): string {\n\tswitch (posting.type) {\n\t\tcase PostingType.UsageFee:\n\t\t\treturn lang.get(\"invoice_label\")\n\n\t\tcase PostingType.Credit:\n\t\t\treturn lang.get(\"credit_label\")\n\n\t\tcase PostingType.Payment:\n\t\t\treturn lang.get(\"adminPayment_action\")\n\n\t\tcase PostingType.Refund:\n\t\t\treturn lang.get(\"refund_label\")\n\n\t\tcase PostingType.GiftCard:\n\t\t\treturn Number(posting.amount) < 0 ? lang.get(\"boughtGiftCardPosting_label\") : lang.get(\"redeemedGiftCardPosting_label\")\n\n\t\tcase PostingType.SalesCommission:\n\t\t\treturn Number(posting.amount) < 0 ? lang.get(\"cancelledReferralCreditPosting_label\") : lang.get(\"referralCreditPosting_label\")\n\n\t\tdefault:\n\t\t\treturn \"\"\n\t\t// Generic, Dispute, Suspension, SuspensionCancel\n\t}\n}\n\nexport async function showManageThroughAppStoreDialog(): Promise<void> {\n\tconst confirmed = await Dialog.confirm(\n\t\tlang.getTranslation(\"storeSubscription_msg\", {\n\t\t\t\"{AppStorePayment}\": InfoLink.AppStorePayment,\n\t\t}),\n\t)\n\tif (confirmed) {\n\t\twindow.open(\"https://apps.apple.com/account/subscriptions\", \"_blank\", \"noopener,noreferrer\")\n\t}\n}\n"]}