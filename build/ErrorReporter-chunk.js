import { __toESM } from "./chunk-chunk.js";
import { Mode, isApp, isDesktop } from "./Env-chunk.js";
import { ErrorReportClientType, client } from "./ClientDetector-chunk.js";
import { mithril_default } from "./mithril-chunk.js";
import { downcast, errorToString, neverNull, typedKeys, uint8ArrayToString } from "./dist2-chunk.js";
import { lang } from "./LanguageViewModel-chunk.js";
import { AccountType, ConversationType, Keys, MailMethod } from "./TutanotaConstants-chunk.js";
import { px } from "./size-chunk.js";
import { require_stream } from "./stream-chunk.js";
import { createLogFile } from "./Logger-chunk.js";
import { Button, ButtonType } from "./Button-chunk.js";
import { Dialog, DialogType, TextField, TextFieldType } from "./Dialog-chunk.js";
import { convertTextToHtml } from "./Formatter-chunk.js";
import { locator } from "./CommonLocator-chunk.js";
import { RecipientType } from "./Recipient-chunk.js";
import { show } from "./NotificationOverlay-chunk.js";
import { Checkbox } from "./Checkbox-chunk.js";
import { ExpanderButton, ExpanderPanel } from "./Expander-chunk.js";
import { copyToClipboard } from "./ClipboardUtils-chunk.js";
import { ReportErrorService, createErrorReportData, createErrorReportFile, createReportErrorIn } from "./Services4-chunk.js";
import { BubbleButton } from "./BubbleButton-chunk.js";

//#region src/common/misc/ErrorReporter.ts
var import_stream = __toESM(require_stream(), 1);
async function showErrorNotification(e) {
	const loggedIn = locator.logins.isUserLoggedIn();
	const logs = await getLogAttachments();
	const { decision, ignore } = await showErrorOverlay();
	if (decision === "cancel") return { ignored: ignore };
	const preparedContent = prepareFeedbackContent(e, loggedIn);
	const reportDialogResult = await showReportDialog(preparedContent.subject, preparedContent.message, logs);
	if (reportDialogResult.decision === "cancel") return { ignored: ignore };
	preparedContent.logs = reportDialogResult.sendLogs ? logs : [];
	preparedContent.message = reportDialogResult.userMessage + "\n" + preparedContent.message;
	sendToServer(e, reportDialogResult.userMessage, reportDialogResult.sendLogs ? logs : []);
	sendFeedbackMail(preparedContent);
	return { ignored: ignore };
}
async function showErrorOverlay() {
	let ignore = false;
	const decision = await new Promise((resolve) => {
		show({ view: () => mithril_default("", ["An error occurred", mithril_default(Checkbox, {
			label: () => "Ignore the error for this session",
			checked: ignore,
			onChecked: (checked) => ignore = checked
		})]) }, {
			label: "close_alt",
			click: () => resolve("cancel")
		}, [{
			label: "sendReport_label",
			click: () => resolve("send"),
			type: ButtonType.Secondary
		}]);
	});
	return {
		decision,
		ignore
	};
}
function showReportDialog(subject, message, logs) {
	let sendLogs = true;
	let detailsExpanded = false;
	let userMessage = "";
	const dialogContent = { view: () => {
		return [
			mithril_default(TextField, {
				label: "yourMessage_label",
				helpLabel: () => lang.get("feedbackOnErrorInfo_msg"),
				value: userMessage,
				type: TextFieldType.Area,
				oninput: (value) => userMessage = value
			}),
			mithril_default(Checkbox, {
				label: () => lang.get("sendLogs_action"),
				helpLabel: "sendLogsInfo_msg",
				checked: sendLogs,
				onChecked: (checked) => sendLogs = checked
			}),
			mithril_default(".flex.flex-column.space-around.items-center", logs.map((l) => mithril_default(BubbleButton, {
				label: lang.makeTranslation("filename", l.name),
				onclick: () => showLogDialog(l.name, uint8ArrayToString("utf-8", l.data))
			}))),
			mithril_default(".flex-end", mithril_default(".right", mithril_default(ExpanderButton, {
				label: "details_label",
				expanded: detailsExpanded,
				onExpandedChange: (expanded) => detailsExpanded = expanded
			}))),
			mithril_default(ExpanderPanel, { expanded: detailsExpanded }, mithril_default(".selectable", [mithril_default(".selectable", subject), message.split("\n").map((l) => l.trim() === "" ? mithril_default(".pb", "") : mithril_default("", l))]))
		];
	} };
	return new Promise((resolve) => {
		Dialog.showActionDialog({
			okActionTextId: "send_action",
			title: "sendErrorReport_action",
			type: DialogType.EditMedium,
			child: dialogContent,
			okAction: (dialog) => {
				resolve({
					decision: "send",
					sendLogs,
					userMessage
				});
				dialog.close();
			},
			cancelAction: () => resolve({ decision: "cancel" })
		});
	});
}
/**
* show the contents of a log file in a large dialog.
* @param heading the title of the dialog
* @param text the text to display
*/
async function showLogDialog(heading, text) {
	let logDialog;
	const closeLogDialog = () => logDialog?.close();
	logDialog = Dialog.largeDialog({
		right: [{
			label: "ok_action",
			click: closeLogDialog,
			type: ButtonType.Secondary
		}],
		middle: lang.makeTranslation("heading", heading)
	}, { view: () => mithril_default(".white-space-pre.pt.pb.selectable", text) }).addShortcut({
		key: Keys.ESC,
		exec: closeLogDialog,
		help: "close_alt"
	}).setCloseHandler(closeLogDialog).show();
}
async function showErrorDialogNotLoggedIn(e) {
	const content = prepareFeedbackContent(e, false);
	const expanded = (0, import_stream.default)(false);
	const message = content.subject + "\n\n" + content.message;
	const info = () => [mithril_default(".flex.col.items-end.plr", { style: { marginTop: "-16px" } }, [mithril_default("div.mr-negative-xs", mithril_default(ExpanderButton, {
		expanded: expanded(),
		onExpandedChange: expanded,
		label: "showMore_action"
	}))]), mithril_default(ExpanderPanel, { expanded: expanded() }, [mithril_default(".flex-end.plr", mithril_default(Button, {
		label: "copy_action",
		click: () => copyToClipboard(message),
		type: ButtonType.Secondary
	})), mithril_default(".plr.selectable.pb.scroll.text-pre", { style: { height: px(200) } }, message)])];
	return Dialog.message("unknownError_msg", info);
}
async function sendFeedbackMail(content) {
	const name = "";
	const mailAddress = "reports@tutao.de";
	const escapedBody = new Option(content.message).innerHTML;
	const logins = locator.logins;
	const draft = await locator.mailFacade.createDraft({
		subject: content.subject,
		bodyText: convertTextToHtml(escapedBody),
		senderMailAddress: neverNull(logins.getUserController().userGroupInfo.mailAddress),
		senderName: "",
		toRecipients: [{
			name,
			address: mailAddress
		}],
		ccRecipients: [],
		bccRecipients: [],
		conversationType: ConversationType.NEW,
		previousMessageId: null,
		attachments: content.logs,
		confidential: true,
		replyTos: [],
		method: MailMethod.NONE
	});
	await locator.mailFacade.sendDraft(draft, [{
		name,
		address: mailAddress,
		type: RecipientType.INTERNAL,
		contact: null
	}], "de");
}
async function sendToServer(error, userMessage, logs) {
	function getReportingClientType() {
		if (env.mode === Mode.Browser) return ErrorReportClientType.Browser;
else switch (env.platformId) {
			case "ios": return ErrorReportClientType.Ios;
			case "android": return ErrorReportClientType.Android;
			case "darwin": return ErrorReportClientType.MacOS;
			case "linux": return ErrorReportClientType.Linux;
			case "win32": return ErrorReportClientType.Windows;
			default: return ErrorReportClientType.Linux;
		}
	}
	const clientType = getReportingClientType();
	const errorData = createReportErrorIn({
		data: createErrorReportData({
			clientType,
			appVersion: env.versionNumber,
			userId: locator.logins.getUserController().userId,
			errorClass: error.name ?? "?",
			errorMessage: error.message,
			userMessage,
			stackTrace: error.stack ?? "",
			additionalInfo: client.userAgent,
			time: new Date()
		}),
		files: logs.map((log) => {
			const stringData = uint8ArrayToString("utf-8", log.data);
			return createErrorReportFile({
				name: log.name,
				content: stringData
			});
		})
	});
	await locator.serviceExecutor.post(ReportErrorService, errorData);
}
function prepareFeedbackContent(error, loggedIn) {
	const timestamp = new Date();
	let { message, client: client$1, type } = clientInfoString(timestamp, loggedIn);
	if (error) message += errorToString(error);
	const subject = `Feedback v${env.versionNumber} - ${error && error.name ? error.name : "?"} - ${type} - ${client$1}`;
	return {
		message,
		subject,
		logs: []
	};
}
function clientInfoString(timestamp, loggedIn) {
	const type = loggedIn ? neverNull(typedKeys(AccountType).find((typeName) => AccountType[typeName] === locator.logins.getUserController().user.accountType)) : "UNKNOWN";
	const client$1 = (() => {
		switch (env.mode) {
			case Mode.Browser:
			case Mode.Test: return env.mode;
			default: return env.platformId ?? "";
		}
	})();
	let message = `\n\n Client: ${client$1}`;
	message += `\n Type: ${type}`;
	message += `\n Tutanota version: ${env.versionNumber}`;
	message += `\n Timestamp (UTC): ${timestamp.toUTCString()}`;
	message += `\n User agent:\n${navigator.userAgent}` + "\n";
	return {
		message,
		client: client$1,
		type
	};
}
async function getLogAttachments(timestamp) {
	const logs = [];
	const global = downcast(window);
	if (global.logger) {
		const mainEntries = global.logger.getEntries();
		const mainLogFile = createLogFile(mainEntries.join("\n"), "main", timestamp?.getTime());
		logs.push(mainLogFile);
		const workerLogEntries = await locator.workerFacade.getLog();
		const workerLogFile = await createLogFile(workerLogEntries.join("\n"), "worker", timestamp?.getTime());
		logs.push(workerLogFile);
	}
	if (isDesktop() || isApp()) {
		const nativeLog = await locator.commonSystemFacade.getLog();
		const nativeLogFile = createLogFile(nativeLog, isDesktop() ? "desktop" : "device", timestamp?.getTime());
		logs.push(nativeLogFile);
	}
	return logs;
}

//#endregion
export { clientInfoString, getLogAttachments, sendFeedbackMail, showErrorDialogNotLoggedIn, showErrorNotification };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXJyb3JSZXBvcnRlci1jaHVuay5qcyIsIm5hbWVzIjpbImU6IEVycm9ySW5mbyIsImRlY2lzaW9uOiBcInNlbmRcIiB8IFwiY2FuY2VsXCIiLCJzdWJqZWN0OiBzdHJpbmciLCJtZXNzYWdlOiBzdHJpbmciLCJsb2dzOiByZWFkb25seSBEYXRhRmlsZVtdIiwiZGlhbG9nOiBEaWFsb2ciLCJoZWFkaW5nOiBzdHJpbmciLCJ0ZXh0OiBzdHJpbmciLCJsb2dEaWFsb2c6IERpYWxvZyIsImNvbnRlbnQ6IEZlZWRiYWNrQ29udGVudCIsImVycm9yOiBFcnJvckluZm8iLCJ1c2VyTWVzc2FnZTogc3RyaW5nIHwgbnVsbCIsImxvZ3M6IERhdGFGaWxlW10iLCJsb2dnZWRJbjogYm9vbGVhbiIsImNsaWVudCIsInRpbWVzdGFtcDogRGF0ZSIsInRpbWVzdGFtcD86IERhdGUiLCJsb2dzOiBBcnJheTxEYXRhRmlsZT4iXSwic291cmNlcyI6WyIuLi9zcmMvY29tbW9uL21pc2MvRXJyb3JSZXBvcnRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgc3RyZWFtIGZyb20gXCJtaXRocmlsL3N0cmVhbVwiXG5pbXBvcnQgeyBUZXh0RmllbGQsIFRleHRGaWVsZFR5cGUgfSBmcm9tIFwiLi4vZ3VpL2Jhc2UvVGV4dEZpZWxkLmpzXCJcbmltcG9ydCB7IGxhbmcgfSBmcm9tIFwiLi9MYW5ndWFnZVZpZXdNb2RlbFwiXG5pbXBvcnQgeyBEaWFsb2csIERpYWxvZ1R5cGUgfSBmcm9tIFwiLi4vZ3VpL2Jhc2UvRGlhbG9nXCJcbmltcG9ydCAqIGFzIG5vdGlmaWNhdGlvbk92ZXJsYXkgZnJvbSBcIi4uL2d1aS9iYXNlL05vdGlmaWNhdGlvbk92ZXJsYXlcIlxuaW1wb3J0IG0gZnJvbSBcIm1pdGhyaWxcIlxuaW1wb3J0IHsgQ2hlY2tib3ggfSBmcm9tIFwiLi4vZ3VpL2Jhc2UvQ2hlY2tib3guanNcIlxuaW1wb3J0IHsgQnV0dG9uLCBCdXR0b25UeXBlIH0gZnJvbSBcIi4uL2d1aS9iYXNlL0J1dHRvbi5qc1wiXG5pbXBvcnQgeyBFeHBhbmRlckJ1dHRvbiwgRXhwYW5kZXJQYW5lbCB9IGZyb20gXCIuLi9ndWkvYmFzZS9FeHBhbmRlclwiXG5pbXBvcnQgeyBkb3duY2FzdCwgRXJyb3JJbmZvLCBlcnJvclRvU3RyaW5nLCBuZXZlck51bGwsIHR5cGVkS2V5cywgdWludDhBcnJheVRvU3RyaW5nIH0gZnJvbSBcIkB0dXRhby90dXRhbm90YS11dGlsc1wiXG5pbXBvcnQgeyBsb2NhdG9yIH0gZnJvbSBcIi4uL2FwaS9tYWluL0NvbW1vbkxvY2F0b3JcIlxuaW1wb3J0IHsgQWNjb3VudFR5cGUsIENvbnZlcnNhdGlvblR5cGUsIEtleXMsIE1haWxNZXRob2QgfSBmcm9tIFwiLi4vYXBpL2NvbW1vbi9UdXRhbm90YUNvbnN0YW50c1wiXG5pbXBvcnQgeyBjb3B5VG9DbGlwYm9hcmQgfSBmcm9tIFwiLi9DbGlwYm9hcmRVdGlsc1wiXG5pbXBvcnQgeyBweCB9IGZyb20gXCIuLi9ndWkvc2l6ZVwiXG5pbXBvcnQgeyBpc0FwcCwgaXNEZXNrdG9wLCBNb2RlIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vRW52XCJcbmltcG9ydCB7IFJlY2lwaWVudFR5cGUgfSBmcm9tIFwiLi4vYXBpL2NvbW1vbi9yZWNpcGllbnRzL1JlY2lwaWVudC5qc1wiXG5pbXBvcnQgeyBjcmVhdGVMb2dGaWxlIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vTG9nZ2VyLmpzXCJcbmltcG9ydCB7IERhdGFGaWxlIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vRGF0YUZpbGUuanNcIlxuaW1wb3J0IHsgY29udmVydFRleHRUb0h0bWwgfSBmcm9tIFwiLi9Gb3JtYXR0ZXIuanNcIlxuaW1wb3J0IHsgUmVwb3J0RXJyb3JTZXJ2aWNlIH0gZnJvbSBcIi4uL2FwaS9lbnRpdGllcy9tb25pdG9yL1NlcnZpY2VzLmpzXCJcbmltcG9ydCB7IGNyZWF0ZUVycm9yUmVwb3J0RGF0YSwgY3JlYXRlRXJyb3JSZXBvcnRGaWxlLCBjcmVhdGVSZXBvcnRFcnJvckluIH0gZnJvbSBcIi4uL2FwaS9lbnRpdGllcy9tb25pdG9yL1R5cGVSZWZzLmpzXCJcbmltcG9ydCB7IEVycm9yUmVwb3J0Q2xpZW50VHlwZSB9IGZyb20gXCIuL0NsaWVudENvbnN0YW50cy5qc1wiXG5pbXBvcnQgeyBjbGllbnQgfSBmcm9tIFwiLi9DbGllbnREZXRlY3Rvci5qc1wiXG5pbXBvcnQgeyBCdWJibGVCdXR0b24gfSBmcm9tIFwiLi4vZ3VpL2Jhc2UvYnV0dG9ucy9CdWJibGVCdXR0b24uanNcIlxuXG50eXBlIEZlZWRiYWNrQ29udGVudCA9IHtcblx0bWVzc2FnZTogc3RyaW5nXG5cdHN1YmplY3Q6IHN0cmluZ1xuXHRsb2dzOiBBcnJheTxEYXRhRmlsZT5cbn1cblxuLyoqXG4gKiBEaXNwbGF5cyBhIG5vdGlmaWNhdGlvbiBvdmVybGF5IHRoYXQgc29tZSBlcnJvciBoYXMgb2NjdXJyZWQgd2l0aCBhbiBvcHRpb24gdG8gc2VuZCBhbiBlcnJvciByZXBvcnQgb3IgZGlzbWlzcyB0aGUgbm90aWZpY2F0aW9uLiBJbiBlaXRoZXIgY2FzZSB0aGVcbiAqIGVycm9yIGNhbiBiZSBpZ25vcmVkLlxuICpcbiAqIElmIHJlcG9ydCBpcyBwcmVzc2VkIHRoZW4gaXQgc2hvd3MgYSByZXBvcnQgZGlhbG9nIHdpdGggbWVzc2FnZSBmaWVsZCBhbmQgYW4gb3ZlcnZpZXcgb2YgdGhlIHNlbnQgZGF0YS5cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNob3dFcnJvck5vdGlmaWNhdGlvbihlOiBFcnJvckluZm8pOiBQcm9taXNlPHsgaWdub3JlZDogYm9vbGVhbiB9PiB7XG5cdGNvbnN0IGxvZ2dlZEluID0gbG9jYXRvci5sb2dpbnMuaXNVc2VyTG9nZ2VkSW4oKVxuXG5cdGNvbnN0IGxvZ3MgPSBhd2FpdCBnZXRMb2dBdHRhY2htZW50cygpXG5cblx0Y29uc3QgeyBkZWNpc2lvbiwgaWdub3JlIH0gPSBhd2FpdCBzaG93RXJyb3JPdmVybGF5KClcblx0aWYgKGRlY2lzaW9uID09PSBcImNhbmNlbFwiKSB7XG5cdFx0cmV0dXJuIHsgaWdub3JlZDogaWdub3JlIH1cblx0fVxuXG5cdGNvbnN0IHByZXBhcmVkQ29udGVudCA9IHByZXBhcmVGZWVkYmFja0NvbnRlbnQoZSwgbG9nZ2VkSW4pXG5cblx0Y29uc3QgcmVwb3J0RGlhbG9nUmVzdWx0ID0gYXdhaXQgc2hvd1JlcG9ydERpYWxvZyhwcmVwYXJlZENvbnRlbnQuc3ViamVjdCwgcHJlcGFyZWRDb250ZW50Lm1lc3NhZ2UsIGxvZ3MpXG5cdGlmIChyZXBvcnREaWFsb2dSZXN1bHQuZGVjaXNpb24gPT09IFwiY2FuY2VsXCIpIHtcblx0XHRyZXR1cm4geyBpZ25vcmVkOiBpZ25vcmUgfVxuXHR9XG5cdHByZXBhcmVkQ29udGVudC5sb2dzID0gcmVwb3J0RGlhbG9nUmVzdWx0LnNlbmRMb2dzID8gbG9ncyA6IFtdXG5cdHByZXBhcmVkQ29udGVudC5tZXNzYWdlID0gcmVwb3J0RGlhbG9nUmVzdWx0LnVzZXJNZXNzYWdlICsgXCJcXG5cIiArIHByZXBhcmVkQ29udGVudC5tZXNzYWdlXG5cblx0c2VuZFRvU2VydmVyKGUsIHJlcG9ydERpYWxvZ1Jlc3VsdC51c2VyTWVzc2FnZSwgcmVwb3J0RGlhbG9nUmVzdWx0LnNlbmRMb2dzID8gbG9ncyA6IFtdKVxuXHRzZW5kRmVlZGJhY2tNYWlsKHByZXBhcmVkQ29udGVudClcblxuXHRyZXR1cm4geyBpZ25vcmVkOiBpZ25vcmUgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzaG93RXJyb3JPdmVybGF5KCk6IFByb21pc2U8eyBkZWNpc2lvbjogXCJzZW5kXCIgfCBcImNhbmNlbFwiOyBpZ25vcmU6IGJvb2xlYW4gfT4ge1xuXHRsZXQgaWdub3JlID0gZmFsc2Vcblx0Y29uc3QgZGVjaXNpb246IFwic2VuZFwiIHwgXCJjYW5jZWxcIiA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiB7XG5cdFx0bm90aWZpY2F0aW9uT3ZlcmxheS5zaG93KFxuXHRcdFx0e1xuXHRcdFx0XHR2aWV3OiAoKSA9PlxuXHRcdFx0XHRcdG0oXCJcIiwgW1xuXHRcdFx0XHRcdFx0XCJBbiBlcnJvciBvY2N1cnJlZFwiLFxuXHRcdFx0XHRcdFx0bShDaGVja2JveCwge1xuXHRcdFx0XHRcdFx0XHRsYWJlbDogKCkgPT4gXCJJZ25vcmUgdGhlIGVycm9yIGZvciB0aGlzIHNlc3Npb25cIixcblx0XHRcdFx0XHRcdFx0Y2hlY2tlZDogaWdub3JlLFxuXHRcdFx0XHRcdFx0XHRvbkNoZWNrZWQ6IChjaGVja2VkKSA9PiAoaWdub3JlID0gY2hlY2tlZCksXG5cdFx0XHRcdFx0XHR9KSxcblx0XHRcdFx0XHRdKSxcblx0XHRcdH0sXG5cdFx0XHR7XG5cdFx0XHRcdGxhYmVsOiBcImNsb3NlX2FsdFwiLFxuXHRcdFx0XHRjbGljazogKCkgPT4gcmVzb2x2ZShcImNhbmNlbFwiKSxcblx0XHRcdH0sXG5cdFx0XHRbXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRsYWJlbDogXCJzZW5kUmVwb3J0X2xhYmVsXCIsXG5cdFx0XHRcdFx0Y2xpY2s6ICgpID0+IHJlc29sdmUoXCJzZW5kXCIpLFxuXHRcdFx0XHRcdHR5cGU6IEJ1dHRvblR5cGUuU2Vjb25kYXJ5LFxuXHRcdFx0XHR9LFxuXHRcdFx0XSxcblx0XHQpXG5cdH0pXG5cdHJldHVybiB7IGRlY2lzaW9uLCBpZ25vcmUgfVxufVxuXG5mdW5jdGlvbiBzaG93UmVwb3J0RGlhbG9nKFxuXHRzdWJqZWN0OiBzdHJpbmcsXG5cdG1lc3NhZ2U6IHN0cmluZyxcblx0bG9nczogcmVhZG9ubHkgRGF0YUZpbGVbXSxcbik6IFByb21pc2U8eyBkZWNpc2lvbjogXCJzZW5kXCI7IHNlbmRMb2dzOiBib29sZWFuOyB1c2VyTWVzc2FnZTogc3RyaW5nIH0gfCB7IGRlY2lzaW9uOiBcImNhbmNlbFwiIH0+IHtcblx0bGV0IHNlbmRMb2dzID0gdHJ1ZVxuXHRsZXQgZGV0YWlsc0V4cGFuZGVkID0gZmFsc2Vcblx0bGV0IHVzZXJNZXNzYWdlID0gXCJcIlxuXG5cdGNvbnN0IGRpYWxvZ0NvbnRlbnQgPSB7XG5cdFx0dmlldzogKCkgPT4ge1xuXHRcdFx0cmV0dXJuIFtcblx0XHRcdFx0bShUZXh0RmllbGQsIHtcblx0XHRcdFx0XHRsYWJlbDogXCJ5b3VyTWVzc2FnZV9sYWJlbFwiLFxuXHRcdFx0XHRcdGhlbHBMYWJlbDogKCkgPT4gbGFuZy5nZXQoXCJmZWVkYmFja09uRXJyb3JJbmZvX21zZ1wiKSxcblx0XHRcdFx0XHR2YWx1ZTogdXNlck1lc3NhZ2UsXG5cdFx0XHRcdFx0dHlwZTogVGV4dEZpZWxkVHlwZS5BcmVhLFxuXHRcdFx0XHRcdG9uaW5wdXQ6ICh2YWx1ZSkgPT4gKHVzZXJNZXNzYWdlID0gdmFsdWUpLFxuXHRcdFx0XHR9KSxcblx0XHRcdFx0bShDaGVja2JveCwge1xuXHRcdFx0XHRcdGxhYmVsOiAoKSA9PiBsYW5nLmdldChcInNlbmRMb2dzX2FjdGlvblwiKSxcblx0XHRcdFx0XHRoZWxwTGFiZWw6IFwic2VuZExvZ3NJbmZvX21zZ1wiLFxuXHRcdFx0XHRcdGNoZWNrZWQ6IHNlbmRMb2dzLFxuXHRcdFx0XHRcdG9uQ2hlY2tlZDogKGNoZWNrZWQpID0+IChzZW5kTG9ncyA9IGNoZWNrZWQpLFxuXHRcdFx0XHR9KSxcblx0XHRcdFx0bShcblx0XHRcdFx0XHRcIi5mbGV4LmZsZXgtY29sdW1uLnNwYWNlLWFyb3VuZC5pdGVtcy1jZW50ZXJcIixcblx0XHRcdFx0XHRsb2dzLm1hcCgobCkgPT5cblx0XHRcdFx0XHRcdG0oQnViYmxlQnV0dG9uLCB7XG5cdFx0XHRcdFx0XHRcdGxhYmVsOiBsYW5nLm1ha2VUcmFuc2xhdGlvbihcImZpbGVuYW1lXCIsIGwubmFtZSksXG5cdFx0XHRcdFx0XHRcdG9uY2xpY2s6ICgpID0+IHNob3dMb2dEaWFsb2cobC5uYW1lLCB1aW50OEFycmF5VG9TdHJpbmcoXCJ1dGYtOFwiLCAobCBhcyBEYXRhRmlsZSkuZGF0YSkpLFxuXHRcdFx0XHRcdFx0fSksXG5cdFx0XHRcdFx0KSxcblx0XHRcdFx0KSxcblx0XHRcdFx0bShcblx0XHRcdFx0XHRcIi5mbGV4LWVuZFwiLFxuXHRcdFx0XHRcdG0oXG5cdFx0XHRcdFx0XHRcIi5yaWdodFwiLFxuXHRcdFx0XHRcdFx0bShFeHBhbmRlckJ1dHRvbiwge1xuXHRcdFx0XHRcdFx0XHRsYWJlbDogXCJkZXRhaWxzX2xhYmVsXCIsXG5cdFx0XHRcdFx0XHRcdGV4cGFuZGVkOiBkZXRhaWxzRXhwYW5kZWQsXG5cdFx0XHRcdFx0XHRcdG9uRXhwYW5kZWRDaGFuZ2U6IChleHBhbmRlZCkgPT4gKGRldGFpbHNFeHBhbmRlZCA9IGV4cGFuZGVkKSxcblx0XHRcdFx0XHRcdH0pLFxuXHRcdFx0XHRcdCksXG5cdFx0XHRcdCksXG5cdFx0XHRcdG0oXG5cdFx0XHRcdFx0RXhwYW5kZXJQYW5lbCxcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRleHBhbmRlZDogZGV0YWlsc0V4cGFuZGVkLFxuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0bShcIi5zZWxlY3RhYmxlXCIsIFttKFwiLnNlbGVjdGFibGVcIiwgc3ViamVjdCksIG1lc3NhZ2Uuc3BsaXQoXCJcXG5cIikubWFwKChsKSA9PiAobC50cmltKCkgPT09IFwiXCIgPyBtKFwiLnBiXCIsIFwiXCIpIDogbShcIlwiLCBsKSkpXSksXG5cdFx0XHRcdCksXG5cdFx0XHRdXG5cdFx0fSxcblx0fVxuXG5cdHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuXHRcdERpYWxvZy5zaG93QWN0aW9uRGlhbG9nKHtcblx0XHRcdG9rQWN0aW9uVGV4dElkOiBcInNlbmRfYWN0aW9uXCIsXG5cdFx0XHR0aXRsZTogXCJzZW5kRXJyb3JSZXBvcnRfYWN0aW9uXCIsXG5cdFx0XHR0eXBlOiBEaWFsb2dUeXBlLkVkaXRNZWRpdW0sXG5cdFx0XHRjaGlsZDogZGlhbG9nQ29udGVudCxcblx0XHRcdG9rQWN0aW9uOiAoZGlhbG9nOiBEaWFsb2cpID0+IHtcblx0XHRcdFx0cmVzb2x2ZSh7IGRlY2lzaW9uOiBcInNlbmRcIiwgc2VuZExvZ3MsIHVzZXJNZXNzYWdlIH0pXG5cdFx0XHRcdGRpYWxvZy5jbG9zZSgpXG5cdFx0XHR9LFxuXHRcdFx0Y2FuY2VsQWN0aW9uOiAoKSA9PiByZXNvbHZlKHsgZGVjaXNpb246IFwiY2FuY2VsXCIgfSksXG5cdFx0fSlcblx0fSlcbn1cblxuLyoqXG4gKiBzaG93IHRoZSBjb250ZW50cyBvZiBhIGxvZyBmaWxlIGluIGEgbGFyZ2UgZGlhbG9nLlxuICogQHBhcmFtIGhlYWRpbmcgdGhlIHRpdGxlIG9mIHRoZSBkaWFsb2dcbiAqIEBwYXJhbSB0ZXh0IHRoZSB0ZXh0IHRvIGRpc3BsYXlcbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2hvd0xvZ0RpYWxvZyhoZWFkaW5nOiBzdHJpbmcsIHRleHQ6IHN0cmluZykge1xuXHRsZXQgbG9nRGlhbG9nOiBEaWFsb2dcblx0Y29uc3QgY2xvc2VMb2dEaWFsb2cgPSAoKSA9PiBsb2dEaWFsb2c/LmNsb3NlKClcblxuXHRsb2dEaWFsb2cgPSBEaWFsb2cubGFyZ2VEaWFsb2coXG5cdFx0e1xuXHRcdFx0cmlnaHQ6IFtcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGxhYmVsOiBcIm9rX2FjdGlvblwiLFxuXHRcdFx0XHRcdGNsaWNrOiBjbG9zZUxvZ0RpYWxvZyxcblx0XHRcdFx0XHR0eXBlOiBCdXR0b25UeXBlLlNlY29uZGFyeSxcblx0XHRcdFx0fSxcblx0XHRcdF0sXG5cdFx0XHRtaWRkbGU6IGxhbmcubWFrZVRyYW5zbGF0aW9uKFwiaGVhZGluZ1wiLCBoZWFkaW5nKSxcblx0XHR9LFxuXHRcdHtcblx0XHRcdHZpZXc6ICgpID0+IG0oXCIud2hpdGUtc3BhY2UtcHJlLnB0LnBiLnNlbGVjdGFibGVcIiwgdGV4dCksXG5cdFx0fSxcblx0KVxuXHRcdC5hZGRTaG9ydGN1dCh7XG5cdFx0XHRrZXk6IEtleXMuRVNDLFxuXHRcdFx0ZXhlYzogY2xvc2VMb2dEaWFsb2csXG5cdFx0XHRoZWxwOiBcImNsb3NlX2FsdFwiLFxuXHRcdH0pXG5cdFx0LnNldENsb3NlSGFuZGxlcihjbG9zZUxvZ0RpYWxvZylcblx0XHQuc2hvdygpXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzaG93RXJyb3JEaWFsb2dOb3RMb2dnZWRJbihlOiBFcnJvckluZm8pOiBQcm9taXNlPHZvaWQ+IHtcblx0Y29uc3QgY29udGVudCA9IHByZXBhcmVGZWVkYmFja0NvbnRlbnQoZSwgZmFsc2UpXG5cdGNvbnN0IGV4cGFuZGVkID0gc3RyZWFtKGZhbHNlKVxuXHRjb25zdCBtZXNzYWdlID0gY29udGVudC5zdWJqZWN0ICsgXCJcXG5cXG5cIiArIGNvbnRlbnQubWVzc2FnZVxuXG5cdGNvbnN0IGluZm8gPSAoKSA9PiBbXG5cdFx0bShcblx0XHRcdFwiLmZsZXguY29sLml0ZW1zLWVuZC5wbHJcIixcblx0XHRcdHtcblx0XHRcdFx0c3R5bGU6IHtcblx0XHRcdFx0XHRtYXJnaW5Ub3A6IFwiLTE2cHhcIixcblx0XHRcdFx0fSxcblx0XHRcdH0sXG5cdFx0XHRbXG5cdFx0XHRcdG0oXG5cdFx0XHRcdFx0XCJkaXYubXItbmVnYXRpdmUteHNcIixcblx0XHRcdFx0XHRtKEV4cGFuZGVyQnV0dG9uLCB7XG5cdFx0XHRcdFx0XHRleHBhbmRlZDogZXhwYW5kZWQoKSxcblx0XHRcdFx0XHRcdG9uRXhwYW5kZWRDaGFuZ2U6IGV4cGFuZGVkLFxuXHRcdFx0XHRcdFx0bGFiZWw6IFwic2hvd01vcmVfYWN0aW9uXCIsXG5cdFx0XHRcdFx0fSksXG5cdFx0XHRcdCksXG5cdFx0XHRdLFxuXHRcdCksXG5cdFx0bShcblx0XHRcdEV4cGFuZGVyUGFuZWwsXG5cdFx0XHR7XG5cdFx0XHRcdGV4cGFuZGVkOiBleHBhbmRlZCgpLFxuXHRcdFx0fSxcblx0XHRcdFtcblx0XHRcdFx0bShcblx0XHRcdFx0XHRcIi5mbGV4LWVuZC5wbHJcIixcblx0XHRcdFx0XHRtKEJ1dHRvbiwge1xuXHRcdFx0XHRcdFx0bGFiZWw6IFwiY29weV9hY3Rpb25cIixcblx0XHRcdFx0XHRcdGNsaWNrOiAoKSA9PiBjb3B5VG9DbGlwYm9hcmQobWVzc2FnZSksXG5cdFx0XHRcdFx0XHR0eXBlOiBCdXR0b25UeXBlLlNlY29uZGFyeSxcblx0XHRcdFx0XHR9KSxcblx0XHRcdFx0KSxcblx0XHRcdFx0bShcblx0XHRcdFx0XHRcIi5wbHIuc2VsZWN0YWJsZS5wYi5zY3JvbGwudGV4dC1wcmVcIixcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRzdHlsZToge1xuXHRcdFx0XHRcdFx0XHRoZWlnaHQ6IHB4KDIwMCksXG5cdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0bWVzc2FnZSxcblx0XHRcdFx0KSxcblx0XHRcdF0sXG5cdFx0KSxcblx0XVxuXG5cdHJldHVybiBEaWFsb2cubWVzc2FnZShcInVua25vd25FcnJvcl9tc2dcIiwgaW5mbylcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmRGZWVkYmFja01haWwoY29udGVudDogRmVlZGJhY2tDb250ZW50KTogUHJvbWlzZTx2b2lkPiB7XG5cdGNvbnN0IG5hbWUgPSBcIlwiXG5cdGNvbnN0IG1haWxBZGRyZXNzID0gXCJyZXBvcnRzQHR1dGFvLmRlXCJcblx0Ly8gV2Ugd2FudCB0byB0cmVhdCB3aGF0IHdlIGhhdmUgYXMgdGV4dCwgbm90IGFzIEhUTUwgc28gd2UgZXNjYXBlIGl0LiBUaGlzIGlzIGFuIGVhc3kgd2F5IHRvIGRvIGl0LlxuXHRjb25zdCBlc2NhcGVkQm9keSA9IG5ldyBPcHRpb24oY29udGVudC5tZXNzYWdlKS5pbm5lckhUTUxcblx0Y29uc3QgbG9naW5zID0gbG9jYXRvci5sb2dpbnNcblx0Y29uc3QgZHJhZnQgPSBhd2FpdCBsb2NhdG9yLm1haWxGYWNhZGUuY3JlYXRlRHJhZnQoe1xuXHRcdHN1YmplY3Q6IGNvbnRlbnQuc3ViamVjdCxcblx0XHRib2R5VGV4dDogY29udmVydFRleHRUb0h0bWwoZXNjYXBlZEJvZHkpLFxuXHRcdHNlbmRlck1haWxBZGRyZXNzOiBuZXZlck51bGwobG9naW5zLmdldFVzZXJDb250cm9sbGVyKCkudXNlckdyb3VwSW5mby5tYWlsQWRkcmVzcyksXG5cdFx0c2VuZGVyTmFtZTogXCJcIixcblx0XHR0b1JlY2lwaWVudHM6IFtcblx0XHRcdHtcblx0XHRcdFx0bmFtZSxcblx0XHRcdFx0YWRkcmVzczogbWFpbEFkZHJlc3MsXG5cdFx0XHR9LFxuXHRcdF0sXG5cdFx0Y2NSZWNpcGllbnRzOiBbXSxcblx0XHRiY2NSZWNpcGllbnRzOiBbXSxcblx0XHRjb252ZXJzYXRpb25UeXBlOiBDb252ZXJzYXRpb25UeXBlLk5FVyxcblx0XHRwcmV2aW91c01lc3NhZ2VJZDogbnVsbCxcblx0XHRhdHRhY2htZW50czogY29udGVudC5sb2dzLFxuXHRcdGNvbmZpZGVudGlhbDogdHJ1ZSxcblx0XHRyZXBseVRvczogW10sXG5cdFx0bWV0aG9kOiBNYWlsTWV0aG9kLk5PTkUsXG5cdH0pXG5cdGF3YWl0IGxvY2F0b3IubWFpbEZhY2FkZS5zZW5kRHJhZnQoXG5cdFx0ZHJhZnQsXG5cdFx0W1xuXHRcdFx0e1xuXHRcdFx0XHRuYW1lLFxuXHRcdFx0XHRhZGRyZXNzOiBtYWlsQWRkcmVzcyxcblx0XHRcdFx0dHlwZTogUmVjaXBpZW50VHlwZS5JTlRFUk5BTCxcblx0XHRcdFx0Y29udGFjdDogbnVsbCxcblx0XHRcdH0sXG5cdFx0XSxcblx0XHRcImRlXCIsXG5cdClcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2VuZFRvU2VydmVyKGVycm9yOiBFcnJvckluZm8sIHVzZXJNZXNzYWdlOiBzdHJpbmcgfCBudWxsLCBsb2dzOiBEYXRhRmlsZVtdKSB7XG5cdGZ1bmN0aW9uIGdldFJlcG9ydGluZ0NsaWVudFR5cGUoKTogRXJyb3JSZXBvcnRDbGllbnRUeXBlIHtcblx0XHRpZiAoZW52Lm1vZGUgPT09IE1vZGUuQnJvd3Nlcikge1xuXHRcdFx0cmV0dXJuIEVycm9yUmVwb3J0Q2xpZW50VHlwZS5Ccm93c2VyXG5cdFx0fSBlbHNlIHtcblx0XHRcdHN3aXRjaCAoZW52LnBsYXRmb3JtSWQpIHtcblx0XHRcdFx0Y2FzZSBcImlvc1wiOlxuXHRcdFx0XHRcdHJldHVybiBFcnJvclJlcG9ydENsaWVudFR5cGUuSW9zXG5cdFx0XHRcdGNhc2UgXCJhbmRyb2lkXCI6XG5cdFx0XHRcdFx0cmV0dXJuIEVycm9yUmVwb3J0Q2xpZW50VHlwZS5BbmRyb2lkXG5cdFx0XHRcdGNhc2UgXCJkYXJ3aW5cIjpcblx0XHRcdFx0XHRyZXR1cm4gRXJyb3JSZXBvcnRDbGllbnRUeXBlLk1hY09TXG5cdFx0XHRcdGNhc2UgXCJsaW51eFwiOlxuXHRcdFx0XHRcdHJldHVybiBFcnJvclJlcG9ydENsaWVudFR5cGUuTGludXhcblx0XHRcdFx0Y2FzZSBcIndpbjMyXCI6XG5cdFx0XHRcdFx0cmV0dXJuIEVycm9yUmVwb3J0Q2xpZW50VHlwZS5XaW5kb3dzXG5cdFx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdFx0cmV0dXJuIEVycm9yUmVwb3J0Q2xpZW50VHlwZS5MaW51eFxuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdGNvbnN0IGNsaWVudFR5cGUgPSBnZXRSZXBvcnRpbmdDbGllbnRUeXBlKClcblxuXHRjb25zdCBlcnJvckRhdGEgPSBjcmVhdGVSZXBvcnRFcnJvckluKHtcblx0XHRkYXRhOiBjcmVhdGVFcnJvclJlcG9ydERhdGEoe1xuXHRcdFx0Y2xpZW50VHlwZSxcblx0XHRcdGFwcFZlcnNpb246IGVudi52ZXJzaW9uTnVtYmVyLFxuXHRcdFx0dXNlcklkOiBsb2NhdG9yLmxvZ2lucy5nZXRVc2VyQ29udHJvbGxlcigpLnVzZXJJZCxcblx0XHRcdGVycm9yQ2xhc3M6IGVycm9yLm5hbWUgPz8gXCI/XCIsXG5cdFx0XHRlcnJvck1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG5cdFx0XHR1c2VyTWVzc2FnZTogdXNlck1lc3NhZ2UsXG5cdFx0XHRzdGFja1RyYWNlOiBlcnJvci5zdGFjayA/PyBcIlwiLFxuXHRcdFx0YWRkaXRpb25hbEluZm86IGNsaWVudC51c2VyQWdlbnQsXG5cdFx0XHR0aW1lOiBuZXcgRGF0ZSgpLFxuXHRcdH0pLFxuXHRcdGZpbGVzOiBsb2dzLm1hcCgobG9nKSA9PiB7XG5cdFx0XHRjb25zdCBzdHJpbmdEYXRhID0gdWludDhBcnJheVRvU3RyaW5nKFwidXRmLThcIiwgbG9nLmRhdGEpXG5cdFx0XHRyZXR1cm4gY3JlYXRlRXJyb3JSZXBvcnRGaWxlKHtcblx0XHRcdFx0bmFtZTogbG9nLm5hbWUsXG5cdFx0XHRcdGNvbnRlbnQ6IHN0cmluZ0RhdGEsXG5cdFx0XHR9KVxuXHRcdH0pLFxuXHR9KVxuXHRhd2FpdCBsb2NhdG9yLnNlcnZpY2VFeGVjdXRvci5wb3N0KFJlcG9ydEVycm9yU2VydmljZSwgZXJyb3JEYXRhKVxufVxuXG5mdW5jdGlvbiBwcmVwYXJlRmVlZGJhY2tDb250ZW50KGVycm9yOiBFcnJvckluZm8sIGxvZ2dlZEluOiBib29sZWFuKTogRmVlZGJhY2tDb250ZW50IHtcblx0Y29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKVxuXHRsZXQgeyBtZXNzYWdlLCBjbGllbnQsIHR5cGUgfSA9IGNsaWVudEluZm9TdHJpbmcodGltZXN0YW1wLCBsb2dnZWRJbilcblxuXHRpZiAoZXJyb3IpIHtcblx0XHRtZXNzYWdlICs9IGVycm9yVG9TdHJpbmcoZXJyb3IpXG5cdH1cblxuXHRjb25zdCBzdWJqZWN0ID0gYEZlZWRiYWNrIHYke2Vudi52ZXJzaW9uTnVtYmVyfSAtICR7ZXJyb3IgJiYgZXJyb3IubmFtZSA/IGVycm9yLm5hbWUgOiBcIj9cIn0gLSAke3R5cGV9IC0gJHtjbGllbnR9YFxuXHRyZXR1cm4ge1xuXHRcdG1lc3NhZ2UsXG5cdFx0c3ViamVjdCxcblx0XHRsb2dzOiBbXSxcblx0fVxufVxuXG5leHBvcnQgZnVuY3Rpb24gY2xpZW50SW5mb1N0cmluZyhcblx0dGltZXN0YW1wOiBEYXRlLFxuXHRsb2dnZWRJbjogYm9vbGVhbixcbik6IHtcblx0bWVzc2FnZTogc3RyaW5nXG5cdGNsaWVudDogc3RyaW5nXG5cdHR5cGU6IHN0cmluZ1xufSB7XG5cdGNvbnN0IHR5cGUgPSBsb2dnZWRJblxuXHRcdD8gbmV2ZXJOdWxsKHR5cGVkS2V5cyhBY2NvdW50VHlwZSkuZmluZCgodHlwZU5hbWUpID0+IEFjY291bnRUeXBlW3R5cGVOYW1lXSA9PT0gbG9jYXRvci5sb2dpbnMuZ2V0VXNlckNvbnRyb2xsZXIoKS51c2VyLmFjY291bnRUeXBlKSlcblx0XHQ6IFwiVU5LTk9XTlwiXG5cblx0Y29uc3QgY2xpZW50ID0gKCgpID0+IHtcblx0XHRzd2l0Y2ggKGVudi5tb2RlKSB7XG5cdFx0XHRjYXNlIE1vZGUuQnJvd3Nlcjpcblx0XHRcdGNhc2UgTW9kZS5UZXN0OlxuXHRcdFx0XHRyZXR1cm4gZW52Lm1vZGVcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdHJldHVybiBlbnYucGxhdGZvcm1JZCA/PyBcIlwiXG5cdFx0fVxuXHR9KSgpXG5cblx0bGV0IG1lc3NhZ2UgPSBgXFxuXFxuIENsaWVudDogJHtjbGllbnR9YFxuXHRtZXNzYWdlICs9IGBcXG4gVHlwZTogJHt0eXBlfWBcblx0bWVzc2FnZSArPSBgXFxuIFR1dGFub3RhIHZlcnNpb246ICR7ZW52LnZlcnNpb25OdW1iZXJ9YFxuXHRtZXNzYWdlICs9IGBcXG4gVGltZXN0YW1wIChVVEMpOiAke3RpbWVzdGFtcC50b1VUQ1N0cmluZygpfWBcblx0bWVzc2FnZSArPSBgXFxuIFVzZXIgYWdlbnQ6XFxuJHtuYXZpZ2F0b3IudXNlckFnZW50fWAgKyBcIlxcblwiXG5cdHJldHVybiB7XG5cdFx0bWVzc2FnZSxcblx0XHRjbGllbnQsXG5cdFx0dHlwZSxcblx0fVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0TG9nQXR0YWNobWVudHModGltZXN0YW1wPzogRGF0ZSk6IFByb21pc2U8QXJyYXk8RGF0YUZpbGU+PiB7XG5cdGNvbnN0IGxvZ3M6IEFycmF5PERhdGFGaWxlPiA9IFtdXG5cdGNvbnN0IGdsb2JhbCA9IGRvd25jYXN0PFdpbmRvdz4od2luZG93KVxuXG5cdGlmIChnbG9iYWwubG9nZ2VyKSB7XG5cdFx0Y29uc3QgbWFpbkVudHJpZXMgPSBnbG9iYWwubG9nZ2VyLmdldEVudHJpZXMoKVxuXHRcdGNvbnN0IG1haW5Mb2dGaWxlID0gY3JlYXRlTG9nRmlsZShtYWluRW50cmllcy5qb2luKFwiXFxuXCIpLCBcIm1haW5cIiwgdGltZXN0YW1wPy5nZXRUaW1lKCkpXG5cdFx0bG9ncy5wdXNoKG1haW5Mb2dGaWxlKVxuXHRcdGNvbnN0IHdvcmtlckxvZ0VudHJpZXMgPSBhd2FpdCBsb2NhdG9yLndvcmtlckZhY2FkZS5nZXRMb2coKVxuXHRcdGNvbnN0IHdvcmtlckxvZ0ZpbGUgPSBhd2FpdCBjcmVhdGVMb2dGaWxlKHdvcmtlckxvZ0VudHJpZXMuam9pbihcIlxcblwiKSwgXCJ3b3JrZXJcIiwgdGltZXN0YW1wPy5nZXRUaW1lKCkpXG5cdFx0bG9ncy5wdXNoKHdvcmtlckxvZ0ZpbGUpXG5cdH1cblxuXHRpZiAoaXNEZXNrdG9wKCkgfHwgaXNBcHAoKSkge1xuXHRcdGNvbnN0IG5hdGl2ZUxvZyA9IGF3YWl0IGxvY2F0b3IuY29tbW9uU3lzdGVtRmFjYWRlLmdldExvZygpXG5cdFx0Y29uc3QgbmF0aXZlTG9nRmlsZSA9IGNyZWF0ZUxvZ0ZpbGUobmF0aXZlTG9nLCBpc0Rlc2t0b3AoKSA/IFwiZGVza3RvcFwiIDogXCJkZXZpY2VcIiwgdGltZXN0YW1wPy5nZXRUaW1lKCkpXG5cdFx0bG9ncy5wdXNoKG5hdGl2ZUxvZ0ZpbGUpXG5cdH1cblxuXHRyZXR1cm4gbG9nc1xufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFxQ08sZUFBZSxzQkFBc0JBLEdBQTZDO0NBQ3hGLE1BQU0sV0FBVyxRQUFRLE9BQU8sZ0JBQWdCO0NBRWhELE1BQU0sT0FBTyxNQUFNLG1CQUFtQjtDQUV0QyxNQUFNLEVBQUUsVUFBVSxRQUFRLEdBQUcsTUFBTSxrQkFBa0I7QUFDckQsS0FBSSxhQUFhLFNBQ2hCLFFBQU8sRUFBRSxTQUFTLE9BQVE7Q0FHM0IsTUFBTSxrQkFBa0IsdUJBQXVCLEdBQUcsU0FBUztDQUUzRCxNQUFNLHFCQUFxQixNQUFNLGlCQUFpQixnQkFBZ0IsU0FBUyxn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