import { __toESM } from "./chunk-chunk.js";
import { Mode, isApp, isDesktop } from "./Env-chunk.js";
import { ErrorReportClientType, client } from "./ClientDetector-chunk.js";
import { mithril_default } from "./mithril-chunk.js";
import { downcast, errorToString, neverNull, typedKeys, uint8ArrayToString } from "./dist2-chunk.js";
import { lang } from "./LanguageViewModel-chunk.js";
import { AccountType, ConversationType, Keys, MailMethod } from "./TutanotaConstants-chunk.js";
import { px } from "./size-chunk.js";
import { getTimeZone } from "./CalendarUtils-chunk.js";
import { require_stream } from "./stream-chunk.js";
import { createLogFile } from "./Logger-chunk.js";
import { Button, ButtonType } from "./Button-chunk.js";
import { Dialog, DialogType, TextField, TextFieldType } from "./Dialog-chunk.js";
import { convertTextToHtml } from "./Formatter-chunk.js";
import { locator } from "./CommonLocator-chunk.js";
import { RecipientType } from "./Recipient-chunk.js";
import { show } from "./NotificationOverlay-chunk.js";
import { Checkbox } from "./Checkbox-chunk.js";
import { ExpanderButton, ExpanderPanel } from "./Expander-chunk.js";
import { copyToClipboard } from "./ClipboardUtils-chunk.js";
import { ReportErrorService, createErrorReportData, createErrorReportFile, createReportErrorIn } from "./Services4-chunk.js";
import { BubbleButton } from "./BubbleButton-chunk.js";

//#region src/common/misc/ErrorReporter.ts
var import_stream = __toESM(require_stream(), 1);
async function showErrorNotification(e) {
	const loggedIn = locator.logins.isUserLoggedIn();
	const logs = await getLogAttachments();
	const { decision, ignore } = await showErrorOverlay();
	if (decision === "cancel") return { ignored: ignore };
	const preparedContent = prepareFeedbackContent(e, loggedIn);
	const reportDialogResult = await showReportDialog(preparedContent.subject, preparedContent.message, logs);
	if (reportDialogResult.decision === "cancel") return { ignored: ignore };
	preparedContent.logs = reportDialogResult.sendLogs ? logs : [];
	preparedContent.message = reportDialogResult.userMessage + "\n" + preparedContent.message;
	sendToServer(e, reportDialogResult.userMessage, reportDialogResult.sendLogs ? logs : []);
	sendFeedbackMail(preparedContent);
	return { ignored: ignore };
}
async function showErrorOverlay() {
	let ignore = false;
	const decision = await new Promise((resolve) => {
		show({ view: () => mithril_default("", ["An error occurred", mithril_default(Checkbox, {
			label: () => "Ignore the error for this session",
			checked: ignore,
			onChecked: (checked) => ignore = checked
		})]) }, {
			label: "close_alt",
			click: () => resolve("cancel")
		}, [{
			label: "sendReport_label",
			click: () => resolve("send"),
			type: ButtonType.Secondary
		}]);
	});
	return {
		decision,
		ignore
	};
}
function showReportDialog(subject, message, logs) {
	let sendLogs = true;
	let detailsExpanded = false;
	let userMessage = "";
	const dialogContent = { view: () => {
		return [
			mithril_default(TextField, {
				label: "yourMessage_label",
				helpLabel: () => lang.get("feedbackOnErrorInfo_msg"),
				value: userMessage,
				type: TextFieldType.Area,
				oninput: (value) => userMessage = value
			}),
			mithril_default(Checkbox, {
				label: () => lang.get("sendLogs_action"),
				helpLabel: "sendLogsInfo_msg",
				checked: sendLogs,
				onChecked: (checked) => sendLogs = checked
			}),
			mithril_default(".flex.flex-column.space-around.items-center", logs.map((l) => mithril_default(BubbleButton, {
				label: lang.makeTranslation("filename", l.name),
				onclick: () => showLogDialog(l.name, uint8ArrayToString("utf-8", l.data))
			}))),
			mithril_default(".flex-end", mithril_default(".right", mithril_default(ExpanderButton, {
				label: "details_label",
				expanded: detailsExpanded,
				onExpandedChange: (expanded) => detailsExpanded = expanded
			}))),
			mithril_default(ExpanderPanel, { expanded: detailsExpanded }, mithril_default(".selectable", [mithril_default(".selectable", subject), message.split("\n").map((l) => l.trim() === "" ? mithril_default(".pb", "") : mithril_default("", l))]))
		];
	} };
	return new Promise((resolve) => {
		Dialog.showActionDialog({
			okActionTextId: "send_action",
			title: "sendErrorReport_action",
			type: DialogType.EditMedium,
			child: dialogContent,
			okAction: (dialog) => {
				resolve({
					decision: "send",
					sendLogs,
					userMessage
				});
				dialog.close();
			},
			cancelAction: () => resolve({ decision: "cancel" })
		});
	});
}
/**
* show the contents of a log file in a large dialog.
* @param heading the title of the dialog
* @param text the text to display
*/
async function showLogDialog(heading, text) {
	let logDialog;
	const closeLogDialog = () => logDialog?.close();
	logDialog = Dialog.largeDialog({
		right: [{
			label: "ok_action",
			click: closeLogDialog,
			type: ButtonType.Secondary
		}],
		middle: lang.makeTranslation("heading", heading)
	}, { view: () => mithril_default(".white-space-pre.pt.pb.selectable", text) }).addShortcut({
		key: Keys.ESC,
		exec: closeLogDialog,
		help: "close_alt"
	}).setCloseHandler(closeLogDialog).show();
}
async function showErrorDialogNotLoggedIn(e) {
	const content = prepareFeedbackContent(e, false);
	const expanded = (0, import_stream.default)(false);
	const message = content.subject + "\n\n" + content.message;
	const info = () => [mithril_default(".flex.col.items-end.plr", { style: { marginTop: "-16px" } }, [mithril_default("div.mr-negative-xs", mithril_default(ExpanderButton, {
		expanded: expanded(),
		onExpandedChange: expanded,
		label: "showMore_action"
	}))]), mithril_default(ExpanderPanel, { expanded: expanded() }, [mithril_default(".flex-end.plr", mithril_default(Button, {
		label: "copy_action",
		click: () => copyToClipboard(message),
		type: ButtonType.Secondary
	})), mithril_default(".plr.selectable.pb.scroll.text-pre", { style: { height: px(200) } }, message)])];
	return Dialog.message("unknownError_msg", info);
}
async function sendFeedbackMail(content) {
	const name = "";
	const mailAddress = "reports@tutao.de";
	const escapedBody = new Option(content.message).innerHTML;
	const logins = locator.logins;
	const draft = await locator.mailFacade.createDraft({
		subject: content.subject,
		bodyText: convertTextToHtml(escapedBody),
		senderMailAddress: neverNull(logins.getUserController().userGroupInfo.mailAddress),
		senderName: "",
		toRecipients: [{
			name,
			address: mailAddress
		}],
		ccRecipients: [],
		bccRecipients: [],
		conversationType: ConversationType.NEW,
		previousMessageId: null,
		attachments: content.logs,
		confidential: true,
		replyTos: [],
		method: MailMethod.NONE
	});
	await locator.mailFacade.sendDraft(draft, [{
		name,
		address: mailAddress,
		type: RecipientType.INTERNAL,
		contact: null
	}], "de");
}
async function sendToServer(error, userMessage, logs) {
	function getReportingClientType() {
		if (env.mode === Mode.Browser) return ErrorReportClientType.Browser;
else switch (env.platformId) {
			case "ios": return ErrorReportClientType.Ios;
			case "android": return ErrorReportClientType.Android;
			case "darwin": return ErrorReportClientType.MacOS;
			case "linux": return ErrorReportClientType.Linux;
			case "win32": return ErrorReportClientType.Windows;
			default: return ErrorReportClientType.Linux;
		}
	}
	const clientType = getReportingClientType();
	const errorData = createReportErrorIn({
		data: createErrorReportData({
			clientType,
			appVersion: env.versionNumber,
			userId: locator.logins.getUserController().userId,
			errorClass: error.name ?? "?",
			errorMessage: error.message,
			userMessage,
			stackTrace: error.stack ?? "",
			additionalInfo: client.userAgent,
			time: new Date()
		}),
		files: logs.map((log) => {
			const stringData = uint8ArrayToString("utf-8", log.data);
			return createErrorReportFile({
				name: log.name,
				content: stringData
			});
		})
	});
	await locator.serviceExecutor.post(ReportErrorService, errorData);
}
function prepareFeedbackContent(error, loggedIn) {
	const timestamp = new Date();
	let { message, client: client$1, type } = clientInfoString(timestamp, loggedIn);
	if (error) message += errorToString(error);
	const subject = `Feedback v${env.versionNumber} - ${error && error.name ? error.name : "?"} - ${type} - ${client$1}`;
	return {
		message,
		subject,
		logs: []
	};
}
function clientInfoString(timestamp, loggedIn) {
	const type = loggedIn ? neverNull(typedKeys(AccountType).find((typeName) => AccountType[typeName] === locator.logins.getUserController().user.accountType)) : "UNKNOWN";
	const client$1 = (() => {
		switch (env.mode) {
			case Mode.Browser:
			case Mode.Test: return env.mode;
			default: return env.platformId ?? "";
		}
	})();
	let message = `\n\n Client: ${client$1}`;
	message += `\n Type: ${type}`;
	message += `\n Tutanota version: ${env.versionNumber}`;
	message += `\n Timestamp (UTC): ${timestamp.toUTCString()}`;
	message += `\n Time zone: ${getTimeZone()}`;
	message += `\n User agent: ${navigator.userAgent}\n`;
	return {
		message,
		client: client$1,
		type
	};
}
async function getLogAttachments(timestamp) {
	const logs = [];
	const global = downcast(window);
	if (global.logger) {
		const mainEntries = global.logger.getEntries();
		const mainLogFile = createLogFile(mainEntries.join("\n"), "main", timestamp?.getTime());
		logs.push(mainLogFile);
		const workerLogEntries = await locator.workerFacade.getLog();
		const workerLogFile = await createLogFile(workerLogEntries.join("\n"), "worker", timestamp?.getTime());
		logs.push(workerLogFile);
	}
	if (isDesktop() || isApp()) {
		const nativeLog = await locator.commonSystemFacade.getLog();
		const nativeLogFile = createLogFile(nativeLog, isDesktop() ? "desktop" : "device", timestamp?.getTime());
		logs.push(nativeLogFile);
	}
	return logs;
}

//#endregion
export { clientInfoString, getLogAttachments, sendFeedbackMail, showErrorDialogNotLoggedIn, showErrorNotification };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXJyb3JSZXBvcnRlci1jaHVuay5qcyIsIm5hbWVzIjpbImU6IEVycm9ySW5mbyIsImRlY2lzaW9uOiBcInNlbmRcIiB8IFwiY2FuY2VsXCIiLCJzdWJqZWN0OiBzdHJpbmciLCJtZXNzYWdlOiBzdHJpbmciLCJsb2dzOiByZWFkb25seSBEYXRhRmlsZVtdIiwiZGlhbG9nOiBEaWFsb2ciLCJoZWFkaW5nOiBzdHJpbmciLCJ0ZXh0OiBzdHJpbmciLCJsb2dEaWFsb2c6IERpYWxvZyIsImNvbnRlbnQ6IEZlZWRiYWNrQ29udGVudCIsImVycm9yOiBFcnJvckluZm8iLCJ1c2VyTWVzc2FnZTogc3RyaW5nIHwgbnVsbCIsImxvZ3M6IERhdGFGaWxlW10iLCJsb2dnZWRJbjogYm9vbGVhbiIsImNsaWVudCIsInRpbWVzdGFtcDogRGF0ZSIsInRpbWVzdGFtcD86IERhdGUiLCJsb2dzOiBBcnJheTxEYXRhRmlsZT4iXSwic291cmNlcyI6WyIuLi9zcmMvY29tbW9uL21pc2MvRXJyb3JSZXBvcnRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgc3RyZWFtIGZyb20gXCJtaXRocmlsL3N0cmVhbVwiXG5pbXBvcnQgeyBUZXh0RmllbGQsIFRleHRGaWVsZFR5cGUgfSBmcm9tIFwiLi4vZ3VpL2Jhc2UvVGV4dEZpZWxkLmpzXCJcbmltcG9ydCB7IGxhbmcgfSBmcm9tIFwiLi9MYW5ndWFnZVZpZXdNb2RlbFwiXG5pbXBvcnQgeyBEaWFsb2csIERpYWxvZ1R5cGUgfSBmcm9tIFwiLi4vZ3VpL2Jhc2UvRGlhbG9nXCJcbmltcG9ydCAqIGFzIG5vdGlmaWNhdGlvbk92ZXJsYXkgZnJvbSBcIi4uL2d1aS9iYXNlL05vdGlmaWNhdGlvbk92ZXJsYXlcIlxuaW1wb3J0IG0gZnJvbSBcIm1pdGhyaWxcIlxuaW1wb3J0IHsgQ2hlY2tib3ggfSBmcm9tIFwiLi4vZ3VpL2Jhc2UvQ2hlY2tib3guanNcIlxuaW1wb3J0IHsgQnV0dG9uLCBCdXR0b25UeXBlIH0gZnJvbSBcIi4uL2d1aS9iYXNlL0J1dHRvbi5qc1wiXG5pbXBvcnQgeyBFeHBhbmRlckJ1dHRvbiwgRXhwYW5kZXJQYW5lbCB9IGZyb20gXCIuLi9ndWkvYmFzZS9FeHBhbmRlclwiXG5pbXBvcnQgeyBkb3duY2FzdCwgRXJyb3JJbmZvLCBlcnJvclRvU3RyaW5nLCBuZXZlck51bGwsIHR5cGVkS2V5cywgdWludDhBcnJheVRvU3RyaW5nIH0gZnJvbSBcIkB0dXRhby90dXRhbm90YS11dGlsc1wiXG5pbXBvcnQgeyBsb2NhdG9yIH0gZnJvbSBcIi4uL2FwaS9tYWluL0NvbW1vbkxvY2F0b3JcIlxuaW1wb3J0IHsgQWNjb3VudFR5cGUsIENvbnZlcnNhdGlvblR5cGUsIEtleXMsIE1haWxNZXRob2QgfSBmcm9tIFwiLi4vYXBpL2NvbW1vbi9UdXRhbm90YUNvbnN0YW50c1wiXG5pbXBvcnQgeyBjb3B5VG9DbGlwYm9hcmQgfSBmcm9tIFwiLi9DbGlwYm9hcmRVdGlsc1wiXG5pbXBvcnQgeyBweCB9IGZyb20gXCIuLi9ndWkvc2l6ZVwiXG5pbXBvcnQgeyBpc0FwcCwgaXNEZXNrdG9wLCBNb2RlIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vRW52XCJcbmltcG9ydCB7IFJlY2lwaWVudFR5cGUgfSBmcm9tIFwiLi4vYXBpL2NvbW1vbi9yZWNpcGllbnRzL1JlY2lwaWVudC5qc1wiXG5pbXBvcnQgeyBjcmVhdGVMb2dGaWxlIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vTG9nZ2VyLmpzXCJcbmltcG9ydCB7IERhdGFGaWxlIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vRGF0YUZpbGUuanNcIlxuaW1wb3J0IHsgY29udmVydFRleHRUb0h0bWwgfSBmcm9tIFwiLi9Gb3JtYXR0ZXIuanNcIlxuaW1wb3J0IHsgUmVwb3J0RXJyb3JTZXJ2aWNlIH0gZnJvbSBcIi4uL2FwaS9lbnRpdGllcy9tb25pdG9yL1NlcnZpY2VzLmpzXCJcbmltcG9ydCB7IGNyZWF0ZUVycm9yUmVwb3J0RGF0YSwgY3JlYXRlRXJyb3JSZXBvcnRGaWxlLCBjcmVhdGVSZXBvcnRFcnJvckluIH0gZnJvbSBcIi4uL2FwaS9lbnRpdGllcy9tb25pdG9yL1R5cGVSZWZzLmpzXCJcbmltcG9ydCB7IEVycm9yUmVwb3J0Q2xpZW50VHlwZSB9IGZyb20gXCIuL0NsaWVudENvbnN0YW50cy5qc1wiXG5pbXBvcnQgeyBjbGllbnQgfSBmcm9tIFwiLi9DbGllbnREZXRlY3Rvci5qc1wiXG5pbXBvcnQgeyBCdWJibGVCdXR0b24gfSBmcm9tIFwiLi4vZ3VpL2Jhc2UvYnV0dG9ucy9CdWJibGVCdXR0b24uanNcIlxuaW1wb3J0IHsgZ2V0VGltZVpvbmUgfSBmcm9tIFwiLi4vY2FsZW5kYXIvZGF0ZS9DYWxlbmRhclV0aWxzLmpzXCJcblxudHlwZSBGZWVkYmFja0NvbnRlbnQgPSB7XG5cdG1lc3NhZ2U6IHN0cmluZ1xuXHRzdWJqZWN0OiBzdHJpbmdcblx0bG9nczogQXJyYXk8RGF0YUZpbGU+XG59XG5cbi8qKlxuICogRGlzcGxheXMgYSBub3RpZmljYXRpb24gb3ZlcmxheSB0aGF0IHNvbWUgZXJyb3IgaGFzIG9jY3VycmVkIHdpdGggYW4gb3B0aW9uIHRvIHNlbmQgYW4gZXJyb3IgcmVwb3J0IG9yIGRpc21pc3MgdGhlIG5vdGlmaWNhdGlvbi4gSW4gZWl0aGVyIGNhc2UgdGhlXG4gKiBlcnJvciBjYW4gYmUgaWdub3JlZC5cbiAqXG4gKiBJZiByZXBvcnQgaXMgcHJlc3NlZCB0aGVuIGl0IHNob3dzIGEgcmVwb3J0IGRpYWxvZyB3aXRoIG1lc3NhZ2UgZmllbGQgYW5kIGFuIG92ZXJ2aWV3IG9mIHRoZSBzZW50IGRhdGEuXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzaG93RXJyb3JOb3RpZmljYXRpb24oZTogRXJyb3JJbmZvKTogUHJvbWlzZTx7IGlnbm9yZWQ6IGJvb2xlYW4gfT4ge1xuXHRjb25zdCBsb2dnZWRJbiA9IGxvY2F0b3IubG9naW5zLmlzVXNlckxvZ2dlZEluKClcblxuXHRjb25zdCBsb2dzID0gYXdhaXQgZ2V0TG9nQXR0YWNobWVudHMoKVxuXG5cdGNvbnN0IHsgZGVjaXNpb24sIGlnbm9yZSB9ID0gYXdhaXQgc2hvd0Vycm9yT3ZlcmxheSgpXG5cdGlmIChkZWNpc2lvbiA9PT0gXCJjYW5jZWxcIikge1xuXHRcdHJldHVybiB7IGlnbm9yZWQ6IGlnbm9yZSB9XG5cdH1cblxuXHRjb25zdCBwcmVwYXJlZENvbnRlbnQgPSBwcmVwYXJlRmVlZGJhY2tDb250ZW50KGUsIGxvZ2dlZEluKVxuXG5cdGNvbnN0IHJlcG9ydERpYWxvZ1Jlc3VsdCA9IGF3YWl0IHNob3dSZXBvcnREaWFsb2cocHJlcGFyZWRDb250ZW50LnN1YmplY3QsIHByZXBhcmVkQ29udGVudC5tZXNzYWdlLCBsb2dzKVxuXHRpZiAocmVwb3J0RGlhbG9nUmVzdWx0LmRlY2lzaW9uID09PSBcImNhbmNlbFwiKSB7XG5cdFx0cmV0dXJuIHsgaWdub3JlZDogaWdub3JlIH1cblx0fVxuXHRwcmVwYXJlZENvbnRlbnQubG9ncyA9IHJlcG9ydERpYWxvZ1Jlc3VsdC5zZW5kTG9ncyA/IGxvZ3MgOiBbXVxuXHRwcmVwYXJlZENvbnRlbnQubWVzc2FnZSA9IHJlcG9ydERpYWxvZ1Jlc3VsdC51c2VyTWVzc2FnZSArIFwiXFxuXCIgKyBwcmVwYXJlZENvbnRlbnQubWVzc2FnZVxuXG5cdHNlbmRUb1NlcnZlcihlLCByZXBvcnREaWFsb2dSZXN1bHQudXNlck1lc3NhZ2UsIHJlcG9ydERpYWxvZ1Jlc3VsdC5zZW5kTG9ncyA/IGxvZ3MgOiBbXSlcblx0c2VuZEZlZWRiYWNrTWFpbChwcmVwYXJlZENvbnRlbnQpXG5cblx0cmV0dXJuIHsgaWdub3JlZDogaWdub3JlIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2hvd0Vycm9yT3ZlcmxheSgpOiBQcm9taXNlPHsgZGVjaXNpb246IFwic2VuZFwiIHwgXCJjYW5jZWxcIjsgaWdub3JlOiBib29sZWFuIH0+IHtcblx0bGV0IGlnbm9yZSA9IGZhbHNlXG5cdGNvbnN0IGRlY2lzaW9uOiBcInNlbmRcIiB8IFwiY2FuY2VsXCIgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4ge1xuXHRcdG5vdGlmaWNhdGlvbk92ZXJsYXkuc2hvdyhcblx0XHRcdHtcblx0XHRcdFx0dmlldzogKCkgPT5cblx0XHRcdFx0XHRtKFwiXCIsIFtcblx0XHRcdFx0XHRcdFwiQW4gZXJyb3Igb2NjdXJyZWRcIixcblx0XHRcdFx0XHRcdG0oQ2hlY2tib3gsIHtcblx0XHRcdFx0XHRcdFx0bGFiZWw6ICgpID0+IFwiSWdub3JlIHRoZSBlcnJvciBmb3IgdGhpcyBzZXNzaW9uXCIsXG5cdFx0XHRcdFx0XHRcdGNoZWNrZWQ6IGlnbm9yZSxcblx0XHRcdFx0XHRcdFx0b25DaGVja2VkOiAoY2hlY2tlZCkgPT4gKGlnbm9yZSA9IGNoZWNrZWQpLFxuXHRcdFx0XHRcdFx0fSksXG5cdFx0XHRcdFx0XSksXG5cdFx0XHR9LFxuXHRcdFx0e1xuXHRcdFx0XHRsYWJlbDogXCJjbG9zZV9hbHRcIixcblx0XHRcdFx0Y2xpY2s6ICgpID0+IHJlc29sdmUoXCJjYW5jZWxcIiksXG5cdFx0XHR9LFxuXHRcdFx0W1xuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGFiZWw6IFwic2VuZFJlcG9ydF9sYWJlbFwiLFxuXHRcdFx0XHRcdGNsaWNrOiAoKSA9PiByZXNvbHZlKFwic2VuZFwiKSxcblx0XHRcdFx0XHR0eXBlOiBCdXR0b25UeXBlLlNlY29uZGFyeSxcblx0XHRcdFx0fSxcblx0XHRcdF0sXG5cdFx0KVxuXHR9KVxuXHRyZXR1cm4geyBkZWNpc2lvbiwgaWdub3JlIH1cbn1cblxuZnVuY3Rpb24gc2hvd1JlcG9ydERpYWxvZyhcblx0c3ViamVjdDogc3RyaW5nLFxuXHRtZXNzYWdlOiBzdHJpbmcsXG5cdGxvZ3M6IHJlYWRvbmx5IERhdGFGaWxlW10sXG4pOiBQcm9taXNlPHsgZGVjaXNpb246IFwic2VuZFwiOyBzZW5kTG9nczogYm9vbGVhbjsgdXNlck1lc3NhZ2U6IHN0cmluZyB9IHwgeyBkZWNpc2lvbjogXCJjYW5jZWxcIiB9PiB7XG5cdGxldCBzZW5kTG9ncyA9IHRydWVcblx0bGV0IGRldGFpbHNFeHBhbmRlZCA9IGZhbHNlXG5cdGxldCB1c2VyTWVzc2FnZSA9IFwiXCJcblxuXHRjb25zdCBkaWFsb2dDb250ZW50ID0ge1xuXHRcdHZpZXc6ICgpID0+IHtcblx0XHRcdHJldHVybiBbXG5cdFx0XHRcdG0oVGV4dEZpZWxkLCB7XG5cdFx0XHRcdFx0bGFiZWw6IFwieW91ck1lc3NhZ2VfbGFiZWxcIixcblx0XHRcdFx0XHRoZWxwTGFiZWw6ICgpID0+IGxhbmcuZ2V0KFwiZmVlZGJhY2tPbkVycm9ySW5mb19tc2dcIiksXG5cdFx0XHRcdFx0dmFsdWU6IHVzZXJNZXNzYWdlLFxuXHRcdFx0XHRcdHR5cGU6IFRleHRGaWVsZFR5cGUuQXJlYSxcblx0XHRcdFx0XHRvbmlucHV0OiAodmFsdWUpID0+ICh1c2VyTWVzc2FnZSA9IHZhbHVlKSxcblx0XHRcdFx0fSksXG5cdFx0XHRcdG0oQ2hlY2tib3gsIHtcblx0XHRcdFx0XHRsYWJlbDogKCkgPT4gbGFuZy5nZXQoXCJzZW5kTG9nc19hY3Rpb25cIiksXG5cdFx0XHRcdFx0aGVscExhYmVsOiBcInNlbmRMb2dzSW5mb19tc2dcIixcblx0XHRcdFx0XHRjaGVja2VkOiBzZW5kTG9ncyxcblx0XHRcdFx0XHRvbkNoZWNrZWQ6IChjaGVja2VkKSA9PiAoc2VuZExvZ3MgPSBjaGVja2VkKSxcblx0XHRcdFx0fSksXG5cdFx0XHRcdG0oXG5cdFx0XHRcdFx0XCIuZmxleC5mbGV4LWNvbHVtbi5zcGFjZS1hcm91bmQuaXRlbXMtY2VudGVyXCIsXG5cdFx0XHRcdFx0bG9ncy5tYXAoKGwpID0+XG5cdFx0XHRcdFx0XHRtKEJ1YmJsZUJ1dHRvbiwge1xuXHRcdFx0XHRcdFx0XHRsYWJlbDogbGFuZy5tYWtlVHJhbnNsYXRpb24oXCJmaWxlbmFtZVwiLCBsLm5hbWUpLFxuXHRcdFx0XHRcdFx0XHRvbmNsaWNrOiAoKSA9PiBzaG93TG9nRGlhbG9nKGwubmFtZSwgdWludDhBcnJheVRvU3RyaW5nKFwidXRmLThcIiwgKGwgYXMgRGF0YUZpbGUpLmRhdGEpKSxcblx0XHRcdFx0XHRcdH0pLFxuXHRcdFx0XHRcdCksXG5cdFx0XHRcdCksXG5cdFx0XHRcdG0oXG5cdFx0XHRcdFx0XCIuZmxleC1lbmRcIixcblx0XHRcdFx0XHRtKFxuXHRcdFx0XHRcdFx0XCIucmlnaHRcIixcblx0XHRcdFx0XHRcdG0oRXhwYW5kZXJCdXR0b24sIHtcblx0XHRcdFx0XHRcdFx0bGFiZWw6IFwiZGV0YWlsc19sYWJlbFwiLFxuXHRcdFx0XHRcdFx0XHRleHBhbmRlZDogZGV0YWlsc0V4cGFuZGVkLFxuXHRcdFx0XHRcdFx0XHRvbkV4cGFuZGVkQ2hhbmdlOiAoZXhwYW5kZWQpID0+IChkZXRhaWxzRXhwYW5kZWQgPSBleHBhbmRlZCksXG5cdFx0XHRcdFx0XHR9KSxcblx0XHRcdFx0XHQpLFxuXHRcdFx0XHQpLFxuXHRcdFx0XHRtKFxuXHRcdFx0XHRcdEV4cGFuZGVyUGFuZWwsXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0ZXhwYW5kZWQ6IGRldGFpbHNFeHBhbmRlZCxcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdG0oXCIuc2VsZWN0YWJsZVwiLCBbbShcIi5zZWxlY3RhYmxlXCIsIHN1YmplY3QpLCBtZXNzYWdlLnNwbGl0KFwiXFxuXCIpLm1hcCgobCkgPT4gKGwudHJpbSgpID09PSBcIlwiID8gbShcIi5wYlwiLCBcIlwiKSA6IG0oXCJcIiwgbCkpKV0pLFxuXHRcdFx0XHQpLFxuXHRcdFx0XVxuXHRcdH0sXG5cdH1cblxuXHRyZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcblx0XHREaWFsb2cuc2hvd0FjdGlvbkRpYWxvZyh7XG5cdFx0XHRva0FjdGlvblRleHRJZDogXCJzZW5kX2FjdGlvblwiLFxuXHRcdFx0dGl0bGU6IFwic2VuZEVycm9yUmVwb3J0X2FjdGlvblwiLFxuXHRcdFx0dHlwZTogRGlhbG9nVHlwZS5FZGl0TWVkaXVtLFxuXHRcdFx0Y2hpbGQ6IGRpYWxvZ0NvbnRlbnQsXG5cdFx0XHRva0FjdGlvbjogKGRpYWxvZzogRGlhbG9nKSA9PiB7XG5cdFx0XHRcdHJlc29sdmUoeyBkZWNpc2lvbjogXCJzZW5kXCIsIHNlbmRMb2dzLCB1c2VyTWVzc2FnZSB9KVxuXHRcdFx0XHRkaWFsb2cuY2xvc2UoKVxuXHRcdFx0fSxcblx0XHRcdGNhbmNlbEFjdGlvbjogKCkgPT4gcmVzb2x2ZSh7IGRlY2lzaW9uOiBcImNhbmNlbFwiIH0pLFxuXHRcdH0pXG5cdH0pXG59XG5cbi8qKlxuICogc2hvdyB0aGUgY29udGVudHMgb2YgYSBsb2cgZmlsZSBpbiBhIGxhcmdlIGRpYWxvZy5cbiAqIEBwYXJhbSBoZWFkaW5nIHRoZSB0aXRsZSBvZiB0aGUgZGlhbG9nXG4gKiBAcGFyYW0gdGV4dCB0aGUgdGV4dCB0byBkaXNwbGF5XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHNob3dMb2dEaWFsb2coaGVhZGluZzogc3RyaW5nLCB0ZXh0OiBzdHJpbmcpIHtcblx0bGV0IGxvZ0RpYWxvZzogRGlhbG9nXG5cdGNvbnN0IGNsb3NlTG9nRGlhbG9nID0gKCkgPT4gbG9nRGlhbG9nPy5jbG9zZSgpXG5cblx0bG9nRGlhbG9nID0gRGlhbG9nLmxhcmdlRGlhbG9nKFxuXHRcdHtcblx0XHRcdHJpZ2h0OiBbXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRsYWJlbDogXCJva19hY3Rpb25cIixcblx0XHRcdFx0XHRjbGljazogY2xvc2VMb2dEaWFsb2csXG5cdFx0XHRcdFx0dHlwZTogQnV0dG9uVHlwZS5TZWNvbmRhcnksXG5cdFx0XHRcdH0sXG5cdFx0XHRdLFxuXHRcdFx0bWlkZGxlOiBsYW5nLm1ha2VUcmFuc2xhdGlvbihcImhlYWRpbmdcIiwgaGVhZGluZyksXG5cdFx0fSxcblx0XHR7XG5cdFx0XHR2aWV3OiAoKSA9PiBtKFwiLndoaXRlLXNwYWNlLXByZS5wdC5wYi5zZWxlY3RhYmxlXCIsIHRleHQpLFxuXHRcdH0sXG5cdClcblx0XHQuYWRkU2hvcnRjdXQoe1xuXHRcdFx0a2V5OiBLZXlzLkVTQyxcblx0XHRcdGV4ZWM6IGNsb3NlTG9nRGlhbG9nLFxuXHRcdFx0aGVscDogXCJjbG9zZV9hbHRcIixcblx0XHR9KVxuXHRcdC5zZXRDbG9zZUhhbmRsZXIoY2xvc2VMb2dEaWFsb2cpXG5cdFx0LnNob3coKVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2hvd0Vycm9yRGlhbG9nTm90TG9nZ2VkSW4oZTogRXJyb3JJbmZvKTogUHJvbWlzZTx2b2lkPiB7XG5cdGNvbnN0IGNvbnRlbnQgPSBwcmVwYXJlRmVlZGJhY2tDb250ZW50KGUsIGZhbHNlKVxuXHRjb25zdCBleHBhbmRlZCA9IHN0cmVhbShmYWxzZSlcblx0Y29uc3QgbWVzc2FnZSA9IGNvbnRlbnQuc3ViamVjdCArIFwiXFxuXFxuXCIgKyBjb250ZW50Lm1lc3NhZ2VcblxuXHRjb25zdCBpbmZvID0gKCkgPT4gW1xuXHRcdG0oXG5cdFx0XHRcIi5mbGV4LmNvbC5pdGVtcy1lbmQucGxyXCIsXG5cdFx0XHR7XG5cdFx0XHRcdHN0eWxlOiB7XG5cdFx0XHRcdFx0bWFyZ2luVG9wOiBcIi0xNnB4XCIsXG5cdFx0XHRcdH0sXG5cdFx0XHR9LFxuXHRcdFx0W1xuXHRcdFx0XHRtKFxuXHRcdFx0XHRcdFwiZGl2Lm1yLW5lZ2F0aXZlLXhzXCIsXG5cdFx0XHRcdFx0bShFeHBhbmRlckJ1dHRvbiwge1xuXHRcdFx0XHRcdFx0ZXhwYW5kZWQ6IGV4cGFuZGVkKCksXG5cdFx0XHRcdFx0XHRvbkV4cGFuZGVkQ2hhbmdlOiBleHBhbmRlZCxcblx0XHRcdFx0XHRcdGxhYmVsOiBcInNob3dNb3JlX2FjdGlvblwiLFxuXHRcdFx0XHRcdH0pLFxuXHRcdFx0XHQpLFxuXHRcdFx0XSxcblx0XHQpLFxuXHRcdG0oXG5cdFx0XHRFeHBhbmRlclBhbmVsLFxuXHRcdFx0e1xuXHRcdFx0XHRleHBhbmRlZDogZXhwYW5kZWQoKSxcblx0XHRcdH0sXG5cdFx0XHRbXG5cdFx0XHRcdG0oXG5cdFx0XHRcdFx0XCIuZmxleC1lbmQucGxyXCIsXG5cdFx0XHRcdFx0bShCdXR0b24sIHtcblx0XHRcdFx0XHRcdGxhYmVsOiBcImNvcHlfYWN0aW9uXCIsXG5cdFx0XHRcdFx0XHRjbGljazogKCkgPT4gY29weVRvQ2xpcGJvYXJkKG1lc3NhZ2UpLFxuXHRcdFx0XHRcdFx0dHlwZTogQnV0dG9uVHlwZS5TZWNvbmRhcnksXG5cdFx0XHRcdFx0fSksXG5cdFx0XHRcdCksXG5cdFx0XHRcdG0oXG5cdFx0XHRcdFx0XCIucGxyLnNlbGVjdGFibGUucGIuc2Nyb2xsLnRleHQtcHJlXCIsXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0c3R5bGU6IHtcblx0XHRcdFx0XHRcdFx0aGVpZ2h0OiBweCgyMDApLFxuXHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdG1lc3NhZ2UsXG5cdFx0XHRcdCksXG5cdFx0XHRdLFxuXHRcdCksXG5cdF1cblxuXHRyZXR1cm4gRGlhbG9nLm1lc3NhZ2UoXCJ1bmtub3duRXJyb3JfbXNnXCIsIGluZm8pXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzZW5kRmVlZGJhY2tNYWlsKGNvbnRlbnQ6IEZlZWRiYWNrQ29udGVudCk6IFByb21pc2U8dm9pZD4ge1xuXHRjb25zdCBuYW1lID0gXCJcIlxuXHRjb25zdCBtYWlsQWRkcmVzcyA9IFwicmVwb3J0c0B0dXRhby5kZVwiXG5cdC8vIFdlIHdhbnQgdG8gdHJlYXQgd2hhdCB3ZSBoYXZlIGFzIHRleHQsIG5vdCBhcyBIVE1MIHNvIHdlIGVzY2FwZSBpdC4gVGhpcyBpcyBhbiBlYXN5IHdheSB0byBkbyBpdC5cblx0Y29uc3QgZXNjYXBlZEJvZHkgPSBuZXcgT3B0aW9uKGNvbnRlbnQubWVzc2FnZSkuaW5uZXJIVE1MXG5cdGNvbnN0IGxvZ2lucyA9IGxvY2F0b3IubG9naW5zXG5cdGNvbnN0IGRyYWZ0ID0gYXdhaXQgbG9jYXRvci5tYWlsRmFjYWRlLmNyZWF0ZURyYWZ0KHtcblx0XHRzdWJqZWN0OiBjb250ZW50LnN1YmplY3QsXG5cdFx0Ym9keVRleHQ6IGNvbnZlcnRUZXh0VG9IdG1sKGVzY2FwZWRCb2R5KSxcblx0XHRzZW5kZXJNYWlsQWRkcmVzczogbmV2ZXJOdWxsKGxvZ2lucy5nZXRVc2VyQ29udHJvbGxlcigpLnVzZXJHcm91cEluZm8ubWFpbEFkZHJlc3MpLFxuXHRcdHNlbmRlck5hbWU6IFwiXCIsXG5cdFx0dG9SZWNpcGllbnRzOiBbXG5cdFx0XHR7XG5cdFx0XHRcdG5hbWUsXG5cdFx0XHRcdGFkZHJlc3M6IG1haWxBZGRyZXNzLFxuXHRcdFx0fSxcblx0XHRdLFxuXHRcdGNjUmVjaXBpZW50czogW10sXG5cdFx0YmNjUmVjaXBpZW50czogW10sXG5cdFx0Y29udmVyc2F0aW9uVHlwZTogQ29udmVyc2F0aW9uVHlwZS5ORVcsXG5cdFx0cHJldmlvdXNNZXNzYWdlSWQ6IG51bGwsXG5cdFx0YXR0YWNobWVudHM6IGNvbnRlbnQubG9ncyxcblx0XHRjb25maWRlbnRpYWw6IHRydWUsXG5cdFx0cmVwbHlUb3M6IFtdLFxuXHRcdG1ldGhvZDogTWFpbE1ldGhvZC5OT05FLFxuXHR9KVxuXHRhd2FpdCBsb2NhdG9yLm1haWxGYWNhZGUuc2VuZERyYWZ0KFxuXHRcdGRyYWZ0LFxuXHRcdFtcblx0XHRcdHtcblx0XHRcdFx0bmFtZSxcblx0XHRcdFx0YWRkcmVzczogbWFpbEFkZHJlc3MsXG5cdFx0XHRcdHR5cGU6IFJlY2lwaWVudFR5cGUuSU5URVJOQUwsXG5cdFx0XHRcdGNvbnRhY3Q6IG51bGwsXG5cdFx0XHR9LFxuXHRcdF0sXG5cdFx0XCJkZVwiLFxuXHQpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNlbmRUb1NlcnZlcihlcnJvcjogRXJyb3JJbmZvLCB1c2VyTWVzc2FnZTogc3RyaW5nIHwgbnVsbCwgbG9nczogRGF0YUZpbGVbXSkge1xuXHRmdW5jdGlvbiBnZXRSZXBvcnRpbmdDbGllbnRUeXBlKCk6IEVycm9yUmVwb3J0Q2xpZW50VHlwZSB7XG5cdFx0aWYgKGVudi5tb2RlID09PSBNb2RlLkJyb3dzZXIpIHtcblx0XHRcdHJldHVybiBFcnJvclJlcG9ydENsaWVudFR5cGUuQnJvd3NlclxuXHRcdH0gZWxzZSB7XG5cdFx0XHRzd2l0Y2ggKGVudi5wbGF0Zm9ybUlkKSB7XG5cdFx0XHRcdGNhc2UgXCJpb3NcIjpcblx0XHRcdFx0XHRyZXR1cm4gRXJyb3JSZXBvcnRDbGllbnRUeXBlLklvc1xuXHRcdFx0XHRjYXNlIFwiYW5kcm9pZFwiOlxuXHRcdFx0XHRcdHJldHVybiBFcnJvclJlcG9ydENsaWVudFR5cGUuQW5kcm9pZFxuXHRcdFx0XHRjYXNlIFwiZGFyd2luXCI6XG5cdFx0XHRcdFx0cmV0dXJuIEVycm9yUmVwb3J0Q2xpZW50VHlwZS5NYWNPU1xuXHRcdFx0XHRjYXNlIFwibGludXhcIjpcblx0XHRcdFx0XHRyZXR1cm4gRXJyb3JSZXBvcnRDbGllbnRUeXBlLkxpbnV4XG5cdFx0XHRcdGNhc2UgXCJ3aW4zMlwiOlxuXHRcdFx0XHRcdHJldHVybiBFcnJvclJlcG9ydENsaWVudFR5cGUuV2luZG93c1xuXHRcdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRcdHJldHVybiBFcnJvclJlcG9ydENsaWVudFR5cGUuTGludXhcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRjb25zdCBjbGllbnRUeXBlID0gZ2V0UmVwb3J0aW5nQ2xpZW50VHlwZSgpXG5cblx0Y29uc3QgZXJyb3JEYXRhID0gY3JlYXRlUmVwb3J0RXJyb3JJbih7XG5cdFx0ZGF0YTogY3JlYXRlRXJyb3JSZXBvcnREYXRhKHtcblx0XHRcdGNsaWVudFR5cGUsXG5cdFx0XHRhcHBWZXJzaW9uOiBlbnYudmVyc2lvbk51bWJlcixcblx0XHRcdHVzZXJJZDogbG9jYXRvci5sb2dpbnMuZ2V0VXNlckNvbnRyb2xsZXIoKS51c2VySWQsXG5cdFx0XHRlcnJvckNsYXNzOiBlcnJvci5uYW1lID8/IFwiP1wiLFxuXHRcdFx0ZXJyb3JNZXNzYWdlOiBlcnJvci5tZXNzYWdlLFxuXHRcdFx0dXNlck1lc3NhZ2U6IHVzZXJNZXNzYWdlLFxuXHRcdFx0c3RhY2tUcmFjZTogZXJyb3Iuc3RhY2sgPz8gXCJcIixcblx0XHRcdGFkZGl0aW9uYWxJbmZvOiBjbGllbnQudXNlckFnZW50LFxuXHRcdFx0dGltZTogbmV3IERhdGUoKSxcblx0XHR9KSxcblx0XHRmaWxlczogbG9ncy5tYXAoKGxvZykgPT4ge1xuXHRcdFx0Y29uc3Qgc3RyaW5nRGF0YSA9IHVpbnQ4QXJyYXlUb1N0cmluZyhcInV0Zi04XCIsIGxvZy5kYXRhKVxuXHRcdFx0cmV0dXJuIGNyZWF0ZUVycm9yUmVwb3J0RmlsZSh7XG5cdFx0XHRcdG5hbWU6IGxvZy5uYW1lLFxuXHRcdFx0XHRjb250ZW50OiBzdHJpbmdEYXRhLFxuXHRcdFx0fSlcblx0XHR9KSxcblx0fSlcblx0YXdhaXQgbG9jYXRvci5zZXJ2aWNlRXhlY3V0b3IucG9zdChSZXBvcnRFcnJvclNlcnZpY2UsIGVycm9yRGF0YSlcbn1cblxuZnVuY3Rpb24gcHJlcGFyZUZlZWRiYWNrQ29udGVudChlcnJvcjogRXJyb3JJbmZvLCBsb2dnZWRJbjogYm9vbGVhbik6IEZlZWRiYWNrQ29udGVudCB7XG5cdGNvbnN0IHRpbWVzdGFtcCA9IG5ldyBEYXRlKClcblx0bGV0IHsgbWVzc2FnZSwgY2xpZW50LCB0eXBlIH0gPSBjbGllbnRJbmZvU3RyaW5nKHRpbWVzdGFtcCwgbG9nZ2VkSW4pXG5cblx0aWYgKGVycm9yKSB7XG5cdFx0bWVzc2FnZSArPSBlcnJvclRvU3RyaW5nKGVycm9yKVxuXHR9XG5cblx0Y29uc3Qgc3ViamVjdCA9IGBGZWVkYmFjayB2JHtlbnYudmVyc2lvbk51bWJlcn0gLSAke2Vycm9yICYmIGVycm9yLm5hbWUgPyBlcnJvci5uYW1lIDogXCI/XCJ9IC0gJHt0eXBlfSAtICR7Y2xpZW50fWBcblx0cmV0dXJuIHtcblx0XHRtZXNzYWdlLFxuXHRcdHN1YmplY3QsXG5cdFx0bG9nczogW10sXG5cdH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNsaWVudEluZm9TdHJpbmcoXG5cdHRpbWVzdGFtcDogRGF0ZSxcblx0bG9nZ2VkSW46IGJvb2xlYW4sXG4pOiB7XG5cdG1lc3NhZ2U6IHN0cmluZ1xuXHRjbGllbnQ6IHN0cmluZ1xuXHR0eXBlOiBzdHJpbmdcbn0ge1xuXHRjb25zdCB0eXBlID0gbG9nZ2VkSW5cblx0XHQ/IG5ldmVyTnVsbCh0eXBlZEtleXMoQWNjb3VudFR5cGUpLmZpbmQoKHR5cGVOYW1lKSA9PiBBY2NvdW50VHlwZVt0eXBlTmFtZV0gPT09IGxvY2F0b3IubG9naW5zLmdldFVzZXJDb250cm9sbGVyKCkudXNlci5hY2NvdW50VHlwZSkpXG5cdFx0OiBcIlVOS05PV05cIlxuXG5cdGNvbnN0IGNsaWVudCA9ICgoKSA9PiB7XG5cdFx0c3dpdGNoIChlbnYubW9kZSkge1xuXHRcdFx0Y2FzZSBNb2RlLkJyb3dzZXI6XG5cdFx0XHRjYXNlIE1vZGUuVGVzdDpcblx0XHRcdFx0cmV0dXJuIGVudi5tb2RlXG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHRyZXR1cm4gZW52LnBsYXRmb3JtSWQgPz8gXCJcIlxuXHRcdH1cblx0fSkoKVxuXG5cdGxldCBtZXNzYWdlID0gYFxcblxcbiBDbGllbnQ6ICR7Y2xpZW50fWBcblx0bWVzc2FnZSArPSBgXFxuIFR5cGU6ICR7dHlwZX1gXG5cdG1lc3NhZ2UgKz0gYFxcbiBUdXRhbm90YSB2ZXJzaW9uOiAke2Vudi52ZXJzaW9uTnVtYmVyfWBcblx0bWVzc2FnZSArPSBgXFxuIFRpbWVzdGFtcCAoVVRDKTogJHt0aW1lc3RhbXAudG9VVENTdHJpbmcoKX1gXG5cdG1lc3NhZ2UgKz0gYFxcbiBUaW1lIHpvbmU6ICR7Z2V0VGltZVpvbmUoKX1gXG5cdG1lc3NhZ2UgKz0gYFxcbiBVc2VyIGFnZW50OiAke25hdmlnYXRvci51c2VyQWdlbnR9XFxuYFxuXHRyZXR1cm4ge1xuXHRcdG1lc3NhZ2UsXG5cdFx0Y2xpZW50LFxuXHRcdHR5cGUsXG5cdH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldExvZ0F0dGFjaG1lbnRzKHRpbWVzdGFtcD86IERhdGUpOiBQcm9taXNlPEFycmF5PERhdGFGaWxlPj4ge1xuXHRjb25zdCBsb2dzOiBBcnJheTxEYXRhRmlsZT4gPSBbXVxuXHRjb25zdCBnbG9iYWwgPSBkb3duY2FzdDxXaW5kb3c+KHdpbmRvdylcblxuXHRpZiAoZ2xvYmFsLmxvZ2dlcikge1xuXHRcdGNvbnN0IG1haW5FbnRyaWVzID0gZ2xvYmFsLmxvZ2dlci5nZXRFbnRyaWVzKClcblx0XHRjb25zdCBtYWluTG9nRmlsZSA9IGNyZWF0ZUxvZ0ZpbGUobWFpbkVudHJpZXMuam9pbihcIlxcblwiKSwgXCJtYWluXCIsIHRpbWVzdGFtcD8uZ2V0VGltZSgpKVxuXHRcdGxvZ3MucHVzaChtYWluTG9nRmlsZSlcblx0XHRjb25zdCB3b3JrZXJMb2dFbnRyaWVzID0gYXdhaXQgbG9jYXRvci53b3JrZXJGYWNhZGUuZ2V0TG9nKClcblx0XHRjb25zdCB3b3JrZXJMb2dGaWxlID0gYXdhaXQgY3JlYXRlTG9nRmlsZSh3b3JrZXJMb2dFbnRyaWVzLmpvaW4oXCJcXG5cIiksIFwid29ya2VyXCIsIHRpbWVzdGFtcD8uZ2V0VGltZSgpKVxuXHRcdGxvZ3MucHVzaCh3b3JrZXJMb2dGaWxlKVxuXHR9XG5cblx0aWYgKGlzRGVza3RvcCgpIHx8IGlzQXBwKCkpIHtcblx0XHRjb25zdCBuYXRpdmVMb2cgPSBhd2FpdCBsb2NhdG9yLmNvbW1vblN5c3RlbUZhY2FkZS5nZXRMb2coKVxuXHRcdGNvbnN0IG5hdGl2ZUxvZ0ZpbGUgPSBjcmVhdGVMb2dGaWxlKG5hdGl2ZUxvZywgaXNEZXNrdG9wKCkgPyBcImRlc2t0b3BcIiA6IFwiZGV2aWNlXCIsIHRpbWVzdGFtcD8uZ2V0VGltZSgpKVxuXHRcdGxvZ3MucHVzaChuYXRpdmVMb2dGaWxlKVxuXHR9XG5cblx0cmV0dXJuIGxvZ3Ncbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXNDTyxlQUFlLHNCQUFzQkEsR0FBNkM7Q0FDeEYsTUFBTSxXQUFXLFFBQVEsT0FBTyxnQkFBZ0I7Q0FFaEQsTUFBTSxPQUFPLE1BQU0sbUJBQW1CO0NBRXRDLE1BQU0sRUFBRSxVQUFVLFFBQVEsR0FBRyxNQUFNLGtCQUFrQjtBQUNyRCxLQUFJLGFB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