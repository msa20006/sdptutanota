import "./dist-chunk.js";
import "./ProgrammingError-chunk.js";
import { assertWorkerOrNode } from "./Env-chunk.js";
import { assertNotNull, isNotNull } from "./dist2-chunk.js";
import { ArchiveDataType } from "./TutanotaConstants-chunk.js";
import { elementIdPart } from "./EntityUtils-chunk.js";
import "./TypeModels-chunk.js";
import "./TypeModels2-chunk.js";
import "./EntityFunctions-chunk.js";
import "./TypeModels3-chunk.js";
import "./ModelInfo-chunk.js";
import { NotFoundError } from "./RestError-chunk.js";
import "./SuspensionError-chunk.js";
import { SuspensionBehavior } from "./RestClient-chunk.js";
import { convertToDataFile, createReferencingInstance } from "./BlobUtils-chunk.js";

//#region src/common/api/worker/facades/lazy/MailExportFacade.ts
assertWorkerOrNode();
const MAIL_EXPORT_TOKEN_HEADER = "mailExportToken";
var MailExportFacade = class {
	constructor(mailExportTokenFacade, bulkMailLoader, blobFacade, cryptoFacade, blobAccessTokenFacade) {
		this.mailExportTokenFacade = mailExportTokenFacade;
		this.bulkMailLoader = bulkMailLoader;
		this.blobFacade = blobFacade;
		this.cryptoFacade = cryptoFacade;
		this.blobAccessTokenFacade = blobAccessTokenFacade;
	}
	/**
	* Returns a list of servers that can be used to request data from.
	*/
	async getExportServers(group) {
		const blobServerAccessInfo = await this.blobAccessTokenFacade.requestWriteToken(ArchiveDataType.Attachments, group._id);
		return blobServerAccessInfo.servers;
	}
	async loadFixedNumberOfMailsWithCache(mailListId, startId, baseUrl) {
		return this.mailExportTokenFacade.loadWithToken((token) => this.bulkMailLoader.loadFixedNumberOfMailsWithCache(mailListId, startId, {
			baseUrl,
			...this.options(token)
		}));
	}
	async loadMailDetails(mails) {
		return this.mailExportTokenFacade.loadWithToken((token) => this.bulkMailLoader.loadMailDetails(mails, this.options(token)));
	}
	async loadAttachments(mails, baseUrl) {
		return this.mailExportTokenFacade.loadWithToken((token) => this.bulkMailLoader.loadAttachments(mails, {
			baseUrl,
			...this.options(token)
		}));
	}
	async loadAttachmentData(mail, attachments) {
		const attachmentsWithKeys = await this.cryptoFacade.enforceSessionKeyUpdateIfNeeded(mail, attachments);
		const downloads = await this.mailExportTokenFacade.loadWithToken((token) => {
			const referencingInstances = attachmentsWithKeys.map(createReferencingInstance);
			return this.blobFacade.downloadAndDecryptBlobsOfMultipleInstances(ArchiveDataType.Attachments, referencingInstances, { ...this.options(token) });
		});
		const attachmentData = Array.from(downloads.entries()).map(([fileId, bytes]) => {
			try {
				if (bytes == null) return null;
else {
					const attachment = assertNotNull(attachmentsWithKeys.find((attachment$1) => elementIdPart(attachment$1._id) === fileId));
					return convertToDataFile(attachment, bytes);
				}
			} catch (e) {
				if (e instanceof NotFoundError) return null;
else throw e;
			}
		});
		return attachmentData.filter(isNotNull);
	}
	options(token) {
		return {
			extraHeaders: { [MAIL_EXPORT_TOKEN_HEADER]: token },
			suspensionBehavior: SuspensionBehavior.Throw
		};
	}
};

//#endregion
export { MailExportFacade };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbEV4cG9ydEZhY2FkZS1jaHVuay5qcyIsIm5hbWVzIjpbIm1haWxFeHBvcnRUb2tlbkZhY2FkZTogTWFpbEV4cG9ydFRva2VuRmFjYWRlIiwiYnVsa01haWxMb2FkZXI6IEJ1bGtNYWlsTG9hZGVyIiwiYmxvYkZhY2FkZTogQmxvYkZhY2FkZSIsImNyeXB0b0ZhY2FkZTogQ3J5cHRvRmFjYWRlIiwiYmxvYkFjY2Vzc1Rva2VuRmFjYWRlOiBCbG9iQWNjZXNzVG9rZW5GYWNhZGUiLCJncm91cDogR3JvdXAiLCJtYWlsTGlzdElkOiBJZCIsInN0YXJ0SWQ6IElkIiwiYmFzZVVybDogc3RyaW5nIiwibWFpbHM6IHJlYWRvbmx5IE1haWxbXSIsIm1haWw6IE1haWwiLCJhdHRhY2htZW50czogcmVhZG9ubHkgVHV0YW5vdGFGaWxlW10iLCJhdHRhY2htZW50IiwidG9rZW46IHN0cmluZyJdLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21tb24vYXBpL3dvcmtlci9mYWNhZGVzL2xhenkvTWFpbEV4cG9ydEZhY2FkZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGaWxlIGFzIFR1dGFub3RhRmlsZSwgTWFpbCB9IGZyb20gXCIuLi8uLi8uLi9lbnRpdGllcy90dXRhbm90YS9UeXBlUmVmc1wiXG5pbXBvcnQgeyBhc3NlcnRXb3JrZXJPck5vZGUgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL0VudlwiXG5pbXBvcnQgeyBCdWxrTWFpbExvYWRlciwgTWFpbFdpdGhNYWlsRGV0YWlscyB9IGZyb20gXCIuLi8uLi8uLi8uLi8uLi9tYWlsLWFwcC93b3JrZXJVdGlscy9pbmRleC9CdWxrTWFpbExvYWRlci5qc1wiXG5pbXBvcnQgeyBjb252ZXJ0VG9EYXRhRmlsZSwgRGF0YUZpbGUgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL0RhdGFGaWxlLmpzXCJcbmltcG9ydCB7IEFyY2hpdmVEYXRhVHlwZSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vVHV0YW5vdGFDb25zdGFudHMuanNcIlxuaW1wb3J0IHsgQmxvYkZhY2FkZSB9IGZyb20gXCIuL0Jsb2JGYWNhZGUuanNcIlxuaW1wb3J0IHsgQ3J5cHRvRmFjYWRlIH0gZnJvbSBcIi4uLy4uL2NyeXB0by9DcnlwdG9GYWNhZGUuanNcIlxuaW1wb3J0IHsgY3JlYXRlUmVmZXJlbmNpbmdJbnN0YW5jZSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vdXRpbHMvQmxvYlV0aWxzLmpzXCJcbmltcG9ydCB7IE1haWxFeHBvcnRUb2tlbkZhY2FkZSB9IGZyb20gXCIuL01haWxFeHBvcnRUb2tlbkZhY2FkZS5qc1wiXG5pbXBvcnQgeyBhc3NlcnROb3ROdWxsLCBpc05vdE51bGwgfSBmcm9tIFwiQHR1dGFvL3R1dGFub3RhLXV0aWxzXCJcbmltcG9ydCB7IE5vdEZvdW5kRXJyb3IgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL2Vycm9yL1Jlc3RFcnJvclwiXG5pbXBvcnQgeyBlbGVtZW50SWRQYXJ0IH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi91dGlscy9FbnRpdHlVdGlsc1wiXG5pbXBvcnQgeyBCbG9iQWNjZXNzVG9rZW5GYWNhZGUgfSBmcm9tIFwiLi4vQmxvYkFjY2Vzc1Rva2VuRmFjYWRlXCJcbmltcG9ydCB7IEJsb2JTZXJ2ZXJVcmwgfSBmcm9tIFwiLi4vLi4vLi4vZW50aXRpZXMvc3RvcmFnZS9UeXBlUmVmc1wiXG5pbXBvcnQgeyBHcm91cCB9IGZyb20gXCIuLi8uLi8uLi9lbnRpdGllcy9zeXMvVHlwZVJlZnNcIlxuaW1wb3J0IHsgU3VzcGVuc2lvbkJlaGF2aW9yIH0gZnJvbSBcIi4uLy4uL3Jlc3QvUmVzdENsaWVudFwiXG5cbmFzc2VydFdvcmtlck9yTm9kZSgpXG5cbi8qKlxuICogRGVub3RlcyB0aGUgaGVhZGVyIHRoYXQgd2lsbCBoYXZlIHRoZSBtYWlsIGV4cG9ydCB0b2tlbi5cbiAqL1xuZXhwb3J0IGNvbnN0IE1BSUxfRVhQT1JUX1RPS0VOX0hFQURFUiA9IFwibWFpbEV4cG9ydFRva2VuXCJcblxuLyoqXG4gKiBXcmFwcyBidWxrIGxvYWRpbmcgb2YgbWFpbHMgZm9yIG1haWwgZXhwb3J0LlxuICpcbiAqIFRha2VzIGNhcmUgb2YgdXNpbmcgbWFpbCBleHBvcnQgdG9rZW5zLlxuICovXG5leHBvcnQgY2xhc3MgTWFpbEV4cG9ydEZhY2FkZSB7XG5cdGNvbnN0cnVjdG9yKFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgbWFpbEV4cG9ydFRva2VuRmFjYWRlOiBNYWlsRXhwb3J0VG9rZW5GYWNhZGUsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBidWxrTWFpbExvYWRlcjogQnVsa01haWxMb2FkZXIsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBibG9iRmFjYWRlOiBCbG9iRmFjYWRlLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgY3J5cHRvRmFjYWRlOiBDcnlwdG9GYWNhZGUsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBibG9iQWNjZXNzVG9rZW5GYWNhZGU6IEJsb2JBY2Nlc3NUb2tlbkZhY2FkZSxcblx0KSB7fVxuXG5cdC8qKlxuXHQgKiBSZXR1cm5zIGEgbGlzdCBvZiBzZXJ2ZXJzIHRoYXQgY2FuIGJlIHVzZWQgdG8gcmVxdWVzdCBkYXRhIGZyb20uXG5cdCAqL1xuXHRhc3luYyBnZXRFeHBvcnRTZXJ2ZXJzKGdyb3VwOiBHcm91cCk6IFByb21pc2U8QmxvYlNlcnZlclVybFtdPiB7XG5cdFx0Y29uc3QgYmxvYlNlcnZlckFjY2Vzc0luZm8gPSBhd2FpdCB0aGlzLmJsb2JBY2Nlc3NUb2tlbkZhY2FkZS5yZXF1ZXN0V3JpdGVUb2tlbihBcmNoaXZlRGF0YVR5cGUuQXR0YWNobWVudHMsIGdyb3VwLl9pZClcblx0XHRyZXR1cm4gYmxvYlNlcnZlckFjY2Vzc0luZm8uc2VydmVyc1xuXHR9XG5cblx0YXN5bmMgbG9hZEZpeGVkTnVtYmVyT2ZNYWlsc1dpdGhDYWNoZShtYWlsTGlzdElkOiBJZCwgc3RhcnRJZDogSWQsIGJhc2VVcmw6IHN0cmluZyk6IFByb21pc2U8TWFpbFtdPiB7XG5cdFx0cmV0dXJuIHRoaXMubWFpbEV4cG9ydFRva2VuRmFjYWRlLmxvYWRXaXRoVG9rZW4oKHRva2VuKSA9PlxuXHRcdFx0dGhpcy5idWxrTWFpbExvYWRlci5sb2FkRml4ZWROdW1iZXJPZk1haWxzV2l0aENhY2hlKG1haWxMaXN0SWQsIHN0YXJ0SWQsIHsgYmFzZVVybCwgLi4udGhpcy5vcHRpb25zKHRva2VuKSB9KSxcblx0XHQpXG5cdH1cblxuXHRhc3luYyBsb2FkTWFpbERldGFpbHMobWFpbHM6IHJlYWRvbmx5IE1haWxbXSk6IFByb21pc2U8TWFpbFdpdGhNYWlsRGV0YWlsc1tdPiB7XG5cdFx0cmV0dXJuIHRoaXMubWFpbEV4cG9ydFRva2VuRmFjYWRlLmxvYWRXaXRoVG9rZW4oKHRva2VuKSA9PiB0aGlzLmJ1bGtNYWlsTG9hZGVyLmxvYWRNYWlsRGV0YWlscyhtYWlscywgdGhpcy5vcHRpb25zKHRva2VuKSkpXG5cdH1cblxuXHRhc3luYyBsb2FkQXR0YWNobWVudHMobWFpbHM6IHJlYWRvbmx5IE1haWxbXSwgYmFzZVVybDogc3RyaW5nKTogUHJvbWlzZTxUdXRhbm90YUZpbGVbXT4ge1xuXHRcdHJldHVybiB0aGlzLm1haWxFeHBvcnRUb2tlbkZhY2FkZS5sb2FkV2l0aFRva2VuKCh0b2tlbikgPT4gdGhpcy5idWxrTWFpbExvYWRlci5sb2FkQXR0YWNobWVudHMobWFpbHMsIHsgYmFzZVVybCwgLi4udGhpcy5vcHRpb25zKHRva2VuKSB9KSlcblx0fVxuXG5cdGFzeW5jIGxvYWRBdHRhY2htZW50RGF0YShtYWlsOiBNYWlsLCBhdHRhY2htZW50czogcmVhZG9ubHkgVHV0YW5vdGFGaWxlW10pOiBQcm9taXNlPERhdGFGaWxlW10+IHtcblx0XHRjb25zdCBhdHRhY2htZW50c1dpdGhLZXlzID0gYXdhaXQgdGhpcy5jcnlwdG9GYWNhZGUuZW5mb3JjZVNlc3Npb25LZXlVcGRhdGVJZk5lZWRlZChtYWlsLCBhdHRhY2htZW50cylcblxuXHRcdGNvbnN0IGRvd25sb2FkcyA9IGF3YWl0IHRoaXMubWFpbEV4cG9ydFRva2VuRmFjYWRlLmxvYWRXaXRoVG9rZW4oKHRva2VuKSA9PiB7XG5cdFx0XHRjb25zdCByZWZlcmVuY2luZ0luc3RhbmNlcyA9IGF0dGFjaG1lbnRzV2l0aEtleXMubWFwKGNyZWF0ZVJlZmVyZW5jaW5nSW5zdGFuY2UpXG5cdFx0XHRyZXR1cm4gdGhpcy5ibG9iRmFjYWRlLmRvd25sb2FkQW5kRGVjcnlwdEJsb2JzT2ZNdWx0aXBsZUluc3RhbmNlcyhBcmNoaXZlRGF0YVR5cGUuQXR0YWNobWVudHMsIHJlZmVyZW5jaW5nSW5zdGFuY2VzLCB7XG5cdFx0XHRcdC4uLnRoaXMub3B0aW9ucyh0b2tlbiksXG5cdFx0XHR9KVxuXHRcdH0pXG5cblx0XHRjb25zdCBhdHRhY2htZW50RGF0YSA9IEFycmF5LmZyb20oZG93bmxvYWRzLmVudHJpZXMoKSkubWFwKChbZmlsZUlkLCBieXRlc10pID0+IHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdGlmIChieXRlcyA9PSBudWxsKSB7XG5cdFx0XHRcdFx0cmV0dXJuIG51bGxcblx0XHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0XHRjb25zdCBhdHRhY2htZW50ID0gYXNzZXJ0Tm90TnVsbChhdHRhY2htZW50c1dpdGhLZXlzLmZpbmQoKGF0dGFjaG1lbnQpID0+IGVsZW1lbnRJZFBhcnQoYXR0YWNobWVudC5faWQpID09PSBmaWxlSWQpKVxuXHRcdFx0XHRcdHJldHVybiBjb252ZXJ0VG9EYXRhRmlsZShhdHRhY2htZW50LCBieXRlcylcblx0XHRcdFx0fVxuXHRcdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0XHRpZiAoZSBpbnN0YW5jZW9mIE5vdEZvdW5kRXJyb3IpIHtcblx0XHRcdFx0XHRyZXR1cm4gbnVsbFxuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHRocm93IGVcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0pXG5cblx0XHRyZXR1cm4gYXR0YWNobWVudERhdGEuZmlsdGVyKGlzTm90TnVsbClcblx0fVxuXG5cdHByaXZhdGUgb3B0aW9ucyh0b2tlbjogc3RyaW5nKTogeyBleHRyYUhlYWRlcnM6IERpY3Q7IHN1c3BlbnNpb25CZWhhdmlvcjogU3VzcGVuc2lvbkJlaGF2aW9yLlRocm93IH0ge1xuXHRcdHJldHVybiB7XG5cdFx0XHRleHRyYUhlYWRlcnM6IHtcblx0XHRcdFx0W01BSUxfRVhQT1JUX1RPS0VOX0hFQURFUl06IHRva2VuLFxuXHRcdFx0fSxcblx0XHRcdHN1c3BlbnNpb25CZWhhdmlvcjogU3VzcGVuc2lvbkJlaGF2aW9yLlRocm93LFxuXHRcdH1cblx0fVxufVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQWlCQSxvQkFBb0I7TUFLUCwyQkFBMkI7SUFPM0IsbUJBQU4sTUFBdUI7Q0FDN0IsWUFDa0JBLHVCQUNBQyxnQkFDQUMsWUFDQUMsY0FDQUMsdUJBQ2hCO0VBK0RGLEtBcEVrQjtFQW9FakIsS0FuRWlCO0VBbUVoQixLQWxFZ0I7RUFrRWYsS0FqRWU7RUFpRWQsS0FoRWM7Q0FDZDs7OztDQUtKLE1BQU0saUJBQWlCQyxPQUF3QztFQUM5RCxNQUFNLHVCQUF1QixNQUFNLEtBQUssc0JBQXNCLGtCQUFrQixnQkFBZ0IsYUFBYSxNQUFNLElBQUk7QUFDdkgsU0FBTyxxQkFBcUI7Q0FDNUI7Q0FFRCxNQUFNLGdDQUFnQ0MsWUFBZ0JDLFNBQWFDLFNBQWtDO0FBQ3BHLFNBQU8sS0FBSyxzQkFBc0IsY0FBYyxDQUFDLFVBQ2hELEtBQUssZUFBZSxnQ0FBZ0MsWUFBWSxTQUFTO0dBQUU7R0FBUyxHQUFHLEtBQUssUUFBUSxNQUFNO0VBQUUsRUFBQyxDQUM3RztDQUNEO0NBRUQsTUFBTSxnQkFBZ0JDLE9BQXdEO0FBQzdFLFNBQU8sS0FBSyxzQkFBc0IsY0FBYyxDQUFDLFVBQVUsS0FBSyxlQUFlLGdCQUFnQixPQUFPLEtBQUssUUFBUSxNQUFNLENBQUMsQ0FBQztDQUMzSDtDQUVELE1BQU0sZ0JBQWdCQSxPQUF3QkQsU0FBMEM7QUFDdkYsU0FBTyxLQUFLLHNCQUFzQixjQUFjLENBQUMsVUFBVSxLQUFLLGVBQWUsZ0JBQWdCLE9BQU87R0FBRTtHQUFTLEdBQUcsS0FBSyxRQUFRLE1BQU07RUFBRSxFQUFDLENBQUM7Q0FDM0k7Q0FFRCxNQUFNLG1CQUFtQkUsTUFBWUMsYUFBMkQ7RUFDL0YsTUFBTSxzQkFBc0IsTUFBTSxLQUFLLGFBQWEsZ0NBQWdDLE1BQU0sWUFBWTtFQUV0RyxNQUFNLFlBQVksTUFBTSxLQUFLLHNCQUFzQixjQUFjLENBQUMsVUFBVTtHQUMzRSxNQUFNLHVCQUF1QixvQkFBb0IsSUFBSSwwQkFBMEI7QUFDL0UsVUFBTyxLQUFLLFdBQVcsMkNBQTJDLGdCQUFnQixhQUFhLHNCQUFzQixFQUNwSCxHQUFHLEtBQUssUUFBUSxNQUFNLENBQ3RCLEVBQUM7RUFDRixFQUFDO0VBRUYsTUFBTSxpQkFBaUIsTUFBTSxLQUFLLFVBQVUsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxNQUFNLEtBQUs7QUFDL0UsT0FBSTtBQUNILFFBQUksU0FBUyxLQUNaLFFBQU87S0FDRDtLQUNOLE1BQU0sYUFBYSxjQUFjLG9CQUFvQixLQUFLLENBQUNDLGlCQUFlLGNBQWNBLGFBQVcsSUFBSSxLQUFLLE9BQU8sQ0FBQztBQUNwSCxZQUFPLGtCQUFrQixZQUFZLE1BQU07SUFDM0M7R0FDRCxTQUFRLEdBQUc7QUFDWCxRQUFJLGFBQWEsY0FDaEIsUUFBTztJQUVQLE9BQU07R0FFUDtFQUNELEVBQUM7QUFFRixTQUFPLGVBQWUsT0FBTyxVQUFVO0NBQ3ZDO0NBRUQsQUFBUSxRQUFRQyxPQUFxRjtBQUNwRyxTQUFPO0dBQ04sY0FBYyxHQUNaLDJCQUEyQixNQUM1QjtHQUNELG9CQUFvQixtQkFBbUI7RUFDdkM7Q0FDRDtBQUNEIn0=