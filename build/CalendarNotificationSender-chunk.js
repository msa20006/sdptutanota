import "./dist-chunk.js";
import { ProgrammingError } from "./ProgrammingError-chunk.js";
import "./Env-chunk.js";
import "./ClientDetector-chunk.js";
import "./mithril-chunk.js";
import { assertNotNull, noOp, ofClass } from "./dist2-chunk.js";
import "./WhitelabelCustomizations-chunk.js";
import { lang } from "./LanguageViewModel-chunk.js";
import "./styles-chunk.js";
import "./theme-chunk.js";
import { MailMethod, getAttendeeStatus, mailMethodToCalendarMethod } from "./TutanotaConstants-chunk.js";
import "./KeyManager-chunk.js";
import { windowFacade } from "./WindowFacade-chunk.js";
import "./RootView-chunk.js";
import "./size-chunk.js";
import "./HtmlUtils-chunk.js";
import "./luxon-chunk.js";
import "./EntityUtils-chunk.js";
import "./TypeModels-chunk.js";
import { createCalendarEventAttendee } from "./TypeRefs-chunk.js";
import { cleanMailAddress, findAttendeeInAddresses, findRecipientWithAddress } from "./CommonCalendarUtils-chunk.js";
import "./TypeModels2-chunk.js";
import "./TypeRefs2-chunk.js";
import "./ParserCombinator-chunk.js";
import { getTimeZone } from "./CalendarUtils-chunk.js";
import "./ImportExportUtils-chunk.js";
import "./FormatValidator-chunk.js";
import "./stream-chunk.js";
import "./EntityFunctions-chunk.js";
import "./TypeModels3-chunk.js";
import "./ModelInfo-chunk.js";
import "./ErrorUtils-chunk.js";
import "./RestError-chunk.js";
import "./SetupMultipleError-chunk.js";
import "./OutOfSyncError-chunk.js";
import "./CancelledError-chunk.js";
import "./SuspensionError-chunk.js";
import "./LoginIncompleteError-chunk.js";
import "./CryptoError-chunk.js";
import "./error-chunk.js";
import { RecipientsNotFoundError } from "./RecipientsNotFoundError-chunk.js";
import "./DbError-chunk.js";
import "./QuotaExceededError-chunk.js";
import "./DeviceStorageUnavailableError-chunk.js";
import "./MailBodyTooLargeError-chunk.js";
import "./ImportError-chunk.js";
import "./WebauthnError-chunk.js";
import "./PermissionError-chunk.js";
import "./EntityUpdateUtils-chunk.js";
import "./dist3-chunk.js";
import "./Services-chunk.js";
import "./EntityClient-chunk.js";
import "./BirthdayUtils-chunk.js";
import "./Services2-chunk.js";
import "./GroupUtils-chunk.js";
import "./Button-chunk.js";
import "./Icons-chunk.js";
import "./DialogHeaderBar-chunk.js";
import "./CountryList-chunk.js";
import "./Dialog-chunk.js";
import "./Icon-chunk.js";
import "./AriaUtils-chunk.js";
import "./IconButton-chunk.js";
import "./CalendarEventWhenModel-chunk.js";
import "./Formatter-chunk.js";
import "./ProgressMonitor-chunk.js";
import "./Notifications-chunk.js";
import "./CalendarFacade-chunk.js";
import "./CalendarModel-chunk.js";
import "./GroupUtils2-chunk.js";
import "./CommonLocator-chunk.js";
import "./UserError-chunk.js";
import "./MailAddressParser-chunk.js";
import "./BlobUtils-chunk.js";
import "./FileUtils-chunk.js";
import "./ProgressDialog-chunk.js";
import { RecipientField } from "./SharedMailUtils-chunk.js";
import "./PasswordUtils-chunk.js";
import "./Recipient-chunk.js";
import "./ContactUtils-chunk.js";
import "./RecipientsModel-chunk.js";
import { calendarAttendeeStatusSymbol, formatEventDuration } from "./CalendarGuiUtils-chunk.js";
import "./UpgradeRequiredError-chunk.js";
import "./ColorPickerModel-chunk.js";
import { makeInvitationCalendarFile } from "./CalendarExporter-chunk.js";

//#region src/calendar-app/calendar/view/CalendarNotificationSender.ts
var CalendarNotificationSender = class {
	/** Used for knowing how many emails are in the process of being sent. */
	countDownLatch;
	constructor() {
		this.countDownLatch = 0;
	}
	sendInvite(event, sendMailModel) {
		const message = lang.get("eventInviteMail_msg", { "{event}": event.summary });
		const sender = assertOrganizer(event).address;
		return this.sendCalendarFile({
			sendMailModel,
			method: MailMethod.ICAL_REQUEST,
			subject: message,
			body: makeInviteEmailBody(sender, event, message),
			event,
			sender
		});
	}
	sendUpdate(event, sendMailModel) {
		const message = lang.get("eventUpdated_msg", { "{event}": event.summary });
		const sender = assertOrganizer(event).address;
		return this.sendCalendarFile({
			sendMailModel,
			method: MailMethod.ICAL_REQUEST,
			subject: message,
			body: makeInviteEmailBody(sender, event, message),
			event,
			sender
		});
	}
	sendCancellation(event, sendMailModel) {
		const message = lang.get("eventCancelled_msg", { "{event}": event.summary });
		const sender = assertOrganizer(event).address;
		return this.sendCalendarFile({
			sendMailModel,
			method: MailMethod.ICAL_CANCEL,
			subject: message,
			body: makeInviteEmailBody(sender, event, message),
			event,
			sender
		}).catch(ofClass(RecipientsNotFoundError, (e) => {
			const invalidRecipients = e.message.split("\n");
			let hasRemovedRecipient = false;
			for (const invalidRecipient of invalidRecipients) {
				const recipientInfo = findRecipientWithAddress(sendMailModel.bccRecipients(), invalidRecipient);
				if (recipientInfo) hasRemovedRecipient = sendMailModel.removeRecipient(recipientInfo, RecipientField.BCC, false) || hasRemovedRecipient;
			}
			if (hasRemovedRecipient && sendMailModel.allRecipients().length) return this.sendCancellation(event, sendMailModel);
		}));
	}
	/**
	* send a response mail to the organizer of an event
	* @param event the event to respond to (included as a .ics file attachment)
	* @param sendMailModel used to actually send the mail
	*/
	async sendResponse(event, sendMailModel) {
		const sendAs = sendMailModel.getSender();
		const message = lang.get("repliedToEventInvite_msg", { "{event}": event.summary });
		const organizer = assertOrganizer(event);
		const body = makeInviteEmailBody(organizer.address, event, message);
		return this.sendCalendarFile({
			event,
			sendMailModel,
			method: MailMethod.ICAL_REPLY,
			subject: message,
			body,
			sender: sendAs
		});
	}
	async sendCalendarFile({ sendMailModel, method, subject, event, body, sender }) {
		const inviteFile = makeInvitationCalendarFile(event, mailMethodToCalendarMethod(method), new Date(), getTimeZone());
		sendMailModel.setSender(sender);
		sendMailModel.attachFiles([inviteFile]);
		sendMailModel.setSubject(subject);
		sendMailModel.setBody(body);
		this.sendStart();
		await sendMailModel.send(method).finally(() => this.sendEnd());
	}
	_windowUnsubscribe = null;
	sendStart() {
		this.countDownLatch++;
		if (this.countDownLatch === 1) this._windowUnsubscribe = windowFacade.addWindowCloseListener(noOp);
	}
	sendEnd() {
		this.countDownLatch--;
		if (this.countDownLatch === 0 && this._windowUnsubscribe) {
			this._windowUnsubscribe();
			this._windowUnsubscribe = null;
		}
	}
};
function summaryLine(event) {
	return newLine(lang.get("name_label"), event.summary);
}
function whenLine(event) {
	const duration = formatEventDuration(event, getTimeZone(), true);
	return newLine(lang.get("when_label"), duration);
}
function organizerLabel(organizer, a) {
	return cleanMailAddress(organizer.address) === cleanMailAddress(a.address.address) ? `(${lang.get("organizer_label")})` : "";
}
function newLine(label, content) {
	return `<div style="display: flex; margin-top: 8px"><div style="min-width: 120px"><b style="float:right; margin-right:16px">${label}:</b></div>${content}</div>`;
}
function attendeesLine(event) {
	const { organizer } = event;
	let attendees = "";
	if (organizer && !findAttendeeInAddresses(event.attendees, [organizer.address])) attendees = makeAttendee(organizer, createCalendarEventAttendee({
		address: organizer,
		status: "0"
	}));
	attendees += event.attendees.map((a) => makeAttendee(assertNotNull(organizer), a)).join("\n");
	return newLine(lang.get("who_label"), `<div>${attendees}</div>`);
}
function makeAttendee(organizer, attendee) {
	return `<div>
${attendee.address.name || ""} ${attendee.address.address}
${organizerLabel(organizer, attendee)}
${calendarAttendeeStatusSymbol(getAttendeeStatus(attendee))}</div>`;
}
function locationLine(event) {
	return event.location ? newLine(lang.get("location_label"), event.location) : "";
}
function descriptionLine(event) {
	return event.description ? newLine(lang.get("description_label"), `<div>${event.description}</div>`) : "";
}
function makeInviteEmailBody(sender, event, message) {
	return `
	<div style="max-width: 685px; margin: 0 auto">
	  	<h2 style="text-align: center">${message}</h2>
  		<div style="margin: 0 auto">
  			${summaryLine(event)}
    		${whenLine(event)}
    		${locationLine(event)}
    		${attendeesLine(event)}
    		${descriptionLine(event)}
  		</div>
	</div>`;
}
function assertOrganizer(event) {
	if (event.organizer == null) throw new ProgrammingError("Cannot send event update without organizer");
	return event.organizer;
}
const calendarNotificationSender = new CalendarNotificationSender();

//#endregion
export { CalendarNotificationSender, calendarNotificationSender };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FsZW5kYXJOb3RpZmljYXRpb25TZW5kZXItY2h1bmsuanMiLCJuYW1lcyI6WyJldmVudDogQ2FsZW5kYXJFdmVudCIsInNlbmRNYWlsTW9kZWw6IFNlbmRNYWlsTW9kZWwiLCJvcmdhbml6ZXI6IEVuY3J5cHRlZE1haWxBZGRyZXNzIiwiYTogQ2FsZW5kYXJFdmVudEF0dGVuZGVlIiwibGFiZWw6IHN0cmluZyIsImNvbnRlbnQ6IHN0cmluZyIsImF0dGVuZGVlOiBDYWxlbmRhckV2ZW50QXR0ZW5kZWUiLCJzZW5kZXI6IHN0cmluZyIsIm1lc3NhZ2U6IHN0cmluZyIsImNhbGVuZGFyTm90aWZpY2F0aW9uU2VuZGVyOiBDYWxlbmRhck5vdGlmaWNhdGlvblNlbmRlciJdLCJzb3VyY2VzIjpbIi4uL3NyYy9jYWxlbmRhci1hcHAvY2FsZW5kYXIvdmlldy9DYWxlbmRhck5vdGlmaWNhdGlvblNlbmRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBsYW5nIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9taXNjL0xhbmd1YWdlVmlld01vZGVsLmpzXCJcbmltcG9ydCB7IG1ha2VJbnZpdGF0aW9uQ2FsZW5kYXJGaWxlIH0gZnJvbSBcIi4uL2V4cG9ydC9DYWxlbmRhckV4cG9ydGVyLmpzXCJcbmltcG9ydCB7IGdldEF0dGVuZGVlU3RhdHVzLCBNYWlsTWV0aG9kLCBtYWlsTWV0aG9kVG9DYWxlbmRhck1ldGhvZCB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vYXBpL2NvbW1vbi9UdXRhbm90YUNvbnN0YW50cy5qc1wiXG5pbXBvcnQgeyBnZXRUaW1lWm9uZSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vY2FsZW5kYXIvZGF0ZS9DYWxlbmRhclV0aWxzLmpzXCJcbmltcG9ydCB0eXBlIHsgQ2FsZW5kYXJFdmVudCwgQ2FsZW5kYXJFdmVudEF0dGVuZGVlLCBFbmNyeXB0ZWRNYWlsQWRkcmVzcyB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vYXBpL2VudGl0aWVzL3R1dGFub3RhL1R5cGVSZWZzLmpzXCJcbmltcG9ydCB7IGNyZWF0ZUNhbGVuZGFyRXZlbnRBdHRlbmRlZSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vYXBpL2VudGl0aWVzL3R1dGFub3RhL1R5cGVSZWZzLmpzXCJcbmltcG9ydCB7IGFzc2VydE5vdE51bGwsIG5vT3AsIG9mQ2xhc3MgfSBmcm9tIFwiQHR1dGFvL3R1dGFub3RhLXV0aWxzXCJcbmltcG9ydCB0eXBlIHsgU2VuZE1haWxNb2RlbCB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vbWFpbEZ1bmN0aW9uYWxpdHkvU2VuZE1haWxNb2RlbC5qc1wiXG5pbXBvcnQgeyB3aW5kb3dGYWNhZGUgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL21pc2MvV2luZG93RmFjYWRlLmpzXCJcbmltcG9ydCB7IFJlY2lwaWVudHNOb3RGb3VuZEVycm9yIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9hcGkvY29tbW9uL2Vycm9yL1JlY2lwaWVudHNOb3RGb3VuZEVycm9yLmpzXCJcbmltcG9ydCB7IGNsZWFuTWFpbEFkZHJlc3MsIGZpbmRBdHRlbmRlZUluQWRkcmVzc2VzLCBmaW5kUmVjaXBpZW50V2l0aEFkZHJlc3MgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL2FwaS9jb21tb24vdXRpbHMvQ29tbW9uQ2FsZW5kYXJVdGlscy5qc1wiXG5pbXBvcnQgeyBQcm9ncmFtbWluZ0Vycm9yIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9hcGkvY29tbW9uL2Vycm9yL1Byb2dyYW1taW5nRXJyb3IuanNcIlxuXG5pbXBvcnQgeyBjYWxlbmRhckF0dGVuZGVlU3RhdHVzU3ltYm9sLCBmb3JtYXRFdmVudER1cmF0aW9uIH0gZnJvbSBcIi4uL2d1aS9DYWxlbmRhckd1aVV0aWxzLmpzXCJcbmltcG9ydCB7IFJlY2lwaWVudEZpZWxkIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9tYWlsRnVuY3Rpb25hbGl0eS9TaGFyZWRNYWlsVXRpbHMuanNcIlxuXG5leHBvcnQgY2xhc3MgQ2FsZW5kYXJOb3RpZmljYXRpb25TZW5kZXIge1xuXHQvKiogVXNlZCBmb3Iga25vd2luZyBob3cgbWFueSBlbWFpbHMgYXJlIGluIHRoZSBwcm9jZXNzIG9mIGJlaW5nIHNlbnQuICovXG5cdHByaXZhdGUgY291bnREb3duTGF0Y2g6IG51bWJlclxuXG5cdGNvbnN0cnVjdG9yKCkge1xuXHRcdHRoaXMuY291bnREb3duTGF0Y2ggPSAwXG5cdH1cblxuXHRzZW5kSW52aXRlKGV2ZW50OiBDYWxlbmRhckV2ZW50LCBzZW5kTWFpbE1vZGVsOiBTZW5kTWFpbE1vZGVsKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgbWVzc2FnZSA9IGxhbmcuZ2V0KFwiZXZlbnRJbnZpdGVNYWlsX21zZ1wiLCB7XG5cdFx0XHRcIntldmVudH1cIjogZXZlbnQuc3VtbWFyeSxcblx0XHR9KVxuXHRcdGNvbnN0IHNlbmRlciA9IGFzc2VydE9yZ2FuaXplcihldmVudCkuYWRkcmVzc1xuXHRcdHJldHVybiB0aGlzLnNlbmRDYWxlbmRhckZpbGUoe1xuXHRcdFx0c2VuZE1haWxNb2RlbCxcblx0XHRcdG1ldGhvZDogTWFpbE1ldGhvZC5JQ0FMX1JFUVVFU1QsXG5cdFx0XHRzdWJqZWN0OiBtZXNzYWdlLFxuXHRcdFx0Ym9keTogbWFrZUludml0ZUVtYWlsQm9keShzZW5kZXIsIGV2ZW50LCBtZXNzYWdlKSxcblx0XHRcdGV2ZW50LFxuXHRcdFx0c2VuZGVyLFxuXHRcdH0pXG5cdH1cblxuXHRzZW5kVXBkYXRlKGV2ZW50OiBDYWxlbmRhckV2ZW50LCBzZW5kTWFpbE1vZGVsOiBTZW5kTWFpbE1vZGVsKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgbWVzc2FnZSA9IGxhbmcuZ2V0KFwiZXZlbnRVcGRhdGVkX21zZ1wiLCB7XG5cdFx0XHRcIntldmVudH1cIjogZXZlbnQuc3VtbWFyeSxcblx0XHR9KVxuXHRcdGNvbnN0IHNlbmRlciA9IGFzc2VydE9yZ2FuaXplcihldmVudCkuYWRkcmVzc1xuXHRcdHJldHVybiB0aGlzLnNlbmRDYWxlbmRhckZpbGUoe1xuXHRcdFx0c2VuZE1haWxNb2RlbCxcblx0XHRcdG1ldGhvZDogTWFpbE1ldGhvZC5JQ0FMX1JFUVVFU1QsXG5cdFx0XHRzdWJqZWN0OiBtZXNzYWdlLFxuXHRcdFx0Ym9keTogbWFrZUludml0ZUVtYWlsQm9keShzZW5kZXIsIGV2ZW50LCBtZXNzYWdlKSxcblx0XHRcdGV2ZW50LFxuXHRcdFx0c2VuZGVyLFxuXHRcdH0pXG5cdH1cblxuXHRzZW5kQ2FuY2VsbGF0aW9uKGV2ZW50OiBDYWxlbmRhckV2ZW50LCBzZW5kTWFpbE1vZGVsOiBTZW5kTWFpbE1vZGVsKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgbWVzc2FnZSA9IGxhbmcuZ2V0KFwiZXZlbnRDYW5jZWxsZWRfbXNnXCIsIHtcblx0XHRcdFwie2V2ZW50fVwiOiBldmVudC5zdW1tYXJ5LFxuXHRcdH0pXG5cdFx0Y29uc3Qgc2VuZGVyID0gYXNzZXJ0T3JnYW5pemVyKGV2ZW50KS5hZGRyZXNzXG5cdFx0cmV0dXJuIHRoaXMuc2VuZENhbGVuZGFyRmlsZSh7XG5cdFx0XHRzZW5kTWFpbE1vZGVsLFxuXHRcdFx0bWV0aG9kOiBNYWlsTWV0aG9kLklDQUxfQ0FOQ0VMLFxuXHRcdFx0c3ViamVjdDogbWVzc2FnZSxcblx0XHRcdGJvZHk6IG1ha2VJbnZpdGVFbWFpbEJvZHkoc2VuZGVyLCBldmVudCwgbWVzc2FnZSksXG5cdFx0XHRldmVudCxcblx0XHRcdHNlbmRlcixcblx0XHR9KS5jYXRjaChcblx0XHRcdG9mQ2xhc3MoUmVjaXBpZW50c05vdEZvdW5kRXJyb3IsIChlKSA9PiB7XG5cdFx0XHRcdC8vIHdlIHdhbnQgdG8gZGVsZXRlIHRoZSBldmVudCBldmVuIGlmIHRoZSByZWNpcGllbnQgaXMgbm90IGFuIGV4aXN0aW5nIHR1dGFub3RhIGFkZHJlc3Ncblx0XHRcdFx0Ly8gYW5kIGp1c3QgZXhjbHVkZSB0aGVtIGZyb20gc2VuZGluZyBvdXQgdXBkYXRlcyBidXQgbGVhdmUgdGhlIGV2ZW50IHVudG91Y2hlZCBmb3Igb3RoZXIgcmVjaXBpZW50c1xuXHRcdFx0XHRjb25zdCBpbnZhbGlkUmVjaXBpZW50cyA9IGUubWVzc2FnZS5zcGxpdChcIlxcblwiKVxuXHRcdFx0XHRsZXQgaGFzUmVtb3ZlZFJlY2lwaWVudCA9IGZhbHNlXG5cdFx0XHRcdGZvciAoY29uc3QgaW52YWxpZFJlY2lwaWVudCBvZiBpbnZhbGlkUmVjaXBpZW50cykge1xuXHRcdFx0XHRcdGNvbnN0IHJlY2lwaWVudEluZm8gPSBmaW5kUmVjaXBpZW50V2l0aEFkZHJlc3Moc2VuZE1haWxNb2RlbC5iY2NSZWNpcGllbnRzKCksIGludmFsaWRSZWNpcGllbnQpXG5cblx0XHRcdFx0XHRpZiAocmVjaXBpZW50SW5mbykge1xuXHRcdFx0XHRcdFx0aGFzUmVtb3ZlZFJlY2lwaWVudCA9IHNlbmRNYWlsTW9kZWwucmVtb3ZlUmVjaXBpZW50KHJlY2lwaWVudEluZm8sIFJlY2lwaWVudEZpZWxkLkJDQywgZmFsc2UpIHx8IGhhc1JlbW92ZWRSZWNpcGllbnRcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH1cblxuXHRcdFx0XHQvLyBvbmx5IHRyeSBzZW5kaW5nIGFnYWluIGlmIHdlIHN1Y2Nlc3NmdWxseSByZW1vdmVkIGEgcmVjaXBpZW50IGFuZCB0aGVyZSBhcmUgc3RpbGwgb3RoZXIgcmVjaXBpZW50c1xuXHRcdFx0XHRpZiAoaGFzUmVtb3ZlZFJlY2lwaWVudCAmJiBzZW5kTWFpbE1vZGVsLmFsbFJlY2lwaWVudHMoKS5sZW5ndGgpIHtcblx0XHRcdFx0XHRyZXR1cm4gdGhpcy5zZW5kQ2FuY2VsbGF0aW9uKGV2ZW50LCBzZW5kTWFpbE1vZGVsKVxuXHRcdFx0XHR9XG5cdFx0XHR9KSxcblx0XHQpXG5cdH1cblxuXHQvKipcblx0ICogc2VuZCBhIHJlc3BvbnNlIG1haWwgdG8gdGhlIG9yZ2FuaXplciBvZiBhbiBldmVudFxuXHQgKiBAcGFyYW0gZXZlbnQgdGhlIGV2ZW50IHRvIHJlc3BvbmQgdG8gKGluY2x1ZGVkIGFzIGEgLmljcyBmaWxlIGF0dGFjaG1lbnQpXG5cdCAqIEBwYXJhbSBzZW5kTWFpbE1vZGVsIHVzZWQgdG8gYWN0dWFsbHkgc2VuZCB0aGUgbWFpbFxuXHQgKi9cblx0YXN5bmMgc2VuZFJlc3BvbnNlKGV2ZW50OiBDYWxlbmRhckV2ZW50LCBzZW5kTWFpbE1vZGVsOiBTZW5kTWFpbE1vZGVsKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3Qgc2VuZEFzID0gc2VuZE1haWxNb2RlbC5nZXRTZW5kZXIoKVxuXHRcdGNvbnN0IG1lc3NhZ2UgPSBsYW5nLmdldChcInJlcGxpZWRUb0V2ZW50SW52aXRlX21zZ1wiLCB7XG5cdFx0XHRcIntldmVudH1cIjogZXZlbnQuc3VtbWFyeSxcblx0XHR9KVxuXHRcdGNvbnN0IG9yZ2FuaXplciA9IGFzc2VydE9yZ2FuaXplcihldmVudClcblx0XHRjb25zdCBib2R5ID0gbWFrZUludml0ZUVtYWlsQm9keShvcmdhbml6ZXIuYWRkcmVzcywgZXZlbnQsIG1lc3NhZ2UpXG5cdFx0cmV0dXJuIHRoaXMuc2VuZENhbGVuZGFyRmlsZSh7XG5cdFx0XHRldmVudCxcblx0XHRcdHNlbmRNYWlsTW9kZWwsXG5cdFx0XHRtZXRob2Q6IE1haWxNZXRob2QuSUNBTF9SRVBMWSxcblx0XHRcdHN1YmplY3Q6IG1lc3NhZ2UsXG5cdFx0XHRib2R5OiBib2R5LFxuXHRcdFx0c2VuZGVyOiBzZW5kQXMsXG5cdFx0fSlcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgc2VuZENhbGVuZGFyRmlsZSh7XG5cdFx0c2VuZE1haWxNb2RlbCxcblx0XHRtZXRob2QsXG5cdFx0c3ViamVjdCxcblx0XHRldmVudCxcblx0XHRib2R5LFxuXHRcdHNlbmRlcixcblx0fToge1xuXHRcdHNlbmRNYWlsTW9kZWw6IFNlbmRNYWlsTW9kZWxcblx0XHRtZXRob2Q6IE1haWxNZXRob2Rcblx0XHRzdWJqZWN0OiBzdHJpbmdcblx0XHRldmVudDogQ2FsZW5kYXJFdmVudFxuXHRcdGJvZHk6IHN0cmluZ1xuXHRcdHNlbmRlcjogc3RyaW5nXG5cdH0pOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCBpbnZpdGVGaWxlID0gbWFrZUludml0YXRpb25DYWxlbmRhckZpbGUoZXZlbnQsIG1haWxNZXRob2RUb0NhbGVuZGFyTWV0aG9kKG1ldGhvZCksIG5ldyBEYXRlKCksIGdldFRpbWVab25lKCkpXG5cdFx0c2VuZE1haWxNb2RlbC5zZXRTZW5kZXIoc2VuZGVyKVxuXHRcdHNlbmRNYWlsTW9kZWwuYXR0YWNoRmlsZXMoW2ludml0ZUZpbGVdKVxuXHRcdHNlbmRNYWlsTW9kZWwuc2V0U3ViamVjdChzdWJqZWN0KVxuXHRcdHNlbmRNYWlsTW9kZWwuc2V0Qm9keShib2R5KVxuXG5cdFx0dGhpcy5zZW5kU3RhcnQoKVxuXG5cdFx0YXdhaXQgc2VuZE1haWxNb2RlbC5zZW5kKG1ldGhvZCkuZmluYWxseSgoKSA9PiB0aGlzLnNlbmRFbmQoKSlcblx0fVxuXG5cdHByaXZhdGUgX3dpbmRvd1Vuc3Vic2NyaWJlOiAoKCkgPT4gdm9pZCkgfCBudWxsID0gbnVsbFxuXG5cdHByaXZhdGUgc2VuZFN0YXJ0KCkge1xuXHRcdHRoaXMuY291bnREb3duTGF0Y2grK1xuXG5cdFx0aWYgKHRoaXMuY291bnREb3duTGF0Y2ggPT09IDEpIHtcblx0XHRcdHRoaXMuX3dpbmRvd1Vuc3Vic2NyaWJlID0gd2luZG93RmFjYWRlLmFkZFdpbmRvd0Nsb3NlTGlzdGVuZXIobm9PcClcblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIHNlbmRFbmQoKSB7XG5cdFx0dGhpcy5jb3VudERvd25MYXRjaC0tXG5cblx0XHRpZiAodGhpcy5jb3VudERvd25MYXRjaCA9PT0gMCAmJiB0aGlzLl93aW5kb3dVbnN1YnNjcmliZSkge1xuXHRcdFx0dGhpcy5fd2luZG93VW5zdWJzY3JpYmUoKVxuXG5cdFx0XHR0aGlzLl93aW5kb3dVbnN1YnNjcmliZSA9IG51bGxcblx0XHR9XG5cdH1cbn1cblxuZnVuY3Rpb24gc3VtbWFyeUxpbmUoZXZlbnQ6IENhbGVuZGFyRXZlbnQpOiBzdHJpbmcge1xuXHRyZXR1cm4gbmV3TGluZShsYW5nLmdldChcIm5hbWVfbGFiZWxcIiksIGV2ZW50LnN1bW1hcnkpXG59XG5cbmZ1bmN0aW9uIHdoZW5MaW5lKGV2ZW50OiBDYWxlbmRhckV2ZW50KTogc3RyaW5nIHtcblx0Y29uc3QgZHVyYXRpb24gPSBmb3JtYXRFdmVudER1cmF0aW9uKGV2ZW50LCBnZXRUaW1lWm9uZSgpLCB0cnVlKVxuXHRyZXR1cm4gbmV3TGluZShsYW5nLmdldChcIndoZW5fbGFiZWxcIiksIGR1cmF0aW9uKVxufVxuXG5mdW5jdGlvbiBvcmdhbml6ZXJMYWJlbChvcmdhbml6ZXI6IEVuY3J5cHRlZE1haWxBZGRyZXNzLCBhOiBDYWxlbmRhckV2ZW50QXR0ZW5kZWUpIHtcblx0cmV0dXJuIGNsZWFuTWFpbEFkZHJlc3Mob3JnYW5pemVyLmFkZHJlc3MpID09PSBjbGVhbk1haWxBZGRyZXNzKGEuYWRkcmVzcy5hZGRyZXNzKSA/IGAoJHtsYW5nLmdldChcIm9yZ2FuaXplcl9sYWJlbFwiKX0pYCA6IFwiXCJcbn1cblxuZnVuY3Rpb24gbmV3TGluZShsYWJlbDogc3RyaW5nLCBjb250ZW50OiBzdHJpbmcpOiBzdHJpbmcge1xuXHRyZXR1cm4gYDxkaXYgc3R5bGU9XCJkaXNwbGF5OiBmbGV4OyBtYXJnaW4tdG9wOiA4cHhcIj48ZGl2IHN0eWxlPVwibWluLXdpZHRoOiAxMjBweFwiPjxiIHN0eWxlPVwiZmxvYXQ6cmlnaHQ7IG1hcmdpbi1yaWdodDoxNnB4XCI+JHtsYWJlbH06PC9iPjwvZGl2PiR7Y29udGVudH08L2Rpdj5gXG59XG5cbmZ1bmN0aW9uIGF0dGVuZGVlc0xpbmUoZXZlbnQ6IENhbGVuZGFyRXZlbnQpOiBzdHJpbmcge1xuXHRjb25zdCB7IG9yZ2FuaXplciB9ID0gZXZlbnRcblx0bGV0IGF0dGVuZGVlcyA9IFwiXCJcblxuXHQvLyBJZiBvcmdhbml6ZXIgaXMgYWxyZWFkeSBpbiB0aGUgYXR0ZW5kZWVzLCB3ZSBkb24ndCBoYXZlIHRvIGFkZCB0aGVtIHNlcGFyYXRlbHkuXG5cdGlmIChvcmdhbml6ZXIgJiYgIWZpbmRBdHRlbmRlZUluQWRkcmVzc2VzKGV2ZW50LmF0dGVuZGVlcywgW29yZ2FuaXplci5hZGRyZXNzXSkpIHtcblx0XHRhdHRlbmRlZXMgPSBtYWtlQXR0ZW5kZWUoXG5cdFx0XHRvcmdhbml6ZXIsXG5cdFx0XHRjcmVhdGVDYWxlbmRhckV2ZW50QXR0ZW5kZWUoe1xuXHRcdFx0XHRhZGRyZXNzOiBvcmdhbml6ZXIsXG5cdFx0XHRcdHN0YXR1czogXCIwXCIsXG5cdFx0XHR9KSxcblx0XHQpXG5cdH1cblxuXHRhdHRlbmRlZXMgKz0gZXZlbnQuYXR0ZW5kZWVzLm1hcCgoYSkgPT4gbWFrZUF0dGVuZGVlKGFzc2VydE5vdE51bGwob3JnYW5pemVyKSwgYSkpLmpvaW4oXCJcXG5cIilcblx0cmV0dXJuIG5ld0xpbmUobGFuZy5nZXQoXCJ3aG9fbGFiZWxcIiksIGA8ZGl2PiR7YXR0ZW5kZWVzfTwvZGl2PmApXG59XG5cbmZ1bmN0aW9uIG1ha2VBdHRlbmRlZShvcmdhbml6ZXI6IEVuY3J5cHRlZE1haWxBZGRyZXNzLCBhdHRlbmRlZTogQ2FsZW5kYXJFdmVudEF0dGVuZGVlKTogc3RyaW5nIHtcblx0cmV0dXJuIGA8ZGl2PlxuJHthdHRlbmRlZS5hZGRyZXNzLm5hbWUgfHwgXCJcIn0gJHthdHRlbmRlZS5hZGRyZXNzLmFkZHJlc3N9XG4ke29yZ2FuaXplckxhYmVsKG9yZ2FuaXplciwgYXR0ZW5kZWUpfVxuJHtjYWxlbmRhckF0dGVuZGVlU3RhdHVzU3ltYm9sKGdldEF0dGVuZGVlU3RhdHVzKGF0dGVuZGVlKSl9PC9kaXY+YFxufVxuXG5mdW5jdGlvbiBsb2NhdGlvbkxpbmUoZXZlbnQ6IENhbGVuZGFyRXZlbnQpOiBzdHJpbmcge1xuXHRyZXR1cm4gZXZlbnQubG9jYXRpb24gPyBuZXdMaW5lKGxhbmcuZ2V0KFwibG9jYXRpb25fbGFiZWxcIiksIGV2ZW50LmxvY2F0aW9uKSA6IFwiXCJcbn1cblxuZnVuY3Rpb24gZGVzY3JpcHRpb25MaW5lKGV2ZW50OiBDYWxlbmRhckV2ZW50KTogc3RyaW5nIHtcblx0cmV0dXJuIGV2ZW50LmRlc2NyaXB0aW9uID8gbmV3TGluZShsYW5nLmdldChcImRlc2NyaXB0aW9uX2xhYmVsXCIpLCBgPGRpdj4ke2V2ZW50LmRlc2NyaXB0aW9ufTwvZGl2PmApIDogXCJcIlxufVxuXG5mdW5jdGlvbiBtYWtlSW52aXRlRW1haWxCb2R5KHNlbmRlcjogc3RyaW5nLCBldmVudDogQ2FsZW5kYXJFdmVudCwgbWVzc2FnZTogc3RyaW5nKSB7XG5cdHJldHVybiBgXG5cdDxkaXYgc3R5bGU9XCJtYXgtd2lkdGg6IDY4NXB4OyBtYXJnaW46IDAgYXV0b1wiPlxuXHQgIFx0PGgyIHN0eWxlPVwidGV4dC1hbGlnbjogY2VudGVyXCI+JHttZXNzYWdlfTwvaDI+XG4gIFx0XHQ8ZGl2IHN0eWxlPVwibWFyZ2luOiAwIGF1dG9cIj5cbiAgXHRcdFx0JHtzdW1tYXJ5TGluZShldmVudCl9XG4gICAgXHRcdCR7d2hlbkxpbmUoZXZlbnQpfVxuICAgIFx0XHQke2xvY2F0aW9uTGluZShldmVudCl9XG4gICAgXHRcdCR7YXR0ZW5kZWVzTGluZShldmVudCl9XG4gICAgXHRcdCR7ZGVzY3JpcHRpb25MaW5lKGV2ZW50KX1cbiAgXHRcdDwvZGl2PlxuXHQ8L2Rpdj5gXG59XG5cbmZ1bmN0aW9uIGFzc2VydE9yZ2FuaXplcihldmVudDogQ2FsZW5kYXJFdmVudCk6IEVuY3J5cHRlZE1haWxBZGRyZXNzIHtcblx0aWYgKGV2ZW50Lm9yZ2FuaXplciA9PSBudWxsKSB7XG5cdFx0dGhyb3cgbmV3IFByb2dyYW1taW5nRXJyb3IoXCJDYW5ub3Qgc2VuZCBldmVudCB1cGRhdGUgd2l0aG91dCBvcmdhbml6ZXJcIilcblx0fVxuXG5cdHJldHVybiBldmVudC5vcmdhbml6ZXJcbn1cblxuZXhwb3J0IGNvbnN0IGNhbGVuZGFyTm90aWZpY2F0aW9uU2VuZGVyOiBDYWxlbmRhck5vdGlmaWNhdGlvblNlbmRlciA9IG5ldyBDYWxlbmRhck5vdGlm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