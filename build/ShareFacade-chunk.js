import "./dist-chunk.js";
import "./ProgrammingError-chunk.js";
import { assertWorkerOrNode } from "./Env-chunk.js";
import { isSameTypeRef, neverNull } from "./dist2-chunk.js";
import "./EntityUtils-chunk.js";
import "./TypeModels-chunk.js";
import { InternalRecipientKeyDataTypeRef, createGroupInvitationDeleteData, createGroupInvitationPostData, createGroupInvitationPutData, createSharedGroupData } from "./TypeRefs-chunk.js";
import "./TypeModels2-chunk.js";
import { GroupInfoTypeRef } from "./TypeRefs2-chunk.js";
import "./CryptoError-chunk.js";
import { RecipientsNotFoundError } from "./RecipientsNotFoundError-chunk.js";
import { aes256RandomKey, bitArrayToUint8Array, encryptKey, uint8ArrayToBitArray } from "./dist3-chunk.js";
import { encryptBytes, encryptKeyWithVersionedKey, encryptString } from "./CryptoWrapper-chunk.js";
import { GroupInvitationService } from "./Services2-chunk.js";

//#region src/common/api/worker/facades/lazy/ShareFacade.ts
assertWorkerOrNode();
var ShareFacade = class {
	constructor(userFacade, cryptoFacade, serviceExecutor, entityClient, keyLoaderFacade) {
		this.userFacade = userFacade;
		this.cryptoFacade = cryptoFacade;
		this.serviceExecutor = serviceExecutor;
		this.entityClient = entityClient;
		this.keyLoaderFacade = keyLoaderFacade;
	}
	async sendGroupInvitation(sharedGroupInfo, recipientMailAddresses, shareCapability) {
		const sharedGroupKey = await this.keyLoaderFacade.getCurrentSymGroupKey(sharedGroupInfo.group);
		const invitationData = await this.prepareGroupInvitation(sharedGroupKey, sharedGroupInfo, recipientMailAddresses, shareCapability);
		return this.sendGroupInvitationRequest(invitationData);
	}
	async sendGroupInvitationRequest(invitationData) {
		return this.serviceExecutor.post(GroupInvitationService, invitationData);
	}
	async prepareGroupInvitation(sharedGroupKey, sharedGroupInfo, recipientMailAddresses, shareCapability) {
		const userGroupInfo = await this.entityClient.load(GroupInfoTypeRef, this.userFacade.getLoggedInUser().userGroup.groupInfo);
		const userGroupInfoSessionKey = await this.cryptoFacade.resolveSessionKeyForInstance(userGroupInfo);
		const sharedGroupInfoSessionKey = await this.cryptoFacade.resolveSessionKeyForInstance(sharedGroupInfo);
		const bucketKey = aes256RandomKey();
		const invitationSessionKey = aes256RandomKey();
		const sharedGroupEncInviterGroupInfoKey = encryptKeyWithVersionedKey(sharedGroupKey, neverNull(userGroupInfoSessionKey));
		const sharedGroupEncSharedGroupInfoKey = encryptKeyWithVersionedKey(sharedGroupKey, neverNull(sharedGroupInfoSessionKey));
		const sharedGroupData = createSharedGroupData({
			sessionEncInviterName: encryptString(invitationSessionKey, userGroupInfo.name),
			sessionEncSharedGroupKey: encryptBytes(invitationSessionKey, bitArrayToUint8Array(sharedGroupKey.object)),
			sessionEncSharedGroupName: encryptString(invitationSessionKey, sharedGroupInfo.name),
			bucketEncInvitationSessionKey: encryptKey(bucketKey, invitationSessionKey),
			capability: shareCapability,
			sharedGroup: sharedGroupInfo.group,
			sharedGroupEncInviterGroupInfoKey: sharedGroupEncInviterGroupInfoKey.key,
			sharedGroupEncSharedGroupInfoKey: sharedGroupEncSharedGroupInfoKey.key,
			sharedGroupKeyVersion: String(sharedGroupKey.version)
		});
		const invitationData = createGroupInvitationPostData({
			sharedGroupData,
			internalKeyData: []
		});
		const notFoundRecipients = [];
		for (let mailAddress of recipientMailAddresses) {
			const keyData = await this.cryptoFacade.encryptBucketKeyForInternalRecipient(userGroupInfo.group, bucketKey, mailAddress, notFoundRecipients);
			if (keyData && isSameTypeRef(keyData._type, InternalRecipientKeyDataTypeRef)) invitationData.internalKeyData.push(keyData);
		}
		if (notFoundRecipients.length > 0) throw new RecipientsNotFoundError(notFoundRecipients.join("\n"));
		return invitationData;
	}
	async acceptGroupInvitation(invitation) {
		const userGroupInfo = await this.entityClient.load(GroupInfoTypeRef, this.userFacade.getLoggedInUser().userGroup.groupInfo);
		const userGroupInfoSessionKey = await this.cryptoFacade.resolveSessionKeyForInstance(userGroupInfo);
		const sharedGroupKey = {
			object: uint8ArrayToBitArray(invitation.sharedGroupKey),
			version: Number(invitation.sharedGroupKeyVersion)
		};
		const userGroupKey = this.userFacade.getCurrentUserGroupKey();
		const userGroupEncGroupKey = encryptKeyWithVersionedKey(userGroupKey, sharedGroupKey.object);
		const sharedGroupEncInviteeGroupInfoKey = encryptKeyWithVersionedKey(sharedGroupKey, neverNull(userGroupInfoSessionKey));
		const serviceData = createGroupInvitationPutData({
			receivedInvitation: invitation._id,
			userGroupEncGroupKey: userGroupEncGroupKey.key,
			sharedGroupEncInviteeGroupInfoKey: sharedGroupEncInviteeGroupInfoKey.key,
			userGroupKeyVersion: userGroupEncGroupKey.encryptingKeyVersion.toString(),
			sharedGroupKeyVersion: sharedGroupEncInviteeGroupInfoKey.encryptingKeyVersion.toString()
		});
		await this.serviceExecutor.put(GroupInvitationService, serviceData);
	}
	async rejectOrCancelGroupInvitation(receivedGroupInvitationId) {
		const serviceData = createGroupInvitationDeleteData({ receivedInvitation: receivedGroupInvitationId });
		await this.serviceExecutor.delete(GroupInvitationService, serviceData);
	}
};

//#endregion
export { ShareFacade };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2hhcmVGYWNhZGUtY2h1bmsuanMiLCJuYW1lcyI6WyJ1c2VyRmFjYWRlOiBVc2VyRmFjYWRlIiwiY3J5cHRvRmFjYWRlOiBDcnlwdG9GYWNhZGUiLCJzZXJ2aWNlRXhlY3V0b3I6IElTZXJ2aWNlRXhlY3V0b3IiLCJlbnRpdHlDbGllbnQ6IEVudGl0eUNsaWVudCIsImtleUxvYWRlckZhY2FkZTogS2V5TG9hZGVyRmFjYWRlIiwic2hhcmVkR3JvdXBJbmZvOiBHcm91cEluZm8iLCJyZWNpcGllbnRNYWlsQWRkcmVzc2VzOiBBcnJheTxzdHJpbmc+Iiwic2hhcmVDYXBhYmlsaXR5OiBTaGFyZUNhcGFiaWxpdHkiLCJpbnZpdGF0aW9uRGF0YTogR3JvdXBJbnZpdGF0aW9uUG9zdERhdGEiLCJzaGFyZWRHcm91cEtleTogVmVyc2lvbmVkS2V5Iiwibm90Rm91bmRSZWNpcGllbnRzOiBBcnJheTxzdHJpbmc+IiwiaW52aXRhdGlvbjogUmVjZWl2ZWRHcm91cEludml0YXRpb24iLCJyZWNlaXZlZEdyb3VwSW52aXRhdGlvbklkOiBJZFR1cGxlIl0sInNvdXJjZXMiOlsiLi4vc3JjL2NvbW1vbi9hcGkvd29ya2VyL2ZhY2FkZXMvbGF6eS9TaGFyZUZhY2FkZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IENyeXB0b0ZhY2FkZSB9IGZyb20gXCIuLi8uLi9jcnlwdG8vQ3J5cHRvRmFjYWRlLmpzXCJcbmltcG9ydCB0eXBlIHsgR3JvdXBJbmZvLCBSZWNlaXZlZEdyb3VwSW52aXRhdGlvbiB9IGZyb20gXCIuLi8uLi8uLi9lbnRpdGllcy9zeXMvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHsgR3JvdXBJbmZvVHlwZVJlZiB9IGZyb20gXCIuLi8uLi8uLi9lbnRpdGllcy9zeXMvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHR5cGUgeyBTaGFyZUNhcGFiaWxpdHkgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL1R1dGFub3RhQ29uc3RhbnRzLmpzXCJcbmltcG9ydCB0eXBlIHsgR3JvdXBJbnZpdGF0aW9uUG9zdERhdGEsIEdyb3VwSW52aXRhdGlvblBvc3RSZXR1cm4sIEludGVybmFsUmVjaXBpZW50S2V5RGF0YSB9IGZyb20gXCIuLi8uLi8uLi9lbnRpdGllcy90dXRhbm90YS9UeXBlUmVmcy5qc1wiXG5pbXBvcnQge1xuXHRjcmVhdGVHcm91cEludml0YXRpb25EZWxldGVEYXRhLFxuXHRjcmVhdGVHcm91cEludml0YXRpb25Qb3N0RGF0YSxcblx0Y3JlYXRlR3JvdXBJbnZpdGF0aW9uUHV0RGF0YSxcblx0Y3JlYXRlU2hhcmVkR3JvdXBEYXRhLFxuXHRJbnRlcm5hbFJlY2lwaWVudEtleURhdGFUeXBlUmVmLFxufSBmcm9tIFwiLi4vLi4vLi4vZW50aXRpZXMvdHV0YW5vdGEvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHsgaXNTYW1lVHlwZVJlZiwgbmV2ZXJOdWxsIH0gZnJvbSBcIkB0dXRhby90dXRhbm90YS11dGlsc1wiXG5pbXBvcnQgeyBSZWNpcGllbnRzTm90Rm91bmRFcnJvciB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vZXJyb3IvUmVjaXBpZW50c05vdEZvdW5kRXJyb3IuanNcIlxuaW1wb3J0IHsgYXNzZXJ0V29ya2VyT3JOb2RlIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9FbnYuanNcIlxuaW1wb3J0IHsgYWVzMjU2UmFuZG9tS2V5LCBiaXRBcnJheVRvVWludDhBcnJheSwgZW5jcnlwdEtleSwgdWludDhBcnJheVRvQml0QXJyYXkgfSBmcm9tIFwiQHR1dGFvL3R1dGFub3RhLWNyeXB0b1wiXG5pbXBvcnQgeyBJU2VydmljZUV4ZWN1dG9yIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9TZXJ2aWNlUmVxdWVzdC5qc1wiXG5pbXBvcnQgeyBHcm91cEludml0YXRpb25TZXJ2aWNlIH0gZnJvbSBcIi4uLy4uLy4uL2VudGl0aWVzL3R1dGFub3RhL1NlcnZpY2VzLmpzXCJcbmltcG9ydCB7IFVzZXJGYWNhZGUgfSBmcm9tIFwiLi4vVXNlckZhY2FkZS5qc1wiXG5pbXBvcnQgeyBFbnRpdHlDbGllbnQgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL0VudGl0eUNsaWVudC5qc1wiXG5pbXBvcnQgeyBLZXlMb2FkZXJGYWNhZGUgfSBmcm9tIFwiLi4vS2V5TG9hZGVyRmFjYWRlLmpzXCJcbmltcG9ydCB7IGVuY3J5cHRCeXRlcywgZW5jcnlwdEtleVdpdGhWZXJzaW9uZWRLZXksIGVuY3J5cHRTdHJpbmcsIFZlcnNpb25lZEtleSB9IGZyb20gXCIuLi8uLi9jcnlwdG8vQ3J5cHRvV3JhcHBlci5qc1wiXG5cbmFzc2VydFdvcmtlck9yTm9kZSgpXG5cbmV4cG9ydCBjbGFzcyBTaGFyZUZhY2FkZSB7XG5cdGNvbnN0cnVjdG9yKFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgdXNlckZhY2FkZTogVXNlckZhY2FkZSxcblx0XHRwcml2YXRlIHJlYWRvbmx5IGNyeXB0b0ZhY2FkZTogQ3J5cHRvRmFjYWRlLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgc2VydmljZUV4ZWN1dG9yOiBJU2VydmljZUV4ZWN1dG9yLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgZW50aXR5Q2xpZW50OiBFbnRpdHlDbGllbnQsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBrZXlMb2FkZXJGYWNhZGU6IEtleUxvYWRlckZhY2FkZSxcblx0KSB7fVxuXG5cdGFzeW5jIHNlbmRHcm91cEludml0YXRpb24oXG5cdFx0c2hhcmVkR3JvdXBJbmZvOiBHcm91cEluZm8sXG5cdFx0cmVjaXBpZW50TWFpbEFkZHJlc3NlczogQXJyYXk8c3RyaW5nPixcblx0XHRzaGFyZUNhcGFiaWxpdHk6IFNoYXJlQ2FwYWJpbGl0eSxcblx0KTogUHJvbWlzZTxHcm91cEludml0YXRpb25Qb3N0UmV0dXJuPiB7XG5cdFx0Y29uc3Qgc2hhcmVkR3JvdXBLZXkgPSBhd2FpdCB0aGlzLmtleUxvYWRlckZhY2FkZS5nZXRDdXJyZW50U3ltR3JvdXBLZXkoc2hhcmVkR3JvdXBJbmZvLmdyb3VwKVxuXHRcdGNvbnN0IGludml0YXRpb25EYXRhID0gYXdhaXQgdGhpcy5wcmVwYXJlR3JvdXBJbnZpdGF0aW9uKHNoYXJlZEdyb3VwS2V5LCBzaGFyZWRHcm91cEluZm8sIHJlY2lwaWVudE1haWxBZGRyZXNzZXMsIHNoYXJlQ2FwYWJpbGl0eSlcblx0XHRyZXR1cm4gdGhpcy5zZW5kR3JvdXBJbnZpdGF0aW9uUmVxdWVzdChpbnZpdGF0aW9uRGF0YSlcblx0fVxuXG5cdGFzeW5jIHNlbmRHcm91cEludml0YXRpb25SZXF1ZXN0KGludml0YXRpb25EYXRhOiBHcm91cEludml0YXRpb25Qb3N0RGF0YSk6IFByb21pc2U8R3JvdXBJbnZpdGF0aW9uUG9zdFJldHVybj4ge1xuXHRcdHJldHVybiB0aGlzLnNlcnZpY2VFeGVjdXRvci5wb3N0KEdyb3VwSW52aXRhdGlvblNlcnZpY2UsIGludml0YXRpb25EYXRhKVxuXHR9XG5cblx0YXN5bmMgcHJlcGFyZUdyb3VwSW52aXRhdGlvbihcblx0XHRzaGFyZWRHcm91cEtleTogVmVyc2lvbmVkS2V5LFxuXHRcdHNoYXJlZEdyb3VwSW5mbzogR3JvdXBJbmZvLFxuXHRcdHJlY2lwaWVudE1haWxBZGRyZXNzZXM6IEFycmF5PHN0cmluZz4sXG5cdFx0c2hhcmVDYXBhYmlsaXR5OiBTaGFyZUNhcGFiaWxpdHksXG5cdCk6IFByb21pc2U8R3JvdXBJbnZpdGF0aW9uUG9zdERhdGE+IHtcblx0XHRjb25zdCB1c2VyR3JvdXBJbmZvID0gYXdhaXQgdGhpcy5lbnRpdHlDbGllbnQubG9hZChHcm91cEluZm9UeXBlUmVmLCB0aGlzLnVzZXJGYWNhZGUuZ2V0TG9nZ2VkSW5Vc2VyKCkudXNlckdyb3VwLmdyb3VwSW5mbylcblx0XHRjb25zdCB1c2VyR3JvdXBJbmZvU2Vzc2lvbktleSA9IGF3YWl0IHRoaXMuY3J5cHRvRmFjYWRlLnJlc29sdmVTZXNzaW9uS2V5Rm9ySW5zdGFuY2UodXNlckdyb3VwSW5mbylcblx0XHRjb25zdCBzaGFyZWRHcm91cEluZm9TZXNzaW9uS2V5ID0gYXdhaXQgdGhpcy5jcnlwdG9GYWNhZGUucmVzb2x2ZVNlc3Npb25LZXlGb3JJbnN0YW5jZShzaGFyZWRHcm91cEluZm8pXG5cdFx0Y29uc3QgYnVja2V0S2V5ID0gYWVzMjU2UmFuZG9tS2V5KClcblx0XHRjb25zdCBpbnZpdGF0aW9uU2Vzc2lvbktleSA9IGFlczI1NlJhbmRvbUtleSgpXG5cdFx0Y29uc3Qgc2hhcmVkR3JvdXBFbmNJbnZpdGVyR3JvdXBJbmZvS2V5ID0gZW5jcnlwdEtleVdpdGhWZXJzaW9uZWRLZXkoc2hhcmVkR3JvdXBLZXksIG5ldmVyTnVsbCh1c2VyR3JvdXBJbmZvU2Vzc2lvbktleSkpXG5cdFx0Y29uc3Qgc2hhcmVkR3JvdXBFbmNTaGFyZWRHcm91cEluZm9LZXkgPSBlbmNyeXB0S2V5V2l0aFZlcnNpb25lZEtleShzaGFyZWRHcm91cEtleSwgbmV2ZXJOdWxsKHNoYXJlZEdyb3VwSW5mb1Nlc3Npb25LZXkpKVxuXHRcdGNvbnN0IHNoYXJlZEdyb3VwRGF0YSA9IGNyZWF0ZVNoYXJlZEdyb3VwRGF0YSh7XG5cdFx0XHRzZXNzaW9uRW5jSW52aXRlck5hbWU6IGVuY3J5cHRTdHJpbmcoaW52aXRhdGlvblNlc3Npb25LZXksIHVzZXJHcm91cEluZm8ubmFtZSksXG5cdFx0XHRzZXNzaW9uRW5jU2hhcmVkR3JvdXBLZXk6IGVuY3J5cHRCeXRlcyhpbnZpdGF0aW9uU2Vzc2lvbktleSwgYml0QXJyYXlUb1VpbnQ4QXJyYXkoc2hhcmVkR3JvdXBLZXkub2JqZWN0KSksXG5cdFx0XHRzZXNzaW9uRW5jU2hhcmVkR3JvdXBOYW1lOiBlbmNyeXB0U3RyaW5nKGludml0YXRpb25TZXNzaW9uS2V5LCBzaGFyZWRHcm91cEluZm8ubmFtZSksXG5cdFx0XHRidWNrZXRFbmNJbnZpdGF0aW9uU2Vzc2lvbktleTogZW5jcnlwdEtleShidWNrZXRLZXksIGludml0YXRpb25TZXNzaW9uS2V5KSxcblx0XHRcdGNhcGFiaWxpdHk6IHNoYXJlQ2FwYWJpbGl0eSxcblx0XHRcdHNoYXJlZEdyb3VwOiBzaGFyZWRHcm91cEluZm8uZ3JvdXAsXG5cdFx0XHRzaGFyZWRHcm91cEVuY0ludml0ZXJHcm91cEluZm9LZXk6IHNoYXJlZEdyb3VwRW5jSW52aXRlckdyb3VwSW5mb0tleS5rZXksXG5cdFx0XHRzaGFyZWRHcm91cEVuY1NoYXJlZEdyb3VwSW5mb0tleTogc2hhcmVkR3JvdXBFbmNTaGFyZWRHcm91cEluZm9LZXkua2V5LFxuXHRcdFx0c2hhcmVkR3JvdXBLZXlWZXJzaW9uOiBTdHJpbmcoc2hhcmVkR3JvdXBLZXkudmVyc2lvbiksXG5cdFx0fSlcblx0XHRjb25zdCBpbnZpdGF0aW9uRGF0YSA9IGNyZWF0ZUdyb3VwSW52aXRhdGlvblBvc3REYXRhKHtcblx0XHRcdHNoYXJlZEdyb3VwRGF0YSxcblx0XHRcdGludGVybmFsS2V5RGF0YTogW10sXG5cdFx0fSlcblx0XHRjb25zdCBub3RGb3VuZFJlY2lwaWVudHM6IEFycmF5PHN0cmluZz4gPSBbXVxuXG5cdFx0Zm9yIChsZXQgbWFpbEFkZHJlc3Mgb2YgcmVjaXBpZW50TWFpbEFkZHJlc3Nlcykge1xuXHRcdFx0Y29uc3Qga2V5RGF0YSA9IGF3YWl0IHRoaXMuY3J5cHRvRmFjYWRlLmVuY3J5cHRCdWNrZXRLZXlGb3JJbnRlcm5hbFJlY2lwaWVudCh1c2VyR3JvdXBJbmZvLmdyb3VwLCBidWNrZXRLZXksIG1haWxBZGRyZXNzLCBub3RGb3VuZFJlY2lwaWVudHMpXG5cdFx0XHRpZiAoa2V5RGF0YSAmJiBpc1NhbWVUeXBlUmVmKGtleURhdGEuX3R5cGUsIEludGVybmFsUmVjaXBpZW50S2V5RGF0YVR5cGVSZWYpKSB7XG5cdFx0XHRcdGludml0YXRpb25EYXRhLmludGVybmFsS2V5RGF0YS5wdXNoKGtleURhdGEgYXMgSW50ZXJuYWxSZWNpcGllbnRLZXlEYXRhKVxuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGlmIChub3RGb3VuZFJlY2lwaWVudHMubGVuZ3RoID4gMCkge1xuXHRcdFx0dGhyb3cgbmV3IFJlY2lwaWVudHNOb3RGb3VuZEVycm9yKG5vdEZvdW5kUmVjaXBpZW50cy5qb2luKFwiXFxuXCIpKVxuXHRcdH1cblx0XHRyZXR1cm4gaW52aXRhdGlvbkRhdGFcblx0fVxuXG5cdGFzeW5jIGFjY2VwdEdyb3VwSW52aXRhdGlvbihpbnZpdGF0aW9uOiBSZWNlaXZlZEdyb3VwSW52aXRhdGlvbik6IFByb21pc2U8dm9pZD4ge1xuXHRcdGNvbnN0IHVzZXJHcm91cEluZm8gPSBhd2FpdCB0aGlzLmVudGl0eUNsaWVudC5sb2FkKEdyb3VwSW5mb1R5cGVSZWYsIHRoaXMudXNlckZhY2FkZS5nZXRMb2dnZWRJblVzZXIoKS51c2VyR3JvdXAuZ3JvdXBJbmZvKVxuXHRcdGNvbnN0IHVzZXJHcm91cEluZm9TZXNzaW9uS2V5ID0gYXdhaXQgdGhpcy5jcnlwdG9GYWNhZGUucmVzb2x2ZVNlc3Npb25LZXlGb3JJbnN0YW5jZSh1c2VyR3JvdXBJbmZvKVxuXHRcdGNvbnN0IHNoYXJlZEdyb3VwS2V5ID0geyBvYmplY3Q6IHVpbnQ4QXJyYXlUb0JpdEFycmF5KGludml0YXRpb24uc2hhcmVkR3JvdXBLZXkpLCB2ZXJzaW9uOiBOdW1iZXIoaW52aXRhdGlvbi5zaGFyZWRHcm91cEtleVZlcnNpb24pIH1cblx0XHRjb25zdCB1c2VyR3JvdXBLZXkgPSB0aGlzLnVzZXJGYWNhZGUuZ2V0Q3VycmVudFVzZXJHcm91cEtleSgpXG5cdFx0Y29uc3QgdXNlckdyb3VwRW5jR3JvdXBLZXkgPSBlbmNyeXB0S2V5V2l0aFZlcnNpb25lZEtleSh1c2VyR3JvdXBLZXksIHNoYXJlZEdyb3VwS2V5Lm9iamVjdClcblx0XHRjb25zdCBzaGFyZWRHcm91cEVuY0ludml0ZWVHcm91cEluZm9LZXkgPSBlbmNyeXB0S2V5V2l0aFZlcnNpb25lZEtleShzaGFyZWRHcm91cEtleSwgbmV2ZXJOdWxsKHVzZXJHcm91cEluZm9TZXNzaW9uS2V5KSlcblx0XHRjb25zdCBzZXJ2aWNlRGF0YSA9IGNyZWF0ZUdyb3VwSW52aXRhdGlvblB1dERhdGEoe1xuXHRcdFx0cmVjZWl2ZWRJbnZpdGF0aW9uOiBpbnZpdGF0aW9uLl9pZCxcblx0XHRcdHVzZXJHcm91cEVuY0dyb3VwS2V5OiB1c2VyR3JvdXBFbmNHcm91cEtleS5rZXksXG5cdFx0XHRzaGFyZWRHcm91cEVuY0ludml0ZWVHcm91cEluZm9LZXk6IHNoYXJlZEdyb3VwRW5jSW52aXRlZUdyb3VwSW5mb0tleS5rZXksXG5cdFx0XHR1c2VyR3JvdXBLZXlWZXJzaW9uOiB1c2VyR3JvdXBFbmNHcm91cEtleS5lbmNyeXB0aW5nS2V5VmVyc2lvbi50b1N0cmluZygpLFxuXHRcdFx0c2hhcmVkR3JvdXBLZXlWZXJzaW9uOiBzaGFyZWRHcm91cEVuY0ludml0ZWVHcm91cEluZm9LZXkuZW5jcnlwdGluZ0tleVZlcnNpb24udG9TdHJpbmcoKSxcblx0XHR9KVxuXHRcdGF3YWl0IHRoaXMuc2VydmljZUV4ZWN1dG9yLnB1dChHcm91cEludml0YXRpb25TZXJ2aWNlLCBzZXJ2aWNlRGF0YSlcblx0fVxuXG5cdGFzeW5jIHJlamVjdE9yQ2FuY2VsR3JvdXBJbnZpdGF0aW9uKHJlY2VpdmVkR3JvdXBJbnZpdGF0aW9uSWQ6IElkVHVwbGUpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCBzZXJ2aWNlRGF0YSA9IGNyZWF0ZUdyb3VwSW52aXRhdGlvbkRlbGV0ZURhdGEoe1xuXHRcdFx0cmVjZWl2ZWRJbnZpdGF0aW9uOiByZWNlaXZlZEdyb3VwSW52aXRhdGlvbklkLFxuXHRcdH0pXG5cdFx0YXdhaXQgdGhpcy5zZXJ2aWNlRXhlY3V0b3IuZGVsZXRlKEdyb3VwSW52aXRhdGlvblNlcnZpY2UsIHNlcnZpY2VEYXRhKVxuXHR9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUF1QkEsb0JBQW9CO0lBRVAsY0FBTixNQUFrQjtDQUN4QixZQUNrQkEsWUFDQUMsY0FDQUMsaUJBQ0FDLGNBQ0FDLGlCQUNoQjtFQW1GRixLQXhGa0I7RUF3RmpCLEtBdkZpQjtFQXVGaEIsS0F0RmdCO0VBc0ZmLEtBckZlO0VBcUZkLEtBcEZjO0NBQ2Q7Q0FFSixNQUFNLG9CQUNMQyxp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