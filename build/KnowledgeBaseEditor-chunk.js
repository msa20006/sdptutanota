import { __toESM } from "./chunk-chunk.js";
import { mithril_default } from "./mithril-chunk.js";
import { LazyLoaded, clone, deduplicate, localeCompare, noOp, ofClass } from "./dist2-chunk.js";
import { lang } from "./LanguageViewModel-chunk.js";
import { elementIdPart, getLetId, listIdPart } from "./EntityUtils-chunk.js";
import { EmailTemplateTypeRef, createKnowledgeBaseEntry, createKnowledgeBaseEntryKeyword } from "./TypeRefs-chunk.js";
import { require_stream } from "./stream-chunk.js";
import { NotFoundError } from "./RestError-chunk.js";
import { ButtonColor, ButtonType } from "./Button-chunk.js";
import { Icons } from "./Icons-chunk.js";
import { Dialog, TextField, createAsyncDropdown } from "./Dialog-chunk.js";
import { ButtonSize } from "./IconButton-chunk.js";
import { locator } from "./CommonLocator-chunk.js";
import { UserError } from "./UserError-chunk.js";
import { showUserError } from "./ErrorHandlerImpl-chunk.js";
import { HtmlEditor } from "./HtmlEditor-chunk.js";
import { TEMPLATE_SHORTCUT_PREFIX } from "./TemplatePopupModel-chunk.js";

//#region src/mail-app/settings/KnowledgeBaseEditorModel.ts
var import_stream = __toESM(require_stream(), 1);
var KnowledgeBaseEditorModel = class {
	title;
	keywords;
	_entityClient;
	_templateGroupRoot;
	entry;
	availableTemplates;
	_descriptionProvider;
	constructor(entry, templateGroupInstances, entityClient) {
		this.title = (0, import_stream.default)(entry ? entry.title : "");
		this.keywords = (0, import_stream.default)(entry ? keywordsToString(entry.keywords) : "");
		this._entityClient = entityClient;
		this._templateGroupRoot = templateGroupInstances;
		this.entry = entry ? clone(entry) : createKnowledgeBaseEntry({
			description: "",
			title: "",
			keywords: []
		});
		this._descriptionProvider = null;
		this.availableTemplates = new LazyLoaded(() => {
			return this._entityClient.loadAll(EmailTemplateTypeRef, this._templateGroupRoot.templates);
		}, []);
	}
	isUpdate() {
		return this.entry._id != null;
	}
	save() {
		if (!this.title()) return Promise.reject(new UserError("emptyTitle_msg"));
		this.entry.title = this.title();
		this.entry.keywords = stringToKeywords(this.keywords());
		if (this._descriptionProvider) this.entry.description = this._descriptionProvider();
		if (this.entry._id) return this._entityClient.update(this.entry).catch(ofClass(NotFoundError, noOp));
else {
			this.entry._ownerGroup = this._templateGroupRoot._id;
			return this._entityClient.setup(this._templateGroupRoot.knowledgeBase, this.entry);
		}
	}
	setDescriptionProvider(provider) {
		this._descriptionProvider = provider;
	}
};
/**
* get keywords as a space separated string
* @param keywords
*/
function keywordsToString(keywords) {
	return keywords.map((keyword) => keyword.keyword).join(" ");
}
function stringToKeywords(keywords) {
	return deduplicate(keywords.split(" ").filter(Boolean)).sort(localeCompare).map((keyword) => createKnowledgeBaseEntryKeyword({ keyword }));
}

//#endregion
//#region src/mail-app/settings/KnowledgeBaseEditor.ts
function showKnowledgeBaseEditor(entry, templateGroupRoot) {
	const { entityClient } = locator;
	const editorModel = new KnowledgeBaseEditorModel(entry, templateGroupRoot, entityClient);
	const closeDialog = () => {
		dialog.close();
	};
	const saveAction = () => {
		editorModel.save().then(closeDialog).catch(ofClass(UserError, showUserError));
	};
	const headerBarAttrs = {
		left: [{
			label: "cancel_action",
			click: closeDialog,
			type: ButtonType.Secondary
		}],
		right: [{
			label: "save_action",
			click: saveAction,
			type: ButtonType.Primary
		}],
		middle: editorModel.entry._id ? "editEntry_label" : "createEntry_action"
	};
	const dialog = Dialog.editDialog(headerBarAttrs, KnowledgeBaseEditor, editorModel);
	dialog.show();
}
var KnowledgeBaseEditor = class {
	entryContentEditor;
	linkedTemplateButtonAttrs;
	constructor(vnode) {
		const model = vnode.attrs;
		this.linkedTemplateButtonAttrs = {
			title: "linkTemplate_label",
			icon: Icons.Add,
			colors: ButtonColor.Elevated,
			click: (e, dom) => {
				e.stopPropagation();
				createAsyncDropdown({ lazyButtons: () => this._createDropdownChildAttrs(model) })(e, dom);
			},
			size: ButtonSize.Compact
		};
		this.entryContentEditor = new HtmlEditor("content_label").showBorders().setMinHeight(500).enableToolbar().setToolbarOptions({ customButtonAttrs: [this.linkedTemplateButtonAttrs] });
		model.setDescriptionProvider(() => {
			return this.entryContentEditor.getValue();
		});
		if (model.isUpdate()) this.entryContentEditor.setValue(model.entry.description);
	}
	_createDropdownChildAttrs(model) {
		return model.availableTemplates.getAsync().then((templates) => {
			if (templates.length > 0) return templates.map((template) => {
				return {
					label: lang.makeTranslation("tag", template.tag),
					click: () => this.entryContentEditor.editor.insertHTML(createTemplateLink(template))
				};
			});
else return [{
				label: "noEntries_msg",
				click: noOp
			}];
		});
	}
	view(vnode) {
		const model = vnode.attrs;
		return mithril_default("", [
			mithril_default(TextField, {
				label: "title_placeholder",
				value: model.title(),
				oninput: model.title
			}),
			mithril_default(TextField, {
				label: "keywords_label",
				value: model.keywords(),
				oninput: model.keywords
			}),
			mithril_default(this.entryContentEditor)
		]);
	}
};
function createTemplateLink(template) {
	const listId = listIdPart(getLetId(template));
	const elementId = elementIdPart(getLetId(template));
	return `<a href="tutatemplate:${listId}/${elementId}">${TEMPLATE_SHORTCUT_PREFIX + template.tag}</a>`;
}

//#endregion
export { showKnowledgeBaseEditor };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiS25vd2xlZGdlQmFzZUVkaXRvci1jaHVuay5qcyIsIm5hbWVzIjpbImVudHJ5OiBLbm93bGVkZ2VCYXNlRW50cnkgfCBudWxsIiwidGVtcGxhdGVHcm91cEluc3RhbmNlczogVGVtcGxhdGVHcm91cFJvb3QiLCJlbnRpdHlDbGllbnQ6IEVudGl0eUNsaWVudCIsInByb3ZpZGVyOiAoKSA9PiBzdHJpbmciLCJrZXl3b3JkczogQXJyYXk8S25vd2xlZGdlQmFzZUVudHJ5S2V5d29yZD4iLCJrZXl3b3Jkczogc3RyaW5nIiwiZW50cnk6IEtub3dsZWRnZUJhc2VFbnRyeSB8IG51bGwiLCJ0ZW1wbGF0ZUdyb3VwUm9vdDogVGVtcGxhdGVHcm91cFJvb3QiLCJoZWFkZXJCYXJBdHRyczogRGlhbG9nSGVhZGVyQmFyQXR0cnMiLCJ2bm9kZTogVm5vZGU8S25vd2xlZGdlQmFzZUVkaXRvck1vZGVsPiIsIm1vZGVsOiBLbm93bGVkZ2VCYXNlRWRpdG9yTW9kZWwiLCJ0ZW1wbGF0ZTogRW1haWxUZW1wbGF0ZSJdLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWlsLWFwcC9zZXR0aW5ncy9Lbm93bGVkZ2VCYXNlRWRpdG9yTW9kZWwudHMiLCIuLi9zcmMvbWFpbC1hcHAvc2V0dGluZ3MvS25vd2xlZGdlQmFzZUVkaXRvci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IEVtYWlsVGVtcGxhdGUgfSBmcm9tIFwiLi4vLi4vY29tbW9uL2FwaS9lbnRpdGllcy90dXRhbm90YS9UeXBlUmVmcy5qc1wiXG5pbXBvcnQgeyBFbWFpbFRlbXBsYXRlVHlwZVJlZiB9IGZyb20gXCIuLi8uLi9jb21tb24vYXBpL2VudGl0aWVzL3R1dGFub3RhL1R5cGVSZWZzLmpzXCJcbmltcG9ydCB7IEVudGl0eUNsaWVudCB9IGZyb20gXCIuLi8uLi9jb21tb24vYXBpL2NvbW1vbi9FbnRpdHlDbGllbnRcIlxuaW1wb3J0IHR5cGUgeyBUZW1wbGF0ZUdyb3VwUm9vdCB9IGZyb20gXCIuLi8uLi9jb21tb24vYXBpL2VudGl0aWVzL3R1dGFub3RhL1R5cGVSZWZzLmpzXCJcbmltcG9ydCB0eXBlIHsgS25vd2xlZGdlQmFzZUVudHJ5IH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9hcGkvZW50aXRpZXMvdHV0YW5vdGEvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHsgY3JlYXRlS25vd2xlZGdlQmFzZUVudHJ5IH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9hcGkvZW50aXRpZXMvdHV0YW5vdGEvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHsgY2xvbmUsIGRlZHVwbGljYXRlLCBMYXp5TG9hZGVkLCBsb2NhbGVDb21wYXJlLCBub09wLCBvZkNsYXNzIH0gZnJvbSBcIkB0dXRhby90dXRhbm90YS11dGlsc1wiXG5pbXBvcnQgc3RyZWFtIGZyb20gXCJtaXRocmlsL3N0cmVhbVwiXG5pbXBvcnQgU3RyZWFtIGZyb20gXCJtaXRocmlsL3N0cmVhbVwiXG5pbXBvcnQgeyBOb3RGb3VuZEVycm9yIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9hcGkvY29tbW9uL2Vycm9yL1Jlc3RFcnJvclwiXG5pbXBvcnQgeyBVc2VyRXJyb3IgfSBmcm9tIFwiLi4vLi4vY29tbW9uL2FwaS9tYWluL1VzZXJFcnJvclwiXG5pbXBvcnQgdHlwZSB7IEtub3dsZWRnZUJhc2VFbnRyeUtleXdvcmQgfSBmcm9tIFwiLi4vLi4vY29tbW9uL2FwaS9lbnRpdGllcy90dXRhbm90YS9UeXBlUmVmcy5qc1wiXG5pbXBvcnQgeyBjcmVhdGVLbm93bGVkZ2VCYXNlRW50cnlLZXl3b3JkIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9hcGkvZW50aXRpZXMvdHV0YW5vdGEvVHlwZVJlZnMuanNcIlxuXG5leHBvcnQgY2xhc3MgS25vd2xlZGdlQmFzZUVkaXRvck1vZGVsIHtcblx0dGl0bGU6IFN0cmVhbTxzdHJpbmc+XG5cdGtleXdvcmRzOiBTdHJlYW08c3RyaW5nPlxuXHRwcml2YXRlIHJlYWRvbmx5IF9lbnRpdHlDbGllbnQ6IEVudGl0eUNsaWVudFxuXHRwcml2YXRlIHJlYWRvbmx5IF90ZW1wbGF0ZUdyb3VwUm9vdDogVGVtcGxhdGVHcm91cFJvb3Rcblx0cmVhZG9ubHkgZW50cnk6IEtub3dsZWRnZUJhc2VFbnRyeVxuXHRyZWFkb25seSBhdmFpbGFibGVUZW1wbGF0ZXM6IExhenlMb2FkZWQ8QXJyYXk8RW1haWxUZW1wbGF0ZT4+XG5cdHByaXZhdGUgX2Rlc2NyaXB0aW9uUHJvdmlkZXI6ICgoKSA9PiBzdHJpbmcpIHwgbnVsbFxuXG5cdGNvbnN0cnVjdG9yKGVudHJ5OiBLbm93bGVkZ2VCYXNlRW50cnkgfCBudWxsLCB0ZW1wbGF0ZUdyb3VwSW5zdGFuY2VzOiBUZW1wbGF0ZUdyb3VwUm9vdCwgZW50aXR5Q2xpZW50OiBFbnRpdHlDbGllbnQpIHtcblx0XHR0aGlzLnRpdGxlID0gc3RyZWFtKGVudHJ5ID8gZW50cnkudGl0bGUgOiBcIlwiKVxuXHRcdHRoaXMua2V5d29yZHMgPSBzdHJlYW0oZW50cnkgPyBrZXl3b3Jkc1RvU3RyaW5nKGVudHJ5LmtleXdvcmRzKSA6IFwiXCIpXG5cdFx0dGhpcy5fZW50aXR5Q2xpZW50ID0gZW50aXR5Q2xpZW50XG5cdFx0dGhpcy5fdGVtcGxhdGVHcm91cFJvb3QgPSB0ZW1wbGF0ZUdyb3VwSW5zdGFuY2VzXG5cdFx0dGhpcy5lbnRyeSA9IGVudHJ5ID8gY2xvbmUoZW50cnkpIDogY3JlYXRlS25vd2xlZGdlQmFzZUVudHJ5KHsgZGVzY3JpcHRpb246IFwiXCIsIHRpdGxlOiBcIlwiLCBrZXl3b3JkczogW10gfSlcblx0XHR0aGlzLl9kZXNjcmlwdGlvblByb3ZpZGVyID0gbnVsbFxuXHRcdHRoaXMuYXZhaWxhYmxlVGVtcGxhdGVzID0gbmV3IExhenlMb2FkZWQoKCkgPT4ge1xuXHRcdFx0cmV0dXJuIHRoaXMuX2VudGl0eUNsaWVudC5sb2FkQWxsKEVtYWlsVGVtcGxhdGVUeXBlUmVmLCB0aGlzLl90ZW1wbGF0ZUdyb3VwUm9vdC50ZW1wbGF0ZXMpXG5cdFx0fSwgW10pXG5cdH1cblxuXHRpc1VwZGF0ZSgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5lbnRyeS5faWQgIT0gbnVsbFxuXHR9XG5cblx0c2F2ZSgpOiBQcm9taXNlPGFueT4ge1xuXHRcdGlmICghdGhpcy50aXRsZSgpKSB7XG5cdFx0XHRyZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IFVzZXJFcnJvcihcImVtcHR5VGl0bGVfbXNnXCIpKVxuXHRcdH1cblxuXHRcdHRoaXMuZW50cnkudGl0bGUgPSB0aGlzLnRpdGxlKClcblx0XHR0aGlzLmVudHJ5LmtleXdvcmRzID0gc3RyaW5nVG9LZXl3b3Jkcyh0aGlzLmtleXdvcmRzKCkpXG5cblx0XHRpZiAodGhpcy5fZGVzY3JpcHRpb25Qcm92aWRlcikge1xuXHRcdFx0dGhpcy5lbnRyeS5kZXNjcmlwdGlvbiA9IHRoaXMuX2Rlc2NyaXB0aW9uUHJvdmlkZXIoKVxuXHRcdH1cblxuXHRcdGlmICh0aGlzLmVudHJ5Ll9pZCkge1xuXHRcdFx0cmV0dXJuIHRoaXMuX2VudGl0eUNsaWVudC51cGRhdGUodGhpcy5lbnRyeSkuY2F0Y2gob2ZDbGFzcyhOb3RGb3VuZEVycm9yLCBub09wKSlcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5lbnRyeS5fb3duZXJHcm91cCA9IHRoaXMuX3RlbXBsYXRlR3JvdXBSb290Ll9pZFxuXHRcdFx0cmV0dXJuIHRoaXMuX2VudGl0eUNsaWVudC5zZXR1cCh0aGlzLl90ZW1wbGF0ZUdyb3VwUm9vdC5rbm93bGVkZ2VCYXNlLCB0aGlzLmVudHJ5KVxuXHRcdH1cblx0fVxuXG5cdHNldERlc2NyaXB0aW9uUHJvdmlkZXIocHJvdmlkZXI6ICgpID0+IHN0cmluZykge1xuXHRcdHRoaXMuX2Rlc2NyaXB0aW9uUHJvdmlkZXIgPSBwcm92aWRlclxuXHR9XG59XG5cbi8qKlxuICogZ2V0IGtleXdvcmRzIGFzIGEgc3BhY2Ugc2VwYXJhdGVkIHN0cmluZ1xuICogQHBhcmFtIGtleXdvcmRzXG4gKi9cbmZ1bmN0aW9uIGtleXdvcmRzVG9TdHJpbmcoa2V5d29yZHM6IEFycmF5PEtub3dsZWRnZUJhc2VFbnRyeUtleXdvcmQ+KTogc3RyaW5nIHtcblx0cmV0dXJuIGtleXdvcmRzLm1hcCgoa2V5d29yZCkgPT4ga2V5d29yZC5rZXl3b3JkKS5qb2luKFwiIFwiKVxufVxuXG5mdW5jdGlvbiBzdHJpbmdUb0tleXdvcmRzKGtleXdvcmRzOiBzdHJpbmcpOiBBcnJheTxLbm93bGVkZ2VCYXNlRW50cnlLZXl3b3JkPiB7XG5cdHJldHVybiBkZWR1cGxpY2F0ZShrZXl3b3Jkcy5zcGxpdChcIiBcIikuZmlsdGVyKEJvb2xlYW4pKVxuXHRcdC5zb3J0KGxvY2FsZUNvbXBhcmUpXG5cdFx0Lm1hcCgoa2V5d29yZCkgPT5cblx0XHRcdGNyZWF0ZUtub3dsZWRnZUJhc2VFbnRyeUtleXdvcmQoe1xuXHRcdFx0XHRrZXl3b3JkLFxuXHRcdFx0fSksXG5cdFx0KVxufVxuIiwiaW1wb3J0IG0sIHsgQ2hpbGRyZW4sIENvbXBvbmVudCwgVm5vZGUgfSBmcm9tIFwibWl0aHJpbFwiXG5pbXBvcnQgdHlwZSB7IEVtYWlsVGVtcGxhdGUsIEtub3dsZWRnZUJhc2VFbnRyeSwgVGVtcGxhdGVHcm91cFJvb3QgfSBmcm9tIFwiLi4vLi4vY29tbW9uL2FwaS9lbnRpdGllcy90dXRhbm90YS9UeXBlUmVmcy5qc1wiXG5pbXBvcnQgeyBCdXR0b25Db2xvciwgQnV0dG9uVHlwZSB9IGZyb20gXCIuLi8uLi9jb21tb24vZ3VpL2Jhc2UvQnV0dG9uLmpzXCJcbmltcG9ydCB7IEtub3dsZWRnZUJhc2VFZGl0b3JNb2RlbCB9IGZyb20gXCIuL0tub3dsZWRnZUJhc2VFZGl0b3JNb2RlbFwiXG5pbXBvcnQgeyBub09wLCBvZkNsYXNzIH0gZnJvbSBcIkB0dXRhby90dXRhbm90YS11dGlsc1wiXG5pbXBvcnQgeyBUZXh0RmllbGQgfSBmcm9tIFwiLi4vLi4vY29tbW9uL2d1aS9iYXNlL1RleHRGaWVsZC5qc1wiXG5pbXBvcnQgeyBEaWFsb2cgfSBmcm9tIFwiLi4vLi4vY29tbW9uL2d1aS9iYXNlL0RpYWxvZ1wiXG5pbXBvcnQgdHlwZSB7IERpYWxvZ0hlYWRlckJhckF0dHJzIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9ndWkvYmFzZS9EaWFsb2dIZWFkZXJCYXJcIlxuaW1wb3J0IHsgbGFuZyB9IGZyb20gXCIuLi8uLi9jb21tb24vbWlzYy9MYW5ndWFnZVZpZXdNb2RlbFwiXG5pbXBvcnQgeyBsb2NhdG9yIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9hcGkvbWFpbi9Db21tb25Mb2NhdG9yXCJcbmltcG9ydCB0eXBlIHsgRHJvcGRvd25DaGlsZEF0dHJzIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9ndWkvYmFzZS9Ecm9wZG93bi5qc1wiXG5pbXBvcnQgeyBjcmVhdGVBc3luY0Ryb3Bkb3duIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9ndWkvYmFzZS9Ecm9wZG93bi5qc1wiXG5pbXBvcnQgeyBzaG93VXNlckVycm9yIH0gZnJvbSBcIi4uLy4uL2NvbW1vbi9taXNjL0Vycm9ySGFuZGxlckltcGxcIlxuaW1wb3J0IHsgZWxlbWVudElkUGFydCwgZ2V0TGV0SWQsIGxpc3RJZFBhcnQgfSBmcm9tIFwiLi4vLi4vY29tbW9uL2FwaS9jb21tb24vdXRpbHMvRW50aXR5VXRpbHNcIlxuaW1wb3J0IHsgSHRtbEVkaXRvciB9IGZyb20gXCIuLi8uLi9jb21tb24vZ3VpL2VkaXRvci9IdG1sRWRpdG9yXCJcbmltcG9ydCB7IFVzZXJFcnJvciB9IGZyb20gXCIuLi8uLi9jb21tb24vYXBpL21haW4vVXNlckVycm9yXCJcbmltcG9ydCB7IFRFTVBMQVRFX1NIT1JUQ1VUX1BSRUZJWCB9IGZyb20gXCIuLi90ZW1wbGF0ZXMvbW9kZWwvVGVtcGxhdGVQb3B1cE1vZGVsXCJcbmltcG9ydCB7IEljb25CdXR0b25BdHRycyB9IGZyb20gXCIuLi8uLi9jb21tb24vZ3VpL2Jhc2UvSWNvbkJ1dHRvbi5qc1wiXG5pbXBvcnQgeyBJY29ucyB9IGZyb20gXCIuLi8uLi9jb21tb24vZ3VpL2Jhc2UvaWNvbnMvSWNvbnMuanNcIlxuaW1wb3J0IHsgQnV0dG9uU2l6ZSB9IGZyb20gXCIuLi8uLi9jb21tb24vZ3VpL2Jhc2UvQnV0dG9uU2l6ZS5qc1wiXG5cbi8qKlxuICogIEVkaXRvciB0byBlZGl0IC8gYWRkIGEga25vd2xlZGdlQmFzZSBlbnRyeVxuICogIFJldHVybmVkIHByb21pc2UgcmVzb2x2ZXMgd2hlbiB0aGUgZGlhbG9nIGNsb3Nlc1xuICovXG5leHBvcnQgZnVuY3Rpb24gc2hvd0tub3dsZWRnZUJhc2VFZGl0b3IoZW50cnk6IEtub3dsZWRnZUJhc2VFbnRyeSB8IG51bGwsIHRlbXBsYXRlR3JvdXBSb290OiBUZW1wbGF0ZUdyb3VwUm9vdCk6IHZvaWQge1xuXHRjb25zdCB7IGVudGl0eUNsaWVudCB9ID0gbG9jYXRvclxuXHRjb25zdCBlZGl0b3JNb2RlbCA9IG5ldyBLbm93bGVkZ2VCYXNlRWRpdG9yTW9kZWwoZW50cnksIHRlbXBsYXRlR3JvdXBSb290LCBlbnRpdHlDbGllbnQpXG5cblx0Y29uc3QgY2xvc2VEaWFsb2cgPSAoKSA9PiB7XG5cdFx0ZGlhbG9nLmNsb3NlKClcblx0fVxuXG5cdGNvbnN0IHNhdmVBY3Rpb24gPSAoKSA9PiB7XG5cdFx0ZWRpdG9yTW9kZWwuc2F2ZSgpLnRoZW4oY2xvc2VEaWFsb2cpLmNhdGNoKG9mQ2xhc3MoVXNlckVycm9yLCBzaG93VXNlckVycm9yKSlcblx0fVxuXG5cdGNvbnN0IGhlYWRlckJhckF0dHJzOiBEaWFsb2dIZWFkZXJCYXJBdHRycyA9IHtcblx0XHRsZWZ0OiBbXG5cdFx0XHR7XG5cdFx0XHRcdGxhYmVsOiBcImNhbmNlbF9hY3Rpb25cIixcblx0XHRcdFx0Y2xpY2s6IGNsb3NlRGlhbG9nLFxuXHRcdFx0XHR0eXBlOiBCdXR0b25UeXBlLlNlY29uZGFyeSxcblx0XHRcdH0sXG5cdFx0XSxcblx0XHRyaWdodDogW1xuXHRcdFx0e1xuXHRcdFx0XHRsYWJlbDogXCJzYXZlX2FjdGlvblwiLFxuXHRcdFx0XHRjbGljazogc2F2ZUFjdGlvbixcblx0XHRcdFx0dHlwZTogQnV0dG9uVHlwZS5QcmltYXJ5LFxuXHRcdFx0fSxcblx0XHRdLFxuXHRcdG1pZGRsZTogZWRpdG9yTW9kZWwuZW50cnkuX2lkID8gXCJlZGl0RW50cnlfbGFiZWxcIiA6IFwiY3JlYXRlRW50cnlfYWN0aW9uXCIsXG5cdH1cblx0Y29uc3QgZGlhbG9nID0gRGlhbG9nLmVkaXREaWFsb2coaGVhZGVyQmFyQXR0cnMsIEtub3dsZWRnZUJhc2VFZGl0b3IsIGVkaXRvck1vZGVsKVxuXHRkaWFsb2cuc2hvdygpXG59XG5cbmNsYXNzIEtub3dsZWRnZUJhc2VFZGl0b3IgaW1wbGVtZW50cyBDb21wb25lbnQ8S25vd2xlZGdlQmFzZUVkaXRvck1vZGVsPiB7XG5cdGVudHJ5Q29udGVudEVkaXRvcjogSHRtbEVkaXRvclxuXHRsaW5rZWRUZW1wbGF0ZUJ1dHRvbkF0dHJzOiBJY29uQnV0dG9uQXR0cnNcblxuXHRjb25zdHJ1Y3Rvcih2bm9kZTogVm5vZGU8S25vd2xlZGdlQmFzZUVkaXRvck1vZGVsPikge1xuXHRcdGNvbnN0IG1vZGVsID0gdm5vZGUuYXR0cnNcblx0XHR0aGlzLmxpbmtlZFRlbXBsYXRlQnV0dG9uQXR0cnMgPSB7XG5cdFx0XHR0aXRsZTogXCJsaW5rVGVtcGxhdGVfbGFiZWxcIixcblx0XHRcdGljb246IEljb25zLkFkZCxcblx0XHRcdGNvbG9yczogQnV0dG9uQ29sb3IuRWxldmF0ZWQsXG5cdFx0XHRjbGljazogKGUsIGRvbSkgPT4ge1xuXHRcdFx0XHRlLnN0b3BQcm9wYWdhdGlvbigpXG5cdFx0XHRcdGNyZWF0ZUFzeW5jRHJvcGRvd24oe1xuXHRcdFx0XHRcdGxhenlCdXR0b25zOiAoKSA9PiB0aGlzLl9jcmVhdGVEcm9wZG93bkNoaWxkQXR0cnMobW9kZWwpLFxuXHRcdFx0XHR9KShlLCBkb20pXG5cdFx0XHR9LFxuXHRcdFx0c2l6ZTogQnV0dG9uU2l6ZS5Db21wYWN0LFxuXHRcdH1cblx0XHR0aGlzLmVudHJ5Q29udGVudEVkaXRvciA9IG5ldyBIdG1sRWRpdG9yKFwiY29udGVudF9sYWJlbFwiKVxuXHRcdFx0LnNob3dCb3JkZXJzKClcblx0XHRcdC5zZXRNaW5IZWlnaHQoNTAwKVxuXHRcdFx0LmVuYWJsZVRvb2xiYXIoKVxuXHRcdFx0LnNldFRvb2xiYXJPcHRpb25zKHtcblx0XHRcdFx0Y3VzdG9tQnV0dG9uQXR0cnM6IFt0aGlzLmxpbmtlZFRlbXBsYXRlQnV0dG9uQXR0cnNdLFxuXHRcdFx0fSlcblx0XHRtb2RlbC5zZXREZXNjcmlwdGlvblByb3ZpZGVyKCgpID0+IHtcblx0XHRcdHJldHVybiB0aGlzLmVudHJ5Q29udGVudEVkaXRvci5nZXRWYWx1ZSgpXG5cdFx0fSlcblxuXHRcdGlmIChtb2RlbC5pc1VwZGF0ZSgpKSB7XG5cdFx0XHR0aGlzLmVudHJ5Q29udGVudEVkaXRvci5zZXRWYWx1ZShtb2RlbC5lbnRyeS5kZXNjcmlwdGlvbilcblx0XHR9XG5cdH1cblxuXHRfY3JlYXRlRHJvcGRvd25DaGlsZEF0dHJzKG1vZGVsOiBLbm93bGVkZ2VCYXNlRWRpdG9yTW9kZWwpOiBQcm9taXNlPEFycmF5PERyb3Bkb3duQ2hpbGRBdHRycz4+IHtcblx0XHRyZXR1cm4gbW9kZWwuYXZhaWxhYmxlVGVtcGxhdGVzLmdldEFzeW5jKCkudGhlbigodGVtcGxhdGVzKSA9PiB7XG5cdFx0XHRpZiAodGVtcGxhdGVzLmxlbmd0aCA+IDApIHtcblx0XHRcdFx0cmV0dXJuIHRlbXBsYXRlcy5tYXAoKHRlbXBsYXRlKSA9PiB7XG5cdFx0XHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0XHRcdGxhYmVsOiBsYW5nLm1ha2VUcmFuc2xhdGlvbihcInRhZ1wiLCB0ZW1wbGF0ZS50YWcpLFxuXHRcdFx0XHRcdFx0Y2xpY2s6ICgpID0+IHRoaXMuZW50cnlDb250ZW50RWRpdG9yLmVkaXRvci5pbnNlcnRIVE1MKGNyZWF0ZVRlbXBsYXRlTGluayh0ZW1wbGF0ZSkpLFxuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSlcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdHJldHVybiBbXG5cdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0bGFiZWw6IFwibm9FbnRyaWVzX21zZ1wiLFxuXHRcdFx0XHRcdFx0Y2xpY2s6IG5vT3AsXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XVxuXHRcdFx0fVxuXHRcdH0pXG5cdH1cblxuXHR2aWV3KHZub2RlOiBWbm9kZTxLbm93bGVkZ2VCYXNlRWRpdG9yTW9kZWw+KTogQ2hpbGRyZW4ge1xuXHRcdGNvbnN0IG1vZGVsID0gdm5vZGUuYXR0cnNcblx0XHRyZXR1cm4gbShcIlwiLCBbXG5cdFx0XHRtKFRleHRGaWVsZCwge1xuXHRcdFx0XHRsYWJlbDogXCJ0aXRsZV9wbGFjZWhvbGRlclwiLFxuXHRcdFx0XHR2YWx1ZTogbW9kZWwudGl0bGUoKSxcblx0XHRcdFx0b25pbnB1dDogbW9kZWwudGl0bGUsXG5cdFx0XHR9KSxcblx0XHRcdG0oVGV4dEZpZWxkLCB7XG5cdFx0XHRcdGxhYmVsOiBcImtleXdvcmRzX2xhYmVsXCIsXG5cdFx0XHRcdHZhbHVlOiBtb2RlbC5rZXl3b3JkcygpLFxuXHRcdFx0XHRvbmlucHV0OiBtb2RlbC5rZXl3b3Jkcyxcblx0XHRcdH0pLFxuXHRcdFx0bSh0aGlzLmVudHJ5Q29udGVudEVkaXRvciksXG5cdFx0XSlcblx0fVxufVxuXG5mdW5jdGlvbiBjcmVhdGVUZW1wbGF0ZUxpbmsodGVtcGxhdGU6IEVtYWlsVGVtcGxhdGUpOiBzdHJpbmcge1xuXHRjb25zdCBsaXN0SWQgPSBsaXN0SWRQYXJ0KGdldExldElkKHRlbXBsYXRlKSlcblx0Y29uc3QgZWxlbWVudElkID0gZWxlbWVudElkUGFydChnZXRMZXRJZCh0ZW1wbGF0ZSkpXG5cdHJldHVybiBgPGEgaHJlZj1cInR1dGF0ZW1wbGF0ZToke2xpc3RJZH0vJHtlbGVtZW50SWR9XCI+JHtURU1QTEFURV9TSE9SVENVVF9QUkVGSVggKyB0ZW1wbGF0ZS50YWd9PC9hPmBcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFjYSwyQkFBTixNQUErQjtDQUNyQztDQUNBO0NBQ0EsQUFBaUI7Q0FDakIsQUFBaUI7Q0FDakIs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