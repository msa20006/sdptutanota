import { ProgrammingError } from "./ProgrammingError-chunk.js";
import { Mode } from "./Env-chunk.js";
import { mithril_default } from "./mithril-chunk.js";
import { debounce, findAllAndRemove, isNotNull, ofClass, remove } from "./dist2-chunk.js";
import { lang } from "./LanguageViewModel-chunk.js";
import { FileNotFoundError, FileOpenError } from "./ErrorUtils-chunk.js";
import { PermissionError } from "./PermissionError-chunk.js";
import { Dialog } from "./Dialog-chunk.js";
import { locator } from "./CommonLocator-chunk.js";
import { UserError } from "./UserError-chunk.js";
import { isDataFile, isFileReference, isTutanotaFile } from "./FileUtils-chunk.js";
import { showFileChooser } from "./SharedMailUtils-chunk.js";
import { showUserError } from "./ErrorHandlerImpl-chunk.js";
import { AttachmentType } from "./AttachmentBubble-chunk.js";

//#region src/mail-app/mail/editor/MailEditorViewModel.ts
async function chooseAndAttachFile(model, boundingRect, fileTypes) {
	boundingRect.height = Math.round(boundingRect.height);
	boundingRect.width = Math.round(boundingRect.width);
	boundingRect.x = Math.round(boundingRect.x);
	boundingRect.y = Math.round(boundingRect.y);
	try {
		const files = await showFileChooserForAttachments(boundingRect, fileTypes);
		if (!files || files.length === 0) return;
		switch (env.mode) {
			case Mode.App:
				model.attachFiles(files);
				return files;
			case Mode.Desktop: {
				const dataFiles = (await Promise.all(files.map(async (f) => locator.fileApp.readDataFile(f.location)))).filter(isNotNull);
				model.attachFiles(dataFiles);
				return dataFiles;
			}
			default:
				model.attachFiles(files);
				return files;
		}
	} catch (e) {
		if (e instanceof UserError) await showUserError(e);
else {
			const msg = e.message || "unknown error";
			console.error("could not attach files:", msg);
		}
	}
}
function showFileChooserForAttachments(boundingRect, fileTypes) {
	const fileSelector = [Mode.App, Mode.Desktop].includes(env.mode) ? locator.fileApp.openFileChooser(boundingRect, fileTypes) : showFileChooser(true, fileTypes);
	return fileSelector.catch(ofClass(PermissionError, () => {
		Dialog.message("fileAccessDeniedMobile_msg");
	})).catch(ofClass(FileNotFoundError, () => {
		Dialog.message("couldNotAttachFile_msg");
	}));
}
function createAttachmentBubbleAttrs(model, inlineImageElements) {
	return model.getAttachments().map((attachment) => ({
		attachment,
		open: null,
		download: () => _downloadAttachment(attachment),
		remove: () => {
			model.removeAttachment(attachment);
			if (attachment.cid) {
				const imageElement = inlineImageElements.find((e) => e.getAttribute("cid") === attachment.cid);
				if (imageElement) {
					imageElement.remove();
					remove(inlineImageElements, imageElement);
				}
			}
			mithril_default.redraw();
		},
		fileImport: null,
		type: AttachmentType.GENERIC
	}));
}
async function _downloadAttachment(attachment) {
	try {
		if (isFileReference(attachment)) await locator.fileApp.open(attachment);
else if (isDataFile(attachment)) await locator.fileController.saveDataFile(attachment);
else if (isTutanotaFile(attachment)) await locator.fileController.download(attachment);
else throw new ProgrammingError("attachment is neither reference, datafile nor tutanotafile!");
	} catch (e) {
		if (e instanceof FileOpenError) return Dialog.message("canNotOpenFileOnDevice_msg");
else {
			const msg = e.message || "unknown error";
			console.error("could not open file:", msg);
			return Dialog.message("errorDuringFileOpen_msg");
		}
	}
}
const cleanupInlineAttachments = debounce(50, (domElement, inlineImageElements, attachments) => {
	const elementsToRemove = [];
	for (const inlineImage of inlineImageElements) if (domElement && !domElement.contains(inlineImage)) {
		const cid = inlineImage.getAttribute("cid");
		const attachmentIndex = attachments.findIndex((a) => a.cid === cid);
		if (attachmentIndex !== -1) {
			attachments.splice(attachmentIndex, 1);
			elementsToRemove.push(inlineImage);
			mithril_default.redraw();
		}
	}
	findAllAndRemove(inlineImageElements, (imageElement) => elementsToRemove.includes(imageElement));
});
function getConfidentialStateMessage(isConfidential) {
	return isConfidential ? lang.get("confidentialStatus_msg") : lang.get("nonConfidentialStatus_msg");
}

//#endregion
export { chooseAndAttachFile, cleanupInlineAttachments, createAttachmentBubbleAttrs, getConfidentialStateMessage };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbEVkaXRvclZpZXdNb2RlbC1jaHVuay5qcyIsIm5hbWVzIjpbIm1vZGVsOiBTZW5kTWFpbE1vZGVsIiwiYm91bmRpbmdSZWN0OiBDbGllbnRSZWN0IiwiZmlsZVR5cGVzPzogQXJyYXk8c3RyaW5nPiIsImRhdGFGaWxlczogQXJyYXk8RGF0YUZpbGU+IiwiaW5saW5lSW1hZ2VFbGVtZW50czogQXJyYXk8SFRNTEVsZW1lbnQ+IiwiYXR0YWNobWVudDogQXR0YWNobWVudCIsImNsZWFudXBJbmxpbmVBdHRhY2htZW50czogKGFyZzA6IEhUTUxFbGVtZW50LCBhcmcxOiBBcnJheTxIVE1MRWxlbWVudD4sIGFyZzI6IEFycmF5PEF0dGFjaG1lbnQ+KSA9PiB2b2lkIiwiZG9tRWxlbWVudDogSFRNTEVsZW1lbnQiLCJhdHRhY2htZW50czogQXJyYXk8QXR0YWNobWVudD4iLCJlbGVtZW50c1RvUmVtb3ZlOiBIVE1MRWxlbWVudFtdIiwiaXNDb25maWRlbnRpYWw6IGJvb2xlYW4iXSwic291cmNlcyI6WyIuLi9zcmMvbWFpbC1hcHAvbWFpbC9lZGl0b3IvTWFpbEVkaXRvclZpZXdNb2RlbC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbSBmcm9tIFwibWl0aHJpbFwiXG5pbXBvcnQgdHlwZSB7IEF0dGFjaG1lbnQgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL21haWxGdW5jdGlvbmFsaXR5L1NlbmRNYWlsTW9kZWwuanNcIlxuaW1wb3J0IHsgU2VuZE1haWxNb2RlbCB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vbWFpbEZ1bmN0aW9uYWxpdHkvU2VuZE1haWxNb2RlbC5qc1wiXG5pbXBvcnQgeyBkZWJvdW5jZSwgZmluZEFsbEFuZFJlbW92ZSwgaXNOb3ROdWxsLCBvZkNsYXNzLCByZW1vdmUgfSBmcm9tIFwiQHR1dGFvL3R1dGFub3RhLXV0aWxzXCJcbmltcG9ydCB7IE1vZGUgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL2FwaS9jb21tb24vRW52XCJcbmltcG9ydCB7IFBlcm1pc3Npb25FcnJvciB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vYXBpL2NvbW1vbi9lcnJvci9QZXJtaXNzaW9uRXJyb3JcIlxuaW1wb3J0IHsgRGlhbG9nIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9ndWkvYmFzZS9EaWFsb2dcIlxuaW1wb3J0IHsgRmlsZU5vdEZvdW5kRXJyb3IgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL2FwaS9jb21tb24vZXJyb3IvRmlsZU5vdEZvdW5kRXJyb3JcIlxuaW1wb3J0IHsgbGFuZyB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vbWlzYy9MYW5ndWFnZVZpZXdNb2RlbFwiXG5pbXBvcnQgeyBGaWxlT3BlbkVycm9yIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9hcGkvY29tbW9uL2Vycm9yL0ZpbGVPcGVuRXJyb3JcIlxuaW1wb3J0IHsgVXNlckVycm9yIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9hcGkvbWFpbi9Vc2VyRXJyb3JcIlxuaW1wb3J0IHsgc2hvd1VzZXJFcnJvciB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vbWlzYy9FcnJvckhhbmRsZXJJbXBsXCJcbmltcG9ydCB7IGxvY2F0b3IgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL2FwaS9tYWluL0NvbW1vbkxvY2F0b3JcIlxuaW1wb3J0IHsgRmlsZVJlZmVyZW5jZSwgaXNEYXRhRmlsZSwgaXNGaWxlUmVmZXJlbmNlLCBpc1R1dGFub3RhRmlsZSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vYXBpL2NvbW1vbi91dGlscy9GaWxlVXRpbHNcIlxuaW1wb3J0IHsgRGF0YUZpbGUgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL2FwaS9jb21tb24vRGF0YUZpbGVcIlxuaW1wb3J0IHsgc2hvd0ZpbGVDaG9vc2VyIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9maWxlL0ZpbGVDb250cm9sbGVyLmpzXCJcbmltcG9ydCB7IFByb2dyYW1taW5nRXJyb3IgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL2FwaS9jb21tb24vZXJyb3IvUHJvZ3JhbW1pbmdFcnJvci5qc1wiXG5pbXBvcnQgeyBBdHRhY2htZW50QnViYmxlQXR0cnMsIEF0dGFjaG1lbnRUeXBlIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9ndWkvQXR0YWNobWVudEJ1YmJsZS5qc1wiXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjaG9vc2VBbmRBdHRhY2hGaWxlKFxuXHRtb2RlbDogU2VuZE1haWxNb2RlbCxcblx0Ym91bmRpbmdSZWN0OiBDbGllbnRSZWN0LFxuXHRmaWxlVHlwZXM/OiBBcnJheTxzdHJpbmc+LFxuKTogUHJvbWlzZTxSZWFkb25seUFycmF5PERhdGFGaWxlIHwgRmlsZVJlZmVyZW5jZT4gfCB2b2lkPiB7XG5cdGJvdW5kaW5nUmVjdC5oZWlnaHQgPSBNYXRoLnJvdW5kKGJvdW5kaW5nUmVjdC5oZWlnaHQpXG5cdGJvdW5kaW5nUmVjdC53aWR0aCA9IE1hdGgucm91bmQoYm91bmRpbmdSZWN0LndpZHRoKVxuXHRib3VuZGluZ1JlY3QueCA9IE1hdGgucm91bmQoYm91bmRpbmdSZWN0LngpXG5cdGJvdW5kaW5nUmVjdC55ID0gTWF0aC5yb3VuZChib3VuZGluZ1JlY3QueSlcblx0dHJ5IHtcblx0XHRjb25zdCBmaWxlcyA9IGF3YWl0IHNob3dGaWxlQ2hvb3NlckZvckF0dGFjaG1lbnRzKGJvdW5kaW5nUmVjdCwgZmlsZVR5cGVzKVxuXHRcdGlmICghZmlsZXMgfHwgZmlsZXMubGVuZ3RoID09PSAwKSByZXR1cm5cblx0XHRzd2l0Y2ggKGVudi5tb2RlKSB7XG5cdFx0XHRjYXNlIE1vZGUuQXBwOlxuXHRcdFx0XHQvLyB3ZSBoYXZlIGZpbGUgcmVmcyBhbmQgd2FudCB0byBrZWVwIHRoZW1cblx0XHRcdFx0bW9kZWwuYXR0YWNoRmlsZXMoZmlsZXMpXG5cdFx0XHRcdHJldHVybiBmaWxlc1xuXHRcdFx0Y2FzZSBNb2RlLkRlc2t0b3A6IHtcblx0XHRcdFx0Ly8gdGhpcyBpcyBpbXBvcnRhbnQgZm9yIHRoZSBkZXNrdG9wIGNsaWVudCBzbyBpdCBjYW4gYXR0YWNoIHRoZW0gYXMgaW5saW5lIGltYWdlcy4gLy8gd2UgaGF2ZSBmaWxlIHJlZnMgYW5kIHdhbnQgdG8gcmVhZCB0aGVtLlxuXHRcdFx0XHRjb25zdCBkYXRhRmlsZXM6IEFycmF5PERhdGFGaWxlPiA9IChcblx0XHRcdFx0XHRhd2FpdCBQcm9taXNlLmFsbCgoZmlsZXMgYXMgQXJyYXk8RmlsZVJlZmVyZW5jZT4pLm1hcChhc3luYyAoZikgPT4gbG9jYXRvci5maWxlQXBwLnJlYWREYXRhRmlsZShmLmxvY2F0aW9uKSkpXG5cdFx0XHRcdCkuZmlsdGVyKGlzTm90TnVsbClcblx0XHRcdFx0bW9kZWwuYXR0YWNoRmlsZXMoZGF0YUZpbGVzKVxuXHRcdFx0XHRyZXR1cm4gZGF0YUZpbGVzXG5cdFx0XHR9XG5cdFx0XHRkZWZhdWx0OlxuXHRcdFx0XHQvLyB3ZSBoYXZlIGRhdGEgZmlsZXMgYW5kIHdhbnQgdG8ga2VlcCB0aGVtXG5cdFx0XHRcdG1vZGVsLmF0dGFjaEZpbGVzKGZpbGVzKVxuXHRcdFx0XHRyZXR1cm4gZmlsZXNcblx0XHR9XG5cdH0gY2F0Y2ggKGUpIHtcblx0XHRpZiAoZSBpbnN0YW5jZW9mIFVzZXJFcnJvcikge1xuXHRcdFx0YXdhaXQgc2hvd1VzZXJFcnJvcihlKVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRjb25zdCBtc2cgPSBlLm1lc3NhZ2UgfHwgXCJ1bmtub3duIGVycm9yXCJcblx0XHRcdGNvbnNvbGUuZXJyb3IoXCJjb3VsZCBub3QgYXR0YWNoIGZpbGVzOlwiLCBtc2cpXG5cdFx0fVxuXHR9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzaG93RmlsZUNob29zZXJGb3JBdHRhY2htZW50cyhib3VuZGluZ1JlY3Q6IENsaWVudFJlY3QsIGZpbGVUeXBlcz86IEFycmF5PHN0cmluZz4pOiBQcm9taXNlPFJlYWRvbmx5QXJyYXk8RmlsZVJlZmVyZW5jZSB8IERhdGFGaWxlPiB8IHZvaWQ+IHtcblx0Y29uc3QgZmlsZVNlbGVjdG9yID0gW01vZGUuQXBwLCBNb2RlLkRlc2t0b3BdLmluY2x1ZGVzKGVudi5tb2RlKVxuXHRcdD8gbG9jYXRvci5maWxlQXBwLm9wZW5GaWxlQ2hvb3Nlcihib3VuZGluZ1JlY3QsIGZpbGVUeXBlcylcblx0XHQ6IHNob3dGaWxlQ2hvb3Nlcih0cnVlLCBmaWxlVHlwZXMpXG5cdHJldHVybiBmaWxlU2VsZWN0b3Jcblx0XHQuY2F0Y2goXG5cdFx0XHRvZkNsYXNzKFBlcm1pc3Npb25FcnJvciwgKCkgPT4ge1xuXHRcdFx0XHREaWFsb2cubWVzc2FnZShcImZpbGVBY2Nlc3NEZW5pZWRNb2JpbGVfbXNnXCIpXG5cdFx0XHR9KSxcblx0XHQpXG5cdFx0LmNhdGNoKFxuXHRcdFx0b2ZDbGFzcyhGaWxlTm90Rm91bmRFcnJvciwgKCkgPT4ge1xuXHRcdFx0XHREaWFsb2cubWVzc2FnZShcImNvdWxkTm90QXR0YWNoRmlsZV9tc2dcIilcblx0XHRcdH0pLFxuXHRcdClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUF0dGFjaG1lbnRCdWJibGVBdHRycyhtb2RlbDogU2VuZE1haWxNb2RlbCwgaW5saW5lSW1hZ2VFbGVtZW50czogQXJyYXk8SFRNTEVsZW1lbnQ+KTogQXJyYXk8QXR0YWNobWVudEJ1YmJsZUF0dHJzPiB7XG5cdHJldHVybiBtb2RlbC5nZXRBdHRhY2htZW50cygpLm1hcCgoYXR0YWNobWVudCkgPT4gKHtcblx0XHRhdHRhY2htZW50LFxuXHRcdG9wZW46IG51bGwsXG5cdFx0ZG93bmxvYWQ6ICgpID0+IF9kb3dubG9hZEF0dGFjaG1lbnQoYXR0YWNobWVudCksXG5cdFx0cmVtb3ZlOiAoKSA9PiB7XG5cdFx0XHRtb2RlbC5yZW1vdmVBdHRhY2htZW50KGF0dGFjaG1lbnQpXG5cblx0XHRcdC8vIElmIGFuIGF0dGFjaG1lbnQgaGFzIGEgY2lkIGl0IG1lYW5zIGl0IGNvdWxkIGJlIGluIHRoZSBlZGl0b3IncyBpbmxpbmUgaW1hZ2VzIHRvb1xuXHRcdFx0aWYgKGF0dGFjaG1lbnQuY2lkKSB7XG5cdFx0XHRcdGNvbnN0IGltYWdlRWxlbWVudCA9IGlubGluZUltYWdlRWxlbWVudHMuZmluZCgoZSkgPT4gZS5nZXRBdHRyaWJ1dGUoXCJjaWRcIikgPT09IGF0dGFjaG1lbnQuY2lkKVxuXG5cdFx0XHRcdGlmIChpbWFnZUVsZW1lbnQpIHtcblx0XHRcdFx0XHRpbWFnZUVsZW1lbnQucmVtb3ZlKClcblx0XHRcdFx0XHRyZW1vdmUoaW5saW5lSW1hZ2VFbGVtZW50cywgaW1hZ2VFbGVtZW50KVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cblx0XHRcdG0ucmVkcmF3KClcblx0XHR9LFxuXHRcdGZpbGVJbXBvcnQ6IG51bGwsXG5cdFx0dHlwZTogQXR0YWNobWVudFR5cGUuR0VORVJJQyxcblx0fSkpXG59XG5cbmFzeW5jIGZ1bmN0aW9uIF9kb3dubG9hZEF0dGFjaG1lbnQoYXR0YWNobWVudDogQXR0YWNobWVudCkge1xuXHR0cnkge1xuXHRcdGlmIChpc0ZpbGVSZWZlcmVuY2UoYXR0YWNobWVudCkpIHtcblx0XHRcdGF3YWl0IGxvY2F0b3IuZmlsZUFwcC5vcGVuKGF0dGFjaG1lbnQpXG5cdFx0fSBlbHNlIGlmIChpc0RhdGFGaWxlKGF0dGFjaG1lbnQpKSB7XG5cdFx0XHRhd2FpdCBsb2NhdG9yLmZpbGVDb250cm9sbGVyLnNhdmVEYXRhRmlsZShhdHRhY2htZW50KVxuXHRcdH0gZWxzZSBpZiAoaXNUdXRhbm90YUZpbGUoYXR0YWNobWVudCkpIHtcblx0XHRcdGF3YWl0IGxvY2F0b3IuZmlsZUNvbnRyb2xsZXIuZG93bmxvYWQoYXR0YWNobWVudClcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhyb3cgbmV3IFByb2dyYW1taW5nRXJyb3IoXCJhdHRhY2htZW50IGlzIG5laXRoZXIgcmVmZXJlbmNlLCBkYXRhZmlsZSBub3IgdHV0YW5vdGFmaWxlIVwiKVxuXHRcdH1cblx0fSBjYXRjaCAoZSkge1xuXHRcdGlmIChlIGluc3RhbmNlb2YgRmlsZU9wZW5FcnJvcikge1xuXHRcdFx0cmV0dXJuIERpYWxvZy5tZXNzYWdlKFwiY2FuTm90T3BlbkZpbGVPbkRldmljZV9tc2dcIilcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc3QgbXNnID0gZS5tZXNzYWdlIHx8IFwidW5rbm93biBlcnJvclwiXG5cdFx0XHRjb25zb2xlLmVycm9yKFwiY291bGQgbm90IG9wZW4gZmlsZTpcIiwgbXNnKVxuXHRcdFx0cmV0dXJuIERpYWxvZy5tZXNzYWdlKFwiZXJyb3JEdXJpbmdGaWxlT3Blbl9tc2dcIilcblx0XHR9XG5cdH1cbn1cblxuZXhwb3J0IGNvbnN0IGNsZWFudXBJbmxpbmVBdHRhY2htZW50czogKGFyZzA6IEhUTUxFbGVtZW50LCBhcmcxOiBBcnJheTxIVE1MRWxlbWVudD4sIGFyZzI6IEFycmF5PEF0dGFjaG1lbnQ+KSA9PiB2b2lkID0gZGVib3VuY2UoXG5cdDUwLFxuXHQoZG9tRWxlbWVudDogSFRNTEVsZW1lbnQsIGlubGluZUltYWdlRWxlbWVudHM6IEFycmF5PEhUTUxFbGVtZW50PiwgYXR0YWNobWVudHM6IEFycmF5PEF0dGFjaG1lbnQ+KSA9PiB7XG5cdFx0Ly8gUHJldmlvdXNseSB3ZSByZXBsaWVkIG9uIHN1YnRyZWUgb3B0aW9uIG9mIE11dGF0aW9uT2JzZXJ2ZXIgdG8gcmVjZWl2ZSBpbmZvIHdoZW4gbmVzdGVkIGNoaWxkIGlzIHJlbW92ZWQuXG5cdFx0Ly8gSXQgd29ya3MgYnV0IGl0IGRvZXNuJ3Qgd29yayBpZiB0aGUgcGFyZW50IG9mIHRoZSBuZXN0ZWQgY2hpbGQgaXMgcmVtb3ZlZCwgd2Ugd291bGQgaGF2ZSB0byBnbyBvdmVyIGVhY2ggbXV0YXRpb25cblx0XHQvLyBhbmQgY2hlY2sgZWFjaCBkZXNjZW5kYW50IGFuZCBpZiBpdCdzIGFuIGltYWdlIHdpdGggQ0lEIG9yIG5vdC5cblx0XHQvLyBJdCdzIGVhc2llciBhbmQgZmFzdGVyIHRvIGp1c3QgZ28gb3ZlciBlYWNoIGlubGluZSBpbWFnZSB0aGF0IHdlIGtub3cgYWJvdXQuIEl0J3MgbW9yZSBib29ra2VlcGluZyBidXQgaXQncyBlYXNpZXJcblx0XHQvLyBjb2RlIHdoaWNoIHRvdWNoZXMgbGVzcyBkb21lLlxuXHRcdC8vXG5cdFx0Ly8gQWx0ZXJuYXRpdmUgd291bGQgYmUgb2JzZXJ2ZSB0aGUgcGFyZW50IG9mIGVhY2ggaW5saW5lIGltYWdlIGJ1dCB0aGF0J3MgbW9yZSBjb21wbGV4aXR5IGFuZCB3ZSBuZWVkIHRvIHRha2UgY2FyZSBvZlxuXHRcdC8vIG5ldyAoanVzdCBpbnNlcnRlZCkgaW5saW5lIGltYWdlcyBhbmQgYWxzbyBhc3NpZ24gbGlzdGVuZXIgdGhlcmUuXG5cdFx0Ly8gRG9pbmcgdGhpcyBjaGVjayBpbnN0ZWFkIG9mIHJlbHlpbmcgb24gbXV0YXRpb25zIGFsc28gaGVscHMgd2l0aCB0aGUgY2FzZSB3aGVuIG5vZGUgaXMgcmVtb3ZlZCBidXQgaW5zZXJ0ZWQgYWdhaW5cblx0XHQvLyBicmllZmx5LCBlLmcuIGlmIHNvbWUgdGV4dCBpcyBpbnNlcnRlZCBiZWZvcmUvYWZ0ZXIgdGhlIGVsZW1lbnQsIFNxdWlyZSB3b3VsZCBwdXQgaXQgaW50byBhbm90aGVyIGRpZmYgYW5kIHRoaXNcblx0XHQvLyBtZWFucyByZW1vdmFsICsgaW5zZXJ0aW9uLlxuXHRcdGNvbnN0IGVsZW1lbnRzVG9SZW1vdmU6IEhUTUxFbGVtZW50W10gPSBbXVxuXHRcdGZvciAoY29uc3QgaW5saW5lSW1hZ2Ugb2YgaW5saW5lSW1hZ2VFbGVtZW50cykge1xuXHRcdFx0aWYgKGRvbUVsZW1lbnQgJiYgIWRvbUVsZW1lbnQuY29udGFpbnMoaW5saW5lSW1hZ2UpKSB7XG5cdFx0XHRcdGNvbnN0IGNpZCA9IGlubGluZUltYWdlLmdldEF0dHJpYnV0ZShcImNpZFwiKVxuXHRcdFx0XHRjb25zdCBhdHRhY2htZW50SW5kZXggPSBhdHRhY2htZW50cy5maW5kSW5kZXgoKGEpID0+IGEuY2lkID09PSBjaWQpXG5cblx0XHRcdFx0aWYgKGF0dGFjaG1lbnRJbmRleCAhPT0gLTEpIHtcblx0XHRcdFx0XHRhdHRhY2htZW50cy5zcGxpY2UoYXR0YWNobWVudEluZGV4LCAxKVxuXHRcdFx0XHRcdGVsZW1lbnRzVG9SZW1vdmUucHVzaChpbmxpbmVJbWFnZSlcblx0XHRcdFx0XHRtLnJlZHJhdygpXG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cdFx0ZmluZEFsbEFuZFJlbW92ZShpbmxpbmVJbWFnZUVsZW1lbnRzLCAoaW1hZ2VFbGVtZW50KSA9PiBlbGVtZW50c1RvUmVtb3ZlLmluY2x1ZGVzKGltYWdlRWxlbWVudCkpXG5cdH0sXG4pXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDb25maWRlbnRpYWxTdGF0ZU1lc3NhZ2UoaXNDb25maWRlbnRpYWw6IGJvb2xlYW4pOiBzdHJpbmcge1xuXHRyZXR1cm4gaXNDb25maWRlbnRpYWwgPyBsYW5nLmdldChcImNvbmZpZGVudGlhbFN0YXR1c19tc2dcIikgOiBsYW5nLmdldChcIm5vbkNvbmZpZGVudGlhbFN0YXR1c19tc2dcIilcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQW1CTyxlQUFlLG9CQUNyQkEsT0FDQUMsY0FDQUMsV0FDMEQ7QUFDMUQsY0FBYSxTQUFTLEtBQUssTUFBTSxhQUFhLE9BQU87QUFDckQsY0FBYSxRQUFRLEtBQUssTUFBTSxhQUFhLE1BQU07QUFDbkQsY0FBYSxJQUFJLEtBQUssTUFBTSxhQUFhLEVBQUU7QUFDM0MsY0FBYSxJQUFJLEtBQUssTUFBTSxhQUFhLEVBQUU7QUFDM0MsS0FBSTtFQUNILE1BQU0sUUFBUSxNQUFNLDhCQUE4QixjQUFjLFVBQVU7QUFDMUUsT0FBSyxTQUFTLE1BQU0sV0FBVyxFQUFHO0FBQ2xDLFVBQVEsSUFBSSxNQUFaO0FBQ0MsUUFBSyxLQUFLO0FBRVQsVUFBTSxZQUFZLE1BQU07QUFDeEIsV0FBTztBQUNSLFFBQUssS0FBSyxTQUFTO0lBRWxCLE1BQU1DLFlBQTZCLENBQ2xDLE1BQU0sUUFBUSxJQUFJLEFBQUMsTUFBK0IsSUFBSSxPQUFPLE1BQU0sUUFBUSxRQUFRLGFBQWEsRUFBRSxTQUFTLENBQUMsQ0FBQyxFQUM1RyxPQUFPLFVBQVU7QUFDbkIsVUFBTSxZQUFZLFVBQVU7QUFDNUIsV0FBTztHQUNQO0FBQ0Q7QUFFQyxVQUFNLFlBQVksTUFBTTtBQUN4QixXQUFPO0VBQ1I7Q0FDRCxTQUFRLEdBQUc7QUFDWCxNQUFJLGFBQWEsVUFDaEIsT0FBTSxjQUFjLEVBQUU7S0FDaEI7R0FDTixNQUFNLE1BQU0sRUFBRSxXQUFXO0FBQ3pCLFdBQVEsTUFBTSwyQkFBMkIsSUFBSTtFQUM3QztDQUNEO0FBQ0Q7QUFFTSxTQUFTLDhCQUE4QkYsY0FBMEJDLFdBQW9GO0NBQzNKLE1BQU0sZUFBZSxDQUFDLEtBQUssS0FBSyxLQUFLLE9BQVEsRUFBQyxTQUFTLElBQUksS0FBSyxHQUM3RCxRQUFRLFFBQVEsZ0JBQWdCLGNBQWMsVUFBVSxHQUN4RCxnQkFBZ0IsTUFBTSxVQUFVO0FBQ25DLFFBQU8sYUFDTCxNQUNBLFFBQVEsaUJBQWlCLE1BQU07QUFDOUIsU0FBTyxRQUFRLDZCQUE2QjtDQUM1QyxFQUFDLENBQ0YsQ0FDQSxNQUNBLFFBQVEsbUJBQW1CLE1BQU07QUFDaEMsU0FBTyxRQUFRLHlCQUF5QjtDQUN4QyxFQUFDLENBQ0Y7QUFDRjtBQUVNLFNBQVMsNEJBQTRCRixPQUFzQkkscUJBQXVFO0FBQ3hJLFFBQU8sTUFBTSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCO0VBQ2xEO0VBQ0EsTUFBTTtFQUNOLFVBQVUsTUFBTSxvQkFBb0IsV0FBVztFQUMvQyxRQUFRLE1BQU07QUFDYixTQUFNLGlCQUFpQixXQUFXO0FBR2xDLE9BQUksV0FBVyxLQUFLO0lBQ25CLE1BQU0sZUFBZSxvQkFBb0IsS0FBSyxDQUFDLE1BQU0sRUFBRSxhQUFhLE1BQU0sS0FBSyxXQUFXLElBQUk7QUFFOUYsUUFBSSxjQUFjO0FBQ2pCLGtCQUFhLFFBQVE7QUFDckIsWUFBTyxxQkFBcUIsYUFBYTtJQUN6QztHQUNEO0FBRUQsbUJBQUUsUUFBUTtFQUNWO0VBQ0QsWUFBWTtFQUNaLE1BQU0sZUFBZTtDQUNyQixHQUFFO0FBQ0g7QUFFRCxlQUFlLG9CQUFvQkMsWUFBd0I7QUFDMUQsS0FBSTtBQUNILE1BQUksZ0JBQWdCLFdBQVcsQ0FDOUIsT0FBTSxRQUFRLFFBQVEsS0FBSyxXQUFXO1NBQzVCLFdBQVcsV0FBVyxDQUNoQyxPQUFNLFFBQVEsZUFBZSxhQUFhLFdBQVc7U0FDM0MsZUFBZSxXQUFXLENBQ3BDLE9BQU0sUUFBUSxlQUFlLFNBQVMsV0FBVztJQUVqRCxPQUFNLElBQUksaUJBQWlCO0NBRTVCLFNBQVEsR0FBRztBQUNYLE1BQUksYUFBYSxjQUNoQixRQUFPLE9BQU8sUUFBUSw2QkFBNkI7S0FDN0M7R0FDTixNQUFNLE1BQU0sRUFBRSxXQUFXO0FBQ3pCLFdBQVEsTUFBTSx3QkFBd0IsSUFBSTtBQUMxQyxVQUFPLE9BQU8sUUFBUSwwQkFBMEI7RUFDaEQ7Q0FDRDtBQUNEO01BRVlDLDJCQUEyRyxTQUN2SCxJQUNBLENBQUNDLFlBQXlCSCxxQkFBeUNJLGdCQUFtQztDQVlyRyxNQUFNQyxtQkFBa0MsQ0FBRTtBQUMxQyxNQUFLLE1BQU0sZUFBZSxvQkFDekIsS0FBSSxlQUFlLFdBQVcsU0FBUyxZQUFZLEVBQUU7RUFDcEQsTUFBTSxNQUFNLFlBQVksYUFBYSxNQUFNO0VBQzNDLE1BQU0sa0JBQWtCLFlBQVksVUFBVSxDQUFDLE1BQU0sRUFBRSxRQUFRLElBQUk7QUFFbkUsTUFBSSxvQkFBb0IsSUFBSTtBQUMzQixlQUFZLE9BQU8saUJBQWlCLEVBQUU7QUFDdEMsb0JBQWlCLEtBQUssWUFBWTtBQUNsQyxtQkFBRSxRQUFRO0VBQ1Y7Q0FDRDtBQUVGLGtCQUFpQixxQkFBcUIsQ0FBQyxpQkFBaUIsaUJBQWlCLFNBQVMsYUFBYSxDQUFDO0FBQ2hHLEVBQ0Q7QUFFTSxTQUFTLDRCQUE0QkMsZ0JBQWlDO0FBQzVFLFFBQU8saUJBQWlCLEtBQUssSUFBSSx5QkFBeUIsR0FBRyxLQUFLLElBQUksNEJBQTRCO0FBQ2xHIn0=