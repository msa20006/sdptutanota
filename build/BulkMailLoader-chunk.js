import "./dist-chunk.js";
import "./ProgrammingError-chunk.js";
import "./Env-chunk.js";
import "./ClientDetector-chunk.js";
import { assertNotNull, groupBy, groupByAndMap, neverNull, pMap, splitInChunks } from "./dist2-chunk.js";
import "./TutanotaConstants-chunk.js";
import { elementIdPart, isSameId, listIdPart, timestampToGeneratedId } from "./EntityUtils-chunk.js";
import "./TypeModels-chunk.js";
import { FileTypeRef, MailDetailsBlobTypeRef, MailDetailsDraftTypeRef, MailTypeRef } from "./TypeRefs-chunk.js";
import "./TypeModels2-chunk.js";
import "./TypeRefs2-chunk.js";
import "./ParserCombinator-chunk.js";
import "./ErrorHandler-chunk.js";
import "./EntityFunctions-chunk.js";
import "./TypeModels3-chunk.js";
import "./ModelInfo-chunk.js";
import "./ErrorUtils-chunk.js";
import "./RestError-chunk.js";
import "./SetupMultipleError-chunk.js";
import "./OutOfSyncError-chunk.js";
import "./CancelledError-chunk.js";
import "./EventQueue-chunk.js";
import { CacheMode } from "./EntityRestClient-chunk.js";
import "./SuspensionError-chunk.js";
import "./LoginIncompleteError-chunk.js";
import "./CryptoError-chunk.js";
import "./RecipientsNotFoundError-chunk.js";
import "./DbError-chunk.js";
import "./QuotaExceededError-chunk.js";
import "./DeviceStorageUnavailableError-chunk.js";
import "./MailBodyTooLargeError-chunk.js";
import "./ImportError-chunk.js";
import "./WebauthnError-chunk.js";
import "./PermissionError-chunk.js";
import "./MessageDispatcher-chunk.js";
import "./WorkerProxy-chunk.js";
import "./EntityUpdateUtils-chunk.js";
import { isDraft } from "./MailChecks-chunk.js";

//#region src/mail-app/workerUtils/index/BulkMailLoader.ts
const ENTITY_INDEXER_CHUNK = 20;
const MAIL_INDEXER_CHUNK = 100;
var BulkMailLoader = class {
	constructor(mailEntityClient, mailDataEntityClient, cachedStorage) {
		this.mailEntityClient = mailEntityClient;
		this.mailDataEntityClient = mailDataEntityClient;
		this.cachedStorage = cachedStorage;
	}
	loadMailsInRangeWithCache(mailListId, [rangeStart, rangeEnd]) {
		return this.mailEntityClient.loadReverseRangeBetween(MailTypeRef, mailListId, timestampToGeneratedId(rangeStart), timestampToGeneratedId(rangeEnd), MAIL_INDEXER_CHUNK);
	}
	loadFixedNumberOfMailsWithCache(mailLIstId, startId, options = {}) {
		return this.mailEntityClient.loadRange(MailTypeRef, mailLIstId, startId, MAIL_INDEXER_CHUNK, true, {
			...options,
			cacheMode: CacheMode.ReadOnly
		});
	}
	async removeFromCache(id) {
		return this.cachedStorage?.deleteIfExists(MailTypeRef, listIdPart(id), elementIdPart(id));
	}
	async loadMailDetails(mails, options = {}) {
		const result = [];
		let mailDetailsBlobMails = mails.filter((m) => !isDraft(m));
		const listIdToMailDetailsBlobIds = groupByAndMap(mailDetailsBlobMails, (m) => assertNotNull(m.mailDetails)[0], (m) => neverNull(m.mailDetails)[1]);
		for (let [listId, ids] of listIdToMailDetailsBlobIds) {
			const ownerEncSessionKeyProvider = async (instanceElementId) => {
				const mail = assertNotNull(mailDetailsBlobMails.find((m) => elementIdPart(assertNotNull(m.mailDetails)) === instanceElementId));
				return {
					key: assertNotNull(mail._ownerEncSessionKey),
					encryptingKeyVersion: Number(mail._ownerKeyVersion ?? 0)
				};
			};
			const mailDetailsBlobs = await this.loadInChunks(MailDetailsBlobTypeRef, listId, ids, ownerEncSessionKeyProvider, options);
			result.push(...mailDetailsBlobs.map((mailDetailsBlob) => {
				const mail = assertNotNull(mailDetailsBlobMails.find((m) => isSameId(m.mailDetails, mailDetailsBlob._id)));
				return {
					mail,
					mailDetails: mailDetailsBlob.details
				};
			}));
		}
		let mailDetailsDraftMails = mails.filter((m) => isDraft(m));
		const listIdToMailDetailsDraftIds = groupByAndMap(mailDetailsDraftMails, (m) => assertNotNull(m.mailDetailsDraft)[0], (m) => neverNull(m.mailDetailsDraft)[1]);
		for (let [listId, ids] of listIdToMailDetailsDraftIds) {
			const ownerEncSessionKeyProvider = async (instanceElementId) => {
				const mail = assertNotNull(mailDetailsDraftMails.find((m) => elementIdPart(assertNotNull(m.mailDetailsDraft)) === instanceElementId));
				return {
					key: assertNotNull(mail._ownerEncSessionKey),
					encryptingKeyVersion: Number(mail._ownerKeyVersion ?? 0)
				};
			};
			const mailDetailsDrafts = await this.loadInChunks(MailDetailsDraftTypeRef, listId, ids, ownerEncSessionKeyProvider, options);
			result.push(...mailDetailsDrafts.map((draftDetails) => {
				const mail = assertNotNull(mailDetailsDraftMails.find((m) => isSameId(m.mailDetailsDraft, draftDetails._id)));
				return {
					mail,
					mailDetails: draftDetails.details
				};
			}));
		}
		return result;
	}
	async loadAttachments(mails, options = {}) {
		const attachmentIds = [];
		for (const mail of mails) attachmentIds.push(...mail.attachments);
		const filesByList = groupBy(attachmentIds, (a) => a[0]);
		const fileLoadingPromises = [];
		for (const [listId, fileIds] of filesByList.entries()) fileLoadingPromises.push(this.loadInChunks(FileTypeRef, listId, fileIds.map((f) => f[1]), undefined, options));
		const filesResults = await Promise.all(fileLoadingPromises);
		return filesResults.flat();
	}
	async loadInChunks(typeRef, listId, ids, ownerEncSessionKeyProvider, options = {}) {
		const byChunk = splitInChunks(ENTITY_INDEXER_CHUNK, ids);
		const entityResults = await pMap(byChunk, (chunk) => {
			return chunk.length > 0 ? this.mailDataEntityClient.loadMultiple(typeRef, listId, chunk, ownerEncSessionKeyProvider, {
				...options,
				cacheMode: CacheMode.ReadOnly
			}) : Promise.resolve([]);
		}, { concurrency: 2 });
		return entityResults.flat();
	}
};

//#endregion
export { BulkMailLoader };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnVsa01haWxMb2FkZXItY2h1bmsuanMiLCJuYW1lcyI6WyJtYWlsRW50aXR5Q2xpZW50OiBFbnRpdHlDbGllbnQiLCJtYWlsRGF0YUVudGl0eUNsaWVudDogRW50aXR5Q2xpZW50IiwiY2FjaGVkU3RvcmFnZTogRXhwb3NlZENhY2hlU3RvcmFnZSB8IG51bGwiLCJtYWlsTGlzdElkOiBJZCIsIm1haWxMSXN0SWQ6IElkIiwic3RhcnRJZDogSWQiLCJvcHRpb25zOiBFbnRpdHlSZXN0Q2xpZW50TG9hZE9wdGlvbnMiLCJpZDogSWRUdXBsZSIsIm1haWxzOiByZWFkb25seSBNYWlsW10iLCJyZXN1bHQ6IEFycmF5PE1haWxXaXRoTWFpbERldGFpbHM+IiwibGlzdElkVG9NYWlsRGV0YWlsc0Jsb2JJZHM6IE1hcDxJZCwgQXJyYXk8SWQ+PiIsIm93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyOiBPd25lckVuY1Nlc3Npb25LZXlQcm92aWRlciIsImluc3RhbmNlRWxlbWVudElkOiBJZCIsImxpc3RJZFRvTWFpbERldGFpbHNEcmFmdElkczogTWFwPElkLCBBcnJheTxJZD4+IiwiYXR0YWNobWVudElkczogSWRUdXBsZVtdIiwiZmlsZUxvYWRpbmdQcm9taXNlczogQXJyYXk8UHJvbWlzZTxBcnJheTxUdXRhbm90YUZpbGU+Pj4iLCJ0eXBlUmVmOiBUeXBlUmVmPFQ+IiwibGlzdElkOiBJZCB8IG51bGwiLCJpZHM6IElkW10iLCJvd25lckVuY1Nlc3Npb25LZXlQcm92aWRlcj86IE93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyIl0sInNvdXJjZXMiOlsiLi4vc3JjL21haWwtYXBwL3dvcmtlclV0aWxzL2luZGV4L0J1bGtNYWlsTG9hZGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydE5vdE51bGwsIGdyb3VwQnksIGdyb3VwQnlBbmRNYXAsIG5ldmVyTnVsbCwgcHJvbWlzZU1hcCwgc3BsaXRJbkNodW5rcywgVHlwZVJlZiB9IGZyb20gXCJAdHV0YW8vdHV0YW5vdGEtdXRpbHNcIlxuaW1wb3J0IHsgRW50aXR5Q2xpZW50IH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9hcGkvY29tbW9uL0VudGl0eUNsaWVudC5qc1wiXG5pbXBvcnQgeyBFeHBvc2VkQ2FjaGVTdG9yYWdlIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9hcGkvd29ya2VyL3Jlc3QvRGVmYXVsdEVudGl0eVJlc3RDYWNoZS5qc1wiXG5pbXBvcnQgeyBlbGVtZW50SWRQYXJ0LCBpc1NhbWVJZCwgbGlzdElkUGFydCwgdGltZXN0YW1wVG9HZW5lcmF0ZWRJZCB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vYXBpL2NvbW1vbi91dGlscy9FbnRpdHlVdGlscy5qc1wiXG5pbXBvcnQgeyBDYWNoZU1vZGUsIEVudGl0eVJlc3RDbGllbnRMb2FkT3B0aW9ucywgT3duZXJFbmNTZXNzaW9uS2V5UHJvdmlkZXIgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL2FwaS93b3JrZXIvcmVzdC9FbnRpdHlSZXN0Q2xpZW50LmpzXCJcbmltcG9ydCB7IGlzRHJhZnQgfSBmcm9tIFwiLi4vLi4vbWFpbC9tb2RlbC9NYWlsQ2hlY2tzLmpzXCJcbmltcG9ydCB7XG5cdE1haWwsXG5cdEZpbGUgYXMgVHV0YW5vdGFGaWxlLFxuXHRNYWlsRGV0YWlscyxcblx0TWFpbFR5cGVSZWYsXG5cdE1haWxEZXRhaWxzQmxvYlR5cGVSZWYsXG5cdE1haWxEZXRhaWxzRHJhZnRUeXBlUmVmLFxuXHRGaWxlVHlwZVJlZixcbn0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9hcGkvZW50aXRpZXMvdHV0YW5vdGEvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHsgU29tZUVudGl0eSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vYXBpL2NvbW1vbi9FbnRpdHlUeXBlcy5qc1wiXG5cbmV4cG9ydCBjb25zdCBFTlRJVFlfSU5ERVhFUl9DSFVOSyA9IDIwXG5leHBvcnQgY29uc3QgTUFJTF9JTkRFWEVSX0NIVU5LID0gMTAwXG5cbmV4cG9ydCB0eXBlIFRpbWVSYW5nZSA9IFtudW1iZXIsIG51bWJlcl1cblxuZXhwb3J0IGludGVyZmFjZSBNYWlsV2l0aE1haWxEZXRhaWxzIHtcblx0bWFpbDogTWFpbFxuXHRtYWlsRGV0YWlsczogTWFpbERldGFpbHNcbn1cblxuZXhwb3J0IGNsYXNzIEJ1bGtNYWlsTG9hZGVyIHtcblx0Y29uc3RydWN0b3IoXG5cdFx0cHJpdmF0ZSByZWFkb25seSBtYWlsRW50aXR5Q2xpZW50OiBFbnRpdHlDbGllbnQsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBtYWlsRGF0YUVudGl0eUNsaWVudDogRW50aXR5Q2xpZW50LFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgY2FjaGVkU3RvcmFnZTogRXhwb3NlZENhY2hlU3RvcmFnZSB8IG51bGwsXG5cdCkge31cblxuXHRsb2FkTWFpbHNJblJhbmdlV2l0aENhY2hlKFxuXHRcdG1haWxMaXN0SWQ6IElkLFxuXHRcdFtyYW5nZVN0YXJ0LCByYW5nZUVuZF06IFRpbWVSYW5nZSxcblx0KTogUHJvbWlzZTx7XG5cdFx0ZWxlbWVudHM6IEFycmF5PE1haWw+XG5cdFx0bG9hZGVkQ29tcGxldGVseTogYm9vbGVhblxuXHR9PiB7XG5cdFx0cmV0dXJuIHRoaXMubWFpbEVudGl0eUNsaWVudC5sb2FkUmV2ZXJzZVJhbmdlQmV0d2Vlbihcblx0XHRcdE1haWxUeXBlUmVmLFxuXHRcdFx0bWFpbExpc3RJZCxcblx0XHRcdHRpbWVzdGFtcFRvR2VuZXJhdGVkSWQocmFuZ2VTdGFydCksXG5cdFx0XHR0aW1lc3RhbXBUb0dlbmVyYXRlZElkKHJhbmdlRW5kKSxcblx0XHRcdE1BSUxfSU5ERVhFUl9DSFVOSyxcblx0XHQpXG5cdH1cblxuXHRsb2FkRml4ZWROdW1iZXJPZk1haWxzV2l0aENhY2hlKG1haWxMSXN0SWQ6IElkLCBzdGFydElkOiBJZCwgb3B0aW9uczogRW50aXR5UmVzdENsaWVudExvYWRPcHRpb25zID0ge30pOiBQcm9taXNlPE1haWxbXT4ge1xuXHRcdHJldHVybiB0aGlzLm1haWxFbnRpdHlDbGllbnQubG9hZFJhbmdlKE1haWxUeXBlUmVmLCBtYWlsTElzdElkLCBzdGFydElkLCBNQUlMX0lOREVYRVJfQ0hVTkssIHRydWUsIHsgLi4ub3B0aW9ucywgY2FjaGVNb2RlOiBDYWNoZU1vZGUuUmVhZE9ubHkgfSlcblx0fVxuXG5cdGFzeW5jIHJlbW92ZUZyb21DYWNoZShpZDogSWRUdXBsZSk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHJldHVybiB0aGlzLmNhY2hlZFN0b3JhZ2U/LmRlbGV0ZUlmRXhpc3RzKE1haWxUeXBlUmVmLCBsaXN0SWRQYXJ0KGlkKSwgZWxlbWVudElkUGFydChpZCkpXG5cdH1cblxuXHRhc3luYyBsb2FkTWFpbERldGFpbHMobWFpbHM6IHJlYWRvbmx5IE1haWxbXSwgb3B0aW9uczogRW50aXR5UmVzdENsaWVudExvYWRPcHRpb25zID0ge30pOiBQcm9taXNlPE1haWxXaXRoTWFpbERldGFpbHNbXT4ge1xuXHRcdGNvbnN0IHJlc3VsdDogQXJyYXk8TWFpbFdpdGhNYWlsRGV0YWlscz4gPSBbXVxuXHRcdC8vIG1haWxEZXRhaWxzIHN0b3JlZCBhcyBibG9iXG5cdFx0bGV0IG1haWxEZXRhaWxzQmxvYk1haWxzID0gbWFpbHMuZmlsdGVyKChtKSA9PiAhaXNEcmFmdChtKSlcblx0XHRjb25zdCBsaXN0SWRUb01haWxEZXRhaWxzQmxvYklkczogTWFwPElkLCBBcnJheTxJZD4+ID0gZ3JvdXBCeUFuZE1hcChcblx0XHRcdG1haWxEZXRhaWxzQmxvYk1haWxzLFxuXHRcdFx0KG0pID0+IGFzc2VydE5vdE51bGwobS5tYWlsRGV0YWlscylbMF0sXG5cdFx0XHQobSkgPT4gbmV2ZXJOdWxsKG0ubWFpbERldGFpbHMpWzFdLFxuXHRcdClcblx0XHRmb3IgKGxldCBbbGlzdElkLCBpZHNdIG9mIGxpc3RJZFRvTWFpbERldGFpbHNCbG9iSWRzKSB7XG5cdFx0XHRjb25zdCBvd25lckVuY1Nlc3Npb25LZXlQcm92aWRlcjogT3duZXJFbmNTZXNzaW9uS2V5UHJvdmlkZXIgPSBhc3luYyAoaW5zdGFuY2VFbGVtZW50SWQ6IElkKSA9PiB7XG5cdFx0XHRcdGNvbnN0IG1haWwgPSBhc3NlcnROb3ROdWxsKG1haWxEZXRhaWxzQmxvYk1haWxzLmZpbmQoKG0pID0+IGVsZW1lbnRJZFBhcnQoYXNzZXJ0Tm90TnVsbChtLm1haWxEZXRhaWxzKSkgPT09IGluc3RhbmNlRWxlbWVudElkKSlcblx0XHRcdFx0cmV0dXJuIHtcblx0XHRcdFx0XHRrZXk6IGFzc2VydE5vdE51bGwobWFpbC5fb3duZXJFbmNTZXNzaW9uS2V5KSxcblx0XHRcdFx0XHRlbmNyeXB0aW5nS2V5VmVyc2lvbjogTnVtYmVyKG1haWwuX293bmVyS2V5VmVyc2lvbiA/PyAwKSxcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdFx0Y29uc3QgbWFpbERldGFpbHNCbG9icyA9IGF3YWl0IHRoaXMubG9hZEluQ2h1bmtzKE1haWxEZXRhaWxzQmxvYlR5cGVSZWYsIGxpc3RJZCwgaWRzLCBvd25lckVuY1Nlc3Npb25LZXlQcm92aWRlciwgb3B0aW9ucylcblx0XHRcdHJlc3VsdC5wdXNoKFxuXHRcdFx0XHQuLi5tYWlsRGV0YWlsc0Jsb2JzLm1hcCgobWFpbERldGFpbHNCbG9iKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgbWFpbCA9IGFzc2VydE5vdE51bGwobWFpbERldGFpbHNCbG9iTWFpbHMuZmluZCgobSkgPT4gaXNTYW1lSWQobS5tYWlsRGV0YWlscywgbWFpbERldGFpbHNCbG9iLl9pZCkpKVxuXHRcdFx0XHRcdHJldHVybiB7IG1haWwsIG1haWxEZXRhaWxzOiBtYWlsRGV0YWlsc0Jsb2IuZGV0YWlscyB9XG5cdFx0XHRcdH0pLFxuXHRcdFx0KVxuXHRcdH1cblx0XHQvLyBtYWlsRGV0YWlscyBzdG9yZWQgaW4gZGIgKGRyYWZ0KVxuXHRcdGxldCBtYWlsRGV0YWlsc0RyYWZ0TWFpbHMgPSBtYWlscy5maWx0ZXIoKG0pID0+IGlzRHJhZnQobSkpXG5cdFx0Y29uc3QgbGlzdElkVG9NYWlsRGV0YWlsc0RyYWZ0SWRzOiBNYXA8SWQsIEFycmF5PElkPj4gPSBncm91cEJ5QW5kTWFwKFxuXHRcdFx0bWFpbERldGFpbHNEcmFmdE1haWxzLFxuXHRcdFx0KG0pID0+IGFzc2VydE5vdE51bGwobS5tYWlsRGV0YWlsc0RyYWZ0KVswXSxcblx0XHRcdChtKSA9PiBuZXZlck51bGwobS5tYWlsRGV0YWlsc0RyYWZ0KVsxXSxcblx0XHQpXG5cdFx0Zm9yIChsZXQgW2xpc3RJZCwgaWRzXSBvZiBsaXN0SWRUb01haWxEZXRhaWxzRHJhZnRJZHMpIHtcblx0XHRcdGNvbnN0IG93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyOiBPd25lckVuY1Nlc3Npb25LZXlQcm92aWRlciA9IGFzeW5jIChpbnN0YW5jZUVsZW1lbnRJZDogSWQpID0+IHtcblx0XHRcdFx0Y29uc3QgbWFpbCA9IGFzc2VydE5vdE51bGwobWFpbERldGFpbHNEcmFmdE1haWxzLmZpbmQoKG0pID0+IGVsZW1lbnRJZFBhcnQoYXNzZXJ0Tm90TnVsbChtLm1haWxEZXRhaWxzRHJhZnQpKSA9PT0gaW5zdGFuY2VFbGVtZW50SWQpKVxuXHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdGtleTogYXNzZXJ0Tm90TnVsbChtYWlsLl9vd25lckVuY1Nlc3Npb25LZXkpLFxuXHRcdFx0XHRcdGVuY3J5cHRpbmdLZXlWZXJzaW9uOiBOdW1iZXIobWFpbC5fb3duZXJLZXlWZXJzaW9uID8/IDApLFxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRjb25zdCBtYWlsRGV0YWlsc0RyYWZ0cyA9IGF3YWl0IHRoaXMubG9hZEluQ2h1bmtzKE1haWxEZXRhaWxzRHJhZnRUeXBlUmVmLCBsaXN0SWQsIGlkcywgb3duZXJFbmNTZXNzaW9uS2V5UHJvdmlkZXIsIG9wdGlvbnMpXG5cdFx0XHRyZXN1bHQucHVzaChcblx0XHRcdFx0Li4ubWFpbERldGFpbHNEcmFmdHMubWFwKChkcmFmdERldGFpbHMpID0+IHtcblx0XHRcdFx0XHRjb25zdCBtYWlsID0gYXNzZXJ0Tm90TnVsbChtYWlsRGV0YWlsc0RyYWZ0TWFpbHMuZmluZCgobSkgPT4gaXNTYW1lSWQobS5tYWlsRGV0YWlsc0RyYWZ0LCBkcmFmdERldGFpbHMuX2lkKSkpXG5cdFx0XHRcdFx0cmV0dXJuIHsgbWFpbCwgbWFpbERldGFpbHM6IGRyYWZ0RGV0YWlscy5kZXRhaWxzIH1cblx0XHRcdFx0fSksXG5cdFx0XHQpXG5cdFx0fVxuXHRcdHJldHVybiByZXN1bHRcblx0fVxuXG5cdGFzeW5jIGxvYWRBdHRhY2htZW50cyhtYWlsczogcmVhZG9ubHkgTWFpbFtdLCBvcHRpb25zOiBFbnRpdHlSZXN0Q2xpZW50TG9hZE9wdGlvbnMgPSB7fSk6IFByb21pc2U8VHV0YW5vdGFGaWxlW10+IHtcblx0XHRjb25zdCBhdHRhY2htZW50SWRzOiBJZFR1cGxlW10gPSBbXVxuXHRcdGZvciAoY29uc3QgbWFpbCBvZiBtYWlscykge1xuXHRcdFx0YXR0YWNobWVudElkcy5wdXNoKC4uLm1haWwuYXR0YWNobWVudHMpXG5cdFx0fVxuXHRcdGNvbnN0IGZpbGVzQnlMaXN0ID0gZ3JvdXBCeShhdHRhY2htZW50SWRzLCAoYSkgPT4gYVswXSlcblx0XHRjb25zdCBmaWxlTG9hZGluZ1Byb21pc2VzOiBBcnJheTxQcm9taXNlPEFycmF5PFR1dGFub3RhRmlsZT4+PiA9IFtdXG5cdFx0Zm9yIChjb25zdCBbbGlzdElkLCBmaWxlSWRzXSBvZiBmaWxlc0J5TGlzdC5lbnRyaWVzKCkpIHtcblx0XHRcdGZpbGVMb2FkaW5nUHJvbWlzZXMucHVzaChcblx0XHRcdFx0dGhpcy5sb2FkSW5DaHVua3MoXG5cdFx0XHRcdFx0RmlsZVR5cGVSZWYsXG5cdFx0XHRcdFx0bGlzdElkLFxuXHRcdFx0XHRcdGZpbGVJZHMubWFwKChmKSA9PiBmWzFdKSxcblx0XHRcdFx0XHR1bmRlZmluZWQsXG5cdFx0XHRcdFx0b3B0aW9ucyxcblx0XHRcdFx0KSxcblx0XHRcdClcblx0XHR9XG5cdFx0Y29uc3QgZmlsZXNSZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwoZmlsZUxvYWRpbmdQcm9taXNlcylcblx0XHRyZXR1cm4gZmlsZXNSZXN1bHRzLmZsYXQoKVxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBsb2FkSW5DaHVua3M8VCBleHRlbmRzIFNvbWVFbnRpdHk+KFxuXHRcdHR5cGVSZWY6IFR5cGVSZWY8VD4sXG5cdFx0bGlzdElkOiBJZCB8IG51bGwsXG5cdFx0aWRzOiBJZFtdLFxuXHRcdG93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyPzogT3duZXJFbmNTZXNzaW9uS2V5UHJvdmlkZXIsXG5cdFx0b3B0aW9uczogRW50aXR5UmVzdENsaWVudExvYWRPcHRpb25zID0ge30sXG5cdCk6IFByb21pc2U8VFtdPiB7XG5cdFx0Y29uc3QgYnlDaHVuayA9IHNwbGl0SW5DaHVua3MoRU5USVRZX0lOREVYRVJfQ0hVTkssIGlkcylcblx0XHRjb25zdCBlbnRpdHlSZXN1bHRzID0gYXdhaXQgcHJvbWlzZU1hcChcblx0XHRcdGJ5Q2h1bmssXG5cdFx0XHQoY2h1bmspID0+IHtcblx0XHRcdFx0cmV0dXJuIGNodW5rLmxlbmd0aCA+IDBcblx0XHRcdFx0XHQ/IHRoaXMubWFpbERhdGFFbnRpdHlDbGllbnQubG9hZE11bHRpcGxlKHR5cGVSZWYsIGxpc3RJZCwgY2h1bmssIG93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyLCB7IC4uLm9wdGlvbnMsIGNhY2hlTW9kZTogQ2FjaGVNb2RlLlJlYWRPbmx5IH0pXG5cdFx0XHRcdFx0OiBQcm9taXNlLnJlc29sdmUoW10pXG5cdFx0XHR9LFxuXHRcdFx0e1xuXHRcdFx0XHRjb25jdXJyZW5jeTogMixcblx0XHRcdH0sXG5cdFx0KVxuXHRcdHJldHVybiBlbnRpdHlSZXN1bHRzLmZsYXQoKVxuXHR9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7TUFpQmEsdUJBQXVCO01BQ3ZCLHFCQUFxQjtJQVNyQixpQkFBTixNQUFxQjtDQUMzQixZQUNrQkEsa0JBQ0FDLHNCQUNBQyxlQUNoQjtF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