import "./dist-chunk.js";
import "./ProgrammingError-chunk.js";
import "./Env-chunk.js";
import "./ClientDetector-chunk.js";
import { assertNotNull, groupBy, groupByAndMap, neverNull, pMap, splitInChunks } from "./dist2-chunk.js";
import "./TutanotaConstants-chunk.js";
import { elementIdPart, isSameId, listIdPart, timestampToGeneratedId } from "./EntityUtils-chunk.js";
import "./TypeModels-chunk.js";
import { FileTypeRef, MailDetailsBlobTypeRef, MailDetailsDraftTypeRef, MailTypeRef } from "./TypeRefs-chunk.js";
import "./TypeModels2-chunk.js";
import "./TypeRefs2-chunk.js";
import "./ParserCombinator-chunk.js";
import "./ErrorHandler-chunk.js";
import "./EntityFunctions-chunk.js";
import "./TypeModels3-chunk.js";
import "./ModelInfo-chunk.js";
import "./ErrorUtils-chunk.js";
import "./RestError-chunk.js";
import "./SetupMultipleError-chunk.js";
import "./OutOfSyncError-chunk.js";
import "./CancelledError-chunk.js";
import "./EventQueue-chunk.js";
import { CacheMode } from "./EntityRestClient-chunk.js";
import "./SuspensionError-chunk.js";
import "./LoginIncompleteError-chunk.js";
import "./CryptoError-chunk.js";
import "./error-chunk.js";
import "./RecipientsNotFoundError-chunk.js";
import "./DbError-chunk.js";
import "./QuotaExceededError-chunk.js";
import "./DeviceStorageUnavailableError-chunk.js";
import "./MailBodyTooLargeError-chunk.js";
import "./ImportError-chunk.js";
import "./WebauthnError-chunk.js";
import "./PermissionError-chunk.js";
import "./MessageDispatcher-chunk.js";
import "./WorkerProxy-chunk.js";
import "./EntityUpdateUtils-chunk.js";
import "./dist3-chunk.js";
import { parseKeyVersion } from "./KeyLoaderFacade-chunk.js";
import { isDraft } from "./MailChecks-chunk.js";

//#region src/mail-app/workerUtils/index/BulkMailLoader.ts
const ENTITY_INDEXER_CHUNK = 20;
const MAIL_INDEXER_CHUNK = 100;
var BulkMailLoader = class {
	constructor(mailEntityClient, mailDataEntityClient, cachedStorage) {
		this.mailEntityClient = mailEntityClient;
		this.mailDataEntityClient = mailDataEntityClient;
		this.cachedStorage = cachedStorage;
	}
	loadMailsInRangeWithCache(mailListId, [rangeStart, rangeEnd]) {
		return this.mailEntityClient.loadReverseRangeBetween(MailTypeRef, mailListId, timestampToGeneratedId(rangeStart), timestampToGeneratedId(rangeEnd), MAIL_INDEXER_CHUNK);
	}
	loadFixedNumberOfMailsWithCache(mailLIstId, startId, options = {}) {
		return this.mailEntityClient.loadRange(MailTypeRef, mailLIstId, startId, MAIL_INDEXER_CHUNK, true, {
			...options,
			cacheMode: CacheMode.ReadOnly
		});
	}
	async removeFromCache(id) {
		return this.cachedStorage?.deleteIfExists(MailTypeRef, listIdPart(id), elementIdPart(id));
	}
	async loadMailDetails(mails, options = {}) {
		const result = [];
		let mailDetailsBlobMails = mails.filter((m) => !isDraft(m));
		const listIdToMailDetailsBlobIds = groupByAndMap(mailDetailsBlobMails, (m) => assertNotNull(m.mailDetails)[0], (m) => neverNull(m.mailDetails)[1]);
		for (let [listId, ids] of listIdToMailDetailsBlobIds) {
			const ownerEncSessionKeyProvider = async (instanceElementId) => {
				const mail = assertNotNull(mailDetailsBlobMails.find((m) => elementIdPart(assertNotNull(m.mailDetails)) === instanceElementId));
				return {
					key: assertNotNull(mail._ownerEncSessionKey),
					encryptingKeyVersion: parseKeyVersion(mail._ownerKeyVersion ?? "0")
				};
			};
			const mailDetailsBlobs = await this.loadInChunks(MailDetailsBlobTypeRef, listId, ids, ownerEncSessionKeyProvider, options);
			result.push(...mailDetailsBlobs.map((mailDetailsBlob) => {
				const mail = assertNotNull(mailDetailsBlobMails.find((m) => isSameId(m.mailDetails, mailDetailsBlob._id)));
				return {
					mail,
					mailDetails: mailDetailsBlob.details
				};
			}));
		}
		let mailDetailsDraftMails = mails.filter((m) => isDraft(m));
		const listIdToMailDetailsDraftIds = groupByAndMap(mailDetailsDraftMails, (m) => assertNotNull(m.mailDetailsDraft)[0], (m) => neverNull(m.mailDetailsDraft)[1]);
		for (let [listId, ids] of listIdToMailDetailsDraftIds) {
			const ownerEncSessionKeyProvider = async (instanceElementId) => {
				const mail = assertNotNull(mailDetailsDraftMails.find((m) => elementIdPart(assertNotNull(m.mailDetailsDraft)) === instanceElementId));
				return {
					key: assertNotNull(mail._ownerEncSessionKey),
					encryptingKeyVersion: parseKeyVersion(mail._ownerKeyVersion ?? "0")
				};
			};
			const mailDetailsDrafts = await this.loadInChunks(MailDetailsDraftTypeRef, listId, ids, ownerEncSessionKeyProvider, options);
			result.push(...mailDetailsDrafts.map((draftDetails) => {
				const mail = assertNotNull(mailDetailsDraftMails.find((m) => isSameId(m.mailDetailsDraft, draftDetails._id)));
				return {
					mail,
					mailDetails: draftDetails.details
				};
			}));
		}
		return result;
	}
	async loadAttachments(mails, options = {}) {
		const attachmentIds = [];
		for (const mail of mails) attachmentIds.push(...mail.attachments);
		const filesByList = groupBy(attachmentIds, (a) => a[0]);
		const fileLoadingPromises = [];
		for (const [listId, fileIds] of filesByList.entries()) fileLoadingPromises.push(this.loadInChunks(FileTypeRef, listId, fileIds.map((f) => f[1]), undefined, options));
		const filesResults = await Promise.all(fileLoadingPromises);
		return filesResults.flat();
	}
	async loadInChunks(typeRef, listId, ids, ownerEncSessionKeyProvider, options = {}) {
		const byChunk = splitInChunks(ENTITY_INDEXER_CHUNK, ids);
		const entityResults = await pMap(byChunk, (chunk) => {
			return chunk.length > 0 ? this.mailDataEntityClient.loadMultiple(typeRef, listId, chunk, ownerEncSessionKeyProvider, {
				...options,
				cacheMode: CacheMode.ReadOnly
			}) : Promise.resolve([]);
		}, { concurrency: 2 });
		return entityResults.flat();
	}
};

//#endregion
export { BulkMailLoader };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQnVsa01haWxMb2FkZXItY2h1bmsuanMiLCJuYW1lcyI6WyJtYWlsRW50aXR5Q2xpZW50OiBFbnRpdHlDbGllbnQiLCJtYWlsRGF0YUVudGl0eUNsaWVudDogRW50aXR5Q2xpZW50IiwiY2FjaGVkU3RvcmFnZTogRXhwb3NlZENhY2hlU3RvcmFnZSB8IG51bGwiLCJtYWlsTGlzdElkOiBJZCIsIm1haWxMSXN0SWQ6IElkIiwic3RhcnRJZDogSWQiLCJvcHRpb25zOiBFbnRpdHlSZXN0Q2xpZW50TG9hZE9wdGlvbnMiLCJpZDogSWRUdXBsZSIsIm1haWxzOiByZWFkb25seSBNYWlsW10iLCJyZXN1bHQ6IEFycmF5PE1haWxXaXRoTWFpbERldGFpbHM+IiwibGlzdElkVG9NYWlsRGV0YWlsc0Jsb2JJZHM6IE1hcDxJZCwgQXJyYXk8SWQ+PiIsIm93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyOiBPd25lckVuY1Nlc3Npb25LZXlQcm92aWRlciIsImluc3RhbmNlRWxlbWVudElkOiBJZCIsImxpc3RJZFRvTWFpbERldGFpbHNEcmFmdElkczogTWFwPElkLCBBcnJheTxJZD4+IiwiYXR0YWNobWVudElkczogSWRUdXBsZVtdIiwiZmlsZUxvYWRpbmdQcm9taXNlczogQXJyYXk8UHJvbWlzZTxBcnJheTxUdXRhbm90YUZpbGU+Pj4iLCJ0eXBlUmVmOiBUeXBlUmVmPFQ+IiwibGlzdElkOiBJZCB8IG51bGwiLCJpZHM6IElkW10iLCJvd25lckVuY1Nlc3Npb25LZXlQcm92aWRlcj86IE93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyIl0sInNvdXJjZXMiOlsiLi4vc3JjL21haWwtYXBwL3dvcmtlclV0aWxzL2luZGV4L0J1bGtNYWlsTG9hZGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydE5vdE51bGwsIGdyb3VwQnksIGdyb3VwQnlBbmRNYXAsIG5ldmVyTnVsbCwgcHJvbWlzZU1hcCwgc3BsaXRJbkNodW5rcywgVHlwZVJlZiB9IGZyb20gXCJAdHV0YW8vdHV0YW5vdGEtdXRpbHNcIlxuaW1wb3J0IHsgRW50aXR5Q2xpZW50IH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9hcGkvY29tbW9uL0VudGl0eUNsaWVudC5qc1wiXG5pbXBvcnQgeyBFeHBvc2VkQ2FjaGVTdG9yYWdlIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9hcGkvd29ya2VyL3Jlc3QvRGVmYXVsdEVudGl0eVJlc3RDYWNoZS5qc1wiXG5pbXBvcnQgeyBlbGVtZW50SWRQYXJ0LCBpc1NhbWVJZCwgbGlzdElkUGFydCwgdGltZXN0YW1wVG9HZW5lcmF0ZWRJZCB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vYXBpL2NvbW1vbi91dGlscy9FbnRpdHlVdGlscy5qc1wiXG5pbXBvcnQgeyBDYWNoZU1vZGUsIEVudGl0eVJlc3RDbGllbnRMb2FkT3B0aW9ucywgT3duZXJFbmNTZXNzaW9uS2V5UHJvdmlkZXIgfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL2FwaS93b3JrZXIvcmVzdC9FbnRpdHlSZXN0Q2xpZW50LmpzXCJcbmltcG9ydCB7IGlzRHJhZnQgfSBmcm9tIFwiLi4vLi4vbWFpbC9tb2RlbC9NYWlsQ2hlY2tzLmpzXCJcbmltcG9ydCB7XG5cdEZpbGUgYXMgVHV0YW5vdGFGaWxlLFxuXHRGaWxlVHlwZVJlZixcblx0TWFpbCxcblx0TWFpbERldGFpbHMsXG5cdE1haWxEZXRhaWxzQmxvYlR5cGVSZWYsXG5cdE1haWxEZXRhaWxzRHJhZnRUeXBlUmVmLFxuXHRNYWlsVHlwZVJlZixcbn0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9hcGkvZW50aXRpZXMvdHV0YW5vdGEvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHsgU29tZUVudGl0eSB9IGZyb20gXCIuLi8uLi8uLi9jb21tb24vYXBpL2NvbW1vbi9FbnRpdHlUeXBlcy5qc1wiXG5pbXBvcnQgeyBwYXJzZUtleVZlcnNpb24gfSBmcm9tIFwiLi4vLi4vLi4vY29tbW9uL2FwaS93b3JrZXIvZmFjYWRlcy9LZXlMb2FkZXJGYWNhZGUuanNcIlxuXG5leHBvcnQgY29uc3QgRU5USVRZX0lOREVYRVJfQ0hVTksgPSAyMFxuZXhwb3J0IGNvbnN0IE1BSUxfSU5ERVhFUl9DSFVOSyA9IDEwMFxuXG5leHBvcnQgdHlwZSBUaW1lUmFuZ2UgPSBbbnVtYmVyLCBudW1iZXJdXG5cbmV4cG9ydCBpbnRlcmZhY2UgTWFpbFdpdGhNYWlsRGV0YWlscyB7XG5cdG1haWw6IE1haWxcblx0bWFpbERldGFpbHM6IE1haWxEZXRhaWxzXG59XG5cbmV4cG9ydCBjbGFzcyBCdWxrTWFpbExvYWRlciB7XG5cdGNvbnN0cnVjdG9yKFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgbWFpbEVudGl0eUNsaWVudDogRW50aXR5Q2xpZW50LFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgbWFpbERhdGFFbnRpdHlDbGllbnQ6IEVudGl0eUNsaWVudCxcblx0XHRwcml2YXRlIHJlYWRvbmx5IGNhY2hlZFN0b3JhZ2U6IEV4cG9zZWRDYWNoZVN0b3JhZ2UgfCBudWxsLFxuXHQpIHt9XG5cblx0bG9hZE1haWxzSW5SYW5nZVdpdGhDYWNoZShcblx0XHRtYWlsTGlzdElkOiBJZCxcblx0XHRbcmFuZ2VTdGFydCwgcmFuZ2VFbmRdOiBUaW1lUmFuZ2UsXG5cdCk6IFByb21pc2U8e1xuXHRcdGVsZW1lbnRzOiBBcnJheTxNYWlsPlxuXHRcdGxvYWRlZENvbXBsZXRlbHk6IGJvb2xlYW5cblx0fT4ge1xuXHRcdHJldHVybiB0aGlzLm1haWxFbnRpdHlDbGllbnQubG9hZFJldmVyc2VSYW5nZUJldHdlZW4oXG5cdFx0XHRNYWlsVHlwZVJlZixcblx0XHRcdG1haWxMaXN0SWQsXG5cdFx0XHR0aW1lc3RhbXBUb0dlbmVyYXRlZElkKHJhbmdlU3RhcnQpLFxuXHRcdFx0dGltZXN0YW1wVG9HZW5lcmF0ZWRJZChyYW5nZUVuZCksXG5cdFx0XHRNQUlMX0lOREVYRVJfQ0hVTkssXG5cdFx0KVxuXHR9XG5cblx0bG9hZEZpeGVkTnVtYmVyT2ZNYWlsc1dpdGhDYWNoZShtYWlsTElzdElkOiBJZCwgc3RhcnRJZDogSWQsIG9wdGlvbnM6IEVudGl0eVJlc3RDbGllbnRMb2FkT3B0aW9ucyA9IHt9KTogUHJvbWlzZTxNYWlsW10+IHtcblx0XHRyZXR1cm4gdGhpcy5tYWlsRW50aXR5Q2xpZW50LmxvYWRSYW5nZShNYWlsVHlwZVJlZiwgbWFpbExJc3RJZCwgc3RhcnRJZCwgTUFJTF9JTkRFWEVSX0NIVU5LLCB0cnVlLCB7IC4uLm9wdGlvbnMsIGNhY2hlTW9kZTogQ2FjaGVNb2RlLlJlYWRPbmx5IH0pXG5cdH1cblxuXHRhc3luYyByZW1vdmVGcm9tQ2FjaGUoaWQ6IElkVHVwbGUpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRyZXR1cm4gdGhpcy5jYWNoZWRTdG9yYWdlPy5kZWxldGVJZkV4aXN0cyhNYWlsVHlwZVJlZiwgbGlzdElkUGFydChpZCksIGVsZW1lbnRJZFBhcnQoaWQpKVxuXHR9XG5cblx0YXN5bmMgbG9hZE1haWxEZXRhaWxzKG1haWxzOiByZWFkb25seSBNYWlsW10sIG9wdGlvbnM6IEVudGl0eVJlc3RDbGllbnRMb2FkT3B0aW9ucyA9IHt9KTogUHJvbWlzZTxNYWlsV2l0aE1haWxEZXRhaWxzW10+IHtcblx0XHRjb25zdCByZXN1bHQ6IEFycmF5PE1haWxXaXRoTWFpbERldGFpbHM+ID0gW11cblx0XHQvLyBtYWlsRGV0YWlscyBzdG9yZWQgYXMgYmxvYlxuXHRcdGxldCBtYWlsRGV0YWlsc0Jsb2JNYWlscyA9IG1haWxzLmZpbHRlcigobSkgPT4gIWlzRHJhZnQobSkpXG5cdFx0Y29uc3QgbGlzdElkVG9NYWlsRGV0YWlsc0Jsb2JJZHM6IE1hcDxJZCwgQXJyYXk8SWQ+PiA9IGdyb3VwQnlBbmRNYXAoXG5cdFx0XHRtYWlsRGV0YWlsc0Jsb2JNYWlscyxcblx0XHRcdChtKSA9PiBhc3NlcnROb3ROdWxsKG0ubWFpbERldGFpbHMpWzBdLFxuXHRcdFx0KG0pID0+IG5ldmVyTnVsbChtLm1haWxEZXRhaWxzKVsxXSxcblx0XHQpXG5cdFx0Zm9yIChsZXQgW2xpc3RJZCwgaWRzXSBvZiBsaXN0SWRUb01haWxEZXRhaWxzQmxvYklkcykge1xuXHRcdFx0Y29uc3Qgb3duZXJFbmNTZXNzaW9uS2V5UHJvdmlkZXI6IE93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyID0gYXN5bmMgKGluc3RhbmNlRWxlbWVudElkOiBJZCkgPT4ge1xuXHRcdFx0XHRjb25zdCBtYWlsID0gYXNzZXJ0Tm90TnVsbChtYWlsRGV0YWlsc0Jsb2JNYWlscy5maW5kKChtKSA9PiBlbGVtZW50SWRQYXJ0KGFzc2VydE5vdE51bGwobS5tYWlsRGV0YWlscykpID09PSBpbnN0YW5jZUVsZW1lbnRJZCkpXG5cdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0a2V5OiBhc3NlcnROb3ROdWxsKG1haWwuX293bmVyRW5jU2Vzc2lvbktleSksXG5cdFx0XHRcdFx0ZW5jcnlwdGluZ0tleVZlcnNpb246IHBhcnNlS2V5VmVyc2lvbihtYWlsLl9vd25lcktleVZlcnNpb24gPz8gXCIwXCIpLFxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRjb25zdCBtYWlsRGV0YWlsc0Jsb2JzID0gYXdhaXQgdGhpcy5sb2FkSW5DaHVua3MoTWFpbERldGFpbHNCbG9iVHlwZVJlZiwgbGlzdElkLCBpZHMsIG93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyLCBvcHRpb25zKVxuXHRcdFx0cmVzdWx0LnB1c2goXG5cdFx0XHRcdC4uLm1haWxEZXRhaWxzQmxvYnMubWFwKChtYWlsRGV0YWlsc0Jsb2IpID0+IHtcblx0XHRcdFx0XHRjb25zdCBtYWlsID0gYXNzZXJ0Tm90TnVsbChtYWlsRGV0YWlsc0Jsb2JNYWlscy5maW5kKChtKSA9PiBpc1NhbWVJZChtLm1haWxEZXRhaWxzLCBtYWlsRGV0YWlsc0Jsb2IuX2lkKSkpXG5cdFx0XHRcdFx0cmV0dXJuIHsgbWFpbCwgbWFpbERldGFpbHM6IG1haWxEZXRhaWxzQmxvYi5kZXRhaWxzIH1cblx0XHRcdFx0fSksXG5cdFx0XHQpXG5cdFx0fVxuXHRcdC8vIG1haWxEZXRhaWxzIHN0b3JlZCBpbiBkYiAoZHJhZnQpXG5cdFx0bGV0IG1haWxEZXRhaWxzRHJhZnRNYWlscyA9IG1haWxzLmZpbHRlcigobSkgPT4gaXNEcmFmdChtKSlcblx0XHRjb25zdCBsaXN0SWRUb01haWxEZXRhaWxzRHJhZnRJZHM6IE1hcDxJZCwgQXJyYXk8SWQ+PiA9IGdyb3VwQnlBbmRNYXAoXG5cdFx0XHRtYWlsRGV0YWlsc0RyYWZ0TWFpbHMsXG5cdFx0XHQobSkgPT4gYXNzZXJ0Tm90TnVsbChtLm1haWxEZXRhaWxzRHJhZnQpWzBdLFxuXHRcdFx0KG0pID0+IG5ldmVyTnVsbChtLm1haWxEZXRhaWxzRHJhZnQpWzFdLFxuXHRcdClcblx0XHRmb3IgKGxldCBbbGlzdElkLCBpZHNdIG9mIGxpc3RJZFRvTWFpbERldGFpbHNEcmFmdElkcykge1xuXHRcdFx0Y29uc3Qgb3duZXJFbmNTZXNzaW9uS2V5UHJvdmlkZXI6IE93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyID0gYXN5bmMgKGluc3RhbmNlRWxlbWVudElkOiBJZCkgPT4ge1xuXHRcdFx0XHRjb25zdCBtYWlsID0gYXNzZXJ0Tm90TnVsbChtYWlsRGV0YWlsc0RyYWZ0TWFpbHMuZmluZCgobSkgPT4gZWxlbWVudElkUGFydChhc3NlcnROb3ROdWxsKG0ubWFpbERldGFpbHNEcmFmdCkpID09PSBpbnN0YW5jZUVsZW1lbnRJZCkpXG5cdFx0XHRcdHJldHVybiB7XG5cdFx0XHRcdFx0a2V5OiBhc3NlcnROb3ROdWxsKG1haWwuX293bmVyRW5jU2Vzc2lvbktleSksXG5cdFx0XHRcdFx0ZW5jcnlwdGluZ0tleVZlcnNpb246IHBhcnNlS2V5VmVyc2lvbihtYWlsLl9vd25lcktleVZlcnNpb24gPz8gXCIwXCIpLFxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRjb25zdCBtYWlsRGV0YWlsc0RyYWZ0cyA9IGF3YWl0IHRoaXMubG9hZEluQ2h1bmtzKE1haWxEZXRhaWxzRHJhZnRUeXBlUmVmLCBsaXN0SWQsIGlkcywgb3duZXJFbmNTZXNzaW9uS2V5UHJvdmlkZXIsIG9wdGlvbnMpXG5cdFx0XHRyZXN1bHQucHVzaChcblx0XHRcdFx0Li4ubWFpbERldGFpbHNEcmFmdHMubWFwKChkcmFmdERldGFpbHMpID0+IHtcblx0XHRcdFx0XHRjb25zdCBtYWlsID0gYXNzZXJ0Tm90TnVsbChtYWlsRGV0YWlsc0RyYWZ0TWFpbHMuZmluZCgobSkgPT4gaXNTYW1lSWQobS5tYWlsRGV0YWlsc0RyYWZ0LCBkcmFmdERldGFpbHMuX2lkKSkpXG5cdFx0XHRcdFx0cmV0dXJuIHsgbWFpbCwgbWFpbERldGFpbHM6IGRyYWZ0RGV0YWlscy5kZXRhaWxzIH1cblx0XHRcdFx0fSksXG5cdFx0XHQpXG5cdFx0fVxuXHRcdHJldHVybiByZXN1bHRcblx0fVxuXG5cdGFzeW5jIGxvYWRBdHRhY2htZW50cyhtYWlsczogcmVhZG9ubHkgTWFpbFtdLCBvcHRpb25zOiBFbnRpdHlSZXN0Q2xpZW50TG9hZE9wdGlvbnMgPSB7fSk6IFByb21pc2U8VHV0YW5vdGFGaWxlW10+IHtcblx0XHRjb25zdCBhdHRhY2htZW50SWRzOiBJZFR1cGxlW10gPSBbXVxuXHRcdGZvciAoY29uc3QgbWFpbCBvZiBtYWlscykge1xuXHRcdFx0YXR0YWNobWVudElkcy5wdXNoKC4uLm1haWwuYXR0YWNobWVudHMpXG5cdFx0fVxuXHRcdGNvbnN0IGZpbGVzQnlMaXN0ID0gZ3JvdXBCeShhdHRhY2htZW50SWRzLCAoYSkgPT4gYVswXSlcblx0XHRjb25zdCBmaWxlTG9hZGluZ1Byb21pc2VzOiBBcnJheTxQcm9taXNlPEFycmF5PFR1dGFub3RhRmlsZT4+PiA9IFtdXG5cdFx0Zm9yIChjb25zdCBbbGlzdElkLCBmaWxlSWRzXSBvZiBmaWxlc0J5TGlzdC5lbnRyaWVzKCkpIHtcblx0XHRcdGZpbGVMb2FkaW5nUHJvbWlzZXMucHVzaChcblx0XHRcdFx0dGhpcy5sb2FkSW5DaHVua3MoXG5cdFx0XHRcdFx0RmlsZVR5cGVSZWYsXG5cdFx0XHRcdFx0bGlzdElkLFxuXHRcdFx0XHRcdGZpbGVJZHMubWFwKChmKSA9PiBmWzFdKSxcblx0XHRcdFx0XHR1bmRlZmluZWQsXG5cdFx0XHRcdFx0b3B0aW9ucyxcblx0XHRcdFx0KSxcblx0XHRcdClcblx0XHR9XG5cdFx0Y29uc3QgZmlsZXNSZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwoZmlsZUxvYWRpbmdQcm9taXNlcylcblx0XHRyZXR1cm4gZmlsZXNSZXN1bHRzLmZsYXQoKVxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBsb2FkSW5DaHVua3M8VCBleHRlbmRzIFNvbWVFbnRpdHk+KFxuXHRcdHR5cGVSZWY6IFR5cGVSZWY8VD4sXG5cdFx0bGlzdElkOiBJZCB8IG51bGwsXG5cdFx0aWRzOiBJZFtdLFxuXHRcdG93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyPzogT3duZXJFbmNTZXNzaW9uS2V5UHJvdmlkZXIsXG5cdFx0b3B0aW9uczogRW50aXR5UmVzdENsaWVudExvYWRPcHRpb25zID0ge30sXG5cdCk6IFByb21pc2U8VFtdPiB7XG5cdFx0Y29uc3QgYnlDaHVuayA9IHNwbGl0SW5DaHVua3MoRU5USVRZX0lOREVYRVJfQ0hVTkssIGlkcylcblx0XHRjb25zdCBlbnRpdHlSZXN1bHRzID0gYXdhaXQgcHJvbWlzZU1hcChcblx0XHRcdGJ5Q2h1bmssXG5cdFx0XHQoY2h1bmspID0+IHtcblx0XHRcdFx0cmV0dXJuIGNodW5rLmxlbmd0aCA+IDBcblx0XHRcdFx0XHQ/IHRoaXMubWFpbERhdGFFbnRpdHlDbGllbnQubG9hZE11bHRpcGxlKHR5cGVSZWYsIGxpc3RJZCwgY2h1bmssIG93bmVyRW5jU2Vzc2lvbktleVByb3ZpZGVyLCB7IC4uLm9wdGlvbnMsIGNhY2hlTW9kZTogQ2FjaGVNb2RlLlJlYWRPbmx5IH0pXG5cdFx0XHRcdFx0OiBQcm9taXNlLnJlc29sdmUoW10pXG5cdFx0XHR9LFxuXHRcdFx0e1xuXHRcdFx0XHRjb25jdXJyZW5jeTogMixcblx0XHRcdH0sXG5cdFx0KVxuXHRcdHJldHVybiBlbnRpdHlSZXN1bHRzLmZsYXQoKVxuXHR9XG59XG4iXSwibWFwcGluZ3MiOiI7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