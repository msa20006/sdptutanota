import "./dist-chunk.js";
import "./ProgrammingError-chunk.js";
import "./Env-chunk.js";
import "./ClientDetector-chunk.js";
import "./mithril-chunk.js";
import { ofClass } from "./dist2-chunk.js";
import "./WhitelabelCustomizations-chunk.js";
import "./LanguageViewModel-chunk.js";
import "./styles-chunk.js";
import "./theme-chunk.js";
import "./TutanotaConstants-chunk.js";
import "./KeyManager-chunk.js";
import "./WindowFacade-chunk.js";
import "./RootView-chunk.js";
import "./size-chunk.js";
import "./HtmlUtils-chunk.js";
import "./EntityUtils-chunk.js";
import "./TypeModels-chunk.js";
import { ContactListEntryTypeRef, ContactTypeRef } from "./TypeRefs-chunk.js";
import { findRecipientWithAddress } from "./CommonCalendarUtils-chunk.js";
import "./TypeModels2-chunk.js";
import "./TypeRefs2-chunk.js";
import "./ParserCombinator-chunk.js";
import { isMailAddress } from "./FormatValidator-chunk.js";
import "./stream-chunk.js";
import "./ErrorUtils-chunk.js";
import "./RestError-chunk.js";
import "./OutOfSyncError-chunk.js";
import "./CancelledError-chunk.js";
import "./SuspensionError-chunk.js";
import { LoginIncompleteError } from "./LoginIncompleteError-chunk.js";
import "./CryptoError-chunk.js";
import "./RecipientsNotFoundError-chunk.js";
import { DbError } from "./DbError-chunk.js";
import "./QuotaExceededError-chunk.js";
import "./DeviceStorageUnavailableError-chunk.js";
import "./MailBodyTooLargeError-chunk.js";
import "./ImportError-chunk.js";
import "./WebauthnError-chunk.js";
import "./PermissionError-chunk.js";
import "./BirthdayUtils-chunk.js";
import "./GroupUtils-chunk.js";
import "./Button-chunk.js";
import "./Icons-chunk.js";
import "./DialogHeaderBar-chunk.js";
import "./CountryList-chunk.js";
import "./Dialog-chunk.js";
import "./Icon-chunk.js";
import "./AriaUtils-chunk.js";
import "./IconButton-chunk.js";
import "./Formatter-chunk.js";
import { locator } from "./CommonLocator-chunk.js";
import "./MailAddressParser-chunk.js";
import "./BlobUtils-chunk.js";
import "./FileUtils-chunk.js";
import "./ProgressDialog-chunk.js";
import "./SharedMailUtils-chunk.js";
import "./Recipient-chunk.js";
import "./ContactUtils-chunk.js";
import { ResolveMode } from "./RecipientsModel-chunk.js";

//#region src/common/misc/RecipientsSearchModel.ts
const MaxNativeSuggestions = 10;
var RecipientsSearchModel = class {
	searchResults = [];
	loading = null;
	currentQuery = "";
	previousQuery = "";
	filter = null;
	constructor(recipientsModel, contactModel, suggestionsProvider, entityClient) {
		this.recipientsModel = recipientsModel;
		this.contactModel = contactModel;
		this.suggestionsProvider = suggestionsProvider;
		this.entityClient = entityClient;
	}
	results() {
		return this.searchResults;
	}
	isLoading() {
		return this.loading != null;
	}
	clear() {
		this.searchResults = [];
		this.loading = null;
		this.currentQuery = "";
		this.previousQuery = "";
	}
	async search(value) {
		const query = value.trim();
		this.currentQuery = query;
		if (this.loading != null) {} else if (query.length > 0 && !(this.previousQuery.length > 0 && query.indexOf(this.previousQuery) === 0 && this.searchResults.length === 0)) {
			const [newContactListSuggestions, newContactSuggestions] = await Promise.all([this.findContactLists(query.toLowerCase()), this.findContacts(query.toLowerCase())]);
			if (query === this.currentQuery) {
				this.searchResults = [...newContactListSuggestions.map((value$1) => ({
					type: "contactlist",
					value: value$1
				})), ...newContactSuggestions.map((value$1) => ({
					type: "recipient",
					value: value$1
				}))].filter(this.filter ?? ((_) => true));
				this.previousQuery = query;
			}
			this.loading = null;
		} else if (query.length === 0 && query !== this.previousQuery) {
			this.searchResults = [];
			this.previousQuery = query;
		}
		await this.loading;
	}
	async resolveContactList(contactList) {
		const entries = await this.entityClient.loadAll(ContactListEntryTypeRef, contactList.groupRoot.entries);
		return entries.map((entry) => {
			return this.recipientsModel.resolve({ address: entry.emailAddress }, ResolveMode.Lazy);
		});
	}
	setFilter(filter) {
		this.filter = filter;
	}
	async findContacts(query) {
		if (isMailAddress(query, false)) return [];
		const contacts = await this.contactModel.searchForContacts(`"${query}"`, "recipient", 10).catch(ofClass(DbError, async () => {
			const listId = await this.contactModel.getContactListId();
			if (listId) return locator.entityClient.loadAll(ContactTypeRef, listId);
else return [];
		})).catch(ofClass(LoginIncompleteError, () => []));
		let suggestedRecipients = [];
		for (const contact of contacts) {
			const name = `${contact.firstName} ${contact.lastName}`.trim();
			const filter = name.toLowerCase().indexOf(query) !== -1 ? (address) => isMailAddress(address.trim(), false) : (address) => isMailAddress(address.trim(), false) && address.toLowerCase().indexOf(query) !== -1;
			const recipientsOfContact = contact.mailAddresses.map(({ address }) => address).filter(filter).map((address) => this.recipientsModel.resolve({
				name,
				address,
				contact
			}, ResolveMode.Lazy));
			suggestedRecipients = suggestedRecipients.concat(recipientsOfContact);
		}
		const additionalSuggestions = await this.findAdditionalSuggestions(query);
		const contactSuggestions = additionalSuggestions.filter((contact) => isMailAddress(contact.address, false) && !findRecipientWithAddress(suggestedRecipients, contact.address)).slice(0, MaxNativeSuggestions).map((recipient) => this.recipientsModel.resolve(recipient, ResolveMode.Lazy));
		suggestedRecipients.push(...contactSuggestions);
		return suggestedRecipients.sort((suggestion1, suggestion2) => suggestion1.name.localeCompare(suggestion2.name));
	}
	async findAdditionalSuggestions(text) {
		if (!this.suggestionsProvider) return [];
		const recipients = await this.suggestionsProvider.getContactSuggestions(text);
		return recipients.map(({ name, mailAddress }) => ({
			name,
			address: mailAddress
		}));
	}
	async findContactLists(text) {
		return this.contactModel.searchForContactLists(text);
	}
};

//#endregion
export { RecipientsSearchModel };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVjaXBpZW50c1NlYXJjaE1vZGVsLWNodW5rLmpzIiwibmFtZXMiOlsicmVjaXBpZW50c01vZGVsOiBSZWNpcGllbnRzTW9kZWwiLCJjb250YWN0TW9kZWw6IENvbnRhY3RNb2RlbCIsInN1Z2dlc3Rpb25zUHJvdmlkZXI6IENvbnRhY3RTdWdnZXN0aW9uUHJvdmlkZXIiLCJlbnRpdHlDbGllbnQ6IEVudGl0eUNsaWVudCIsInZhbHVlOiBzdHJpbmciLCJ2YWx1ZSIsImNvbnRhY3RMaXN0OiBDb250YWN0TGlzdEluZm8iLCJmaWx0ZXI6IFJlY2lwaWVudFNlYXJjaFJlc3VsdEZpbHRlciB8IG51bGwiLCJxdWVyeTogc3RyaW5nIiwic3VnZ2VzdGVkUmVjaXBpZW50czogQXJyYXk8UmVjaXBpZW50PiIsImFkZHJlc3M6IHN0cmluZyIsInRleHQ6IHN0cmluZyJdLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21tb24vbWlzYy9SZWNpcGllbnRzU2VhcmNoTW9kZWwudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUGFydGlhbFJlY2lwaWVudCwgUmVjaXBpZW50IH0gZnJvbSBcIi4uL2FwaS9jb21tb24vcmVjaXBpZW50cy9SZWNpcGllbnQuanNcIlxuaW1wb3J0IHsgUmVjaXBpZW50c01vZGVsLCBSZXNvbHZlTW9kZSB9IGZyb20gXCIuLi9hcGkvbWFpbi9SZWNpcGllbnRzTW9kZWwuanNcIlxuaW1wb3J0IHsgQ29udGFjdExpc3RJbmZvLCBDb250YWN0TW9kZWwgfSBmcm9tIFwiLi4vY29udGFjdHNGdW5jdGlvbmFsaXR5L0NvbnRhY3RNb2RlbC5qc1wiXG5pbXBvcnQgeyBpc01haWxBZGRyZXNzIH0gZnJvbSBcIi4vRm9ybWF0VmFsaWRhdG9yLmpzXCJcbmltcG9ydCB7IG9mQ2xhc3MgfSBmcm9tIFwiQHR1dGFvL3R1dGFub3RhLXV0aWxzXCJcbmltcG9ydCB7IERiRXJyb3IgfSBmcm9tIFwiLi4vYXBpL2NvbW1vbi9lcnJvci9EYkVycm9yLmpzXCJcbmltcG9ydCB7IGxvY2F0b3IgfSBmcm9tIFwiLi4vYXBpL21haW4vQ29tbW9uTG9jYXRvci5qc1wiXG5pbXBvcnQgeyBDb250YWN0TGlzdEVudHJ5VHlwZVJlZiwgQ29udGFjdFR5cGVSZWYgfSBmcm9tIFwiLi4vYXBpL2VudGl0aWVzL3R1dGFub3RhL1R5cGVSZWZzLmpzXCJcbmltcG9ydCB7IExvZ2luSW5jb21wbGV0ZUVycm9yIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vZXJyb3IvTG9naW5JbmNvbXBsZXRlRXJyb3IuanNcIlxuaW1wb3J0IHsgZmluZFJlY2lwaWVudFdpdGhBZGRyZXNzIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vdXRpbHMvQ29tbW9uQ2FsZW5kYXJVdGlscy5qc1wiXG5pbXBvcnQgeyBFbnRpdHlDbGllbnQgfSBmcm9tIFwiLi4vYXBpL2NvbW1vbi9FbnRpdHlDbGllbnQuanNcIlxuaW1wb3J0IHsgQ29udGFjdFN1Z2dlc3Rpb24gfSBmcm9tIFwiLi4vbmF0aXZlL2NvbW1vbi9nZW5lcmF0ZWRpcGMvQ29udGFjdFN1Z2dlc3Rpb24uanNcIlxuXG5jb25zdCBNYXhOYXRpdmVTdWdnZXN0aW9ucyA9IDEwXG5cbmV4cG9ydCB0eXBlIFJlY2lwaWVudFNlYXJjaFJlc3VsdEl0ZW0gPVxuXHR8IHsgdHlwZTogXCJyZWNpcGllbnRcIjsgdmFsdWU6IFJlY2lwaWVudCB9XG5cdHwge1xuXHRcdFx0dHlwZTogXCJjb250YWN0bGlzdFwiXG5cdFx0XHR2YWx1ZTogQ29udGFjdExpc3RJbmZvXG5cdCAgfVxuZXhwb3J0IHR5cGUgUmVjaXBpZW50U2VhcmNoUmVzdWx0RmlsdGVyID0gKGl0ZW06IFJlY2lwaWVudFNlYXJjaFJlc3VsdEl0ZW0pID0+IGJvb2xlYW5cblxuZXhwb3J0IGludGVyZmFjZSBDb250YWN0U3VnZ2VzdGlvblByb3ZpZGVyIHtcblx0Z2V0Q29udGFjdFN1Z2dlc3Rpb25zKHF1ZXJ5OiBzdHJpbmcpOiBQcm9taXNlPHJlYWRvbmx5IENvbnRhY3RTdWdnZXN0aW9uW10+XG59XG5cbmV4cG9ydCBjbGFzcyBSZWNpcGllbnRzU2VhcmNoTW9kZWwge1xuXHRwcml2YXRlIHNlYXJjaFJlc3VsdHM6IEFycmF5PFJlY2lwaWVudFNlYXJjaFJlc3VsdEl0ZW0+ID0gW11cblx0cHJpdmF0ZSBsb2FkaW5nOiBQcm9taXNlPHZvaWQ+IHwgbnVsbCA9IG51bGxcblxuXHRwcml2YXRlIGN1cnJlbnRRdWVyeSA9IFwiXCJcblx0cHJpdmF0ZSBwcmV2aW91c1F1ZXJ5ID0gXCJcIlxuXHRwcml2YXRlIGZpbHRlcjogUmVjaXBpZW50U2VhcmNoUmVzdWx0RmlsdGVyIHwgbnVsbCA9IG51bGxcblxuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIHJlYWRvbmx5IHJlY2lwaWVudHNNb2RlbDogUmVjaXBpZW50c01vZGVsLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgY29udGFjdE1vZGVsOiBDb250YWN0TW9kZWwsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBzdWdnZXN0aW9uc1Byb3ZpZGVyOiBDb250YWN0U3VnZ2VzdGlvblByb3ZpZGVyLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgZW50aXR5Q2xpZW50OiBFbnRpdHlDbGllbnQsXG5cdCkge31cblxuXHRyZXN1bHRzKCk6IFJlYWRvbmx5QXJyYXk8UmVjaXBpZW50U2VhcmNoUmVzdWx0SXRlbT4ge1xuXHRcdHJldHVybiB0aGlzLnNlYXJjaFJlc3VsdHNcblx0fVxuXG5cdGlzTG9hZGluZygpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gdGhpcy5sb2FkaW5nICE9IG51bGxcblx0fVxuXG5cdGNsZWFyKCkge1xuXHRcdHRoaXMuc2VhcmNoUmVzdWx0cyA9IFtdXG5cdFx0dGhpcy5sb2FkaW5nID0gbnVsbFxuXHRcdHRoaXMuY3VycmVudFF1ZXJ5ID0gXCJcIlxuXHRcdHRoaXMucHJldmlvdXNRdWVyeSA9IFwiXCJcblx0fVxuXG5cdGFzeW5jIHNlYXJjaCh2YWx1ZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgcXVlcnkgPSB2YWx1ZS50cmltKClcblxuXHRcdHRoaXMuY3VycmVudFF1ZXJ5ID0gcXVlcnlcblxuXHRcdGlmICh0aGlzLmxvYWRpbmcgIT0gbnVsbCkge1xuXHRcdFx0Ly8gZmFsbCB0aHJvdWdoIGFuZCBhd2FpdCBiZWxvd1xuXHRcdH0gZWxzZSBpZiAocXVlcnkubGVuZ3RoID4gMCAmJiAhKHRoaXMucHJldmlvdXNRdWVyeS5sZW5ndGggPiAwICYmIHF1ZXJ5LmluZGV4T2YodGhpcy5wcmV2aW91c1F1ZXJ5KSA9PT0gMCAmJiB0aGlzLnNlYXJjaFJlc3VsdHMubGVuZ3RoID09PSAwKSkge1xuXHRcdFx0Y29uc3QgW25ld0NvbnRhY3RMaXN0U3VnZ2VzdGlvbnMsIG5ld0NvbnRhY3RTdWdnZXN0aW9uc10gPSBhd2FpdCBQcm9taXNlLmFsbChbXG5cdFx0XHRcdHRoaXMuZmluZENvbnRhY3RMaXN0cyhxdWVyeS50b0xvd2VyQ2FzZSgpKSxcblx0XHRcdFx0dGhpcy5maW5kQ29udGFjdHMocXVlcnkudG9Mb3dlckNhc2UoKSksXG5cdFx0XHRdKVxuXHRcdFx0aWYgKHF1ZXJ5ID09PSB0aGlzLmN1cnJlbnRRdWVyeSkge1xuXHRcdFx0XHR0aGlzLnNlYXJjaFJlc3VsdHMgPSBbXG5cdFx0XHRcdFx0Li4ubmV3Q29udGFjdExpc3RTdWdnZXN0aW9ucy5tYXAoXG5cdFx0XHRcdFx0XHQodmFsdWUpID0+XG5cdFx0XHRcdFx0XHRcdCh7XG5cdFx0XHRcdFx0XHRcdFx0dHlwZTogXCJjb250YWN0bGlzdFwiLFxuXHRcdFx0XHRcdFx0XHRcdHZhbHVlLFxuXHRcdFx0XHRcdFx0XHR9IHNhdGlzZmllcyBSZWNpcGllbnRTZWFyY2hSZXN1bHRJdGVtKSxcblx0XHRcdFx0XHQpLFxuXHRcdFx0XHRcdC4uLm5ld0NvbnRhY3RTdWdnZXN0aW9ucy5tYXAoXG5cdFx0XHRcdFx0XHQodmFsdWUpID0+XG5cdFx0XHRcdFx0XHRcdCh7XG5cdFx0XHRcdFx0XHRcdFx0dHlwZTogXCJyZWNpcGllbnRcIixcblx0XHRcdFx0XHRcdFx0XHR2YWx1ZSxcblx0XHRcdFx0XHRcdFx0fSBzYXRpc2ZpZXMgUmVjaXBpZW50U2VhcmNoUmVzdWx0SXRlbSksXG5cdFx0XHRcdFx0KSxcblx0XHRcdFx0XS5maWx0ZXIodGhpcy5maWx0ZXIgPz8gKChfKSA9PiB0cnVlKSlcblx0XHRcdFx0dGhpcy5wcmV2aW91c1F1ZXJ5ID0gcXVlcnlcblx0XHRcdH1cblx0XHRcdHRoaXMubG9hZGluZyA9IG51bGxcblx0XHR9IGVsc2UgaWYgKHF1ZXJ5Lmxlbmd0aCA9PT0gMCAmJiBxdWVyeSAhPT0gdGhpcy5wcmV2aW91c1F1ZXJ5KSB7XG5cdFx0XHR0aGlzLnNlYXJjaFJlc3VsdHMgPSBbXVxuXHRcdFx0dGhpcy5wcmV2aW91c1F1ZXJ5ID0gcXVlcnlcblx0XHR9XG5cblx0XHRhd2FpdCB0aGlzLmxvYWRpbmdcblx0fVxuXG5cdGFzeW5jIHJlc29sdmVDb250YWN0TGlzdChjb250YWN0TGlzdDogQ29udGFjdExpc3RJbmZvKTogUHJvbWlzZTxBcnJheTxSZWNpcGllbnQ+PiB7XG5cdFx0Y29uc3QgZW50cmllcyA9IGF3YWl0IHRoaXMuZW50aXR5Q2xpZW50LmxvYWRBbGwoQ29udGFjdExpc3RFbnRyeVR5cGVSZWYsIGNvbnRhY3RMaXN0Lmdyb3VwUm9vdC5lbnRyaWVzKVxuXHRcdHJldHVybiBlbnRyaWVzLm1hcCgoZW50cnkpID0+IHtcblx0XHRcdC8vIGl0J3Mgb2theSB0byBiZSBsYXp5IHNvbWV0aW1lc1xuXHRcdFx0Ly8gYWxsIHRoZSBwbGFjZXMgYW55d2F5IHJlc29sdmUgdGhlIHJlY2lwaWVudHMgd2hlbiB0aGV5IG5lZWQgdG9cblx0XHRcdHJldHVybiB0aGlzLnJlY2lwaWVudHNNb2RlbC5yZXNvbHZlKHsgYWRkcmVzczogZW50cnkuZW1haWxBZGRyZXNzIH0sIFJlc29sdmVNb2RlLkxhenkpXG5cdFx0fSlcblx0fVxuXG5cdHNldEZpbHRlcihmaWx0ZXI6IFJlY2lwaWVudFNlYXJjaFJlc3VsdEZpbHRlciB8IG51bGwpIHtcblx0XHR0aGlzLmZpbHRlciA9IGZpbHRlclxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBmaW5kQ29udGFjdHMocXVlcnk6IHN0cmluZyk6IFByb21pc2U8QXJyYXk8UmVjaXBpZW50Pj4ge1xuXHRcdGlmIChpc01haWxBZGRyZXNzKHF1ZXJ5LCBmYWxzZSkpIHtcblx0XHRcdHJldHVybiBbXVxuXHRcdH1cblxuXHRcdC8vIGVuc3VyZSBtYXRjaCB3b3JkIG9yZGVyIGZvciBlbWFpbCBhZGRyZXNzZXMgbWFpbmx5XG5cdFx0Y29uc3QgY29udGFjdHMgPSBhd2FpdCB0aGlzLmNvbnRhY3RNb2RlbFxuXHRcdFx0LnNlYXJjaEZvckNvbnRhY3RzKGBcIiR7cXVlcnl9XCJgLCBcInJlY2lwaWVudFwiLCAxMClcblx0XHRcdC5jYXRjaChcblx0XHRcdFx0b2ZDbGFzcyhEYkVycm9yLCBhc3luYyAoKSA9PiB7XG5cdFx0XHRcdFx0Y29uc3QgbGlzdElkID0gYXdhaXQgdGhpcy5jb250YWN0TW9kZWwuZ2V0Q29udGFjdExpc3RJZCgpXG5cdFx0XHRcdFx0aWYgKGxpc3RJZCkge1xuXHRcdFx0XHRcdFx0cmV0dXJuIGxvY2F0b3IuZW50aXR5Q2xpZW50LmxvYWRBbGwoQ29udGFjdFR5cGVSZWYsIGxpc3RJZClcblx0XHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdFx0cmV0dXJuIFtdXG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9KSxcblx0XHRcdClcblx0XHRcdC5jYXRjaChvZkNsYXNzKExvZ2luSW5jb21wbGV0ZUVycm9yLCAoKSA9PiBbXSkpXG5cblx0XHRsZXQgc3VnZ2VzdGVkUmVjaXBpZW50czogQXJyYXk8UmVjaXBpZW50PiA9IFtdXG5cdFx0Zm9yIChjb25zdCBjb250YWN0IG9mIGNvbnRhY3RzKSB7XG5cdFx0XHRjb25zdCBuYW1lID0gYCR7Y29udGFjdC5maXJzdE5hbWV9ICR7Y29udGFjdC5sYXN0TmFtZX1gLnRyaW0oKVxuXG5cdFx0XHRjb25zdCBmaWx0ZXIgPVxuXHRcdFx0XHRuYW1lLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihxdWVyeSkgIT09IC0xXG5cdFx0XHRcdFx0PyAoYWRkcmVzczogc3RyaW5nKSA9PiBpc01haWxBZGRyZXNzKGFkZHJlc3MudHJpbSgpLCBmYWxzZSlcblx0XHRcdFx0XHQ6IChhZGRyZXNzOiBzdHJpbmcpID0+IGlzTWFpbEFkZHJlc3MoYWRkcmVzcy50cmltKCksIGZhbHNlKSAmJiBhZGRyZXNzLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihxdWVyeSkgIT09IC0xXG5cblx0XHRcdGNvbnN0IHJlY2lwaWVudHNPZkNvbnRhY3QgPSBjb250YWN0Lm1haWxBZGRyZXNzZXNcblx0XHRcdFx0Lm1hcCgoeyBhZGRyZXNzIH0pID0+IGFkZHJlc3MpXG5cdFx0XHRcdC5maWx0ZXIoZmlsdGVyKVxuXHRcdFx0XHQubWFwKChhZGRyZXNzKSA9PiB0aGlzLnJlY2lwaWVudHNNb2RlbC5yZXNvbHZlKHsgbmFtZSwgYWRkcmVzcywgY29udGFjdCB9LCBSZXNvbHZlTW9kZS5MYXp5KSlcblxuXHRcdFx0c3VnZ2VzdGVkUmVjaXBpZW50cyA9IHN1Z2dlc3RlZFJlY2lwaWVudHMuY29uY2F0KHJlY2lwaWVudHNPZkNvbnRhY3QpXG5cdFx0fVxuXG5cdFx0Y29uc3QgYWRkaXRpb25hbFN1Z2dlc3Rpb25zID0gYXdhaXQgdGhpcy5maW5kQWRkaXRpb25hbFN1Z2dlc3Rpb25zKHF1ZXJ5KVxuXG5cdFx0Y29uc3QgY29udGFjdFN1Z2dlc3Rpb25zID0gYWRkaXRpb25hbFN1Z2dlc3Rpb25zXG5cdFx0XHQuZmlsdGVyKChjb250YWN0KSA9PiBpc01haWxBZGRyZXNzKGNvbnRhY3QuYWRkcmVzcywgZmFsc2UpICYmICFmaW5kUmVjaXBpZW50V2l0aEFkZHJlc3Moc3VnZ2VzdGVkUmVjaXBpZW50cywgY29udGFjdC5hZGRyZXNzKSlcblx0XHRcdC5zbGljZSgwLCBNYXhOYXRpdmVTdWdnZXN0aW9ucylcblx0XHRcdC5tYXAoKHJlY2lwaWVudCkgPT4gdGhpcy5yZWNpcGllbnRzTW9kZWwucmVzb2x2ZShyZWNpcGllbnQsIFJlc29sdmVNb2RlLkxhenkpKVxuXG5cdFx0c3VnZ2VzdGVkUmVjaXBpZW50cy5wdXNoKC4uLmNvbnRhY3RTdWdnZXN0aW9ucylcblxuXHRcdHJldHVybiBzdWdnZXN0ZWRSZWNpcGllbnRzLnNvcnQoKHN1Z2dlc3Rpb24xLCBzdWdnZXN0aW9uMikgPT4gc3VnZ2VzdGlvbjEubmFtZS5sb2NhbGVDb21wYXJlKHN1Z2dlc3Rpb24yLm5hbWUpKVxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBmaW5kQWRkaXRpb25hbFN1Z2dlc3Rpb25zKHRleHQ6IHN0cmluZyk6IFByb21pc2U8QXJyYXk8UGFydGlhbFJlY2lwaWVudD4+IHtcblx0XHRpZiAoIXRoaXMuc3VnZ2VzdGlvbnNQcm92aWRlcikge1xuXHRcdFx0cmV0dXJuIFtdXG5cdFx0fVxuXHRcdGNvbnN0IHJlY2lwaWVudHMgPSBhd2FpdCB0aGlzLnN1Z2dlc3Rpb25zUHJvdmlkZXIuZ2V0Q29udGFjdFN1Z2dlc3Rpb25zKHRleHQpXG5cdFx0cmV0dXJuIHJlY2lwaWVudHMubWFwKCh7IG5hbWUsIG1haWxBZGRyZXNzIH0pID0+ICh7IG5hbWUsIGFkZHJlc3M6IG1haWxBZGRyZXNzIH0pKVxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBmaW5kQ29udGFjdExpc3RzKHRleHQ6IHN0cmluZyk6IFByb21pc2U8Q29udGFjdExpc3RJbmZvW10+IHtcblx0XHRyZXR1cm4gdGhpcy5jb250YWN0TW9kZWwuc2VhcmNoRm9yQ29udGFjdExpc3RzKHRleHQpXG5cdH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFhQSxNQUFNLHVCQUF1QjtJQWNoQix3QkFBTixNQUE0QjtDQUNsQyxBQUFRLGdCQUFrRCxDQUFFO0NBQzVELEFBQVEsVUFBZ0M7Q0FFeEMsQUFBUSxlQUFlO0NBQ3ZCLEFBQVEsZ0JBQWdCO0NBQ3hCLEFBQVEsU0FBNkM7Q0FFckQsWUFDa0JBLGlCQUNBQyxjQUNBQyxxQkFD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