import { assertMainOrNode } from "./Env-chunk.js";
import { getEnabledMailAddressesWithUser, getMailboxName } from "./SharedMailUtils-chunk.js";

//#region src/common/misc/passwords/PasswordUtils.ts
assertMainOrNode();
const PASSWORD_MAX_VALUE = 80;
const PASSWORD_MIN_VALUE = 0;
const PASSWORD_MIN_SECURE_VALUE = 64;
const _BAD_SEQUENCES = [
	"^1234567890ß´",
	"°!\"§$%&/()=?`",
	"qwertzuiopü+",
	"asdfghjklöä#",
	"<yxcvbnm,.-",
	"`1234567890-=",
	"~!@#$%^&*()_+",
	"qwertyuiop[]",
	"asdfghjkl'\\",
	"\\zxcvbnm,./",
	"abcdefghijklmnopqrstuvwxyz"
];
const _BAD_STRINGS = [
	"passwort",
	"password",
	"tutanota",
	"free",
	"test",
	"keemail",
	"tutamail"
];
function getPasswordStrength(password, badStrings) {
	if (password.length === 0) return 0;
	let nbrOfLowerChars = _getNbrOfOccurrences(password, /[a-z ]/g);
	let nbrOfConsecutiveLowerChars = Math.max(0, _getLongestResult(password, /[a-z ]*/g) - 2);
	let nbrOfUpperChars = _getNbrOfOccurrences(password, /[A-Z]/g);
	let nbrOfConsecutiveUpperChars = Math.max(0, _getLongestResult(password, /[A-Z]*/g) - 2);
	let nbrOfDigits = _getNbrOfOccurrences(password, /[0-9]/g);
	let nbrOfConsecutiveDigits = Math.max(0, _getLongestResult(password, /[0-9]*/g) - 2);
	let nbrOfOtherChars = password.length - nbrOfDigits - nbrOfLowerChars - nbrOfUpperChars;
	let nbrOfConsecutiveOtherChars = Math.max(0, _getLongestResult(password, /[^a-z A-Z0-9]*/g) - 2);
	let nbrOfConsecutiveSame = Math.max(0, _getLongestResult(password, /(.)\1+/g) - 2);
	let minNbrOfCharsPerType = password.length / 4;
	let nbrOfMissingLowerChars = Math.max(0, minNbrOfCharsPerType - nbrOfLowerChars);
	let nbrOfMissingUpperChars = Math.max(0, minNbrOfCharsPerType - nbrOfUpperChars);
	let nbrOfMissingDigits = Math.max(0, minNbrOfCharsPerType - nbrOfDigits);
	let nbrOfMissingOtherChars = Math.max(0, minNbrOfCharsPerType - nbrOfOtherChars);
	let nbrOfSameChars = _getNbrOfSameChars(password);
	let nbrOfSequenceDigits = _getNbrOfSequenceChars(password.toLowerCase(), _BAD_SEQUENCES, true);
	let nbrOfBadStringDigits = _getNbrOfSequenceChars(password.toLowerCase(), badStrings.map((s) => s.toLowerCase()).concat(_BAD_STRINGS), false);
	let strength = password.length * 11;
	strength -= nbrOfMissingLowerChars * 3;
	strength -= nbrOfMissingUpperChars * 3;
	strength -= nbrOfMissingDigits * 3;
	strength -= nbrOfMissingOtherChars * 3;
	strength -= nbrOfConsecutiveLowerChars * 2;
	strength -= nbrOfConsecutiveUpperChars * 2;
	strength -= nbrOfConsecutiveDigits * 2;
	strength -= nbrOfConsecutiveOtherChars * 2;
	strength -= nbrOfConsecutiveSame * 2;
	strength -= nbrOfSameChars * 5;
	strength -= nbrOfSequenceDigits * 4;
	strength -= nbrOfBadStringDigits * 4;
	return Math.min(PASSWORD_MAX_VALUE, Math.max(PASSWORD_MIN_VALUE, Math.round(strength)));
}
function getPasswordStrengthForUser(password, recipientInfo, mailboxDetails, logins) {
	let reserved = getEnabledMailAddressesWithUser(mailboxDetails, logins.getUserController().userGroupInfo).concat(getMailboxName(logins, mailboxDetails), recipientInfo.address, recipientInfo.name ?? "");
	return Math.min(PASSWORD_MAX_VALUE, getPasswordStrength(password, reserved));
}
function scaleToVisualPasswordStrength(passwordStrength) {
	return Math.min(100, passwordStrength / PASSWORD_MAX_VALUE * 100);
}
function isSecurePassword(passwordStrength) {
	return passwordStrength >= PASSWORD_MIN_SECURE_VALUE;
}
/**
* Provides the number of repetitions of any characters in the given password at any position.
* @param password The password to check.
* @returns The number of same characters.
*/
function _getNbrOfSameChars(password) {
	const characterObject = new Set();
	for (const c of password) characterObject.add(c);
	return password.length - characterObject.size;
}
function _getNbrOfSequenceChars(password, sequences, reverseToo) {
	let s = sequences;
	if (reverseToo) s = sequences.concat(sequences.map((s1) => s1.split("").reverse().join("")));
	let MIN_SEQUENCE_LEN = 4;
	let nbrOfSequenceDigits = 0;
	for (let i = 0; i <= password.length - MIN_SEQUENCE_LEN; i++) {
		let maxFoundLen = 0;
		for (let sequenceLen = MIN_SEQUENCE_LEN; i + sequenceLen <= password.length; sequenceLen++) {
			let substringToCheck = password.substring(i, i + sequenceLen);
			for (let a = 0; a < s.length; a++) if (s[a].indexOf(substringToCheck) !== -1) {
				maxFoundLen = sequenceLen;
				break;
			}
		}
		if (maxFoundLen > 0) {
			nbrOfSequenceDigits += maxFoundLen;
			i += maxFoundLen - 1;
		}
	}
	return nbrOfSequenceDigits;
}
/**
* Gets the number of occurrences of the given regular expression in the given string.
* @param string The string to check.
* @param regexp The reqular expression to check against.
* @return The number of occurrences.
*/
function _getNbrOfOccurrences(string, regexp) {
	let result = string.match(regexp);
	return result ? result.length : 0;
}
/**
* Gets the number of characters in the longest result when checking the given string against the given regular expression.
* @param string The string to check.
* @param regexp The reqular expression to check against.
* @returns The number of characters of the longest result.
*/
function _getLongestResult(string, regexp) {
	let result = string.match(regexp);
	return result ? result.reduce((max, val) => Math.max(max, val.length), 0) : 0;
}

//#endregion
export { PASSWORD_MIN_SECURE_VALUE, getPasswordStrength, getPasswordStrengthForUser, isSecurePassword, scaleToVisualPasswordStrength };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFzc3dvcmRVdGlscy1jaHVuay5qcyIsIm5hbWVzIjpbInBhc3N3b3JkOiBzdHJpbmciLCJiYWRTdHJpbmdzOiBzdHJpbmdbXSIsInJlY2lwaWVudEluZm86IFBhcnRpYWxSZWNpcGllbnQiLCJtYWlsYm94RGV0YWlsczogTWFpbGJveERldGFpbCIsImxvZ2luczogTG9naW5Db250cm9sbGVyIiwicGFzc3dvcmRTdHJlbmd0aDogbnVtYmVyIiwic2VxdWVuY2VzOiBzdHJpbmdbXSIsInJldmVyc2VUb286IGJvb2xlYW4iLCJzdHJpbmc6IHN0cmluZyIsInJlZ2V4cDogUmVnRXhwIl0sInNvdXJjZXMiOlsiLi4vc3JjL2NvbW1vbi9taXNjL3Bhc3N3b3Jkcy9QYXNzd29yZFV0aWxzLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgTWFpbGJveERldGFpbCB9IGZyb20gXCIuLi8uLi9tYWlsRnVuY3Rpb25hbGl0eS9NYWlsYm94TW9kZWwuanNcIlxuaW1wb3J0IHR5cGUgeyBMb2dpbkNvbnRyb2xsZXIgfSBmcm9tIFwiLi4vLi4vYXBpL21haW4vTG9naW5Db250cm9sbGVyXCJcbmltcG9ydCB7IGFzc2VydE1haW5Pck5vZGUgfSBmcm9tIFwiLi4vLi4vYXBpL2NvbW1vbi9FbnZcIlxuaW1wb3J0IHsgUGFydGlhbFJlY2lwaWVudCB9IGZyb20gXCIuLi8uLi9hcGkvY29tbW9uL3JlY2lwaWVudHMvUmVjaXBpZW50XCJcbmltcG9ydCB7IGdldEVuYWJsZWRNYWlsQWRkcmVzc2VzV2l0aFVzZXIsIGdldE1haWxib3hOYW1lIH0gZnJvbSBcIi4uLy4uL21haWxGdW5jdGlvbmFsaXR5L1NoYXJlZE1haWxVdGlscy5qc1wiXG5cbmFzc2VydE1haW5Pck5vZGUoKVxuLyoqIHBhc3N3b3JkIHN0cmVuZ3RoIHJlc3VsdGluZyBpbiBhIGZ1bGwgYmFyICovXG5leHBvcnQgY29uc3QgUEFTU1dPUkRfTUFYX1ZBTFVFID0gODBcbmV4cG9ydCBjb25zdCBQQVNTV09SRF9NSU5fVkFMVUUgPSAwXG4vKiogdGhlIG1pbmltdW0gcGFzc3dvcmQgc3RyZW5ndGggd2UgYWNjZXB0LCBidXQgdGhlIHVzZXIgY2FuIGNob29zZSBhIHN0cm9uZ2VyIHBhc3N3b3JkICovXG5leHBvcnQgY29uc3QgUEFTU1dPUkRfTUlOX1NFQ1VSRV9WQUxVRSA9IDY0XG5leHBvcnQgY29uc3QgX0JBRF9TRVFVRU5DRVMgPSBbXG5cdFwiXjEyMzQ1Njc4OTDDn8K0XCIsXG5cdCfCsCFcIsKnJCUmLygpPT9gJyxcblx0XCJxd2VydHp1aW9ww7wrXCIsXG5cdFwiYXNkZmdoamtsw7bDpCNcIixcblx0XCI8eXhjdmJubSwuLVwiLFxuXHRcImAxMjM0NTY3ODkwLT1cIixcblx0XCJ+IUAjJCVeJiooKV8rXCIsXG5cdFwicXdlcnR5dWlvcFtdXCIsXG5cdFwiYXNkZmdoamtsJ1xcXFxcIixcblx0XCJcXFxcenhjdmJubSwuL1wiLFxuXHRcImFiY2RlZmdoaWprbG1ub3BxcnN0dXZ3eHl6XCIsXG5dXG5jb25zdCBfQkFEX1NUUklOR1MgPSBbXCJwYXNzd29ydFwiLCBcInBhc3N3b3JkXCIsIFwidHV0YW5vdGFcIiwgXCJmcmVlXCIsIFwidGVzdFwiLCBcImtlZW1haWxcIiwgXCJ0dXRhbWFpbFwiXVxuXG4vKipcbiAqIENoZWNrcyBob3cgc2VjdXJlIHRoZSBnaXZlbiBwYXNzd29yZCBpcy4gVGhlIGZvbGxvd2luZyBwYXNzd29yZCBjaGFyYWN0ZXJpc3RpY3MgZGVjcmVhc2UgdGhlIHBhc3N3b3JkIHN0cmVuZ3RoOlxuICogLSBpcnJlZ3VsYXIgZGlzdHJpYnV0aW9uIG9mIGNoYXJhY3RlcnMgYWNyb3NzIHRoZSBjaGFyYWN0ZXIgY2xhc3NlcyBsb3dlciBjYXNlLCB1cHBlciBjYXNlLCBkaWdpdCwgb3RoZXJcbiAqIC0gY29uc2VjdXRpdmUgY2hhcmFjdGVycyBvZiB0aGUgc2FtZSBjbGFzc1xuICogLSBzYW1lIGNoYXJzXG4gKiAtIHNhbWUgY29uc2VjdXRpdmUgY2hhcnNcbiAqIC0ga2V5Ym9hcmQgKGdlcm1hbi9lbmdsaXNoKSBvciBhbHBoYWJldCBzZXF1ZW5jZXNcbiAqIC0gYmFkIHN0cmluZ3MgKHN0YXRpY2FsbHkgZGVmaW5lZCBhbmQgcGFzc2VkIHRvIGZ1bmN0aW9uIGluIGJhZFN0cmluZ3MpXG4gKiBAcGFyYW0gcGFzc3dvcmQgVGhlIHBhc3N3b3JkIHRvIGNoZWNrLlxuICogQHBhcmFtIGJhZFN0cmluZ3MgU3RyaW5ncyB0aGF0IHJlZHVjZSB0aGUgc3RyZW5ndGggb2YgdGhlIHBhc3N3b3JkLlxuICogQHJldHVybiBBIG51bWJlciBmcm9tIDAgdG8gUEFTU1dPUkRfTUFYX1ZBTFVFLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGFzc3dvcmRTdHJlbmd0aChwYXNzd29yZDogc3RyaW5nLCBiYWRTdHJpbmdzOiBzdHJpbmdbXSk6IG51bWJlciB7XG5cdGlmIChwYXNzd29yZC5sZW5ndGggPT09IDApIHJldHVybiAwXG5cblx0Ly8gY2FsY3VsYXRlIHRoZSBjaGFyYWN0ZXJpc3RpY3Mgb2YgdGhlIHBhc3N3b3JkXG5cdGxldCBuYnJPZkxvd2VyQ2hhcnMgPSBfZ2V0TmJyT2ZPY2N1cnJlbmNlcyhwYXNzd29yZCwgL1thLXogXS9nKVxuXG5cdGxldCBuYnJPZkNvbnNlY3V0aXZlTG93ZXJDaGFycyA9IE1hdGgubWF4KDAsIF9nZXRMb25nZXN0UmVzdWx0KHBhc3N3b3JkLCAvW2EteiBdKi9nKSAtIDIpIC8vIGNvbnNlY3V0aXZlIGNoYXJzID4gMlxuXG5cdGxldCBuYnJPZlVwcGVyQ2hhcnMgPSBfZ2V0TmJyT2ZPY2N1cnJlbmNlcyhwYXNzd29yZCwgL1tBLVpdL2cpXG5cblx0bGV0IG5ick9mQ29uc2VjdXRpdmVVcHBlckNoYXJzID0gTWF0aC5tYXgoMCwgX2dldExvbmdlc3RSZXN1bHQocGFzc3dvcmQsIC9bQS1aXSovZykgLSAyKVxuXG5cdGxldCBuYnJPZkRpZ2l0cyA9IF9nZXROYnJPZk9jY3VycmVuY2VzKHBhc3N3b3JkLCAvWzAtOV0vZylcblxuXHRsZXQgbmJyT2ZDb25zZWN1dGl2ZURpZ2l0cyA9IE1hdGgubWF4KDAsIF9nZXRMb25nZXN0UmVzdWx0KHBhc3N3b3JkLCAvWzAtOV0qL2cpIC0gMilcblx0bGV0IG5ick9mT3RoZXJDaGFycyA9IHBhc3N3b3JkLmxlbmd0aCAtIG5ick9mRGlnaXRzIC0gbmJyT2ZMb3dlckNoYXJzIC0gbmJyT2ZVcHBlckNoYXJzXG5cdGxldCBuYnJPZkNvbnNlY3V0aXZlT3RoZXJDaGFycyA9IE1hdGgubWF4KDAsIF9nZXRMb25nZXN0UmVzdWx0KHBhc3N3b3JkLCAvW15hLXogQS1aMC05XSovZykgLSAyKVxuXHRsZXQgbmJyT2ZDb25zZWN1dGl2ZVNhbWUgPSBNYXRoLm1heCgwLCBfZ2V0TG9uZ2VzdFJlc3VsdChwYXNzd29yZCwgLyguKVxcMSsvZykgLSAyKVxuXHRsZXQgbWluTmJyT2ZDaGFyc1BlclR5cGUgPSBwYXNzd29yZC5sZW5ndGggLyA0IC8vIGJlc3QgaXMgMS80IGxvd2VyIGNhc2UsIDEvNCB1cHBlciBjYXNlLCAxLzQgZGlnaXRzLCAxLzQgb3RoZXIgY2hhcnNcblxuXHQvLyBhbGwgdGhlc2UgdmFsdWVzIGRlY3JlYXNlIHRoZSBzdHJlbmd0aFxuXHRsZXQgbmJyT2ZNaXNzaW5nTG93ZXJDaGFycyA9IE1hdGgubWF4KDAsIG1pbk5ick9mQ2hhcnNQZXJUeXBlIC0gbmJyT2ZMb3dlckNoYXJzKVxuXHRsZXQgbmJyT2ZNaXNzaW5nVXBwZXJDaGFycyA9IE1hdGgubWF4KDAsIG1pbk5ick9mQ2hhcnNQZXJUeXBlIC0gbmJyT2ZVcHBlckNoYXJzKVxuXHRsZXQgbmJyT2ZNaXNzaW5nRGlnaXRzID0gTWF0aC5tYXgoMCwgbWluTmJyT2ZDaGFyc1BlclR5cGUgLSBuYnJPZkRpZ2l0cylcblx0bGV0IG5ick9mTWlzc2luZ090aGVyQ2hhcnMgPSBNYXRoLm1heCgwLCBtaW5OYnJPZkNoYXJzUGVyVHlwZSAtIG5ick9mT3RoZXJDaGFycylcblxuXHRsZXQgbmJyT2ZTYW1lQ2hhcnMgPSBfZ2V0TmJyT2ZTYW1lQ2hhcnMocGFzc3dvcmQpXG5cblx0bGV0IG5ick9mU2VxdWVuY2VEaWdpdHMgPSBfZ2V0TmJyT2ZTZXF1ZW5jZUNoYXJzKHBhc3N3b3JkLnRvTG93ZXJDYXNlKCksIF9CQURfU0VRVUVOQ0VTLCB0cnVlKVxuXG5cdGxldCBuYnJPZkJhZFN0cmluZ0RpZ2l0cyA9IF9nZXROYnJPZlNlcXVlbmNlQ2hhcnMocGFzc3dvcmQudG9Mb3dlckNhc2UoKSwgYmFkU3RyaW5ncy5tYXAoKHMpID0+IHMudG9Mb3dlckNhc2UoKSkuY29uY2F0KF9CQURfU1RSSU5HUyksIGZhbHNlKVxuXG5cdGxldCBzdHJlbmd0aCA9IHBhc3N3b3JkLmxlbmd0aCAqIDExIC8vIDExID0gc3RyZW5ndGggcGVyIGNoYXJhY3RlciB3aXRob3V0IHJlZHVjdGlvblxuXG5cdHN0cmVuZ3RoIC09IG5ick9mTWlzc2luZ0xvd2VyQ2hhcnMgKiAzXG5cdHN0cmVuZ3RoIC09IG5ick9mTWlzc2luZ1VwcGVyQ2hhcnMgKiAzXG5cdHN0cmVuZ3RoIC09IG5ick9mTWlzc2luZ0RpZ2l0cyAqIDNcblx0c3RyZW5ndGggLT0gbmJyT2ZNaXNzaW5nT3RoZXJDaGFycyAqIDNcblx0c3RyZW5ndGggLT0gbmJyT2ZDb25zZWN1dGl2ZUxvd2VyQ2hhcnMgKiAyXG5cdHN0cmVuZ3RoIC09IG5ick9mQ29uc2VjdXRpdmVVcHBlckNoYXJzICogMlxuXHRzdHJlbmd0aCAtPSBuYnJPZkNvbnNlY3V0aXZlRGlnaXRzICogMlxuXHRzdHJlbmd0aCAtPSBuYnJPZkNvbnNlY3V0aXZlT3RoZXJDaGFycyAqIDJcblx0c3RyZW5ndGggLT0gbmJyT2ZDb25zZWN1dGl2ZVNhbWUgKiAyXG5cdHN0cmVuZ3RoIC09IG5ick9mU2FtZUNoYXJzICogNVxuXHRzdHJlbmd0aCAtPSBuYnJPZlNlcXVlbmNlRGlnaXRzICogNFxuXHRzdHJlbmd0aCAtPSBuYnJPZkJhZFN0cmluZ0RpZ2l0cyAqIDRcblx0cmV0dXJuIE1hdGgubWluKFBBU1NXT1JEX01BWF9WQUxVRSwgTWF0aC5tYXgoUEFTU1dPUkRfTUlOX1ZBTFVFLCBNYXRoLnJvdW5kKHN0cmVuZ3RoKSkpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRQYXNzd29yZFN0cmVuZ3RoRm9yVXNlcihwYXNzd29yZDogc3RyaW5nLCByZWNpcGllbnRJbmZvOiBQYXJ0aWFsUmVjaXBpZW50LCBtYWlsYm94RGV0YWlsczogTWFpbGJveERldGFpbCwgbG9naW5zOiBMb2dpbkNvbnRyb2xsZXIpOiBudW1iZXIge1xuXHRsZXQgcmVzZXJ2ZWQgPSBnZXRFbmFibGVkTWFpbEFkZHJlc3Nlc1dpdGhVc2VyKG1haWxib3hEZXRhaWxzLCBsb2dpbnMuZ2V0VXNlckNvbnRyb2xsZXIoKS51c2VyR3JvdXBJbmZvKS5jb25jYXQoXG5cdFx0Z2V0TWFpbGJveE5hbWUobG9naW5zLCBtYWlsYm94RGV0YWlscyksXG5cdFx0cmVjaXBpZW50SW5mby5hZGRyZXNzLFxuXHRcdHJlY2lwaWVudEluZm8ubmFtZSA/PyBcIlwiLFxuXHQpXG5cdHJldHVybiBNYXRoLm1pbihQQVNTV09SRF9NQVhfVkFMVUUsIGdldFBhc3N3b3JkU3RyZW5ndGgocGFzc3dvcmQsIHJlc2VydmVkKSlcbn1cblxuLyoqXG4gKiBNYXBzIHRoZSBwYXNzd29yZCBzdHJlbmd0aCBmcm9tIHRoZSByYW5nZSAwIHRvIFBBU1NXT1JEX01BWF9WQUxVRSB0byB0aGUgcmFuZ2UgMCUgdG8gMTAwJS4gVGhlcmVmb3JlLCBpZiBhIHBhc3N3b3JkIHJlYWNoZXMgdGhlIFBBU1NXT1JEX01JTl9TRUNVUkVfVkFMVUUgaXQgaXMgbm90IGF0IDEwMCUgeWV0LlxuICogQHJldHVybiBBIHZhbHVlIGluZGljYXRpbmcgdGhlIHBhc3N3b3JkIHN0cmVuZ3RoIGJldHdlZW4gMCBhbmQgMTAwLlxuICovXG5leHBvcnQgZnVuY3Rpb24gc2NhbGVUb1Zpc3VhbFBhc3N3b3JkU3RyZW5ndGgocGFzc3dvcmRTdHJlbmd0aDogbnVtYmVyKTogbnVtYmVyIHtcblx0cmV0dXJuIE1hdGgubWluKDEwMCwgKHBhc3N3b3JkU3RyZW5ndGggLyBQQVNTV09SRF9NQVhfVkFMVUUpICogMTAwKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNTZWN1cmVQYXNzd29yZChwYXNzd29yZFN0cmVuZ3RoOiBudW1iZXIpOiBib29sZWFuIHtcblx0cmV0dXJuIHBhc3N3b3JkU3RyZW5ndGggPj0gUEFTU1dPUkRfTUlOX1NFQ1VSRV9WQUxVRVxufVxuXG4vKipcbiAqIFByb3ZpZGVzIHRoZSBudW1iZXIgb2YgcmVwZXRpdGlvbnMgb2YgYW55IGNoYXJhY3RlcnMgaW4gdGhlIGdpdmVuIHBhc3N3b3JkIGF0IGFueSBwb3NpdGlvbi5cbiAqIEBwYXJhbSBwYXNzd29yZCBUaGUgcGFzc3dvcmQgdG8gY2hlY2suXG4gKiBAcmV0dXJucyBUaGUgbnVtYmVyIG9mIHNhbWUgY2hhcmFjdGVycy5cbiAqL1xuZnVuY3Rpb24gX2dldE5ick9mU2FtZUNoYXJzKHBhc3N3b3JkOiBzdHJpbmcpOiBudW1iZXIge1xuXHRjb25zdCBjaGFyYWN0ZXJPYmplY3QgPSBuZXcgU2V0PHN0cmluZz4oKVxuXG5cdGZvciAoY29uc3QgYyBvZiBwYXNzd29yZCkge1xuXHRcdGNoYXJhY3Rlck9iamVjdC5hZGQoYylcblx0fVxuXG5cdHJldHVybiBwYXNzd29yZC5sZW5ndGggLSBjaGFyYWN0ZXJPYmplY3Quc2l6ZVxufVxuXG4vKipcbiAqIFByb3ZpZGVzIHRoZSBudW1iZXIgb2YgY2hhcnMgaW4gdGhlIGdpdmVuIHBhc3N3b3JkIHRoYXQgY29udGFpbnMgcGFydHMgKD4gMiBjaGFyYWN0ZXJzKSBvZiB0aGUgZ2l2ZW4gc2VxdWVuY2VzLlxuICogQHBhcmFtIHBhc3N3b3JkIFRoZSBwYXNzd29yZCB0byBjaGVjay5cbiAqIEBwYXJhbSBzZXF1ZW5jZXMgVGhlIHNlcXVlbmNlcyB0byBjaGVjay5cbiAqIEBwYXJhbSByZXZlcnNlVG9vIElmIHRydWUsIGFsc28gYWxsIHJldmVyc2Ugc2VxdWVuY2VzIGFyZSBjaGVja2VkLlxuICogQHJldHVybnMgVGhlIG51bWJlciBvZiBjaGFycyB0aGF0IG1hdGNoIGFueSBzZXF1ZW5jZXMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBfZ2V0TmJyT2ZTZXF1ZW5jZUNoYXJzKHBhc3N3b3JkOiBzdHJpbmcsIHNlcXVlbmNlczogc3RyaW5nW10sIHJldmVyc2VUb286IGJvb2xlYW4pOiBudW1iZXIge1xuXHQvLyBhbGwgc2VxdWVuY2VzIHRvIHRoZSBsaXN0IG9mIGNoZWNrZWQgc2VxdWVuY2VzIHMuIGFsc28gYWRkIGFsbCByZXZlcnNlIHNlcXVlbmNlcyBpZiByZXF1ZXN0ZWRcblx0bGV0IHMgPSBzZXF1ZW5jZXNcblxuXHRpZiAocmV2ZXJzZVRvbykge1xuXHRcdHMgPSBzZXF1ZW5jZXMuY29uY2F0KHNlcXVlbmNlcy5tYXAoKHMxKSA9PiBzMS5zcGxpdChcIlwiKS5yZXZlcnNlKCkuam9pbihcIlwiKSkpXG5cdH1cblxuXHRsZXQgTUlOX1NFUVVFTkNFX0xFTiA9IDRcblx0bGV0IG5ick9mU2VxdWVuY2VEaWdpdHMgPSAwXG5cblx0Ly8gY2hlY2sgdGhlIHBhcnQgb2YgdGhlIHBhc3N3b3JkIChzdWJzdHJpbmdUb0NoZWNrKSBmcm9tIGkgdG8gaStzZXF1ZW5jZUxlbiBpbiBhIGxvb3Bcblx0Zm9yIChsZXQgaSA9IDA7IGkgPD0gcGFzc3dvcmQubGVuZ3RoIC0gTUlOX1NFUVVFTkNFX0xFTjsgaSsrKSB7XG5cdFx0bGV0IG1heEZvdW5kTGVuID0gMFxuXG5cdFx0Zm9yIChsZXQgc2VxdWVuY2VMZW4gPSBNSU5fU0VRVUVOQ0VfTEVOOyBpICsgc2VxdWVuY2VMZW4gPD0gcGFzc3dvcmQubGVuZ3RoOyBzZXF1ZW5jZUxlbisrKSB7XG5cdFx0XHRsZXQgc3Vic3RyaW5nVG9DaGVjayA9IHBhc3N3b3JkLnN1YnN0cmluZyhpLCBpICsgc2VxdWVuY2VMZW4pXG5cblx0XHRcdGZvciAobGV0IGEgPSAwOyBhIDwgcy5sZW5ndGg7IGErKykge1xuXHRcdFx0XHRpZiAoc1thXS5pbmRleE9mKHN1YnN0cmluZ1RvQ2hlY2spICE9PSAtMSkge1xuXHRcdFx0XHRcdG1heEZvdW5kTGVuID0gc2VxdWVuY2VMZW5cblx0XHRcdFx0XHRicmVha1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0aWYgKG1heEZvdW5kTGVuID4gMCkge1xuXHRcdFx0bmJyT2ZTZXF1ZW5jZURpZ2l0cyArPSBtYXhGb3VuZExlblxuXHRcdFx0aSArPSBtYXhGb3VuZExlbiAtIDEgLy8gc2tpcCB0aGUgZm91bmQgc2VxdWVuY2UuIC0xIGJlY2F1c2UgdGhlIGZvciBsb29wIGFsc28gZGVjcmVhc2VzIGJ5IDFcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gbmJyT2ZTZXF1ZW5jZURpZ2l0c1xufVxuXG4vKipcbiAqIEdldHMgdGhlIG51bWJlciBvZiBvY2N1cnJlbmNlcyBvZiB0aGUgZ2l2ZW4gcmVndWxhciBleHByZXNzaW9uIGluIHRoZSBnaXZlbiBzdHJpbmcuXG4gKiBAcGFyYW0gc3RyaW5nIFRoZSBzdHJpbmcgdG8gY2hlY2suXG4gKiBAcGFyYW0gcmVnZXhwIFRoZSByZXF1bGFyIGV4cHJlc3Npb24gdG8gY2hlY2sgYWdhaW5zdC5cbiAqIEByZXR1cm4gVGhlIG51bWJlciBvZiBvY2N1cnJlbmNlcy5cbiAqL1xuZnVuY3Rpb24gX2dldE5ick9mT2NjdXJyZW5jZXMoc3RyaW5nOiBzdHJpbmcsIHJlZ2V4cDogUmVnRXhwKTogbnVtYmVyIHtcblx0bGV0IHJlc3VsdCA9IHN0cmluZy5tYXRjaChyZWdleHApXG5cdHJldHVybiByZXN1bHQgPyByZXN1bHQubGVuZ3RoIDogMFxufVxuXG4vKipcbiAqIEdldHMgdGhlIG51bWJlciBvZiBjaGFyYWN0ZXJzIGluIHRoZSBsb25nZXN0IHJlc3VsdCB3aGVuIGNoZWNraW5nIHRoZSBnaXZlbiBzdHJpbmcgYWdhaW5zdCB0aGUgZ2l2ZW4gcmVndWxhciBleHByZXNzaW9uLlxuICogQHBhcmFtIHN0cmluZyBUaGUgc3RyaW5nIHRvIGNoZWNrLlxuICogQHBhcmFtIHJlZ2V4cCBUaGUgcmVxdWxhciBleHByZXNzaW9uIHRvIGNoZWNrIGFnYWluc3QuXG4gKiBAcmV0dXJucyBUaGUgbnVtYmVyIG9mIGNoYXJhY3RlcnMgb2YgdGhlIGxvbmdlc3QgcmVzdWx0LlxuICovXG5mdW5jdGlvbiBfZ2V0TG9uZ2VzdFJlc3VsdChzdHJpbmc6IHN0cmluZywgcmVnZXhwOiBSZWdFeHApOiBudW1iZXIge1xuXHRsZXQgcmVzdWx0ID0gc3RyaW5nLm1hdGNoKHJlZ2V4cClcblx0cmV0dXJuIHJlc3VsdCA/IHJlc3VsdC5yZWR1Y2UoKG1heCwgdmFsKSA9PiBNYXRoLm1heChtYXgsIHZhbC5sZW5ndGgpLCAwKSA6IDBcbn1cbiJdLCJtYXBwaW5ncyI6Ijs7OztBQU1BLGtCQUFrQjtNQUVMLHFCQUFxQjtNQUNyQixxQkFBcUI7TUFFckIsNEJBQTRCO01BQzVCLGlCQUFpQjtDQUM3QjtDQUNBO0NBQ0E7Q0FDQTtDQUNBO0NBQ0E7Q0FDQTtDQUNBO0NBQ0E7Q0FDQTtDQUNBO0FBQ0E7QUFDRCxNQUFNLGVBQWU7Q0FBQztDQUFZO0NBQVk7Q0FBWTtDQUFRO0NBQVE7Q0FBVztBQUFXO0FBY3pGLFNBQVMsb0JBQW9CQSxVQUFrQkMsWUFBOEI7QUFDbkYsS0FBSSxTQUFTLFdBQVcsRUFBRyxRQUFPO0NBR2xDLElBQUksa0JBQWtCLHFCQUFxQixVQUFVLFVBQVU7Q0FFL0QsSUFBSSw2QkFBNkIsS0FBSyxJQUFJLEdBQUcsa0JBQWtCLFVBQVUsV0FBVyxHQUFHLEVBQUU7Q0FFekYsSUFBSSxrQkFBa0IscUJBQXFCLFVBQVUsU0FBUztDQUU5RCxJQUFJLDZCQUE2QixLQUFLLElBQUksR0FBRyxrQkFBa0IsVUFBVSxVQUFVLEdBQUcsRUFBRTtDQUV4RixJQUFJLGNBQWMscUJBQXFCLFVBQVUsU0FBUztDQUUxRCxJQUFJLHlCQUF5QixLQUFLLElBQUksR0FBRyxrQkFBa0IsVUFBVSxVQUFVLEdBQUcsRUFBRTtDQUNwRixJQUFJLGtCQUFrQixTQUFTLFNBQVMsY0FBYyxrQkFBa0I7Q0FDeEUsSUFBSSw2QkFBNkIsS0FBSyxJQUFJLEdBQUcsa0JBQWtCLFVBQVUsa0JBQWtCLEdBQUcsRUFB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