import "./dist-chunk.js";
import "./ProgrammingError-chunk.js";
import { LOGIN_TITLE, isAdminClient, isApp, isDesktop, isIOSApp } from "./Env-chunk.js";
import "./ClientDetector-chunk.js";
import { mithril_default } from "./mithril-chunk.js";
import { assertNotNull, defer, delay, neverNull, noOp, ofClass } from "./dist2-chunk.js";
import { getThemeCustomizations } from "./WhitelabelCustomizations-chunk.js";
import { lang } from "./LanguageViewModel-chunk.js";
import "./styles-chunk.js";
import "./theme-chunk.js";
import { CloseEventBusOption, Const, SecondFactorType } from "./TutanotaConstants-chunk.js";
import "./KeyManager-chunk.js";
import { windowFacade } from "./WindowFacade-chunk.js";
import "./RootView-chunk.js";
import "./size-chunk.js";
import "./HtmlUtils-chunk.js";
import "./luxon-chunk.js";
import "./EntityUtils-chunk.js";
import "./TypeModels-chunk.js";
import { createReceiveInfoServiceData } from "./TypeRefs-chunk.js";
import "./CommonCalendarUtils-chunk.js";
import "./TypeModels2-chunk.js";
import { CustomerTypeRef, SecondFactorTypeRef, createCustomerProperties } from "./TypeRefs2-chunk.js";
import "./ParserCombinator-chunk.js";
import "./CalendarUtils-chunk.js";
import "./ImportExportUtils-chunk.js";
import "./FormatValidator-chunk.js";
import "./stream-chunk.js";
import { deviceConfig } from "./DeviceConfig-chunk.js";
import "./Logger-chunk.js";
import "./EntityFunctions-chunk.js";
import "./TypeModels3-chunk.js";
import "./ModelInfo-chunk.js";
import "./ErrorUtils-chunk.js";
import { LockedError } from "./RestError-chunk.js";
import "./OutOfSyncError-chunk.js";
import "./CancelledError-chunk.js";
import "./SuspensionError-chunk.js";
import "./LoginIncompleteError-chunk.js";
import "./CryptoError-chunk.js";
import "./error-chunk.js";
import "./RecipientsNotFoundError-chunk.js";
import "./DbError-chunk.js";
import "./QuotaExceededError-chunk.js";
import "./DeviceStorageUnavailableError-chunk.js";
import "./MailBodyTooLargeError-chunk.js";
import "./ImportError-chunk.js";
import "./WebauthnError-chunk.js";
import "./PermissionError-chunk.js";
import { isUpdateForTypeRef } from "./EntityUpdateUtils-chunk.js";
import { SessionType } from "./SessionType-chunk.js";
import "./CredentialType-chunk.js";
import "./RestClient-chunk.js";
import { ReceiveInfoService } from "./Services2-chunk.js";
import "./GroupUtils-chunk.js";
import { ButtonType } from "./Button-chunk.js";
import "./Icons-chunk.js";
import "./DialogHeaderBar-chunk.js";
import "./CountryList-chunk.js";
import { Dialog } from "./Dialog-chunk.js";
import "./Icon-chunk.js";
import "./AriaUtils-chunk.js";
import "./IconButton-chunk.js";
import { getHourCycle } from "./Formatter-chunk.js";
import { notifications } from "./Notifications-chunk.js";
import { locator } from "./CommonLocator-chunk.js";
import "./UserError-chunk.js";
import "./MailAddressParser-chunk.js";
import "./BlobUtils-chunk.js";
import "./FileUtils-chunk.js";
import "./ProgressDialog-chunk.js";
import "./SharedMailUtils-chunk.js";
import "./PasswordUtils-chunk.js";
import "./Recipient-chunk.js";
import { showMoreStorageNeededOrderDialog } from "./SubscriptionDialogs-chunk.js";
import "./ExternalLink-chunk.js";
import "./ToggleButton-chunk.js";
import "./SnackBar-chunk.js";
import "./Credentials-chunk.js";
import { show } from "./NotificationOverlay-chunk.js";
import "./Checkbox-chunk.js";
import "./Expander-chunk.js";
import "./ClipboardUtils-chunk.js";
import "./Services4-chunk.js";
import "./BubbleButton-chunk.js";
import "./ErrorReporter-chunk.js";
import "./PasswordField-chunk.js";
import "./PasswordRequestDialog-chunk.js";
import "./ErrorHandlerImpl-chunk.js";
import "./LoginScreenHeader-chunk.js";
import "./LoginButton-chunk.js";
import { checkApprovalStatus } from "./LoginUtils-chunk.js";
import { StorageBehavior } from "./UsageTestModel-chunk.js";
import { CredentialEncryptionMode } from "./CredentialEncryptionMode-chunk.js";
import { isNotificationCurrentlyActive, loadOutOfOfficeNotification } from "./OutOfOfficeNotificationUtils-chunk.js";
import { usingKeychainAuthenticationWithOptions } from "./CredentialsProvider-chunk.js";

//#region src/common/login/PostLoginUtils.ts
const reminderCutoffDate = new Date("2023-09-20T13:00:00.000Z");
async function shouldShowUpgradeReminder(userController, date) {
	if (!userController.isGlobalAdmin() || await userController.isNewPaidPlan() || isIOSApp()) return false;
	const customerInfo = await userController.loadCustomerInfo();
	const customerProperties = await userController.loadCustomerProperties();
	if (userController.isFreeAccount()) {
		const isOldEnoughForInitialReminder = customerProperties.lastUpgradeReminder == null && date.getTime() - customerInfo.creationTime.getTime() > Const.INITIAL_UPGRADE_REMINDER_INTERVAL_MS;
		const wasRemindedLongAgo = customerProperties.lastUpgradeReminder != null && date.getTime() - customerProperties.lastUpgradeReminder.getTime() > Const.REPEATED_UPGRADE_REMINDER_INTERVAL_MS;
		return isOldEnoughForInitialReminder || wasRemindedLongAgo;
	} else if (!(await userController.loadCustomer()).businessUse) return customerProperties.lastUpgradeReminder == null || customerProperties.lastUpgradeReminder.getTime() < reminderCutoffDate.getTime();
else return false;
}
async function shouldShowStorageWarning(userController, userManagementFacade, customerFacade) {
	const customerInfo = await userController.loadCustomerInfo();
	if (await userController.isNewPaidPlan() || userController.isFreeAccount()) {
		const usedStorage = await userManagementFacade.readUsedUserStorage(userController.user);
		return isOverStorageLimit(usedStorage, Number(customerInfo.perUserStorageCapacity) * Const.MEMORY_GB_FACTOR);
	} else {
		if (!userController.isGlobalAdmin()) return false;
		const customerId = assertNotNull(userController.user.customer);
		const usedStorage = await customerFacade.readUsedCustomerStorage(customerId);
		if (Number(usedStorage) > Const.MEMORY_GB_FACTOR * Const.MEMORY_WARNING_FACTOR) {
			const availableStorage = await customerFacade.readAvailableCustomerStorage(customerId);
			return isOverStorageLimit(usedStorage, availableStorage);
		} else return false;
	}
}
function isOverStorageLimit(usedStorageInBytes, availableStorageInBytes) {
	return usedStorageInBytes > availableStorageInBytes * Const.MEMORY_WARNING_FACTOR;
}

//#endregion
//#region src/common/login/PostLoginActions.ts
var PostLoginActions = class {
	constructor(credentialsProvider, secondFactorHandler, connectivityModel, logins, dateProvider, entityClient, userManagementFacade, customerFacade, themeController, showSetupWizard, syncExternalCalendars, setUpClientOnlyCalendars) {
		this.credentialsProvider = credentialsProvider;
		this.secondFactorHandler = secondFactorHandler;
		this.connectivityModel = connectivityModel;
		this.logins = logins;
		this.dateProvider = dateProvider;
		this.entityClient = entityClient;
		this.userManagementFacade = userManagementFacade;
		this.customerFacade = customerFacade;
		this.themeController = themeController;
		this.showSetupWizard = showSetupWizard;
		this.syncExternalCalendars = syncExternalCalendars;
		this.setUpClientOnlyCalendars = setUpClientOnlyCalendars;
	}
	async onPartialLoginSuccess(loggedInEvent) {
		windowFacade.addOnlineListener(() => {
			console.log(new Date().toISOString(), "online - try reconnect");
			if (this.logins.isFullyLoggedIn()) this.connectivityModel.tryReconnect(true, true, 2e3);
else this.logins.retryAsyncLogin();
		});
		windowFacade.addOfflineListener(() => {
			console.log(new Date().toISOString(), "offline - pause event bus");
			this.connectivityModel.close(CloseEventBusOption.Pause);
		});
		if (!this.logins.getUserController().isInternalUser()) {
			if (document.title === LOGIN_TITLE) document.title = "Tuta Mail";
			return;
		} else {
			let postLoginTitle = document.title === LOGIN_TITLE ? "Tuta Mail" : document.title;
			document.title = neverNull(this.logins.getUserController().userGroupInfo.mailAddress) + " - " + postLoginTitle;
		}
		notifications.requestPermission();
		if (loggedInEvent.sessionType === SessionType.Persistent && usingKeychainAuthenticationWithOptions() && await this.credentialsProvider.getCredentialEncryptionMode() == null) await this.credentialsProvider.setCredentialEncryptionMode(CredentialEncryptionMode.DEVICE_LOCK);
		lang.updateFormats({ hourCycle: getHourCycle(this.logins.getUserController().userSettingsGroupRoot) });
		if (isApp() || isDesktop()) await this.storeNewCustomThemes();
	}
	async onFullLoginSuccess(loggedInEvent) {
		if (loggedInEvent.sessionType === SessionType.Temporary || !this.logins.getUserController().isInternalUser()) return;
		this.fullLoginAsyncActions();
		this.showSetupWizardIfNeeded();
	}
	checkApprovalAfterSync() {
		const listenerDeferral = defer();
		const listener = async (updates) => {
			const customer = this.logins.getUserController().user.customer;
			const isCustomerUpdate = updates.some((update) => isUpdateForTypeRef(CustomerTypeRef, update) && update.instanceId === customer);
			if (customer != null && isCustomerUpdate) listenerDeferral.resolve();
		};
		locator.eventController.addEntityListener(listener);
		const timeoutPromise = delay(2e3);
		return Promise.race([listenerDeferral.promise, timeoutPromise]).then(() => {
			locator.eventController.removeEntityListener(listener);
			checkApprovalStatus(this.logins, true);
		});
	}
	async fullLoginAsyncActions() {
		this.checkApprovalAfterSync();
		await this.showUpgradeReminderIfNeeded();
		await this.checkStorageLimit();
		this.secondFactorHandler.setupAcceptOtherClientLoginListener();
		if (!isAdminClient()) {
			await locator.mailboxModel.init();
			const calendarModel = await locator.calendarModel();
			await calendarModel.init();
			await this.remindActiveOutOfOfficeNotification();
		}
		if (isApp() || isDesktop()) {
			if (isApp() && deviceConfig.getIsSetupComplete() || isDesktop()) await locator.pushService.register();
else console.log("Skipping registering for notifications while setup dialog is shown");
			this.syncExternalCalendars();
		}
		this.setUpClientOnlyCalendars();
		if (this.logins.isGlobalAdminUserLoggedIn() && !isAdminClient()) {
			const receiveInfoData = createReceiveInfoServiceData({ language: lang.code });
			locator.serviceExecutor.post(ReceiveInfoService, receiveInfoData);
		}
		this.enforcePasswordChange();
		const usageTestModel = locator.usageTestModel;
		await usageTestModel.init();
		usageTestModel.setStorageBehavior(StorageBehavior.Persist);
		locator.usageTestController.setTests(await usageTestModel.loadActiveUsageTests());
		await locator.newsModel.loadNewsIds();
		mithril_default.redraw();
	}
	deactivateOutOfOfficeNotification(notification) {
		notification.enabled = false;
		return this.entityClient.update(notification);
	}
	remindActiveOutOfOfficeNotification() {
		return loadOutOfOfficeNotification().then((notification) => {
			if (notification && isNotificationCurrentlyActive(notification, new Date())) {
				const notificationMessage = { view: () => {
					return mithril_default("", lang.get("outOfOfficeReminder_label"));
				} };
				show(notificationMessage, { label: "close_alt" }, [{
					label: "deactivate_action",
					click: () => this.deactivateOutOfOfficeNotification(notification),
					type: ButtonType.Primary
				}]);
			}
		});
	}
	async storeNewCustomThemes() {
		const domainInfoAndConfig = await this.logins.getUserController().loadWhitelabelConfig();
		if (domainInfoAndConfig && domainInfoAndConfig.whitelabelConfig.jsonTheme) {
			const customizations = getThemeCustomizations(domainInfoAndConfig.whitelabelConfig);
			if (Object.keys(customizations).length > 0) {
				if (!customizations.themeId) customizations.themeId = domainInfoAndConfig.domainInfo.domain;
				await this.themeController.storeCustomThemeForCustomizations(customizations);
				const previouslySavedThemes = await this.themeController.getCustomThemes();
				const isExistingTheme = previouslySavedThemes.includes(domainInfoAndConfig.domainInfo.domain);
				if (isExistingTheme) await this.themeController.reloadTheme();
			}
		}
	}
	async checkStorageLimit() {
		if (await shouldShowStorageWarning(this.logins.getUserController(), this.userManagementFacade, this.customerFacade)) await showMoreStorageNeededOrderDialog("insufficientStorageWarning_msg");
	}
	async showUpgradeReminderIfNeeded() {
		if (await shouldShowUpgradeReminder(this.logins.getUserController(), new Date(this.dateProvider.now()))) {
			const confirmed = await Dialog.reminder(lang.get("upgradeReminderTitle_msg"), lang.get("premiumOffer_msg"));
			if (confirmed) {
				const wizard = await import("./UpgradeSubscriptionWizard-chunk.js");
				await wizard.showUpgradeWizard(this.logins);
			}
			const newCustomerProperties = createCustomerProperties(await this.logins.getUserController().loadCustomerProperties());
			newCustomerProperties.lastUpgradeReminder = new Date(this.dateProvider.now());
			this.entityClient.update(newCustomerProperties).catch(ofClass(LockedError, noOp));
		}
	}
	async enforcePasswordChange() {
		if (this.logins.getUserController().user.requirePasswordUpdate) {
			const { showChangeOwnPasswordDialog } = await import("./ChangePasswordDialogs2-chunk.js");
			await showChangeOwnPasswordDialog(false);
		}
		if (location.hostname === Const.DEFAULT_APP_DOMAIN) {
			const user = this.logins.getUserController().user;
			const secondFactors = await this.entityClient.loadAll(SecondFactorTypeRef, assertNotNull(user.auth).secondFactors);
			const webauthnFactors = secondFactors.filter((f) => f.type === SecondFactorType.webauthn || f.type === SecondFactorType.u2f);
			if (webauthnFactors.length > 0 && !webauthnFactors.some((f) => f.u2f && f.u2f?.appId == Const.WEBAUTHN_RP_ID)) {
				const dialog = Dialog.confirmMultiple("noKeysForThisDomain_msg", [{
					label: "skip_action",
					type: ButtonType.Secondary,
					click: () => dialog.close()
				}, {
					label: "settings_label",
					type: ButtonType.Primary,
					click: () => {
						dialog.close();
						mithril_default.route.set("/settings/login");
					}
				}]);
			}
		}
	}
	async showSetupWizardIfNeeded() {
		const isSetupComplete = deviceConfig.getIsSetupComplete();
		if (isApp() && !isSetupComplete) await this.showSetupWizard();
	}
};

//#endregion
export { PostLoginActions };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUG9zdExvZ2luQWN0aW9ucy1jaHVuay5qcyIsIm5hbWVzIjpbInVzZXJDb250cm9sbGVyOiBVc2VyQ29udHJvbGxlciIsImRhdGU6IERhdGUiLCJ1c2VyTWFuYWdlbWVudEZhY2FkZTogVXNlck1hbmFnZW1lbnRGYWNhZGUiLCJjdXN0b21lckZhY2FkZTogQ3VzdG9tZXJGYWNhZGUiLCJ1c2VkU3RvcmFnZUluQnl0ZXM6IG51bWJlciIsImF2YWlsYWJsZVN0b3JhZ2VJbkJ5dGVzOiBudW1iZXIiLCJjcmVkZW50aWFsc1Byb3ZpZGVyOiBDcmVkZW50aWFsc1Byb3ZpZGVyIiwic2Vjb25kRmFjdG9ySGFuZGxlcjogU2Vjb25kRmFjdG9ySGFuZGxlciIsImNvbm5lY3Rpdml0eU1vZGVsOiBXZWJzb2NrZXRDb25uZWN0aXZpdHlNb2RlbCIsImxvZ2luczogTG9naW5Db250cm9sbGVyIiwiZGF0ZVByb3ZpZGVyOiBEYXRlUHJvdmlkZXIiLCJlbnRpdHlDbGllbnQ6IEVudGl0eUNsaWVudCIsInVzZXJNYW5hZ2VtZW50RmFjYWRlOiBVc2VyTWFuYWdlbWVudEZhY2FkZSIsImN1c3RvbWVyRmFjYWRlOiBDdXN0b21lckZhY2FkZSIsInRoZW1lQ29udHJvbGxlcjogVGhlbWVDb250cm9sbGVyIiwic2hvd1NldHVwV2l6YXJkOiAoKSA9PiB1bmtub3duIiwic3luY0V4dGVybmFsQ2FsZW5kYXJzOiAoKSA9PiB1bmtub3duIiwic2V0VXBDbGllbnRPbmx5Q2FsZW5kYXJzOiAoKSA9PiB1bmtub3duIiwibG9nZ2VkSW5FdmVudDogTG9nZ2VkSW5FdmVudCIsInVwZGF0ZXM6IFJlYWRvbmx5QXJyYXk8RW50aXR5VXBkYXRlRGF0YT4iLCJpc0N1c3RvbWVyVXBkYXRlOiBib29sZWFuIiwibm90aWZpY2F0aW9uOiBPdXRPZk9mZmljZU5vdGlmaWNhdGlvbiIsIm5vdGlmaWNhdGlvbk1lc3NhZ2U6IENvbXBvbmVudCIsImN1c3RvbWl6YXRpb25zOiBUaGVtZUN1c3RvbWl6YXRpb25zIl0sInNvdXJjZXMiOlsiLi4vc3JjL2NvbW1vbi9sb2dpbi9Qb3N0TG9naW5VdGlscy50cyIsIi4uL3NyYy9jb21tb24vbG9naW4vUG9zdExvZ2luQWN0aW9ucy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc0lPU0FwcCB9IGZyb20gXCIuLi9hcGkvY29tbW9uL0Vudi5qc1wiXG5pbXBvcnQgeyBDb25zdCB9IGZyb20gXCIuLi9hcGkvY29tbW9uL1R1dGFub3RhQ29uc3RhbnRzLmpzXCJcbmltcG9ydCB7IFVzZXJDb250cm9sbGVyIH0gZnJvbSBcIi4uL2FwaS9tYWluL1VzZXJDb250cm9sbGVyLmpzXCJcbmltcG9ydCB7IGFzc2VydE5vdE51bGwgfSBmcm9tIFwiQHR1dGFvL3R1dGFub3RhLXV0aWxzXCJcbmltcG9ydCB7IFVzZXJNYW5hZ2VtZW50RmFjYWRlIH0gZnJvbSBcIi4uL2FwaS93b3JrZXIvZmFjYWRlcy9sYXp5L1VzZXJNYW5hZ2VtZW50RmFjYWRlLmpzXCJcbmltcG9ydCB7IEN1c3RvbWVyRmFjYWRlIH0gZnJvbSBcIi4uL2FwaS93b3JrZXIvZmFjYWRlcy9sYXp5L0N1c3RvbWVyRmFjYWRlLmpzXCJcblxuLy8gdGhlIGN1c3RvbWVyIG1heSBoYXZlIGJlZW4gcmVtaW5kZWQgd2hlbiB0aGV5IHdlcmUgYSBmcmVlIGFjY291bnQsIHNvIHdlIGNhbid0IHVzZSBsYXN0VXBncmFkZVJlbWluZGVyIGJlaW5nIG51bGwgYXMgYSBtYXJrZXIuXG4vLyB3ZSB1c2UgYSBkYXRlIHRoYXQncyBzaG9ydGx5IGJlZm9yZSB3ZSBzdGFydGVkIGlzc3VpbmcgcmVtaW5kZXJzIGZvciBsZWdhY3kgYWNjb3VudHMgYW5kIGFmdGVyIHdlIHN0YXJ0ZWQgb25seSBhbGxvd2luZyBuZXcgcGxhbnMgYXMgdXBncmFkZXMuXG4vLyBhbnlvbmUgd2hvIGlzIHN0aWxsIGxlZ2FjeSBhbmQgd2FzIHJlbWluZGVkIGJlZm9yZSB0aGlzIGRhdGUgbXVzdCBoYXZlIHNlZW4gdGhlIGxhc3QgcmVtaW5kZXIgd2hlbiB0aGV5IHdlcmUgYSBmcmVlIGFjY291bnQuXG4vLyBpZiB3ZSBlbmQgdXAgd2FudGluZyB0byByZXBlYXQgdGhpcyBkb3duIHRoZSBsaW5lLCB1cGRhdGUgdGhpcyB0byBzb21lIGxhdGVyIGRhdGUuXG5leHBvcnQgY29uc3QgcmVtaW5kZXJDdXRvZmZEYXRlID0gbmV3IERhdGUoXCIyMDIzLTA5LTIwVDEzOjAwOjAwLjAwMFpcIilcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNob3VsZFNob3dVcGdyYWRlUmVtaW5kZXIodXNlckNvbnRyb2xsZXI6IFVzZXJDb250cm9sbGVyLCBkYXRlOiBEYXRlKTogUHJvbWlzZTxib29sZWFuPiB7XG5cdC8vICogZG8gbm90IHNob3cgdG8gbm9ybWFsIHVzZXJzLCB0aGV5IGNhbid0IHVwZ3JhZGUgdGhlaXIgYWNjb3VudFxuXHQvLyAqIGRvIG5vdCBzaG93IHRvIG5ldyBwbGFucywgdGhleSBhbHJlYWR5IHN3aXRjaGVkXG5cdC8vICogZG8gbm90IHNob3cgaW4gaW9zIGFwcCwgdGhleSBjYW4ndCB1cGdyYWRlIHRoZXJlLlxuXHRpZiAoIXVzZXJDb250cm9sbGVyLmlzR2xvYmFsQWRtaW4oKSB8fCAoYXdhaXQgdXNlckNvbnRyb2xsZXIuaXNOZXdQYWlkUGxhbigpKSB8fCBpc0lPU0FwcCgpKSByZXR1cm4gZmFsc2VcblxuXHRjb25zdCBjdXN0b21lckluZm8gPSBhd2FpdCB1c2VyQ29udHJvbGxlci5sb2FkQ3VzdG9tZXJJbmZvKClcblx0Y29uc3QgY3VzdG9tZXJQcm9wZXJ0aWVzID0gYXdhaXQgdXNlckNvbnRyb2xsZXIubG9hZEN1c3RvbWVyUHJvcGVydGllcygpXG5cblx0aWYgKHVzZXJDb250cm9sbGVyLmlzRnJlZUFjY291bnQoKSkge1xuXHRcdC8vIGknbSBhbnkgbm9uLXBheWluZyB1c2VyIC0gc2hvdyByZXBlYXRlZGx5IHVudGlsIHVwZ3JhZGVkLCBidXQgb25seSBhZnRlciBJTklUSUFMX1VQR1JBREVfUkVNSU5ERVJfSU5URVJWQUxfTVNcblx0XHRjb25zdCBpc09sZEVub3VnaEZvckluaXRpYWxSZW1pbmRlciA9XG5cdFx0XHRjdXN0b21lclByb3BlcnRpZXMubGFzdFVwZ3JhZGVSZW1pbmRlciA9PSBudWxsICYmIGRhdGUuZ2V0VGltZSgpIC0gY3VzdG9tZXJJbmZvLmNyZWF0aW9uVGltZS5nZXRUaW1lKCkgPiBDb25zdC5JTklUSUFMX1VQR1JBREVfUkVNSU5ERVJfSU5URVJWQUxfTVNcblx0XHQvLyBJZiB3ZSd2ZSBzaG93biB0aGUgcmVtaW5kZXIgYmVmb3JlIHNob3cgaXQgYWdhaW4gZXZlcnkgUkVQRUFURURfVVBHUkFERV9SRU1JTkRFUl9JTlRFUlZBTF9NUy5cblx0XHRjb25zdCB3YXNSZW1pbmRlZExvbmdBZ28gPVxuXHRcdFx0Y3VzdG9tZXJQcm9wZXJ0aWVzLmxhc3RVcGdyYWRlUmVtaW5kZXIgIT0gbnVsbCAmJlxuXHRcdFx0ZGF0ZS5nZXRUaW1lKCkgLSBjdXN0b21lclByb3BlcnRpZXMubGFzdFVwZ3JhZGVSZW1pbmRlci5nZXRUaW1lKCkgPiBDb25zdC5SRVBFQVRFRF9VUEdSQURFX1JFTUlOREVSX0lOVEVSVkFMX01TXG5cdFx0cmV0dXJuIGlzT2xkRW5vdWdoRm9ySW5pdGlhbFJlbWluZGVyIHx8IHdhc1JlbWluZGVkTG9uZ0Fnb1xuXHR9IGVsc2UgaWYgKCEoYXdhaXQgdXNlckNvbnRyb2xsZXIubG9hZEN1c3RvbWVyKCkpLmJ1c2luZXNzVXNlKSB7XG5cdFx0Ly8gaSdtIGEgcHJpdmF0ZSBsZWdhY3kgcGFpZCBhY2NvdW50LiBzaG93IG9uY2UuXG5cdFx0Ly8gd2UgZG9uJ3QgaGF2ZSB0byBjaGVjayBhY2NvdW50IGFnZSAtIGFsbCBsZWdhY3kgYWNjb3VudHMgYXJlIG9sZCBlbm91Z2ggYnkgbm93LlxuXHRcdHJldHVybiBjdXN0b21lclByb3BlcnRpZXMubGFzdFVwZ3JhZGVSZW1pbmRlciA9PSBudWxsIHx8IGN1c3RvbWVyUHJvcGVydGllcy5sYXN0VXBncmFkZVJlbWluZGVyLmdldFRpbWUoKSA8IHJlbWluZGVyQ3V0b2ZmRGF0ZS5nZXRUaW1lKClcblx0fSBlbHNlIHtcblx0XHQvLyBpJ20gYSBidXNpbmVzcyBsZWdhY3kgcGFpZCBhY2NvdW50LCBzbyB3ZSBkb24ndCBzaG93IHRoZSByZW1pbmRlci5cblx0XHRyZXR1cm4gZmFsc2Vcblx0fVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2hvdWxkU2hvd1N0b3JhZ2VXYXJuaW5nKFxuXHR1c2VyQ29udHJvbGxlcjogVXNlckNvbnRyb2xsZXIsXG5cdHVzZXJNYW5hZ2VtZW50RmFjYWRlOiBVc2VyTWFuYWdlbWVudEZhY2FkZSxcblx0Y3VzdG9tZXJGYWNhZGU6IEN1c3RvbWVyRmFjYWRlLFxuKTogUHJvbWlzZTxib29sZWFuPiB7XG5cdGNvbnN0IGN1c3RvbWVySW5mbyA9IGF3YWl0IHVzZXJDb250cm9sbGVyLmxvYWRDdXN0b21lckluZm8oKVxuXHQvLyBOZXcgcGxhbnMgaGF2ZSBwZXItdXNlciBzdG9yYWdlIGxpbWl0cy5cblx0aWYgKChhd2FpdCB1c2VyQ29udHJvbGxlci5pc05ld1BhaWRQbGFuKCkpIHx8IHVzZXJDb250cm9sbGVyLmlzRnJlZUFjY291bnQoKSkge1xuXHRcdGNvbnN0IHVzZWRTdG9yYWdlID0gYXdhaXQgdXNlck1hbmFnZW1lbnRGYWNhZGUucmVhZFVzZWRVc2VyU3RvcmFnZSh1c2VyQ29udHJvbGxlci51c2VyKVxuXHRcdHJldHVybiBpc092ZXJTdG9yYWdlTGltaXQodXNlZFN0b3JhZ2UsIE51bWJlcihjdXN0b21lckluZm8ucGVyVXNlclN0b3JhZ2VDYXBhY2l0eSkgKiBDb25zdC5NRU1PUllfR0JfRkFDVE9SKVxuXHR9IGVsc2Uge1xuXHRcdC8vIExlZ2FjeSBwbGFucyBoYXZlIHBlci1hY2NvdW50IHN0b3JhZ2UgbGltaXRzLlxuXHRcdGlmICghdXNlckNvbnRyb2xsZXIuaXNHbG9iYWxBZG1pbigpKSB7XG5cdFx0XHRyZXR1cm4gZmFsc2Vcblx0XHR9XG5cdFx0Y29uc3QgY3VzdG9tZXJJZCA9IGFzc2VydE5vdE51bGwodXNlckNvbnRyb2xsZXIudXNlci5jdXN0b21lcilcblx0XHRjb25zdCB1c2VkU3RvcmFnZSA9IGF3YWl0IGN1c3RvbWVyRmFjYWRlLnJlYWRVc2VkQ3VzdG9tZXJTdG9yYWdlKGN1c3RvbWVySWQpXG5cdFx0aWYgKE51bWJlcih1c2VkU3RvcmFnZSkgPiBDb25zdC5NRU1PUllfR0JfRkFDVE9SICogQ29uc3QuTUVNT1JZX1dBUk5JTkdfRkFDVE9SKSB7XG5cdFx0XHRjb25zdCBhdmFpbGFibGVTdG9yYWdlID0gYXdhaXQgY3VzdG9tZXJGYWNhZGUucmVhZEF2YWlsYWJsZUN1c3RvbWVyU3RvcmFnZShjdXN0b21lcklkKVxuXHRcdFx0cmV0dXJuIGlzT3ZlclN0b3JhZ2VMaW1pdCh1c2VkU3RvcmFnZSwgYXZhaWxhYmxlU3RvcmFnZSlcblx0XHR9IGVsc2Uge1xuXHRcdFx0cmV0dXJuIGZhbHNlXG5cdFx0fVxuXHR9XG59XG5cbmZ1bmN0aW9uIGlzT3ZlclN0b3JhZ2VMaW1pdCh1c2VkU3RvcmFnZUluQnl0ZXM6IG51bWJlciwgYXZhaWxhYmxlU3RvcmFnZUluQnl0ZXM6IG51bWJlcikge1xuXHRyZXR1cm4gdXNlZFN0b3JhZ2VJbkJ5dGVzID4gYXZhaWxhYmxlU3RvcmFnZUluQnl0ZXMgKiBDb25zdC5NRU1PUllfV0FSTklOR19GQUNUT1Jcbn1cbiIsImltcG9ydCBtLCB7IENvbXBvbmVudCB9IGZyb20gXCJtaXRocmlsXCJcbmltcG9ydCB0eXBlIHsgTG9nZ2VkSW5FdmVudCwgUG9zdExvZ2luQWN0aW9uIH0gZnJvbSBcIi4uL2FwaS9tYWluL0xvZ2luQ29udHJvbGxlclwiXG5pbXBvcnQgeyBMb2dpbkNvbnRyb2xsZXIgfSBmcm9tIFwiLi4vYXBpL21haW4vTG9naW5Db250cm9sbGVyXCJcbmltcG9ydCB7IGlzQWRtaW5DbGllbnQsIGlzQXBwLCBpc0Rlc2t0b3AsIExPR0lOX1RJVExFIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vRW52XCJcbmltcG9ydCB7IGFzc2VydE5vdE51bGwsIGRlZmVyLCBkZWxheSwgbmV2ZXJOdWxsLCBub09wLCBvZkNsYXNzIH0gZnJvbSBcIkB0dXRhby90dXRhbm90YS11dGlsc1wiXG5pbXBvcnQgeyB3aW5kb3dGYWNhZGUgfSBmcm9tIFwiLi4vbWlzYy9XaW5kb3dGYWNhZGUuanNcIlxuaW1wb3J0IHsgY2hlY2tBcHByb3ZhbFN0YXR1cyB9IGZyb20gXCIuLi9taXNjL0xvZ2luVXRpbHMuanNcIlxuaW1wb3J0IHsgbG9jYXRvciB9IGZyb20gXCIuLi9hcGkvbWFpbi9Db21tb25Mb2NhdG9yXCJcbmltcG9ydCB7IFJlY2VpdmVJbmZvU2VydmljZSB9IGZyb20gXCIuLi9hcGkvZW50aXRpZXMvdHV0YW5vdGEvU2VydmljZXNcIlxuaW1wb3J0IHsgbGFuZyB9IGZyb20gXCIuLi9taXNjL0xhbmd1YWdlVmlld01vZGVsLmpzXCJcbmltcG9ydCB7IGdldEhvdXJDeWNsZSB9IGZyb20gXCIuLi9taXNjL0Zvcm1hdHRlci5qc1wiXG5pbXBvcnQgeyBjcmVhdGVSZWNlaXZlSW5mb1NlcnZpY2VEYXRhLCBPdXRPZk9mZmljZU5vdGlmaWNhdGlvbiB9IGZyb20gXCIuLi9hcGkvZW50aXRpZXMvdHV0YW5vdGEvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHsgaXNOb3RpZmljYXRpb25DdXJyZW50bHlBY3RpdmUsIGxvYWRPdXRPZk9mZmljZU5vdGlmaWNhdGlvbiB9IGZyb20gXCIuLi9taXNjL091dE9mT2ZmaWNlTm90aWZpY2F0aW9uVXRpbHMuanNcIlxuaW1wb3J0ICogYXMgbm90aWZpY2F0aW9uT3ZlcmxheSBmcm9tIFwiLi4vZ3VpL2Jhc2UvTm90aWZpY2F0aW9uT3ZlcmxheVwiXG5pbXBvcnQgeyBCdXR0b25UeXBlIH0gZnJvbSBcIi4uL2d1aS9iYXNlL0J1dHRvbi5qc1wiXG5pbXBvcnQgeyBEaWFsb2cgfSBmcm9tIFwiLi4vZ3VpL2Jhc2UvRGlhbG9nXCJcbmltcG9ydCB7IENsb3NlRXZlbnRCdXNPcHRpb24sIENvbnN0LCBTZWNvbmRGYWN0b3JUeXBlIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vVHV0YW5vdGFDb25zdGFudHNcIlxuaW1wb3J0IHsgc2hvd01vcmVTdG9yYWdlTmVlZGVkT3JkZXJEaWFsb2cgfSBmcm9tIFwiLi4vbWlzYy9TdWJzY3JpcHRpb25EaWFsb2dzLmpzXCJcbmltcG9ydCB7IG5vdGlmaWNhdGlvbnMgfSBmcm9tIFwiLi4vZ3VpL05vdGlmaWNhdGlvbnNcIlxuaW1wb3J0IHsgTG9ja2VkRXJyb3IgfSBmcm9tIFwiLi4vYXBpL2NvbW1vbi9lcnJvci9SZXN0RXJyb3JcIlxuaW1wb3J0IHsgQ3JlZGVudGlhbHNQcm92aWRlciwgdXNpbmdLZXljaGFpbkF1dGhlbnRpY2F0aW9uV2l0aE9wdGlvbnMgfSBmcm9tIFwiLi4vbWlzYy9jcmVkZW50aWFscy9DcmVkZW50aWFsc1Byb3ZpZGVyLmpzXCJcbmltcG9ydCB0eXBlIHsgVGhlbWVDdXN0b21pemF0aW9ucyB9IGZyb20gXCIuLi9taXNjL1doaXRlbGFiZWxDdXN0b21pemF0aW9ucy5qc1wiXG5pbXBvcnQgeyBnZXRUaGVtZUN1c3RvbWl6YXRpb25zIH0gZnJvbSBcIi4uL21pc2MvV2hpdGVsYWJlbEN1c3RvbWl6YXRpb25zLmpzXCJcbmltcG9ydCB7IENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZSB9IGZyb20gXCIuLi9taXNjL2NyZWRlbnRpYWxzL0NyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZS5qc1wiXG5pbXBvcnQgeyBTZWNvbmRGYWN0b3JIYW5kbGVyIH0gZnJvbSBcIi4uL21pc2MvMmZhL1NlY29uZEZhY3RvckhhbmRsZXIuanNcIlxuaW1wb3J0IHsgU2Vzc2lvblR5cGUgfSBmcm9tIFwiLi4vYXBpL2NvbW1vbi9TZXNzaW9uVHlwZVwiXG5pbXBvcnQgeyBTdG9yYWdlQmVoYXZpb3IgfSBmcm9tIFwiLi4vbWlzYy9Vc2FnZVRlc3RNb2RlbC5qc1wiXG5pbXBvcnQgdHlwZSB7IFdlYnNvY2tldENvbm5lY3Rpdml0eU1vZGVsIH0gZnJvbSBcIi4uL21pc2MvV2Vic29ja2V0Q29ubmVjdGl2aXR5TW9kZWwuanNcIlxuaW1wb3J0IHsgRGF0ZVByb3ZpZGVyIH0gZnJvbSBcIi4uL2FwaS9jb21tb24vRGF0ZVByb3ZpZGVyLmpzXCJcbmltcG9ydCB7IGNyZWF0ZUN1c3RvbWVyUHJvcGVydGllcywgQ3VzdG9tZXJUeXBlUmVmLCBTZWNvbmRGYWN0b3JUeXBlUmVmIH0gZnJvbSBcIi4uL2FwaS9lbnRpdGllcy9zeXMvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHsgRW50aXR5Q2xpZW50IH0gZnJvbSBcIi4uL2FwaS9jb21tb24vRW50aXR5Q2xpZW50LmpzXCJcbmltcG9ydCB7IHNob3VsZFNob3dTdG9yYWdlV2FybmluZywgc2hvdWxkU2hvd1VwZ3JhZGVSZW1pbmRlciB9IGZyb20gXCIuL1Bvc3RMb2dpblV0aWxzLmpzXCJcbmltcG9ydCB7IFVzZXJNYW5hZ2VtZW50RmFjYWRlIH0gZnJvbSBcIi4uL2FwaS93b3JrZXIvZmFjYWRlcy9sYXp5L1VzZXJNYW5hZ2VtZW50RmFjYWRlLmpzXCJcbmltcG9ydCB7IEN1c3RvbWVyRmFjYWRlIH0gZnJvbSBcIi4uL2FwaS93b3JrZXIvZmFjYWRlcy9sYXp5L0N1c3RvbWVyRmFjYWRlLmpzXCJcbmltcG9ydCB7IGRldmljZUNvbmZpZyB9IGZyb20gXCIuLi9taXNjL0RldmljZUNvbmZpZy5qc1wiXG5pbXBvcnQgeyBUaGVtZUNvbnRyb2xsZXIgfSBmcm9tIFwiLi4vZ3VpL1RoZW1lQ29udHJvbGxlci5qc1wiXG5pbXBvcnQgeyBFbnRpdHlVcGRhdGVEYXRhLCBpc1VwZGF0ZUZvclR5cGVSZWYgfSBmcm9tIFwiLi4vYXBpL2NvbW1vbi91dGlscy9FbnRpdHlVcGRhdGVVdGlscy5qc1wiXG5cbi8qKlxuICogVGhpcyBpcyBhIGNvbGxlY3Rpb24gb2YgYWxsIHRoaW5ncyB0aGF0IG5lZWQgdG8gYmUgaW5pdGlhbGl6ZWQvZ2xvYmFsIHN0YXRlIHRvIGJlIHNldCBhZnRlciBhIHVzZXIgaGFzIGxvZ2dlZCBpbiBzdWNjZXNzZnVsbHkuXG4gKi9cblxuZXhwb3J0IGNsYXNzIFBvc3RMb2dpbkFjdGlvbnMgaW1wbGVtZW50cyBQb3N0TG9naW5BY3Rpb24ge1xuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIHJlYWRvbmx5IGNyZWRlbnRpYWxzUHJvdmlkZXI6IENyZWRlbnRpYWxzUHJvdmlkZXIsXG5cdFx0cHVibGljIHNlY29uZEZhY3RvckhhbmRsZXI6IFNlY29uZEZhY3RvckhhbmRsZXIsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBjb25uZWN0aXZpdHlNb2RlbDogV2Vic29ja2V0Q29ubmVjdGl2aXR5TW9kZWwsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBsb2dpbnM6IExvZ2luQ29udHJvbGxlcixcblx0XHRwcml2YXRlIHJlYWRvbmx5IGRhdGVQcm92aWRlcjogRGF0ZVByb3ZpZGVyLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgZW50aXR5Q2xpZW50OiBFbnRpdHlDbGllbnQsXG5cdFx0cHJpdmF0ZSByZWFkb25seSB1c2VyTWFuYWdlbWVudEZhY2FkZTogVXNlck1hbmFnZW1lbnRGYWNhZGUsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBjdXN0b21lckZhY2FkZTogQ3VzdG9tZXJGYWNhZGUsXG5cdFx0cHJpdmF0ZSByZWFkb25seSB0aGVtZUNvbnRyb2xsZXI6IFRoZW1lQ29udHJvbGxlcixcblx0XHRwcml2YXRlIHJlYWRvbmx5IHNob3dTZXR1cFdpemFyZDogKCkgPT4gdW5rbm93bixcblx0XHRwcml2YXRlIHJlYWRvbmx5IHN5bmNFeHRlcm5hbENhbGVuZGFyczogKCkgPT4gdW5rbm93bixcblx0XHRwcml2YXRlIHJlYWRvbmx5IHNldFVwQ2xpZW50T25seUNhbGVuZGFyczogKCkgPT4gdW5rbm93bixcblx0KSB7fVxuXG5cdGFzeW5jIG9uUGFydGlhbExvZ2luU3VjY2Vzcyhsb2dnZWRJbkV2ZW50OiBMb2dnZWRJbkV2ZW50KTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Ly8gV2UgZXN0YWJsaXNoIHdlYnNvY2tldCBjb25uZWN0aW9uIGV2ZW4gZm9yIHRlbXBvcmFyeSBzZXNzaW9ucyBiZWNhdXNlIHdlIG5lZWQgdG8gZ2V0IHVwZGF0ZXMgZS5nLiBkdXJpbmcgc2lnbnVwXG5cdFx0d2luZG93RmFjYWRlLmFkZE9ubGluZUxpc3RlbmVyKCgpID0+IHtcblx0XHRcdGNvbnNvbGUubG9nKG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgXCJvbmxpbmUgLSB0cnkgcmVjb25uZWN0XCIpXG5cdFx0XHRpZiAodGhpcy5sb2dpbnMuaXNGdWxseUxvZ2dlZEluKCkpIHtcblx0XHRcdFx0Ly8gV2hlbiB3ZSB0cnkgdG8gY29ubmVjdCBhZnRlciByZWNlaXZpbmcgb25saW5lIGV2ZW50IGl0IG1pZ2h0IG5vdCBzdWNjZWVkIHNvIHdlIGRlbGF5IHJlY29ubmVjdCBhdHRlbXB0IGJ5IDJzXG5cdFx0XHRcdHRoaXMuY29ubmVjdGl2aXR5TW9kZWwudHJ5UmVjb25uZWN0KHRydWUsIHRydWUsIDIwMDApXG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHQvLyBsb2cgaW4gdXNlclxuXHRcdFx0XHR0aGlzLmxvZ2lucy5yZXRyeUFzeW5jTG9naW4oKVxuXHRcdFx0fVxuXHRcdH0pXG5cdFx0d2luZG93RmFjYWRlLmFkZE9mZmxpbmVMaXN0ZW5lcigoKSA9PiB7XG5cdFx0XHRjb25zb2xlLmxvZyhuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksIFwib2ZmbGluZSAtIHBhdXNlIGV2ZW50IGJ1c1wiKVxuXHRcdFx0dGhpcy5jb25uZWN0aXZpdHlNb2RlbC5jbG9zZShDbG9zZUV2ZW50QnVzT3B0aW9uLlBhdXNlKVxuXHRcdH0pXG5cblx0XHQvLyBvbmx5IHNob3cgXCJUdXRhIE1haWxcIiBhZnRlciBsb2dpbiBpZiB0aGVyZSBpcyBubyBjdXN0b20gdGl0bGUgc2V0XG5cdFx0aWYgKCF0aGlzLmxvZ2lucy5nZXRVc2VyQ29udHJvbGxlcigpLmlzSW50ZXJuYWxVc2VyKCkpIHtcblx0XHRcdGlmIChkb2N1bWVudC50aXRsZSA9PT0gTE9HSU5fVElUTEUpIHtcblx0XHRcdFx0ZG9jdW1lbnQudGl0bGUgPSBcIlR1dGEgTWFpbFwiXG5cdFx0XHR9XG5cblx0XHRcdHJldHVyblxuXHRcdH0gZWxzZSB7XG5cdFx0XHRsZXQgcG9zdExvZ2luVGl0bGUgPSBkb2N1bWVudC50aXRsZSA9PT0gTE9HSU5fVElUTEUgPyBcIlR1dGEgTWFpbFwiIDogZG9jdW1lbnQudGl0bGVcblx0XHRcdGRvY3VtZW50LnRpdGxlID0gbmV2ZXJOdWxsKHRoaXMubG9naW5zLmdldFVzZXJDb250cm9sbGVyKCkudXNlckdyb3VwSW5mby5tYWlsQWRkcmVzcykgKyBcIiAtIFwiICsgcG9zdExvZ2luVGl0bGVcblx0XHR9XG5cdFx0bm90aWZpY2F0aW9ucy5yZXF1ZXN0UGVybWlzc2lvbigpXG5cblx0XHRpZiAoXG5cdFx0XHRsb2dnZWRJbkV2ZW50LnNlc3Npb25UeXBlID09PSBTZXNzaW9uVHlwZS5QZXJzaXN0ZW50ICYmXG5cdFx0XHR1c2luZ0tleWNoYWluQXV0aGVudGljYXRpb25XaXRoT3B0aW9ucygpICYmXG5cdFx0XHQoYXdhaXQgdGhpcy5jcmVkZW50aWFsc1Byb3ZpZGVyLmdldENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZSgpKSA9PSBudWxsXG5cdFx0KSB7XG5cdFx0XHQvLyBJZiB0aGUgZW5jcnlwdGlvbiBtb2RlIGlzIG5vdCBzZWxlY3RlZCwgd2Ugb3B0IHVzZXIgaW50byBhdXRvbWF0aWMgbW9kZS5cblx0XHRcdC8vIFdlIGtlZXAgZG9pbmcgaXQgaGVyZSBmb3Igbm93IHRvIGhhdmUgc29tZSBmbGV4aWJpbGl0eSBpZiB3ZSB3YW50IHRvIHNob3cgc29tZSBvdGhlciBvcHRpb24gaGVyZSBpbiB0aGUgZnV0dXJlLlxuXHRcdFx0YXdhaXQgdGhpcy5jcmVkZW50aWFsc1Byb3ZpZGVyLnNldENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZShDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGUuREVWSUNFX0xPQ0spXG5cdFx0fVxuXG5cdFx0bGFuZy51cGRhdGVGb3JtYXRzKHtcblx0XHRcdC8vIHBhcnRpYWxcblx0XHRcdGhvdXJDeWNsZTogZ2V0SG91ckN5Y2xlKHRoaXMubG9naW5zLmdldFVzZXJDb250cm9sbGVyKCkudXNlclNldHRpbmdzR3JvdXBSb290KSxcblx0XHR9KVxuXG5cdFx0Ly8gV2UgYWxyZWFkeSBoYXZlIHVzZXIgZGF0YSB0byBsb2FkIHRoZW1lc1xuXHRcdGlmIChpc0FwcCgpIHx8IGlzRGVza3RvcCgpKSB7XG5cdFx0XHRhd2FpdCB0aGlzLnN0b3JlTmV3Q3VzdG9tVGhlbWVzKClcblx0XHR9XG5cdH1cblxuXHRhc3luYyBvbkZ1bGxMb2dpblN1Y2Nlc3MobG9nZ2VkSW5FdmVudDogTG9nZ2VkSW5FdmVudCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGlmIChsb2dnZWRJbkV2ZW50LnNlc3Npb25UeXBlID09PSBTZXNzaW9uVHlwZS5UZW1wb3JhcnkgfHwgIXRoaXMubG9naW5zLmdldFVzZXJDb250cm9sbGVyKCkuaXNJbnRlcm5hbFVzZXIoKSkge1xuXHRcdFx0cmV0dXJuXG5cdFx0fVxuXG5cdFx0Ly8gRG8gbm90IHdhaXRcblx0XHR0aGlzLmZ1bGxMb2dpbkFzeW5jQWN0aW9ucygpXG5cblx0XHR0aGlzLnNob3dTZXR1cFdpemFyZElmTmVlZGVkKClcblx0fVxuXG5cdC8vIFJ1bnMgdGhlIHVzZXIgYXBwcm92YWwgY2hlY2sgYWZ0ZXIgdGhlIHVzZXIgaGFzIGJlZW4gdXBkYXRlZCBvciBhZnRlciBhIHRpbWVvdXRcblx0cHJpdmF0ZSBjaGVja0FwcHJvdmFsQWZ0ZXJTeW5jKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdC8vIENyZWF0ZSBhIHByb21pc2Ugd2Ugd2lsbCB1c2UgdG8gdHJhY2sgdGhlIGNvbXBsZXRpb24gb2YgdGhlIGJlbG93IGxpc3RlbmVyXG5cdFx0Y29uc3QgbGlzdGVuZXJEZWZlcnJhbCA9IGRlZmVyPHZvaWQ+KClcblx0XHQvLyBBZGQgYW4gZXZlbnQgbGlzdGVuZXIgdG8gcnVuIHRoZSBjaGVjayBhZnRlciBhbnkgY3VzdG9tZXIgZW50aXR5IHVwZGF0ZVxuXHRcdGNvbnN0IGxpc3RlbmVyID0gYXN5bmMgKHVwZGF0ZXM6IFJlYWRvbmx5QXJyYXk8RW50aXR5VXBkYXRlRGF0YT4pID0+IHtcblx0XHRcdC8vIEdldCB3aGV0aGVyIHRoZSBlbnRpdHkgdXBkYXRlIGNvbnRhaW5zIHRoZSBjdXN0b21lclxuXHRcdFx0Y29uc3QgY3VzdG9tZXIgPSB0aGlzLmxvZ2lucy5nZXRVc2VyQ29udHJvbGxlcigpLnVzZXIuY3VzdG9tZXJcblx0XHRcdGNvbnN0IGlzQ3VzdG9tZXJVcGRhdGU6IGJvb2xlYW4gPSB1cGRhdGVzLnNvbWUoKHVwZGF0ZSkgPT4gaXNVcGRhdGVGb3JUeXBlUmVmKEN1c3RvbWVyVHlwZVJlZiwgdXBkYXRlKSAmJiB1cGRhdGUuaW5zdGFuY2VJZCA9PT0gY3VzdG9tZXIpXG5cdFx0XHRpZiAoY3VzdG9tZXIgIT0gbnVsbCAmJiBpc0N1c3RvbWVyVXBkYXRlKSB7XG5cdFx0XHRcdGxpc3RlbmVyRGVmZXJyYWwucmVzb2x2ZSgpXG5cdFx0XHR9XG5cdFx0fVxuXHRcdGxvY2F0b3IuZXZlbnRDb250cm9sbGVyLmFkZEVudGl0eUxpc3RlbmVyKGxpc3RlbmVyKVxuXG5cdFx0Ly8gVGltZW91dCBpZiB0aGUgZW50aXR5IHVwZGF0ZSBkb2VzIG5vdCBhcnJpdmUgb3IgdGFrZXMgdG9vIGxvbmcgdG8gYXJyaXZlXG5cdFx0Y29uc3QgdGltZW91dFByb21pc2UgPSBkZWxheSgyMDAwKVxuXG5cdFx0Ly8gUmVtb3ZlIHRoZSBsaXN0ZW5lciBhbmQgc3RhcnQgdGhlIGFwcHJvdmFsIGNoZWNrIGRlcGVuZGluZyBvbiB3aGV0aGVyIGEgY3VzdG9tZXIgdXBkYXRlIG9yIHRoZSB0aW1lb3V0IHJlc29sdmVzIGZpcnN0LlxuXHRcdHJldHVybiBQcm9taXNlLnJhY2UoW2xpc3RlbmVyRGVmZXJyYWwucHJvbWlzZSwgdGltZW91dFByb21pc2VdKS50aGVuKCgpID0+IHtcblx0XHRcdGxvY2F0b3IuZXZlbnRDb250cm9sbGVyLnJlbW92ZUVudGl0eUxpc3RlbmVyKGxpc3RlbmVyKVxuXHRcdFx0Y2hlY2tBcHByb3ZhbFN0YXR1cyh0aGlzLmxvZ2lucywgdHJ1ZSlcblx0XHR9KVxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBmdWxsTG9naW5Bc3luY0FjdGlvbnMoKSB7XG5cdFx0dGhpcy5jaGVja0FwcHJvdmFsQWZ0ZXJTeW5jKCkgLy8gTm90IGF3YWl0aW5nIHNvIHRoaXMgaXMgcnVuIGluIHBhcmFsbGVsXG5cdFx0YXdhaXQgdGhpcy5zaG93VXBncmFkZVJlbWluZGVySWZOZWVkZWQoKVxuXHRcdGF3YWl0IHRoaXMuY2hlY2tTdG9yYWdlTGltaXQoKVxuXG5cdFx0dGhpcy5zZWNvbmRGYWN0b3JIYW5kbGVyLnNldHVwQWNjZXB0T3RoZXJDbGllbnRMb2dpbkxpc3RlbmVyKClcblxuXHRcdGlmICghaXNBZG1pbkNsaWVudCgpKSB7XG5cdFx0XHQvLyBJZiBpdCBmYWlsZWQgZHVyaW5nIHRoZSBwYXJ0aWFsIGxvZ2luIGR1ZSB0byBtaXNzaW5nIGNhY2hlIGVudHJpZXMgd2Ugd2lsbCBnaXZlIGl0IGFub3RoZXIgc3BpbiBoZXJlLiBJZiBpdCBkaWRuJ3QgZmFpbCB0aGVuIGl0J3MganVzdCBhIG5vb3Bcblx0XHRcdGF3YWl0IGxvY2F0b3IubWFpbGJveE1vZGVsLmluaXQoKVxuXHRcdFx0Y29uc3QgY2FsZW5kYXJNb2RlbCA9IGF3YWl0IGxvY2F0b3IuY2FsZW5kYXJNb2RlbCgpXG5cdFx0XHRhd2FpdCBjYWxlbmRhck1vZGVsLmluaXQoKVxuXHRcdFx0YXdhaXQgdGhpcy5yZW1pbmRBY3RpdmVPdXRPZk9mZmljZU5vdGlmaWNhdGlvbigpXG5cdFx0fVxuXG5cdFx0aWYgKGlzQXBwKCkgfHwgaXNEZXNrdG9wKCkpIHtcblx0XHRcdC8vIERvIG5vdCB0cnkgdG8gcmVnaXN0ZXIgZm9yIG5vdGlmaWNhdGlvbnMgd2hpbGUgdGhlIHNldHVwIGRpYWxvZ1xuXHRcdFx0Ly8gaXMgYmVpbmcgc2hvd24gYmVjYXVzZSB3ZSBtaWdodCBub3QgaGF2ZSBhIHBlcm1pc3Npb24geWV0IGFuZFxuXHRcdFx0Ly8gd2UgZG9uJ3Qgd2FudCB0byBhc2sgZm9yIGl0IHdoaWxlIGRpYWxvZyBpcyBzaG93biwgd2Ugd2lsbCBhc2sgaW5cblx0XHRcdC8vIHRoZSBkaWFsb2cgYW55d2F5LlxuXHRcdFx0Ly8gQWZ0ZXIgZGlhbG9nIGlzIGZpbmlzaGVkIG9yIGRpc21pc3NlZCB0aGUgc2V0dXAgaXMgXCJjb21wbGV0ZVwiLlxuXHRcdFx0aWYgKChpc0FwcCgpICYmIGRldmljZUNvbmZpZy5nZXRJc1NldHVwQ29tcGxldGUoKSkgfHwgaXNEZXNrdG9wKCkpIHtcblx0XHRcdFx0Ly8gQXdhaXQgdGhlIHB1c2ggc2VydmljZSByZWdpc3RyYXRpb24gc28gYHN0b3JlUHVzaElkZW50aWZpZXJMb2NhbGx5KClgIGNhbiBzZXQgdGhlIGV4dGVuZGVkIG5vdGlmaWNhdGlvbiBtb2RlIG9uIEFuZHJvaWRcblx0XHRcdFx0Ly8gYmVmb3JlIGBsb2FkTmV3c0lkcygpYCBydW5zIHRoZSBgaXNTaG93bigpYCBjaGVjayBvZiB0aGUgYFJpY2hOb3RpZmljYXRpb25zTmV3c2AgbmV3cyBpdGVtXG5cdFx0XHRcdGF3YWl0IGxvY2F0b3IucHVzaFNlcnZpY2UucmVnaXN0ZXIoKVxuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0Y29uc29sZS5sb2coXCJTa2lwcGluZyByZWdpc3RlcmluZyBmb3Igbm90aWZpY2F0aW9ucyB3aGlsZSBzZXR1cCBkaWFsb2cgaXMgc2hvd25cIilcblx0XHRcdH1cblxuXHRcdFx0dGhpcy5zeW5jRXh0ZXJuYWxDYWxlbmRhcnMoKVxuXHRcdH1cblxuXHRcdHRoaXMuc2V0VXBDbGllbnRPbmx5Q2FsZW5kYXJzKClcblxuXHRcdGlmICh0aGlzLmxvZ2lucy5pc0dsb2JhbEFkbWluVXNlckxvZ2dlZEluKCkgJiYgIWlzQWRtaW5DbGllbnQoKSkge1xuXHRcdFx0Y29uc3QgcmVjZWl2ZUluZm9EYXRhID0gY3JlYXRlUmVjZWl2ZUluZm9TZXJ2aWNlRGF0YSh7XG5cdFx0XHRcdGxhbmd1YWdlOiBsYW5nLmNvZGUsXG5cdFx0XHR9KVxuXHRcdFx0bG9jYXRvci5zZXJ2aWNlRXhlY3V0b3IucG9zdChSZWNlaXZlSW5mb1NlcnZpY2UsIHJlY2VpdmVJbmZvRGF0YSlcblx0XHR9XG5cblx0XHR0aGlzLmVuZm9yY2VQYXNzd29yZENoYW5nZSgpXG5cblx0XHRjb25zdCB1c2FnZVRlc3RNb2RlbCA9IGxvY2F0b3IudXNhZ2VUZXN0TW9kZWxcblx0XHRhd2FpdCB1c2FnZVRlc3RNb2RlbC5pbml0KClcblxuXHRcdHVzYWdlVGVzdE1vZGVsLnNldFN0b3JhZ2VCZWhhdmlvcihTdG9yYWdlQmVoYXZpb3IuUGVyc2lzdClcblx0XHQvLyBMb2FkIG9ubHkgdXAtdG8tZGF0ZSAobm90IG9sZGVyIHRoYW4gMWgpIGFzc2lnbm1lbnRzIGhlcmUgYW5kIG1ha2UgYSByZXF1ZXN0IGZvciB0aGF0LlxuXHRcdC8vIFRoZXJlIHNob3VsZCBub3QgYmUgYSBsb3Qgb2YgcmUtcmVuZGVyaW5nIGF0IHRoaXMgcG9pbnQgc2luY2UgYXNzaWdubWVudHMgZm9yIG5ldyB0ZXN0cyBhcmUgdXN1YWxseSBmZXRjaGVkIHJpZ2h0IGFmdGVyIGEgY2xpZW50IHZlcnNpb24gdXBkYXRlLlxuXHRcdGxvY2F0b3IudXNhZ2VUZXN0Q29udHJvbGxlci5zZXRUZXN0cyhhd2FpdCB1c2FnZVRlc3RNb2RlbC5sb2FkQWN0aXZlVXNhZ2VUZXN0cygpKVxuXG5cdFx0Ly8gTmVlZHMgdG8gYmUgY2FsbGVkIGFmdGVyIFVzYWdlVGVzdE1vZGVsLmluaXQoKSBpZiB0aGUgVXNhZ2VPcHRJbk5ld3MgaXMgbGl2ZSEgKGl0cyBpc1Nob3duKCkgcmVxdWlyZXMgYW4gaW5pdGlhbGl6ZWQgVXNhZ2VUZXN0TW9kZWwpXG5cdFx0YXdhaXQgbG9jYXRvci5uZXdzTW9kZWwubG9hZE5ld3NJZHMoKVxuXG5cdFx0Ly8gUmVkcmF3IHRvIHJlbmRlciB1c2FnZSB0ZXN0cyBhbmQgbmV3cywgYW1vbmcgb3RoZXIgdGhpbmdzIHRoYXQgbWF5IGhhdmUgY2hhbmdlZC5cblx0XHRtLnJlZHJhdygpXG5cdH1cblxuXHRwcml2YXRlIGRlYWN0aXZhdGVPdXRPZk9mZmljZU5vdGlmaWNhdGlvbihub3RpZmljYXRpb246IE91dE9mT2ZmaWNlTm90aWZpY2F0aW9uKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0bm90aWZpY2F0aW9uLmVuYWJsZWQgPSBmYWxzZVxuXHRcdHJldHVybiB0aGlzLmVudGl0eUNsaWVudC51cGRhdGUobm90aWZpY2F0aW9uKVxuXHR9XG5cblx0cHJpdmF0ZSByZW1pbmRBY3RpdmVPdXRPZk9mZmljZU5vdGlmaWNhdGlvbigpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRyZXR1cm4gbG9hZE91dE9mT2ZmaWNlTm90aWZpY2F0aW9uKCkudGhlbigobm90aWZpY2F0aW9uKSA9PiB7XG5cdFx0XHRpZiAobm90aWZpY2F0aW9uICYmIGlzTm90aWZpY2F0aW9uQ3VycmVudGx5QWN0aXZlKG5vdGlmaWNhdGlvbiwgbmV3IERhdGUoKSkpIHtcblx0XHRcdFx0Y29uc3Qgbm90aWZpY2F0aW9uTWVzc2FnZTogQ29tcG9uZW50ID0ge1xuXHRcdFx0XHRcdHZpZXc6ICgpID0+IHtcblx0XHRcdFx0XHRcdHJldHVybiBtKFwiXCIsIGxhbmcuZ2V0KFwib3V0T2ZPZmZpY2VSZW1pbmRlcl9sYWJlbFwiKSlcblx0XHRcdFx0XHR9LFxuXHRcdFx0XHR9XG5cdFx0XHRcdG5vdGlmaWNhdGlvbk92ZXJsYXkuc2hvdyhcblx0XHRcdFx0XHRub3RpZmljYXRpb25NZXNzYWdlLFxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdGxhYmVsOiBcImNsb3NlX2FsdFwiLFxuXHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0W1xuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRsYWJlbDogXCJkZWFjdGl2YXRlX2FjdGlvblwiLFxuXHRcdFx0XHRcdFx0XHRjbGljazogKCkgPT4gdGhpcy5kZWFjdGl2YXRlT3V0T2ZPZmZpY2VOb3RpZmljYXRpb24obm90aWZpY2F0aW9uKSxcblx0XHRcdFx0XHRcdFx0dHlwZTogQnV0dG9uVHlwZS5QcmltYXJ5LFxuXHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRdLFxuXHRcdFx0XHQpXG5cdFx0XHR9XG5cdFx0fSlcblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgc3RvcmVOZXdDdXN0b21UaGVtZXMoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgZG9tYWluSW5mb0FuZENvbmZpZyA9IGF3YWl0IHRoaXMubG9naW5zLmdldFVzZXJDb250cm9sbGVyKCkubG9hZFdoaXRlbGFiZWxDb25maWcoKVxuXHRcdGlmIChkb21haW5JbmZvQW5kQ29uZmlnICYmIGRvbWFpbkluZm9BbmRDb25maWcud2hpdGVsYWJlbENvbmZpZy5qc29uVGhlbWUpIHtcblx0XHRcdGNvbnN0IGN1c3RvbWl6YXRpb25zOiBUaGVtZUN1c3RvbWl6YXRpb25zID0gZ2V0VGhlbWVDdXN0b21pemF0aW9ucyhkb21haW5JbmZvQW5kQ29uZmlnLndoaXRlbGFiZWxDb25maWcpXG5cdFx0XHQvLyBqc29uVGhlbWUgaXMgc3RvcmVkIG9uIFdoaXRlbGFiZWxDb25maWcgYXMgYW4gZW1wdHkganNvbiBzdHJpbmcgKFwie31cIiwgb3Igd2hhdGV2ZXIgSlNPTi5zdHJpbmdpZnkoe30pIGdpdmVzIHlvdSlcblx0XHRcdC8vIHNvIHdlIGNhbid0IGp1c3QgY2hlY2sgYCF3aGl0ZWxhYmVsQ29uZmlnLmpzb25UaGVtZWBcblx0XHRcdGlmIChPYmplY3Qua2V5cyhjdXN0b21pemF0aW9ucykubGVuZ3RoID4gMCkge1xuXHRcdFx0XHQvLyBDdXN0b20gdGhlbWUgaXMgbWlzc2luZyB0aGVtZUlkLCBzbyB3ZSB1cGRhdGUgaXQgd2l0aCB0aGUgd2hpdGVsYWJlbCBkb21haW5cblx0XHRcdFx0aWYgKCFjdXN0b21pemF0aW9ucy50aGVtZUlkKSB7XG5cdFx0XHRcdFx0Y3VzdG9taXphdGlvbnMudGhlbWVJZCA9IGRvbWFpbkluZm9BbmRDb25maWcuZG9tYWluSW5mby5kb21haW5cblx0XHRcdFx0fVxuXG5cdFx0XHRcdGF3YWl0IHRoaXMudGhlbWVDb250cm9sbGVyLnN0b3JlQ3VzdG9tVGhlbWVGb3JDdXN0b21pemF0aW9ucyhjdXN0b21pemF0aW9ucylcblxuXHRcdFx0XHQvLyBVcGRhdGUgdGhlIGFscmVhZHkgbG9hZGVkIGN1c3RvbSB0aGVtZXMgdG8gdGhlaXIgbGF0ZXN0IHZlcnNpb25cblx0XHRcdFx0Y29uc3QgcHJldmlvdXNseVNhdmVkVGhlbWVzID0gYXdhaXQgdGhpcy50aGVtZUNvbnRyb2xsZXIuZ2V0Q3VzdG9tVGhlbWVzKClcblx0XHRcdFx0Y29uc3QgaXNFeGlzdGluZ1RoZW1lID0gcHJldmlvdXNseVNhdmVkVGhlbWVzLmluY2x1ZGVzKGRvbWFpbkluZm9BbmRDb25maWcuZG9tYWluSW5mby5kb21haW4pXG5cdFx0XHRcdGlmIChpc0V4aXN0aW5nVGhlbWUpIHtcblx0XHRcdFx0XHRhd2FpdCB0aGlzLnRoZW1lQ29udHJvbGxlci5yZWxvYWRUaGVtZSgpXG5cdFx0XHRcdH1cblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGNoZWNrU3RvcmFnZUxpbWl0KCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGlmIChhd2FpdCBzaG91bGRTaG93U3RvcmFnZVdhcm5pbmcodGhpcy5sb2dpbnMuZ2V0VXNlckNvbnRyb2xsZXIoKSwgdGhpcy51c2VyTWFuYWdlbWVudEZhY2FkZSwgdGhpcy5jdXN0b21lckZhY2FkZSkpIHtcblx0XHRcdGF3YWl0IHNob3dNb3JlU3RvcmFnZU5lZWRlZE9yZGVyRGlhbG9nKFwiaW5zdWZmaWNpZW50U3RvcmFnZVdhcm5pbmdfbXNnXCIpXG5cdFx0fVxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBzaG93VXBncmFkZVJlbWluZGVySWZOZWVkZWQoKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0aWYgKGF3YWl0IHNob3VsZFNob3dVcGdyYWRlUmVtaW5kZXIodGhpcy5sb2dpbnMuZ2V0VXNlckNvbnRyb2xsZXIoKSwgbmV3IERhdGUodGhpcy5kYXRlUHJvdmlkZXIubm93KCkpKSkge1xuXHRcdFx0Y29uc3QgY29uZmlybWVkID0gYXdhaXQgRGlhbG9nLnJlbWluZGVyKGxhbmcuZ2V0KFwidXBncmFkZVJlbWluZGVyVGl0bGVfbXNnXCIpLCBsYW5nLmdldChcInByZW1pdW1PZmZlcl9tc2dcIikpXG5cdFx0XHRpZiAoY29uZmlybWVkKSB7XG5cdFx0XHRcdGNvbnN0IHdpemFyZCA9IGF3YWl0IGltcG9ydChcIi4uL3N1YnNjcmlwdGlvbi9VcGdyYWRlU3Vic2NyaXB0aW9uV2l6YXJkLmpzXCIpXG5cdFx0XHRcdGF3YWl0IHdpemFyZC5zaG93VXBncmFkZVdpemFyZCh0aGlzLmxvZ2lucylcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgbmV3Q3VzdG9tZXJQcm9wZXJ0aWVzID0gY3JlYXRlQ3VzdG9tZXJQcm9wZXJ0aWVzKGF3YWl0IHRoaXMubG9naW5zLmdldFVzZXJDb250cm9sbGVyKCkubG9hZEN1c3RvbWVyUHJvcGVydGllcygpKVxuXHRcdFx0bmV3Q3VzdG9tZXJQcm9wZXJ0aWVzLmxhc3RVcGdyYWRlUmVtaW5kZXIgPSBuZXcgRGF0ZSh0aGlzLmRhdGVQcm92aWRlci5ub3coKSlcblx0XHRcdHRoaXMuZW50aXR5Q2xpZW50LnVwZGF0ZShuZXdDdXN0b21lclByb3BlcnRpZXMpLmNhdGNoKG9mQ2xhc3MoTG9ja2VkRXJyb3IsIG5vT3ApKVxuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgYXN5bmMgZW5mb3JjZVBhc3N3b3JkQ2hhbmdlKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdGlmICh0aGlzLmxvZ2lucy5nZXRVc2VyQ29udHJvbGxlcigpLnVzZXIucmVxdWlyZVBhc3N3b3JkVXBkYXRlKSB7XG5cdFx0XHRjb25zdCB7IHNob3dDaGFuZ2VPd25QYXNzd29yZERpYWxvZyB9ID0gYXdhaXQgaW1wb3J0KFwiLi4vc2V0dGluZ3MvbG9naW4vQ2hhbmdlUGFzc3dvcmREaWFsb2dzLmpzXCIpXG5cdFx0XHRhd2FpdCBzaG93Q2hhbmdlT3duUGFzc3dvcmREaWFsb2coZmFsc2UpXG5cdFx0fVxuXG5cdFx0aWYgKGxvY2F0aW9uLmhvc3RuYW1lID09PSBDb25zdC5ERUZBVUxUX0FQUF9ET01BSU4pIHtcblx0XHRcdGNvbnN0IHVzZXIgPSB0aGlzLmxvZ2lucy5nZXRVc2VyQ29udHJvbGxlcigpLnVzZXJcblx0XHRcdGNvbnN0IHNlY29uZEZhY3RvcnMgPSBhd2FpdCB0aGlzLmVudGl0eUNsaWVudC5sb2FkQWxsKFNlY29uZEZhY3RvclR5cGVSZWYsIGFzc2VydE5vdE51bGwodXNlci5hdXRoKS5zZWNvbmRGYWN0b3JzKVxuXHRcdFx0Y29uc3Qgd2ViYXV0aG5GYWN0b3JzID0gc2Vjb25kRmFjdG9ycy5maWx0ZXIoKGYpID0+IGYudHlwZSA9PT0gU2Vjb25kRmFjdG9yVHlwZS53ZWJhdXRobiB8fCBmLnR5cGUgPT09IFNlY29uZEZhY3RvclR5cGUudTJmKVxuXHRcdFx0Ly8gSWYgdGhlcmUgYXJlIHdlYmF1dGhuIGZhY3RvcnMgYnV0IG5vbmUgb2YgdGhlbSBhcmUgZm9yIHRoZSBkZWZhdWx0IGRvbWFpbiwgc2hvdyBhIG1lc3NhZ2Vcblx0XHRcdGlmICh3ZWJhdXRobkZhY3RvcnMubGVuZ3RoID4gMCAmJiAhd2ViYXV0aG5GYWN0b3JzLnNvbWUoKGYpID0+IGYudTJmICYmIGYudTJmPy5hcHBJZCA9PSBDb25zdC5XRUJBVVRITl9SUF9JRCkpIHtcblx0XHRcdFx0Y29uc3QgZGlhbG9nID0gRGlhbG9nLmNvbmZpcm1NdWx0aXBsZShcIm5vS2V5c0ZvclRoaXNEb21haW5fbXNnXCIsIFtcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRsYWJlbDogXCJza2lwX2FjdGlvblwiLFxuXHRcdFx0XHRcdFx0dHlwZTogQnV0dG9uVHlwZS5TZWNvbmRhcnksXG5cdFx0XHRcdFx0XHRjbGljazogKCkgPT4gZGlhbG9nLmNsb3NlKCksXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRsYWJlbDogXCJzZXR0aW5nc19sYWJlbFwiLFxuXHRcdFx0XHRcdFx0dHlwZTogQnV0dG9uVHlwZS5QcmltYXJ5LFxuXHRcdFx0XHRcdFx0Y2xpY2s6ICgpID0+IHtcblx0XHRcdFx0XHRcdFx0ZGlhbG9nLmNsb3NlKClcblx0XHRcdFx0XHRcdFx0bS5yb3V0ZS5zZXQoXCIvc2V0dGluZ3MvbG9naW5cIilcblx0XHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XSlcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHQvLyBTaG93IHRoZSBvbmJvYXJkaW5nIHdpemFyZCBpZiB0aGlzIGlzIHRoZSBmaXJzdCB0aW1lIHRoZSBhcHAgaGFzIGJlZW4gb3BlbmVkIHNpbmNlIGluc3RhbGxcblx0cHJpdmF0ZSBhc3luYyBzaG93U2V0dXBXaXphcmRJZk5lZWRlZCgpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCBpc1NldHVwQ29tcGxldGUgPSBkZXZpY2VDb25maWcuZ2V0SXNTZXR1cENvbXBsZXRlKClcblx0XHRpZiAoaXNBcHAoKSAmJiAhaXNTZXR1cENvbXBsZXRlKSB7XG5cdFx0XHRhd2FpdCB0aGlzLnNob3dTZXR1cFdpemFyZCgpXG5cdFx0fVxuXHR9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O01BV2EscUJBQXFCLElBQUksS0FBSztBQUVwQyxlQUFlLDBCQUEwQkEsZ0JBQWdDQyxNQUE4QjtBQUk3RyxNQUFLLGVBQWUsZUFBZSxJQUFLLE1BQU0sZUFBZSxlQUFlLElBQUssVUFBVSxDQUFFLFFBQU87Q0FFcEcsTUFBTSxlQUFlLE1BQU0sZUFBZSxrQkFBa0I7Q0FDNUQsTUFBTSxxQkFBcUIsTUFBTSxlQUFlLHdCQUF3QjtBQUV4RSxLQUFJLGVBQWUsZUFBZSxFQUFFO0VBRW5DLE1BQU0sZ0NBQ0wsbUJBQW1CLHVCQUF1QixRQUFRLEtBQUssU0FBUyxHQUFHLGFBQWEsYUFBYSxTQUFTLEdBQUcsTUFBTTtFQUVoSCxNQUFN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