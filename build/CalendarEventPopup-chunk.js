import { mithril_default } from "./mithril-chunk.js";
import { Keys } from "./TutanotaConstants-chunk.js";
import { modal } from "./RootView-chunk.js";
import { px } from "./size-chunk.js";
import { prepareCalendarDescription } from "./CalendarUtils-chunk.js";
import { Icons } from "./Icons-chunk.js";
import { DROPDOWN_MARGIN, Dialog, createAsyncDropdown, showDropdown } from "./Dialog-chunk.js";
import { BootIcons } from "./Icon-chunk.js";
import { IconButton } from "./IconButton-chunk.js";
import { convertTextToHtml } from "./Formatter-chunk.js";
import { showDeletePopup } from "./CalendarGuiUtils-chunk.js";
import { EventPreviewView } from "./EventPreviewView-chunk.js";

//#region src/calendar-app/calendar/gui/eventpopup/CalendarEventPopup.ts
var CalendarEventPopup = class {
	_shortcuts = [];
	sanitizedDescription;
	dom = null;
	focusedBeforeShown = null;
	/**
	* @param model
	* @param eventBubbleRect the rect where the event bubble was displayed that was clicked (if any)
	* @param htmlSanitizer
	*/
	constructor(model, eventBubbleRect, htmlSanitizer) {
		this.model = model;
		this.eventBubbleRect = eventBubbleRect;
		this.sanitizedDescription = prepareCalendarDescription(model.calendarEvent.description, (s) => htmlSanitizer.sanitizeHTML(convertTextToHtml(s), { blockExternalContent: true }).html);
		this.setupShortcuts();
		this.view = this.view.bind(this);
	}
	handleDeleteButtonClick = async (ev, receiver) => {
		showDeletePopup(this.model, ev, receiver, () => this.close());
	};
	handleEditButtonClick = (ev, receiver) => {
		if (this.model.isRepeatingForEditing) createAsyncDropdown({
			lazyButtons: () => Promise.resolve([{
				label: "updateOneCalendarEvent_action",
				click: () => {
					this.model.editSingle();
					this.close();
				}
			}, {
				label: "updateAllCalendarEvents_action",
				click: () => {
					this.model.editAll();
					this.close();
				}
			}]),
			width: 300
		})(ev, receiver);
else {
			this.model.editAll();
			this.close();
		}
	};
	handleSendUpdatesClick = async () => {
		const confirmed = await Dialog.confirm("sendUpdates_msg");
		if (confirmed) await this.model.sendUpdates();
		this.close();
	};
	view() {
		return mithril_default(".abs.elevated-bg.plr.pb.border-radius.dropdown-shadow.flex.flex-column", {
			style: {
				width: px(Math.min(window.innerWidth - DROPDOWN_MARGIN * 2, 400)),
				opacity: "0",
				margin: "1px"
			},
			oncreate: (vnode) => {
				this.dom = vnode.dom;
				setTimeout(() => {
					showDropdown(this.eventBubbleRect, this.dom, this.dom.offsetHeight, 400);
					const firstButton = vnode.dom.firstElementChild?.firstElementChild;
					firstButton?.focus();
				}, 24);
			}
		}, [mithril_default(".flex.flex-end", [
			this.renderSendUpdateButton(),
			this.renderEditButton(),
			this.renderDeleteButton(),
			this.renderCloseButton()
		]), mithril_default(".flex-grow.scroll.visible-scrollbar", [mithril_default(EventPreviewView, {
			event: this.model.calendarEvent,
			sanitizedDescription: this.sanitizedDescription,
			participation: this.model.getParticipationSetterAndThen(() => this.close())
		})])]);
	}
	renderEditButton() {
		if (!this.model.canEdit) return null;
		return mithril_default(IconButton, {
			title: "edit_action",
			icon: Icons.Edit,
			click: this.handleEditButtonClick
		});
	}
	renderDeleteButton() {
		if (!this.model.canDelete) return null;
		return mithril_default(IconButton, {
			title: "delete_action",
			icon: Icons.Trash,
			click: this.handleDeleteButtonClick
		});
	}
	renderSendUpdateButton() {
		if (!this.model.canSendUpdates) return null;
		return mithril_default(IconButton, {
			title: "sendUpdates_label",
			click: () => this.handleSendUpdatesClick(),
			icon: BootIcons.Mail
		});
	}
	renderCloseButton() {
		return mithril_default(IconButton, {
			title: "close_alt",
			click: () => this.close(),
			icon: Icons.Cancel
		});
	}
	show() {
		this.focusedBeforeShown = document.activeElement;
		modal.display(this, false);
	}
	close() {
		modal.remove(this);
	}
	backgroundClick(e) {
		modal.remove(this);
	}
	hideAnimation() {
		return Promise.resolve();
	}
	onClose() {
		this.close();
	}
	shortcuts() {
		return this._shortcuts;
	}
	popState(e) {
		modal.remove(this);
		return false;
	}
	callingElement() {
		return this.focusedBeforeShown;
	}
	setupShortcuts() {
		const close = {
			key: Keys.ESC,
			exec: () => this.close(),
			help: "close_alt"
		};
		const edit = {
			key: Keys.E,
			exec: () => this.handleEditButtonClick(new MouseEvent("click", {}), this.dom),
			help: "edit_action"
		};
		const sendUpdates = {
			key: Keys.R,
			exec: this.handleSendUpdatesClick,
			help: "sendUpdates_label"
		};
		const remove = {
			key: Keys.DELETE,
			exec: () => this.handleDeleteButtonClick(new MouseEvent("click", {}), this.dom),
			help: "delete_action"
		};
		this._shortcuts.push(close);
		if (this.model.canSendUpdates) this._shortcuts.push(sendUpdates);
		if (this.model.canEdit) this._shortcuts.push(edit);
		if (this.model.canDelete) this._shortcuts.push(remove);
	}
};

//#endregion
export { CalendarEventPopup };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FsZW5kYXJFdmVudFBvcHVwLWNodW5rLmpzIiwibmFtZXMiOlsibW9kZWw6IENhbGVuZGFyRXZlbnRQcmV2aWV3Vmlld01vZGVsIiwiZXZlbnRCdWJibGVSZWN0OiBQb3NSZWN0IiwiaHRtbFNhbml0aXplcjogSHRtbFNhbml0aXplciIsImV2OiBNb3VzZUV2ZW50IiwicmVjZWl2ZXI6IEhUTUxFbGVtZW50IiwiZTogTW91c2VFdmVudCIsImU6IEV2ZW50IiwiY2xvc2U6IFNob3J0Y3V0IiwiZWRpdDogU2hvcnRjdXQiLCJzZW5kVXBkYXRlczogU2hvcnRjdXQiLCJyZW1vdmU6IFNob3J0Y3V0Il0sInNvdXJjZXMiOlsiLi4vc3JjL2NhbGVuZGFyLWFwcC9jYWxlbmRhci9ndWkvZXZlbnRwb3B1cC9DYWxlbmRhckV2ZW50UG9wdXAudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBTaG9ydGN1dCB9IGZyb20gXCIuLi8uLi8uLi8uLi9jb21tb24vbWlzYy9LZXlNYW5hZ2VyLmpzXCJcbmltcG9ydCBtLCB7IENoaWxkcmVuIH0gZnJvbSBcIm1pdGhyaWxcIlxuaW1wb3J0IHsgcHggfSBmcm9tIFwiLi4vLi4vLi4vLi4vY29tbW9uL2d1aS9zaXplLmpzXCJcbmltcG9ydCB7IEljb25zIH0gZnJvbSBcIi4uLy4uLy4uLy4uL2NvbW1vbi9ndWkvYmFzZS9pY29ucy9JY29ucy5qc1wiXG5pbXBvcnQgdHlwZSB7IE1vZGFsQ29tcG9uZW50IH0gZnJvbSBcIi4uLy4uLy4uLy4uL2NvbW1vbi9ndWkvYmFzZS9Nb2RhbC5qc1wiXG5pbXBvcnQgeyBtb2RhbCB9IGZyb20gXCIuLi8uLi8uLi8uLi9jb21tb24vZ3VpL2Jhc2UvTW9kYWwuanNcIlxuaW1wb3J0IHsgRXZlbnRQcmV2aWV3VmlldywgRXZlbnRQcmV2aWV3Vmlld0F0dHJzIH0gZnJvbSBcIi4vRXZlbnRQcmV2aWV3Vmlldy5qc1wiXG5pbXBvcnQgeyBEaWFsb2cgfSBmcm9tIFwiLi4vLi4vLi4vLi4vY29tbW9uL2d1aS9iYXNlL0RpYWxvZy5qc1wiXG5pbXBvcnQgeyBjcmVhdGVBc3luY0Ryb3Bkb3duLCBEUk9QRE9XTl9NQVJHSU4sIFBvc1JlY3QsIHNob3dEcm9wZG93biB9IGZyb20gXCIuLi8uLi8uLi8uLi9jb21tb24vZ3VpL2Jhc2UvRHJvcGRvd24uanNcIlxuaW1wb3J0IHsgS2V5cyB9IGZyb20gXCIuLi8uLi8uLi8uLi9jb21tb24vYXBpL2NvbW1vbi9UdXRhbm90YUNvbnN0YW50cy5qc1wiXG5pbXBvcnQgdHlwZSB7IEh0bWxTYW5pdGl6ZXIgfSBmcm9tIFwiLi4vLi4vLi4vLi4vY29tbW9uL21pc2MvSHRtbFNhbml0aXplci5qc1wiXG5pbXBvcnQgeyBwcmVwYXJlQ2FsZW5kYXJEZXNjcmlwdGlvbiB9IGZyb20gXCIuLi8uLi8uLi8uLi9jb21tb24vY2FsZW5kYXIvZGF0ZS9DYWxlbmRhclV0aWxzLmpzXCJcbmltcG9ydCB7IEJvb3RJY29ucyB9IGZyb20gXCIuLi8uLi8uLi8uLi9jb21tb24vZ3VpL2Jhc2UvaWNvbnMvQm9vdEljb25zLmpzXCJcbmltcG9ydCB7IEljb25CdXR0b24gfSBmcm9tIFwiLi4vLi4vLi4vLi4vY29tbW9uL2d1aS9iYXNlL0ljb25CdXR0b24uanNcIlxuaW1wb3J0IHsgY29udmVydFRleHRUb0h0bWwgfSBmcm9tIFwiLi4vLi4vLi4vLi4vY29tbW9uL21pc2MvRm9ybWF0dGVyLmpzXCJcbmltcG9ydCB7IENhbGVuZGFyRXZlbnRQcmV2aWV3Vmlld01vZGVsIH0gZnJvbSBcIi4vQ2FsZW5kYXJFdmVudFByZXZpZXdWaWV3TW9kZWwuanNcIlxuaW1wb3J0IHsgc2hvd0RlbGV0ZVBvcHVwIH0gZnJvbSBcIi4uL0NhbGVuZGFyR3VpVXRpbHMuanNcIlxuXG4vKipcbiAqIHNtYWxsIG1vZGFsIGRpc3BsYXlpbmcgYWxsIHJlbGV2YW50IGluZm9ybWF0aW9uIGFib3V0IGFuIGV2ZW50IGluIGEgY29tcGFjdCBmYXNoaW9uLiBvZmZlcnMgbGltaXRlZCBlZGl0aW5nIGNhcGFiaWxpdGllcyB0byBwYXJ0aWNpcGFudHMgaW4gdGhlXG4gKiBmb3JtIG9mIHF1aWNrIHJlc3BvbnNlIGJ1dHRvbnMgdG8gc2V0IGF0dGVuZGFuY2UgYW5kIGFkZGluZyBleGNsdXNpb25zLlxuICpcbiAqIEl0IGlzIHRoZSBmaXJzdCBsaW5lIG9mIGRlZmVuc2UgYWdhaW5zdCBpbnZhbGlkIGVkaXQgb3BlcmF0aW9ucyBzaW5jZSBpdCdzIHRoZSBvbmx5IHdheSB0byBvcGVuIGFcbiAqIGNhbGVuZGFyIGVkaXRvciBmb3IgYW4gZXZlbnQgdGhhdCdzIG5vdCBicmFuZCBuZXcgb3IgdG8gZGVsZXRlIGFuIGV2ZW50L3BhcnRzIG9mIGl0LlxuICpcbiAqIGl0IGlzIGFsc28gcmVzcG9uc2libGUgZm9yIGRpdmluaW5nIHRoZSB1c2VycyBpbnRlbnQgYmVmb3JlIHN0YXJ0aW5nIGFueSBvcGVyYXRpb25zIHNvIHdlIGNhbiBtYWtlIHN1cmUgd2UgaGF2ZSB0aGUgcmlnaHRcbiAqIGluZm9ybWF0aW9uIGF2YWlsYWJsZSwgbGlrZSB3aGVuIGVkaXRpbmcgYWxsIGV2ZW50IG9jY3VycmVuY2VzIG9yIG9ubHkgc29tZS5cbiAqL1xuZXhwb3J0IGNsYXNzIENhbGVuZGFyRXZlbnRQb3B1cCBpbXBsZW1lbnRzIE1vZGFsQ29tcG9uZW50IHtcblx0cHJpdmF0ZSByZWFkb25seSBfc2hvcnRjdXRzOiBTaG9ydGN1dFtdID0gW11cblx0cHJpdmF0ZSByZWFkb25seSBzYW5pdGl6ZWREZXNjcmlwdGlvbjogc3RyaW5nXG5cdHByaXZhdGUgZG9tOiBIVE1MRWxlbWVudCB8IG51bGwgPSBudWxsXG5cdHByaXZhdGUgZm9jdXNlZEJlZm9yZVNob3duOiBIVE1MRWxlbWVudCB8IG51bGwgPSBudWxsXG5cblx0LyoqXG5cdCAqIEBwYXJhbSBtb2RlbFxuXHQgKiBAcGFyYW0gZXZlbnRCdWJibGVSZWN0IHRoZSByZWN0IHdoZXJlIHRoZSBldmVudCBidWJibGUgd2FzIGRpc3BsYXllZCB0aGF0IHdhcyBjbGlja2VkIChpZiBhbnkpXG5cdCAqIEBwYXJhbSBodG1sU2FuaXRpemVyXG5cdCAqL1xuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IG1vZGVsOiBDYWxlbmRhckV2ZW50UHJldmlld1ZpZXdNb2RlbCwgcHJpdmF0ZSByZWFkb25seSBldmVudEJ1YmJsZVJlY3Q6IFBvc1JlY3QsIGh0bWxTYW5pdGl6ZXI6IEh0bWxTYW5pdGl6ZXIpIHtcblx0XHQvLyBXZSByZWNlaXZlIHRoZSBIdG1sU2FuaXRpemVyIGZyb20gb3V0c2lkZSBhbmQgZG8gdGhlIHNhbml0aXphdGlvbiBpbnNpZGUsIHNvIHRoYXQgd2UgZG9uJ3QgaGF2ZSB0byBqdXN0IGFzc3VtZSBpdCB3YXMgYWxyZWFkeSBkb25lXG5cdFx0dGhpcy5zYW5pdGl6ZWREZXNjcmlwdGlvbiA9IHByZXBhcmVDYWxlbmRhckRlc2NyaXB0aW9uKFxuXHRcdFx0bW9kZWwuY2FsZW5kYXJFdmVudC5kZXNjcmlwdGlvbixcblx0XHRcdChzKSA9PlxuXHRcdFx0XHRodG1sU2FuaXRpemVyLnNhbml0aXplSFRNTChjb252ZXJ0VGV4dFRvSHRtbChzKSwge1xuXHRcdFx0XHRcdGJsb2NrRXh0ZXJuYWxDb250ZW50OiB0cnVlLFxuXHRcdFx0XHR9KS5odG1sLFxuXHRcdClcblxuXHRcdHRoaXMuc2V0dXBTaG9ydGN1dHMoKVxuXHRcdHRoaXMudmlldyA9IHRoaXMudmlldy5iaW5kKHRoaXMpXG5cdH1cblxuXHRwcml2YXRlIHJlYWRvbmx5IGhhbmRsZURlbGV0ZUJ1dHRvbkNsaWNrOiAoZXY6IE1vdXNlRXZlbnQsIHJlY2VpdmVyOiBIVE1MRWxlbWVudCkgPT4gdm9pZCA9IGFzeW5jIChldjogTW91c2VFdmVudCwgcmVjZWl2ZXI6IEhUTUxFbGVtZW50KSA9PiB7XG5cdFx0c2hvd0RlbGV0ZVBvcHVwKHRoaXMubW9kZWwsIGV2LCByZWNlaXZlciwgKCkgPT4gdGhpcy5jbG9zZSgpKVxuXHR9XG5cblx0cHJpdmF0ZSByZWFkb25seSBoYW5kbGVFZGl0QnV0dG9uQ2xpY2s6IChldjogTW91c2VFdmVudCwgcmVjZWl2ZXI6IEhUTUxFbGVtZW50KSA9PiB2b2lkID0gKGV2OiBNb3VzZUV2ZW50LCByZWNlaXZlcjogSFRNTEVsZW1lbnQpID0+IHtcblx0XHRpZiAodGhpcy5tb2RlbC5pc1JlcGVhdGluZ0ZvckVkaXRpbmcpIHtcblx0XHRcdGNyZWF0ZUFzeW5jRHJvcGRvd24oe1xuXHRcdFx0XHRsYXp5QnV0dG9uczogKCkgPT5cblx0XHRcdFx0XHRQcm9taXNlLnJlc29sdmUoW1xuXHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRsYWJlbDogXCJ1cGRhdGVPbmVDYWxlbmRhckV2ZW50X2FjdGlvblwiLFxuXHRcdFx0XHRcdFx0XHRjbGljazogKCkgPT4ge1xuXHRcdFx0XHRcdFx0XHRcdC8vIG5vaW5zcGVjdGlvbiBKU0lnbm9yZWRQcm9taXNlRnJvbUNhbGxcblx0XHRcdFx0XHRcdFx0XHR0aGlzLm1vZGVsLmVkaXRTaW5nbGUoKVxuXHRcdFx0XHRcdFx0XHRcdHRoaXMuY2xvc2UoKVxuXHRcdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0bGFiZWw6IFwidXBkYXRlQWxsQ2FsZW5kYXJFdmVudHNfYWN0aW9uXCIsXG5cdFx0XHRcdFx0XHRcdGNsaWNrOiAoKSA9PiB7XG5cdFx0XHRcdFx0XHRcdFx0Ly8gbm9pbnNwZWN0aW9uIEpTSWdub3JlZFByb21pc2VGcm9tQ2FsbFxuXHRcdFx0XHRcdFx0XHRcdHRoaXMubW9kZWwuZWRpdEFsbCgpXG5cdFx0XHRcdFx0XHRcdFx0dGhpcy5jbG9zZSgpXG5cdFx0XHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdF0pLFxuXHRcdFx0XHR3aWR0aDogMzAwLFxuXHRcdFx0fSkoZXYsIHJlY2VpdmVyKVxuXHRcdH0gZWxzZSB7XG5cdFx0XHQvLyBub2luc3BlY3Rpb24gSlNJZ25vcmVkUHJvbWlzZUZyb21DYWxsXG5cdFx0XHR0aGlzLm1vZGVsLmVkaXRBbGwoKVxuXHRcdFx0dGhpcy5jbG9zZSgpXG5cdFx0fVxuXHR9XG5cblx0Ly8gd2UgaGFuZGxlIGFza0ZvclVwZGF0ZXMgaGVyZSB0byBhdm9pZCBtYWtpbmcgYSByZXF1ZXN0IGlmIG5vdCBuZWNlc3Nhcnlcblx0cHJpdmF0ZSByZWFkb25seSBoYW5kbGVTZW5kVXBkYXRlc0NsaWNrOiAoKSA9PiB2b2lkID0gYXN5bmMgKCkgPT4ge1xuXHRcdGNvbnN0IGNvbmZpcm1lZCA9IGF3YWl0IERpYWxvZy5jb25maXJtKFwic2VuZFVwZGF0ZXNfbXNnXCIpXG5cdFx0aWYgKGNvbmZpcm1lZCkgYXdhaXQgdGhpcy5tb2RlbC5zZW5kVXBkYXRlcygpXG5cdFx0dGhpcy5jbG9zZSgpXG5cdH1cblxuXHR2aWV3KCk6IENoaWxkcmVuIHtcblx0XHRyZXR1cm4gbShcblx0XHRcdFwiLmFicy5lbGV2YXRlZC1iZy5wbHIucGIuYm9yZGVyLXJhZGl1cy5kcm9wZG93bi1zaGFkb3cuZmxleC5mbGV4LWNvbHVtblwiLFxuXHRcdFx0e1xuXHRcdFx0XHRzdHlsZToge1xuXHRcdFx0XHRcdC8vIG1pbnVzIG1hcmdpbiwgbmVlZCB0byBhcHBseSBpdCBub3cgdG8gbm90IG92ZXJmbG93IGxhdGVyXG5cdFx0XHRcdFx0d2lkdGg6IHB4KE1hdGgubWluKHdpbmRvdy5pbm5lcldpZHRoIC0gRFJPUERPV05fTUFSR0lOICogMiwgNDAwKSksXG5cdFx0XHRcdFx0Ly8gc2VlIGhhY2sgZGVzY3JpcHRpb24gYmVsb3dcblx0XHRcdFx0XHRvcGFjaXR5OiBcIjBcIixcblx0XHRcdFx0XHQvLyBiZWNhdXNlIGNhbGVuZGFyIGV2ZW50IGJ1YmJsZXMgaGF2ZSAxcHggYm9yZGVyLCB3ZSB3YW50IHRvIGFsaWduXG5cdFx0XHRcdFx0bWFyZ2luOiBcIjFweFwiLFxuXHRcdFx0XHR9LFxuXHRcdFx0XHRvbmNyZWF0ZTogKHZub2RlKSA9PiB7XG5cdFx0XHRcdFx0dGhpcy5kb20gPSB2bm9kZS5kb20gYXMgSFRNTEVsZW1lbnRcblx0XHRcdFx0XHQvLyBUaGlzIGlzIGEgaGFjayB0byBnZXQgXCJuYXR1cmFsXCIgdmlldyBzaXplIGJ1dCByZW5kZXIgaXQgd2l0aG91dCBvcGFjaXR5IGZpcnN0IGFuZCB0aGVuIHNob3cgZHJvcGRvd24gd2l0aCBpbmZlcnJlZFxuXHRcdFx0XHRcdC8vIHNpemUuXG5cdFx0XHRcdFx0c2V0VGltZW91dCgoKSA9PiB7XG5cdFx0XHRcdFx0XHRzaG93RHJvcGRvd24odGhpcy5ldmVudEJ1YmJsZVJlY3QsIHRoaXMuZG9tISwgdGhpcy5kb20hLm9mZnNldEhlaWdodCwgNDAwKVxuXHRcdFx0XHRcdFx0Ly8gTW92ZSB0aGUga2V5Ym9hcmQgZm9jdXMgaW50byB0aGUgcG9wdXAncyBidXR0b25zIHdoZW4gaXQgaXMgc2hvd25cblx0XHRcdFx0XHRcdGNvbnN0IGZpcnN0QnV0dG9uID0gdm5vZGUuZG9tLmZpcnN0RWxlbWVudENoaWxkPy5maXJzdEVsZW1lbnRDaGlsZCBhcyBIVE1MSW5wdXRFbGVtZW50IHwgbnVsbFxuXHRcdFx0XHRcdFx0Zmlyc3RCdXR0b24/LmZvY3VzKClcblx0XHRcdFx0XHR9LCAyNClcblx0XHRcdFx0fSxcblx0XHRcdH0sXG5cdFx0XHRbXG5cdFx0XHRcdG0oXCIuZmxleC5mbGV4LWVuZFwiLCBbdGhpcy5yZW5kZXJTZW5kVXBkYXRlQnV0dG9uKCksIHRoaXMucmVuZGVyRWRpdEJ1dHRvbigpLCB0aGlzLnJlbmRlckRlbGV0ZUJ1dHRvbigpLCB0aGlzLnJlbmRlckNsb3NlQnV0dG9uKCldKSxcblx0XHRcdFx0bShcIi5mbGV4LWdyb3cuc2Nyb2xsLnZpc2libGUtc2Nyb2xsYmFyXCIsIFtcblx0XHRcdFx0XHRtKEV2ZW50UHJldmlld1ZpZXcsIHtcblx0XHRcdFx0XHRcdGV2ZW50OiB0aGlzLm1vZGVsLmNhbGVuZGFyRXZlbnQsXG5cdFx0XHRcdFx0XHRzYW5pdGl6ZWREZXNjcmlwdGlvbjogdGhpcy5zYW5pdGl6ZWREZXNjcmlwdGlvbixcblx0XHRcdFx0XHRcdC8vIGNsb3NpbmcgdGhpcyBzaW5jZSByZXBlYXRlZCBlZGl0IG9wZXJhdGlvbnMgZnJvbSB0aGUgcG9wdXAgd291bGQgYWx3YXlzXG5cdFx0XHRcdFx0XHQvLyB1c2UgdGhlIHZlcnNpb24gb2YgdGhlIGV2ZW50IHRoZSBwb3B1cCB3YXMgb3BlbmVkIHdpdGgsIHdoaWNoIG1lYW5zIHRoZSBuZXh0XG5cdFx0XHRcdFx0XHQvLyBjbGljayB1c2VzIGFuIG91dGRhdGVkIHZlcnNpb24uXG5cdFx0XHRcdFx0XHRwYXJ0aWNpcGF0aW9uOiB0aGlzLm1vZGVsLmdldFBhcnRpY2lwYXRpb25TZXR0ZXJBbmRUaGVuKCgpID0+IHRoaXMuY2xvc2UoKSksXG5cdFx0XHRcdFx0fSBzYXRpc2ZpZXMgRXZlbnRQcmV2aWV3Vmlld0F0dHJzKSxcblx0XHRcdFx0XSksXG5cdFx0XHRdLFxuXHRcdClcblx0fVxuXG5cdHByaXZhdGUgcmVuZGVyRWRpdEJ1dHRvbigpOiBDaGlsZHJlbiB7XG5cdFx0aWYgKCF0aGlzLm1vZGVsLmNhbkVkaXQpIHJldHVybiBudWxsXG5cdFx0cmV0dXJuIG0oSWNvbkJ1dHRvbiwgeyB0aXRsZTogXCJlZGl0X2FjdGlvblwiLCBpY29uOiBJY29ucy5FZGl0LCBjbGljazogdGhpcy5oYW5kbGVFZGl0QnV0dG9uQ2xpY2sgfSlcblx0fVxuXG5cdHByaXZhdGUgcmVuZGVyRGVsZXRlQnV0dG9uKCk6IENoaWxkcmVuIHtcblx0XHRpZiAoIXRoaXMubW9kZWwuY2FuRGVsZXRlKSByZXR1cm4gbnVsbFxuXHRcdHJldHVybiBtKEljb25CdXR0b24sIHsgdGl0bGU6IFwiZGVsZXRlX2FjdGlvblwiLCBpY29uOiBJY29ucy5UcmFzaCwgY2xpY2s6IHRoaXMuaGFuZGxlRGVsZXRlQnV0dG9uQ2xpY2sgfSlcblx0fVxuXG5cdHByaXZhdGUgcmVuZGVyU2VuZFVwZGF0ZUJ1dHRvbigpOiBDaGlsZHJlbiB7XG5cdFx0aWYgKCF0aGlzLm1vZGVsLmNhblNlbmRVcGRhdGVzKSByZXR1cm4gbnVsbFxuXHRcdHJldHVybiBtKEljb25CdXR0b24sIHtcblx0XHRcdHRpdGxlOiBcInNlbmRVcGRhdGVzX2xhYmVsXCIsXG5cdFx0XHRjbGljazogKCkgPT4gdGhpcy5oYW5kbGVTZW5kVXBkYXRlc0NsaWNrKCksXG5cdFx0XHRpY29uOiBCb290SWNvbnMuTWFpbCxcblx0XHR9KVxuXHR9XG5cblx0cHJpdmF0ZSByZW5kZXJDbG9zZUJ1dHRvbigpOiBDaGlsZHJlbiB7XG5cdFx0cmV0dXJuIG0oSWNvbkJ1dHRvbiwge1xuXHRcdFx0dGl0bGU6IFwiY2xvc2VfYWx0XCIsXG5cdFx0XHRjbGljazogKCkgPT4gdGhpcy5jbG9zZSgpLFxuXHRcdFx0aWNvbjogSWNvbnMuQ2FuY2VsLFxuXHRcdH0pXG5cdH1cblxuXHRzaG93KCkge1xuXHRcdHRoaXMuZm9jdXNlZEJlZm9yZVNob3duID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudCBhcyBIVE1MRWxlbWVudFxuXHRcdG1vZGFsLmRpc3BsYXkodGhpcywgZmFsc2UpXG5cdH1cblxuXHRwcml2YXRlIGNsb3NlKCkge1xuXHRcdG1vZGFsLnJlbW92ZSh0aGlzKVxuXHR9XG5cblx0YmFja2dyb3VuZENsaWNrKGU6IE1vdXNlRXZlbnQpOiB2b2lkIHtcblx0XHRtb2RhbC5yZW1vdmUodGhpcylcblx0fVxuXG5cdGhpZGVBbmltYXRpb24oKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0cmV0dXJuIFByb21pc2UucmVzb2x2ZSgpXG5cdH1cblxuXHRvbkNsb3NlKCk6IHZvaWQge1xuXHRcdHRoaXMuY2xvc2UoKVxuXHR9XG5cblx0c2hvcnRjdXRzKCk6IFNob3J0Y3V0W10ge1xuXHRcdHJldHVybiB0aGlzLl9zaG9ydGN1dHNcblx0fVxuXG5cdHBvcFN0YXRlKGU6IEV2ZW50KTogYm9vbGVhbiB7XG5cdFx0bW9kYWwucmVtb3ZlKHRoaXMpXG5cdFx0cmV0dXJuIGZhbHNlXG5cdH1cblxuXHRjYWxsaW5nRWxlbWVudCgpOiBIVE1MRWxlbWVudCB8IG51bGwge1xuXHRcdHJldHVybiB0aGlzLmZvY3VzZWRCZWZvcmVTaG93blxuXHR9XG5cblx0cHJpdmF0ZSBzZXR1cFNob3J0Y3V0cygpIHtcblx0XHRjb25zdCBjbG9zZTogU2hvcnRjdXQgPSB7XG5cdFx0XHRrZXk6IEtleXMuRVNDLFxuXHRcdFx0ZXhlYzogKCkgPT4gdGhpcy5jbG9zZSgpLFxuXHRcdFx0aGVscDogXCJjbG9zZV9hbHRcIixcblx0XHR9XG5cdFx0Y29uc3QgZWRpdDogU2hvcnRjdXQgPSB7XG5cdFx0XHRrZXk6IEtleXMuRSxcblx0XHRcdGV4ZWM6ICgpID0+IHRoaXMuaGFuZGxlRWRpdEJ1dHRvbkNsaWNrKG5ldyBNb3VzZUV2ZW50KFwiY2xpY2tcIiwge30pLCB0aGlzLmRvbSEpLFxuXHRcdFx0aGVscDogXCJlZGl0X2FjdGlvblwiLFxuXHRcdH1cblx0XHRjb25zdCBzZW5kVXBkYXRlczogU2hvcnRjdXQgPSB7XG5cdFx0XHRrZXk6IEtleXMuUixcblx0XHRcdGV4ZWM6IHRoaXMuaGFuZGxlU2VuZFVwZGF0ZXNDbGljayxcblx0XHRcdGhlbHA6IFwic2VuZFVwZGF0ZXNfbGFiZWxcIixcblx0XHR9XG5cdFx0Y29uc3QgcmVtb3ZlOiBTaG9ydGN1dCA9IHtcblx0XHRcdGtleTogS2V5cy5ERUxFVEUsXG5cdFx0XHRleGVjOiAoKSA9PiB0aGlzLmhhbmRsZURlbGV0ZUJ1dHRvbkNsaWNrKG5ldyBNb3VzZUV2ZW50KFwiY2xpY2tcIiwge30pLCB0aGlzLmRvbSEpLFxuXHRcdFx0aGVscDogXCJkZWxldGVfYWN0aW9uXCIsXG5cdFx0fVxuXG5cdFx0dGhpcy5fc2hvcnRjdXRzLnB1c2goY2xvc2UpXG5cblx0XHRpZiAodGhpcy5tb2RlbC5jYW5TZW5kVXBkYXRlcykge1xuXHRcdFx0dGhpcy5fc2hvcnRjdXRzLnB1c2goc2VuZFVwZGF0ZXMpXG5cdFx0fVxuXG5cdFx0aWYgKHRoaXMubW9kZWwuY2FuRWRpdCkge1xuXHRcdFx0dGhpcy5fc2hvcnRjdXRzLnB1c2goZWRpdClcblx0XHR9XG5cblx0XHRpZiAodGhpcy5tb2RlbC5jYW5EZWxldGUpIHtcblx0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