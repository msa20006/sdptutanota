import { assertMainOrNodeBoot, isAppleDevice } from "./Env-chunk.js";
import { mithril_default } from "./mithril-chunk.js";
import { mod } from "./dist2-chunk.js";
import { Keys } from "./TutanotaConstants-chunk.js";

//#region src/common/misc/KeyManager.ts
assertMainOrNodeBoot();
const TABBABLE = "button, input, textarea, div[contenteditable='true'], [tabindex='0'], a, [role=button], [role=input]";
function keyboardEventToKeyPress(event) {
	const ctrlOrCmd = isAppleDevice() ? event.metaKey : event.ctrlKey;
	return {
		key: event.key,
		ctrlOrCmd,
		shift: event.shiftKey,
		alt: event.altKey,
		ctrl: !ctrlOrCmd && event.ctrlKey,
		meta: !ctrlOrCmd && event.metaKey
	};
}
function useKeyHandler(e, onKey) {
	const key = keyboardEventToKeyPress(e);
	return onKey != null ? onKey(key) : true;
}
function isFocusable(e) {
	if ("disabled" in e && !!e.disabled) return false;
	if (e.tabIndex === -1) return false;
	return e.style.display !== "none" && e.closest("[hidden]:not([hidden=false]), [aria-hidden]:not([aria-hidden=false]), [inert]:not([inert=false])") == null;
}
function focusPrevious(dom) {
	const tabbable = Array.from(dom.querySelectorAll(TABBABLE)).filter(isFocusable);
	const selected = tabbable.find((e) => document.activeElement === e);
	if (selected) {
		const selection = window.getSelection();
		if (selection && selection.focusNode && (selection.focusNode.nodeName === "LI" || selection.focusNode.parentNode && selection.focusNode.parentNode.nodeName === "LI")) return true;
else {
			tabbable[mod(tabbable.indexOf(selected) - 1, tabbable.length)].focus();
			return false;
		}
	} else if (tabbable.length > 0) {
		tabbable[tabbable.length - 1].focus();
		return false;
	}
	return true;
}
function focusNext(dom) {
	const tabbable = Array.from(dom.querySelectorAll(TABBABLE)).filter(isFocusable);
	const selected = tabbable.find((e) => document.activeElement === e);
	if (selected) {
		const selection = window.getSelection();
		if (selection && selection.focusNode && (selection.focusNode.nodeName === "LI" || selection.focusNode.parentNode && selection.focusNode.parentNode.nodeName === "LI")) return true;
else {
			tabbable[mod(tabbable.indexOf(selected) + 1, tabbable.length)].focus();
			return false;
		}
	} else if (tabbable.length > 0) {
		tabbable[0].focus();
		return false;
	}
	return true;
}
function createKeyIdentifier(key, modifiers) {
	return key + (modifiers?.ctrlOrCmd ? "X" : "") + (modifiers?.ctrl ? "C" : "") + (modifiers?.alt ? "A" : "") + (modifiers?.shift ? "S" : "") + (modifiers?.meta ? "M" : "");
}
var KeyManager = class {
	keyToShortcut;
	keyToModalShortcut;
	desktopShortcuts;
	isHelpOpen = false;
	constructor() {
		const helpShortcut = {
			key: Keys.F1,
			exec: () => this.openF1Help(),
			help: "showHelp_action"
		};
		const helpId = createKeyIdentifier(helpShortcut.key.code);
		this.keyToShortcut = new Map([[helpId, helpShortcut]]);
		this.keyToModalShortcut = new Map([[helpId, helpShortcut]]);
		this.desktopShortcuts = [];
		if (!window.document.addEventListener) return;
		window.document.addEventListener("keydown", (e) => this.handleKeydown(e), false);
	}
	handleKeydown(e) {
		if (!e.isComposing) {
			const keysToShortcuts = this.keyToModalShortcut.size > 1 ? this.keyToModalShortcut : this.keyToShortcut;
			const keyPress = keyboardEventToKeyPress(e);
			const shortcut = keyPress.key ? keysToShortcuts.get(createKeyIdentifier(e.key.toLowerCase(), keyPress)) : null;
			if (shortcut != null && (shortcut.enabled == null || shortcut.enabled())) {
				if (shortcut.exec(keyPress) !== true) e.preventDefault();
			}
			mithril_default.redraw();
		}
	}
	/**
	* open a dialog listing all currently active shortcuts
	* @param forceBaseShortcuts set to true for the special case where the dialog is opened
	* from the support dropdown (which registers its own shortcuts as modal shortcuts)
	*/
	openF1Help(forceBaseShortcuts = false) {
		if (this.isHelpOpen) return;
		this.isHelpOpen = true;
		const shortcutsToShow = this.keyToModalShortcut.size > 1 && !forceBaseShortcuts ? Array.from(this.keyToModalShortcut.values()) : [...this.keyToShortcut.values(), ...this.desktopShortcuts];
		import("./ShortcutDialog-chunk.js").then(({ showShortcutDialog }) => showShortcutDialog(shortcutsToShow)).then(() => this.isHelpOpen = false);
	}
	registerShortcuts(shortcuts) {
		this.applyOperation(shortcuts, (id, s) => this.keyToShortcut.set(id, s));
	}
	unregisterShortcuts(shortcuts) {
		this.applyOperation(shortcuts, (id, _) => this.keyToShortcut.delete(id));
	}
	registerDesktopShortcuts(shortcuts) {
		this.applyOperation(shortcuts, (_, s) => this.desktopShortcuts.push(s));
	}
	registerModalShortcuts(shortcuts) {
		this.applyOperation(shortcuts, (id, s) => this.keyToModalShortcut.set(id, s));
	}
	unregisterModalShortcuts(shortcuts) {
		this.applyOperation(shortcuts, (id, _) => this.keyToModalShortcut.delete(id));
	}
	/**
	*
	* @param shortcuts list of shortcuts to operate on
	* @param operation operation to execute for every shortcut and its ID
	* @private
	*/
	applyOperation(shortcuts, operation) {
		for (const s of shortcuts) operation(createKeyIdentifier(s.key.code, s), s);
	}
};
function isKeyPressed(key, ...keys) {
	if (key != null) return keys.some((k) => k.code === key.toLowerCase());
	return false;
}
const keyManager = new KeyManager();

//#endregion
export { TABBABLE, focusNext, focusPrevious, isKeyPressed, keyManager, keyboardEventToKeyPress, useKeyHandler };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiS2V5TWFuYWdlci1jaHVuay5qcyIsIm5hbWVzIjpbImV2ZW50OiBLZXlib2FyZEV2ZW50IiwiZTogS2V5Ym9hcmRFdmVudCIsIm9uS2V5OiBrZXlIYW5kbGVyIHwgdW5kZWZpbmVkIiwiZTogSFRNTEVsZW1lbnQiLCJkb206IEhUTUxFbGVtZW50Iiwia2V5OiBzdHJpbmciLCJtb2RpZmllcnM/OiB7IGN0cmxPckNtZD86IGJvb2xlYW47IGN0cmw/OiBib29sZWFuOyBhbHQ/OiBib29sZWFuOyBzaGlmdD86IGJvb2xlYW47IG1ldGE/OiBib29sZWFuIH0iLCJoZWxwU2hvcnRjdXQ6IFNob3J0Y3V0IiwiZm9yY2VCYXNlU2hvcnRjdXRzOiBib29sZWFuIiwic2hvcnRjdXRzOiBSZWFkb25seUFycmF5PFNob3J0Y3V0PiIsInNob3J0Y3V0czogQXJyYXk8U2hvcnRjdXQ+Iiwib3BlcmF0aW9uOiAoaWQ6IHN0cmluZywgczogU2hvcnRjdXQpID0+IHVua25vd24iLCJrZXk6IHN0cmluZyB8IHVuZGVmaW5lZCIsImtleU1hbmFnZXI6IEtleU1hbmFnZXIiXSwic291cmNlcyI6WyIuLi9zcmMvY29tbW9uL21pc2MvS2V5TWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdHlwZSB7IFRyYW5zbGF0aW9uS2V5IH0gZnJvbSBcIi4vTGFuZ3VhZ2VWaWV3TW9kZWxcIlxuaW1wb3J0IHsgS2V5cyB9IGZyb20gXCIuLi9hcGkvY29tbW9uL1R1dGFub3RhQ29uc3RhbnRzXCJcbmltcG9ydCB7IGxhenksIG1vZCB9IGZyb20gXCJAdHV0YW8vdHV0YW5vdGEtdXRpbHNcIlxuaW1wb3J0IHsgYXNzZXJ0TWFpbk9yTm9kZUJvb3QsIGlzQXBwbGVEZXZpY2UgfSBmcm9tIFwiLi4vYXBpL2NvbW1vbi9FbnZcIlxuaW1wb3J0IG0gZnJvbSBcIm1pdGhyaWxcIlxuXG5hc3NlcnRNYWluT3JOb2RlQm9vdCgpXG5leHBvcnQgY29uc3QgVEFCQkFCTEUgPSBcImJ1dHRvbiwgaW5wdXQsIHRleHRhcmVhLCBkaXZbY29udGVudGVkaXRhYmxlPSd0cnVlJ10sIFt0YWJpbmRleD0nMCddLCBhLCBbcm9sZT1idXR0b25dLCBbcm9sZT1pbnB1dF1cIlxuZXhwb3J0IHR5cGUgS2V5UHJlc3MgPSB7XG5cdGtleTogc3RyaW5nXG5cblx0LyoqIE9uIEFwcGxlIGRldmljZXMsIHRoaXMgaXMgY29tbWFuZDsgb24gYWxsIG90aGVyIHBsYXRmb3JtcywgdGhpcyBpcyBjb250cm9sICovXG5cdGN0cmxPckNtZDogYm9vbGVhblxuXG5cdC8qKiBDb250cm9sIG9uIGFsbCBwbGF0Zm9ybXM7IHNob3VsZCBub3QgYmUgY29tYmluZWQgd2l0aCBjdHJsT3JDbWQgKi9cblx0Y3RybDogYm9vbGVhblxuXG5cdC8qKiBTaGlmdCBvbiBhbGwgcGxhdGZvcm1zICovXG5cdHNoaWZ0OiBib29sZWFuXG5cblx0LyoqIEFsdCBvbiBhbGwgcGxhdGZvcm1zICovXG5cdGFsdDogYm9vbGVhblxuXG5cdC8qKiBNZXRhIGlzIHRoZSBXaW5kb3dzLCBDb21tYW5kLCBvciBhIGRlZGljYXRlZCBtZXRhIGtleSBkZXBlbmRpbmcgb24gcGxhdGZvcm07IHNob3VsZCBub3QgYmUgY29tYmluZWQgd2l0aCBjdHJsT3JDbWQgKi9cblx0bWV0YTogYm9vbGVhblxufVxuZXhwb3J0IHR5cGUgS2V5ID0ge1xuXHRjb2RlOiBzdHJpbmdcblx0bmFtZTogc3RyaW5nXG59XG5cbi8qKlxuICogQ29udmVydCB0aGUga2V5Ym9hcmQgZXZlbnQgaW50byBhIGtleSBwcmVzc1xuICogQHBhcmFtIGV2ZW50IGV2ZW50IHRvIGNvbnZlcnRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGtleWJvYXJkRXZlbnRUb0tleVByZXNzKGV2ZW50OiBLZXlib2FyZEV2ZW50KTogS2V5UHJlc3Mge1xuXHRjb25zdCBjdHJsT3JDbWQgPSBpc0FwcGxlRGV2aWNlKCkgPyBldmVudC5tZXRhS2V5IDogZXZlbnQuY3RybEtleVxuXG5cdHJldHVybiB7XG5cdFx0a2V5OiBldmVudC5rZXksXG5cdFx0Y3RybE9yQ21kLFxuXHRcdHNoaWZ0OiBldmVudC5zaGlmdEtleSxcblx0XHRhbHQ6IGV2ZW50LmFsdEtleSxcblxuXHRcdC8vIElnbm9yZSB0aGVzZSBtb2RpZmllcnMgaWYgY3RybE9yQ21kIGlzIHNldCwgYXMgaXQgd2lsbCBvdGhlcndpc2UgY2F1c2UgZWl0aGVyIGJvdGggY3RybC9jdHJsT3JDbWQgdG8gYmUgc2V0IG9yIG1ldGEvY3RybE9yQ21kIHRvIGJlIHNldCwgd2hpY2ggd2lsbFxuXHRcdC8vIG1ha2UgdGhlIHNob3J0Y3V0IG5vdCBmaXJlXG5cdFx0Y3RybDogIWN0cmxPckNtZCAmJiBldmVudC5jdHJsS2V5LFxuXHRcdG1ldGE6ICFjdHJsT3JDbWQgJiYgZXZlbnQubWV0YUtleSxcblx0fVxufVxuXG4vKipcbiAqIEByZXR1cm4gZmFsc2UsIGlmIHRoZSBkZWZhdWx0IGFjdGlvbiBzaG91bGQgYmUgYWJvcnRlZFxuICovXG5leHBvcnQgdHlwZSBrZXlIYW5kbGVyID0gKGtleTogS2V5UHJlc3MpID0+IGJvb2xlYW5cblxuZXhwb3J0IGZ1bmN0aW9uIHVzZUtleUhhbmRsZXIoZTogS2V5Ym9hcmRFdmVudCwgb25LZXk6IGtleUhhbmRsZXIgfCB1bmRlZmluZWQpOiBib29sZWFuIHtcblx0Ly8ga2V5ZG93biBpcyB1c2VkIHRvIGNhbmNlbCBjZXJ0YWluIGtleXByZXNzZXMgb2YgdGhlIHVzZXIgKG1haW5seSBuZWVkZWQgZm9yIHRoZSBCdWJibGVUZXh0RmllbGQpXG5cdGNvbnN0IGtleSA9IGtleWJvYXJkRXZlbnRUb0tleVByZXNzKGUpXG5cdHJldHVybiBvbktleSAhPSBudWxsID8gb25LZXkoa2V5KSA6IHRydWVcbn1cblxuZXhwb3J0IGludGVyZmFjZSBTaG9ydGN1dCB7XG5cdC8vIGtleSB0byB1c2UgKHRoZSBjb2RlL25hbWUgaXMgaW1wb3J0YW50IGhlcmUpXG5cdGtleTogS2V5XG5cblx0Ly8gc2V0IHRvIHRydWUgdG8gaW5jbHVkZSBhIG1vZGlmaWVyLCBmYWxzZSBvciB1bmRlZmluZWQgdG8gbm90XG5cdGN0cmxPckNtZD86IGJvb2xlYW5cblx0Y3RybD86IGJvb2xlYW5cblx0YWx0PzogYm9vbGVhblxuXHRzaGlmdD86IGJvb2xlYW5cblx0bWV0YT86IGJvb2xlYW5cblx0ZW5hYmxlZD86IGxhenk8Ym9vbGVhbj5cblxuXHQvLyBtdXN0IHJldHVybiB0cnVlLCBpZiBwcmV2ZW50RGVmYXVsdCBzaG91bGQgbm90IGJlIGludm9rZWRcblx0ZXhlYyhrZXk6IEtleVByZXNzLCBlPzogRXZlbnQpOiBib29sZWFuIHwgdm9pZFxuXG5cdC8vIGRpc3BsYXllZCB0byB0aGUgdXNlciBpbiB0aGUgaGVscCBzY3JlZW5cblx0aGVscDogVHJhbnNsYXRpb25LZXlcbn1cblxuZnVuY3Rpb24gaXNGb2N1c2FibGUoZTogSFRNTEVsZW1lbnQpIHtcblx0aWYgKFwiZGlzYWJsZWRcIiBpbiBlICYmICEhZS5kaXNhYmxlZCkge1xuXHRcdHJldHVybiBmYWxzZVxuXHR9XG5cdGlmIChlLnRhYkluZGV4ID09PSAtMSkge1xuXHRcdC8vIGFsc28gZmlsdGVyIGZvciB0YWJJbmRleCBoZXJlIHRvIHJlc3RyaWN0IHRhYmJpbmcgdG8gaW52aXNpYmxlIGlucHV0c1xuXHRcdHJldHVybiBmYWxzZVxuXHR9XG5cdHJldHVybiAoXG5cdFx0ZS5zdHlsZS5kaXNwbGF5ICE9PSBcIm5vbmVcIiAmJlxuXHRcdC8vIGNoZWNrIHRoYXQgbm9uZSBvZiB0aGUgcGFyZW50cyBoYXZlIGhpZGRlbj10cnVlIG9yIGFyaWEtaGlkZGVuPXRydWVcblx0XHRlLmNsb3Nlc3QoXCJbaGlkZGVuXTpub3QoW2hpZGRlbj1mYWxzZV0pLCBbYXJpYS1oaWRkZW5dOm5vdChbYXJpYS1oaWRkZW49ZmFsc2VdKSwgW2luZXJ0XTpub3QoW2luZXJ0PWZhbHNlXSlcIikgPT0gbnVsbFxuXHQpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmb2N1c1ByZXZpb3VzKGRvbTogSFRNTEVsZW1lbnQpOiBib29sZWFuIHtcblx0Y29uc3QgdGFiYmFibGUgPSBBcnJheS5mcm9tKGRvbS5xdWVyeVNlbGVjdG9yQWxsKFRBQkJBQkxFKSkuZmlsdGVyKGlzRm9jdXNhYmxlKSBhcyBIVE1MRWxlbWVudFtdXG5cblx0Y29uc3Qgc2VsZWN0ZWQgPSB0YWJiYWJsZS5maW5kKChlKSA9PiBkb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSBlKVxuXG5cdGlmIChzZWxlY3RlZCkge1xuXHRcdC8vd29yayBhcm91bmQgZm9yIHNxdWlyZSBzbyB0YWJ1bGF0b3IgYWN0aW9ucyBhcmUgZXhlY3V0ZWQgcHJvcGVybHlcblx0XHQvL3NxdWlyZSBtYWtlcyBhIGxpc3Qgd2hpY2ggY2FuIGJlIGluZGVudGVkIGFuZCBtYW5hZ2VzIHRoaXMgd2l0aCB0YWIgYW5kIHNoaWZ0IHRhYlxuXHRcdGNvbnN0IHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKVxuXG5cdFx0aWYgKFxuXHRcdFx0c2VsZWN0aW9uICYmXG5cdFx0XHRzZWxlY3Rpb24uZm9jdXNOb2RlICYmXG5cdFx0XHQoc2VsZWN0aW9uLmZvY3VzTm9kZS5ub2RlTmFtZSA9PT0gXCJMSVwiIHx8IChzZWxlY3Rpb24uZm9jdXNOb2RlLnBhcmVudE5vZGUgJiYgc2VsZWN0aW9uLmZvY3VzTm9kZS5wYXJlbnROb2RlLm5vZGVOYW1lID09PSBcIkxJXCIpKVxuXHRcdCkge1xuXHRcdFx0cmV0dXJuIHRydWUgLy9kb250IGNoYW5nZSBzZWxlY3Rpb24gaWYgc2VsZWN0aW9uIGlzIGluIGxpc3Rcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGFiYmFibGVbbW9kKHRhYmJhYmxlLmluZGV4T2Yoc2VsZWN0ZWQpIC0gMSwgdGFiYmFibGUubGVuZ3RoKV0uZm9jdXMoKVxuXHRcdFx0cmV0dXJuIGZhbHNlXG5cdFx0fVxuXHR9IGVsc2UgaWYgKHRhYmJhYmxlLmxlbmd0aCA+IDApIHtcblx0XHR0YWJiYWJsZVt0YWJiYWJsZS5sZW5ndGggLSAxXS5mb2N1cygpXG5cdFx0cmV0dXJuIGZhbHNlXG5cdH1cblxuXHRyZXR1cm4gdHJ1ZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZm9jdXNOZXh0KGRvbTogSFRNTEVsZW1lbnQpOiBib29sZWFuIHtcblx0Y29uc3QgdGFiYmFibGUgPSBBcnJheS5mcm9tKGRvbS5xdWVyeVNlbGVjdG9yQWxsKFRBQkJBQkxFKSkuZmlsdGVyKGlzRm9jdXNhYmxlKSBhcyBIVE1MRWxlbWVudFtdXG5cblx0Y29uc3Qgc2VsZWN0ZWQgPSB0YWJiYWJsZS5maW5kKChlKSA9PiBkb2N1bWVudC5hY3RpdmVFbGVtZW50ID09PSBlKVxuXG5cdGlmIChzZWxlY3RlZCkge1xuXHRcdC8vd29yayBhcm91bmQgZm9yIHNxdWlyZSBzbyB0YWJ1bGF0b3IgYWN0aW9ucyBhcmUgZXhlY3V0ZWQgcHJvcGVybHlcblx0XHQvL3NxdWlyZSBtYWtlcyBhIGxpc3Qgd2hpY2ggY2FuIGJlIGluZGVudGVkIGFuZCBtYW5hZ2VzIHRoaXMgd2l0aCB0YWIgYW5kIHNoaWZ0IHRhYlxuXHRcdGNvbnN0IHNlbGVjdGlvbiA9IHdpbmRvdy5nZXRTZWxlY3Rpb24oKVxuXG5cdFx0aWYgKFxuXHRcdFx0c2VsZWN0aW9uICYmXG5cdFx0XHRzZWxlY3Rpb24uZm9jdXNOb2RlICYmXG5cdFx0XHQoc2VsZWN0aW9uLmZvY3VzTm9kZS5ub2RlTmFtZSA9PT0gXCJMSVwiIHx8IChzZWxlY3Rpb24uZm9jdXNOb2RlLnBhcmVudE5vZGUgJiYgc2VsZWN0aW9uLmZvY3VzTm9kZS5wYXJlbnROb2RlLm5vZGVOYW1lID09PSBcIkxJXCIpKVxuXHRcdCkge1xuXHRcdFx0cmV0dXJuIHRydWUgLy9kb250IGNoYW5nZSBzZWxlY3Rpb25cblx0XHR9IGVsc2Uge1xuXHRcdFx0dGFiYmFibGVbbW9kKHRhYmJhYmxlLmluZGV4T2Yoc2VsZWN0ZWQpICsgMSwgdGFiYmFibGUubGVuZ3RoKV0uZm9jdXMoKVxuXHRcdFx0cmV0dXJuIGZhbHNlXG5cdFx0fVxuXHR9IGVsc2UgaWYgKHRhYmJhYmxlLmxlbmd0aCA+IDApIHtcblx0XHR0YWJiYWJsZVswXS5mb2N1cygpXG5cdFx0cmV0dXJuIGZhbHNlXG5cdH1cblxuXHRyZXR1cm4gdHJ1ZVxufVxuXG5mdW5jdGlvbiBjcmVhdGVLZXlJZGVudGlmaWVyKGtleTogc3RyaW5nLCBtb2RpZmllcnM/OiB7IGN0cmxPckNtZD86IGJvb2xlYW47IGN0cmw/OiBib29sZWFuOyBhbHQ/OiBib29sZWFuOyBzaGlmdD86IGJvb2xlYW47IG1ldGE/OiBib29sZWFuIH0pOiBzdHJpbmcge1xuXHRyZXR1cm4gKFxuXHRcdGtleSArXG5cdFx0KG1vZGlmaWVycz8uY3RybE9yQ21kID8gXCJYXCIgOiBcIlwiKSArXG5cdFx0KG1vZGlmaWVycz8uY3RybCA/IFwiQ1wiIDogXCJcIikgK1xuXHRcdChtb2RpZmllcnM/LmFsdCA/IFwiQVwiIDogXCJcIikgK1xuXHRcdChtb2RpZmllcnM/LnNoaWZ0ID8gXCJTXCIgOiBcIlwiKSArXG5cdFx0KG1vZGlmaWVycz8ubWV0YSA/IFwiTVwiIDogXCJcIilcblx0KVxufVxuXG4vKipcbiAqIEtleU1hbmFnZXIgb2ZmZXJzIHRoZSBBUEkgZm9yICh1bilyZWdpc3RyYXRpb24gb2YgYWxsIGtleWJvYXJkIHNob3J0Y3V0cyBhbmQgcm91dGVzXG4gKiBrZXkgcHJlc3NlcyB0byB0aGUgY29ycmVjdCBoYW5kbGVyLlxuICpcbiAqIFNob3J0Y3V0cyB0aGF0IGFyZSByZWdpc3RlcmVkIGJ5IGEgbW9kYWwgYWx3YXlzIHRha2UgcHJlY2VkZW5jZS5cbiAqL1xuXG5jbGFzcyBLZXlNYW5hZ2VyIHtcblx0cHJpdmF0ZSBrZXlUb1Nob3J0Y3V0OiBNYXA8c3RyaW5nLCBTaG9ydGN1dD5cblx0Ly8gb3ZlcnJpZGUgZm9yIHNob3J0Y3V0czogSWYgYSBtb2RhbCBpcyB2aXNpYmxlLCBvbmx5IG1vZGFsLXNob3J0Y3V0cyBzaG91bGQgYmUgYWN0aXZlXG5cdHByaXZhdGUga2V5VG9Nb2RhbFNob3J0Y3V0OiBNYXA8c3RyaW5nLCBTaG9ydGN1dD5cblx0cHJpdmF0ZSBkZXNrdG9wU2hvcnRjdXRzOiBTaG9ydGN1dFtdXG5cdHByaXZhdGUgaXNIZWxwT3BlbjogYm9vbGVhbiA9IGZhbHNlXG5cblx0Y29uc3RydWN0b3IoKSB7XG5cdFx0Y29uc3QgaGVscFNob3J0Y3V0OiBTaG9ydGN1dCA9IHtcblx0XHRcdGtleTogS2V5cy5GMSxcblx0XHRcdGV4ZWM6ICgpID0+IHRoaXMub3BlbkYxSGVscCgpLFxuXHRcdFx0aGVscDogXCJzaG93SGVscF9hY3Rpb25cIixcblx0XHR9XG5cdFx0Y29uc3QgaGVscElkID0gY3JlYXRlS2V5SWRlbnRpZmllcihoZWxwU2hvcnRjdXQua2V5LmNvZGUpXG5cdFx0dGhpcy5rZXlUb1Nob3J0Y3V0ID0gbmV3IE1hcChbW2hlbHBJZCwgaGVscFNob3J0Y3V0XV0pXG5cdFx0Ly8gb3ZlcnJpZGUgZm9yIF9zaG9ydGN1dHM6IElmIGEgbW9kYWwgaXMgdmlzaWJsZSwgb25seSBtb2RhbC1zaG9ydGN1dHMgc2hvdWxkIGJlIGFjdGl2ZVxuXHRcdHRoaXMua2V5VG9Nb2RhbFNob3J0Y3V0ID0gbmV3IE1hcChbW2hlbHBJZCwgaGVscFNob3J0Y3V0XV0pXG5cdFx0dGhpcy5kZXNrdG9wU2hvcnRjdXRzID0gW11cblx0XHRpZiAoIXdpbmRvdy5kb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKSByZXR1cm5cblx0XHR3aW5kb3cuZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcihcImtleWRvd25cIiwgKGUpID0+IHRoaXMuaGFuZGxlS2V5ZG93bihlKSwgZmFsc2UpXG5cdH1cblxuXHRwcml2YXRlIGhhbmRsZUtleWRvd24oZTogS2V5Ym9hcmRFdmVudCk6IHZvaWQge1xuXHRcdC8vIElmIHdlIGdldCBhIGtleWJvYXJkIGV2ZW50IHdoaWxlIGluIGEgY29tcG9zaXRpb24gc3lzdGVtIChzdWNoIGFzIGFuIGlucHV0IG1ldGhvZCBlZGl0b3IpLFxuXHRcdC8vIGl0IHNob3VsZCBiZSBpZ25vcmVkIChzaW5jZSB0aGUgc3lzdGVtIHNob3VsZCBiZSBoYW5kbGluZyBrZXkgY29tbWFuZHMgZm9yIHRoYXQpLlxuXHRcdGlmICghZS5pc0NvbXBvc2luZykge1xuXHRcdFx0Y29uc3Qga2V5c1RvU2hvcnRjdXRzID0gdGhpcy5rZXlUb01vZGFsU2hvcnRjdXQuc2l6ZSA+IDEgPyB0aGlzLmtleVRvTW9kYWxTaG9ydGN1dCA6IHRoaXMua2V5VG9TaG9ydGN1dFxuXHRcdFx0Y29uc3Qga2V5UHJlc3MgPSBrZXlib2FyZEV2ZW50VG9LZXlQcmVzcyhlKVxuXHRcdFx0Y29uc3Qgc2hvcnRjdXQgPSBrZXlQcmVzcy5rZXkgPyBrZXlzVG9TaG9ydGN1dHMuZ2V0KGNyZWF0ZUtleUlkZW50aWZpZXIoZS5rZXkudG9Mb3dlckNhc2UoKSwga2V5UHJlc3MpKSA6IG51bGxcblxuXHRcdFx0aWYgKHNob3J0Y3V0ICE9IG51bGwgJiYgKHNob3J0Y3V0LmVuYWJsZWQgPT0gbnVsbCB8fCBzaG9ydGN1dC5lbmFibGVkKCkpKSB7XG5cdFx0XHRcdGlmIChzaG9ydGN1dC5leGVjKGtleVByZXNzKSAhPT0gdHJ1ZSkge1xuXHRcdFx0XHRcdGUucHJldmVudERlZmF1bHQoKVxuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0XHRtLnJlZHJhdygpXG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIG9wZW4gYSBkaWFsb2cgbGlzdGluZyBhbGwgY3VycmVudGx5IGFjdGl2ZSBzaG9ydGN1dHNcblx0ICogQHBhcmFtIGZvcmNlQmFzZVNob3J0Y3V0cyBzZXQgdG8gdHJ1ZSBmb3IgdGhlIHNwZWNpYWwgY2FzZSB3aGVyZSB0aGUgZGlhbG9nIGlzIG9wZW5lZFxuXHQgKiBmcm9tIHRoZSBzdXBwb3J0IGRyb3Bkb3duICh3aGljaCByZWdpc3RlcnMgaXRzIG93biBzaG9ydGN1dHMgYXMgbW9kYWwgc2hvcnRjdXRzKVxuXHQgKi9cblx0b3BlbkYxSGVscChmb3JjZUJhc2VTaG9ydGN1dHM6IGJvb2xlYW4gPSBmYWxzZSk6IHZvaWQge1xuXHRcdGlmICh0aGlzLmlzSGVscE9wZW4pIHJldHVyblxuXHRcdHRoaXMuaXNIZWxwT3BlbiA9IHRydWVcblx0XHQvLyB3ZSBkZWNpZGUgd2hpY2ggc2hvcnRjdXRzIHRvIHNob3cgcmlnaHQgbm93LlxuXHRcdC8vXG5cdFx0Ly8gdGhlIGhlbHAgZGlhbG9nIHdpbGwgcmVnaXN0ZXIgaXRzIG93biBzaG9ydGN1dHMgd2hpY2ggd291bGQgb3ZlcnJpZGUgdGhlXG5cdFx0Ly8gc3RhbmRhcmQgc2hvcnRjdXRzIGlmIHdlIGRpZCB0aGlzIGxhdGVyXG5cdFx0Ly9cblx0XHQvLyB3ZSBjYW4ndCBkbyB0aGlzIGluIHRoZSByZWdpc3Rlci91bnJlZ2lzdGVyIG1ldGhvZCBiZWNhdXNlIHRoZSBtb2RhbFxuXHRcdC8vIHVucmVnaXN0ZXJzIHRoZSBvbGQgZGlhbG9nIHNob3J0Y3V0cyBhbmQgdGhlbiByZWdpc3RlcnMgdGhlIG5ldyBvbmVzXG5cdFx0Ly8gd2hlbiB0aGUgdG9wIGRpYWxvZyBjaGFuZ2VzLCBsZWFkaW5nIHRvIGEgc2l0dWF0aW9uIHdoZXJlXG5cdFx0Ly8gbW9kYWxzaG9ydGN1dHMgaXMgZW1wdHkuXG5cdFx0Y29uc3Qgc2hvcnRjdXRzVG9TaG93ID1cblx0XHRcdHRoaXMua2V5VG9Nb2RhbFNob3J0Y3V0LnNpemUgPiAxICYmICFmb3JjZUJhc2VTaG9ydGN1dHNcblx0XHRcdFx0PyBBcnJheS5mcm9tKHRoaXMua2V5VG9Nb2RhbFNob3J0Y3V0LnZhbHVlcygpKSAvLyBjb3B5IHZhbHVlcywgdGhleSB3aWxsIGNoYW5nZVxuXHRcdFx0XHQ6IFsuLi50aGlzLmtleVRvU2hvcnRjdXQudmFsdWVzKCksIC4uLnRoaXMuZGVza3RvcFNob3J0Y3V0c11cblx0XHRpbXBvcnQoXCIuLi9ndWkvZGlhbG9ncy9TaG9ydGN1dERpYWxvZy5qc1wiKS50aGVuKCh7IHNob3dTaG9ydGN1dERpYWxvZyB9KSA9PiBzaG93U2hvcnRjdXREaWFsb2coc2hvcnRjdXRzVG9TaG93KSkudGhlbigoKSA9PiAodGhpcy5pc0hlbHBPcGVuID0gZmFsc2UpKVxuXHR9XG5cblx0cmVnaXN0ZXJTaG9ydGN1dHMoc2hvcnRjdXRzOiBSZWFkb25seUFycmF5PFNob3J0Y3V0Pikge1xuXHRcdHRoaXMuYXBwbHlPcGVyYXRpb24oc2hvcnRjdXRzLCAoaWQsIHMpID0+IHRoaXMua2V5VG9TaG9ydGN1dC5zZXQoaWQsIHMpKVxuXHR9XG5cblx0dW5yZWdpc3RlclNob3J0Y3V0cyhzaG9ydGN1dHM6IFJlYWRvbmx5QXJyYXk8U2hvcnRjdXQ+KSB7XG5cdFx0dGhpcy5hcHBseU9wZXJhdGlvbihzaG9ydGN1dHMsIChpZCwgXykgPT4gdGhpcy5rZXlUb1Nob3J0Y3V0LmRlbGV0ZShpZCkpXG5cdH1cblxuXHRyZWdpc3RlckRlc2t0b3BTaG9ydGN1dHMoc2hvcnRjdXRzOiBSZWFkb25seUFycmF5PFNob3J0Y3V0Pikge1xuXHRcdHRoaXMuYXBwbHlPcGVyYXRpb24oc2hvcnRjdXRzLCAoXywgcykgPT4gdGhpcy5kZXNrdG9wU2hvcnRjdXRzLnB1c2gocykpXG5cdH1cblxuXHRyZWdpc3Rlck1vZGFsU2hvcnRjdXRzKHNob3J0Y3V0czogQXJyYXk8U2hvcnRjdXQ+KSB7XG5cdFx0dGhpcy5hcHBseU9wZXJhdGlvbihzaG9ydGN1dHMsIChpZCwgcykgPT4gdGhpcy5rZXlUb01vZGFsU2hvcnRjdXQuc2V0KGlkLCBzKSlcblx0fVxuXG5cdHVucmVnaXN0ZXJNb2RhbFNob3J0Y3V0cyhzaG9ydGN1dHM6IEFycmF5PFNob3J0Y3V0Pikge1xuXHRcdHRoaXMuYXBwbHlPcGVyYXRpb24oc2hvcnRjdXRzLCAoaWQsIF8pID0+IHRoaXMua2V5VG9Nb2RhbFNob3J0Y3V0LmRlbGV0ZShpZCkpXG5cdH1cblxuXHQvKipcblx0ICpcblx0ICogQHBhcmFtIHNob3J0Y3V0cyBsaXN0IG9mIHNob3J0Y3V0cyB0byBvcGVyYXRlIG9uXG5cdCAqIEBwYXJhbSBvcGVyYXRpb24gb3BlcmF0aW9uIHRvIGV4ZWN1dGUgZm9yIGV2ZXJ5IHNob3J0Y3V0IGFuZCBpdHMgSURcblx0ICogQHByaXZhdGVcblx0ICovXG5cdHByaXZhdGUgYXBwbHlPcGVyYXRpb24oc2hvcnRjdXRzOiBSZWFkb25seUFycmF5PFNob3J0Y3V0Piwgb3BlcmF0aW9uOiAoaWQ6IHN0cmluZywgczogU2hvcnRjdXQpID0+IHVua25vd24pIHtcblx0XHRmb3IgKGNvbnN0IHMgb2Ygc2hvcnRjdXRzKSB7XG5cdFx0XHRvcGVyYXRpb24oY3JlYXRlS2V5SWRlbnRpZmllcihzLmtleS5jb2RlLCBzKSwgcylcblx0XHR9XG5cdH1cbn1cblxuLyoqXG4gKlxuICogQHBhcmFtIGtleSBUaGUga2V5IHRvIGJlIGNoZWNrZWQsIHNob3VsZCBjb3JyZXNwb25kIHRvIEtleUV2ZW50LmtleVxuICogQHBhcmFtIGtleXMgS2V5cyB0byBiZSBjaGVja2VkIGFnYWluc3QsIHR5cGUgb2YgS2V5c1xuICovXG5leHBvcnQgZnVuY3Rpb24gaXNLZXlQcmVzc2VkKGtleTogc3RyaW5nIHwgdW5kZWZpbmVkLCAuLi5rZXlzOiBBcnJheTxLZXk+KTogYm9vbGVhbiB7XG5cdGlmIChrZXkgIT0gbnVsbCkge1xuXHRcdHJldHVybiBrZXlzLnNvbWUoKGspID0+IGsuY29kZSA9PT0ga2V5LnRvTG93ZXJDYXNlKCkpXG5cdH1cblx0cmV0dXJuIGZhbHNlXG59XG5cbmV4cG9ydCBjb25zdCBrZXlNYW5hZ2VyOiBLZXlNYW5hZ2VyID0gbmV3IEtleU1hbmFnZXIoKVxuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFNQSxzQkFBc0I7TUFDVCxXQUFXO0FBNEJqQixTQUFTLHdCQUF3QkEsT0FBZ0M7Q0FDdkUsTUFBTSxZQUFZLGVBQWUsR0FBRyxNQUFNLFVBQVUsTUFBTTtBQUUxRCxRQUFPO0VBQ04sS0FBSyxNQUFNO0VBQ1g7RUFDQSxPQUFPLE1BQU07RUFDYixLQUFLLE1BQU07RUFJWCxPQUFPLGFBQWEsTUFBTTtFQUMxQixPQUFPLGFBQWEsTUFBTTtDQUMxQjtBQUNEO0FBT00sU0FBUyxjQUFjQyxHQUFrQkMsT0FBd0M7Q0FFdkYsTUFBTSxNQUFNLHdCQUF3QixFQUFFO0FBQ3RDLFFBQU8sU0FBUyxPQUFPLE1BQU0s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