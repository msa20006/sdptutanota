import { LazyLoaded, assertNotNull, concat, downcast, isSameTypeRefByAttr, stringToUtf8Uint8Array, utf8Uint8ArrayToString } from "./dist2-chunk.js";
import { ExternalImageRule, OperationType } from "./TutanotaConstants-chunk.js";
import { UserTypeRef } from "./TypeRefs2-chunk.js";
import { DbError } from "./DbError-chunk.js";
import { IV_BYTE_LENGTH, aes256RandomKey, aesEncrypt, decryptKey, random, unauthenticatedAesDecrypt } from "./dist3-chunk.js";
import { checkKeyVersionConstraints } from "./KeyLoaderFacade-chunk.js";
import { encryptKeyWithVersionedKey } from "./CryptoWrapper-chunk.js";
import { DbFacade, Metadata, b64UserIdHash } from "./IndexTables-chunk.js";

//#region src/common/api/worker/facades/lazy/ConfigurationDatabase.ts
const VERSION = 2;
const DB_KEY_PREFIX = "ConfigStorage";
const ExternalImageListOS = "ExternalAllowListOS";
const ConfigurationMetaDataOS = "MetaDataOS";
async function encryptItem(item, key, iv) {
	return aesEncrypt(key, stringToUtf8Uint8Array(item), iv, true);
}
async function decryptLegacyItem(encryptedAddress, key, iv) {
	return utf8Uint8ArrayToString(unauthenticatedAesDecrypt(key, concat(iv, encryptedAddress)));
}
var ConfigurationDatabase = class {
	db;
	constructor(keyLoaderFacade, userFacade, dbLoadFn = (user, keyLoaderFacade$1) => this.loadConfigDb(user, keyLoaderFacade$1)) {
		this.keyLoaderFacade = keyLoaderFacade;
		this.db = new LazyLoaded(() => {
			const user = assertNotNull(userFacade.getLoggedInUser());
			return dbLoadFn(user, keyLoaderFacade);
		});
	}
	async addExternalImageRule(address, rule) {
		const { db, metaData } = await this.db.getAsync();
		if (!db.indexingSupported) return;
		const encryptedAddress = await encryptItem(address, metaData.key, metaData.iv);
		return addAddressToImageList(db, encryptedAddress, rule);
	}
	async getExternalImageRule(address) {
		const { db, metaData } = await this.db.getAsync();
		if (!db.indexingSupported) return ExternalImageRule.None;
		const encryptedAddress = await encryptItem(address, metaData.key, metaData.iv);
		const transaction = await db.createTransaction(true, [ExternalImageListOS]);
		const entry = await transaction.get(ExternalImageListOS, encryptedAddress);
		let rule = ExternalImageRule.None;
		if (entry != null) if (entry.rule != null) rule = entry.rule;
else {
			await addAddressToImageList(db, encryptedAddress, ExternalImageRule.Allow);
			rule = ExternalImageRule.Allow;
		}
		return rule;
	}
	async loadConfigDb(user, keyLoaderFacade) {
		const id = this.getDbId(user._id);
		const db = new DbFacade(VERSION, async (event, db$1, dbFacade) => {
			if (event.oldVersion === 0) {
				db$1.createObjectStore(ConfigurationMetaDataOS);
				db$1.createObjectStore(ExternalImageListOS, { keyPath: "address" });
			}
			const metaData$1 = await loadEncryptionMetadata(dbFacade, id, keyLoaderFacade, ConfigurationMetaDataOS) || await initializeDb(dbFacade, id, keyLoaderFacade, ConfigurationMetaDataOS);
			if (event.oldVersion === 1) {
				const transaction = await dbFacade.createTransaction(true, [ExternalImageListOS]);
				const entries = await transaction.getAll(ExternalImageListOS);
				const { key, iv } = metaData$1;
				for (const entry of entries) {
					const address = await decryptLegacyItem(new Uint8Array(downcast(entry.key)), key, iv);
					await this.addExternalImageRule(address, entry.value.rule);
					const deleteTransaction = await dbFacade.createTransaction(false, [ExternalImageListOS]);
					await deleteTransaction.delete(ExternalImageListOS, entry.key);
				}
			}
		});
		const metaData = await loadEncryptionMetadata(db, id, keyLoaderFacade, ConfigurationMetaDataOS) || await initializeDb(db, id, keyLoaderFacade, ConfigurationMetaDataOS);
		return {
			db,
			metaData
		};
	}
	async onEntityEventsReceived(batch) {
		const { events, groupId, batchId } = batch;
		for (const event of events) {
			if (!(event.operation === OperationType.UPDATE && isSameTypeRefByAttr(UserTypeRef, event.application, event.type))) continue;
			const configDb = await this.db.getAsync();
			if (configDb.db.isSameDbId(this.getDbId(event.instanceId))) return updateEncryptionMetadata(configDb.db, this.keyLoaderFacade, ConfigurationMetaDataOS);
		}
	}
	async delete(userId) {
		const dbId = this.getDbId(userId);
		if (this.db.isLoadedOrLoading()) {
			const { db } = await this.db.getAsync();
			await db.deleteDatabase(dbId);
		} else await DbFacade.deleteDb(dbId);
	}
	getDbId(userId) {
		return `${DB_KEY_PREFIX}_${b64UserIdHash(userId)}`;
	}
};
async function decryptMetaData(keyLoaderFacade, metaData) {
	const userGroupKey = await keyLoaderFacade.loadSymUserGroupKey(metaData.userGroupKeyVersion);
	const key = decryptKey(userGroupKey, metaData.userEncDbKey);
	const iv = unauthenticatedAesDecrypt(key, metaData.encDbIv);
	return {
		key,
		iv
	};
}
async function loadEncryptionMetadata(db, id, keyLoaderFacade, objectStoreName) {
	await db.open(id);
	const metaData = await getMetaData(db, objectStoreName);
	if (metaData != null) return await decryptMetaData(keyLoaderFacade, metaData);
else return null;
}
async function updateEncryptionMetadata(db, keyLoaderFacade, objectStoreName) {
	const metaData = await getMetaData(db, objectStoreName);
	const currentUserGroupKey = keyLoaderFacade.getCurrentSymUserGroupKey();
	if (metaData == null || currentUserGroupKey.version === metaData.userGroupKeyVersion) return;
	const encryptionMetadata = await decryptMetaData(keyLoaderFacade, metaData);
	if (encryptionMetadata == null) return;
	const { key, iv } = encryptionMetadata;
	await encryptAndSaveDbKey(currentUserGroupKey, key, iv, db, objectStoreName);
}
async function getMetaData(db, objectStoreName) {
	const transaction = await db.createTransaction(true, [objectStoreName]);
	const userEncDbKey = await transaction.get(objectStoreName, Metadata.userEncDbKey);
	const encDbIv = await transaction.get(objectStoreName, Metadata.encDbIv);
	const userGroupKeyVersion = checkKeyVersionConstraints(await transaction.get(objectStoreName, Metadata.userGroupKeyVersion) ?? 0);
	if (userEncDbKey == null || encDbIv == null) return null;
else return {
		userEncDbKey,
		encDbIv,
		userGroupKeyVersion
	};
}
async function getIndexerMetaData(db, objectStoreName) {
	const transaction = await db.createTransaction(true, [objectStoreName]);
	const userEncDbKey = await transaction.get(objectStoreName, Metadata.userEncDbKey);
	const encDbIv = await transaction.get(objectStoreName, Metadata.encDbIv);
	const userGroupKeyVersion = checkKeyVersionConstraints(await transaction.get(objectStoreName, Metadata.userGroupKeyVersion) ?? 0);
	const mailIndexingEnabled = await transaction.get(objectStoreName, Metadata.mailIndexingEnabled);
	const excludedListIds = await transaction.get(objectStoreName, Metadata.excludedListIds);
	const lastEventIndexTimeMs = await transaction.get(objectStoreName, Metadata.lastEventIndexTimeMs);
	if (userEncDbKey == null || encDbIv == null) return null;
else return {
		userEncDbKey,
		encDbIv,
		userGroupKeyVersion,
		mailIndexingEnabled,
		excludedListIds,
		lastEventIndexTimeMs
	};
}
async function encryptAndSaveDbKey(userGroupKey, dbKey, dbIv, db, objectStoreName) {
	const transaction = await db.createTransaction(false, [objectStoreName]);
	const groupEncSessionKey = encryptKeyWithVersionedKey(userGroupKey, dbKey);
	await transaction.put(objectStoreName, Metadata.userEncDbKey, groupEncSessionKey.key);
	await transaction.put(objectStoreName, Metadata.userGroupKeyVersion, groupEncSessionKey.encryptingKeyVersion);
	await transaction.put(objectStoreName, Metadata.encDbIv, aesEncrypt(dbKey, dbIv));
}
async function initializeDb(db, id, keyLoaderFacade, objectStoreName) {
	await db.deleteDatabase(id).then(() => db.open(id));
	const key = aes256RandomKey();
	const iv = random.generateRandomData(IV_BYTE_LENGTH);
	const userGroupKey = keyLoaderFacade.getCurrentSymUserGroupKey();
	await encryptAndSaveDbKey(userGroupKey, key, iv, db, objectStoreName);
	return {
		key,
		iv
	};
}
async function addAddressToImageList(db, encryptedAddress, rule) {
	try {
		const transaction = await db.createTransaction(false, [ExternalImageListOS]);
		await transaction.put(ExternalImageListOS, null, {
			address: encryptedAddress,
			rule
		});
	} catch (e) {
		if (e instanceof DbError) {
			console.error("failed to add address to image list:", e.message);
			return;
		}
		throw e;
	}
}

//#endregion
export { ConfigurationDatabase, ConfigurationMetaDataOS, decryptLegacyItem, encryptItem, getIndexerMetaData, getMetaData, initializeDb, loadEncryptionMetadata, updateEncryptionMetadata };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29uZmlndXJhdGlvbkRhdGFiYXNlLWNodW5rLmpzIiwibmFtZXMiOlsiVkVSU0lPTjogbnVtYmVyIiwiREJfS0VZX1BSRUZJWDogc3RyaW5nIiwiRXh0ZXJuYWxJbWFnZUxpc3RPUzogT2JqZWN0U3RvcmVOYW1lIiwiQ29uZmlndXJhdGlvbk1ldGFEYXRhT1M6IE9iamVjdFN0b3JlTmFtZSIsIml0ZW06IHN0cmluZyIsImtleTogQWVzMjU2S2V5IiwiaXY6IFVpbnQ4QXJyYXkiLCJlbmNyeXB0ZWRBZGRyZXNzOiBVaW50OEFycmF5Iiwia2V5TG9hZGVyRmFjYWRlOiBLZXlMb2FkZXJGYWNhZGUiLCJ1c2VyRmFjYWRlOiBVc2VyRmFjYWRlIiwiZGJMb2FkRm46IChhcmcwOiBVc2VyLCBhcmcxOiBLZXlMb2FkZXJGYWNhZGUpID0+IFByb21pc2U8Q29uZmlnRGI+IiwidXNlcjogVXNlciIsImtleUxvYWRlckZhY2FkZSIsImFkZHJlc3M6IHN0cmluZyIsInJ1bGU6IEV4dGVybmFsSW1hZ2VSdWxlIiwiZGIiLCJtZXRhRGF0YSIsImJhdGNoOiBRdWV1ZWRCYXRjaCIsInVzZXJJZDogSWQiLCJtZXRhRGF0YTogRW5jcnlwdGVkRGJLZXlCYXNlTWV0YURhdGEiLCJkYjogRGJGYWNhZGUiLCJpZDogc3RyaW5nIiwib2JqZWN0U3RvcmVOYW1lOiBPYmplY3RTdG9yZU5hbWUiLCJ1c2VyR3JvdXBLZXk6IFZlcnNpb25lZEtleSIsImRiS2V5OiBBZXNLZXkiLCJkYkl2OiBVaW50OEFycmF5Iiwib2JqZWN0U3RvcmVOYW1lOiBzdHJpbmciXSwic291cmNlcyI6WyIuLi9zcmMvY29tbW9uL2FwaS93b3JrZXIvZmFjYWRlcy9sYXp5L0NvbmZpZ3VyYXRpb25EYXRhYmFzZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBiNjRVc2VySWRIYXNoLCBEYkZhY2FkZSB9IGZyb20gXCIuLi8uLi9zZWFyY2gvRGJGYWNhZGUuanNcIlxuaW1wb3J0IHsgYXNzZXJ0Tm90TnVsbCwgY29uY2F0LCBkb3duY2FzdCwgaXNTYW1lVHlwZVJlZkJ5QXR0ciwgTGF6eUxvYWRlZCwgc3RyaW5nVG9VdGY4VWludDhBcnJheSwgdXRmOFVpbnQ4QXJyYXlUb1N0cmluZyB9IGZyb20gXCJAdHV0YW8vdHV0YW5vdGEtdXRpbHNcIlxuaW1wb3J0IHsgVXNlciwgVXNlclR5cGVSZWYgfSBmcm9tIFwiLi4vLi4vLi4vZW50aXRpZXMvc3lzL1R5cGVSZWZzLmpzXCJcbmltcG9ydCB7IEV4dGVybmFsSW1hZ2VSdWxlLCBPcGVyYXRpb25UeXBlIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9UdXRhbm90YUNvbnN0YW50cy5qc1wiXG5pbXBvcnQge1xuXHRBZXMxMjhLZXksXG5cdEFlczI1NktleSxcblx0YWVzMjU2UmFuZG9tS2V5LFxuXHRhZXNFbmNyeXB0LFxuXHRBZXNLZXksXG5cdGRlY3J5cHRLZXksXG5cdElWX0JZVEVfTEVOR1RILFxuXHRyYW5kb20sXG5cdHVuYXV0aGVudGljYXRlZEFlc0RlY3J5cHQsXG59IGZyb20gXCJAdHV0YW8vdHV0YW5vdGEtY3J5cHRvXCJcbmltcG9ydCB7IFVzZXJGYWNhZGUgfSBmcm9tIFwiLi4vVXNlckZhY2FkZS5qc1wiXG5pbXBvcnQgeyBFbmNyeXB0ZWREYktleUJhc2VNZXRhRGF0YSwgRW5jcnlwdGVkSW5kZXhlck1ldGFEYXRhLCBNZXRhZGF0YSwgT2JqZWN0U3RvcmVOYW1lIH0gZnJvbSBcIi4uLy4uL3NlYXJjaC9JbmRleFRhYmxlcy5qc1wiXG5pbXBvcnQgeyBEYkVycm9yIH0gZnJvbSBcIi4uLy4uLy4uL2NvbW1vbi9lcnJvci9EYkVycm9yLmpzXCJcbmltcG9ydCB7IGNoZWNrS2V5VmVyc2lvbkNvbnN0cmFpbnRzLCBLZXlMb2FkZXJGYWNhZGUgfSBmcm9tIFwiLi4vS2V5TG9hZGVyRmFjYWRlLmpzXCJcbmltcG9ydCB0eXBlIHsgUXVldWVkQmF0Y2ggfSBmcm9tIFwiLi4vLi4vRXZlbnRRdWV1ZS5qc1wiXG5pbXBvcnQgeyBlbmNyeXB0S2V5V2l0aFZlcnNpb25lZEtleSwgVmVyc2lvbmVkS2V5IH0gZnJvbSBcIi4uLy4uL2NyeXB0by9DcnlwdG9XcmFwcGVyLmpzXCJcblxuY29uc3QgVkVSU0lPTjogbnVtYmVyID0gMlxuY29uc3QgREJfS0VZX1BSRUZJWDogc3RyaW5nID0gXCJDb25maWdTdG9yYWdlXCJcbmNvbnN0IEV4dGVybmFsSW1hZ2VMaXN0T1M6IE9iamVjdFN0b3JlTmFtZSA9IFwiRXh0ZXJuYWxBbGxvd0xpc3RPU1wiXG5leHBvcnQgY29uc3QgQ29uZmlndXJhdGlvbk1ldGFEYXRhT1M6IE9iamVjdFN0b3JlTmFtZSA9IFwiTWV0YURhdGFPU1wiXG50eXBlIEVuY3J5cHRpb25NZXRhZGF0YSA9IHtcblx0cmVhZG9ubHkga2V5OiBBZXMxMjhLZXlcblx0cmVhZG9ubHkgaXY6IFVpbnQ4QXJyYXlcbn1cbnR5cGUgQ29uZmlnRGIgPSB7XG5cdHJlYWRvbmx5IGRiOiBEYkZhY2FkZVxuXHRyZWFkb25seSBtZXRhRGF0YTogRW5jcnlwdGlvbk1ldGFkYXRhXG59XG5cbi8qKiBAUHVibGljRm9yVGVzdGluZyAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGVuY3J5cHRJdGVtKGl0ZW06IHN0cmluZywga2V5OiBBZXMyNTZLZXksIGl2OiBVaW50OEFycmF5KTogUHJvbWlzZTxVaW50OEFycmF5PiB7XG5cdHJldHVybiBhZXNFbmNyeXB0KGtleSwgc3RyaW5nVG9VdGY4VWludDhBcnJheShpdGVtKSwgaXYsIHRydWUpXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWNyeXB0TGVnYWN5SXRlbShlbmNyeXB0ZWRBZGRyZXNzOiBVaW50OEFycmF5LCBrZXk6IEFlczI1NktleSwgaXY6IFVpbnQ4QXJyYXkpOiBQcm9taXNlPHN0cmluZz4ge1xuXHRyZXR1cm4gdXRmOFVpbnQ4QXJyYXlUb1N0cmluZyh1bmF1dGhlbnRpY2F0ZWRBZXNEZWNyeXB0KGtleSwgY29uY2F0KGl2LCBlbmNyeXB0ZWRBZGRyZXNzKSkpXG59XG5cbi8qKlxuICogQSBsb2NhbCBjb25maWd1cmF0aW9uIGRhdGFiYXNlIHRoYXQgY2FuIGJlIHVzZWQgYXMgYW4gYWx0ZXJuYXRpdmUgdG8gRGV2aWNlQ29uZmlnOlxuICogSWRlYWwgZm9yIGNhc2VzIHdoZXJlIHRoZSBjb25maWd1cmF0aW9uIHZhbHVlcyBzaG91bGQgYmUgc3RvcmVkIGVuY3J5cHRlZCxcbiAqIE9yIHdoZW4gdGhlIGNvbmZpZ3VyYXRpb24gaXMgYSBncm93aW5nIGxpc3Qgb3Igb2JqZWN0LCB3aGljaCB3b3VsZCBiZSB1bnN1aXRhYmxlIGZvciBsb2NhbFN0b3JhZ2VcbiAqIE9yIHdoZW4gdGhlIGNvbmZpZ3VyYXRpb24gaXMgb25seSByZXF1aXJlZCBpbiB0aGUgV29ya2VyXG4gKi9cbmV4cG9ydCBjbGFzcyBDb25maWd1cmF0aW9uRGF0YWJhc2Uge1xuXHQvLyB2aXNpYmxlIGZvciB0ZXN0aW5nXG5cdHJlYWRvbmx5IGRiOiBMYXp5TG9hZGVkPENvbmZpZ0RiPlxuXG5cdGNvbnN0cnVjdG9yKFxuXHRcdHByaXZhdGUgcmVhZG9ubHkga2V5TG9hZGVyRmFjYWRlOiBLZXlMb2FkZXJGYWNhZGUsXG5cdFx0dXNlckZhY2FkZTogVXNlckZhY2FkZSxcblx0XHRkYkxvYWRGbjogKGFyZzA6IFVzZXIsIGFyZzE6IEtleUxvYWRlckZhY2FkZSkgPT4gUHJvbWlzZTxDb25maWdEYj4gPSAodXNlcjogVXNlciwga2V5TG9hZGVyRmFjYWRlOiBLZXlMb2FkZXJGYWNhZGUpID0+XG5cdFx0XHR0aGlzLmxvYWRDb25maWdEYih1c2VyLCBrZXlMb2FkZXJGYWNhZGUpLFxuXHQpIHtcblx0XHR0aGlzLmRiID0gbmV3IExhenlMb2FkZWQoKCkgPT4ge1xuXHRcdFx0Y29uc3QgdXNlciA9IGFzc2VydE5vdE51bGwodXNlckZhY2FkZS5nZXRMb2dnZWRJblVzZXIoKSlcblx0XHRcdHJldHVybiBkYkxvYWRGbih1c2VyLCBrZXlMb2FkZXJGYWNhZGUpXG5cdFx0fSlcblx0fVxuXG5cdGFzeW5jIGFkZEV4dGVybmFsSW1hZ2VSdWxlKGFkZHJlc3M6IHN0cmluZywgcnVsZTogRXh0ZXJuYWxJbWFnZVJ1bGUpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRjb25zdCB7IGRiLCBtZXRhRGF0YSB9ID0gYXdhaXQgdGhpcy5kYi5nZXRBc3luYygpXG5cdFx0aWYgKCFkYi5pbmRleGluZ1N1cHBvcnRlZCkgcmV0dXJuXG5cdFx0Y29uc3QgZW5jcnlwdGVkQWRkcmVzcyA9IGF3YWl0IGVuY3J5cHRJdGVtKGFkZHJlc3MsIG1ldGFEYXRhLmtleSwgbWV0YURhdGEuaXYpXG5cdFx0cmV0dXJuIGFkZEFkZHJlc3NUb0ltYWdlTGlzdChkYiwgZW5jcnlwdGVkQWRkcmVzcywgcnVsZSlcblx0fVxuXG5cdGFzeW5jIGdldEV4dGVybmFsSW1hZ2VSdWxlKGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8RXh0ZXJuYWxJbWFnZVJ1bGU+IHtcblx0XHRjb25zdCB7IGRiLCBtZXRhRGF0YSB9ID0gYXdhaXQgdGhpcy5kYi5nZXRBc3luYygpXG5cdFx0aWYgKCFkYi5pbmRleGluZ1N1cHBvcnRlZCkgcmV0dXJuIEV4dGVybmFsSW1hZ2VSdWxlLk5vbmVcblx0XHRjb25zdCBlbmNyeXB0ZWRBZGRyZXNzID0gYXdhaXQgZW5jcnlwdEl0ZW0oYWRkcmVzcywgbWV0YURhdGEua2V5LCBtZXRhRGF0YS5pdilcblx0XHRjb25zdCB0cmFuc2FjdGlvbiA9IGF3YWl0IGRiLmNyZWF0ZVRyYW5zYWN0aW9uKHRydWUsIFtFeHRlcm5hbEltYWdlTGlzdE9TXSlcblx0XHRjb25zdCBlbnRyeSA9IGF3YWl0IHRyYW5zYWN0aW9uLmdldChFeHRlcm5hbEltYWdlTGlzdE9TLCBlbmNyeXB0ZWRBZGRyZXNzKVxuXHRcdGxldCBydWxlID0gRXh0ZXJuYWxJbWFnZVJ1bGUuTm9uZVxuXG5cdFx0aWYgKGVudHJ5ICE9IG51bGwpIHtcblx0XHRcdGlmIChlbnRyeS5ydWxlICE9IG51bGwpIHtcblx0XHRcdFx0cnVsZSA9IGVudHJ5LnJ1bGVcblx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdC8vIE5vIHJ1bGUgc2V0IGZyb20gZWFybGllciB2ZXJzaW9uIG1lYW5zIEFsbG93XG5cdFx0XHRcdGF3YWl0IGFkZEFkZHJlc3NUb0ltYWdlTGlzdChkYiwgZW5jcnlwdGVkQWRkcmVzcywgRXh0ZXJuYWxJbWFnZVJ1bGUuQWxsb3cpXG5cdFx0XHRcdHJ1bGUgPSBFeHRlcm5hbEltYWdlUnVsZS5BbGxvd1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiBydWxlXG5cdH1cblxuXHRhc3luYyBsb2FkQ29uZmlnRGIodXNlcjogVXNlciwga2V5TG9hZGVyRmFjYWRlOiBLZXlMb2FkZXJGYWNhZGUpOiBQcm9taXNlPENvbmZpZ0RiPiB7XG5cdFx0Y29uc3QgaWQgPSB0aGlzLmdldERiSWQodXNlci5faWQpXG5cdFx0Y29uc3QgZGIgPSBuZXcgRGJGYWNhZGUoVkVSU0lPTiwgYXN5bmMgKGV2ZW50LCBkYiwgZGJGYWNhZGUpID0+IHtcblx0XHRcdGlmIChldmVudC5vbGRWZXJzaW9uID09PSAwKSB7XG5cdFx0XHRcdGRiLmNyZWF0ZU9iamVjdFN0b3JlKENvbmZpZ3VyYXRpb25NZXRhRGF0YU9TKVxuXHRcdFx0XHRkYi5jcmVhdGVPYmplY3RTdG9yZShFeHRlcm5hbEltYWdlTGlzdE9TLCB7XG5cdFx0XHRcdFx0a2V5UGF0aDogXCJhZGRyZXNzXCIsXG5cdFx0XHRcdH0pXG5cdFx0XHR9XG5cdFx0XHRjb25zdCBtZXRhRGF0YSA9XG5cdFx0XHRcdChhd2FpdCBsb2FkRW5jcnlwdGlvbk1ldGFkYXRhKGRiRmFjYWRlLCBpZCwga2V5TG9hZGVyRmFjYWRlLCBDb25maWd1cmF0aW9uTWV0YURhdGFPUykpIHx8XG5cdFx0XHRcdChhd2FpdCBpbml0aWFsaXplRGIoZGJGYWNhZGUsIGlkLCBrZXlMb2FkZXJGYWNhZGUsIENvbmZpZ3VyYXRpb25NZXRhRGF0YU9TKSlcblxuXHRcdFx0aWYgKGV2ZW50Lm9sZFZlcnNpb24gPT09IDEpIHtcblx0XHRcdFx0Ly8gbWlncmF0ZSBmcm9tIHBsYWluLCBtYWMtYW5kLXN0YXRpYy1pdiBhZXMyNTYgdG8gYWVzMjU2IHdpdGggbWFjXG5cdFx0XHRcdGNvbnN0IHRyYW5zYWN0aW9uID0gYXdhaXQgZGJGYWNhZGUuY3JlYXRlVHJhbnNhY3Rpb24odHJ1ZSwgW0V4dGVybmFsSW1hZ2VMaXN0T1NdKVxuXHRcdFx0XHRjb25zdCBlbnRyaWVzID0gYXdhaXQgdHJhbnNhY3Rpb24uZ2V0QWxsKEV4dGVybmFsSW1hZ2VMaXN0T1MpXG5cdFx0XHRcdGNvbnN0IHsga2V5LCBpdiB9ID0gbWV0YURhdGFcblx0XHRcdFx0Zm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7XG5cdFx0XHRcdFx0Y29uc3QgYWRkcmVzcyA9IGF3YWl0IGRlY3J5cHRMZWdhY3lJdGVtKG5ldyBVaW50OEFycmF5KGRvd25jYXN0KGVudHJ5LmtleSkpLCBrZXksIGl2KVxuXHRcdFx0XHRcdGF3YWl0IHRoaXMuYWRkRXh0ZXJuYWxJbWFnZVJ1bGUoYWRkcmVzcywgZW50cnkudmFsdWUucnVsZSlcblx0XHRcdFx0XHRjb25zdCBkZWxldGVUcmFuc2FjdGlvbiA9IGF3YWl0IGRiRmFjYWRlLmNyZWF0ZVRyYW5zYWN0aW9uKGZhbHNlLCBbRXh0ZXJuYWxJbWFnZUxpc3RPU10pXG5cdFx0XHRcdFx0YXdhaXQgZGVsZXRlVHJhbnNhY3Rpb24uZGVsZXRlKEV4dGVybmFsSW1hZ2VMaXN0T1MsIGVudHJ5LmtleSlcblx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0pXG5cdFx0Y29uc3QgbWV0YURhdGEgPVxuXHRcdFx0KGF3YWl0IGxvYWRFbmNyeXB0aW9uTWV0YWRhdGEoZGIsIGlkLCBrZXlMb2FkZXJGYWNhZGUsIENvbmZpZ3VyYXRpb25NZXRhRGF0YU9TKSkgfHxcblx0XHRcdChhd2FpdCBpbml0aWFsaXplRGIoZGIsIGlkLCBrZXlMb2FkZXJGYWNhZGUsIENvbmZpZ3VyYXRpb25NZXRhRGF0YU9TKSlcblx0XHRyZXR1cm4ge1xuXHRcdFx0ZGIsXG5cdFx0XHRtZXRhRGF0YSxcblx0XHR9XG5cdH1cblxuXHRhc3luYyBvbkVudGl0eUV2ZW50c1JlY2VpdmVkKGJhdGNoOiBRdWV1ZWRCYXRjaCk6IFByb21pc2U8YW55PiB7XG5cdFx0Y29uc3QgeyBldmVudHMsIGdyb3VwSWQsIGJhdGNoSWQgfSA9IGJhdGNoXG5cdFx0Zm9yIChjb25zdCBldmVudCBvZiBldmVudHMpIHtcblx0XHRcdGlmICghKGV2ZW50Lm9wZXJhdGlvbiA9PT0gT3BlcmF0aW9uVHlwZS5VUERBVEUgJiYgaXNTYW1lVHlwZVJlZkJ5QXR0cihVc2VyVHlwZVJlZiwgZXZlbnQuYXBwbGljYXRpb24sIGV2ZW50LnR5cGUpKSkge1xuXHRcdFx0XHRjb250aW51ZVxuXHRcdFx0fVxuXHRcdFx0Y29uc3QgY29uZmlnRGIgPSBhd2FpdCB0aGlzLmRiLmdldEFzeW5jKClcblx0XHRcdGlmIChjb25maWdEYi5kYi5pc1NhbWVEYklkKHRoaXMuZ2V0RGJJZChldmVudC5pbnN0YW5jZUlkKSkpIHtcblx0XHRcdFx0cmV0dXJuIHVwZGF0ZUVuY3J5cHRpb25NZXRhZGF0YShjb25maWdEYi5kYiwgdGhpcy5rZXlMb2FkZXJGYWNhZGUsIENvbmZpZ3VyYXRpb25NZXRhRGF0YU9TKVxuXHRcdFx0fVxuXHRcdH1cblx0fVxuXG5cdGFzeW5jIGRlbGV0ZSh1c2VySWQ6IElkKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0Y29uc3QgZGJJZCA9IHRoaXMuZ2V0RGJJZCh1c2VySWQpXG5cdFx0aWYgKHRoaXMuZGIuaXNMb2FkZWRPckxvYWRpbmcoKSkge1xuXHRcdFx0Y29uc3QgeyBkYiB9ID0gYXdhaXQgdGhpcy5kYi5nZXRBc3luYygpXG5cdFx0XHRhd2FpdCBkYi5kZWxldGVEYXRhYmFzZShkYklkKVxuXHRcdH0gZWxzZSB7XG5cdFx0XHRhd2FpdCBEYkZhY2FkZS5kZWxldGVEYihkYklkKVxuXHRcdH1cblx0fVxuXG5cdHByaXZhdGUgZ2V0RGJJZCh1c2VySWQ6IElkKTogc3RyaW5nIHtcblx0XHRyZXR1cm4gYCR7REJfS0VZX1BSRUZJWH1fJHtiNjRVc2VySWRIYXNoKHVzZXJJZCl9YFxuXHR9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRlY3J5cHRNZXRhRGF0YShrZXlMb2FkZXJGYWNhZGU6IEtleUxvYWRlckZhY2FkZSwgbWV0YURhdGE6IEVuY3J5cHRlZERiS2V5QmFzZU1ldGFEYXRhKTogUHJvbWlzZTxFbmNyeXB0aW9uTWV0YWRhdGE+IHtcblx0Y29uc3QgdXNlckdyb3VwS2V5ID0gYXdhaXQga2V5TG9hZGVyRmFjYWRlLmxvYWRTeW1Vc2VyR3JvdXBLZXkobWV0YURhdGEudXNlckdyb3VwS2V5VmVyc2lvbilcblx0Y29uc3Qga2V5ID0gZGVjcnlwdEtleSh1c2VyR3JvdXBLZXksIG1ldGFEYXRhLnVzZXJFbmNEYktleSlcblx0Y29uc3QgaXYgPSB1bmF1dGhlbnRpY2F0ZWRBZXNEZWNyeXB0KGtleSwgbWV0YURhdGEuZW5jRGJJdilcblx0cmV0dXJuIHtcblx0XHRrZXksXG5cdFx0aXYsXG5cdH1cbn1cblxuLyoqXG4gKiBMb2FkIHRoZSBlbmNyeXB0aW9uIGtleSBhbmQgaXYgZnJvbSB0aGUgZGJcbiAqIEByZXR1cm4geyBrZXksIGl2IH0gb3IgbnVsbCBpZiBvbmUgb3IgYm90aCBkb24ndCBleGlzdFxuICogQFZpc2libGVGb3JUZXN0aW5nXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBsb2FkRW5jcnlwdGlvbk1ldGFkYXRhKFxuXHRkYjogRGJGYWNhZGUsXG5cdGlkOiBzdHJpbmcsXG5cdGtleUxvYWRlckZhY2FkZTogS2V5TG9hZGVyRmFjYWRlLFxuXHRvYmplY3RTdG9yZU5hbWU6IE9iamVjdFN0b3JlTmFtZSxcbik6IFByb21pc2U8RW5jcnlwdGlvbk1ldGFkYXRhIHwgbnVsbD4ge1xuXHRhd2FpdCBkYi5vcGVuKGlkKVxuXHRjb25zdCBtZXRhRGF0YSA9IGF3YWl0IGdldE1ldGFEYXRhKGRiLCBvYmplY3RTdG9yZU5hbWUpXG5cdGlmIChtZXRhRGF0YSAhPSBudWxsKSB7XG5cdFx0cmV0dXJuIGF3YWl0IGRlY3J5cHRNZXRhRGF0YShrZXlMb2FkZXJGYWNhZGUsIG1ldGFEYXRhKVxuXHR9IGVsc2Uge1xuXHRcdHJldHVybiBudWxsXG5cdH1cbn1cblxuLyoqXG4gKiBSZWVuY3J5cHQgdGhlIERCIGtleSBhbmQgSVYgaWYgdGhlcmUgaXMgYSBuZXcgdXNlckdyb3VwS2V5XG4gKiBAVmlzaWJsZUZvclRlc3RpbmdcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUVuY3J5cHRpb25NZXRhZGF0YShkYjogRGJGYWNhZGUsIGtleUxvYWRlckZhY2FkZTogS2V5TG9hZGVyRmFjYWRlLCBvYmplY3RTdG9yZU5hbWU6IE9iamVjdFN0b3JlTmFtZSk6IFByb21pc2U8dm9pZD4ge1xuXHRjb25zdCBtZXRhRGF0YSA9IGF3YWl0IGdldE1ldGFEYXRhKGRiLCBvYmplY3RTdG9yZU5hbWUpXG5cdGNvbnN0IGN1cnJlbnRVc2VyR3JvdXBLZXkgPSBrZXlMb2FkZXJGYWNhZGUuZ2V0Q3VycmVudFN5bVVzZXJHcm91cEtleSgpXG5cblx0aWYgKG1ldGFEYXRhID09IG51bGwgfHwgY3VycmVudFVzZXJHcm91cEtleS52ZXJzaW9uID09PSBtZXRhRGF0YS51c2VyR3JvdXBLZXlWZXJzaW9uKSByZXR1cm5cblxuXHRjb25zdCBlbmNyeXB0aW9uTWV0YWRhdGEgPSBhd2FpdCBkZWNyeXB0TWV0YURhdGEoa2V5TG9hZGVyRmFjYWRlLCBtZXRhRGF0YSlcblx0aWYgKGVuY3J5cHRpb25NZXRhZGF0YSA9PSBudWxsKSByZXR1cm5cblx0Y29uc3QgeyBrZXksIGl2IH0gPSBlbmNyeXB0aW9uTWV0YWRhdGFcblx0YXdhaXQgZW5jcnlwdEFuZFNhdmVEYktleShjdXJyZW50VXNlckdyb3VwS2V5LCBrZXksIGl2LCBkYiwgb2JqZWN0U3RvcmVOYW1lKVxufVxuXG4vKipcbiAqIEhlbHBlciBmdW5jdGlvbiB0byBnZXQgdGhlIGdyb3VwIGtleSB2ZXJzaW9uIGZvciB0aGUgZ3JvdXAga2V5IHRoYXQgd2FzIHVzZWQgdG8gZW5jcnlwdCB0aGUgZGIga2V5LiBJbiBjYXNlIHRoZSB2ZXJzaW9uIGhhcyBub3QgYmVlbiB3cml0dGVuIHRvIHRoZSBkYiB3ZSBhc3N1bWUgMC5cbiAqIEBwYXJhbSBkYiB0aGUgZGJGYWNhZGUgY29ycmVzcG9uZGluZyB0byB0aGUgb2JqZWN0IHN0b3JlXG4gKiBAcGFyYW0gb2JqZWN0U3RvcmVOYW1lIHRoZSBvYmplY3RTdG9yZSB0byBnZXQgdGhlIG1ldGFkYXRhIGZyb21cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldE1ldGFEYXRhKGRiOiBEYkZhY2FkZSwgb2JqZWN0U3RvcmVOYW1lOiBPYmplY3RTdG9yZU5hbWUpOiBQcm9taXNlPEVuY3J5cHRlZERiS2V5QmFzZU1ldGFEYXRhIHwgbnVsbD4ge1xuXHRjb25zdCB0cmFuc2FjdGlvbiA9IGF3YWl0IGRiLmNyZWF0ZVRyYW5zYWN0aW9uKHRydWUsIFtvYmplY3RTdG9yZU5hbWVdKVxuXHRjb25zdCB1c2VyRW5jRGJLZXkgPSAoYXdhaXQgdHJhbnNhY3Rpb24uZ2V0KG9iamVjdFN0b3JlTmFtZSwgTWV0YWRhdGEudXNlckVuY0RiS2V5KSkgYXMgVWludDhBcnJheVxuXHRjb25zdCBlbmNEYkl2ID0gKGF3YWl0IHRyYW5zYWN0aW9uLmdldChvYmplY3RTdG9yZU5hbWUsIE1ldGFkYXRhLmVuY0RiSXYpKSBhcyBVaW50OEFycmF5XG5cdGNvbnN0IHVzZXJHcm91cEtleVZlcnNpb24gPSBjaGVja0tleVZlcnNpb25Db25zdHJhaW50cygoYXdhaXQgdHJhbnNhY3Rpb24uZ2V0PG51bWJlcj4ob2JqZWN0U3RvcmVOYW1lLCBNZXRhZGF0YS51c2VyR3JvdXBLZXlWZXJzaW9uKSkgPz8gMCkgLy8gd2FzIG5vdCB3cml0dGVuIGZvciBvbGQgZGJzXG5cdGlmICh1c2VyRW5jRGJLZXkgPT0gbnVsbCB8fCBlbmNEYkl2ID09IG51bGwpIHtcblx0XHRyZXR1cm4gbnVsbFxuXHR9IGVsc2Uge1xuXHRcdHJldHVybiB7XG5cdFx0XHR1c2VyRW5jRGJLZXksXG5cdFx0XHRlbmNEYkl2LFxuXHRcdFx0dXNlckdyb3VwS2V5VmVyc2lvbixcblx0XHR9XG5cdH1cbn1cblxuLyoqXG4gKiBIZWxwZXIgZnVuY3Rpb24gdG8gZ2V0IHRoZSBncm91cCBrZXkgdmVyc2lvbiBmb3IgdGhlIGdyb3VwIGtleSB0aGF0IHdhcyB1c2VkIHRvIGVuY3J5cHQgdGhlIGRiIGtleS4gSW4gY2FzZSB0aGUgdmVyc2lvbiBoYXMgbm90IGJlZW4gd3JpdHRlbiB0byB0aGUgZGIgd2UgYXNzdW1lIDAuXG4gKiBAcGFyYW0gZGIgdGhlIGRiRmFjYWRlIGNvcnJlc3BvbmRpbmcgdG8gdGhlIG9iamVjdCBzdG9yZVxuICogQHBhcmFtIG9iamVjdFN0b3JlTmFtZSB0aGUgb2JqZWN0U3RvcmUgdG8gZ2V0IHRoZSBtZXRhZGF0YSBmcm9tXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRJbmRleGVyTWV0YURhdGEoZGI6IERiRmFjYWRlLCBvYmplY3RTdG9yZU5hbWU6IE9iamVjdFN0b3JlTmFtZSk6IFByb21pc2U8RW5jcnlwdGVkSW5kZXhlck1ldGFEYXRhIHwgbnVsbD4ge1xuXHRjb25zdCB0cmFuc2FjdGlvbiA9IGF3YWl0IGRiLmNyZWF0ZVRyYW5zYWN0aW9uKHRydWUsIFtvYmplY3RTdG9yZU5hbWVdKVxuXHRjb25zdCB1c2VyRW5jRGJLZXkgPSAoYXdhaXQgdHJhbnNhY3Rpb24uZ2V0KG9iamVjdFN0b3JlTmFtZSwgTWV0YWRhdGEudXNlckVuY0RiS2V5KSkgYXMgVWludDhBcnJheVxuXHRjb25zdCBlbmNEYkl2ID0gKGF3YWl0IHRyYW5zYWN0aW9uLmdldChvYmplY3RTdG9yZU5hbWUsIE1ldGFkYXRhLmVuY0RiSXYpKSBhcyBVaW50OEFycmF5XG5cdGNvbnN0IHVzZXJHcm91cEtleVZlcnNpb24gPSBjaGVja0tleVZlcnNpb25Db25zdHJhaW50cygoYXdhaXQgdHJhbnNhY3Rpb24uZ2V0PG51bWJlcj4ob2JqZWN0U3RvcmVOYW1lLCBNZXRhZGF0YS51c2VyR3JvdXBLZXlWZXJzaW9uKSkgPz8gMCkgLy8gd2FzIG5vdCB3cml0dGVuIGZvciBvbGQgZGJzXG5cdGNvbnN0IG1haWxJbmRleGluZ0VuYWJsZWQgPSAoYXdhaXQgdHJhbnNhY3Rpb24uZ2V0KG9iamVjdFN0b3JlTmFtZSwgTWV0YWRhdGEubWFpbEluZGV4aW5nRW5hYmxlZCkpIGFzIGJvb2xlYW5cblx0Y29uc3QgZXhjbHVkZWRMaXN0SWRzID0gKGF3YWl0IHRyYW5zYWN0aW9uLmdldChvYmplY3RTdG9yZU5hbWUsIE1ldGFkYXRhLmV4Y2x1ZGVkTGlzdElkcykpIGFzIElkW11cblx0Y29uc3QgbGFzdEV2ZW50SW5kZXhUaW1lTXMgPSAoYXdhaXQgdHJhbnNhY3Rpb24uZ2V0KG9iamVjdFN0b3JlTmFtZSwgTWV0YWRhdGEubGFzdEV2ZW50SW5kZXhUaW1lTXMpKSBhcyBudW1iZXJcblx0aWYgKHVzZXJFbmNEYktleSA9PSBudWxsIHx8IGVuY0RiSXYgPT0gbnVsbCkge1xuXHRcdHJldHVybiBudWxsXG5cdH0gZWxzZSB7XG5cdFx0cmV0dXJuIHtcblx0XHRcdHVzZXJFbmNEYktleSxcblx0XHRcdGVuY0RiSXYsXG5cdFx0XHR1c2VyR3JvdXBLZXlWZXJzaW9uLFxuXHRcdFx0bWFpbEluZGV4aW5nRW5hYmxlZCxcblx0XHRcdGV4Y2x1ZGVkTGlzdElkcyxcblx0XHRcdGxhc3RFdmVudEluZGV4VGltZU1zLFxuXHRcdH1cblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiBlbmNyeXB0QW5kU2F2ZURiS2V5KHVzZXJHcm91cEtleTogVmVyc2lvbmVkS2V5LCBkYktleTogQWVzS2V5LCBkYkl2OiBVaW50OEFycmF5LCBkYjogRGJGYWNhZGUsIG9iamVjdFN0b3JlTmFtZTogc3RyaW5nKSB7XG5cdGNvbnN0IHRyYW5zYWN0aW9uID0gYXdhaXQgZGIuY3JlYXRlVHJhbnNhY3Rpb24oZmFsc2UsIFtvYmplY3RTdG9yZU5hbWVdKSAvLyBjcmVhdGUgYSBuZXcgdHJhbnNhY3Rpb24gdG8gYXZvaWQgdGltZW91dHMgYW5kIGZvciB3cml0aW5nXG5cdGNvbnN0IGdyb3VwRW5jU2Vzc2lvbktleSA9IGVuY3J5cHRLZXlXaXRoVmVyc2lvbmVkS2V5KHVzZXJHcm91cEtleSwgZGJLZXkpXG5cdGF3YWl0IHRyYW5zYWN0aW9uLnB1dChvYmplY3RTdG9yZU5hbWUsIE1ldGFkYXRhLnVzZXJFbmNEYktleSwgZ3JvdXBFbmNTZXNzaW9uS2V5LmtleSlcblx0YXdhaXQgdHJhbnNhY3Rpb24ucHV0KG9iamVjdFN0b3JlTmFtZSwgTWV0YWRhdGEudXNlckdyb3VwS2V5VmVyc2lvbiwgZ3JvdXBFbmNTZXNzaW9uS2V5LmVuY3J5cHRpbmdLZXlWZXJzaW9uKVxuXHRhd2FpdCB0cmFuc2FjdGlvbi5wdXQob2JqZWN0U3RvcmVOYW1lLCBNZXRhZGF0YS5lbmNEYkl2LCBhZXNFbmNyeXB0KGRiS2V5LCBkYkl2KSlcbn1cblxuLyoqXG4gKiBAY2F1dGlvbiBUaGlzIHdpbGwgY2xlYXIgYW55IGV4aXN0aW5nIGRhdGEgaW4gdGhlIGRhdGFiYXNlLCBiZWNhdXNlIHRoZXkga2V5IGFuZCBJViB3aWxsIGJlIHJlZ2VuZXJhdGVkXG4gKiBAcmV0dXJuIHRoZSBuZXdseSBnZW5lcmF0ZWQga2V5IGFuZCBpdiBmb3IgdGhlIGRhdGFiYXNlIGNvbnRlbnRzXG4gKiBAVmlzaWJsZUZvclRlc3RpbmdcbiAqXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBpbml0aWFsaXplRGIoZGI6IERiRmFjYWRlLCBpZDogc3RyaW5nLCBrZXlMb2FkZXJGYWNhZGU6IEtleUxvYWRlckZhY2FkZSwgb2JqZWN0U3RvcmVOYW1lOiBPYmplY3RTdG9yZU5hbWUpOiBQcm9taXNlPEVuY3J5cHRpb25NZXRhZGF0YT4ge1xuXHRhd2FpdCBkYi5kZWxldGVEYXRhYmFzZShpZCkudGhlbigoKSA9PiBkYi5vcGVuKGlkKSlcblx0Y29uc3Qga2V5ID0gYWVzMjU2UmFuZG9tS2V5KClcblx0Y29uc3QgaXYgPSByYW5kb20uZ2VuZXJhdGVSYW5kb21EYXRhKElWX0JZVEVfTEVOR1RIKVxuXHRjb25zdCB1c2VyR3JvdXBLZXkgPSBrZXlMb2FkZXJGYWNhZGUuZ2V0Q3VycmVudFN5bVVzZXJHcm91cEtleSgpXG5cdGF3YWl0IGVuY3J5cHRBbmRTYXZlRGJLZXkodXNlckdyb3VwS2V5LCBrZXksIGl2LCBkYiwgb2JqZWN0U3RvcmVOYW1lKVxuXHRyZXR1cm4ge1xuXHRcdGtleSxcblx0XHRpdixcblx0fVxufVxuXG5hc3luYyBmdW5jdGlvbiBhZGRBZGRyZXNzVG9JbWFnZUxpc3QoZGI6IERiRmFjYWRlLCBlbmNyeXB0ZWRBZGRyZXNzOiBVaW50OEFycmF5LCBydWxlOiBFeHRlcm5hbEltYWdlUnVsZSk6IFByb21pc2U8dm9pZD4ge1xuXHR0cnkge1xuXHRcdGNvbnN0IHRyYW5zYWN0aW9uID0gYXdhaXQgZGIuY3JlYXRlVHJhbnNhY3Rpb24oZmFsc2UsIFtFeHRlcm5hbEltYWdlTGlzdE9TXSlcblx0XHRhd2FpdCB0cmFuc2FjdGlvbi5wdXQoRXh0ZXJuYWxJbWFnZUxpc3RPUywgbnVsbCwge1xuXHRcdFx0YWRkcmVzczogZW5jcnlwdGVkQWRkcmVzcyxcblx0XHRcdHJ1bGU6IHJ1bGUsXG5cdFx0fSlcblx0fSBjYXRjaCAoZSkge1xuXHRcdGlmIChlIGluc3RhbmNlb2YgRGJFcnJvcikge1xuXHRcdFx0Y29uc29sZS5lcnJvcihcImZhaWxlZCB0byBhZGQgYWRkcmVzcyB0byBpbWFnZSBsaXN0OlwiLCBlLm1lc3NhZ2UpXG5cdFx0XHRyZXR1cm5cblx0XHR9XG5cdFx0dGhyb3cgZVxuXHR9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFzQkEsTUFBTUEsVUFBa0I7QUFDeEIsTUFBTUMsZ0JBQXdCO0FBQzlCLE1BQU1DLHNCQUF1QztNQUNoQ0MsMEJBQTJDO0FBV2pELGVBQWUsWUFBWUMsTUFBY0MsS0FBZ0JDLElBQXFDO0FBQ3BHLFFBQU8sV0FBVyxLQUFLLHVCQUF1QixLQUFLLEVBQUUsSUFBSSxLQUFLO0FBQzlEO0FBRU0sZUFBZSxrQkFBa0JDLGtCQUE4QkYsS0FBZ0JDLElBQWlDO0FBQ3RILFFBQU8sdUJBQXVCLDBCQUEwQixL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