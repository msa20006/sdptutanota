import { mithril_default } from "./mithril-chunk.js";
import { defer } from "./dist2-chunk.js";
import { lang } from "./LanguageViewModel-chunk.js";
import { Keys } from "./TutanotaConstants-chunk.js";
import { windowFacade } from "./WindowFacade-chunk.js";
import { CredentialAuthenticationError, KeyPermanentlyInvalidatedError } from "./ErrorUtils-chunk.js";
import { CancelledError } from "./CancelledError-chunk.js";
import { BaseButton, ButtonType } from "./Button-chunk.js";
import { DialogHeaderBar } from "./DialogHeaderBar-chunk.js";
import { Dialog, DialogType } from "./Dialog-chunk.js";
import { liveDataAttrs } from "./AriaUtils-chunk.js";
import { CredentialEncryptionMode } from "./CredentialEncryptionMode-chunk.js";
import { RadioSelector } from "./RadioSelector-chunk.js";

//#region src/common/gui/dialogs/SelectCredentialsEncryptionModeDialog.ts
const DEFAULT_CREDENTIAL_ENCRYPTION_MODE = CredentialEncryptionMode.DEVICE_LOCK;
async function showCredentialsEncryptionModeDialog(credentialsProvider) {
	await CredentialEncryptionMethodDialog.showAndWaitForSelection(credentialsProvider);
}
var CredentialEncryptionMethodDialog = class CredentialEncryptionMethodDialog {
	error;
	finished;
	dialog;
	constructor(credentialsProvider, supportedModes, previousSelection) {
		this.credentialsProvider = credentialsProvider;
		this.supportedModes = supportedModes;
		this.previousSelection = previousSelection;
		this.error = null;
		this.finished = defer();
		this.dialog = new Dialog(DialogType.EditMedium, { view: () => {
			return mithril_default("", [previousSelection == null ? mithril_default(DialogHeaderBar, { left: () => [{
				label: "skip_action",
				click: () => this.onModeSelected(DEFAULT_CREDENTIAL_ENCRYPTION_MODE),
				type: ButtonType.Secondary
			}] }) : null, mithril_default(SelectCredentialsEncryptionModeView, {
				class: "scroll pt plr-l height-100p",
				error: this.error,
				onConfirm: (mode) => this.onModeSelected(mode),
				supportedModes: this.supportedModes,
				previousSelection: this.previousSelection ?? DEFAULT_CREDENTIAL_ENCRYPTION_MODE
			})]);
		} }).addShortcut({
			help: "close_alt",
			key: Keys.ESC,
			exec: () => this.dialog.close()
		});
		this.dialog.setCloseHandler(() => {
			this.finished.resolve();
			this.dialog.close();
		});
	}
	static async showAndWaitForSelection(credentialsProvider) {
		const supportedModes = await credentialsProvider.getSupportedEncryptionModes();
		const previousSelection = await credentialsProvider.getCredentialEncryptionMode();
		const credentialsDialog = new CredentialEncryptionMethodDialog(credentialsProvider, supportedModes, previousSelection);
		credentialsDialog.dialog.show();
		await credentialsDialog.finished.promise;
	}
	async onModeSelected(mode) {
		try {
			await this.credentialsProvider.setCredentialEncryptionMode(mode);
			this.dialog.close();
			this.finished.resolve();
		} catch (e) {
			if (e instanceof CredentialAuthenticationError) {
				this.error = e.message;
				mithril_default.redraw();
			} else if (e instanceof KeyPermanentlyInvalidatedError) {
				await this.credentialsProvider.clearCredentials(e);
				this.dialog.close();
				await Dialog.message("credentialsKeyInvalidated_msg");
				windowFacade.reload({});
			} else if (e instanceof CancelledError) {} else throw e;
		}
	}
};
var SelectCredentialsEncryptionModeView = class {
	currentMode;
	constructor({ attrs }) {
		this.currentMode = attrs.previousSelection;
	}
	view({ attrs }) {
		const options = this.getSupportedOptions(attrs);
		const { onConfirm } = attrs;
		return [mithril_default(".flex.col", { class: attrs.class }, [
			attrs.error ? mithril_default(".small.center.statusTextColor.pb-s", liveDataAttrs(), attrs.error) : null,
			mithril_default("", lang.get("credentialsEncryptionModeSelection_msg")),
			mithril_default(".mt", mithril_default(RadioSelector, {
				name: "credentialsEncryptionMode_label",
				options,
				selectedOption: this.currentMode,
				onOptionSelected: (mode) => {
					this.currentMode = mode;
					attrs.onModeSelected?.(mode);
				}
			}))
		]), onConfirm ? this.renderSelectButton(() => onConfirm(this.currentMode)) : null];
	}
	getSupportedOptions(attrs) {
		const generateOption = (name, value) => ({
			name,
			value
		});
		const options = [
			generateOption("credentialsEncryptionModeDeviceLock_label", CredentialEncryptionMode.DEVICE_LOCK),
			generateOption("credentialsEncryptionModeDeviceCredentials_label", CredentialEncryptionMode.SYSTEM_PASSWORD),
			generateOption("credentialsEncryptionModeBiometrics_label", CredentialEncryptionMode.BIOMETRICS),
			generateOption("credentialsEncryptionModeAppPassword_label", CredentialEncryptionMode.APP_PASSWORD)
		];
		return options.filter((option) => attrs.supportedModes.includes(option.value));
	}
	renderSelectButton(onclick) {
		return mithril_default(BaseButton, {
			label: "ok_action",
			text: lang.get("ok_action"),
			class: "uppercase accent-bg full-width center b content-fg flash",
			style: { height: "60px" },
			onclick
		});
	}
};

//#endregion
export { showCredentialsEncryptionModeDialog };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VsZWN0Q3JlZGVudGlhbHNFbmNyeXB0aW9uTW9kZURpYWxvZy1jaHVuay5qcyIsIm5hbWVzIjpbImNyZWRlbnRpYWxzUHJvdmlkZXI6IENyZWRlbnRpYWxzUHJvdmlkZXIiLCJzdXBwb3J0ZWRNb2RlczogUmVhZG9ubHlBcnJheTxDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGU+IiwicHJldmlvdXNTZWxlY3Rpb246IENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZSB8IG51bGwiLCJtb2RlOiBDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGUiLCJhdHRyczogU2VsZWN0Q3JlZGVudGlhbEVuY3J5cHRpb25Nb2RlRGlhbG9nQXR0cnMiLCJuYW1lOiBUcmFuc2xhdGlvbktleSIsInZhbHVlOiBDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGUiLCJvbmNsaWNrOiAoKSA9PiB1bmtub3duIl0sInNvdXJjZXMiOlsiLi4vc3JjL2NvbW1vbi9ndWkvZGlhbG9ncy9TZWxlY3RDcmVkZW50aWFsc0VuY3J5cHRpb25Nb2RlRGlhbG9nLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZSB9IGZyb20gXCIuLi8uLi9taXNjL2NyZWRlbnRpYWxzL0NyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZS5qc1wiXG5pbXBvcnQgeyBEaWFsb2csIERpYWxvZ1R5cGUgfSBmcm9tIFwiLi4vYmFzZS9EaWFsb2dcIlxuaW1wb3J0IHR5cGUgeyBDcmVkZW50aWFsc1Byb3ZpZGVyIH0gZnJvbSBcIi4uLy4uL21pc2MvY3JlZGVudGlhbHMvQ3JlZGVudGlhbHNQcm92aWRlci5qc1wiXG5pbXBvcnQgbSwgeyBDaGlsZHJlbiwgQ29tcG9uZW50LCBWbm9kZSB9IGZyb20gXCJtaXRocmlsXCJcbmltcG9ydCB7IGxhbmcsIFRyYW5zbGF0aW9uS2V5IH0gZnJvbSBcIi4uLy4uL21pc2MvTGFuZ3VhZ2VWaWV3TW9kZWxcIlxuaW1wb3J0IHsgRGlhbG9nSGVhZGVyQmFyIH0gZnJvbSBcIi4uL2Jhc2UvRGlhbG9nSGVhZGVyQmFyXCJcbmltcG9ydCB0eXBlIHsgUmFkaW9TZWxlY3RvckF0dHJzLCBSYWRpb1NlbGVjdG9yT3B0aW9uIH0gZnJvbSBcIi4uL2Jhc2UvUmFkaW9TZWxlY3RvclwiXG5pbXBvcnQgeyBSYWRpb1NlbGVjdG9yIH0gZnJvbSBcIi4uL2Jhc2UvUmFkaW9TZWxlY3RvclwiXG5pbXBvcnQgeyBCdXR0b25UeXBlIH0gZnJvbSBcIi4uL2Jhc2UvQnV0dG9uLmpzXCJcbmltcG9ydCB7IENyZWRlbnRpYWxBdXRoZW50aWNhdGlvbkVycm9yIH0gZnJvbSBcIi4uLy4uL2FwaS9jb21tb24vZXJyb3IvQ3JlZGVudGlhbEF1dGhlbnRpY2F0aW9uRXJyb3JcIlxuaW1wb3J0IHsgS2V5UGVybWFuZW50bHlJbnZhbGlkYXRlZEVycm9yIH0gZnJvbSBcIi4uLy4uL2FwaS9jb21tb24vZXJyb3IvS2V5UGVybWFuZW50bHlJbnZhbGlkYXRlZEVycm9yXCJcbmltcG9ydCB7IGxpdmVEYXRhQXR0cnMgfSBmcm9tIFwiLi4vQXJpYVV0aWxzXCJcbmltcG9ydCB0eXBlIHsgRGVmZXJyZWRPYmplY3QgfSBmcm9tIFwiQHR1dGFvL3R1dGFub3RhLXV0aWxzXCJcbmltcG9ydCB7IGRlZmVyIH0gZnJvbSBcIkB0dXRhby90dXRhbm90YS11dGlsc1wiXG5pbXBvcnQgeyB3aW5kb3dGYWNhZGUgfSBmcm9tIFwiLi4vLi4vbWlzYy9XaW5kb3dGYWNhZGVcIlxuaW1wb3J0IHsgQ2FuY2VsbGVkRXJyb3IgfSBmcm9tIFwiLi4vLi4vYXBpL2NvbW1vbi9lcnJvci9DYW5jZWxsZWRFcnJvci5qc1wiXG5pbXBvcnQgeyBLZXlzIH0gZnJvbSBcIi4uLy4uL2FwaS9jb21tb24vVHV0YW5vdGFDb25zdGFudHMuanNcIlxuaW1wb3J0IHsgQmFzZUJ1dHRvbiB9IGZyb20gXCIuLi9iYXNlL2J1dHRvbnMvQmFzZUJ1dHRvbi5qc1wiXG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX0NSRURFTlRJQUxfRU5DUllQVElPTl9NT0RFID0gQ3JlZGVudGlhbEVuY3J5cHRpb25Nb2RlLkRFVklDRV9MT0NLXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBzaG93Q3JlZGVudGlhbHNFbmNyeXB0aW9uTW9kZURpYWxvZyhjcmVkZW50aWFsc1Byb3ZpZGVyOiBDcmVkZW50aWFsc1Byb3ZpZGVyKTogUHJvbWlzZTx2b2lkPiB7XG5cdGF3YWl0IENyZWRlbnRpYWxFbmNyeXB0aW9uTWV0aG9kRGlhbG9nLnNob3dBbmRXYWl0Rm9yU2VsZWN0aW9uKGNyZWRlbnRpYWxzUHJvdmlkZXIpXG59XG5cbmNsYXNzIENyZWRlbnRpYWxFbmNyeXB0aW9uTWV0aG9kRGlhbG9nIHtcblx0cHJpdmF0ZSBlcnJvcjogc3RyaW5nIHwgbnVsbFxuXHRwcml2YXRlIHJlYWRvbmx5IGZpbmlzaGVkOiBEZWZlcnJlZE9iamVjdDx2b2lkPlxuXHRwcml2YXRlIHJlYWRvbmx5IGRpYWxvZzogRGlhbG9nXG5cblx0cHJpdmF0ZSBjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIHJlYWRvbmx5IGNyZWRlbnRpYWxzUHJvdmlkZXI6IENyZWRlbnRpYWxzUHJvdmlkZXIsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBzdXBwb3J0ZWRNb2RlczogUmVhZG9ubHlBcnJheTxDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGU+LFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgcHJldmlvdXNTZWxlY3Rpb246IENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZSB8IG51bGwsXG5cdCkge1xuXHRcdHRoaXMuZXJyb3IgPSBudWxsXG5cdFx0dGhpcy5maW5pc2hlZCA9IGRlZmVyKClcblx0XHR0aGlzLmRpYWxvZyA9IG5ldyBEaWFsb2coRGlhbG9nVHlwZS5FZGl0TWVkaXVtLCB7XG5cdFx0XHR2aWV3OiAoKSA9PiB7XG5cdFx0XHRcdC8vIFdlIG5lZWQgY3VzdG9tIGRpYWxvZyBiZWNhdXNlOlxuXHRcdFx0XHQvLyAtIFdlIGRvbid0IG5lZWQgbGFyZ2UgZGlhbG9nXG5cdFx0XHRcdC8vIC0gV2Ugd2FudCBvdXIgc2VsZWN0b3IgYnV0dG9uIGluIHRoZSBib2R5IGFuZCBub3QgaW4gdGhlIGhlYWRlciBhbmQgaXQgbXVzdCBzdGljayB0byB0aGUgYm90dG9tIG9mIHRoZSBkaWFsb2dcblx0XHRcdFx0Ly8gICAobGFyZ2UgZGlhbG9nIHNjcm9sbHMgaXRzIGNvbnRlbnRzIGFuZCB0aGF0J3MgKm5vdCogd2hhdCB3ZSB3YW50IGZvciB0aGF0IGJ1dHRvbikuXG5cdFx0XHRcdHJldHVybiBtKFwiXCIsIFtcblx0XHRcdFx0XHQvLyBPbmx5IGFsbG93IHNraXBwaW5nIGlmIGl0J3MgZmlyc3QgdGltZSB1c2VyIHNlbGVjdHMgbW9kZSAobm90IGZyb20gc2V0dGluZ3MpXG5cdFx0XHRcdFx0cHJldmlvdXNTZWxlY3Rpb24gPT0gbnVsbFxuXHRcdFx0XHRcdFx0PyBtKERpYWxvZ0hlYWRlckJhciwge1xuXHRcdFx0XHRcdFx0XHRcdGxlZnQ6ICgpID0+IFtcblx0XHRcdFx0XHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0bGFiZWw6IFwic2tpcF9hY3Rpb25cIixcblx0XHRcdFx0XHRcdFx0XHRcdFx0Y2xpY2s6ICgpID0+IHRoaXMub25Nb2RlU2VsZWN0ZWQoREVGQVVMVF9DUkVERU5USUFMX0VOQ1JZUFRJT05fTU9ERSksXG5cdFx0XHRcdFx0XHRcdFx0XHRcdHR5cGU6IEJ1dHRvblR5cGUuU2Vjb25kYXJ5LFxuXHRcdFx0XHRcdFx0XHRcdFx0fSBhcyBjb25zdCxcblx0XHRcdFx0XHRcdFx0XHRdLFxuXHRcdFx0XHRcdFx0ICB9KVxuXHRcdFx0XHRcdFx0OiBudWxsLFxuXHRcdFx0XHRcdG0oU2VsZWN0Q3JlZGVudGlhbHNFbmNyeXB0aW9uTW9kZVZpZXcsIHtcblx0XHRcdFx0XHRcdGNsYXNzOiBcInNjcm9sbCBwdCBwbHItbCBoZWlnaHQtMTAwcFwiLFxuXHRcdFx0XHRcdFx0ZXJyb3I6IHRoaXMuZXJyb3IsXG5cdFx0XHRcdFx0XHRvbkNvbmZpcm06IChtb2RlKSA9PiB0aGlzLm9uTW9kZVNlbGVjdGVkKG1vZGUpLFxuXHRcdFx0XHRcdFx0c3VwcG9ydGVkTW9kZXM6IHRoaXMuc3VwcG9ydGVkTW9kZXMsXG5cdFx0XHRcdFx0XHRwcmV2aW91c1NlbGVjdGlvbjogdGhpcy5wcmV2aW91c1NlbGVjdGlvbiA/PyBERUZBVUxUX0NSRURFTlRJQUxfRU5DUllQVElPTl9NT0RFLFxuXHRcdFx0XHRcdH0pLFxuXHRcdFx0XHRdKVxuXHRcdFx0fSxcblx0XHR9KS5hZGRTaG9ydGN1dCh7XG5cdFx0XHRoZWxwOiBcImNsb3NlX2FsdFwiLFxuXHRcdFx0a2V5OiBLZXlzLkVTQyxcblx0XHRcdGV4ZWM6ICgpID0+IHRoaXMuZGlhbG9nLmNsb3NlKCksXG5cdFx0fSlcblx0XHR0aGlzLmRpYWxvZy5zZXRDbG9zZUhhbmRsZXIoKCkgPT4ge1xuXHRcdFx0dGhpcy5maW5pc2hlZC5yZXNvbHZlKClcblx0XHRcdHRoaXMuZGlhbG9nLmNsb3NlKClcblx0XHR9KVxuXHR9XG5cblx0c3RhdGljIGFzeW5jIHNob3dBbmRXYWl0Rm9yU2VsZWN0aW9uKGNyZWRlbnRpYWxzUHJvdmlkZXI6IENyZWRlbnRpYWxzUHJvdmlkZXIpIHtcblx0XHRjb25zdCBzdXBwb3J0ZWRNb2RlcyA9IGF3YWl0IGNyZWRlbnRpYWxzUHJvdmlkZXIuZ2V0U3VwcG9ydGVkRW5jcnlwdGlvbk1vZGVzKClcblx0XHRjb25zdCBwcmV2aW91c1NlbGVjdGlvbiA9IGF3YWl0IGNyZWRlbnRpYWxzUHJvdmlkZXIuZ2V0Q3JlZGVudGlhbEVuY3J5cHRpb25Nb2RlKClcblx0XHRjb25zdCBjcmVkZW50aWFsc0RpYWxvZyA9IG5ldyBDcmVkZW50aWFsRW5jcnlwdGlvbk1ldGhvZERpYWxvZyhjcmVkZW50aWFsc1Byb3ZpZGVyLCBzdXBwb3J0ZWRNb2RlcywgcHJldmlvdXNTZWxlY3Rpb24pXG5cblx0XHRjcmVkZW50aWFsc0RpYWxvZy5kaWFsb2cuc2hvdygpXG5cblx0XHRhd2FpdCBjcmVkZW50aWFsc0RpYWxvZy5maW5pc2hlZC5wcm9taXNlXG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIG9uTW9kZVNlbGVjdGVkKG1vZGU6IENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZSkge1xuXHRcdHRyeSB7XG5cdFx0XHRhd2FpdCB0aGlzLmNyZWRlbnRpYWxzUHJvdmlkZXIuc2V0Q3JlZGVudGlhbEVuY3J5cHRpb25Nb2RlKG1vZGUpXG5cblx0XHRcdHRoaXMuZGlhbG9nLmNsb3NlKClcblxuXHRcdFx0dGhpcy5maW5pc2hlZC5yZXNvbHZlKClcblx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRpZiAoZSBpbnN0YW5jZW9mIENyZWRlbnRpYWxBdXRoZW50aWNhdGlvbkVycm9yKSB7XG5cdFx0XHRcdHRoaXMuZXJyb3IgPSBlLm1lc3NhZ2Vcblx0XHRcdFx0bS5yZWRyYXcoKVxuXHRcdFx0fSBlbHNlIGlmIChlIGluc3RhbmNlb2YgS2V5UGVybWFuZW50bHlJbnZhbGlkYXRlZEVycm9yKSB7XG5cdFx0XHRcdGF3YWl0IHRoaXMuY3JlZGVudGlhbHNQcm92aWRlci5jbGVhckNyZWRlbnRpYWxzKGUpXG5cblx0XHRcdFx0dGhpcy5kaWFsb2cuY2xvc2UoKVxuXG5cdFx0XHRcdGF3YWl0IERpYWxvZy5tZXNzYWdlKFwiY3JlZGVudGlhbHNLZXlJbnZhbGlkYXRlZF9tc2dcIilcblx0XHRcdFx0d2luZG93RmFjYWRlLnJlbG9hZCh7fSlcblx0XHRcdH0gZWxzZSBpZiAoZSBpbnN0YW5jZW9mIENhbmNlbGxlZEVycm9yKSB7XG5cdFx0XHRcdC8vIGlmIHRoZSB1c2VyIGNhbmNlbHMsIGlzIHVucmVjb2duaXplZCBieSBGYWNlIElELCBlbnRlcnMgYW4gaW5jb3JyZWN0IGRldmljZSBwYXNzd29yZCwgZXRjLiwgd2Ugc2hvdWxkIG5vdCBjbG9zZSB0aGUgZGlhbG9nXG5cdFx0XHRcdC8vIGFuZCBpbnN0ZWFkIGxldCB0aGVtIHRyeSBhZ2FpbiBvciBjaG9vc2UgYSBkaWZmZXJlbnQgZW5jcnlwdGlvbiBtb2RlXG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0aHJvdyBlXG5cdFx0XHR9XG5cdFx0fVxuXHR9XG59XG5cbnR5cGUgU2VsZWN0Q3JlZGVudGlhbEVuY3J5cHRpb25Nb2RlRGlhbG9nQXR0cnMgPSB7XG5cdGNsYXNzPzogc3RyaW5nXG5cdHByZXZpb3VzU2VsZWN0aW9uOiBDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGVcblx0b25Db25maXJtOiAoKGVuY3J5cHRpb25Nb2RlOiBDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGUpID0+IHVua25vd24pIHwgbnVsbFxuXHRzdXBwb3J0ZWRNb2RlczogUmVhZG9ubHlBcnJheTxDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGU+XG5cdGVycm9yOiBzdHJpbmcgfCBudWxsXG5cdG9uTW9kZVNlbGVjdGVkPzogKG1vZGU6IENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZSkgPT4gdW5rbm93blxufVxuXG5leHBvcnQgY2xhc3MgU2VsZWN0Q3JlZGVudGlhbHNFbmNyeXB0aW9uTW9kZVZpZXcgaW1wbGVtZW50cyBDb21wb25lbnQ8U2VsZWN0Q3JlZGVudGlhbEVuY3J5cHRpb25Nb2RlRGlhbG9nQXR0cnM+IHtcblx0cHJpdmF0ZSBjdXJyZW50TW9kZTogQ3JlZGVudGlhbEVuY3J5cHRpb25Nb2RlXG5cblx0Y29uc3RydWN0b3IoeyBhdHRycyB9OiBWbm9kZTxTZWxlY3RDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGVEaWFsb2dBdHRycz4pIHtcblx0XHR0aGlzLmN1cnJlbnRNb2RlID0gYXR0cnMucHJldmlvdXNTZWxlY3Rpb25cblx0fVxuXG5cdHZpZXcoeyBhdHRycyB9OiBWbm9kZTxTZWxlY3RDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGVEaWFsb2dBdHRycz4pOiBDaGlsZHJlbiB7XG5cdFx0Y29uc3Qgb3B0aW9ucyA9IHRoaXMuZ2V0U3VwcG9ydGVkT3B0aW9ucyhhdHRycylcblxuXHRcdGNvbnN0IHsgb25Db25maXJtIH0gPSBhdHRyc1xuXHRcdHJldHVybiBbXG5cdFx0XHRtKFxuXHRcdFx0XHRcIi5mbGV4LmNvbFwiLFxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Y2xhc3M6IGF0dHJzLmNsYXNzLFxuXHRcdFx0XHR9LFxuXHRcdFx0XHRbXG5cdFx0XHRcdFx0YXR0cnMuZXJyb3IgPyBtKFwiLnNtYWxsLmNlbnRlci5zdGF0dXNUZXh0Q29sb3IucGItc1wiLCBsaXZlRGF0YUF0dHJzKCksIGF0dHJzLmVycm9yKSA6IG51bGwsXG5cdFx0XHRcdFx0bShcIlwiLCBsYW5nLmdldChcImNyZWRlbnRpYWxzRW5jcnlwdGlvbk1vZGVTZWxlY3Rpb25fbXNnXCIpKSxcblx0XHRcdFx0XHRtKFxuXHRcdFx0XHRcdFx0XCIubXRcIixcblx0XHRcdFx0XHRcdG0oUmFkaW9TZWxlY3Rvciwge1xuXHRcdFx0XHRcdFx0XHRuYW1lOiBcImNyZWRlbnRpYWxzRW5jcnlwdGlvbk1vZGVfbGFiZWxcIixcblx0XHRcdFx0XHRcdFx0b3B0aW9ucyxcblx0XHRcdFx0XHRcdFx0c2VsZWN0ZWRPcHRpb246IHRoaXMuY3VycmVudE1vZGUsXG5cdFx0XHRcdFx0XHRcdG9uT3B0aW9uU2VsZWN0ZWQ6IChtb2RlOiBDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGUpID0+IHtcblx0XHRcdFx0XHRcdFx0XHR0aGlzLmN1cnJlbnRNb2RlID0gbW9kZVxuXHRcdFx0XHRcdFx0XHRcdGF0dHJzLm9uTW9kZVNlbGVjdGVkPy4obW9kZSlcblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdH0gc2F0aXNmaWVzIFJhZGlvU2VsZWN0b3JBdHRyczxDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGU+KSxcblx0XHRcdFx0XHQpLFxuXHRcdFx0XHRdLFxuXHRcdFx0KSxcblx0XHRcdG9uQ29uZmlybSA/IHRoaXMucmVuZGVyU2VsZWN0QnV0dG9uKCgpID0+IG9uQ29uZmlybSh0aGlzLmN1cnJlbnRNb2RlKSkgOiBudWxsLFxuXHRcdF1cblx0fVxuXG5cdHByaXZhdGUgZ2V0U3VwcG9ydGVkT3B0aW9ucyhhdHRyczogU2VsZWN0Q3JlZGVudGlhbEVuY3J5cHRpb25Nb2RlRGlhbG9nQXR0cnMpOiBBcnJheTxSYWRpb1NlbGVjdG9yT3B0aW9uPENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZT4+IHtcblx0XHRjb25zdCBnZW5lcmF0ZU9wdGlvbiA9IChuYW1lOiBUcmFuc2xhdGlvbktleSwgdmFsdWU6IENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZSk6IFJhZGlvU2VsZWN0b3JPcHRpb248Q3JlZGVudGlhbEVuY3J5cHRpb25Nb2RlPiA9PiAoe1xuXHRcdFx0bmFtZSxcblx0XHRcdHZhbHVlLFxuXHRcdH0pXG5cblx0XHRjb25zdCBvcHRpb25zID0gW1xuXHRcdFx0Z2VuZXJhdGVPcHRpb24oXCJjcmVkZW50aWFsc0VuY3J5cHRpb25Nb2RlRGV2aWNlTG9ja19sYWJlbFwiLCBDcmVkZW50aWFsRW5jcnlwdGlvbk1vZGUuREVWSUNFX0xPQ0spLFxuXHRcdFx0Z2VuZXJhdGVPcHRpb24oXCJjcmVkZW50aWFsc0VuY3J5cHRpb25Nb2RlRGV2aWNlQ3JlZGVudGlhbHNfbGFiZWxcIiwgQ3JlZGVudGlhbEVuY3J5cHRpb25Nb2RlLlNZU1RFTV9QQVNTV09SRCksXG5cdFx0XHRnZW5lcmF0ZU9wdGlvbihcImNyZWRlbnRpYWxzRW5jcnlwdGlvbk1vZGVCaW9tZXRyaWNzX2xhYmVsXCIsIENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZS5CSU9NRVRSSUNTKSxcblx0XHRcdGdlbmVyYXRlT3B0aW9uKFwiY3JlZGVudGlhbHNFbmNyeXB0aW9uTW9kZUFwcFBhc3N3b3JkX2xhYmVsXCIsIENyZWRlbnRpYWxFbmNyeXB0aW9uTW9kZS5BUFBfUEFTU1dPUkQpLFxuXHRcdF0gYXMgY29uc3Rcblx0XHRyZXR1cm4gb3B0aW9ucy5maWx0ZXIoKG9wdGlvbikgPT4gYXR0cnMuc3VwcG9ydGVkTW9kZXMuaW5jbHVkZXMob3B0aW9uLnZhbHVlKSlcblx0fVxuXG5cdHByaXZhdGUgcmVuZGVyU2VsZWN0QnV0dG9uKG9uY2xpY2s6ICgpID0+IHVua25vd24pIHtcblx0XHRyZXR1cm4gbShCYXNlQnV0dG9uLCB7XG5cdFx0XHRsYWJlbDogXCJva19hY3Rpb25cIixcblx0XHRcdHRleHQ6IGxhbmcuZ2V0KFwib2tfYWN0aW9uXCIpLFxuXHRcdFx0Y2xhc3M6IFwidXBwZXJjYXNlIGFjY2VudC1iZyBmdWxsLXdpZHRoIGNlbnRlciBiIGNvbnRlbnQtZmcgZmxhc2hcIixcblx0XHRcdHN0eWxlOiB7XG5cdFx0XHRcdGhlaWdodDogXCI2MHB4XCIsXG5cdFx0XHR9LFxuXHRcdFx0b25jbGljayxcblx0XHR9KVxuXHR9XG59XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztNQW1CYSxxQ0FBcUMseUJBQXlCO0FBRXBFLGVBQWUsb0NBQW9DQSxxQkFBeUQ7QUFDbEgsT0FBTSxpQ0FBaUMsd0JBQXdCLG9CQUFvQjtBQUNuRjtJQUVLLG1DQUFOLE1BQU0saUNBQWlDO0NBQ3RDLEFBQVE7Q0FDUixBQUFpQjtDQUNqQixBQUFpQjtDQUVqQixBQUFRLFlBQ1VBLHFCQUNBQyxnQkFDQUMsbUJBQ2hCO0VBMEpGLEtBN0prQjtFQTZKakIsS0E1SmlCO0VBNEpoQixLQTNKZ0I7QUFFakIsT0FBSyxRQUFRO0FBQ2IsT0FBSyxXQUFXLE9BQU87QUFDdkIsT0FBSyxTQUFTLElBQUksT0FBTyxXQUFXLFlBQVksRUFDL0MsTUFBTSxNQUFNO0FBS1gsVUFBTyxnQkFBRSxJQUFJLENBRVoscUJBQXFCLE9BQ2xCLGdCQUFFLGlCQUFpQixFQUNuQixNQUFNLE1BQU0sQ0FDWDtJQUNDLE9BQU87SUFDUCxPQUFPLE1BQU0sS0FBSyxlQUFlLG1DQUFtQztJQUNwRSxNQUFNLFdBQVc7R0FDakIsQ0FDRCxFQUNBLEVBQUMsR0FDRixNQUNILGdCQUFFLHFDQUFxQztJQUN0QyxPQUFPO0lBQ1AsT0FBTyxLQUFLO0lBQ1osV0FBVyxDQUFDLFNBQVMsS0FBSyxlQUFlLEtBQUs7SUFDOUMsZ0JBQWdCLEtBQUs7SUFDckIsbUJBQW1CLEtBQUsscUJBQXFCO0dBQzdDLEVBQUMsQUFDRixFQUFDO0VBQ0YsRUFDRCxHQUFFLFlBQVk7R0FDZCxNQUFNO0dBQ04sS0FBSyxLQUFLO0dBQ1Ys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