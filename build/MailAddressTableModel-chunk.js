import { assertNotNull, lazyMemoized } from "./dist2-chunk.js";
import { OperationType } from "./TutanotaConstants-chunk.js";
import { MailboxPropertiesTypeRef } from "./TypeRefs-chunk.js";
import { GroupInfoTypeRef } from "./TypeRefs2-chunk.js";
import { LimitReachedError } from "./RestError-chunk.js";
import { isUpdateFor, isUpdateForTypeRef } from "./EntityUpdateUtils-chunk.js";
import { UserError } from "./UserError-chunk.js";
import { isTutaMailAddress } from "./SharedMailUtils-chunk.js";
import { UpgradeRequiredError } from "./UpgradeRequiredError-chunk.js";
import { getAvailableMatchingPlans } from "./SubscriptionUtils-chunk.js";
import { getAvailableDomains } from "./MailAddressesUtils-chunk.js";

//#region src/common/settings/mailaddress/MailAddressTableModel.ts
let AddressStatus = function(AddressStatus$1) {
	AddressStatus$1[AddressStatus$1["Primary"] = 0] = "Primary";
	AddressStatus$1[AddressStatus$1["Alias"] = 1] = "Alias";
	AddressStatus$1[AddressStatus$1["DisabledAlias"] = 2] = "DisabledAlias";
	AddressStatus$1[AddressStatus$1["Custom"] = 3] = "Custom";
	return AddressStatus$1;
}({});
var MailAddressTableModel = class {
	nameMappings = null;
	onLegacyPlan = false;
	aliasCount = null;
	init = lazyMemoized(async () => {
		this.eventController.addEntityListener(this.entityEventsReceived);
		const userController = this.logins.getUserController();
		this.onLegacyPlan = userController.isLegacyPlan(await userController.getPlanType());
		await this.loadNames();
		this.redraw();
		await this.loadAliasCount();
		this.redraw();
	});
	constructor(entityClient, serviceExecutor, mailAddressFacade, logins, eventController, userGroupInfo, nameChanger, redraw) {
		this.entityClient = entityClient;
		this.serviceExecutor = serviceExecutor;
		this.mailAddressFacade = mailAddressFacade;
		this.logins = logins;
		this.eventController = eventController;
		this.userGroupInfo = userGroupInfo;
		this.nameChanger = nameChanger;
		this.redraw = redraw;
	}
	dispose() {
		this.eventController.removeEntityListener(this.entityEventsReceived);
	}
	userCanModifyAliases() {
		return this.logins.getUserController().isGlobalAdmin();
	}
	aliasLimitIncludesCustomDomains() {
		return this.onLegacyPlan;
	}
	addresses() {
		const { nameMappings } = this;
		if (nameMappings == null) return [];
		const primaryAddress = assertNotNull(this.userGroupInfo.mailAddress);
		const primaryAddressInfo = {
			name: nameMappings.get(primaryAddress) ?? "",
			address: primaryAddress,
			status: AddressStatus.Primary
		};
		const aliasesInfo = this.userGroupInfo.mailAddressAliases.slice().sort((a, b) => a.mailAddress > b.mailAddress ? 1 : -1).map(({ mailAddress, enabled }) => {
			const status = isTutaMailAddress(mailAddress) ? enabled ? AddressStatus.Alias : AddressStatus.DisabledAlias : AddressStatus.Custom;
			return {
				name: nameMappings.get(mailAddress) ?? "",
				address: mailAddress,
				status
			};
		});
		return [primaryAddressInfo, ...aliasesInfo];
	}
	async setAliasName(address, senderName) {
		this.nameMappings = await this.nameChanger.setSenderName(address, senderName);
		this.redraw();
	}
	/**
	* Add an alias.
	* @throws if an error occurred, such as a LimitReachedError if too many aliases were added
	*/
	async addAlias(alias, senderName) {
		try {
			await this.mailAddressFacade.addMailAlias(this.userGroupInfo.group, alias);
			await this.setAliasName(alias, senderName);
		} catch (e) {
			if (e instanceof LimitReachedError) await this.handleTooManyAliases();
			throw e;
		}
	}
	getAvailableDomains() {
		return getAvailableDomains(this.logins);
	}
	async setAliasStatus(address, restore) {
		await this.mailAddressFacade.setMailAliasStatus(this.userGroupInfo.group, address, restore);
		this.redraw();
		this.nameMappings = await this.nameChanger.removeSenderName(address);
		this.redraw();
	}
	defaultSenderName() {
		return this.userGroupInfo.name;
	}
	entityEventsReceived = async (updates) => {
		for (const update of updates) if (isUpdateForTypeRef(MailboxPropertiesTypeRef, update) && update.operation === OperationType.UPDATE) await this.loadNames();
else if (isUpdateFor(this.userGroupInfo, update) && update.operation === OperationType.UPDATE) {
			this.userGroupInfo = await this.entityClient.load(GroupInfoTypeRef, this.userGroupInfo._id);
			await this.loadAliasCount();
		}
		this.redraw();
	};
	async loadNames() {
		this.nameMappings = await this.nameChanger.getSenderNames();
	}
	async loadAliasCount() {
		this.aliasCount = await this.mailAddressFacade.getAliasCounters(this.userGroupInfo.group);
	}
	/**
	* Chooses the correct error to throw.
	* @throws UpgradeRequiredError if the customer can upgrade to a plan with more aliases
	* @throws UserError if the customer cannot add more aliases
	*/
	async handleTooManyAliases() {
		const plansWithMoreAliases = await getAvailableMatchingPlans(this.serviceExecutor, (config) => Number(config.nbrOfAliases) > this.userGroupInfo.mailAddressAliases.length);
		if (plansWithMoreAliases.length > 0) throw new UpgradeRequiredError("moreAliasesRequired_msg", plansWithMoreAliases);
else throw new UserError("adminMaxNbrOfAliasesReached_msg");
	}
};

//#endregion
export { AddressStatus, MailAddressTableModel };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWFpbEFkZHJlc3NUYWJsZU1vZGVsLWNodW5rLmpzIiwibmFtZXMiOlsiZW50aXR5Q2xpZW50OiBFbnRpdHlDbGllbnQiLCJzZXJ2aWNlRXhlY3V0b3I6IElTZXJ2aWNlRXhlY3V0b3IiLCJtYWlsQWRkcmVzc0ZhY2FkZTogTWFpbEFkZHJlc3NGYWNhZGUiLCJsb2dpbnM6IExvZ2luQ29udHJvbGxlciIsImV2ZW50Q29udHJvbGxlcjogRXZlbnRDb250cm9sbGVyIiwidXNlckdyb3VwSW5mbzogR3JvdXBJbmZvIiwibmFtZUNoYW5nZXI6IE1haWxBZGRyZXNzTmFtZUNoYW5nZXIiLCJyZWRyYXc6ICgpID0+IHVua25vd24iLCJhZGRyZXNzOiBzdHJpbmciLCJzZW5kZXJOYW1lOiBzdHJpbmciLCJhbGlhczogc3RyaW5nIiwicmVzdG9yZTogYm9vbGVhbiIsInVwZGF0ZXM6IFJlYWRvbmx5QXJyYXk8RW50aXR5VXBkYXRlRGF0YT4iXSwic291cmNlcyI6WyIuLi9zcmMvY29tbW9uL3NldHRpbmdzL21haWxhZGRyZXNzL01haWxBZGRyZXNzVGFibGVNb2RlbC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbnRpdHlDbGllbnQgfSBmcm9tIFwiLi4vLi4vYXBpL2NvbW1vbi9FbnRpdHlDbGllbnQuanNcIlxuaW1wb3J0IHsgTWFpbGJveFByb3BlcnRpZXNUeXBlUmVmIH0gZnJvbSBcIi4uLy4uL2FwaS9lbnRpdGllcy90dXRhbm90YS9UeXBlUmVmcy5qc1wiXG5pbXBvcnQgeyBNYWlsQWRkcmVzc0ZhY2FkZSB9IGZyb20gXCIuLi8uLi9hcGkvd29ya2VyL2ZhY2FkZXMvbGF6eS9NYWlsQWRkcmVzc0ZhY2FkZS5qc1wiXG5pbXBvcnQgeyBMb2dpbkNvbnRyb2xsZXIgfSBmcm9tIFwiLi4vLi4vYXBpL21haW4vTG9naW5Db250cm9sbGVyLmpzXCJcbmltcG9ydCB7IEV2ZW50Q29udHJvbGxlciB9IGZyb20gXCIuLi8uLi9hcGkvbWFpbi9FdmVudENvbnRyb2xsZXIuanNcIlxuaW1wb3J0IHsgT3BlcmF0aW9uVHlwZSB9IGZyb20gXCIuLi8uLi9hcGkvY29tbW9uL1R1dGFub3RhQ29uc3RhbnRzLmpzXCJcbmltcG9ydCB7IEVtYWlsRG9tYWluRGF0YSwgZ2V0QXZhaWxhYmxlRG9tYWlucyB9IGZyb20gXCIuL01haWxBZGRyZXNzZXNVdGlscy5qc1wiXG5pbXBvcnQgeyBHcm91cEluZm8sIEdyb3VwSW5mb1R5cGVSZWYsIE1haWxBZGRyZXNzQWxpYXNTZXJ2aWNlUmV0dXJuIH0gZnJvbSBcIi4uLy4uL2FwaS9lbnRpdGllcy9zeXMvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHsgYXNzZXJ0Tm90TnVsbCwgbGF6eU1lbW9pemVkIH0gZnJvbSBcIkB0dXRhby90dXRhbm90YS11dGlsc1wiXG5pbXBvcnQgeyBMaW1pdFJlYWNoZWRFcnJvciB9IGZyb20gXCIuLi8uLi9hcGkvY29tbW9uL2Vycm9yL1Jlc3RFcnJvci5qc1wiXG5pbXBvcnQgeyBVc2VyRXJyb3IgfSBmcm9tIFwiLi4vLi4vYXBpL21haW4vVXNlckVycm9yLmpzXCJcbmltcG9ydCB7IFVwZ3JhZGVSZXF1aXJlZEVycm9yIH0gZnJvbSBcIi4uLy4uL2FwaS9tYWluL1VwZ3JhZGVSZXF1aXJlZEVycm9yLmpzXCJcbmltcG9ydCB7IElTZXJ2aWNlRXhlY3V0b3IgfSBmcm9tIFwiLi4vLi4vYXBpL2NvbW1vbi9TZXJ2aWNlUmVxdWVzdC5qc1wiXG5pbXBvcnQgeyBnZXRBdmFpbGFibGVNYXRjaGluZ1BsYW5zIH0gZnJvbSBcIi4uLy4uL3N1YnNjcmlwdGlvbi9TdWJzY3JpcHRpb25VdGlscy5qc1wiXG5pbXBvcnQgeyBFbnRpdHlVcGRhdGVEYXRhLCBpc1VwZGF0ZUZvciwgaXNVcGRhdGVGb3JUeXBlUmVmIH0gZnJvbSBcIi4uLy4uL2FwaS9jb21tb24vdXRpbHMvRW50aXR5VXBkYXRlVXRpbHMuanNcIlxuaW1wb3J0IHsgaXNUdXRhTWFpbEFkZHJlc3MgfSBmcm9tIFwiLi4vLi4vbWFpbEZ1bmN0aW9uYWxpdHkvU2hhcmVkTWFpbFV0aWxzLmpzXCJcblxuZXhwb3J0IGVudW0gQWRkcmVzc1N0YXR1cyB7XG5cdFByaW1hcnksXG5cdEFsaWFzLFxuXHREaXNhYmxlZEFsaWFzLFxuXHRDdXN0b20sXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWRkcmVzc0luZm8ge1xuXHRuYW1lOiBzdHJpbmdcblx0YWRkcmVzczogc3RyaW5nXG5cdHN0YXR1czogQWRkcmVzc1N0YXR1c1xufVxuXG5leHBvcnQgdHlwZSBBZGRyZXNzVG9OYW1lID0gTWFwPHN0cmluZywgc3RyaW5nPlxuXG4vKiogQSBzdHJhdGVneSB0byBjaGFuZ2UgbWFpbCBhZGRyZXNzIHRvIHNlbmRlciBuYW1lIG1hcHBpbmcuICovXG5leHBvcnQgaW50ZXJmYWNlIE1haWxBZGRyZXNzTmFtZUNoYW5nZXIge1xuXHRnZXRTZW5kZXJOYW1lcygpOiBQcm9taXNlPEFkZHJlc3NUb05hbWU+XG5cblx0c2V0U2VuZGVyTmFtZShhZGRyZXNzOiBzdHJpbmcsIG5hbWU6IHN0cmluZyk6IFByb21pc2U8QWRkcmVzc1RvTmFtZT5cblxuXHRyZW1vdmVTZW5kZXJOYW1lKGFkZHJlc3M6IHN0cmluZyk6IFByb21pc2U8QWRkcmVzc1RvTmFtZT5cbn1cblxuLyoqIE1vZGVsIGZvciBzaG93aW5nIHRoZSBsaXN0IG9mIG1haWwgYWRkcmVzc2VzIGFuZCBvcHRpb25hbGx5IGFkZGluZyBtb3JlLCBlbmFibGluZy9kaXNhYmxpbmcvc2V0dGluZyBuYW1lcyBmb3IgdGhlbS4gKi9cbmV4cG9ydCBjbGFzcyBNYWlsQWRkcmVzc1RhYmxlTW9kZWwge1xuXHRwcml2YXRlIG5hbWVNYXBwaW5nczogQWRkcmVzc1RvTmFtZSB8IG51bGwgPSBudWxsXG5cdHByaXZhdGUgb25MZWdhY3lQbGFuOiBib29sZWFuID0gZmFsc2Vcblx0YWxpYXNDb3VudDogTWFpbEFkZHJlc3NBbGlhc1NlcnZpY2VSZXR1cm4gfCBudWxsID0gbnVsbFxuXG5cdGluaXQ6ICgpID0+IFByb21pc2U8dm9pZD4gPSBsYXp5TWVtb2l6ZWQoYXN5bmMgKCkgPT4ge1xuXHRcdHRoaXMuZXZlbnRDb250cm9sbGVyLmFkZEVudGl0eUxpc3RlbmVyKHRoaXMuZW50aXR5RXZlbnRzUmVjZWl2ZWQpXG5cblx0XHQvLyBpbXBvcnRhbnQ6IFwibm90IG9uIGxlZ2FjeSBwbGFuXCIgaXMgdHJ1ZSBmb3IgZnJlZSBwbGFuc1xuXHRcdGNvbnN0IHVzZXJDb250cm9sbGVyID0gdGhpcy5sb2dpbnMuZ2V0VXNlckNvbnRyb2xsZXIoKVxuXHRcdHRoaXMub25MZWdhY3lQbGFuID0gdXNlckNvbnRyb2xsZXIuaXNMZWdhY3lQbGFuKGF3YWl0IHVzZXJDb250cm9sbGVyLmdldFBsYW5UeXBlKCkpXG5cblx0XHRhd2FpdCB0aGlzLmxvYWROYW1lcygpXG5cdFx0dGhpcy5yZWRyYXcoKVxuXHRcdGF3YWl0IHRoaXMubG9hZEFsaWFzQ291bnQoKVxuXHRcdHRoaXMucmVkcmF3KClcblx0fSlcblxuXHRjb25zdHJ1Y3Rvcihcblx0XHRwcml2YXRlIHJlYWRvbmx5IGVudGl0eUNsaWVudDogRW50aXR5Q2xpZW50LFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgc2VydmljZUV4ZWN1dG9yOiBJU2VydmljZUV4ZWN1dG9yLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgbWFpbEFkZHJlc3NGYWNhZGU6IE1haWxBZGRyZXNzRmFjYWRlLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgbG9naW5zOiBMb2dpbkNvbnRyb2xsZXIsXG5cdFx0cHJpdmF0ZSByZWFkb25seSBldmVudENvbnRyb2xsZXI6IEV2ZW50Q29udHJvbGxlcixcblx0XHRwcml2YXRlIHVzZXJHcm91cEluZm86IEdyb3VwSW5mbyxcblx0XHRwcml2YXRlIHJlYWRvbmx5IG5hbWVDaGFuZ2VyOiBNYWlsQWRkcmVzc05hbWVDaGFuZ2VyLFxuXHRcdHByaXZhdGUgcmVhZG9ubHkgcmVkcmF3OiAoKSA9PiB1bmtub3duLFxuXHQpIHt9XG5cblx0ZGlzcG9zZSgpIHtcblx0XHR0aGlzLmV2ZW50Q29udHJvbGxlci5yZW1vdmVFbnRpdHlMaXN0ZW5lcih0aGlzLmVudGl0eUV2ZW50c1JlY2VpdmVkKVxuXHR9XG5cblx0dXNlckNhbk1vZGlmeUFsaWFzZXMoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMubG9naW5zLmdldFVzZXJDb250cm9sbGVyKCkuaXNHbG9iYWxBZG1pbigpXG5cdH1cblxuXHRhbGlhc0xpbWl0SW5jbHVkZXNDdXN0b21Eb21haW5zKCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiB0aGlzLm9uTGVnYWN5UGxhblxuXHR9XG5cblx0YWRkcmVzc2VzKCk6IEFkZHJlc3NJbmZvW10ge1xuXHRcdGNvbnN0IHsgbmFtZU1hcHBpbmdzIH0gPSB0aGlzXG5cdFx0aWYgKG5hbWVNYXBwaW5ncyA9PSBudWxsKSB7XG5cdFx0XHRyZXR1cm4gW11cblx0XHR9XG5cblx0XHRjb25zdCBwcmltYXJ5QWRkcmVzcyA9IGFzc2VydE5vdE51bGwodGhpcy51c2VyR3JvdXBJbmZvLm1haWxBZGRyZXNzKVxuXHRcdGNvbnN0IHByaW1hcnlBZGRyZXNzSW5mbyA9IHtcblx0XHRcdG5hbWU6IG5hbWVNYXBwaW5ncy5nZXQocHJpbWFyeUFkZHJlc3MpID8/IFwiXCIsXG5cdFx0XHRhZGRyZXNzOiBwcmltYXJ5QWRkcmVzcyxcblx0XHRcdHN0YXR1czogQWRkcmVzc1N0YXR1cy5QcmltYXJ5LFxuXHRcdH1cblxuXHRcdGNvbnN0IGFsaWFzZXNJbmZvID0gdGhpcy51c2VyR3JvdXBJbmZvLm1haWxBZGRyZXNzQWxpYXNlc1xuXHRcdFx0LnNsaWNlKClcblx0XHRcdC5zb3J0KChhLCBiKSA9PiAoYS5tYWlsQWRkcmVzcyA+IGIubWFpbEFkZHJlc3MgPyAxIDogLTEpKVxuXHRcdFx0Lm1hcCgoeyBtYWlsQWRkcmVzcywgZW5hYmxlZCB9KSA9PiB7XG5cdFx0XHRcdGNvbnN0IHN0YXR1cyA9XG5cdFx0XHRcdFx0Ly8gTyhhbGlhc2VzICogVFVUQV9NQUlMX0FERFJFU1NfRE9NQUlOUylcblx0XHRcdFx0XHRpc1R1dGFNYWlsQWRkcmVzcyhtYWlsQWRkcmVzcykgPyAoZW5hYmxlZCA/IEFkZHJlc3NTdGF0dXMuQWxpYXMgOiBBZGRyZXNzU3RhdHVzLkRpc2FibGVkQWxpYXMpIDogQWRkcmVzc1N0YXR1cy5DdXN0b21cblxuXHRcdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRcdG5hbWU6IG5hbWVNYXBwaW5ncy5nZXQobWFpbEFkZHJlc3MpID8/IFwiXCIsXG5cdFx0XHRcdFx0YWRkcmVzczogbWFpbEFkZHJlc3MsXG5cdFx0XHRcdFx0c3RhdHVzLFxuXHRcdFx0XHR9XG5cdFx0XHR9KVxuXHRcdHJldHVybiBbcHJpbWFyeUFkZHJlc3NJbmZvLCAuLi5hbGlhc2VzSW5mb11cblx0fVxuXG5cdGFzeW5jIHNldEFsaWFzTmFtZShhZGRyZXNzOiBzdHJpbmcsIHNlbmRlck5hbWU6IHN0cmluZykge1xuXHRcdHRoaXMubmFtZU1hcHBpbmdzID0gYXdhaXQgdGhpcy5uYW1lQ2hhbmdlci5zZXRTZW5kZXJOYW1lKGFkZHJlc3MsIHNlbmRlck5hbWUpXG5cdFx0dGhpcy5yZWRyYXcoKVxuXHR9XG5cblx0LyoqXG5cdCAqIEFkZCBhbiBhbGlhcy5cblx0ICogQHRocm93cyBpZiBhbiBlcnJvciBvY2N1cnJlZCwgc3VjaCBhcyBhIExpbWl0UmVhY2hlZEVycm9yIGlmIHRvbyBtYW55IGFsaWFzZXMgd2VyZSBhZGRlZFxuXHQgKi9cblx0YXN5bmMgYWRkQWxpYXMoYWxpYXM6IHN0cmluZywgc2VuZGVyTmFtZTogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGF3YWl0IHRoaXMubWFpbEFkZHJlc3NGYWNhZGUuYWRkTWFpbEFsaWFzKHRoaXMudXNlckdyb3VwSW5mby5ncm91cCwgYWxpYXMpXG5cdFx0XHRhd2FpdCB0aGlzLnNldEFsaWFzTmFtZShhbGlhcywgc2VuZGVyTmFtZSlcblx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRpZiAoZSBpbnN0YW5jZW9mIExpbWl0UmVhY2hlZEVycm9yKSB7XG5cdFx0XHRcdGF3YWl0IHRoaXMuaGFuZGxlVG9vTWFueUFsaWFzZXMoKVxuXHRcdFx0fVxuXHRcdFx0dGhyb3cgZVxuXHRcdH1cblx0fVxuXG5cdGdldEF2YWlsYWJsZURvbWFpbnMoKTogUHJvbWlzZTxFbWFpbERvbWFpbkRhdGFbXT4ge1xuXHRcdHJldHVybiBnZXRBdmFpbGFibGVEb21haW5zKHRoaXMubG9naW5zKVxuXHR9XG5cblx0YXN5bmMgc2V0QWxpYXNTdGF0dXMoYWRkcmVzczogc3RyaW5nLCByZXN0b3JlOiBib29sZWFuKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0YXdhaXQgdGhpcy5tYWlsQWRkcmVzc0ZhY2FkZS5zZXRNYWlsQWxpYXNTdGF0dXModGhpcy51c2VyR3JvdXBJbmZvLmdyb3VwLCBhZGRyZXNzLCByZXN0b3JlKVxuXHRcdHRoaXMucmVkcmF3KClcblx0XHR0aGlzLm5hbWVNYXBwaW5ncyA9IGF3YWl0IHRoaXMubmFtZUNoYW5nZXIucmVtb3ZlU2VuZGVyTmFtZShhZGRyZXNzKVxuXHRcdHRoaXMucmVkcmF3KClcblx0fVxuXG5cdGRlZmF1bHRTZW5kZXJOYW1lKCk6IHN0cmluZyB7XG5cdFx0cmV0dXJuIHRoaXMudXNlckdyb3VwSW5mby5uYW1lXG5cdH1cblxuXHRwcml2YXRlIGVudGl0eUV2ZW50c1JlY2VpdmVkID0gYXN5bmMgKHVwZGF0ZXM6IFJlYWRvbmx5QXJyYXk8RW50aXR5VXBkYXRlRGF0YT4pID0+IHtcblx0XHRmb3IgKGNvbnN0IHVwZGF0ZSBvZiB1cGRhdGVzKSB7XG5cdFx0XHRpZiAoaXNVcGRhdGVGb3JUeXBlUmVmKE1haWxib3hQcm9wZXJ0aWVzVHlwZVJlZiwgdXBkYXRlKSAmJiB1cGRhdGUub3BlcmF0aW9uID09PSBPcGVyYXRpb25UeXBlLlVQREFURSkge1xuXHRcdFx0XHRhd2FpdCB0aGlzLmxvYWROYW1lcygpXG5cdFx0XHR9IGVsc2UgaWYgKGlzVXBkYXRlRm9yKHRoaXMudXNlckdyb3VwSW5mbywgdXBkYXRlKSAmJiB1cGRhdGUub3BlcmF0aW9uID09PSBPcGVyYXRpb25UeXBlLlVQREFURSkge1xuXHRcdFx0XHR0aGlzLnVzZXJHcm91cEluZm8gPSBhd2FpdCB0aGlzLmVudGl0eUNsaWVudC5sb2FkKEdyb3VwSW5mb1R5cGVSZWYsIHRoaXMudXNlckdyb3VwSW5mby5faWQpXG5cdFx0XHRcdGF3YWl0IHRoaXMubG9hZEFsaWFzQ291bnQoKVxuXHRcdFx0fVxuXHRcdH1cblx0XHR0aGlzLnJlZHJhdygpXG5cdH1cblxuXHRwcml2YXRlIGFzeW5jIGxvYWROYW1lcygpIHtcblx0XHR0aGlzLm5hbWVNYXBwaW5ncyA9IGF3YWl0IHRoaXMubmFtZUNoYW5nZXIuZ2V0U2VuZGVyTmFtZXMoKVxuXHR9XG5cblx0cHJpdmF0ZSBhc3luYyBsb2FkQWxpYXNDb3VudCgpIHtcblx0XHR0aGlzLmFsaWFzQ291bnQgPSBhd2FpdCB0aGlzLm1haWxBZGRyZXNzRmFjYWRlLmdldEFsaWFzQ291bnRlcnModGhpcy51c2VyR3JvdXBJbmZvLmdyb3VwKVxuXHR9XG5cblx0LyoqXG5cdCAqIENob29zZXMgdGhlIGNvcnJlY3QgZXJyb3IgdG8gdGhyb3cuXG5cdCAqIEB0aHJvd3MgVXBncmFkZVJlcXVpcmVkRXJyb3IgaWYgdGhlIGN1c3RvbWVyIGNhbiB1cGdyYWRlIHRvIGEgcGxhbiB3aXRoIG1vcmUgYWxpYXNlc1xuXHQgKiBAdGhyb3dzIFVzZXJFcnJvciBpZiB0aGUgY3VzdG9tZXIgY2Fubm90IGFkZCBtb3JlIGFsaWFzZXNcblx0ICovXG5cdHB1YmxpYyBhc3luYyBoYW5kbGVUb29NYW55QWxpYXNlcygpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHQvLyBEZXRlcm1pbmUgaWYgdGhlcmUgaXMgYW4gYXZhaWxhYmxlIHBsYW4gd2UgY2FuIHN3aXRjaCB0byB0aGF0IHdvdWxkIGxldCB0aGUgdXNlciBhZGQgYW4gYWxpYXMuXG5cdFx0Ly8gSWYgc28sIHNob3cgYW4gdXBncmFkZSBkaWFsb2cuIE90aGVyd2lzZSwgaW5mb3JtIHRoZSB1c2VyIHRoYXQgdGhleSByZWFjaGVkIHRoZSBtYXhpbXVtIG51bWJlciBvZiBhbGlhc2VzLlxuXHRcdGNvbnN0IHBsYW5zV2l0aE1vcmVBbGlhc2VzID0gYXdhaXQgZ2V0QXZhaWxhYmxlTWF0Y2hpbmdQbGFucyhcblx0XHRcdHRoaXMuc2VydmljZUV4ZWN1dG9yLFxuXHRcdFx0KGNvbmZpZykgPT4gTnVtYmVyKGNvbmZpZy5uYnJPZkFsaWFzZXMpID4gdGhpcy51c2VyR3JvdXBJbmZvLm1haWxBZGRyZXNzQWxpYXNlcy5sZW5ndGgsXG5cdFx0KVxuXHRcdGlmIChwbGFuc1dpdGhNb3JlQWxpYXNlcy5sZW5ndGggPiAwKSB7XG5cdFx0XHR0aHJvdyBuZXcgVXBncmFkZVJlcXVpcmVkRXJyb3IoXCJtb3JlQWxpYXNlc1JlcXVpcmVkX21zZ1wiLCBwbGFuc1dpdGhNb3JlQWxpYXNlcylcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhyb3cgbmV3IFVzZXJFcnJvcihcImFkbWluTWF4TmJyT2ZBbGlhc2VzUmVhY2hlZF9tc2dcIilcblx0XHR9XG5cdH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztJQWlCWSwwQ0FBTDtBQUNOO0FBQ0E7QUFDQTtBQUNBOztBQUNBO0lBb0JZLHdCQUFOLE1BQTRCO0NBQ2xDLEFBQVEsZUFBcUM7Q0FDN0MsQUFBUSxlQUF3QjtDQUNoQyxhQUFtRDtDQUVuRCxPQUE0QixhQUFhLFlBQVk7QUFDcEQsT0FBSyxnQkFBZ0Isa0JBQWtCLEtBQUsscUJBQXFCO0VBR2pFLE1BQU0saUJBQWlCLEtBQUssT0FBTyxtQkFBbUI7QUFDdEQsT0FBSyxlQUFlLGVBQWUsYUFBYSxNQUFNLGVBQWUsYUFBYSxDQUFDO0FBRW5GLFFBQU0sS0FBSyxXQUFXO0FBQ3RCLE9BQUssUUFBUTtBQUNiLFFBQU0sS0FBSyxnQkFBZ0I7QUFDM0IsT0FBSyxRQUFRO0NBQ2IsRUFBQztDQUVGLFlBQ2tCQSxjQUNBQyxpQkFDQUMsbUJBQ0FDLFFBQ0FDLGlCQUNUQyxlQUNTQyxhQUNBQyxRQUNoQjtFQXVIRixLQS9Ia0I7RUErSGpCLEtBOUhpQjtF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