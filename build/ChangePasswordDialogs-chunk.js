import { mithril_default } from "./mithril-chunk.js";
import { assertNonNull, assertNotNull, ofClass } from "./dist2-chunk.js";
import { DEFAULT_KDF_TYPE, asKdfType } from "./TutanotaConstants-chunk.js";
import { NotAuthenticatedError } from "./RestError-chunk.js";
import { Dialog } from "./Dialog-chunk.js";
import { locator } from "./CommonLocator-chunk.js";
import { showProgressDialog } from "./ProgressDialog-chunk.js";
import { PasswordForm, PasswordModel } from "./PasswordForm-chunk.js";

//#region src/common/settings/login/ChangePasswordDialogs.ts
async function showChangeUserPasswordAsAdminDialog(user) {
	const model = new PasswordModel(locator.usageTestController, locator.logins, {
		checkOldPassword: false,
		enforceStrength: false,
		hideConfirmation: true
	});
	const changeUserPasswordAsAdminOkAction = async (dialog) => {
		showProgressDialog("pleaseWait_msg", locator.userManagementFacade.changeUserPassword(user, model.getNewPassword())).then(() => {
			Dialog.message("pwChangeValid_msg");
			dialog.close();
		}, (e) => {
			console.error(e);
			Dialog.message("passwordResetFailed_msg");
		});
	};
	Dialog.showActionDialog({
		title: "changePassword_label",
		child: () => mithril_default(PasswordForm, { model }),
		validator: () => model.getErrorMessageId(),
		okAction: changeUserPasswordAsAdminOkAction
	});
}
async function storeNewPassword(currentUser, newPasswordData) {
	const credentialsProvider = locator.credentialsProvider;
	const storedCredentials = await credentialsProvider.getCredentialsInfoByUserId(currentUser._id);
	if (storedCredentials != null) {
		assertNonNull(newPasswordData, "encrypted password data is not provided");
		await credentialsProvider.replacePassword(storedCredentials, newPasswordData.newEncryptedPassphrase, newPasswordData.newEncryptedPassphraseKey);
	}
}
async function showChangeOwnPasswordDialog(allowCancel = true) {
	const model = new PasswordModel(locator.usageTestController, locator.logins, {
		checkOldPassword: true,
		enforceStrength: true
	});
	const changeOwnPasswordOkAction = async (dialog) => {
		const error = model.getErrorMessageId();
		if (error) Dialog.message(error);
else {
			const currentUser = locator.logins.getUserController().user;
			const currentKdfType = asKdfType(currentUser.kdfVersion);
			const currentPasswordKeyData = {
				kdfType: currentKdfType,
				salt: assertNotNull(currentUser.salt),
				passphrase: model.getOldPassword()
			};
			const newPasswordKeyData = {
				kdfType: DEFAULT_KDF_TYPE,
				passphrase: model.getNewPassword()
			};
			showProgressDialog("pleaseWait_msg", locator.loginFacade.changePassword(currentPasswordKeyData, newPasswordKeyData)).then((newPasswordData) => {
				Dialog.message("pwChangeValid_msg");
				dialog.close();
				storeNewPassword(currentUser, newPasswordData);
			}).catch(ofClass(NotAuthenticatedError, (e) => {
				Dialog.message("oldPasswordInvalid_msg");
			})).catch((e) => {
				console.error(e);
				Dialog.message("passwordResetFailed_msg");
			});
		}
	};
	Dialog.showActionDialog({
		title: "changePassword_label",
		child: () => mithril_default(PasswordForm, { model }),
		validator: () => model.getErrorMessageId(),
		okAction: changeOwnPasswordOkAction,
		allowCancel
	});
}

//#endregion
export { showChangeOwnPasswordDialog, showChangeUserPasswordAsAdminDialog };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hhbmdlUGFzc3dvcmREaWFsb2dzLWNodW5rLmpzIiwibmFtZXMiOlsidXNlcjogVXNlciIsImRpYWxvZzogRGlhbG9nIiwiY3VycmVudFVzZXI6IFVzZXIiLCJuZXdQYXNzd29yZERhdGE6IHtcblx0XHRuZXdFbmNyeXB0ZWRQYXNzcGhyYXNlOiBCYXNlNjRcblx0XHRuZXdFbmNyeXB0ZWRQYXNzcGhyYXNlS2V5OiBVaW50OEFycmF5XG5cdH0gfCBudWxsIiwiYWxsb3dDYW5jZWw6IGJvb2xlYW4iXSwic291cmNlcyI6WyIuLi9zcmMvY29tbW9uL3NldHRpbmdzL2xvZ2luL0NoYW5nZVBhc3N3b3JkRGlhbG9ncy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBVc2VyIH0gZnJvbSBcIi4uLy4uL2FwaS9lbnRpdGllcy9zeXMvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHsgRGlhbG9nIH0gZnJvbSBcIi4uLy4uL2d1aS9iYXNlL0RpYWxvZy5qc1wiXG5pbXBvcnQgeyBsb2NhdG9yIH0gZnJvbSBcIi4uLy4uL2FwaS9tYWluL0NvbW1vbkxvY2F0b3IuanNcIlxuaW1wb3J0IHsgc2hvd1Byb2dyZXNzRGlhbG9nIH0gZnJvbSBcIi4uLy4uL2d1aS9kaWFsb2dzL1Byb2dyZXNzRGlhbG9nLmpzXCJcbmltcG9ydCB7IGxhbmcgfSBmcm9tIFwiLi4vLi4vbWlzYy9MYW5ndWFnZVZpZXdNb2RlbC5qc1wiXG5pbXBvcnQgbSBmcm9tIFwibWl0aHJpbFwiXG5pbXBvcnQgeyBOb3RBdXRoZW50aWNhdGVkRXJyb3IgfSBmcm9tIFwiLi4vLi4vYXBpL2NvbW1vbi9lcnJvci9SZXN0RXJyb3IuanNcIlxuaW1wb3J0IHsgUGFzc3dvcmRGb3JtLCBQYXNzd29yZE1vZGVsIH0gZnJvbSBcIi4uL1Bhc3N3b3JkRm9ybS5qc1wiXG5pbXBvcnQgeyBhc3NlcnROb25OdWxsLCBhc3NlcnROb3ROdWxsLCBCYXNlNjQsIG9mQ2xhc3MgfSBmcm9tIFwiQHR1dGFvL3R1dGFub3RhLXV0aWxzXCJcbmltcG9ydCB7IGFzS2RmVHlwZSwgREVGQVVMVF9LREZfVFlQRSB9IGZyb20gXCIuLi8uLi9hcGkvY29tbW9uL1R1dGFub3RhQ29uc3RhbnRzLmpzXCJcblxuLyoqXG4gKlRoZSBhZG1pbiBkb2VzIG5vdCBoYXZlIHRvIGVudGVyIHRoZSBvbGQgcGFzc3dvcmQgaW4gYWRkaXRpb24gdG8gdGhlIG5ldyBwYXNzd29yZCAodHdpY2UpLiBUaGUgcGFzc3dvcmQgc3RyZW5ndGggaXMgbm90IGVuZm9yY2VkLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2hvd0NoYW5nZVVzZXJQYXNzd29yZEFzQWRtaW5EaWFsb2codXNlcjogVXNlcikge1xuXHRjb25zdCBtb2RlbCA9IG5ldyBQYXNzd29yZE1vZGVsKGxvY2F0b3IudXNhZ2VUZXN0Q29udHJvbGxlciwgbG9jYXRvci5sb2dpbnMsIHsgY2hlY2tPbGRQYXNzd29yZDogZmFsc2UsIGVuZm9yY2VTdHJlbmd0aDogZmFsc2UsIGhpZGVDb25maXJtYXRpb246IHRydWUgfSlcblxuXHRjb25zdCBjaGFuZ2VVc2VyUGFzc3dvcmRBc0FkbWluT2tBY3Rpb24gPSBhc3luYyAoZGlhbG9nOiBEaWFsb2cpID0+IHtcblx0XHRzaG93UHJvZ3Jlc3NEaWFsb2coXCJwbGVhc2VXYWl0X21zZ1wiLCBsb2NhdG9yLnVzZXJNYW5hZ2VtZW50RmFjYWRlLmNoYW5nZVVzZXJQYXNzd29yZCh1c2VyLCBtb2RlbC5nZXROZXdQYXNzd29yZCgpKSkudGhlbihcblx0XHRcdCgpID0+IHtcblx0XHRcdFx0RGlhbG9nLm1lc3NhZ2UoXCJwd0NoYW5nZVZhbGlkX21zZ1wiKVxuXHRcdFx0XHRkaWFsb2cuY2xvc2UoKVxuXHRcdFx0fSxcblx0XHRcdChlKSA9PiB7XG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoZSlcblx0XHRcdFx0RGlhbG9nLm1lc3NhZ2UoXCJwYXNzd29yZFJlc2V0RmFpbGVkX21zZ1wiKVxuXHRcdFx0fSxcblx0XHQpXG5cdH1cblxuXHREaWFsb2cuc2hvd0FjdGlvbkRpYWxvZyh7XG5cdFx0dGl0bGU6IFwiY2hhbmdlUGFzc3dvcmRfbGFiZWxcIixcblx0XHRjaGlsZDogKCkgPT4gbShQYXNzd29yZEZvcm0sIHsgbW9kZWwgfSksXG5cdFx0dmFsaWRhdG9yOiAoKSA9PiBtb2RlbC5nZXRFcnJvck1lc3NhZ2VJZCgpLFxuXHRcdG9rQWN0aW9uOiBjaGFuZ2VVc2VyUGFzc3dvcmRBc0FkbWluT2tBY3Rpb24sXG5cdH0pXG59XG5cbmFzeW5jIGZ1bmN0aW9uIHN0b3JlTmV3UGFzc3dvcmQoXG5cdGN1cnJlbnRVc2VyOiBVc2VyLFxuXHRuZXdQYXNzd29yZERhdGE6IHtcblx0XHRuZXdFbmNyeXB0ZWRQYXNzcGhyYXNlOiBCYXNlNjRcblx0XHRuZXdFbmNyeXB0ZWRQYXNzcGhyYXNlS2V5OiBVaW50OEFycmF5XG5cdH0gfCBudWxsLFxuKSB7XG5cdGNvbnN0IGNyZWRlbnRpYWxzUHJvdmlkZXIgPSBsb2NhdG9yLmNyZWRlbnRpYWxzUHJvdmlkZXJcblx0Y29uc3Qgc3RvcmVkQ3JlZGVudGlhbHMgPSBhd2FpdCBjcmVkZW50aWFsc1Byb3ZpZGVyLmdldENyZWRlbnRpYWxzSW5mb0J5VXNlcklkKGN1cnJlbnRVc2VyLl9pZClcblx0aWYgKHN0b3JlZENyZWRlbnRpYWxzICE9IG51bGwpIHtcblx0XHRhc3NlcnROb25OdWxsKG5ld1Bhc3N3b3JkRGF0YSwgXCJlbmNyeXB0ZWQgcGFzc3dvcmQgZGF0YSBpcyBub3QgcHJvdmlkZWRcIilcblx0XHRhd2FpdCBjcmVkZW50aWFsc1Byb3ZpZGVyLnJlcGxhY2VQYXNzd29yZChzdG9yZWRDcmVkZW50aWFscywgbmV3UGFzc3dvcmREYXRhLm5ld0VuY3J5cHRlZFBhc3NwaHJhc2UsIG5ld1Bhc3N3b3JkRGF0YS5uZXdFbmNyeXB0ZWRQYXNzcGhyYXNlS2V5KVxuXHR9XG59XG5cbi8qKlxuICogVGhlIHVzZXIgbXVzdCBlbnRlciB0aGUgb2xkIHBhc3N3b3JkIGluIGFkZGl0aW9uIHRvIHRoZSBuZXcgcGFzc3dvcmQgKHR3aWNlKS4gVGhlIHBhc3N3b3JkIHN0cmVuZ3RoIGlzIGVuZm9yY2VkLlxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2hvd0NoYW5nZU93blBhc3N3b3JkRGlhbG9nKGFsbG93Q2FuY2VsOiBib29sZWFuID0gdHJ1ZSkge1xuXHRjb25zdCBtb2RlbCA9IG5ldyBQYXNzd29yZE1vZGVsKGxvY2F0b3IudXNhZ2VUZXN0Q29udHJvbGxlciwgbG9jYXRvci5sb2dpbnMsIHsgY2hlY2tPbGRQYXNzd29yZDogdHJ1ZSwgZW5mb3JjZVN0cmVuZ3RoOiB0cnVlIH0pXG5cblx0Y29uc3QgY2hhbmdlT3duUGFzc3dvcmRPa0FjdGlvbiA9IGFzeW5jIChkaWFsb2c6IERpYWxvZykgPT4ge1xuXHRcdGNvbnN0IGVycm9yID0gbW9kZWwuZ2V0RXJyb3JNZXNzYWdlSWQoKVxuXG5cdFx0aWYgKGVycm9yKSB7XG5cdFx0XHREaWFsb2cubWVzc2FnZShlcnJvcilcblx0XHR9IGVsc2Uge1xuXHRcdFx0Y29uc3QgY3VycmVudFVzZXIgPSBsb2NhdG9yLmxvZ2lucy5nZXRVc2VyQ29udHJvbGxlcigpLnVzZXJcblx0XHRcdGNvbnN0IGN1cnJlbnRLZGZUeXBlID0gYXNLZGZUeXBlKGN1cnJlbnRVc2VyLmtkZlZlcnNpb24pXG5cdFx0XHRjb25zdCBjdXJyZW50UGFzc3dvcmRLZXlEYXRhID0ge1xuXHRcdFx0XHRrZGZUeXBlOiBjdXJyZW50S2RmVHlwZSxcblx0XHRcdFx0c2FsdDogYXNzZXJ0Tm90TnVsbChjdXJyZW50VXNlci5zYWx0KSxcblx0XHRcdFx0cGFzc3BocmFzZTogbW9kZWwuZ2V0T2xkUGFzc3dvcmQoKSxcblx0XHRcdH1cblxuXHRcdFx0Y29uc3QgbmV3UGFzc3dvcmRLZXlEYXRhID0ge1xuXHRcdFx0XHRrZGZUeXBlOiBERUZBVUxUX0tERl9UWVBFLFxuXHRcdFx0XHRwYXNzcGhyYXNlOiBtb2RlbC5nZXROZXdQYXNzd29yZCgpLFxuXHRcdFx0fVxuXG5cdFx0XHRzaG93UHJvZ3Jlc3NEaWFsb2coXCJwbGVhc2VXYWl0X21zZ1wiLCBsb2NhdG9yLmxvZ2luRmFjYWRlLmNoYW5nZVBhc3N3b3JkKGN1cnJlbnRQYXNzd29yZEtleURhdGEsIG5ld1Bhc3N3b3JkS2V5RGF0YSkpXG5cdFx0XHRcdC50aGVuKChuZXdQYXNzd29yZERhdGEpID0+IHtcblx0XHRcdFx0XHREaWFsb2cubWVzc2FnZShcInB3Q2hhbmdlVmFsaWRfbXNnXCIpXG5cdFx0XHRcdFx0ZGlhbG9nLmNsb3NlKClcblx0XHRcdFx0XHQvLyBkbyBub3Qgd2FpdCBmb3IgaXQgb3IgY2F0Y2ggdGhlIGVycm9ycywgd2UgZG8gbm90IHdhbnQgdG8gY29uZnVzZSB0aGUgdXNlciB3aXRoIHRoZSBwYXNzd29yZCBjaGFuZ2UgaWYgYW55dGhpbmcgZ29lcyB3cm9uZ1xuXHRcdFx0XHRcdHN0b3JlTmV3UGFzc3dvcmQoY3VycmVudFVzZXIsIG5ld1Bhc3N3b3JkRGF0YSlcblx0XHRcdFx0fSlcblx0XHRcdFx0LmNhdGNoKFxuXHRcdFx0XHRcdG9mQ2xhc3MoTm90QXV0aGVudGljYXRlZEVycm9yLCAoZSkgPT4ge1xuXHRcdFx0XHRcdFx0RGlhbG9nLm1lc3NhZ2UoXCJvbGRQYXNzd29yZEludmFsaWRfbXNnXCIpXG5cdFx0XHRcdFx0fSksXG5cdFx0XHRcdClcblx0XHRcdFx0LmNhdGNoKChlKSA9PiB7XG5cdFx0XHRcdFx0Y29uc29sZS5lcnJvcihlKVxuXHRcdFx0XHRcdERpYWxvZy5tZXNzYWdlKFwicGFzc3dvcmRSZXNldEZhaWxlZF9tc2dcIilcblx0XHRcdFx0fSlcblx0XHR9XG5cdH1cblxuXHREaWFsb2cuc2hvd0FjdGlvbkRpYWxvZyh7XG5cdFx0dGl0bGU6IFwiY2hhbmdlUGFzc3dvcmRfbGFiZWxcIixcblx0XHRjaGlsZDogKCkgPT4gbShQYXNzd29yZEZvcm0sIHsgbW9kZWwgfSksXG5cdFx0dmFsaWRhdG9yOiAoKSA9PiBtb2RlbC5nZXRFcnJvck1lc3NhZ2VJZCgpLFxuXHRcdG9rQWN0aW9uOiBjaGFuZ2VPd25QYXNzd29yZE9rQWN0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