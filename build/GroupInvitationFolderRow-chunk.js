import { __toESM } from "./chunk-chunk.js";
import { mithril_default } from "./mithril-chunk.js";
import { downcast } from "./dist2-chunk.js";
import { lang } from "./LanguageViewModel-chunk.js";
import { GroupType } from "./TutanotaConstants-chunk.js";
import { size } from "./size-chunk.js";
import { isSameId } from "./EntityUtils-chunk.js";
import { createDefaultAlarmInfo, createGroupSettings } from "./TypeRefs-chunk.js";
import { serializeAlarmInterval } from "./CommonCalendarUtils-chunk.js";
import { require_stream } from "./stream-chunk.js";
import { Icons } from "./Icons-chunk.js";
import { Dialog, TextField } from "./Dialog-chunk.js";
import { IconButton } from "./IconButton-chunk.js";
import { getCapabilityText, getDefaultGroupName, getInvitationGroupType, isTemplateGroup } from "./GroupUtils2-chunk.js";
import { locator } from "./CommonLocator-chunk.js";
import { getMailAddressDisplayText } from "./SharedMailUtils-chunk.js";
import { showPlanUpgradeRequiredDialog } from "./SubscriptionDialogs-chunk.js";
import { LoginButton } from "./LoginButton-chunk.js";
import { ColorPickerView } from "./ColorPickerView-chunk.js";
import { getTextsForGroupType, sendAcceptNotificationEmail, sendRejectNotificationEmail } from "./GroupGuiUtils-chunk.js";

//#region src/common/sharing/view/ReceivedGroupInvitationDialog.ts
var import_stream = __toESM(require_stream(), 1);
function showGroupInvitationDialog(invitation) {
	const groupType = getInvitationGroupType(invitation);
	const texts = getTextsForGroupType(groupType);
	const userSettingsGroupRoot = locator.logins.getUserController().userSettingsGroupRoot;
	const existingGroupSettings = userSettingsGroupRoot.groupSettings.find((gc) => gc.group === invitation.sharedGroup);
	const color = existingGroupSettings ? "#" + existingGroupSettings.color : "";
	const colorStream = (0, import_stream.default)(color);
	const isDefaultGroupName = invitation.sharedGroupName === getDefaultGroupName(downcast(invitation.groupType));
	const nameStream = (0, import_stream.default)(isDefaultGroupName ? texts.sharedGroupDefaultCustomName(invitation) : invitation.sharedGroupName);
	const alarmsStream = (0, import_stream.default)([]);
	const isMember = locator.logins.getUserController().getCalendarMemberships().some((ms) => isSameId(ms.group, invitation.sharedGroup));
	let dialog;
	const onAcceptClicked = () => {
		checkCanAcceptGroupInvitation(invitation).then((canAccept) => {
			if (canAccept) acceptInvite(invitation, texts).then(() => {
				dialog.close();
				const newColor = colorStream().substring(1);
				const newName = nameStream();
				if (existingGroupSettings) {
					existingGroupSettings.color = newColor;
					existingGroupSettings.name = newName;
				} else {
					const groupSettings = createGroupSettings({
						group: invitation.sharedGroup,
						color: newColor,
						name: newName,
						defaultAlarmsList: alarmsStream().map((alarm) => createDefaultAlarmInfo({ trigger: serializeAlarmInterval(alarm) })),
						sourceUrl: null
					});
					userSettingsGroupRoot.groupSettings.push(groupSettings);
				}
				locator.entityClient.update(userSettingsGroupRoot);
			});
		});
	};
	dialog = Dialog.showActionDialog({
		title: "invitation_label",
		child: { view: () => mithril_default(".flex.col", [mithril_default(".mb", [
			mithril_default(".pt.selectable", isMember ? lang.getTranslationText(texts.alreadyGroupMemberMessage) : texts.receivedGroupInvitationMessage),
			mithril_default(TextField, {
				value: nameStream(),
				oninput: nameStream,
				label: texts.groupNameLabel
			}),
			mithril_default(TextField, {
				value: getMailAddressDisplayText(invitation.inviterName, invitation.inviterMailAddress, false),
				label: "sender_label",
				isReadOnly: true
			}),
			mithril_default(TextField, {
				value: invitation.inviteeMailAddress,
				label: "to_label",
				isReadOnly: true
			}),
			mithril_default(TextField, {
				value: getCapabilityText(downcast(invitation.capability)),
				label: "permissions_label",
				isReadOnly: true
			}),
			groupType === GroupType.Calendar ? renderCalendarGroupInvitationFields(invitation, colorStream, alarmsStream) : null
		]), isMember ? null : mithril_default(LoginButton, {
			label: "acceptInvitation_action",
			onclick: onAcceptClicked
		})]) },
		okActionTextId: "decline_action",
		okAction: (dialog$1) => {
			dialog$1.close();
			declineInvite(invitation, texts);
		},
		cancelActionTextId: "close_alt"
	});
}
/**
* Checks if the logged-in user is able to accept the group invitation.
* This is necessary because to be part of some kinds of groups you must have certain features.
* Currently, there are two kinds of group invitations:
* 1. Calendar: any paid account can accept invitations
* 2. Template: only accounts with the templates feature can accept invitations
* @param invitation
*/
async function checkCanAcceptGroupInvitation(invitation) {
	const SubscriptionDialogUtils = await import("./SubscriptionDialogs2-chunk.js");
	const allowed = await SubscriptionDialogUtils.checkPaidSubscription();
	if (!allowed) return false;
	const planConfig = await locator.logins.getUserController().getPlanConfig();
	if (isTemplateGroup(getInvitationGroupType(invitation)) && !planConfig.templates) {
		const { getAvailablePlansWithTemplates } = await import("./SubscriptionUtils2-chunk.js");
		const plans = await getAvailablePlansWithTemplates();
		return showPlanUpgradeRequiredDialog(plans);
	} else return true;
}
function renderCalendarGroupInvitationFields(invitation, selectedColourValue, alarmsStream) {
	let alarms = alarmsStream();
	return [mithril_default(".small.mt.mb-xs", lang.get("color_label")), mithril_default(ColorPickerView, {
		value: selectedColourValue(),
		onselect: selectedColourValue
	})];
}
function acceptInvite(invitation, texts) {
	return locator.shareFacade.acceptGroupInvitation(invitation).then(() => {
		sendAcceptNotificationEmail(invitation, texts);
	});
}
function declineInvite(invitation, texts) {
	return locator.shareFacade.rejectOrCancelGroupInvitation(invitation._id).then(() => {
		sendRejectNotificationEmail(invitation, texts);
	});
}

//#endregion
//#region src/common/sharing/view/GroupInvitationFolderRow.ts
var GroupInvitationFolderRow = class {
	view(vnode) {
		const { invitation, icon } = vnode.attrs;
		return [mithril_default(".folder-row.flex-start.plr-l", [mithril_default(".flex-v-center.flex-grow.button-height", { style: { "max-width": `calc(100% - ${size.button_height}px)` } }, [mithril_default(".b.text-ellipsis", { title: getCapabilityText(downcast(invitation.capability)) }, invitation.sharedGroupName), mithril_default(".small.text-ellipsis", { title: invitation.inviterMailAddress }, getMailAddressDisplayText(invitation.inviterName, invitation.inviterMailAddress, true))]), mithril_default(IconButton, {
			title: "show_action",
			click: () => showGroupInvitationDialog(invitation),
			icon: icon ?? Icons.Eye
		})])];
	}
};

//#endregion
export { GroupInvitationFolderRow };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3JvdXBJbnZpdGF0aW9uRm9sZGVyUm93LWNodW5rLmpzIiwibmFtZXMiOlsiaW52aXRhdGlvbjogUmVjZWl2ZWRHcm91cEludml0YXRpb24iLCJhbGFybXNTdHJlYW06IHN0cmVhbTxBbGFybUludGVydmFsW10+IiwiZGlhbG9nOiBEaWFsb2ciLCJzZWxlY3RlZENvbG91clZhbHVlOiBTdHJlYW08c3RyaW5nPiIsImFsYXJtc1N0cmVhbTogU3RyZWFtPEFsYXJtSW50ZXJ2YWxbXT4iLCJ0ZXh0czogR3JvdXBTaGFyaW5nVGV4dHMiLCJ2bm9kZTogVm5vZGU8R3JvdXBJbnZpdGF0aW9uRm9sZGVyUm93QXR0cnM+Il0sInNvdXJjZXMiOlsiLi4vc3JjL2NvbW1vbi9zaGFyaW5nL3ZpZXcvUmVjZWl2ZWRHcm91cEludml0YXRpb25EaWFsb2cudHMiLCIuLi9zcmMvY29tbW9uL3NoYXJpbmcvdmlldy9Hcm91cEludml0YXRpb25Gb2xkZXJSb3cudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY3JlYXRlRGVmYXVsdEFsYXJtSW5mbywgY3JlYXRlR3JvdXBTZXR0aW5ncyB9IGZyb20gXCIuLi8uLi9hcGkvZW50aXRpZXMvdHV0YW5vdGEvVHlwZVJlZnMuanNcIlxuaW1wb3J0IG0sIHsgQ2hpbGRyZW4gfSBmcm9tIFwibWl0aHJpbFwiXG5pbXBvcnQgeyBsYW5nIH0gZnJvbSBcIi4uLy4uL21pc2MvTGFuZ3VhZ2VWaWV3TW9kZWwuanNcIlxuaW1wb3J0IHsgVGV4dEZpZWxkIH0gZnJvbSBcIi4uLy4uL2d1aS9iYXNlL1RleHRGaWVsZC5qc1wiXG5pbXBvcnQgc3RyZWFtIGZyb20gXCJtaXRocmlsL3N0cmVhbVwiXG5pbXBvcnQgU3RyZWFtIGZyb20gXCJtaXRocmlsL3N0cmVhbVwiXG5pbXBvcnQgeyBkb3duY2FzdCB9IGZyb20gXCJAdHV0YW8vdHV0YW5vdGEtdXRpbHNcIlxuaW1wb3J0IHsgRGlhbG9nIH0gZnJvbSBcIi4uLy4uL2d1aS9iYXNlL0RpYWxvZy5qc1wiXG5pbXBvcnQgeyBSZWNlaXZlZEdyb3VwSW52aXRhdGlvbiB9IGZyb20gXCIuLi8uLi9hcGkvZW50aXRpZXMvc3lzL1R5cGVSZWZzLmpzXCJcbmltcG9ydCB7IGlzU2FtZUlkIH0gZnJvbSBcIi4uLy4uL2FwaS9jb21tb24vdXRpbHMvRW50aXR5VXRpbHMuanNcIlxuaW1wb3J0IHsgc2VuZEFjY2VwdE5vdGlmaWNhdGlvbkVtYWlsLCBzZW5kUmVqZWN0Tm90aWZpY2F0aW9uRW1haWwgfSBmcm9tIFwiLi4vR3JvdXBTaGFyaW5nVXRpbHMuanNcIlxuaW1wb3J0IHsgZ2V0Q2FwYWJpbGl0eVRleHQsIGdldERlZmF1bHRHcm91cE5hbWUsIGdldEludml0YXRpb25Hcm91cFR5cGUsIGlzVGVtcGxhdGVHcm91cCB9IGZyb20gXCIuLi9Hcm91cFV0aWxzLmpzXCJcbmltcG9ydCB7IHNob3dQbGFuVXBncmFkZVJlcXVpcmVkRGlhbG9nIH0gZnJvbSBcIi4uLy4uL21pc2MvU3Vic2NyaXB0aW9uRGlhbG9ncy5qc1wiXG5pbXBvcnQgdHlwZSB7IEdyb3VwU2hhcmluZ1RleHRzIH0gZnJvbSBcIi4uL0dyb3VwR3VpVXRpbHMuanNcIlxuaW1wb3J0IHsgZ2V0VGV4dHNGb3JHcm91cFR5cGUgfSBmcm9tIFwiLi4vR3JvdXBHdWlVdGlscy5qc1wiXG5pbXBvcnQgeyBHcm91cFR5cGUgfSBmcm9tIFwiLi4vLi4vYXBpL2NvbW1vbi9UdXRhbm90YUNvbnN0YW50cy5qc1wiXG5pbXBvcnQgeyBsb2NhdG9yIH0gZnJvbSBcIi4uLy4uL2FwaS9tYWluL0NvbW1vbkxvY2F0b3IuanNcIlxuaW1wb3J0IHsgTG9naW5CdXR0b24gfSBmcm9tIFwiLi4vLi4vZ3VpL2Jhc2UvYnV0dG9ucy9Mb2dpbkJ1dHRvbi5qc1wiXG5pbXBvcnQgeyBBbGFybUludGVydmFsIH0gZnJvbSBcIi4uLy4uL2NhbGVuZGFyL2RhdGUvQ2FsZW5kYXJVdGlscy5qc1wiXG5pbXBvcnQgeyBnZXRNYWlsQWRkcmVzc0Rpc3BsYXlUZXh0IH0gZnJvbSBcIi4uLy4uL21haWxGdW5jdGlvbmFsaXR5L1NoYXJlZE1haWxVdGlscy5qc1wiXG5pbXBvcnQgeyBzZXJpYWxpemVBbGFybUludGVydmFsIH0gZnJvbSBcIi4uLy4uL2FwaS9jb21tb24vdXRpbHMvQ29tbW9uQ2FsZW5kYXJVdGlscy5qc1wiXG5pbXBvcnQgeyBDb2xvclBpY2tlclZpZXcgfSBmcm9tIFwiLi4vLi4vZ3VpL2Jhc2UvY29sb3JQaWNrZXIvQ29sb3JQaWNrZXJWaWV3XCJcblxuZXhwb3J0IGZ1bmN0aW9uIHNob3dHcm91cEludml0YXRpb25EaWFsb2coaW52aXRhdGlvbjogUmVjZWl2ZWRHcm91cEludml0YXRpb24pIHtcblx0Y29uc3QgZ3JvdXBUeXBlID0gZ2V0SW52aXRhdGlvbkdyb3VwVHlwZShpbnZpdGF0aW9uKVxuXHRjb25zdCB0ZXh0cyA9IGdldFRleHRzRm9yR3JvdXBUeXBlKGdyb3VwVHlwZSlcblx0Y29uc3QgdXNlclNldHRpbmdzR3JvdXBSb290ID0gbG9jYXRvci5sb2dpbnMuZ2V0VXNlckNvbnRyb2xsZXIoKS51c2VyU2V0dGluZ3NHcm91cFJvb3Rcblx0Y29uc3QgZXhpc3RpbmdHcm91cFNldHRpbmdzID0gdXNlclNldHRpbmdzR3JvdXBSb290Lmdyb3VwU2V0dGluZ3MuZmluZCgoZ2MpID0+IGdjLmdyb3VwID09PSBpbnZpdGF0aW9uLnNoYXJlZEdyb3VwKVxuXHRjb25zdCBjb2xvciA9IGV4aXN0aW5nR3JvdXBTZXR0aW5ncyA/IFwiI1wiICsgZXhpc3RpbmdHcm91cFNldHRpbmdzLmNvbG9yIDogXCJcIlxuXHRjb25zdCBjb2xvclN0cmVhbSA9IHN0cmVhbShjb2xvcilcblx0Y29uc3QgaXNEZWZhdWx0R3JvdXBOYW1lID0gaW52aXRhdGlvbi5zaGFyZWRHcm91cE5hbWUgPT09IGdldERlZmF1bHRHcm91cE5hbWUoZG93bmNhc3QoaW52aXRhdGlvbi5ncm91cFR5cGUpKVxuXHRjb25zdCBuYW1lU3RyZWFtID0gc3RyZWFtKGlzRGVmYXVsdEdyb3VwTmFtZSA/IHRleHRzLnNoYXJlZEdyb3VwRGVmYXVsdEN1c3RvbU5hbWUoaW52aXRhdGlvbikgOiBpbnZpdGF0aW9uLnNoYXJlZEdyb3VwTmFtZSlcblx0Y29uc3QgYWxhcm1zU3RyZWFtOiBzdHJlYW08QWxhcm1JbnRlcnZhbFtdPiA9IHN0cmVhbShbXSlcblxuXHRjb25zdCBpc01lbWJlciA9IGxvY2F0b3IubG9naW5zXG5cdFx0LmdldFVzZXJDb250cm9sbGVyKClcblx0XHQuZ2V0Q2FsZW5kYXJNZW1iZXJzaGlwcygpXG5cdFx0LnNvbWUoKG1zKSA9PiBpc1NhbWVJZChtcy5ncm91cCwgaW52aXRhdGlvbi5zaGFyZWRHcm91cCkpXG5cdGxldCBkaWFsb2c6IERpYWxvZ1xuXG5cdGNvbnN0IG9uQWNjZXB0Q2xpY2tlZCA9ICgpID0+IHtcblx0XHRjaGVja0NhbkFjY2VwdEdyb3VwSW52aXRhdGlvbihpbnZpdGF0aW9uKS50aGVuKChjYW5BY2NlcHQpID0+IHtcblx0XHRcdGlmIChjYW5BY2NlcHQpIHtcblx0XHRcdFx0YWNjZXB0SW52aXRlKGludml0YXRpb24sIHRleHRzKS50aGVuKCgpID0+IHtcblx0XHRcdFx0XHRkaWFsb2cuY2xvc2UoKVxuXHRcdFx0XHRcdGNvbnN0IG5ld0NvbG9yID0gY29sb3JTdHJlYW0oKS5zdWJzdHJpbmcoMSkgLy8gY29sb3IgaXMgc3RvcmVkIHdpdGhvdXQgI1xuXG5cdFx0XHRcdFx0Y29uc3QgbmV3TmFtZSA9IG5hbWVTdHJlYW0oKVxuXG5cdFx0XHRcdFx0aWYgKGV4aXN0aW5nR3JvdXBTZXR0aW5ncykge1xuXHRcdFx0XHRcdFx0ZXhpc3RpbmdHcm91cFNldHRpbmdzLmNvbG9yID0gbmV3Q29sb3Jcblx0XHRcdFx0XHRcdGV4aXN0aW5nR3JvdXBTZXR0aW5ncy5uYW1lID0gbmV3TmFtZVxuXHRcdFx0XHRcdH0gZWxzZSB7XG5cdFx0XHRcdFx0XHRjb25zdCBncm91cFNldHRpbmdzID0gY3JlYXRlR3JvdXBTZXR0aW5ncyh7XG5cdFx0XHRcdFx0XHRcdGdyb3VwOiBpbnZpdGF0aW9uLnNoYXJlZEdyb3VwLFxuXHRcdFx0XHRcdFx0XHRjb2xvcjogbmV3Q29sb3IsXG5cdFx0XHRcdFx0XHRcdG5hbWU6IG5ld05hbWUsXG5cdFx0XHRcdFx0XHRcdGRlZmF1bHRBbGFybXNMaXN0OiBhbGFybXNTdHJlYW0oKS5tYXAoKGFsYXJtKSA9PiBjcmVhdGVEZWZhdWx0QWxhcm1JbmZvKHsgdHJpZ2dlcjogc2VyaWFsaXplQWxhcm1JbnRlcnZhbChhbGFybSkgfSkpLFxuXHRcdFx0XHRcdFx0XHRzb3VyY2VVcmw6IG51bGwsXG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdFx0dXNlclNldHRpbmdzR3JvdXBSb290Lmdyb3VwU2V0dGluZ3MucHVzaChncm91cFNldHRpbmdzKVxuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGxvY2F0b3IuZW50aXR5Q2xpZW50LnVwZGF0ZSh1c2VyU2V0dGluZ3NHcm91cFJvb3QpXG5cdFx0XHRcdH0pXG5cdFx0XHR9XG5cdFx0fSlcblx0fVxuXG5cdGRpYWxvZyA9IERpYWxvZy5zaG93QWN0aW9uRGlhbG9nKHtcblx0XHR0aXRsZTogXCJpbnZpdGF0aW9uX2xhYmVsXCIsXG5cdFx0Y2hpbGQ6IHtcblx0XHRcdHZpZXc6ICgpID0+XG5cdFx0XHRcdG0oXCIuZmxleC5jb2xcIiwgW1xuXHRcdFx0XHRcdG0oXCIubWJcIiwgW1xuXHRcdFx0XHRcdFx0bShcIi5wdC5zZWxlY3RhYmxlXCIsIGlzTWVtYmVyID8gbGFuZy5nZXRUcmFuc2xhdGlvblRleHQodGV4dHMuYWxyZWFkeUdyb3VwTWVtYmVyTWVzc2FnZSkgOiB0ZXh0cy5yZWNlaXZlZEdyb3VwSW52aXRhdGlvbk1lc3NhZ2UpLFxuXHRcdFx0XHRcdFx0bShUZXh0RmllbGQsIHtcblx0XHRcdFx0XHRcdFx0dmFsdWU6IG5hbWVTdHJlYW0oKSxcblx0XHRcdFx0XHRcdFx0b25pbnB1dDogbmFtZVN0cmVhbSxcblx0XHRcdFx0XHRcdFx0bGFiZWw6IHRleHRzLmdyb3VwTmFtZUxhYmVsLFxuXHRcdFx0XHRcdFx0fSksXG5cdFx0XHRcdFx0XHRtKFRleHRGaWVsZCwge1xuXHRcdFx0XHRcdFx0XHR2YWx1ZTogZ2V0TWFpbEFkZHJlc3NEaXNwbGF5VGV4dChpbnZpdGF0aW9uLmludml0ZXJOYW1lLCBpbnZpdGF0aW9uLmludml0ZXJNYWlsQWRkcmVzcywgZmFsc2UpLFxuXHRcdFx0XHRcdFx0XHRsYWJlbDogXCJzZW5kZXJfbGFiZWxcIixcblx0XHRcdFx0XHRcdFx0aXNSZWFkT25seTogdHJ1ZSxcblx0XHRcdFx0XHRcdH0pLFxuXHRcdFx0XHRcdFx0bShUZXh0RmllbGQsIHtcblx0XHRcdFx0XHRcdFx0dmFsdWU6IGludml0YXRpb24uaW52aXRlZU1haWxBZGRyZXNzLFxuXHRcdFx0XHRcdFx0XHRsYWJlbDogXCJ0b19sYWJlbFwiLFxuXHRcdFx0XHRcdFx0XHRpc1JlYWRPbmx5OiB0cnVlLFxuXHRcdFx0XHRcdFx0fSksXG5cdFx0XHRcdFx0XHRtKFRleHRGaWVsZCwge1xuXHRcdFx0XHRcdFx0XHR2YWx1ZTogZ2V0Q2FwYWJpbGl0eVRleHQoZG93bmNhc3QoaW52aXRhdGlvbi5jYXBhYmlsaXR5KSksXG5cdFx0XHRcdFx0XHRcdGxhYmVsOiBcInBlcm1pc3Npb25zX2xhYmVsXCIsXG5cdFx0XHRcdFx0XHRcdGlzUmVhZE9ubHk6IHRydWUsXG5cdFx0XHRcdFx0XHR9KSxcblx0XHRcdFx0XHRcdGdyb3VwVHlwZSA9PT0gR3JvdXBUeXBlLkNhbGVuZGFyID8gcmVuZGVyQ2FsZW5kYXJHcm91cEludml0YXRpb25GaWVsZHMoaW52aXRhdGlvbiwgY29sb3JTdHJlYW0sIGFsYXJtc1N0cmVhbSkgOiBudWxsLFxuXHRcdFx0XHRcdF0pLFxuXHRcdFx0XHRcdGlzTWVtYmVyXG5cdFx0XHRcdFx0XHQ/IG51bGxcblx0XHRcdFx0XHRcdDogbShMb2dpbkJ1dHRvbiwge1xuXHRcdFx0XHRcdFx0XHRcdGxhYmVsOiBcImFjY2VwdEludml0YXRpb25fYWN0aW9uXCIsXG5cdFx0XHRcdFx0XHRcdFx0b25jbGljazogb25BY2NlcHRDbGlja2VkLFxuXHRcdFx0XHRcdFx0ICB9KSxcblx0XHRcdFx0XSksXG5cdFx0fSxcblx0XHRva0FjdGlvblRleHRJZDogXCJkZWNsaW5lX2FjdGlvblwiLFxuXHRcdG9rQWN0aW9uOiAoZGlhbG9nOiBEaWFsb2cpID0+IHtcblx0XHRcdGRpYWxvZy5jbG9zZSgpXG5cdFx0XHRkZWNsaW5lSW52aXRlKGludml0YXRpb24sIHRleHRzKVxuXHRcdH0sXG5cdFx0Y2FuY2VsQWN0aW9uVGV4dElkOiBcImNsb3NlX2FsdFwiLFxuXHR9KVxufVxuXG4vKipcbiAqIENoZWNrcyBpZiB0aGUgbG9nZ2VkLWluIHVzZXIgaXMgYWJsZSB0byBhY2NlcHQgdGhlIGdyb3VwIGludml0YXRpb24uXG4gKiBUaGlzIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIHRvIGJlIHBhcnQgb2Ygc29tZSBraW5kcyBvZiBncm91cHMgeW91IG11c3QgaGF2ZSBjZXJ0YWluIGZlYXR1cmVzLlxuICogQ3VycmVudGx5LCB0aGVyZSBhcmUgdHdvIGtpbmRzIG9mIGdyb3VwIGludml0YXRpb25zOlxuICogMS4gQ2FsZW5kYXI6IGFueSBwYWlkIGFjY291bnQgY2FuIGFjY2VwdCBpbnZpdGF0aW9uc1xuICogMi4gVGVtcGxhdGU6IG9ubHkgYWNjb3VudHMgd2l0aCB0aGUgdGVtcGxhdGVzIGZlYXR1cmUgY2FuIGFjY2VwdCBpbnZpdGF0aW9uc1xuICogQHBhcmFtIGludml0YXRpb25cbiAqL1xuYXN5bmMgZnVuY3Rpb24gY2hlY2tDYW5BY2NlcHRHcm91cEludml0YXRpb24oaW52aXRhdGlvbjogUmVjZWl2ZWRHcm91cEludml0YXRpb24pOiBQcm9taXNlPGJvb2xlYW4+IHtcblx0Y29uc3QgU3Vic2NyaXB0aW9uRGlhbG9nVXRpbHMgPSBhd2FpdCBpbXBvcnQoXCIuLi8uLi9taXNjL1N1YnNjcmlwdGlvbkRpYWxvZ3MuanNcIilcblx0Y29uc3QgYWxsb3dlZCA9IGF3YWl0IFN1YnNjcmlwdGlvbkRpYWxvZ1V0aWxzLmNoZWNrUGFpZFN1YnNjcmlwdGlvbigpXG5cdGlmICghYWxsb3dlZCkge1xuXHRcdHJldHVybiBmYWxzZVxuXHR9XG5cdGNvbnN0IHBsYW5Db25maWcgPSBhd2FpdCBsb2NhdG9yLmxvZ2lucy5nZXRVc2VyQ29udHJvbGxlcigpLmdldFBsYW5Db25maWcoKVxuXHRpZiAoaXNUZW1wbGF0ZUdyb3VwKGdldEludml0YXRpb25Hcm91cFR5cGUoaW52aXRhdGlvbikpICYmICFwbGFuQ29uZmlnLnRlbXBsYXRlcykge1xuXHRcdGNvbnN0IHsgZ2V0QXZhaWxhYmxlUGxhbnNXaXRoVGVtcGxhdGVzIH0gPSBhd2FpdCBpbXBvcnQoXCIuLi8uLi9zdWJzY3JpcHRpb24vU3Vic2NyaXB0aW9uVXRpbHMuanNcIilcblx0XHRjb25zdCBwbGFucyA9IGF3YWl0IGdldEF2YWlsYWJsZVBsYW5zV2l0aFRlbXBsYXRlcygpXG5cdFx0cmV0dXJuIHNob3dQbGFuVXBncmFkZVJlcXVpcmVkRGlhbG9nKHBsYW5zKVxuXHR9IGVsc2Uge1xuXHRcdHJldHVybiB0cnVlXG5cdH1cbn1cblxuZnVuY3Rpb24gcmVuZGVyQ2FsZW5kYXJHcm91cEludml0YXRpb25GaWVsZHMoXG5cdGludml0YXRpb246IFJlY2VpdmVkR3JvdXBJbnZpdGF0aW9uLFxuXHRzZWxlY3RlZENvbG91clZhbHVlOiBTdHJlYW08c3RyaW5nPixcblx0YWxhcm1zU3RyZWFtOiBTdHJlYW08QWxhcm1JbnRlcnZhbFtdPixcbik6IENoaWxkcmVuIHtcblx0bGV0IGFsYXJtcyA9IGFsYXJtc1N0cmVhbSgpXG5cdHJldHVybiBbXG5cdFx0bShcIi5zbWFsbC5tdC5tYi14c1wiLCBsYW5nLmdldChcImNvbG9yX2xhYmVsXCIpKSxcblx0XHRtKENvbG9yUGlja2VyVmlldywge1xuXHRcdFx0dmFsdWU6IHNlbGVjdGVkQ29sb3VyVmFsdWUoKSxcblx0XHRcdG9uc2VsZWN0OiBzZWxlY3RlZENvbG91clZhbHVlLFxuXHRcdH0pLFxuXHRdXG59XG5cbmZ1bmN0aW9uIGFjY2VwdEludml0ZShpbnZpdGF0aW9uOiBSZWNlaXZlZEdyb3VwSW52aXRhdGlvbiwgdGV4dHM6IEdyb3VwU2hhcmluZ1RleHRzKTogUHJvbWlzZTx2b2lkPiB7XG5cdHJldHVybiBsb2NhdG9yLnNoYXJlRmFjYWRlLmFjY2VwdEdyb3VwSW52aXRhdGlvbihpbnZpdGF0aW9uKS50aGVuKCgpID0+IHtcblx0XHRzZW5kQWNjZXB0Tm90aWZpY2F0aW9uRW1haWwoaW52aXRhdGlvbiwgdGV4dHMpXG5cdH0pXG59XG5cbmZ1bmN0aW9uIGRlY2xpbmVJbnZpdGUoaW52aXRhdGlvbjogUmVjZWl2ZWRHcm91cEludml0YXRpb24sIHRleHRzOiBHcm91cFNoYXJpbmdUZXh0cyk6IFByb21pc2U8dm9pZD4ge1xuXHRyZXR1cm4gbG9jYXRvci5zaGFyZUZhY2FkZS5yZWplY3RPckNhbmNlbEdyb3VwSW52aXRhdGlvbihpbnZpdGF0aW9uLl9pZCkudGhlbigoKSA9PiB7XG5cdFx0c2VuZFJlamVjdE5vdGlmaWNhdGlvbkVtYWlsKGludml0YXRpb24sIHRleHRzKVxuXHR9KVxufVxuIiwiaW1wb3J0IG0sIHsgQ2hpbGRyZW4sIENvbXBvbmVudCwgVm5vZGUgfSBmcm9tIFwibWl0aHJpbFwiXG5pbXBvcnQgeyBzaXplIH0gZnJvbSBcIi4uLy4uL2d1aS9zaXplXCJcbmltcG9ydCB7IGdldENhcGFiaWxpdHlUZXh0IH0gZnJvbSBcIi4uL0dyb3VwVXRpbHNcIlxuaW1wb3J0IHsgZG93bmNhc3QgfSBmcm9tIFwiQHR1dGFvL3R1dGFub3RhLXV0aWxzXCJcbmltcG9ydCB7IHNob3dHcm91cEludml0YXRpb25EaWFsb2cgfSBmcm9tIFwiLi9SZWNlaXZlZEdyb3VwSW52aXRhdGlvbkRpYWxvZy5qc1wiXG5pbXBvcnQgeyBJY29ucyB9IGZyb20gXCIuLi8uLi9ndWkvYmFzZS9pY29ucy9JY29uc1wiXG5pbXBvcnQgdHlwZSB7IFJlY2VpdmVkR3JvdXBJbnZpdGF0aW9uIH0gZnJvbSBcIi4uLy4uL2FwaS9lbnRpdGllcy9zeXMvVHlwZVJlZnMuanNcIlxuaW1wb3J0IHR5cGUgeyBBbGxJY29ucyB9IGZyb20gXCIuLi8uLi9ndWkvYmFzZS9JY29uXCJcbmltcG9ydCB7IEljb25CdXR0b24gfSBmcm9tIFwiLi4vLi4vZ3VpL2Jhc2UvSWNvbkJ1dHRvbi5qc1wiXG5pbXBvcnQgeyBnZXRNYWlsQWRkcmVzc0Rpc3BsYXlUZXh0IH0gZnJvbSBcIi4uLy4uL21haWxGdW5jdGlvbmFsaXR5L1NoYXJlZE1haWxVdGlscy5qc1wiXG5cbmV4cG9ydCB0eXBlIEdyb3VwSW52aXRhdGlvbkZvbGRlclJvd0F0dHJzID0ge1xuXHRpbnZpdGF0aW9uOiBSZWNlaXZlZEdyb3VwSW52aXRhdGlvblxuXHRpY29uPzogQWxsSWNvbnNcbn1cblxuZXhwb3J0IGNsYXNzIEdyb3VwSW52aXRhdGlvbkZvbGRlclJvdyBpbXBsZW1lbnRzIENvbXBvbmVudDxHcm91cEludml0YXRpb25Gb2xkZXJSb3dBdHRycz4ge1xuXHR2aWV3KHZub2RlOiBWbm9kZTxHcm91cEludml0YXRpb25Gb2xkZXJSb3dBdHRycz4pOiBDaGlsZHJlbiB7XG5cdFx0Y29uc3QgeyBpbnZpdGF0aW9uLCBpY29uIH0gPSB2bm9kZS5hdHRyc1xuXHRcdHJldHVybiBbXG5cdFx0XHRtKFwiLmZvbGRlci1yb3cuZmxleC1zdGFydC5wbHItbFwiLCBbXG5cdFx0XHRcdG0oXG5cdFx0XHRcdFx0XCIuZmxleC12LWNlbnRlci5mbGV4LWdyb3cuYnV0dG9uLWhlaWdodFwiLFxuXHRcdFx0XHRcdHtcblx0XHRcdFx0XHRcdHN0eWxlOiB7XG5cdFx0XHRcdFx0XHRcdC8vIEl0J3Mga2luZGEgaGFyZCB0byB0ZWxsIHRoaXMgZWxlbWVudCB0byBub3QgZWF0IHVwIGFsbCB0aGUgcm93IGFuZCB0cnVuY2F0ZSB0ZXh0IGluc3RlYWQgYmVjYXVzZSBpdFxuXHRcdFx0XHRcdFx0XHQvLyBpcyB2ZXJ0aWNhbCBmbGV4LiBXaXRoIHRoaXMgaXQgd2lsbCBzdG9wIGF0IDgwJSBvZiB3aGF0IGl0IGNvdWxkIGJlIGFuZCB0aGF0J3MgZW5vdWdoIGZvciB0aGUgYnV0dG9uLlxuXHRcdFx0XHRcdFx0XHRcIm1heC13aWR0aFwiOiBgY2FsYygxMDAlIC0gJHtzaXplLmJ1dHRvbl9oZWlnaHR9cHgpYCxcblx0XHRcdFx0XHRcdH0sXG5cdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRbXG5cdFx0XHRcdFx0XHRtKFxuXHRcdFx0XHRcdFx0XHRcIi5iLnRleHQtZWxsaXBzaXNcIixcblx0XHRcdFx0XHRcdFx0e1xuXHRcdFx0XHRcdFx0XHRcdHRpdGxlOiBnZXRDYXBhYmlsaXR5VGV4dChkb3duY2FzdChpbnZpdGF0aW9uLmNhcGFiaWxpdHkpKSxcblx0XHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFx0aW52aXRhdGlvbi5zaGFyZWRHcm91cE5hbWUsXG5cdFx0XHRcdFx0XHQpLFxuXHRcdFx0XHRcdFx0bShcblx0XHRcdFx0XHRcdFx0XCIuc21hbGwudGV4dC1lbGxpcHNpc1wiLFxuXHRcdFx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRcdFx0dGl0bGU6IGludml0YXRpb24uaW52aXRlck1haWxBZGRyZXNzLFxuXHRcdFx0XHRcdFx0XHR9LFxuXHRcdFx0XHRcdFx0XHRnZXRNYWlsQWRkcmVzc0Rpc3BsYXlUZXh0KGludml0YXRpb24uaW52aXRlck5hbWUsIGludml0YXRpb24uaW52aXRlck1haWxBZGRyZXNzLCB0cnVlKSxcblx0XHRcdFx0XHRcdCksXG5cdFx0XHRcdFx0XSxcblx0XHRcdFx0KSxcblx0XHRcdFx0bShJY29uQnV0dG9uLCB7XG5cdFx0XHRcdFx0dGl0bGU6IFwic2hvd19hY3Rpb25cIixcblx0XHRcdFx0XHRjbGljazogKCkgPT4gc2hvd0dyb3VwSW52aXRhdGlvbkRpYWxvZyhpbnZpdGF0aW9uKSxcblx0XHRcdFx0XHRpY29uOiBpY29uID8/IEljb25zLkV5ZSxcblx0XHRcdFx0fSksXG5cdFx0XHRdKSxcblx0XHRdXG5cdH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUF1Qk8sU0FBUyww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