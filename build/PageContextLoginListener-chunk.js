import { arrayEquals, assertNotNull, defer } from "./dist2-chunk.js";

//#region src/common/api/main/PageContextLoginListener.ts
let LoginFailReason = function(LoginFailReason$1) {
	LoginFailReason$1[LoginFailReason$1["SessionExpired"] = 0] = "SessionExpired";
	LoginFailReason$1[LoginFailReason$1["Error"] = 1] = "Error";
	return LoginFailReason$1;
}({});
var PageContextLoginListener = class {
	loginPromise = defer();
	fullLoginFailed = false;
	constructor(secondFactorHandler, credentialsProvider) {
		this.secondFactorHandler = secondFactorHandler;
		this.credentialsProvider = credentialsProvider;
	}
	/** e.g. after temp logout */
	reset() {
		this.loginPromise = defer();
		this.fullLoginFailed = false;
	}
	waitForFullLogin() {
		return this.loginPromise.promise;
	}
	/**
	* Full login reached: any network requests can be made
	*/
	async onFullLoginSuccess(_sessionType, _cacheInfo, credentials) {
		this.fullLoginFailed = false;
		const persistedCredentials = (await this.credentialsProvider.getAllInternalCredentials()).find((a) => a.credentialInfo.userId === credentials.userId);
		if (persistedCredentials != null && this.isPassphraseKeyUpdatedNeeded(persistedCredentials, credentials)) await this.credentialsProvider.replacePassword(persistedCredentials.credentialInfo, assertNotNull(credentials.encryptedPassword), assertNotNull(credentials.encryptedPassphraseKey));
		this.loginPromise.resolve();
	}
	/**
	* It is possible that a KDF migration was executed by a different client. This would change the passphrase key, so we need to check if we have to update the stored one.
	* @private
	*/
	isPassphraseKeyUpdatedNeeded(persistedCredentials, credentials) {
		const persistedEncryptedPassphraseKey = persistedCredentials.encryptedPassphraseKey;
		const credentialsEncryptedPassphraseKey = credentials.encryptedPassphraseKey;
		if (persistedCredentials.encryptedPassword != credentials.encryptedPassword) return false;
		if (persistedEncryptedPassphraseKey != null && credentialsEncryptedPassphraseKey != null) return !arrayEquals(persistedEncryptedPassphraseKey, credentialsEncryptedPassphraseKey);
else if (persistedEncryptedPassphraseKey == null && credentialsEncryptedPassphraseKey == null) return false;
else return true;
	}
	/**
	* call when the login fails for invalid session or other reasons
	*/
	async onLoginFailure(reason) {
		this.fullLoginFailed = true;
		if (reason === LoginFailReason.SessionExpired) {
			const { reloginForExpiredSession } = await import("./ErrorHandlerImpl2-chunk.js");
			await reloginForExpiredSession();
		}
	}
	/**
	* call when retrying full login
	*/
	onRetryLogin() {
		this.fullLoginFailed = false;
	}
	/**
	* Shows a dialog with possibility to use second factor and with a message that the login can be approved from another client.
	*/
	onSecondFactorChallenge(sessionId, challenges, mailAddress) {
		return this.secondFactorHandler.showSecondFactorAuthenticationDialog(sessionId, challenges, mailAddress);
	}
	/**
	* true if the last full login attempt failed
	* may revert to false when retrying.
	*/
	getFullLoginFailed() {
		return this.fullLoginFailed;
	}
};

//#endregion
export { LoginFailReason, PageContextLoginListener };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFnZUNvbnRleHRMb2dpbkxpc3RlbmVyLWNodW5rLmpzIiwibmFtZXMiOlsic2Vjb25kRmFjdG9ySGFuZGxlcjogU2Vjb25kRmFjdG9ySGFuZGxlciIsImNyZWRlbnRpYWxzUHJvdmlkZXI6IENyZWRlbnRpYWxzUHJvdmlkZXIiLCJfc2Vzc2lvblR5cGU6IFNlc3Npb25UeXBlIiwiX2NhY2hlSW5mbzogQ2FjaGVJbmZvIiwiY3JlZGVudGlhbHM6IENyZWRlbnRpYWxzIiwicGVyc2lzdGVkQ3JlZGVudGlhbHM6IFBlcnNpc3RlZENyZWRlbnRpYWxzIiwicmVhc29uOiBMb2dpbkZhaWxSZWFzb24iLCJzZXNzaW9uSWQ6IElkVHVwbGUiLCJjaGFsbGVuZ2VzOiBSZWFkb25seUFycmF5PENoYWxsZW5nZT4iLCJtYWlsQWRkcmVzczogc3RyaW5nIHwgbnVsbCJdLCJzb3VyY2VzIjpbIi4uL3NyYy9jb21tb24vYXBpL21haW4vUGFnZUNvbnRleHRMb2dpbkxpc3RlbmVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFNlY29uZEZhY3RvckhhbmRsZXIgfSBmcm9tIFwiLi4vLi4vbWlzYy8yZmEvU2Vjb25kRmFjdG9ySGFuZGxlci5qc1wiXG5pbXBvcnQgeyBhcnJheUVxdWFscywgYXNzZXJ0Tm90TnVsbCwgZGVmZXIsIERlZmVycmVkT2JqZWN0IH0gZnJvbSBcIkB0dXRhby90dXRhbm90YS11dGlsc1wiXG5pbXBvcnQgeyBDaGFsbGVuZ2UgfSBmcm9tIFwiLi4vZW50aXRpZXMvc3lzL1R5cGVSZWZzLmpzXCJcbmltcG9ydCB7IENhY2hlSW5mbywgTG9naW5MaXN0ZW5lciB9IGZyb20gXCIuLi93b3JrZXIvZmFjYWRlcy9Mb2dpbkZhY2FkZS5qc1wiXG5pbXBvcnQgeyBTZXNzaW9uVHlwZSB9IGZyb20gXCIuLi9jb21tb24vU2Vzc2lvblR5cGUuanNcIlxuaW1wb3J0IHsgQ3JlZGVudGlhbHNQcm92aWRlciB9IGZyb20gXCIuLi8uLi9taXNjL2NyZWRlbnRpYWxzL0NyZWRlbnRpYWxzUHJvdmlkZXIuanNcIlxuaW1wb3J0IHsgQ3JlZGVudGlhbHMgfSBmcm9tIFwiLi4vLi4vbWlzYy9jcmVkZW50aWFscy9DcmVkZW50aWFscy5qc1wiXG5pbXBvcnQgeyBQZXJzaXN0ZWRDcmVkZW50aWFscyB9IGZyb20gXCIuLi8uLi9uYXRpdmUvY29tbW9uL2dlbmVyYXRlZGlwYy9QZXJzaXN0ZWRDcmVkZW50aWFscy5qc1wiXG5cbmV4cG9ydCBjb25zdCBlbnVtIExvZ2luRmFpbFJlYXNvbiB7XG5cdFNlc3Npb25FeHBpcmVkLFxuXHRFcnJvcixcbn1cblxuLyoqIExpc3RlbmVyIGZvciB0aGUgbG9naW4gZXZlbnRzIGZyb20gdGhlIHdvcmtlciBzaWRlLiAqL1xuZXhwb3J0IGNsYXNzIFBhZ2VDb250ZXh0TG9naW5MaXN0ZW5lciBpbXBsZW1lbnRzIExvZ2luTGlzdGVuZXIge1xuXHRwcml2YXRlIGxvZ2luUHJvbWlzZTogRGVmZXJyZWRPYmplY3Q8dm9pZD4gPSBkZWZlcigpXG5cdHByaXZhdGUgZnVsbExvZ2luRmFpbGVkOiBib29sZWFuID0gZmFsc2VcblxuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHNlY29uZEZhY3RvckhhbmRsZXI6IFNlY29uZEZhY3RvckhhbmRsZXIsIHByaXZhdGUgcmVhZG9ubHkgY3JlZGVudGlhbHNQcm92aWRlcjogQ3JlZGVudGlhbHNQcm92aWRlcikge31cblxuXHQvKiogZS5nLiBhZnRlciB0ZW1wIGxvZ291dCAqL1xuXHRyZXNldCgpIHtcblx0XHR0aGlzLmxvZ2luUHJvbWlzZSA9IGRlZmVyKClcblx0XHR0aGlzLmZ1bGxMb2dpbkZhaWxlZCA9IGZhbHNlXG5cdH1cblxuXHR3YWl0Rm9yRnVsbExvZ2luKCk6IFByb21pc2U8dm9pZD4ge1xuXHRcdHJldHVybiB0aGlzLmxvZ2luUHJvbWlzZS5wcm9taXNlXG5cdH1cblxuXHQvKipcblx0ICogRnVsbCBsb2dpbiByZWFjaGVkOiBhbnkgbmV0d29yayByZXF1ZXN0cyBjYW4gYmUgbWFkZVxuXHQgKi9cblx0YXN5bmMgb25GdWxsTG9naW5TdWNjZXNzKF9zZXNzaW9uVHlwZTogU2Vzc2lvblR5cGUsIF9jYWNoZUluZm86IENhY2hlSW5mbywgY3JlZGVudGlhbHM6IENyZWRlbnRpYWxzKTogUHJvbWlzZTx2b2lkPiB7XG5cdFx0dGhpcy5mdWxsTG9naW5GYWlsZWQgPSBmYWxzZVxuXG5cdFx0Ly8gVXBkYXRlIHRoZSBjcmVkZW50aWFscyBhZnRlciB0aGUgZnVsbCBsb2dpbi5cblx0XHQvLyBJdCBpcyBuZWVkZWQgYmVjYXVzZSB3ZSBhZGRlZCBlbmNyeXB0ZWRQYXNzcGhyYXNlS2V5IHRvIGNyZWRlbnRpYWxzIHdoaWNoIGlzIG9ubHlcblx0XHQvLyBhdmFpbGFibGUgYWZ0ZXIgdGhlIGZ1bGwgbG9naW4gd2hpY2ggaGFwcGVucyBhc3luYy5cblxuXHRcdC8vIEZpcnN0IGZldGNoIGVuY3J5cHRlZCBjcmVkZW50aWFscyBmb3IgdGhlIHVzZXIgdG8gZmlndXJlIG91dCBpZiB0aGUgY3JlZGVudGlhbHMgYXJlIHN0b3JlZCBidXQgYXJlIGFsc28gbWlzc2luZ1xuXHRcdC8vIGEgcGFzc3BocmFzZSBrZXksIGFuZCB0aGVuIHVwZGF0ZSBpZiBzby5cblxuXHRcdGNvbnN0IHBlcnNpc3RlZENyZWRlbnRpYWxzID0gKGF3YWl0IHRoaXMuY3JlZGVudGlhbHNQcm92aWRlci5nZXRBbGxJbnRlcm5hbENyZWRlbnRpYWxzKCkpLmZpbmQoKGEpID0+IGEuY3JlZGVudGlhbEluZm8udXNlcklkID09PSBjcmVkZW50aWFscy51c2VySWQpXG5cdFx0aWYgKHBlcnNpc3RlZENyZWRlbnRpYWxzICE9IG51bGwgJiYgdGhpcy5pc1Bhc3NwaHJhc2VLZXlVcGRhdGVkTmVlZGVkKHBlcnNpc3RlZENyZWRlbnRpYWxzLCBjcmVkZW50aWFscykpIHtcblx0XHRcdGF3YWl0IHRoaXMuY3JlZGVudGlhbHNQcm92aWRlci5yZXBsYWNlUGFzc3dvcmQoXG5cdFx0XHRcdHBlcnNpc3RlZENyZWRlbnRpYWxzLmNyZWRlbnRpYWxJbmZvLFxuXHRcdFx0XHRhc3NlcnROb3ROdWxsKGNyZWRlbnRpYWxzLmVuY3J5cHRlZFBhc3N3b3JkKSxcblx0XHRcdFx0YXNzZXJ0Tm90TnVsbChjcmVkZW50aWFscy5lbmNyeXB0ZWRQYXNzcGhyYXNlS2V5KSxcblx0XHRcdClcblx0XHR9XG5cblx0XHR0aGlzLmxvZ2luUHJvbWlzZS5yZXNvbHZlKClcblx0fVxuXG5cdC8qKlxuXHQgKiBJdCBpcyBwb3NzaWJsZSB0aGF0IGEgS0RGIG1pZ3JhdGlvbiB3YXMgZXhlY3V0ZWQgYnkgYSBkaWZmZXJlbnQgY2xpZW50LiBUaGlzIHdvdWxkIGNoYW5nZSB0aGUgcGFzc3BocmFzZSBrZXksIHNvIHdlIG5lZWQgdG8gY2hlY2sgaWYgd2UgaGF2ZSB0byB1cGRhdGUgdGhlIHN0b3JlZCBvbmUuXG5cdCAqIEBwcml2YXRlXG5cdCAqL1xuXHRwcml2YXRlIGlzUGFzc3BocmFzZUtleVVwZGF0ZWROZWVkZWQocGVyc2lzdGVkQ3JlZGVudGlhbHM6IFBlcnNpc3RlZENyZWRlbnRpYWxzLCBjcmVkZW50aWFsczogQ3JlZGVudGlhbHMpIHtcblx0XHRjb25zdCBwZXJzaXN0ZWRFbmNyeXB0ZWRQYXNzcGhyYXNlS2V5ID0gcGVyc2lzdGVkQ3JlZGVudGlhbHMuZW5jcnlwdGVkUGFzc3BocmFzZUtleVxuXHRcdGNvbnN0IGNyZWRlbnRpYWxzRW5jcnlwdGVkUGFzc3BocmFzZUtleSA9IGNyZWRlbnRpYWxzLmVuY3J5cHRlZFBhc3NwaHJhc2VLZXlcblx0XHRpZiAocGVyc2lzdGVkQ3JlZGVudGlhbHMuZW5jcnlwdGVkUGFzc3dvcmQgIT0gY3JlZGVudGlhbHMuZW5jcnlwdGVkUGFzc3dvcmQpIHtcblx0XHRcdC8vIHdlIG9ubHkgd2FudCB0byB1cGRhdGUgdGhlIGVuY3J5cHRlZCBwYXNzd29yZEtleSBpZiB3ZSBjaGFuZ2VkIHRoZSBrZGYgZnVuY3Rpb24uXG5cdFx0XHQvLyBJbiB0aGlzIGNhc2Ugd2UgaGF2ZSB0aGUgc2FtZSBlbmRyeXB0ZWRQYXNzd29yZCBidXQgYSBkaWZmZXJlbnQgcGFzc3dvcmQga2V5LlxuXHRcdFx0cmV0dXJuIGZhbHNlXG5cdFx0fVxuXHRcdGlmIChwZXJzaXN0ZWRFbmNyeXB0ZWRQYXNzcGhyYXNlS2V5ICE9IG51bGwgJiYgY3JlZGVudGlhbHNFbmNyeXB0ZWRQYXNzcGhyYXNlS2V5ICE9IG51bGwpIHtcblx0XHRcdHJldHVybiAhYXJyYXlFcXVhbHMocGVyc2lzdGVkRW5jcnlwdGVkUGFzc3BocmFzZUtleSwgY3JlZGVudGlhbHNFbmNyeXB0ZWRQYXNzcGhyYXNlS2V5KVxuXHRcdH0gZWxzZSBpZiAocGVyc2lzdGVkRW5jcnlwdGVkUGFzc3BocmFzZUtleSA9PSBudWxsICYmIGNyZWRlbnRpYWxzRW5jcnlwdGVkUGFzc3BocmFzZUtleSA9PSBudWxsKSB7XG5cdFx0XHQvLyBib3RoIGFyZSBudWxsIHNvIG5vdGhpbmcgaGFzIGNoYW5nZWQuXG5cdFx0XHRyZXR1cm4gZmFsc2Vcblx0XHR9IGVsc2Uge1xuXHRcdFx0Ly8gb25lIGlzIG51bGwgYW5kIHRoZSBvdGhlciBpcyBub3Rcblx0XHRcdHJldHVybiB0cnVlXG5cdFx0fVxuXHR9XG5cblx0LyoqXG5cdCAqIGNhbGwgd2hlbiB0aGUgbG9naW4gZmFpbHMgZm9yIGludmFsaWQgc2Vzc2lvbiBvciBvdGhlciByZWFzb25zXG5cdCAqL1xuXHRhc3luYyBvbkxvZ2luRmFpbHVyZShyZWFzb246IExvZ2luRmFpbFJlYXNvbik6IFByb21pc2U8dm9pZD4ge1xuXHRcdHRoaXMuZnVsbExvZ2luRmFpbGVkID0gdHJ1ZVxuXHRcdGlmIChyZWFzb24gPT09IExvZ2luRmFpbFJlYXNvbi5TZXNzaW9uRXhwaXJlZCkge1xuXHRcdFx0Y29uc3QgeyByZWxvZ2luRm9yRXhwaXJlZFNlc3Npb24gfSA9IGF3YWl0IGltcG9ydChcIi4uLy4uL21pc2MvRXJyb3JIYW5kbGVySW1wbC5qc1wiKVxuXHRcdFx0YXdhaXQgcmVsb2dpbkZvckV4cGlyZWRTZXNzaW9uKClcblx0XHR9XG5cdH1cblxuXHQvKipcblx0ICogY2FsbCB3aGVuIHJldHJ5aW5nIGZ1bGwgbG9naW5cblx0ICovXG5cdG9uUmV0cnlMb2dpbigpOiB2b2lkIHtcblx0XHR0aGlzLmZ1bGxMb2dpbkZhaWxlZCA9IGZhbHNlXG5cdH1cblxuXHQvKipcblx0ICogU2hvd3MgYSBkaWFsb2cgd2l0aCBwb3NzaWJpbGl0eSB0byB1c2Ugc2Vjb25kIGZhY3RvciBhbmQgd2l0aCBhIG1lc3NhZ2UgdGhhdCB0aGUgbG9naW4gY2FuIGJlIGFwcHJvdmVkIGZyb20gYW5vdGhlciBjbGllbnQuXG5cdCAqL1xuXHRvblNlY29uZEZhY3RvckNoYWxsZW5nZShzZXNzaW9uSWQ6IElkVHVwbGUsIGNoYWxsZW5nZXM6IFJlYWRvbmx5QXJyYXk8Q2hhbGxlbmdlPiwgbWFpbEFkZHJlc3M6IHN0cmluZyB8IG51bGwpOiBQcm9taXNlPHZvaWQ+IHtcblx0XHRyZXR1cm4gdGhpcy5zZWNvbmRGYWN0b3JIYW5kbGVyLnNob3dTZWNvbmRGYWN0b3JBdXRoZW50aWNhdGlvbkRpYWxvZyhzZXNzaW9uSWQsIGNoYWxsZW5nZXMsIG1haWxBZGRyZXNzKVxuXHR9XG5cblx0LyoqXG5cdCAqIHRydWUgaWYgdGhlIGxhc3QgZnVsbCBsb2dpbiBhdHRlbXB0IGZhaWxlZFxuXHQgKiBtYXkgcmV2ZXJ0IHRvIGZhbHNlIHdoZW4gcmV0cnlpbmcuXG5cdCAqL1xuXHRnZXRGdWxsTG9naW5GYWlsZWQoKTogYm9vbGVhbiB7XG5cdFx0cmV0dXJuIHRoaXMuZnVsbExvZ2luRmFpbGVkXG5cdH1cbn1cbiJdLCJtYXBwaW5ncyI6Ijs7O0lBU2tCLDhDQUFYO0FBQ047QUFDQTs7QUFDQTtJQUdZLDJCQUFOLE1BQXdEO0NBQzlELEFBQVEsZUFBcUMsT0FBTztDQUNwRCxBQUFRLGtCQUEyQjtDQUVuQyxZQUE2QkEscUJBQTJEQyxxQkFBMEM7RUE2RmxJLEtBN0Y2QjtFQTZGNUIsS0E3RnVGO0NBQTRDOztDQUdwSSxRQUFRO0FBQ1AsT0FBSyxlQUFlLE9BQU87QUFDM0IsT0FBSyxrQkFBa0I7Q0FDdkI7Q0FFRCxtQkFBa0M7QUFDakMsU0FBTyxLQUFLLGFBQWE7Q0FDekI7Ozs7Q0FLRCxNQUFNLG1CQUFtQkMsY0FBMkJDLFlBQXVCQyxhQUF5QztBQUNuSCxPQUFLLGtCQUFrQjtFQVN2QixNQUFNLHVCQUF1QixDQUFDLE1BQU0sS0FBSyxvQkFBb0IsMkJBQTJCLEVBQUUsS0FBSyxDQUFDLE1BQU0sRUFBRSxlQUFlLFdBQVcsWUFBWSxPQUFPO0FBQ3JKLE1BQUksd0JBQXdCLFFBQVEsS0FBSyw2QkFBNkIsc0JBQXNCLFlBQVksQ0FDdkcsT0FBTSxLQUFLLG9CQUFvQixnQkFDOUIscUJBQXFCLGdCQUNyQixjQUFjLFlBQVksa0JBQWtCLEVBQzVDLGNBQWMsWUFBWSx1QkFBdUIsQ0FDakQ7QUFHRixPQUFLLGFBQWEsU0FBUztDQUMzQjs7Ozs7Q0FNRCxBQUFRLDZCQUE2QkMsc0JBQTRDRCxhQUEwQjtFQUMxRyxNQUFNLGtDQUFrQyxxQkFBcUI7RUFDN0QsTUFBTSxvQ0FBb0MsWUFBWTtBQUN0RCxNQUFJLHFCQUFxQixxQkFBcUIsWUFBWSxrQkFHekQsUUFBTztBQUVSLE1BQUksbUNBQW1DLFFBQVEscUNBQXFDLEtBQ25GLFNBQVEsWUFBWSxpQ0FBaUMsa0NBQWtDO1NBQzdFLG1DQUFtQyxRQUFRLHFDQUFxQyxLQUUxRixRQUFPO0lBR1AsUUFBTztDQUVSOzs7O0NBS0QsTUFBTSxlQUFlRSxRQUF3QztBQUM1RCxPQUFLLGtCQUFrQjtBQUN2QixNQUFJLFdBQVcsZ0JBQWdCLGdCQUFnQjtHQUM5QyxNQUFNLEVBQUUsMEJBQTBCLEdBQUcsTUFBTSxPQUFPO0FBQ2xELFNBQU0sMEJBQTBCO0VBQ2hDO0NBQ0Q7Ozs7Q0FLRCxlQUFxQjtBQUNwQixPQUFLLGtCQUFrQjtDQUN2Qjs7OztDQUtELHdCQUF3QkMsV0FBb0JDLFlBQXNDQyxhQUEyQztBQUM1SCxTQUFPLEtBQUssb0JBQW9CLHFDQUFxQyxXQUFXLFlBQVksWUFBWTtDQUN4Rzs7Ozs7Q0FNRCxxQkFBOEI7QUFDN0IsU0FBTyxLQUFLO0NBQ1o7QUFDRCJ9