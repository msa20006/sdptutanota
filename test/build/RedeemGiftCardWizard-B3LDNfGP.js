
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { mithril_default } from "./mithril-Csg4iNnm.js";
import { mapNullable, neverNull, noOp, ofClass } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import "./Env-D5xGlXfw.js";
import "./WhitelabelCustomizations-D1L5qbZi.js";
import { lang } from "./LanguageViewModel-BNC5ekpO.js";
import "./HtmlUtils-C-ecR7U7.js";
import "./ClientDetector-D0v6Vqu6.js";
import { PaymentMethodType, PlanType } from "./TutanotaConstants-3bwAESYA.js";
import "./Icon-BuqNK7vz.js";
import { HabReminderImage } from "./Icons-Dl3nFav5.js";
import "./KeyManager-B0OGXEyJ.js";
import "./WindowFacade-B9kSBKw7.js";
import "./Modal-g4c-b9IU.js";
import { Dialog, DialogType, TextField, renderCountryDropdown } from "./Dialog-B6-HFvZd.js";
import { getByAbbreviation } from "./CountryList-DkVQtcTj.js";
import "./IconButton-DsU60HJ_.js";
import { NotAuthorizedError, NotFoundError } from "./RestError-D17JEBMr.js";
import "./SuspensionError-okvIjE4H.js";
import "./LoginIncompleteError-CpiW0a0l.js";
import "./CryptoError-PqdvQky4.js";
import "./error-DDmy0eAT.js";
import "./ErrorUtils-o1-v67Dd.js";
import "./RecipientsNotFoundError-D8oGE7A_.js";
import "./OfflineDbClosedError-CAwHTI6J.js";
import "./OutOfSyncError-Ck2yBBO8.js";
import "./DbError-CcwZaPG2.js";
import "./QuotaExceededError-nFM6SdTn.js";
import { CancelledError } from "./CancelledError-FjP5S_cR.js";
import "./FileOpenError-C1_8yoXr.js";
import "./DeviceStorageUnavailableError-m4Jk_0xN.js";
import "./MailBodyTooLargeError-C2i0rX_0.js";
import "./ImportError-CIXw37Kv.js";
import "./PermissionError-BGDsHuAh.js";
import "./KeyPermanentlyInvalidatedError-DJjt81rl.js";
import "./ParserCombinator-D38ofgFx.js";
import "./ExportError-DzgStBnl.js";
import { require_stream } from "./stream-u2PttBAC.js";
import "./luxon-D6cgmg6Q.js";
import { elementIdPart, isSameId } from "./EntityUtils-RQxXZlcV.js";
import "./CommonCalendarUtils-DKaO7v1K.js";
import "./Formatter-zB15D6XI.js";
import "./TypeModels-XIXYys8J.js";
import "./TypeRefs-CR3TLWn0.js";
import "./TypeModels-BktRFNDN.js";
import { AccountingInfoTypeRef, CustomerInfoTypeRef } from "./TypeRefs-BP1jvX9p.js";
import "./CalendarUtils-C6jeYrj9.js";
import "./ProgressMonitor-HBfOF56H.js";
import "./Notifications-DLibQbV7.js";
import "./EntityFunctions-l6CncM5C.js";
import "./TypeModels-ZqCk-pGw.js";
import "./ModelInfo-DEa-Yxv2.js";
import "./EntityClient-B0RSdk2i.js";
import "./SetupMultipleError-B6uY8P-x.js";
import "./Services-CZFE0084.js";
import "./Services-DCx-CeM7.js";
import "./EntityUpdateUtils-B5iTKMk4.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import "./ImportExportUtils-B1MoOmZ0.js";
import "./FormatValidator-2BBermUe.js";
import { UserError } from "./UserError-DfXlMLTl.js";
import "./MailAddressParser-BgYy6oyp.js";
import "./GroupUtils-0ZkLIAeC.js";
import "./DataFile-CY7uuk9j.js";
import "./FileUtils-W-u2-gZz.js";
import { showProgressDialog } from "./ProgressDialog-CJfJjh62.js";
import "./BlobUtils-D5ADcckZ.js";
import "./SharedMailUtils-AmFaSJP6.js";
import "./PasswordUtils-C4jlV9GF.js";
import "./Recipient-BFxhfecW.js";
import "./BirthdayUtils-BcCMglSq.js";
import "./ContactUtils-Bbon2oOk.js";
import "./SubscriptionDialogs-DAlWs68I.js";
import "./ExternalLink-rsCBSC7U.js";
import "./ToggleButton-DxuDa0rS.js";
import "./ErrorHandler-DbW1lJbv.js";
import "./SnackBar-CoP3lSVs.js";
import "./Credentials-BM35X_na.js";
import "./NotificationOverlay-C-YNCUiT.js";
import "./Checkbox-WCw-l_7A.js";
import "./Expander-Bautb1_0.js";
import "./ClipboardUtils-mz40UK5S.js";
import "./ErrorReporter-7sfLhWZg.js";
import "./Services-CupYet_j.js";
import "./BubbleButton-DGGInJMg.js";
import { SessionType } from "./SessionType-rxSDsswH.js";
import "./PasswordField-CPKPoLq8.js";
import "./PasswordRequestDialog-B7ZIVTVw.js";
import { showUserError } from "./ErrorHandlerImpl-DRpk8tE9.js";
import "./DeviceConfig-payZM407.js";
import "./InAppRatingUtils-DwsFPPTC.js";
import "./InAppRatingDialog-Cp5yqAc1.js";
import "./CustomerUtils-DmaZpb7Y.js";
import "./EventQueue-c-5UmjJa.js";
import "./EntityRestClient--6dT7ZRF.js";
import "./MessageDispatcher-wJwFhXWv.js";
import "./SqlValue-CkGu32Qd.js";
import "./Sql-C9YhYNym.js";
import "./RestClient-CmoHrId4.js";
import "./CommonFormatter-DiwVeRKZ.js";
import "./HtmlEditor-DkqWVGt0.js";
import "./HtmlSanitizer-CA1YjlPp.js";
import { CredentialsSelector, LoginForm, getLoginErrorMessage, handleExpectedLoginError } from "./LoginViewModel-BX-8ry63.js";
import { LoginButton } from "./LoginButton-DzCRy0Yt.js";
import "./UsageTestModel-CjGx3RZo.js";
import "./PasswordForm-f7LrLbA9.js";
import "./MoreInfoLink-CySwGi3Q.js";
import "./CommonMailUtils-DNufl6ib.js";
import "./PermissionType-Bwii3hCe.js";
import "./RouteChange-im6yOAT2.js";
import { WizardEventType, createWizardDialog, emitWizardEvent, wizardPageWrapper } from "./WizardDialog-DYBfLN1U.js";
import "./SearchUtils-Cu31OiTT.js";
import "./SegmentControl-DpoAc28w.js";
import "./SubscriptionUtils-D0qLWHbE.js";
import { RecoverCodeField } from "./RecoverCodeDialog-nRHUDXK5.js";
import "./MailAddressesUtils-yYLKhrr9.js";
import "./InfoIcon-BCwidYvN.js";
import "./Table-CTZm031N.js";
import { PaymentInterval, PriceAndConfigProvider, UpgradePriceType, formatPrice, getPaymentMethodName } from "./PriceUtils-DA-dFW8L.js";
import { getTokenFromUrl, renderAcceptGiftCardTermsCheckbox, renderGiftCardSvg } from "./PurchaseGiftCardDialog-B0R5zMg4.js";
import { SignupForm } from "./SwitchSubscriptionDialog-Rk9U8Iqn.js";
import "./MessageBox-C_T1dO_P.js";
import "./Captcha-BgtCMZz1.js";
import "./mailLocator-CrvEYt1k.js";
import "./PageContextLoginListener-dgY8O-YX.js";
import "./Scheduler-B2H65_EO.js";
import "./MailUtils-ChhZAFAd.js";
import "./FolderSystem-DLrUB8MO.js";
import "./MailChecks-PhVUoR7f.js";
import "./qrcode-C0eFPi61.js";

//#region ../src/common/subscription/giftcards/RedeemGiftCardWizard.ts
var import_stream = __toESM(require_stream(), 1);
var GetCredentialsMethod = function(GetCredentialsMethod$1) {
	GetCredentialsMethod$1[GetCredentialsMethod$1["Login"] = 0] = "Login";
	GetCredentialsMethod$1[GetCredentialsMethod$1["Signup"] = 1] = "Signup";
	return GetCredentialsMethod$1;
}(GetCredentialsMethod || {});
var RedeemGiftCardModel = class {
	mailAddress = "";
	newAccountData = null;
	credentialsMethod = GetCredentialsMethod.Signup;
	accountingInfo = null;
	constructor(config, giftCardFacade, credentialsProvider, secondFactorHandler, logins, entityClient) {
		this.config = config;
		this.giftCardFacade = giftCardFacade;
		this.credentialsProvider = credentialsProvider;
		this.secondFactorHandler = secondFactorHandler;
		this.logins = logins;
		this.entityClient = entityClient;
	}
	get giftCardInfo() {
		return this.config.giftCardInfo;
	}
	get giftCardId() {
		return elementIdPart(this.giftCardInfo.giftCard);
	}
	get key() {
		return this.config.key;
	}
	get premiumPrice() {
		return this.config.premiumPrice;
	}
	get message() {
		return this.config.giftCardInfo.message;
	}
	get paymentMethod() {
		return this.accountingInfo?.paymentMethod ?? PaymentMethodType.AccountBalance;
	}
	get storedCredentials() {
		return this.config.storedCredentials;
	}
	async loginWithStoredCredentials(encryptedCredentials) {
		if (this.logins.isUserLoggedIn() && isSameId(this.logins.getUserController().user._id, encryptedCredentials.userId)) await this.postLogin();
else {
			await this.logins.logout(false);
			const credentials = await this.credentialsProvider.getDecryptedCredentialsByUserId(encryptedCredentials.userId);
			if (credentials) {
				await this.logins.resumeSession(credentials, null, null);
				await this.postLogin();
			}
		}
	}
	async loginWithFormCredentials(mailAddress, password) {
		this.mailAddress = mailAddress;
		await this.logins.logout(false);
		await this.logins.createSession(mailAddress, password, SessionType.Temporary);
		await this.postLogin();
	}
	async handleNewSignup(newAccountData) {
		if (newAccountData || this.newAccountData) {
			if (!this.newAccountData) this.newAccountData = newAccountData;
			const { mailAddress, password } = neverNull(newAccountData || this.newAccountData);
			this.mailAddress = mailAddress;
			await this.logins.createSession(mailAddress, password, SessionType.Temporary);
			await this.postLogin();
		}
	}
	async redeemGiftCard(country) {
		if (country == null) throw new UserError("invoiceCountryInfoBusiness_msg");
		return this.giftCardFacade.redeemGiftCard(this.giftCardId, this.key, country?.a ?? null).catch(ofClass(NotFoundError, () => {
			throw new UserError("invalidGiftCard_msg");
		})).catch(ofClass(NotAuthorizedError, (e) => {
			throw new UserError(lang.makeTranslation("error_msg", e.message));
		}));
	}
	async postLogin() {
		if (!this.logins.getUserController().isGlobalAdmin()) throw new UserError("onlyAccountAdminFeature_msg");
		await this.secondFactorHandler.closeWaitingForSecondFactorDialog();
		const customer = await this.logins.getUserController().loadCustomer();
		const customerInfo = await this.entityClient.load(CustomerInfoTypeRef, customer.customerInfo);
		this.accountingInfo = await this.entityClient.load(AccountingInfoTypeRef, customerInfo.accountingInfo);
		if (PaymentMethodType.AppStore === this.accountingInfo.paymentMethod) throw new UserError("redeemGiftCardWithAppStoreSubscription_msg");
		if (customer.businessUse) throw new UserError("onlyPrivateAccountFeature_msg");
	}
};
var GiftCardWelcomePage = class {
	dom;
	oncreate(vnodeDOM) {
		this.dom = vnodeDOM.dom;
	}
	view(vnode) {
		const a = vnode.attrs;
		const nextPage = (method) => {
			locator.logins.logout(false).then(() => {
				a.data.credentialsMethod = method;
				emitWizardEvent(this.dom, WizardEventType.SHOW_NEXT_PAGE);
			});
		};
		return [
			mithril_default(".flex-center.full-width.pt-l", mithril_default(".pt-l", { style: { width: "480px" } }, renderGiftCardSvg(parseFloat(a.data.giftCardInfo.value), null, a.data.message))),
			mithril_default(".flex-center.full-width.pt-l", mithril_default(LoginButton, {
				label: "existingAccount_label",
				class: "small-login-button",
				onclick: () => nextPage(GetCredentialsMethod.Login)
			})),
			mithril_default(".flex-center.full-width.pt-l.pb", mithril_default(LoginButton, {
				label: "register_label",
				class: "small-login-button",
				onclick: () => nextPage(GetCredentialsMethod.Signup)
			}))
		];
	}
};
var GiftCardCredentialsPage = class {
	domElement = null;
	loginFormHelpText = lang.get("emptyString_msg");
	mailAddress = (0, import_stream.default)("");
	password = (0, import_stream.default)("");
	oncreate(vnode) {
		this.domElement = vnode.dom;
	}
	view(vnode) {
		const data = vnode.attrs.data;
		switch (data.credentialsMethod) {
			case GetCredentialsMethod.Login: return this.renderLoginPage(data);
			case GetCredentialsMethod.Signup: return this.renderSignupPage(data);
		}
	}
	onremove() {
		this.password("");
	}
	renderLoginPage(model) {
		return [mithril_default(".flex-grow.flex-center.scroll", mithril_default(".flex-grow-shrink-auto.max-width-s.pt.plr-l", [this.renderLoginForm(model), this.renderCredentialsSelector(model)]))];
	}
	renderLoginForm(model) {
		return mithril_default(LoginForm, {
			onSubmit: async (mailAddress, password) => {
				if (mailAddress === "" || password === "") this.loginFormHelpText = lang.get("loginFailed_msg");
else try {
					await showProgressDialog("pleaseWait_msg", model.loginWithFormCredentials(this.mailAddress(), this.password()));
					emitWizardEvent(this.domElement, WizardEventType.SHOW_NEXT_PAGE);
				} catch (e) {
					if (e instanceof UserError) showUserError(e);
else this.loginFormHelpText = lang.getTranslationText(getLoginErrorMessage(e, false));
				}
			},
			mailAddress: this.mailAddress,
			password: this.password,
			helpText: this.loginFormHelpText
		});
	}
	renderCredentialsSelector(model) {
		if (model.storedCredentials.length === 0) return null;
		return mithril_default(CredentialsSelector, {
			credentials: model.storedCredentials,
			onCredentialsSelected: async (encryptedCredentials) => {
				try {
					await showProgressDialog("pleaseWait_msg", model.loginWithStoredCredentials(encryptedCredentials));
					emitWizardEvent(this.domElement, WizardEventType.SHOW_NEXT_PAGE);
				} catch (e) {
					if (e instanceof UserError) showUserError(e);
else {
						this.loginFormHelpText = lang.getTranslationText(getLoginErrorMessage(e, false));
						handleExpectedLoginError(e, noOp);
					}
				}
			}
		});
	}
	renderSignupPage(model) {
		return mithril_default(SignupForm, {
			onComplete: (newAccountData) => {
				showProgressDialog("pleaseWait_msg", model.handleNewSignup(newAccountData).then(() => {
					emitWizardEvent(this.domElement, WizardEventType.SHOW_NEXT_PAGE);
					mithril_default.redraw();
				}).catch((e) => {
					Dialog.message("giftCardLoginError_msg");
					mithril_default.route.set("/login", { noAutoLogin: true });
				}));
			},
			onChangePlan: () => {
				emitWizardEvent(this.domElement, WizardEventType.SHOW_PREVIOUS_PAGE);
			},
			readonly: model.newAccountData != null,
			prefilledMailAddress: model.newAccountData ? model.newAccountData.mailAddress : "",
			isBusinessUse: () => false,
			isPaidSubscription: () => true,
			campaign: () => null
		});
	}
};
var RedeemGiftCardPage = class {
	confirmed = false;
	showCountryDropdown;
	country;
	dom;
	constructor({ attrs }) {
		this.country = mapNullable(attrs.data.accountingInfo?.invoiceCountry, getByAbbreviation);
		this.showCountryDropdown = this.country == null;
	}
	oncreate(vnodeDOM) {
		this.dom = vnodeDOM.dom;
	}
	view(vnode) {
		const model = vnode.attrs.data;
		const isFree = locator.logins.getUserController().isFreeAccount();
		return mithril_default("", [
			mapNullable(model.newAccountData?.recoverCode, (code) => mithril_default(".pt-l.plr-l", mithril_default(RecoverCodeField, {
				showMessage: true,
				recoverCode: code
			}))),
			isFree ? this.renderInfoForFreeAccounts(model) : this.renderInfoForPaidAccounts(model),
			mithril_default(".flex-center.full-width.pt-l", mithril_default("", { style: { maxWidth: "620px" } }, [this.showCountryDropdown ? renderCountryDropdown({
				selectedCountry: this.country,
				onSelectionChanged: (country) => this.country = country,
				helpLabel: () => lang.get("invoiceCountryInfoConsumer_msg")
			}) : null, renderAcceptGiftCardTermsCheckbox(this.confirmed, (confirmed) => this.confirmed = confirmed)])),
			mithril_default(".flex-center.full-width.pt-s.pb", mithril_default(LoginButton, {
				label: "redeem_label",
				class: "small-login-button",
				onclick: () => {
					if (!this.confirmed) {
						Dialog.message("termsAcceptedNeutral_msg");
						return;
					}
					model.redeemGiftCard(this.country).then(() => emitWizardEvent(this.dom, WizardEventType.CLOSE_DIALOG)).catch(ofClass(UserError, showUserError)).catch(ofClass(CancelledError, noOp));
				}
			}))
		]);
	}
	getCreditOrDebitMessage(model) {
		const remainingAmount = Number(model.giftCardInfo.value) - model.premiumPrice;
		if (remainingAmount > 0) return `${lang.get("giftCardUpgradeNotifyCredit_msg", {
			"{price}": formatPrice(model.premiumPrice, true),
			"{amount}": formatPrice(remainingAmount, true)
		})} ${lang.get("creditUsageOptions_msg")}`;
else if (remainingAmount < 0) return lang.get("giftCardUpgradeNotifyDebit_msg", {
			"{price}": formatPrice(model.premiumPrice, true),
			"{amount}": formatPrice(remainingAmount * -1, true)
		});
else return "";
	}
	renderInfoForFreeAccounts(model) {
		return [
			mithril_default(".pt-l.plr-l", `${lang.get("giftCardUpgradeNotifyRevolutionary_msg")} ${this.getCreditOrDebitMessage(model)}`),
			mithril_default(".center.h4.pt", lang.get("upgradeConfirm_msg")),
			mithril_default(".flex-space-around.flex-wrap", [mithril_default(".flex-grow-shrink-half.plr-l", [
				mithril_default(TextField, {
					label: "subscription_label",
					value: "Revolutionary",
					isReadOnly: true
				}),
				mithril_default(TextField, {
					label: "paymentInterval_label",
					value: lang.get("pricing.yearly_label"),
					isReadOnly: true
				}),
				mithril_default(TextField, {
					label: "price_label",
					value: formatPrice(Number(model.premiumPrice), true) + " " + lang.get("pricing.perYear_label"),
					isReadOnly: true
				}),
				mithril_default(TextField, {
					label: "paymentMethod_label",
					value: getPaymentMethodName(model.paymentMethod),
					isReadOnly: true
				})
			]), mithril_default(".flex-grow-shrink-half.plr-l.flex-center.items-end", mithril_default("img[src=" + HabReminderImage + "].pt.bg-white.border-radius", { style: { width: "200px" } }))])
		];
	}
	renderInfoForPaidAccounts(model) {
		return [mithril_default(".pt-l.plr-l.flex-center", `${lang.get("giftCardCreditNotify_msg", { "{credit}": formatPrice(Number(model.giftCardInfo.value), true) })} ${lang.get("creditUsageOptions_msg")}`), mithril_default(".flex-grow-shrink-half.plr-l.flex-center.items-end", mithril_default("img[src=" + HabReminderImage + "].pt.bg-white.border-radius", { style: { width: "200px" } }))];
	}
};
async function loadRedeemGiftCardWizard(hashFromUrl) {
	const model = await loadModel(hashFromUrl);
	const wizardPages = [
		wizardPageWrapper(GiftCardWelcomePage, {
			data: model,
			headerTitle: () => "giftCard_label",
			nextAction: async () => true,
			isSkipAvailable: () => false,
			isEnabled: () => true
		}),
		wizardPageWrapper(GiftCardCredentialsPage, {
			data: model,
			headerTitle: () => model.credentialsMethod === GetCredentialsMethod.Signup ? "register_label" : "login_label",
			nextAction: async () => true,
			isSkipAvailable: () => false,
			isEnabled: () => true
		}),
		wizardPageWrapper(RedeemGiftCardPage, {
			data: model,
			headerTitle: () => "redeem_label",
			nextAction: async () => true,
			isSkipAvailable: () => false,
			isEnabled: () => true
		})
	];
	return createWizardDialog(model, wizardPages, async () => {
		const urlParams = model.mailAddress ? {
			loginWith: model.mailAddress,
			noAutoLogin: true
		} : {};
		mithril_default.route.set("/login", urlParams);
	}, DialogType.EditLarge).dialog;
}
async function loadModel(hashFromUrl) {
	const { id, key } = await getTokenFromUrl(hashFromUrl);
	const giftCardInfo = await locator.giftCardFacade.getGiftCardInfo(id, key);
	const storedCredentials = await locator.credentialsProvider.getInternalCredentialsInfos();
	const pricesDataProvider = await PriceAndConfigProvider.getInitializedInstance(null, locator.serviceExecutor, null);
	return new RedeemGiftCardModel({
		giftCardInfo,
		key,
		premiumPrice: pricesDataProvider.getSubscriptionPrice(PaymentInterval.Yearly, PlanType.Revolutionary, UpgradePriceType.PlanActualPrice),
		storedCredentials
	}, locator.giftCardFacade, locator.credentialsProvider, locator.secondFactorHandler, locator.logins, locator.entityClient);
}

//#endregion
export { loadRedeemGiftCardWizard };
//# sourceMappingURL=RedeemGiftCardWizard-B3LDNfGP.js.map