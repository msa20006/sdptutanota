
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { mithril_default } from "./mithril-Csg4iNnm.js";
import { LazyLoaded, assertNotNull, memoized, neverNull, ofClass } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import "./Env-D5xGlXfw.js";
import "./WhitelabelCustomizations-D1L5qbZi.js";
import { InfoLink, lang, languages } from "./LanguageViewModel-BNC5ekpO.js";
import "./HtmlUtils-C-ecR7U7.js";
import "./ClientDetector-D0v6Vqu6.js";
import { PlanType } from "./TutanotaConstants-3bwAESYA.js";
import "./Icon-BuqNK7vz.js";
import "./Icons-Dl3nFav5.js";
import "./KeyManager-B0OGXEyJ.js";
import "./WindowFacade-B9kSBKw7.js";
import "./Modal-g4c-b9IU.js";
import { Dialog, DialogType, DropDownSelector, TextField } from "./Dialog-B6-HFvZd.js";
import "./CountryList-DkVQtcTj.js";
import "./IconButton-DsU60HJ_.js";
import { PayloadTooLargeError } from "./RestError-D17JEBMr.js";
import "./SuspensionError-okvIjE4H.js";
import "./LoginIncompleteError-CpiW0a0l.js";
import "./CryptoError-PqdvQky4.js";
import "./error-DDmy0eAT.js";
import "./ErrorUtils-o1-v67Dd.js";
import "./RecipientsNotFoundError-D8oGE7A_.js";
import "./OfflineDbClosedError-CAwHTI6J.js";
import "./OutOfSyncError-Ck2yBBO8.js";
import "./DbError-CcwZaPG2.js";
import "./QuotaExceededError-nFM6SdTn.js";
import "./CancelledError-FjP5S_cR.js";
import "./FileOpenError-C1_8yoXr.js";
import "./DeviceStorageUnavailableError-m4Jk_0xN.js";
import "./MailBodyTooLargeError-C2i0rX_0.js";
import "./ImportError-CIXw37Kv.js";
import "./PermissionError-BGDsHuAh.js";
import "./KeyPermanentlyInvalidatedError-DJjt81rl.js";
import "./ParserCombinator-D38ofgFx.js";
import "./ExportError-DzgStBnl.js";
import { require_stream } from "./stream-u2PttBAC.js";
import { GENERATED_MAX_ID } from "./EntityUtils-RQxXZlcV.js";
import "./CommonCalendarUtils-DKaO7v1K.js";
import "./Formatter-zB15D6XI.js";
import "./TypeModels-XIXYys8J.js";
import "./TypeRefs-CR3TLWn0.js";
import "./TypeModels-BktRFNDN.js";
import { BookingTypeRef, CustomerInfoTypeRef, CustomerPropertiesTypeRef, createNotificationMailTemplate } from "./TypeRefs-BP1jvX9p.js";
import "./Services-CZFE0084.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import "./FormatValidator-2BBermUe.js";
import { UserError } from "./UserError-DfXlMLTl.js";
import "./MailAddressParser-BgYy6oyp.js";
import "./GroupUtils-0ZkLIAeC.js";
import "./DataFile-CY7uuk9j.js";
import "./FileUtils-W-u2-gZz.js";
import { showProgressDialog } from "./ProgressDialog-CJfJjh62.js";
import "./BlobUtils-D5ADcckZ.js";
import { insertInlineImageB64ClickHandler } from "./SharedMailUtils-AmFaSJP6.js";
import { showNotAvailableForFreeDialog, showPlanUpgradeRequiredDialog } from "./SubscriptionDialogs-DAlWs68I.js";
import "./ToggleButton-DxuDa0rS.js";
import { getWhitelabelDomainInfo } from "./CustomerUtils-DmaZpb7Y.js";
import { HtmlEditor } from "./HtmlEditor-DkqWVGt0.js";
import { htmlSanitizer } from "./HtmlSanitizer-CA1YjlPp.js";
import { SegmentControl } from "./SegmentControl-DpoAc28w.js";
import { getAvailablePlansWithWhitelabel, isWhitelabelActive } from "./SubscriptionUtils-D0qLWHbE.js";

//#region ../src/common/settings/EditNotificationEmailDialog.ts
var import_stream = __toESM(require_stream(), 1);
function showAddOrEditNotificationEmailDialog(userController, selectedNotificationLanguage) {
	let existingTemplate = undefined;
	userController.loadCustomer().then((customer) => {
		if (customer.properties) {
			const customerProperties = new LazyLoaded(() => locator.entityClient.load(CustomerPropertiesTypeRef, neverNull(customer.properties)));
			return customerProperties.getAsync().then((loadedCustomerProperties) => {
				if (selectedNotificationLanguage != null) existingTemplate = loadedCustomerProperties.notificationMailTemplates.find((template) => template.language === selectedNotificationLanguage);
			}).then(() => {
				return userController.loadCustomerInfo().then((customerInfo) => {
					return customerInfo.bookings ? locator.entityClient.loadRange(BookingTypeRef, customerInfo.bookings.items, GENERATED_MAX_ID, 1, true).then((bookings) => bookings.length === 1 ? bookings[0] : null) : null;
				}).then((lastBooking) => {
					showBuyOrSetNotificationEmailDialog(lastBooking, customerProperties, existingTemplate);
				});
			});
		}
	});
}
async function showBuyOrSetNotificationEmailDialog(lastBooking, customerProperties, existingTemplate) {
	if (locator.logins.getUserController().isFreeAccount()) showNotAvailableForFreeDialog([PlanType.Unlimited]);
else {
		const planConfiguration = await locator.logins.getUserController().getPlanConfig();
		let whitelabel = isWhitelabelActive(lastBooking, planConfiguration);
		if (!whitelabel) {
			const plansWithWhitelabel = await getAvailablePlansWithWhitelabel();
			whitelabel = await showPlanUpgradeRequiredDialog(plansWithWhitelabel);
		}
		if (whitelabel) show(existingTemplate ?? null, customerProperties);
	}
}
function show(existingTemplate, customerProperties) {
	let template;
	if (!existingTemplate) template = createNotificationMailTemplate({
		language: "en",
		body: getDefaultNotificationMail(),
		subject: lang.get("externalNotificationMailSubject_msg", { "{1}": "{sender}" })
	});
else template = existingTemplate;
	const editor = new HtmlEditor().setMinHeight(400).showBorders().setModeSwitcher("mailBody_label").setValue(template.body).enableToolbar().setToolbarOptions({ imageButtonClickHandler: insertInlineImageB64ClickHandler });
	const editSegment = {
		name: lang.get("edit_action"),
		value: "edit"
	};
	const previewSegment = {
		name: lang.get("preview_label"),
		value: "preview"
	};
	const selectedTab = (0, import_stream.default)(editSegment.value);
	const sortedLanguages = languages.slice().sort((a, b) => lang.get(a.textId).localeCompare(lang.get(b.textId))).map((language) => {
		return {
			name: lang.get(language.textId),
			value: language.code
		};
	});
	const selectedLanguage = assertNotNull(sortedLanguages.find(({ value }) => value === template.language));
	const selectedLanguageStream = (0, import_stream.default)(selectedLanguage.value);
	const subject = (0, import_stream.default)(template.subject);
	let savedHtml = editor.getValue();
	selectedTab.map((tab) => {
		if (tab === editSegment.value) editor.setValue(savedHtml);
else savedHtml = editor.getValue();
	});
	const editTabContent = () => [
		mithril_default(".small.mt-s", lang.get("templateHelp_msg")),
		existingTemplate ? mithril_default(TextField, {
			label: "notificationMailLanguage_label",
			isReadOnly: true,
			value: selectedLanguage.name
		}) : mithril_default(DropDownSelector, {
			label: "notificationMailLanguage_label",
			items: sortedLanguages,
			selectedValue: selectedLanguageStream(),
			selectionChangedHandler: selectedLanguageStream,
			dropdownWidth: 250
		}),
		mithril_default(TextField, {
			label: "subject_label",
			value: subject(),
			oninput: subject
		}),
		mithril_default(editor)
	];
	const senderName = locator.logins.getUserController().userGroupInfo.name;
	let senderDomain = "https://app.tuta.com";
	loadCustomerInfo().then((customerInfo) => {
		const whitelabelDomainInfo = customerInfo && getWhitelabelDomainInfo(customerInfo);
		senderDomain = "https://" + (whitelabelDomainInfo && whitelabelDomainInfo.domain || "app.tuta.com");
		mithril_default.redraw();
	});
	const sanitizePreview = memoized((html) => {
		return htmlSanitizer.sanitizeHTML(html).html;
	});
	const previewTabContent = () => [
		mithril_default(TextField, {
			label: "subject_label",
			value: subject().replace(/{sender}/g, senderName),
			isReadOnly: true
		}),
		mithril_default(".small.mt.mb", lang.get("mailBody_label")),
		mithril_default.trust(sanitizePreview(savedHtml.replace(/{sender}/g, senderName).replace(/{link}/g, senderDomain)))
	];
	Dialog.showActionDialog({
		type: DialogType.EditLarge,
		title: "edit_action",
		child: () => {
			return [mithril_default(SegmentControl, {
				items: [editSegment, previewSegment],
				selectedValue: selectedTab(),
				onValueSelected: selectedTab
			}), selectedTab() === editSegment.value ? editTabContent() : previewTabContent()];
		},
		okAction: (dialog) => {
			if (!editor.getValue().includes("{link}")) return Dialog.message(lang.getTranslation("templateMustContain_msg", { "{value}": "{link}" }));
			let templates;
			let isExistingTemplate;
			const oldLanguage = template.language;
			const oldSubject = template.subject;
			const oldBody = template.body;
			return showProgressDialog("pleaseWait_msg", customerProperties.getAsync().then((customerProperties$1) => {
				templates = customerProperties$1.notificationMailTemplates;
				if (customerProperties$1.notificationMailTemplates.some((t) => t !== existingTemplate && t.language === selectedLanguageStream())) throw new UserError("templateLanguageExists_msg");
				isExistingTemplate = templates.includes(template);
				if (!isExistingTemplate) customerProperties$1.notificationMailTemplates.push(template);
				template.subject = htmlSanitizer.sanitizeHTML(subject(), { blockExternalContent: false }).html;
				template.body = htmlSanitizer.sanitizeHTML(editor.getValue(), { blockExternalContent: false }).html;
				template.language = selectedLanguageStream();
				return locator.entityClient.update(customerProperties$1).then(() => dialog.close());
			})).catch(ofClass(UserError, (err) => {
				return Dialog.message(lang.makeTranslation("error_message", err.message));
			})).catch(ofClass(PayloadTooLargeError, () => {
				template.subject = oldSubject;
				template.body = oldBody;
				template.language = oldLanguage;
				if (!isExistingTemplate) templates.pop();
				return Dialog.message("notificationMailTemplateTooLarge_msg");
			}));
		}
	});
}
const HTML_PTAG_START = "<p>";
const HTML_PTAG_END = "</p>";
function getDefaultNotificationMail() {
	return HTML_PTAG_START + lang.get("externalNotificationMailBody1_msg") + HTML_PTAG_END + HTML_PTAG_START + lang.get("externalNotificationMailBody2_msg", { "{1}": InfoLink.HomePage }) + HTML_PTAG_END + HTML_PTAG_START + "<a href='{link}'>" + lang.get("externalNotificationMailBody3_msg") + "</a>" + HTML_PTAG_END + HTML_PTAG_START + lang.get("externalNotificationMailBody4_msg") + "<br>" + "{link}" + "<br>" + HTML_PTAG_END + HTML_PTAG_START + lang.get("externalNotificationMailBody5_msg") + HTML_PTAG_END + HTML_PTAG_START + lang.get("externalNotificationMailBody6_msg") + "<br>" + "{sender}" + HTML_PTAG_END;
}
function loadCustomerInfo() {
	return locator.logins.getUserController().loadCustomer().then((customer) => locator.entityClient.load(CustomerInfoTypeRef, customer.customerInfo));
}

//#endregion
export { showAddOrEditNotificationEmailDialog };
//# sourceMappingURL=EditNotificationEmailDialog-CWN6zOB8.js.map