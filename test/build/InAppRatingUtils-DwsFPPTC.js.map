{"version":3,"file":"InAppRatingUtils-DwsFPPTC.js","names":["deviceConfig: DeviceConfig","retentionPeriod: number","now: Date","date: Date","days: number","isIOSApp: boolean","lastRatingPromptedDate: Date | null","events: Date[]"],"sources":["../../src/common/ratings/InAppRatingUtils.ts"],"sourcesContent":["import { DeviceConfig } from \"../misc/DeviceConfig.js\"\nimport { DateTime } from \"luxon\"\nimport { locator } from \"../api/main/CommonLocator.js\"\n\nexport function createEvent(deviceConfig: DeviceConfig): void {\n\tconst retentionPeriod: number = 30\n\tlet events = deviceConfig.getEvents().filter((event) => isWithinLastNDays(new Date(), event, retentionPeriod))\n\tevents.push(new Date())\n\tdeviceConfig.writeEvents(events)\n}\n\nexport function isWithinLastNDays(now: Date, date: Date, days: number) {\n\treturn DateTime.fromJSDate(now).diff(DateTime.fromJSDate(date), \"days\").days < days\n}\n\nexport enum RatingCheckResult {\n\tRATING_ALLOWED,\n\tUNSUPPORTED_PLATFORM,\n\tLAST_RATING_TOO_YOUNG,\n\tAPP_INSTALLATION_TOO_YOUNG,\n\tACCOUNT_TOO_YOUNG,\n\tRATING_DISMISSED,\n}\n\n/**\n * Determines if we are allowed to ask the user for their rating.\n * It is possible that the user delayed his choice or if we already asked them within the past year.\n *\n * 1. The app must be running on an iOS device.\n * 2. The app installation date and customer creation date must both be at least 7 days in the past.\n * 3. The dialog must not have been shown within the last year (When the dialog is dismissed with the cancel button it is not considered being shown).\n * 4. The retry prompt timer (if set) must have expired.\n */\nexport async function getRatingAllowed(now: Date, deviceConfig: DeviceConfig, isIOSApp: boolean): Promise<RatingCheckResult> {\n\tif (!isIOSApp) {\n\t\treturn RatingCheckResult.UNSUPPORTED_PLATFORM\n\t}\n\n\tconst lastRatingPromptedDate: Date | null = deviceConfig.getLastRatingPromptedDate()\n\n\tif (lastRatingPromptedDate != null && DateTime.fromJSDate(now).diff(DateTime.fromJSDate(lastRatingPromptedDate), \"years\").years < 1) {\n\t\treturn RatingCheckResult.LAST_RATING_TOO_YOUNG\n\t}\n\n\tconst appInstallationDate = await locator.systemFacade.getInstallationDate().then((rawDate) => new Date(Number(rawDate)))\n\tif (isWithinLastNDays(now, appInstallationDate, 7)) {\n\t\treturn RatingCheckResult.APP_INSTALLATION_TOO_YOUNG\n\t}\n\n\tconst customerCreationDate = (await locator.logins.getUserController().loadCustomerInfo()).creationTime\n\tif (isWithinLastNDays(now, customerCreationDate, 7)) {\n\t\treturn RatingCheckResult.ACCOUNT_TOO_YOUNG\n\t}\n\n\tconst retryRatingPromptAfter = deviceConfig.getRetryRatingPromptAfter()\n\tif (retryRatingPromptAfter != null && now.getTime() < retryRatingPromptAfter.getTime()) {\n\t\treturn RatingCheckResult.RATING_DISMISSED\n\t}\n\n\treturn RatingCheckResult.RATING_ALLOWED\n}\n\n/**\n * Determines if the user is experiencing a \"happy moment\".\n *\n * At least one of the following activity-based conditions must be satisfied:\n *    - The user has created at least 3 events/emails, and no previous prompt was shown.\n *    - The user has performed at least 10 activities (events/emails) in the last 28 days.\n *\n * @returns {boolean} A promise that resolves to `true` if the user is in a \"happy moment\".\n */\nexport function isEventHappyMoment(now: Date, deviceConfig: DeviceConfig): boolean {\n\t//region Trigger 1: Check for minimum 3 events/emails created\n\tconst lastRatingPromptedDate: Date | null = deviceConfig.getLastRatingPromptedDate()\n\n\tconst events: Date[] = deviceConfig.getEvents()\n\tif (events.length >= 3 && lastRatingPromptedDate == null) {\n\t\treturn true\n\t}\n\t//endregion\n\n\t//region Trigger 2: Check for at least 10 activities in the last 28 days\n\tconst twentyEightDaysAgo = DateTime.fromJSDate(now).minus({ days: 28 }).toMillis()\n\tconst recentActivityCount = events.filter((event) => new Date(event).getTime() >= twentyEightDaysAgo).length\n\n\tif (recentActivityCount >= 10) {\n\t\treturn true\n\t}\n\t//endregion\n\treturn false\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIO,SAAS,YAAYA,cAAkC;CAC7D,MAAMC,kBAA0B;CAChC,IAAI,SAAS,aAAa,WAAW,CAAC,OAAO,CAAC,UAAU,kBAAkB,IAAI,QAAQ,OAAO,gBAAgB,CAAC;AAC9G,QAAO,KAAK,IAAI,OAAO;AACvB,cAAa,YAAY,OAAO;AAChC;AAEM,SAAS,kBAAkBC,KAAWC,MAAYC,MAAc;AACtE,QAAO,SAAS,WAAW,IAAI,CAAC,KAAK,SAAS,WAAW,KAAK,EAAE,OAAO,CAAC,OAAO;AAC/E;IAEW,kDAAL;AACN;AACA;AACA;AACA;AACA;AACA;;AACA;AAWM,eAAe,iBAAiBF,KAAWF,cAA4BK,UAA+C;AAC5H,MAAK,SACJ,QAAO,kBAAkB;CAG1B,MAAMC,yBAAsC,aAAa,2BAA2B;AAEpF,KAAI,0BAA0B,QAAQ,SAAS,WAAW,IAAI,CAAC,KAAK,SAAS,WAAW,uBAAuB,EAAE,QAAQ,CAAC,QAAQ,EACjI,QAAO,kBAAkB;CAG1B,MAAM,sBAAsB,MAAM,QAAQ,aAAa,qBAAqB,CAAC,KAAK,CAAC,YAAY,IAAI,KAAK,OAAO,QAAQ,EAAE;AACzH,KAAI,kBAAkB,KAAK,qBAAqB,EAAE,CACjD,QAAO,kBAAkB;CAG1B,MAAM,wBAAwB,MAAM,QAAQ,OAAO,mBAAmB,CAAC,kBAAkB,EAAE;AAC3F,KAAI,kBAAkB,KAAK,sBAAsB,EAAE,CAClD,QAAO,kBAAkB;CAG1B,MAAM,yBAAyB,aAAa,2BAA2B;AACvE,KAAI,0BAA0B,QAAQ,IAAI,SAAS,GAAG,uBAAuB,SAAS,CACrF,QAAO,kBAAkB;AAG1B,QAAO,kBAAkB;AACzB;AAWM,SAAS,mBAAmBJ,KAAWF,cAAqC;CAElF,MAAMM,yBAAsC,aAAa,2BAA2B;CAEpF,MAAMC,SAAiB,aAAa,WAAW;AAC/C,KAAI,OAAO,UAAU,KAAK,0BAA0B,KACnD,QAAO;CAKR,MAAM,qBAAqB,SAAS,WAAW,IAAI,CAAC,MAAM,EAAE,MAAM,GAAI,EAAC,CAAC,UAAU;CAClF,MAAM,sBAAsB,OAAO,OAAO,CAAC,UAAU,IAAI,KAAK,OAAO,SAAS,IAAI,mBAAmB,CAAC;AAEtG,KAAI,uBAAuB,GAC1B,QAAO;AAGR,QAAO;AACP"}