
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { findAllAndRemove } from "./dist-CJHwsXKY.js";
import { ProgrammingError } from "./ProgrammingError-D8yJGVtm.js";
import { OperationType } from "./TutanotaConstants-3bwAESYA.js";
import { ConnectionError, ServiceUnavailableError } from "./RestError-D17JEBMr.js";

//#region ../src/common/api/worker/EventQueue.ts
let EntityModificationType = function(EntityModificationType$1) {
	EntityModificationType$1["CREATE"] = "CREATE";
	EntityModificationType$1["UPDATE"] = "UPDATE";
	EntityModificationType$1["DELETE"] = "DELETE";
	return EntityModificationType$1;
}({});
function batchMod(batchId, batch, entityUpdate) {
	for (const batchEvent of batch) if (entityUpdate.instanceId === batchEvent.instanceId && entityUpdate.instanceListId === batchEvent.instanceListId && entityUpdate.application === batchEvent.application && entityUpdate.type === batchEvent.type) switch (batchEvent.operation) {
		case OperationType.CREATE: return EntityModificationType.CREATE;
		case OperationType.UPDATE: return EntityModificationType.UPDATE;
		case OperationType.DELETE: return EntityModificationType.DELETE;
		default: throw new ProgrammingError(`Unknown operation: ${batchEvent.operation}`);
	}
	throw new ProgrammingError(`Batch does not have events for ${entityUpdate.application}/${entityUpdate.type} ${lastOperationKey(entityUpdate)}, batchId: ${batchId}`);
}
function lastOperationKey(update) {
	const typeIdentifier = `${update.application}/${update.type}`;
	if (update.instanceListId) return `${typeIdentifier}/${update.instanceListId}/${update.instanceId}`;
else return `${typeIdentifier}/${update.instanceId}`;
}
var EventQueue = class {
	/** Batches to process. Oldest first. */
	eventQueue;
	lastOperationForEntity;
	processingBatch;
	paused;
	progressMonitor;
	/**
	* @param tag identifier to make for better log messages
	* @param optimizationEnabled whether the queue should try to optimize events and remove unnecessary ones with the knowledge of newer ones
	* @param queueAction which is executed for each batch. Must *never* throw.
	*/
	constructor(tag, optimizationEnabled, queueAction) {
		this.tag = tag;
		this.optimizationEnabled = optimizationEnabled;
		this.queueAction = queueAction;
		this.eventQueue = [];
		this.lastOperationForEntity = new Map();
		this.processingBatch = null;
		this.paused = false;
		this.progressMonitor = null;
	}
	addBatches(batches) {
		for (const batch of batches) this.add(batch.batchId, batch.groupId, batch.events);
	}
	setProgressMonitor(progressMonitor) {
		this.progressMonitor?.completed();
		this.progressMonitor = progressMonitor;
	}
	/**
	* @return whether the batch was added (not optimized away)
	*/
	add(batchId, groupId, newEvents) {
		const newBatch = {
			events: [],
			groupId,
			batchId
		};
		if (!this.optimizationEnabled) newBatch.events.push(...newEvents);
else this.optimizingAddEvents(newBatch, batchId, groupId, newEvents);
		if (newBatch.events.length !== 0) {
			this.eventQueue.push(newBatch);
			for (const update of newBatch.events) this.lastOperationForEntity.set(lastOperationKey(update), newBatch);
		}
		this.start();
		return newBatch.events.length > 0;
	}
	optimizingAddEvents(newBatch, batchId, groupId, newEvents) {
		for (const newEvent of newEvents) {
			const lastOpKey = lastOperationKey(newEvent);
			const lastBatchForEntity = this.lastOperationForEntity.get(lastOpKey);
			if (lastBatchForEntity == null || this.processingBatch != null && this.processingBatch === lastBatchForEntity || groupId !== lastBatchForEntity.groupId) newBatch.events.push(newEvent);
else {
				const newEntityModification = batchMod(batchId, newEvents, newEvent);
				const lastEntityModification = batchMod(lastBatchForEntity.batchId, lastBatchForEntity.events, newEvent);
				if (newEntityModification === EntityModificationType.UPDATE) switch (lastEntityModification) {
					case EntityModificationType.CREATE: break;
					case EntityModificationType.UPDATE: break;
					case EntityModificationType.DELETE: throw new ProgrammingError(`UPDATE not allowed after DELETE. Last batch: ${lastBatchForEntity.batchId}, new batch: ${batchId}, ${newEvent.type} ${lastOpKey}`);
				}
else if (newEntityModification === EntityModificationType.DELETE) {
					this.removeEventsForInstance(lastOpKey);
					this.lastOperationForEntity.set(lastOpKey, newBatch);
					newBatch.events.push(newEvent);
				} else if (newEntityModification === EntityModificationType.CREATE) if (lastEntityModification === EntityModificationType.DELETE || lastEntityModification === EntityModificationType.CREATE) newBatch.events.push(newEvent);
else throw new ProgrammingError(`Impossible modification combination ${lastEntityModification} ${newEntityModification} ${JSON.stringify(newEvent)}`);
else throw new ProgrammingError(`Impossible modification combination ${lastEntityModification} ${newEntityModification} ${JSON.stringify(newEvent)}`);
			}
		}
	}
	removeEventsForInstance(operationKey, startIndex = 0) {
		for (let i = startIndex; i < this.eventQueue.length; i++) {
			const batchInThePast = this.eventQueue[i];
			if (this.processingBatch === batchInThePast) continue;
			findAllAndRemove(batchInThePast.events, (event) => event.operation !== OperationType.DELETE && lastOperationKey(event) === operationKey);
		}
	}
	start() {
		if (this.processingBatch) return;
		this.processNext();
	}
	queueSize() {
		return this.eventQueue.length;
	}
	processNext() {
		if (this.paused) return;
		const next = this.eventQueue[0];
		if (next) {
			this.processingBatch = next;
			this.queueAction(next).then(() => {
				this.eventQueue.shift();
				this.progressMonitor?.workDone(1);
				this.processingBatch = null;
				for (const event of next.events) {
					const concatenatedId = lastOperationKey(event);
					if (this.lastOperationForEntity.get(concatenatedId) === next) this.lastOperationForEntity.delete(concatenatedId);
				}
				this.processNext();
			}).catch((e) => {
				console.log("EventQueue", this.tag, this.optimizationEnabled, "error", next, e);
				this.processingBatch = null;
				if (!(e instanceof ServiceUnavailableError || e instanceof ConnectionError)) console.error("Uncaught EventQueue error!", e, next);
			});
		}
	}
	clear() {
		this.eventQueue.splice(0);
		this.processingBatch = null;
		for (const k of this.lastOperationForEntity.keys()) this.lastOperationForEntity.delete(k);
	}
	pause() {
		this.paused = true;
	}
	resume() {
		this.paused = false;
		this.start();
	}
	/** @private visibleForTesting */
	get __processingBatch() {
		return this.processingBatch;
	}
};

//#endregion
export { EntityModificationType, EventQueue, batchMod };
//# sourceMappingURL=EventQueue-c-5UmjJa.js.map