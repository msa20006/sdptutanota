
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { assertNotNull, base64ToBase64Url, neverNull } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import "./Env-D5xGlXfw.js";
import { OperationType } from "./TutanotaConstants-3bwAESYA.js";
import { handleRestError } from "./RestError-D17JEBMr.js";
import "./CryptoError-PqdvQky4.js";
import "./CancelledError-FjP5S_cR.js";
import "./EntityUtils-RQxXZlcV.js";
import "./TypeModels-XIXYys8J.js";
import { MailAddressTypeRef } from "./TypeRefs-CR3TLWn0.js";
import "./TypeModels-BktRFNDN.js";
import { createIdTupleWrapper, createNotificationInfo } from "./TypeRefs-BP1jvX9p.js";
import { ModelInfo_default$1 as ModelInfo_default } from "./EntityFunctions-l6CncM5C.js";
import "./TypeModels-ZqCk-pGw.js";
import "./ModelInfo-DEa-Yxv2.js";
import "./dist-DcZ1Y4qd.js";
import "./IndexTables-C5S9WDY9.js";
import "./IndexUtils-K27esrGs.js";
import { log } from "./DesktopLog-yAgEoQsh.js";
import { CredentialEncryptionMode } from "./CredentialEncryptionMode-BR0DkQpJ.js";
import { CredentialType } from "./CredentialType-DXeA2MQH.js";
import { ExtendedNotificationMode } from "./ExtendedNotificationMode-5QnYUmGC.js";
import "./IndexerCore-CrLYpsA5.js";
import { dist_default } from "./dist-Ci1bEzYU.js";
import { require_testdouble } from "./testdouble-IbRSnrC0.js";
import "./dist-BY49f75m.js";
import { createTestEntity, mockFetchRequest } from "./TestUtils-f_4UhLVE.js";
import { NotificationResult } from "./DesktopNotifier-BR7GuUWK.js";

//#region ../src/common/desktop/sse/TutaNotificationHandler.ts
const TAG = "[notifications]";
var TutaNotificationHandler = class {
	constructor(windowManager, nativeCredentialFacade, sseStorage, notifier, alarmScheduler, alarmStorage, lang, fetch, appVersion) {
		this.windowManager = windowManager;
		this.nativeCredentialFacade = nativeCredentialFacade;
		this.sseStorage = sseStorage;
		this.notifier = notifier;
		this.alarmScheduler = alarmScheduler;
		this.alarmStorage = alarmStorage;
		this.lang = lang;
		this.fetch = fetch;
		this.appVersion = appVersion;
	}
	async onMailNotification(sseInfo, notificationInfo) {
		const appWindow = this.windowManager.getAll().find((window) => window.getUserId() === notificationInfo.userId);
		if (appWindow && appWindow.isFocused()) return;
		const canShowExtendedNotification = await this.nativeCredentialFacade.getCredentialEncryptionMode() === CredentialEncryptionMode.DEVICE_LOCK && await this.sseStorage.getExtendedNotificationConfig(notificationInfo.userId) !== ExtendedNotificationMode.NoSenderOrSubject;
		if (!canShowExtendedNotification) {
			const notificationId = notificationInfo.mailId ? `${notificationInfo.mailId.listId},${notificationInfo.mailId?.listElementId}` : notificationInfo.userId;
			this.notifier.submitGroupedNotification(this.lang.get("pushNewMail_msg"), notificationInfo.mailAddress, notificationId, (res) => this.onMailNotificationClick(res, notificationInfo));
			return;
		}
		const mailMetadata = await this.downloadMailMetadata(sseInfo, notificationInfo);
		if (mailMetadata == null) return;
		this.notifier.submitGroupedNotification(mailMetadata.sender.address, mailMetadata.firstRecipient?.address ?? "", mailMetadata._id.join(","), (res) => this.onMailNotificationClick(res, notificationInfo));
	}
	onMailNotificationClick(res, notificationInfo) {
		if (res === NotificationResult.Click) {
			let requestedPath;
			if (notificationInfo.mailId) {
				const mailIdParam = encodeURIComponent(`${notificationInfo.mailId.listId},${notificationInfo.mailId.listElementId}`);
				requestedPath = `?mail=${mailIdParam}`;
			} else requestedPath = null;
			this.windowManager.openMailBox({
				userId: notificationInfo.userId,
				mailAddress: notificationInfo.mailAddress
			}, requestedPath);
		}
	}
	async downloadMailMetadata(sseInfo, ni) {
		const url = this.makeMailMetadataUrl(sseInfo, assertNotNull(ni.mailId));
		const credentials = await this.nativeCredentialFacade.loadByUserId(ni.userId);
		if (credentials == null) {
			log.warn(`Not found credentials to download notification, userId ${ni.userId}`);
			return null;
		}
		log.debug(TAG, "downloading mail notification metadata");
		const headers = {
			v: ModelInfo_default.version.toString(),
			cv: this.appVersion,
			accessToken: credentials.accessToken
		};
		try {
			const response = await this.fetch(url, { headers });
			if (!response.ok) throw handleRestError(neverNull(response.status), url.toString(), response.headers.get("Error-Id"), null);
			const parsedResponse = await response.json();
			return parsedResponse;
		} catch (e) {
			log.debug(TAG, "Error fetching mail metadata, " + e.message);
			return null;
		}
	}
	makeMailMetadataUrl(sseInfo, mailId) {
		const url = new URL(sseInfo.sseOrigin);
		url.pathname = `rest/tutanota/mail/${base64ToBase64Url(mailId.listId)}/${base64ToBase64Url(mailId.listElementId)}`;
		return url;
	}
	async onAlarmNotification(alarmNotification) {
		await this.alarmScheduler.handleAlarmNotification(alarmNotification);
	}
	async onUserRemoved(userId) {
		await this.alarmScheduler.unscheduleAllAlarms(userId);
	}
	async onLocalDataInvalidated() {
		await this.alarmScheduler.unscheduleAllAlarms();
		await this.alarmStorage.removePushIdentifierKeys();
		await this.windowManager.invalidateAlarms();
	}
};

//#endregion
//#region tests/desktop/sse/TutaNotificationHandlerTest.ts
var import_testdouble = __toESM(require_testdouble(), 1);
dist_default.spec("TutaNotificationHandler", () => {
	let wm;
	let nativeCredentialsFacade;
	let conf;
	let notifier;
	let alarmScheduler;
	let alarmStorage;
	let lang;
	let fetch;
	let appVersion = "V_1";
	let handler;
	dist_default.beforeEach(() => {
		wm = (0, import_testdouble.object)();
		nativeCredentialsFacade = (0, import_testdouble.object)();
		conf = (0, import_testdouble.object)();
		notifier = (0, import_testdouble.object)();
		alarmScheduler = (0, import_testdouble.object)();
		alarmStorage = (0, import_testdouble.object)();
		lang = (0, import_testdouble.object)();
		fetch = (0, import_testdouble.func)();
		(0, import_testdouble.when)(lang.get(import_testdouble.matchers.anything())).thenDo((arg) => `translated:${arg}`);
		handler = new TutaNotificationHandler(wm, nativeCredentialsFacade, conf, notifier, alarmScheduler, alarmStorage, lang, fetch, appVersion);
	});
	dist_default.spec("onMailNotification", () => {
		dist_default.test("displays simple notification if preview is off", async () => {
			(0, import_testdouble.when)(wm.getAll()).thenReturn([]);
			(0, import_testdouble.when)(nativeCredentialsFacade.getCredentialEncryptionMode()).thenResolve(CredentialEncryptionMode.DEVICE_LOCK);
			(0, import_testdouble.when)(conf.getExtendedNotificationConfig("user1")).thenResolve(ExtendedNotificationMode.NoSenderOrSubject);
			const mailId = createIdTupleWrapper({
				listId: "mailListId",
				listElementId: "mailElementId"
			});
			const notificationInfo = createNotificationInfo({
				_id: "id",
				_ownerGroup: "ownerGroupId",
				mailId,
				mailAddress: "recipient@example.com",
				userId: "user1"
			});
			await handler.onMailNotification(setupSseInfo(), notificationInfo);
			(0, import_testdouble.verify)(notifier.submitGroupedNotification("translated:pushNewMail_msg", notificationInfo.mailAddress, "mailListId,mailElementId", import_testdouble.matchers.anything()));
		});
		dist_default.test("does not display email notification if the window is already focused", async () => {
			(0, import_testdouble.when)(wm.getAll()).thenReturn([{
				getUserId: () => "user1",
				isFocused: () => true
			}]);
			(0, import_testdouble.when)(nativeCredentialsFacade.getCredentialEncryptionMode()).thenResolve(CredentialEncryptionMode.DEVICE_LOCK);
			(0, import_testdouble.when)(conf.getExtendedNotificationConfig("user1")).thenResolve(ExtendedNotificationMode.NoSenderOrSubject);
			const mailId = createIdTupleWrapper({
				listId: "mailListId",
				listElementId: "mailElementId"
			});
			const notificationInfo = createNotificationInfo({
				_id: "id",
				_ownerGroup: "ownerGroupId",
				mailId,
				mailAddress: "recipient@example.com",
				userId: "user1"
			});
			await handler.onMailNotification(setupSseInfo(), notificationInfo);
			(0, import_testdouble.verify)(notifier.submitGroupedNotification(import_testdouble.matchers.anything(), import_testdouble.matchers.anything(), import_testdouble.matchers.anything(), import_testdouble.matchers.anything()), { times: 0 });
		});
		dist_default.test("displays simple notification if app pass is on", async () => {
			(0, import_testdouble.when)(wm.getAll()).thenReturn([]);
			(0, import_testdouble.when)(nativeCredentialsFacade.getCredentialEncryptionMode()).thenResolve(CredentialEncryptionMode.APP_PASSWORD);
			(0, import_testdouble.when)(conf.getExtendedNotificationConfig("user1")).thenResolve(ExtendedNotificationMode.OnlySender);
			const mailId = createIdTupleWrapper({
				listId: "mailListId",
				listElementId: "mailElementId"
			});
			const notificationInfo = createNotificationInfo({
				_id: "id",
				_ownerGroup: "ownerGroupId",
				mailId,
				mailAddress: "recipient@example.com",
				userId: "user1"
			});
			await handler.onMailNotification(setupSseInfo(), notificationInfo);
			const listenerCaptor = import_testdouble.matchers.captor();
			(0, import_testdouble.verify)(notifier.submitGroupedNotification("translated:pushNewMail_msg", notificationInfo.mailAddress, "mailListId,mailElementId", listenerCaptor.capture()));
			listenerCaptor.value(NotificationResult.Click);
			(0, import_testdouble.verify)(wm.openMailBox({
				userId: "user1",
				mailAddress: notificationInfo.mailAddress
			}, "?mail=mailListId%2CmailElementId"));
		});
		dist_default.test("downloads and displays extended notifications", async () => {
			(0, import_testdouble.when)(wm.getAll()).thenReturn([]);
			(0, import_testdouble.when)(nativeCredentialsFacade.getCredentialEncryptionMode()).thenResolve(CredentialEncryptionMode.DEVICE_LOCK);
			(0, import_testdouble.when)(conf.getExtendedNotificationConfig("user1")).thenResolve(ExtendedNotificationMode.OnlySender);
			const mailId = createIdTupleWrapper({
				listId: "mailListId",
				listElementId: "mailElementId"
			});
			const notificationInfo = createNotificationInfo({
				_id: "id",
				_ownerGroup: "ownerGroupId",
				mailId,
				mailAddress: "recipient@example.com",
				userId: "user1"
			});
			const sseInfo = setupSseInfo();
			const credentials = {
				credentialInfo: {
					userId: "user1",
					type: CredentialType.Internal,
					login: "user1@example.com"
				},
				accessToken: "accessToken",
				databaseKey: null,
				encryptedPassphraseKey: null,
				encryptedPassword: ""
			};
			(0, import_testdouble.when)(nativeCredentialsFacade.loadByUserId("user1")).thenResolve(credentials);
			const mailMetadata = {
				_id: [mailId.listId, mailId.listElementId],
				sender: createTestEntity(MailAddressTypeRef, { address: "sender@example.com" }),
				firstRecipient: createTestEntity(MailAddressTypeRef, { address: "recipient@example.com" })
			};
			const requestDefer = mockFetchRequest(fetch, "http://something.com/rest/tutanota/mail/mailListId/mailElementId", {
				v: ModelInfo_default.version.toString(),
				cv: appVersion,
				accessToken: "accessToken"
			}, 200, mailMetadata);
			await handler.onMailNotification(sseInfo, notificationInfo);
			await requestDefer;
			const listenerCaptor = import_testdouble.matchers.captor();
			(0, import_testdouble.verify)(notifier.submitGroupedNotification("sender@example.com", "recipient@example.com", "mailListId,mailElementId", listenerCaptor.capture()));
			listenerCaptor.value(NotificationResult.Click);
			(0, import_testdouble.verify)(wm.openMailBox({
				userId: "user1",
				mailAddress: notificationInfo.mailAddress
			}, "?mail=mailListId%2CmailElementId"));
		});
	});
	dist_default.spec("onAlarmNotification", () => {
		dist_default.test("passes it to alarmScheduler", async () => {
			const alarmNotification = {
				operation: OperationType.CREATE,
				notificationSessionKeys: [],
				alarmInfo: { alarmIdentifier: "alarmIdentifier" },
				user: "user1"
			};
			await handler.onAlarmNotification(alarmNotification);
			(0, import_testdouble.verify)(alarmScheduler.handleAlarmNotification(alarmNotification));
		});
	});
	dist_default.test("onLocalDataInvalidated", async () => {
		await handler.onLocalDataInvalidated();
		(0, import_testdouble.verify)(alarmScheduler.unscheduleAllAlarms());
		(0, import_testdouble.verify)(alarmStorage.removePushIdentifierKeys());
		(0, import_testdouble.verify)(wm.invalidateAlarms());
	});
	function setupSseInfo(template = {}) {
		const sseInfo = {
			identifier: "id",
			sseOrigin: "http://something.com",
			userIds: ["userId"],
			...template
		};
		return sseInfo;
	}
});

//#endregion
//# sourceMappingURL=TutaNotificationHandlerTest-B5iQmXAR.js.map