
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { assertNotNull, noOp } from "./dist-CJHwsXKY.js";
import { assertMainOrNode, isDesktop, isOfflineStorageAvailable } from "./Env-D5xGlXfw.js";
import { lang } from "./LanguageViewModel-BNC5ekpO.js";
import { windowFacade } from "./WindowFacade-B9kSBKw7.js";
import { Dialog } from "./Dialog-B6-HFvZd.js";
import { AccessBlockedError, AccessDeactivatedError, AccessExpiredError, ConnectionError, InsufficientStorageError, InvalidSoftwareVersionError, NotAuthenticatedError, RequestTimeoutError, ServiceUnavailableError, SessionExpiredError } from "./RestError-D17JEBMr.js";
import { isOfflineError } from "./ErrorUtils-o1-v67Dd.js";
import { OfflineDbClosedError } from "./OfflineDbClosedError-CAwHTI6J.js";
import { OutOfSyncError } from "./OutOfSyncError-Ck2yBBO8.js";
import { IndexingNotSupportedError, QuotaExceededError } from "./QuotaExceededError-nFM6SdTn.js";
import { CancelledError } from "./CancelledError-FjP5S_cR.js";
import { UserTypeRef } from "./TypeRefs-BP1jvX9p.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import { UserError } from "./UserError-DfXlMLTl.js";
import { showProgressDialog } from "./ProgressDialog-CJfJjh62.js";
import { showMoreStorageNeededOrderDialog } from "./SubscriptionDialogs-DAlWs68I.js";
import { showSnackBar } from "./SnackBar-CoP3lSVs.js";
import { credentialsToUnencrypted } from "./Credentials-BM35X_na.js";
import { showErrorDialogNotLoggedIn, showErrorNotification } from "./ErrorReporter-7sfLhWZg.js";
import { SessionType } from "./SessionType-rxSDsswH.js";
import { showRequestPasswordDialog } from "./PasswordRequestDialog-B7ZIVTVw.js";

//#region ../src/common/misc/ErrorHandlerImpl.ts
assertMainOrNode();
let unknownErrorDialogActive = false;
let notConnectedDialogActive = false;
let invalidSoftwareVersionActive = false;
let loginDialogActive = false;
let isLoggingOut = false;
let serviceUnavailableDialogActive = false;
let requestTimeoutDialogActive = false;
let shownQuotaError = false;
const ignoredMessages = [
	"webkitExitFullScreen",
	"googletag",
	"avast_submit"
];
async function handleUncaughtErrorImpl(e) {
	const { logins, interWindowEventSender, worker, search } = locator;
	if (isLoggingOut) return;
	if (e instanceof UserError) return showUserError(e);
	if (isOfflineError(e)) showOfflineMessage();
else if (e instanceof InvalidSoftwareVersionError) {
		if (!invalidSoftwareVersionActive) {
			invalidSoftwareVersionActive = true;
			Dialog.message("outdatedClient_msg").then(() => invalidSoftwareVersionActive = false);
		}
	} else if (e instanceof NotAuthenticatedError || e instanceof AccessBlockedError || e instanceof AccessDeactivatedError || e instanceof AccessExpiredError) {
		if (logins.isUserLoggedIn()) logoutIfNoPasswordPrompt();
	} else if (e instanceof SessionExpiredError) reloginForExpiredSession();
else if (e instanceof OutOfSyncError) {
		const isOffline = isOfflineStorageAvailable() && logins.isUserLoggedIn() && logins.getUserController().sessionType === SessionType.Persistent;
		await Dialog.message("outOfSync_label", lang.get(isOffline ? "dataExpiredOfflineDb_msg" : "dataExpired_msg"));
		const { userId } = logins.getUserController();
		if (isDesktop()) {
			await interWindowEventSender?.localUserDataInvalidated(userId);
			await worker.getWorkerInterface().sqlCipherFacade.deleteDb(userId);
		}
		await logins.logout(false);
		await windowFacade.reload({ noAutoLogin: true });
	} else if (e instanceof InsufficientStorageError) if (logins.getUserController().isGlobalAdmin()) showMoreStorageNeededOrderDialog("insufficientStorageAdmin_msg");
else {
		const errorMessage = lang.makeTranslation("insufficientStorageUser_msg", lang.get("insufficientStorageUser_msg") + " " + lang.get("contactAdmin_msg"));
		Dialog.message(errorMessage);
	}
else if (e instanceof ServiceUnavailableError) {
		if (!serviceUnavailableDialogActive) {
			serviceUnavailableDialogActive = true;
			Dialog.message("serviceUnavailable_msg").then(() => {
				serviceUnavailableDialogActive = false;
			});
		}
	} else if (e instanceof RequestTimeoutError) {
		if (!requestTimeoutDialogActive) {
			requestTimeoutDialogActive = true;
			Dialog.message("requestTimeout_msg").then(() => {
				requestTimeoutDialogActive = false;
			});
		}
	} else if (e instanceof IndexingNotSupportedError) {
		console.log("Indexing not supported", e);
		if ("indexingSupported" in search) search.indexingSupported = false;
	} else if (e instanceof QuotaExceededError) {
		if (!shownQuotaError) {
			shownQuotaError = true;
			Dialog.message("storageQuotaExceeded_msg");
		}
	} else if (e instanceof OfflineDbClosedError) {
		if (!loginDialogActive) throw e;
	} else if (ignoredError(e)) {} else if (!unknownErrorDialogActive) {
		unknownErrorDialogActive = true;
		if (logins.isUserLoggedIn()) {
			const { ignored } = await showErrorNotification(e);
			unknownErrorDialogActive = false;
			if (ignored) ignoredMessages.push(e.message);
		} else {
			console.log("Unknown error", e);
			showErrorDialogNotLoggedIn(e).then(() => unknownErrorDialogActive = false);
		}
	}
}
function showOfflineMessage() {
	if (!notConnectedDialogActive) {
		notConnectedDialogActive = true;
		showSnackBar({
			message: "serverNotReachable_msg",
			button: {
				label: "ok_action",
				click: () => {}
			},
			onClose: () => {
				notConnectedDialogActive = false;
			}
		});
	}
}
function logoutIfNoPasswordPrompt() {
	if (!loginDialogActive) windowFacade.reload({});
}
async function reloginForExpiredSession() {
	if (loginDialogActive) return;
	const { logins, loginFacade, secondFactorHandler, credentialsProvider, cacheStorage } = locator;
	await logins.waitForPartialLogin();
	console.log("RELOGIN", logins.isUserLoggedIn());
	const oldSessionType = logins.getUserController().sessionType;
	const userId = logins.getUserController().user._id;
	const mailAddress = assertNotNull(logins.getUserController().userGroupInfo.mailAddress, "could not get mailAddress from userGroupInfo");
	const oldCredentials = await credentialsProvider.getDecryptedCredentialsByUserId(userId);
	await cacheStorage?.deleteIfExists(UserTypeRef, null, userId);
	const sessionReset = loginFacade.resetSession();
	loginDialogActive = true;
	const dialog = showRequestPasswordDialog({
		action: async (pw) => {
			await sessionReset;
			let credentials;
			let databaseKey;
			try {
				const newSessionData = await logins.createSession(mailAddress, pw, oldSessionType, oldCredentials?.databaseKey);
				credentials = newSessionData.credentials;
				databaseKey = newSessionData.databaseKey;
			} catch (e) {
				if (e instanceof CancelledError || e instanceof AccessBlockedError || e instanceof NotAuthenticatedError || e instanceof AccessDeactivatedError || e instanceof ConnectionError) {
					const { getLoginErrorMessage } = await import("./LoginUtils-CdyKJRXa.js");
					return lang.getTranslationText(getLoginErrorMessage(e, false));
				} else throw e;
			} finally {
				secondFactorHandler.closeWaitingForSecondFactorDialog();
			}
			await credentialsProvider.deleteByUserId(userId, { deleteOfflineDb: false });
			if (oldSessionType === SessionType.Persistent) await credentialsProvider.store(credentialsToUnencrypted(credentials, databaseKey));
			loginDialogActive = false;
			dialog.close();
			return "";
		},
		cancel: {
			textId: "logout_label",
			action() {
				windowFacade.reload({});
			}
		}
	});
}
function ignoredError(e) {
	return e.message != null && ignoredMessages.some((s) => e.message.includes(s));
}
function disableErrorHandlingDuringLogout() {
	isLoggingOut = true;
	showProgressDialog("loggingOut_msg", new Promise(noOp));
}
if (typeof window !== "undefined") window.tutao.testError = () => handleUncaughtErrorImpl(new Error("test error!"));
function showUserError(error) {
	return Dialog.message(lang.makeTranslation("error_msg", error.message));
}

//#endregion
export { disableErrorHandlingDuringLogout, handleUncaughtErrorImpl, reloginForExpiredSession, showUserError };
//# sourceMappingURL=ErrorHandlerImpl-DRpk8tE9.js.map