
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { mithril_default } from "./mithril-Csg4iNnm.js";
import { ofClass, utf8Uint8ArrayToString } from "./dist-CJHwsXKY.js";
import { isApp } from "./Env-D5xGlXfw.js";
import { lang } from "./LanguageViewModel-BNC5ekpO.js";
import { size } from "./HtmlUtils-C-ecR7U7.js";
import { ShareCapability } from "./TutanotaConstants-3bwAESYA.js";
import { BootIcons, ButtonType } from "./Icon-BuqNK7vz.js";
import { Dialog, DialogHeaderBar, DialogType, DropDownSelector } from "./Dialog-B6-HFvZd.js";
import { ImportError } from "./ImportError-CIXw37Kv.js";
import { ParserError } from "./ParserCombinator-D38ofgFx.js";
import { CalendarEventTypeRef } from "./TypeRefs-CR3TLWn0.js";
import { CalendarType, getTimeZone, isExternalCalendarType } from "./CalendarUtils-C6jeYrj9.js";
import { getSharedGroupName, hasCapabilityOnGroup } from "./GroupUtils-CpT2lvVS.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import { EventImportRejectionReason, parseCalendarStringData, sortOutParsedEvents } from "./ImportExportUtils-B1MoOmZ0.js";
import { showProgressDialog } from "./ProgressDialog-CJfJjh62.js";
import { showFileChooser, showNativeFilePicker } from "./SharedMailUtils-AmFaSJP6.js";
import { renderCalendarColor } from "./CalendarGuiUtils-CkzhFM1K.js";
import { List, ListLoadingState, MultiselectMode } from "./List-CdKNFQkI.js";
import { KindaCalendarRow } from "./CalendarRow-DM7ryi94.js";

//#region ../src/common/calendar/import/CalendarImporterDialog.ts
/**
* show an error dialog detailing the reason and amount for events that failed to import
*/
async function partialImportConfirmation(skippedEvents, confirmationText, total) {
	return skippedEvents.length === 0 || await Dialog.confirm(lang.makeTranslation("confirm_msg", lang.get(confirmationText, {
		"{amount}": skippedEvents.length + "",
		"{total}": total + ""
	})));
}
async function handleCalendarImport(calendarGroupRoot, importedParsedEvents = null, calendarType = CalendarType.NORMAL) {
	const parsedEvents = importedParsedEvents ?? await showProgressDialog("loading_msg", selectAndParseIcalFile());
	if (parsedEvents.length === 0) return;
	const zone = getTimeZone();
	const existingEvents = await showProgressDialog("loading_msg", loadAllEvents(calendarGroupRoot));
	const { rejectedEvents, eventsForCreation } = sortOutParsedEvents(parsedEvents, existingEvents, calendarGroupRoot, zone);
	const total = parsedEvents.length;
	if (!await partialImportConfirmation(rejectedEvents.get(EventImportRejectionReason.Duplicate) ?? [], "importEventExistingUid_msg", total)) return;
	if (!await partialImportConfirmation(rejectedEvents.get(EventImportRejectionReason.InvalidDate) ?? [], "importInvalidDatesInEvent_msg", total)) return;
	if (!await partialImportConfirmation(rejectedEvents.get(EventImportRejectionReason.Inversed) ?? [], "importEndNotAfterStartInEvent_msg", total)) return;
	if (!await partialImportConfirmation(rejectedEvents.get(EventImportRejectionReason.Pre1970) ?? [], "importPre1970StartInEvent_msg", total)) return;
	if (eventsForCreation.length > 0) if (isExternalCalendarType(calendarType)) await importEvents(eventsForCreation);
else showEventsImportDialog(eventsForCreation.map((ev) => ev.event), async (dialog) => {
		dialog.close();
		await importEvents(eventsForCreation);
	}, "importEvents_label");
}
async function selectAndParseIcalFile() {
	try {
		const allowedExtensions = [
			"ical",
			"ics",
			"ifb",
			"icalendar"
		];
		const dataFiles = isApp() ? await showNativeFilePicker(allowedExtensions, true) : await showFileChooser(true, allowedExtensions);
		const contents = dataFiles.map((file) => parseCalendarFile(file).contents);
		return contents.flat();
	} catch (e) {
		if (e instanceof ParserError) {
			console.log("Failed to parse file", e);
			Dialog.message(lang.makeTranslation("confirm_msg", lang.get("importReadFileError_msg", { "{filename}": e.filename ?? "" })));
			return [];
		} else throw e;
	}
}
async function importEvents(eventsForCreation) {
	const operation = locator.operationProgressTracker.startNewOperation();
	return showProgressDialog("importCalendar_label", locator.calendarFacade.saveImportedCalendarEvents(eventsForCreation, operation.id), operation.progress).catch(ofClass(ImportError, (e) => Dialog.message(lang.makeTranslation("confirm_msg", lang.get("importEventsError_msg", {
		"{amount}": e.numFailed + "",
		"{total}": eventsForCreation.length.toString()
	}))))).finally(() => operation.done());
}
function loadAllEvents(groupRoot) {
	return locator.entityClient.loadAll(CalendarEventTypeRef, groupRoot.longEvents).then((longEvents) => locator.entityClient.loadAll(CalendarEventTypeRef, groupRoot.shortEvents).then((shortEvents) => {
		return shortEvents.concat(longEvents);
	}));
}

//#endregion
//#region ../src/common/calendar/import/CalendarImporter.ts
function parseCalendarFile(file) {
	try {
		const stringData = utf8Uint8ArrayToString(file.data);
		return parseCalendarStringData(stringData, getTimeZone());
	} catch (e) {
		if (e instanceof ParserError) throw new ParserError(e.message, file.name);
else throw e;
	}
}
function showEventsImportDialog(events, okAction, title) {
	const renderConfig = {
		itemHeight: size.list_row_height,
		multiselectionAllowed: MultiselectMode.Disabled,
		swipe: null,
		createElement: (dom) => {
			return new KindaCalendarRow(dom);
		}
	};
	const dialog = new Dialog(DialogType.EditSmall, { view: () => [mithril_default(DialogHeaderBar, {
		left: [{
			type: ButtonType.Secondary,
			label: "cancel_action",
			click: () => {
				dialog.close();
			}
		}],
		middle: title,
		right: [{
			type: ButtonType.Primary,
			label: "import_action",
			click: () => {
				okAction(dialog);
			}
		}]
	}), mithril_default(".dialog-max-height.plr-s.pb.text-break.nav-bg", [mithril_default(".flex.col.rel.mt-s", { style: { height: "80vh" } }, mithril_default(List, {
		renderConfig,
		state: {
			items: events,
			loadingStatus: ListLoadingState.Done,
			loadingAll: false,
			inMultiselect: true,
			activeIndex: null,
			selectedItems: new Set()
		},
		onLoadMore() {},
		onRangeSelectionTowards(item) {},
		onRetryLoading() {},
		onSingleSelection(item) {},
		onSingleTogglingMultiselection(item) {},
		onStopLoading() {}
	}))])] }).show();
}
async function importCalendarFile(calendarModel, userController, events) {
	const groupSettings = userController.userSettingsGroupRoot.groupSettings;
	const calendarInfos = await calendarModel.getCalendarInfos();
	const groupColors = groupSettings.reduce((acc, gc) => {
		acc.set(gc.group, gc.color);
		return acc;
	}, new Map());
	calendarSelectionDialog(Array.from(calendarInfos.values()), userController, groupColors, (dialog, selectedCalendar) => {
		dialog.close();
		handleCalendarImport(selectedCalendar.groupRoot, events);
	});
}
function calendarSelectionDialog(calendars, userController, groupColors, okAction) {
	const availableCalendars = calendars.filter((calendarInfo) => hasCapabilityOnGroup(userController.user, calendarInfo.group, ShareCapability.Write));
	let selectedCalendar = availableCalendars[0];
	const dialog = new Dialog(DialogType.EditSmall, { view: () => [mithril_default(DialogHeaderBar, {
		left: [{
			type: ButtonType.Secondary,
			label: "cancel_action",
			click: () => {
				dialog.close();
			}
		}],
		middle: "calendar_label",
		right: [{
			type: ButtonType.Primary,
			label: "pricing.select_action",
			click: () => {
				okAction(dialog, selectedCalendar);
			}
		}]
	}), mithril_default(".dialog-max-height.plr-l.pt.pb.text-break.scroll", [mithril_default(".text-break.selectable", lang.get("calendarImportSelection_label")), mithril_default(DropDownSelector, {
		label: "calendar_label",
		items: availableCalendars.map((calendarInfo) => {
			return {
				name: getSharedGroupName(calendarInfo.groupInfo, userController, calendarInfo.shared),
				value: calendarInfo
			};
		}),
		selectedValue: selectedCalendar,
		selectionChangedHandler: (v) => selectedCalendar = v,
		icon: BootIcons.Expand,
		disabled: availableCalendars.length < 2,
		helpLabel: () => renderCalendarColor(selectedCalendar, groupColors)
	})])] }).show();
}

//#endregion
export { calendarSelectionDialog, handleCalendarImport, importCalendarFile, parseCalendarFile, showEventsImportDialog };
//# sourceMappingURL=CalendarImporter-DjgWaF1e.js.map