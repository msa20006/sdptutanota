{"version":3,"file":"DesktopContextMenuTest-BNC5ekpO.js","names":["electron: Electron","windowManager: WindowManager","params: ContextMenuParams","bw: Electron.BaseWindow | undefined","misspelledWord: string","dictionarySuggestions: Array<string>","wc: WebContents","contextMenuParams: Partial<ContextMenuParams>"],"sources":["../../src/common/desktop/DesktopContextMenu.ts","../tests/desktop/DesktopContextMenuTest.ts"],"sourcesContent":["import type { ContextMenuParams, Menu, WebContents } from \"electron\"\nimport { lang } from \"../misc/LanguageViewModel\"\nimport { WindowManager } from \"./DesktopWindowManager.js\"\nimport { client } from \"../misc/ClientDetector.js\"\n\ntype Electron = typeof Electron.CrossProcessExports\n\nexport class DesktopContextMenu {\n\tconstructor(private readonly electron: Electron, private readonly windowManager: WindowManager) {}\n\n\topen(params: ContextMenuParams) {\n\t\tconst { linkURL, editFlags, misspelledWord, dictionarySuggestions } = params\n\t\tconst menu = new this.electron.Menu()\n\t\tconst pasteItem = new this.electron.MenuItem({\n\t\t\tlabel: lang.get(\"paste_action\"),\n\t\t\taccelerator: \"CmdOrCtrl+V\",\n\t\t\tclick: (_, bw) => this.getWebContents(bw)?.paste(),\n\t\t\tenabled: editFlags.canPaste,\n\t\t})\n\t\tconst pasteWithoutFormattingItem = new this.electron.MenuItem({\n\t\t\tlabel: lang.get(\"pasteWithoutFormatting_action\"),\n\t\t\taccelerator: client.isMacOS ? \"Cmd+Option+Shift+V\" : \"Ctrl+Shift+V\",\n\t\t\tclick: (_, bw) => this.getWebContents(bw)?.pasteAndMatchStyle(),\n\t\t\tenabled: editFlags.canPaste,\n\t\t})\n\t\tconst copyItem = new this.electron.MenuItem({\n\t\t\tlabel: lang.get(\"copy_action\"),\n\t\t\taccelerator: \"CmdOrCtrl+C\",\n\t\t\tclick: (_, bw) => this.getWebContents(bw)?.copy(),\n\t\t\tenabled: editFlags.canCopy,\n\t\t})\n\t\tconst cutItem = new this.electron.MenuItem({\n\t\t\tlabel: lang.get(\"cut_action\"),\n\t\t\taccelerator: \"CmdOrCtrl+X\",\n\t\t\tclick: (_, bw) => this.getWebContents(bw)?.cut(),\n\t\t\tenabled: editFlags.canCut,\n\t\t})\n\t\tconst copyLinkItem = new this.electron.MenuItem({\n\t\t\tlabel: lang.get(\"copyLink_action\"),\n\t\t\tclick: () => !!linkURL && this.electron.clipboard.writeText(linkURL),\n\t\t\tenabled: !!linkURL,\n\t\t})\n\t\tconst undoItem = new this.electron.MenuItem({\n\t\t\tlabel: lang.get(\"undo_action\"),\n\t\t\taccelerator: \"CmdOrCtrl+Z\",\n\t\t\tclick: (_, bw) => this.getWebContents(bw)?.undo(),\n\t\t\tenabled: editFlags.canUndo,\n\t\t})\n\t\tconst redoItem = new this.electron.MenuItem({\n\t\t\tlabel: lang.get(\"redo_action\"),\n\t\t\taccelerator: \"CmdOrCtrl+Shift+Z\",\n\t\t\tclick: (_, bw) => this.getWebContents(bw)?.redo(),\n\t\t\tenabled: editFlags.canRedo,\n\t\t})\n\t\tconst spellingItem = new this.electron.MenuItem({\n\t\t\tlabel: lang.get(\"spelling_label\"),\n\t\t\tsubmenu: this.spellingSubmenu(misspelledWord, dictionarySuggestions),\n\t\t})\n\t\tmenu.append(copyItem)\n\t\tmenu.append(cutItem)\n\t\tmenu.append(copyLinkItem)\n\t\tmenu.append(pasteItem)\n\t\tmenu.append(pasteWithoutFormattingItem)\n\t\tmenu.append(\n\t\t\tnew this.electron.MenuItem({\n\t\t\t\ttype: \"separator\",\n\t\t\t}),\n\t\t)\n\t\tmenu.append(undoItem)\n\t\tmenu.append(redoItem)\n\t\tmenu.append(\n\t\t\tnew this.electron.MenuItem({\n\t\t\t\ttype: \"separator\",\n\t\t\t}),\n\t\t)\n\t\t// it would be possible to open the menu with a spellcheck dummy\n\t\t// like \"searching dictionary...\" and then append suggestions\n\t\t// and then re-popup the context menu, but alas, the suggestions\n\t\t// are already searched before the context-menu handler is even\n\t\t// invoked, leading to a delay between right-click and menu popup.\n\t\tmenu.append(spellingItem)\n\t\tmenu.popup()\n\t}\n\n\tprivate getWebContents(bw: Electron.BaseWindow | undefined): WebContents | null {\n\t\treturn (bw && bw instanceof this.electron.BrowserWindow && bw.webContents) || null\n\t}\n\n\tprivate spellingSubmenu(misspelledWord: string, dictionarySuggestions: Array<string>): Menu {\n\t\tconst submenu = new this.electron.Menu()\n\n\t\tif (misspelledWord !== \"\") {\n\t\t\tfor (const s of dictionarySuggestions) {\n\t\t\t\tconst menuItem = new this.electron.MenuItem({\n\t\t\t\t\tlabel: s,\n\t\t\t\t\tclick: (_, bw) => this.getWebContents(bw)?.replaceMisspelling(s),\n\t\t\t\t})\n\t\t\t\tsubmenu.append(menuItem)\n\t\t\t}\n\t\t\tsubmenu.append(\n\t\t\t\tnew this.electron.MenuItem({\n\t\t\t\t\ttype: \"separator\",\n\t\t\t\t}),\n\t\t\t)\n\t\t\tsubmenu.append(\n\t\t\t\tnew this.electron.MenuItem({\n\t\t\t\t\tlabel: lang.get(\"addToDict_action\", {\n\t\t\t\t\t\t\"{word}\": misspelledWord,\n\t\t\t\t\t}),\n\t\t\t\t\tclick: (_, bw) => this.getWebContents(bw)?.session.addWordToSpellCheckerDictionary(misspelledWord),\n\t\t\t\t}),\n\t\t\t)\n\t\t}\n\n\t\t// the spellcheck API uses the OS spell checker on MacOs, the language is set in the OS settings.\n\t\tif (process.platform !== \"darwin\") {\n\t\t\tsubmenu.append(\n\t\t\t\tnew this.electron.MenuItem({\n\t\t\t\t\tlabel: lang.get(\"changeSpellCheckLang_action\"),\n\t\t\t\t\tclick: (_, bw) => {\n\t\t\t\t\t\tconst webContents = this.getWebContents(bw)\n\t\t\t\t\t\tif (webContents) {\n\t\t\t\t\t\t\tthis.changeSpellcheckLanguage(webContents)\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t)\n\t\t}\n\n\t\treturn submenu\n\t}\n\n\tprivate async changeSpellcheckLanguage(wc: WebContents) {\n\t\tconst windowId = this.electron.BrowserWindow.fromWebContents(wc)?.id\n\t\tif (windowId == null) return\n\t\tconst window = this.windowManager.get(windowId)\n\t\twindow?.desktopFacade.showSpellcheckDropdown()\n\t}\n}\n","import o from \"@tutao/otest\"\nimport n from \"../nodemocker.js\"\nimport { DesktopContextMenu } from \"../../../src/common/desktop/DesktopContextMenu.js\"\nimport { downcast } from \"@tutao/tutanota-utils\"\nimport { object } from \"testdouble\"\nimport { WindowManager } from \"../../../src/common/desktop/DesktopWindowManager.js\"\nimport { ContextMenuParams } from \"electron\"\n\no.spec(\"DesktopContextMenu Test\", () => {\n\tconst standardMocks = () => {\n\t\t// node modules\n\t\tconst electron = {\n\t\t\tclipboard: {\n\t\t\t\twriteText: () => {},\n\t\t\t},\n\t\t\tMenu: n.classify({\n\t\t\t\tprototype: {\n\t\t\t\t\tappend: function () {},\n\t\t\t\t\tpopup: function () {},\n\t\t\t\t},\n\t\t\t\tstatics: {},\n\t\t\t}),\n\t\t\tMenuItem: n.classify({\n\t\t\t\tprototype: {\n\t\t\t\t\tenabled: true,\n\t\t\t\t\tconstructor: function (p) {\n\t\t\t\t\t\tObject.assign(this, p)\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tstatics: {},\n\t\t\t}),\n\t\t}\n\t\tconst electronMock = n.mock<typeof import(\"electron\")>(\"electron\", electron).set()\n\t\treturn {\n\t\t\telectronMock,\n\t\t}\n\t}\n\n\to(\"can handle undefined browserWindow and webContents in callback\", () => {\n\t\tconst { electronMock } = standardMocks()\n\t\tconst wm = object<WindowManager>()\n\t\tconst contextMenu = new DesktopContextMenu(electronMock, wm)\n\t\tconst contextMenuParams: Partial<ContextMenuParams> = {\n\t\t\tlinkURL: \"nourl\",\n\t\t\teditFlags: {\n\t\t\t\tcanCut: false,\n\t\t\t\tcanPaste: false,\n\t\t\t\tcanCopy: false,\n\t\t\t\tcanUndo: false,\n\t\t\t\tcanRedo: false,\n\t\t\t\tcanEditRichly: false,\n\t\t\t\tcanDelete: false,\n\t\t\t\tcanSelectAll: false,\n\t\t\t},\n\t\t\tdictionarySuggestions: [],\n\t\t\tmisspelledWord: \"\",\n\t\t}\n\t\tcontextMenu.open(contextMenuParams as ContextMenuParams)\n\t\tfor (const i of downcast(electronMock.MenuItem).mockedInstances) {\n\t\t\ti.click?.(undefined)\n\t\t}\n\t\tfor (const i of downcast(electronMock.MenuItem).mockedInstances) {\n\t\t\ti.click?.(undefined)\n\t\t}\n\t})\n})\n"],"mappings":"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"}