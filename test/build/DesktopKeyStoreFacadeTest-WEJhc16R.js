
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { getFromMap } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import "./Env-D5xGlXfw.js";
import "./CryptoError-PqdvQky4.js";
import { CancelledError } from "./CancelledError-FjP5S_cR.js";
import { DeviceStorageUnavailableError } from "./DeviceStorageUnavailableError-m4Jk_0xN.js";
import { base64ToKey, keyToBase64, uint8ArrayToKey } from "./dist-DcZ1Y4qd.js";
import { log } from "./DesktopLog-yAgEoQsh.js";
import { dist_default } from "./dist-Ci1bEzYU.js";
import "./testdouble-IbRSnrC0.js";
import { assertThrows } from "./dist-BY49f75m.js";
import { spyify } from "./nodemocker-Bh_RUICG.js";

//#region ../src/common/desktop/DesktopKeyStoreFacade.ts
const DeviceKeySpec = Object.freeze({
	serviceName: "tutanota-vault",
	accountName: "tuta",
	cached: true
});
const CredentialsKeySpec = Object.freeze({
	serviceName: "tutanota-credentials",
	accountName: "tutanota-credentials",
	cached: false
});
var DesktopKeyStoreFacade = class {
	resolvedKeys = new Map();
	constructor(secretStorage, crypto) {
		this.secretStorage = secretStorage;
		this.crypto = crypto;
	}
	/**
	* get the key used to encrypt alarms and settings
	*/
	async getDeviceKey() {
		return this.resolveKey(DeviceKeySpec);
	}
	/**
	* get the key used to encrypt saved credentials
	*/
	async getKeyChainKey() {
		return this.resolveKey(CredentialsKeySpec);
	}
	resolveKey(spec) {
		const entry = getFromMap(this.resolvedKeys, spec, () => this.fetchOrGenerateKey(spec));
		if (spec.cached) return entry.catch((e) => {
			this.resolvedKeys.delete(spec);
			throw e;
		});
else return entry.finally(() => {
			this.resolvedKeys.delete(spec);
		});
	}
	async fetchOrGenerateKey(spec) {
		log.debug("resolving key...", spec.serviceName);
		try {
			return await this.fetchKey(spec) ?? await this.generateAndStoreKey(spec);
		} catch (e) {
			log.warn("Failed to resolve/generate key: ", spec.serviceName, e);
			if (e instanceof CancelledError) throw e;
			throw new DeviceStorageUnavailableError("failed to resolve/generate key", e);
		}
	}
	async fetchKey(spec) {
		const base64 = await this.secretStorage.getPassword(spec.serviceName, spec.accountName);
		if (base64 == null) return null;
		return base64ToKey(base64);
	}
	async generateAndStoreKey(spec) {
		log.warn(`key ${spec.serviceName} not found, generating a new one`);
		const key = this.crypto.generateDeviceKey();
		const base64 = keyToBase64(key);
		await this.secretStorage.setPassword(spec.serviceName, spec.accountName, base64);
		return key;
	}
};

//#endregion
//#region tests/desktop/DesktopKeyStoreFacadeTest.ts
function initKeyStoreFacade(secretStorage, crypto) {
	return new DesktopKeyStoreFacade(secretStorage, crypto);
}
dist_default.spec("DesktopKeyStoreFacade", function() {
	const aes256Key = uint8ArrayToKey(new Uint8Array([1, 2]));
	let cryptoFacadeSpy;
	dist_default.beforeEach(function() {
		const stub = { generateDeviceKey: () => uint8ArrayToKey(new Uint8Array([0, 0])) };
		cryptoFacadeSpy = spyify(stub);
	});
	const toSpec = {
		getDeviceKey: DeviceKeySpec,
		getKeyChainKey: CredentialsKeySpec
	};
	for (const [opName, spec] of Object.entries(toSpec)) dist_default.spec(opName, function() {
		dist_default(opName + " should return stored key", async function() {
			const secretStorageSpy = spyify({
				async getPassword(service, account) {
					return keyToBase64(aes256Key);
				},
				async setPassword(service, account, password) {}
			});
			const keyStoreFacade = initKeyStoreFacade(secretStorageSpy, cryptoFacadeSpy);
			const actualKey = await keyStoreFacade[opName]();
			dist_default(actualKey).deepEquals(aes256Key);
			dist_default(secretStorageSpy.getPassword.callCount).equals(1);
			dist_default(secretStorageSpy.getPassword.calls[0]).deepEquals([spec.serviceName, spec.accountName]);
		});
		dist_default("should store the key", async function() {
			const secretStorageSpy = spyify({
				async getPassword(service, account) {
					return null;
				},
				async setPassword(service, account, password) {}
			});
			cryptoFacadeSpy = { generateDeviceKey() {
				return aes256Key;
			} };
			const keyStoreFacade = initKeyStoreFacade(secretStorageSpy, cryptoFacadeSpy);
			await keyStoreFacade[opName]();
			dist_default(secretStorageSpy.setPassword.args).deepEquals([
				spec.serviceName,
				spec.accountName,
				keyToBase64(aes256Key)
			]);
		});
		dist_default(spec.cached ? opName + " should cache successful key fetch" : opName + " should NOT cache successful key fetch", async function() {
			const secretStorageSpy = spyify({
				async getPassword(service, account) {
					return keyToBase64(aes256Key);
				},
				async setPassword(service, account, password) {}
			});
			const keyStoreFacade = initKeyStoreFacade(secretStorageSpy, cryptoFacadeSpy);
			const actualKey = await keyStoreFacade[opName]();
			dist_default(actualKey).deepEquals(aes256Key);
			const actualKey2 = await keyStoreFacade[opName]();
			dist_default(actualKey2).deepEquals(aes256Key);
			if (spec.cached) {
				dist_default(secretStorageSpy.getPassword.callCount).equals(1);
				dist_default(secretStorageSpy.getPassword.calls[0]).deepEquals([spec.serviceName, spec.accountName]);
			} else {
				dist_default(secretStorageSpy.getPassword.callCount).equals(2);
				dist_default(secretStorageSpy.getPassword.calls[1]).deepEquals([spec.serviceName, spec.accountName]);
			}
		});
		dist_default(opName + " should not cache failures", async function() {
			let calls = 0;
			const secretStorageSpy = spyify({
				async getPassword(service, account) {
					if (calls == 0) {
						calls++;
						throw new CancelledError("Test");
					} else {
						calls++;
						return keyToBase64(aes256Key);
					}
				},
				async setPassword(service, account, password) {}
			});
			const keyStoreFacade = initKeyStoreFacade(secretStorageSpy, cryptoFacadeSpy);
			await assertThrows(CancelledError, () => keyStoreFacade[opName]());
			const actualKey = await keyStoreFacade[opName]();
			dist_default(actualKey).deepEquals(aes256Key);
			dist_default(secretStorageSpy.getPassword.callCount).equals(2);
			dist_default(secretStorageSpy.getPassword.calls[1]).deepEquals([spec.serviceName, spec.accountName]);
		});
	});
	dist_default.spec("key storage errors get propagated properly", function() {
		async function testErrorWrapping({ onget, onset, expectError }) {
			const secretStorageSpy = spyify({
				async getPassword(service, account) {
					return onget();
				},
				async setPassword(service, account, password) {
					return onset();
				}
			});
			const keyStoreFacade = initKeyStoreFacade(secretStorageSpy, cryptoFacadeSpy);
			await assertThrows(expectError, () => keyStoreFacade.getDeviceKey());
		}
		dist_default("CancelledError passes through for getPassword", async function() {
			await testErrorWrapping({
				onget: () => {
					throw new CancelledError("getting");
				},
				onset: () => {},
				expectError: CancelledError
			});
		});
		dist_default("CancelledError passes through for setPassword", async function() {
			await testErrorWrapping({
				onget: () => null,
				onset: () => {
					throw new CancelledError("setting");
				},
				expectError: CancelledError
			});
		});
		dist_default("other errors get wrapped for getPassword", async function() {
			await testErrorWrapping({
				onget: () => {
					throw new Error("random get failure");
				},
				onset: () => {},
				expectError: DeviceStorageUnavailableError
			});
		});
		dist_default("other errors get wrapped for setPassword", async function() {
			await testErrorWrapping({
				onget: () => null,
				onset: () => {
					throw new Error("random set failure");
				},
				expectError: DeviceStorageUnavailableError
			});
		});
	});
});

//#endregion
//# sourceMappingURL=DesktopKeyStoreFacadeTest-WEJhc16R.js.map