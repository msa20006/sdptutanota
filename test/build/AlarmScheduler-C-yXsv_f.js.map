{"version":3,"file":"AlarmScheduler-C-yXsv_f.js","names":["dateProvider: DateProvider","scheduler: Scheduler","event: EventInfo","alarmInfo: AlarmInfo","repeatRule: RepeatRule | null","notificationSender: NotificationSender","alarmIdentifier: string","identifier: string","atTime: Date","action: Thunk"],"sources":["../../src/common/calendar/date/AlarmScheduler.ts"],"sourcesContent":["import type { Thunk } from \"@tutao/tutanota-utils\"\nimport { downcast } from \"@tutao/tutanota-utils\"\nimport { EndType } from \"../../../common/api/common/TutanotaConstants.js\"\nimport type { AlarmInfo, RepeatRule } from \"../../../common/api/entities/sys/TypeRefs.js\"\nimport type { ScheduledTimeoutId, Scheduler } from \"../../../common/api/common/utils/Scheduler.js\"\nimport { calculateAlarmTime, findNextAlarmOccurrence, getEventStartByTimes, getValidTimeZone, parseAlarmInterval } from \"./CalendarUtils.js\"\nimport { DateProvider } from \"../../../common/api/common/DateProvider.js\"\n\ntype NotificationSender = (eventTime: Date, summary: string) => void\ntype EventInfo = {\n\tstartTime: Date\n\tendTime: Date\n\tsummary: string\n}\n\n/**\n * knows how to translate a given calendar event with alarms into an\n * actual function call that is executed some time later (and maybe displays a notification).\n *\n * should stay independent of the way the actual notification is sent + rendered\n */\nexport class AlarmScheduler {\n\treadonly _scheduledNotifications: Map<string, ScheduledTimeoutId>\n\treadonly _scheduler: Scheduler\n\treadonly _dateProvider: DateProvider\n\n\tconstructor(dateProvider: DateProvider, scheduler: Scheduler) {\n\t\tthis._dateProvider = dateProvider\n\t\tthis._scheduledNotifications = new Map()\n\t\tthis._scheduler = scheduler\n\t}\n\n\tscheduleAlarm(event: EventInfo, alarmInfo: AlarmInfo, repeatRule: RepeatRule | null, notificationSender: NotificationSender): void {\n\t\tconst localZone = this._dateProvider.timeZone()\n\n\t\tif (repeatRule) {\n\t\t\tlet repeatTimeZone = getValidTimeZone(repeatRule.timeZone, localZone)\n\t\t\tlet calculationLocalZone = getValidTimeZone(localZone)\n\t\t\tconst nextOccurrence = findNextAlarmOccurrence(\n\t\t\t\tnew Date(this._dateProvider.now()),\n\t\t\t\trepeatTimeZone,\n\t\t\t\tevent.startTime,\n\t\t\t\tevent.endTime,\n\t\t\t\tdowncast(repeatRule.frequency),\n\t\t\t\tNumber(repeatRule.interval),\n\t\t\t\tdowncast(repeatRule.endType) || EndType.Never,\n\t\t\t\tNumber(repeatRule.endValue),\n\t\t\t\trepeatRule.excludedDates.map(({ date }) => date),\n\t\t\t\tparseAlarmInterval(alarmInfo.trigger),\n\t\t\t\tcalculationLocalZone,\n\t\t\t)\n\n\t\t\tif (nextOccurrence) {\n\t\t\t\tthis._scheduleAction(alarmInfo.alarmIdentifier, nextOccurrence.alarmTime, () => {\n\t\t\t\t\tnotificationSender(nextOccurrence.eventTime, event.summary)\n\n\t\t\t\t\t// Schedule next occurrence\n\t\t\t\t\tthis.scheduleAlarm(event, alarmInfo, repeatRule, notificationSender)\n\t\t\t\t})\n\t\t\t}\n\t\t} else {\n\t\t\tconst eventStart = getEventStartByTimes(event.startTime, event.endTime, localZone)\n\n\t\t\tif (eventStart.getTime() > this._dateProvider.now()) {\n\t\t\t\tthis._scheduleAction(alarmInfo.alarmIdentifier, calculateAlarmTime(eventStart, parseAlarmInterval(alarmInfo.trigger)), () =>\n\t\t\t\t\tnotificationSender(eventStart, event.summary),\n\t\t\t\t)\n\t\t\t}\n\t\t}\n\t}\n\n\tcancelAlarm(alarmIdentifier: string) {\n\t\t// try to cancel single first\n\t\tthis._cancelOccurrence(alarmIdentifier)\n\t}\n\n\t_cancelOccurrence(alarmIdentifier: string) {\n\t\tconst timeoutId = this._scheduledNotifications.get(alarmIdentifier)\n\n\t\tif (timeoutId != null) {\n\t\t\tthis._scheduler.unscheduleTimeout(timeoutId)\n\t\t}\n\t}\n\n\t_scheduleAction(identifier: string, atTime: Date, action: Thunk) {\n\t\tconst scheduledId = this._scheduler.scheduleAt(action, atTime)\n\n\t\tthis._scheduledNotifications.set(identifier, scheduledId)\n\t}\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAqBa,iBAAN,MAAqB;CAC3B,AAAS;CACT,AAAS;CACT,AAAS;CAET,YAAYA,cAA4BC,WAAsB;AAC7D,OAAK,gBAAgB;AACrB,OAAK,0BAA0B,IAAI;AACnC,OAAK,aAAa;CAClB;CAED,cAAcC,OAAkBC,WAAsBC,YAA+BC,oBAA8C;EAClI,MAAM,YAAY,KAAK,cAAc,UAAU;AAE/C,MAAI,YAAY;GACf,IAAI,iBAAiB,iBAAiB,WAAW,UAAU,UAAU;GACrE,IAAI,uBAAuB,iBAAiB,UAAU;GACtD,MAAM,iBAAiB,wBACtB,IAAI,KAAK,KAAK,cAAc,KAAK,GACjC,gBACA,MAAM,WACN,MAAM,SACN,SAAS,WAAW,UAAU,EAC9B,OAAO,WAAW,SAAS,EAC3B,SAAS,WAAW,QAAQ,IAAI,QAAQ,OACxC,OAAO,WAAW,SAAS,EAC3B,WAAW,cAAc,IAAI,CAAC,EAAE,MAAM,KAAK,KAAK,EAChD,mBAAmB,UAAU,QAAQ,EACrC,qBACA;AAED,OAAI,eACH,MAAK,gBAAgB,UAAU,iBAAiB,eAAe,WAAW,MAAM;AAC/E,uBAAmB,eAAe,WAAW,MAAM,QAAQ;AAG3D,SAAK,cAAc,OAAO,WAAW,YAAY,mBAAmB;GACpE,EAAC;EAEH,OAAM;GACN,MAAM,aAAa,qBAAqB,MAAM,WAAW,MAAM,SAAS,UAAU;AAElF,OAAI,WAAW,SAAS,GAAG,KAAK,cAAc,KAAK,CAClD,MAAK,gBAAgB,UAAU,iBAAiB,mBAAmB,YAAY,mBAAmB,UAAU,QAAQ,CAAC,EAAE,MACtH,mBAAmB,YAAY,MAAM,QAAQ,CAC7C;EAEF;CACD;CAED,YAAYC,iBAAyB;AAEpC,OAAK,kBAAkB,gBAAgB;CACvC;CAED,kBAAkBA,iBAAyB;EAC1C,MAAM,YAAY,KAAK,wBAAwB,IAAI,gBAAgB;AAEnE,MAAI,aAAa,KAChB,MAAK,WAAW,kBAAkB,UAAU;CAE7C;CAED,gBAAgBC,YAAoBC,QAAcC,QAAe;EAChE,MAAM,cAAc,KAAK,WAAW,WAAW,QAAQ,OAAO;AAE9D,OAAK,wBAAwB,IAAI,YAAY,YAAY;CACzD;AACD"}