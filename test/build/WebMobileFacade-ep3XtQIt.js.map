{"version":3,"file":"WebMobileFacade-ep3XtQIt.js","names":["connectivityModel: WebsocketConnectivityModel","baseViewPrefix: string","currentView: TopLevelView | null","visibility: boolean","newSize: number"],"sources":["../../src/common/native/main/WebMobileFacade.ts"],"sourcesContent":["import m from \"mithril\"\nimport { assertMainOrNode } from \"../../api/common/Env\"\nimport { modal } from \"../../gui/base/Modal\"\nimport { CALENDAR_PREFIX, CONTACTS_PREFIX, MAIL_PREFIX, SEARCH_PREFIX, SETTINGS_PREFIX } from \"../../misc/RouteChange\"\nimport { last } from \"@tutao/tutanota-utils\"\nimport { CloseEventBusOption, MailSetKind, SECOND_MS } from \"../../api/common/TutanotaConstants.js\"\nimport { MobileFacade } from \"../common/generatedipc/MobileFacade.js\"\nimport { styles } from \"../../gui/styles\"\nimport { WebsocketConnectivityModel } from \"../../misc/WebsocketConnectivityModel.js\"\nimport { MailboxModel } from \"../../mailFunctionality/MailboxModel.js\"\nimport { TopLevelView } from \"../../../TopLevelView.js\"\nimport stream from \"mithril/stream\"\nimport { CalendarViewType } from \"../../api/common/utils/CommonCalendarUtils.js\"\n\nassertMainOrNode()\n\n/**\n * Handles press of the android back button. Returns true if the action has been processed by the application.\n * False if the caller must handle the button press (quit the application)\n */\nexport class WebMobileFacade implements MobileFacade {\n\tprivate disconnectTimeoutId: TimeoutID | null\n\n\tprivate isAppVisible: stream<boolean> = stream(false)\n\n\tconstructor(private readonly connectivityModel: WebsocketConnectivityModel, private readonly baseViewPrefix: string) {}\n\n\tpublic getIsAppVisible(): stream<boolean> {\n\t\treturn this.isAppVisible\n\t}\n\n\tasync handleBackPress(): Promise<boolean> {\n\t\tawait Promise.resolve()\n\t\tconst lastModalComponent = last(modal.components)\n\n\t\tif (lastModalComponent) {\n\t\t\t// first check if any modal dialog is visible\n\t\t\tlastModalComponent.component.onClose()\n\t\t\treturn true\n\t\t} else {\n\t\t\t// otherwise try to navigate back in the current view\n\t\t\tconst viewSlider = window.tutao.currentView?.getViewSlider?.()\n\n\t\t\tconst currentRoute = m.route.get()\n\n\t\t\t// If the sidebar is opened, close it\n\t\t\tif (viewSlider && viewSlider.isForegroundColumnFocused()) {\n\t\t\t\tviewSlider.focusNextColumn()\n\t\t\t\treturn true\n\t\t\t} else if (this.handlesBackButtonViaCurrentView()) {\n\t\t\t\treturn true\n\t\t\t} else if (\n\t\t\t\tviewSlider &&\n\t\t\t\tviewSlider.focusedColumn !== viewSlider.getMainColumn() &&\n\t\t\t\tstyles.isSingleColumnLayout() &&\n\t\t\t\tviewSlider.isFocusPreviousPossible()\n\t\t\t) {\n\t\t\t\t// current view can navigate back, a region column is focused (not main) and is in singleColumnLayout\n\t\t\t\tviewSlider.focusPreviousColumn()\n\t\t\t\treturn true\n\t\t\t} else if (currentRoute.startsWith(CALENDAR_PREFIX)) {\n\t\t\t\tif (history.state?.origin === CalendarViewType.MONTH) {\n\t\t\t\t\tconst date = history.state.dateString ?? new Date().toISOString().substring(0, 10)\n\t\t\t\t\tm.route.set(\"/calendar/:view/:date\", {\n\t\t\t\t\t\tview: CalendarViewType.MONTH,\n\t\t\t\t\t\tdate,\n\t\t\t\t\t})\n\t\t\t\t\treturn true\n\t\t\t\t}\n\n\t\t\t\tif (this.baseViewPrefix === CALENDAR_PREFIX) {\n\t\t\t\t\t// we are at the main view and want to exit the app\n\t\t\t\t\treturn false\n\t\t\t\t} else {\n\t\t\t\t\tm.route.set(this.baseViewPrefix)\n\t\t\t\t\treturn true\n\t\t\t\t}\n\t\t\t} else if (currentRoute.startsWith(CONTACTS_PREFIX) || currentRoute.startsWith(SETTINGS_PREFIX) || currentRoute.startsWith(SEARCH_PREFIX)) {\n\t\t\t\t// go back to mail or calendar from other paths\n\t\t\t\tm.route.set(this.baseViewPrefix)\n\t\t\t\treturn true\n\t\t\t} else {\n\t\t\t\treturn false\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate handlesBackButtonViaCurrentView(): boolean {\n\t\tconst currentView: TopLevelView | null = window.tutao.currentView\n\t\treturn currentView?.handleBackButton != null && currentView.handleBackButton()\n\t}\n\n\tasync visibilityChange(visibility: boolean): Promise<void> {\n\t\tconsole.log(\"native visibility change\", visibility)\n\t\tthis.isAppVisible(visibility)\n\n\t\tif (visibility) {\n\t\t\tif (this.disconnectTimeoutId != null) {\n\t\t\t\tclearTimeout(this.disconnectTimeoutId)\n\t\t\t\tthis.disconnectTimeoutId = null\n\t\t\t}\n\n\t\t\treturn this.connectivityModel.tryReconnect(false, true)\n\t\t} else {\n\t\t\tthis.disconnectTimeoutId = setTimeout(() => {\n\t\t\t\tthis.connectivityModel.close(CloseEventBusOption.Pause)\n\t\t\t}, 30 * SECOND_MS)\n\t\t}\n\t}\n\n\tasync keyboardSizeChanged(newSize: number): Promise<void> {\n\t\tconst { windowFacade } = await import(\"../../misc/WindowFacade.js\")\n\t\treturn windowFacade.onKeyboardSizeChanged(newSize)\n\t}\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAcA,kBAAkB;IAML,kBAAN,MAA8C;CACpD,AAAQ;CAER,AAAQ,eAAgC,2BAAO,MAAM;CAErD,YAA6BA,mBAAgEC,gBAAwB;EA0FrH,KA1F6B;EA0F5B,KA1F4F;CAA0B;CAEvH,AAAO,kBAAmC;AACzC,SAAO,KAAK;CACZ;CAED,MAAM,kBAAoC;AACzC,QAAM,QAAQ,SAAS;EACvB,MAAM,qBAAqB,KAAK,MAAM,WAAW;AAEjD,MAAI,oBAAoB;AAEvB,sBAAmB,UAAU,SAAS;AACtC,UAAO;EACP,OAAM;GAEN,MAAM,aAAa,OAAO,MAAM,aAAa,iBAAiB;GAE9D,MAAM,eAAe,gBAAE,MAAM,KAAK;AAGlC,OAAI,cAAc,WAAW,2BAA2B,EAAE;AACzD,eAAW,iBAAiB;AAC5B,WAAO;GACP,WAAU,KAAK,iCAAiC,CAChD,QAAO;SAEP,cACA,WAAW,kBAAkB,WAAW,eAAe,IACvD,OAAO,sBAAsB,IAC7B,WAAW,yBAAyB,EACnC;AAED,eAAW,qBAAqB;AAChC,WAAO;GACP,WAAU,aAAa,WAAW,gBAAgB,EAAE;AACpD,QAAI,QAAQ,OAAO,WAAW,iBAAiB,OAAO;KACrD,MAAM,OAAO,QAAQ,MAAM,cAAc,IAAI,OAAO,aAAa,CAAC,UAAU,GAAG,GAAG;AAClF,qBAAE,MAAM,IAAI,yBAAyB;MACpC,MAAM,iBAAiB;MACvB;KACA,EAAC;AACF,YAAO;IACP;AAED,QAAI,KAAK,mBAAmB,gBAE3B,QAAO;KACD;AACN,qBAAE,MAAM,IAAI,KAAK,eAAe;AAChC,YAAO;IACP;GACD,WAAU,aAAa,WAAW,gBAAgB,IAAI,aAAa,WAAW,gBAAgB,IAAI,aAAa,WAAW,cAAc,EAAE;AAE1I,oBAAE,MAAM,IAAI,KAAK,eAAe;AAChC,WAAO;GACP,MACA,QAAO;EAER;CACD;CAED,AAAQ,kCAA2C;EAClD,MAAMC,cAAmC,OAAO,MAAM;AACtD,SAAO,aAAa,oBAAoB,QAAQ,YAAY,kBAAkB;CAC9E;CAED,MAAM,iBAAiBC,YAAoC;AAC1D,UAAQ,IAAI,4BAA4B,WAAW;AACnD,OAAK,aAAa,WAAW;AAE7B,MAAI,YAAY;AACf,OAAI,KAAK,uBAAuB,MAAM;AACrC,iBAAa,KAAK,oBAAoB;AACtC,SAAK,sBAAsB;GAC3B;AAED,UAAO,KAAK,kBAAkB,aAAa,OAAO,KAAK;EACvD,MACA,MAAK,sBAAsB,WAAW,MAAM;AAC3C,QAAK,kBAAkB,MAAM,oBAAoB,MAAM;EACvD,GAAE,KAAK,UAAU;CAEnB;CAED,MAAM,oBAAoBC,SAAgC;EACzD,MAAM,EAAE,cAAc,GAAG,MAAM,OAAO;AACtC,SAAO,aAAa,sBAAsB,QAAQ;CAClD;AACD"}