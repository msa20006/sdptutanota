
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { mithril_default } from "./mithril-Csg4iNnm.js";
import { assertNotNull, defer, delay, neverNull, noOp, ofClass } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import { LOGIN_TITLE, isAdminClient, isApp, isDesktop } from "./Env-D5xGlXfw.js";
import { getThemeCustomizations } from "./WhitelabelCustomizations-D1L5qbZi.js";
import { lang } from "./LanguageViewModel-BNC5ekpO.js";
import "./HtmlUtils-C-ecR7U7.js";
import "./ClientDetector-D0v6Vqu6.js";
import { CloseEventBusOption, Const, SecondFactorType } from "./TutanotaConstants-3bwAESYA.js";
import { ButtonType } from "./Icon-BuqNK7vz.js";
import "./Icons-Dl3nFav5.js";
import "./KeyManager-B0OGXEyJ.js";
import { windowFacade } from "./WindowFacade-B9kSBKw7.js";
import "./Modal-g4c-b9IU.js";
import { Dialog } from "./Dialog-B6-HFvZd.js";
import "./CountryList-DkVQtcTj.js";
import "./IconButton-DsU60HJ_.js";
import { LockedError } from "./RestError-D17JEBMr.js";
import "./SuspensionError-okvIjE4H.js";
import "./LoginIncompleteError-CpiW0a0l.js";
import "./CryptoError-PqdvQky4.js";
import "./error-DDmy0eAT.js";
import "./ErrorUtils-o1-v67Dd.js";
import "./RecipientsNotFoundError-D8oGE7A_.js";
import "./OfflineDbClosedError-CAwHTI6J.js";
import "./OutOfSyncError-Ck2yBBO8.js";
import "./DbError-CcwZaPG2.js";
import "./QuotaExceededError-nFM6SdTn.js";
import "./CancelledError-FjP5S_cR.js";
import "./FileOpenError-C1_8yoXr.js";
import "./DeviceStorageUnavailableError-m4Jk_0xN.js";
import "./MailBodyTooLargeError-C2i0rX_0.js";
import "./ImportError-CIXw37Kv.js";
import "./PermissionError-BGDsHuAh.js";
import "./KeyPermanentlyInvalidatedError-DJjt81rl.js";
import "./ParserCombinator-D38ofgFx.js";
import "./ExportError-DzgStBnl.js";
import "./stream-u2PttBAC.js";
import "./luxon-D6cgmg6Q.js";
import "./EntityUtils-RQxXZlcV.js";
import "./CommonCalendarUtils-DKaO7v1K.js";
import { getHourCycle } from "./Formatter-zB15D6XI.js";
import "./TypeModels-XIXYys8J.js";
import { createReceiveInfoServiceData } from "./TypeRefs-CR3TLWn0.js";
import "./TypeModels-BktRFNDN.js";
import { CustomerTypeRef, SecondFactorTypeRef, createCustomerProperties } from "./TypeRefs-BP1jvX9p.js";
import "./CalendarUtils-C6jeYrj9.js";
import { notifications } from "./Notifications-DLibQbV7.js";
import "./EntityFunctions-l6CncM5C.js";
import "./TypeModels-ZqCk-pGw.js";
import "./ModelInfo-DEa-Yxv2.js";
import { ReceiveInfoService } from "./Services-DCx-CeM7.js";
import { isUpdateForTypeRef } from "./EntityUpdateUtils-B5iTKMk4.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import "./ImportExportUtils-B1MoOmZ0.js";
import "./FormatValidator-2BBermUe.js";
import "./UserError-DfXlMLTl.js";
import "./MailAddressParser-BgYy6oyp.js";
import "./GroupUtils-0ZkLIAeC.js";
import "./DataFile-CY7uuk9j.js";
import "./FileUtils-W-u2-gZz.js";
import "./ProgressDialog-CJfJjh62.js";
import "./BlobUtils-D5ADcckZ.js";
import "./SharedMailUtils-AmFaSJP6.js";
import "./PasswordUtils-C4jlV9GF.js";
import "./Recipient-BFxhfecW.js";
import { showMoreStorageNeededOrderDialog } from "./SubscriptionDialogs-DAlWs68I.js";
import "./ExternalLink-rsCBSC7U.js";
import "./ToggleButton-DxuDa0rS.js";
import "./SnackBar-CoP3lSVs.js";
import "./Credentials-BM35X_na.js";
import { show } from "./NotificationOverlay-C-YNCUiT.js";
import "./Checkbox-WCw-l_7A.js";
import "./Expander-Bautb1_0.js";
import "./ClipboardUtils-mz40UK5S.js";
import "./ErrorReporter-7sfLhWZg.js";
import "./Services-CupYet_j.js";
import "./BubbleButton-DGGInJMg.js";
import { SessionType } from "./SessionType-rxSDsswH.js";
import "./PasswordField-CPKPoLq8.js";
import "./PasswordRequestDialog-B7ZIVTVw.js";
import "./ErrorHandlerImpl-DRpk8tE9.js";
import { deviceConfig } from "./DeviceConfig-payZM407.js";
import "./RestClient-CmoHrId4.js";
import { CredentialEncryptionMode } from "./CredentialEncryptionMode-BR0DkQpJ.js";
import { checkApprovalStatus } from "./LoginViewModel-BX-8ry63.js";
import "./LoginButton-DzCRy0Yt.js";
import { isNotificationCurrentlyActive, loadOutOfOfficeNotification, shouldShowStorageWarning, shouldShowUpgradeReminder } from "./PostLoginUtils-D4m5U8Kf.js";
import "./CredentialType-DXeA2MQH.js";
import { usingKeychainAuthenticationWithOptions } from "./CredentialsProvider-HbB_U0ec.js";
import { StorageBehavior } from "./UsageTestModel-CjGx3RZo.js";

//#region ../src/common/login/PostLoginActions.ts
var PostLoginActions = class {
	constructor(credentialsProvider, secondFactorHandler, connectivityModel, logins, dateProvider, entityClient, userManagementFacade, customerFacade, themeController, showSetupWizard, syncExternalCalendars, setUpClientOnlyCalendars) {
		this.credentialsProvider = credentialsProvider;
		this.secondFactorHandler = secondFactorHandler;
		this.connectivityModel = connectivityModel;
		this.logins = logins;
		this.dateProvider = dateProvider;
		this.entityClient = entityClient;
		this.userManagementFacade = userManagementFacade;
		this.customerFacade = customerFacade;
		this.themeController = themeController;
		this.showSetupWizard = showSetupWizard;
		this.syncExternalCalendars = syncExternalCalendars;
		this.setUpClientOnlyCalendars = setUpClientOnlyCalendars;
	}
	async onPartialLoginSuccess(loggedInEvent) {
		windowFacade.addOnlineListener(() => {
			console.log(new Date().toISOString(), "online - try reconnect");
			if (this.logins.isFullyLoggedIn()) this.connectivityModel.tryReconnect(true, true, 2e3);
else this.logins.retryAsyncLogin();
		});
		windowFacade.addOfflineListener(() => {
			console.log(new Date().toISOString(), "offline - pause event bus");
			this.connectivityModel.close(CloseEventBusOption.Pause);
		});
		if (!this.logins.getUserController().isInternalUser()) {
			if (document.title === LOGIN_TITLE) document.title = "Tuta Mail";
			return;
		} else {
			let postLoginTitle = document.title === LOGIN_TITLE ? "Tuta Mail" : document.title;
			document.title = neverNull(this.logins.getUserController().userGroupInfo.mailAddress) + " - " + postLoginTitle;
		}
		notifications.requestPermission();
		if (loggedInEvent.sessionType === SessionType.Persistent && usingKeychainAuthenticationWithOptions() && await this.credentialsProvider.getCredentialEncryptionMode() == null) await this.credentialsProvider.setCredentialEncryptionMode(CredentialEncryptionMode.DEVICE_LOCK);
		lang.updateFormats({ hourCycle: getHourCycle(this.logins.getUserController().userSettingsGroupRoot) });
		if (isApp() || isDesktop()) await this.storeNewCustomThemes();
	}
	async onFullLoginSuccess(loggedInEvent) {
		if (loggedInEvent.sessionType === SessionType.Temporary || !this.logins.getUserController().isInternalUser()) return;
		this.fullLoginAsyncActions();
		this.showSetupWizardIfNeeded();
	}
	checkApprovalAfterSync() {
		const listenerDeferral = defer();
		const listener = async (updates) => {
			const customer = this.logins.getUserController().user.customer;
			const isCustomerUpdate = updates.some((update) => isUpdateForTypeRef(CustomerTypeRef, update) && update.instanceId === customer);
			if (customer != null && isCustomerUpdate) listenerDeferral.resolve();
		};
		locator.eventController.addEntityListener(listener);
		const timeoutPromise = delay(2e3);
		return Promise.race([listenerDeferral.promise, timeoutPromise]).then(() => {
			locator.eventController.removeEntityListener(listener);
			checkApprovalStatus(this.logins, true);
		});
	}
	async fullLoginAsyncActions() {
		this.checkApprovalAfterSync();
		await this.showUpgradeReminderIfNeeded();
		await this.checkStorageLimit();
		this.secondFactorHandler.setupAcceptOtherClientLoginListener();
		if (!isAdminClient()) {
			await locator.mailboxModel.init();
			const calendarModel = await locator.calendarModel();
			await calendarModel.init();
			await this.remindActiveOutOfOfficeNotification();
		}
		if (isApp() || isDesktop()) {
			if (isApp() && deviceConfig.getIsSetupComplete() || isDesktop()) await locator.pushService.register();
else console.log("Skipping registering for notifications while setup dialog is shown");
			this.syncExternalCalendars();
		}
		this.setUpClientOnlyCalendars();
		if (this.logins.isGlobalAdminUserLoggedIn() && !isAdminClient()) {
			const receiveInfoData = createReceiveInfoServiceData({ language: lang.code });
			locator.serviceExecutor.post(ReceiveInfoService, receiveInfoData);
		}
		this.enforcePasswordChange();
		const usageTestModel = locator.usageTestModel;
		await usageTestModel.init();
		usageTestModel.setStorageBehavior(StorageBehavior.Persist);
		locator.usageTestController.setTests(await usageTestModel.loadActiveUsageTests());
		await locator.newsModel.loadNewsIds();
		mithril_default.redraw();
	}
	deactivateOutOfOfficeNotification(notification) {
		notification.enabled = false;
		return this.entityClient.update(notification);
	}
	remindActiveOutOfOfficeNotification() {
		return loadOutOfOfficeNotification().then((notification) => {
			if (notification && isNotificationCurrentlyActive(notification, new Date())) {
				const notificationMessage = { view: () => {
					return mithril_default("", lang.get("outOfOfficeReminder_label"));
				} };
				show(notificationMessage, { label: "close_alt" }, [{
					label: "deactivate_action",
					click: () => this.deactivateOutOfOfficeNotification(notification),
					type: ButtonType.Primary
				}]);
			}
		});
	}
	async storeNewCustomThemes() {
		const domainInfoAndConfig = await this.logins.getUserController().loadWhitelabelConfig();
		if (domainInfoAndConfig && domainInfoAndConfig.whitelabelConfig.jsonTheme) {
			const customizations = getThemeCustomizations(domainInfoAndConfig.whitelabelConfig);
			if (Object.keys(customizations).length > 0) {
				if (!customizations.themeId) customizations.themeId = domainInfoAndConfig.domainInfo.domain;
				await this.themeController.storeCustomThemeForCustomizations(customizations);
				const previouslySavedThemes = await this.themeController.getCustomThemes();
				const isExistingTheme = previouslySavedThemes.includes(domainInfoAndConfig.domainInfo.domain);
				if (isExistingTheme) await this.themeController.reloadTheme();
			}
		}
	}
	async checkStorageLimit() {
		if (await shouldShowStorageWarning(this.logins.getUserController(), this.userManagementFacade, this.customerFacade)) await showMoreStorageNeededOrderDialog("insufficientStorageWarning_msg");
	}
	async showUpgradeReminderIfNeeded() {
		if (await shouldShowUpgradeReminder(this.logins.getUserController(), new Date(this.dateProvider.now()))) {
			const confirmed = await Dialog.reminder(lang.get("upgradeReminderTitle_msg"), lang.get("premiumOffer_msg"));
			if (confirmed) {
				const wizard = await import("./UpgradeSubscriptionWizard-CBu6JZbq.js");
				await wizard.showUpgradeWizard(this.logins);
			}
			const newCustomerProperties = createCustomerProperties(await this.logins.getUserController().loadCustomerProperties());
			newCustomerProperties.lastUpgradeReminder = new Date(this.dateProvider.now());
			this.entityClient.update(newCustomerProperties).catch(ofClass(LockedError, noOp));
		}
	}
	async enforcePasswordChange() {
		if (this.logins.getUserController().user.requirePasswordUpdate) {
			const { showChangeOwnPasswordDialog } = await import("./ChangePasswordDialogs-DmsK7o8b.js");
			await showChangeOwnPasswordDialog(false);
		}
		if (location.hostname === Const.DEFAULT_APP_DOMAIN) {
			const user = this.logins.getUserController().user;
			const secondFactors = await this.entityClient.loadAll(SecondFactorTypeRef, assertNotNull(user.auth).secondFactors);
			const webauthnFactors = secondFactors.filter((f) => f.type === SecondFactorType.webauthn || f.type === SecondFactorType.u2f);
			if (webauthnFactors.length > 0 && !webauthnFactors.some((f) => f.u2f && f.u2f?.appId == Const.WEBAUTHN_RP_ID)) {
				const dialog = Dialog.confirmMultiple("noKeysForThisDomain_msg", [{
					label: "skip_action",
					type: ButtonType.Secondary,
					click: () => dialog.close()
				}, {
					label: "settings_label",
					type: ButtonType.Primary,
					click: () => {
						dialog.close();
						mithril_default.route.set("/settings/login");
					}
				}]);
			}
		}
	}
	async showSetupWizardIfNeeded() {
		const isSetupComplete = deviceConfig.getIsSetupComplete();
		if (isApp() && !isSetupComplete) await this.showSetupWizard();
	}
};

//#endregion
export { PostLoginActions };
//# sourceMappingURL=PostLoginActions-_11wBBmn.js.map