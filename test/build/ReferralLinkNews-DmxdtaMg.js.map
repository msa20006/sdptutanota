{"version":3,"file":"ReferralLinkNews-DmxdtaMg.js","names":["vnode: Vnode<ReferralLinkAttrs>","referralLink: string","userController: UserController","newsModel: NewsModel","dateProvider: DateProvider","userController: UserController","newsId: NewsId","buttonAttrs: Array<ButtonAttrs>","m"],"sources":["../../src/common/misc/news/items/ReferralLinkViewer.ts","../../src/common/misc/news/items/ReferralLinkNews.ts"],"sourcesContent":["import { InfoLink, lang } from \"../../LanguageViewModel.js\"\nimport { isApp } from \"../../../api/common/Env.js\"\nimport { locator } from \"../../../api/main/CommonLocator.js\"\nimport { copyToClipboard } from \"../../ClipboardUtils.js\"\nimport { showSnackBar } from \"../../../gui/base/SnackBar.js\"\nimport { createReferralCodePostIn } from \"../../../api/entities/sys/TypeRefs.js\"\nimport { ReferralCodeService } from \"../../../api/entities/sys/Services.js\"\nimport { TextField, TextFieldAttrs } from \"../../../gui/base/TextField.js\"\nimport m, { Children, Component, Vnode } from \"mithril\"\nimport { IconButton } from \"../../../gui/base/IconButton.js\"\nimport { BootIcons } from \"../../../gui/base/icons/BootIcons.js\"\nimport { ButtonSize } from \"../../../gui/base/ButtonSize.js\"\nimport { Icons } from \"../../../gui/base/icons/Icons.js\"\nimport { ifAllowedTutaLinks } from \"../../../gui/base/GuiUtils.js\"\nimport { UserController } from \"../../../api/main/UserController.js\"\nimport { MoreInfoLink } from \"../MoreInfoLink.js\"\n\nexport type ReferralLinkAttrs = {\n\treferralLink: string\n}\n\n/**\n * Component to display the sharable referral link.\n */\nexport class ReferralLinkViewer implements Component<ReferralLinkAttrs> {\n\tview(vnode: Vnode<ReferralLinkAttrs>): Children {\n\t\treturn m(\".scroll\", [\n\t\t\tm(\".h4\", lang.get(\"referralSettings_label\")),\n\t\t\tm(\"\", lang.get(\"referralLinkLong_msg\")),\n\t\t\tm(TextField, this.getReferralLinkTextFieldAttrs(vnode.attrs.referralLink)),\n\t\t])\n\t}\n\n\tgetReferralLinkTextFieldAttrs(referralLink: string): TextFieldAttrs {\n\t\treturn {\n\t\t\tisReadOnly: true,\n\t\t\tlabel: \"referralLink_label\",\n\t\t\tvalue: referralLink,\n\t\t\tinjectionsRight: () => this.renderButtons(referralLink),\n\t\t\thelpLabel: () => ifAllowedTutaLinks(locator.logins, InfoLink.ReferralLink, (link) => [m(MoreInfoLink, { link: link })]),\n\t\t}\n\t}\n\n\tprivate renderButtons(referralLink: string): Children {\n\t\tif (referralLink === \"\") {\n\t\t\treturn [] // referral link not available yet\n\t\t}\n\n\t\treturn [\n\t\t\tm(IconButton, {\n\t\t\t\ttitle: \"copy_action\",\n\t\t\t\tclick: () => this.copyAction(referralLink),\n\t\t\t\ticon: Icons.Copy,\n\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t}),\n\t\t\tm(IconButton, {\n\t\t\t\ttitle: \"share_action\",\n\t\t\t\tclick: () => this.shareAction(referralLink),\n\t\t\t\ticon: BootIcons.Share,\n\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t}),\n\t\t]\n\t}\n\n\tprivate async copyAction(referralLink: string): Promise<void> {\n\t\tawait copyToClipboard(referralLink)\n\t\tawait showSnackBar({\n\t\t\tmessage: \"linkCopied_msg\",\n\t\t\tbutton: {\n\t\t\t\tlabel: \"close_alt\",\n\t\t\t\tclick: () => {},\n\t\t\t},\n\t\t})\n\t}\n\n\tprivate async shareAction(referralLink: string): Promise<void> {\n\t\tif (isApp()) {\n\t\t\t// open native share dialog on mobile\n\t\t\tconst shareMessage = this.getReferralLinkMessage(referralLink)\n\t\t\treturn locator.systemFacade.shareText(shareMessage, lang.get(\"referralSettings_label\")).then()\n\t\t} else {\n\t\t\t// otherwise share via MailEditor\n\t\t\timport(\"../../../../mail-app/mail/editor/MailEditor.js\").then((mailEditorModule) => mailEditorModule.writeInviteMail(referralLink))\n\t\t}\n\t}\n\n\tprivate getReferralLinkMessage(referralLink: string): string {\n\t\treturn lang.get(\"referralLinkShare_msg\", {\n\t\t\t\"{referralLink}\": referralLink,\n\t\t})\n\t}\n}\n\n/**\n * Get the referral link for the logged-in user\n */\nexport async function getReferralLink(userController: UserController): Promise<string> {\n\tconst customer = await userController.loadCustomer()\n\tconst referralCode = customer.referralCode ? customer.referralCode : await requestNewReferralCode()\n\tconst referralBaseUrl = locator.domainConfigProvider().getCurrentDomainConfig().referralBaseUrl\n\tconst referralUrl = new URL(referralBaseUrl)\n\treferralUrl.searchParams.set(\"ref\", referralCode)\n\treturn referralUrl.href\n}\n\nasync function requestNewReferralCode(): Promise<string> {\n\tconst { referralCode } = await locator.serviceExecutor.post(ReferralCodeService, createReferralCodePostIn({}))\n\treturn referralCode\n}\n","import { NewsListItem } from \"../NewsListItem.js\"\nimport m, { Children } from \"mithril\"\nimport { NewsId } from \"../../../api/entities/tutanota/TypeRefs.js\"\nimport { Button, ButtonAttrs, ButtonType } from \"../../../gui/base/Button.js\"\nimport { NewsModel } from \"../NewsModel.js\"\nimport { getReferralLink, ReferralLinkViewer } from \"./ReferralLinkViewer.js\"\nimport { DateProvider } from \"../../../api/common/DateProvider.js\"\nimport { generatedIdToTimestamp } from \"../../../api/common/utils/EntityUtils.js\"\nimport { getDayShifted, neverNull } from \"@tutao/tutanota-utils\"\nimport { UserController } from \"../../../api/main/UserController.js\"\n\nconst REFERRAL_NEWS_DISPLAY_THRESHOLD_DAYS = 7\n\n/**\n * News item that informs users about option to refer friends. Only shown after the customer exists at least 7 days.\n *\n * Not shown for non-admin users.\n */\nexport class ReferralLinkNews implements NewsListItem {\n\tprivate referralLink: string = \"\"\n\n\tconstructor(private readonly newsModel: NewsModel, private readonly dateProvider: DateProvider, private readonly userController: UserController) {}\n\n\tasync isShown(): Promise<boolean> {\n\t\t// Do not show this for business customers yet (not allowed to create referral links)\n\t\tif ((await this.userController.loadCustomer()).businessUse === true) {\n\t\t\treturn false\n\t\t}\n\n\t\t// Create the referral link\n\t\tthis.referralLink = await getReferralLink(this.userController)\n\n\t\t// Decode the date the user was generated from the timestamp in the user ID\n\t\tconst customerCreatedTime = generatedIdToTimestamp(neverNull(this.userController.user.customer))\n\t\treturn (\n\t\t\tthis.userController.isGlobalAdmin() &&\n\t\t\tgetDayShifted(new Date(customerCreatedTime), REFERRAL_NEWS_DISPLAY_THRESHOLD_DAYS) <= new Date(this.dateProvider.now())\n\t\t)\n\t}\n\n\trender(newsId: NewsId): Children {\n\t\tconst buttonAttrs: Array<ButtonAttrs> = [\n\t\t\t{\n\t\t\t\tlabel: \"close_alt\",\n\t\t\t\tclick: () => this.newsModel.acknowledgeNews(newsId.newsItemId).then(m.redraw),\n\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t},\n\t\t]\n\n\t\treturn m(\".full-width\", [\n\t\t\tm(ReferralLinkViewer, { referralLink: this.referralLink }),\n\t\t\tm(\n\t\t\t\t\".flex-end.flex-no-grow-no-shrink-auto.flex-wrap\",\n\t\t\t\tbuttonAttrs.map((a) => m(Button, a)),\n\t\t\t),\n\t\t])\n\t}\n}\n"],"mappings":"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"}