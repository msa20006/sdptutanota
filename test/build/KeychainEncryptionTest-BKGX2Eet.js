
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import { CryptoError } from "./CryptoError-PqdvQky4.js";
import "./error-DDmy0eAT.js";
import { KeyPermanentlyInvalidatedError } from "./KeyPermanentlyInvalidatedError-DJjt81rl.js";
import { CredentialEncryptionMode } from "./CredentialEncryptionMode-BR0DkQpJ.js";
import { dist_default } from "./dist-Ci1bEzYU.js";
import { require_testdouble } from "./testdouble-IbRSnrC0.js";
import { assertSupportedEncryptionMode } from "./CredentialCommons-BObczrxd.js";

//#region ../src/common/desktop/credentials/KeychainEncryption.ts
var KeychainEncryption = class {
	constructor(appPassHandler, crypto, desktopKeyStoreFacade) {
		this.appPassHandler = appPassHandler;
		this.crypto = crypto;
		this.desktopKeyStoreFacade = desktopKeyStoreFacade;
	}
	async decryptUsingKeychain(encryptedDataWithAppPassWrapper, encryptionMode) {
		try {
			assertSupportedEncryptionMode(encryptionMode);
			const encryptedData = await this.appPassHandler.removeAppPassWrapper(encryptedDataWithAppPassWrapper, encryptionMode);
			const keyChainKey = await this.desktopKeyStoreFacade.getKeyChainKey();
			return this.crypto.unauthenticatedAes256DecryptKey(keyChainKey, encryptedData);
		} catch (e) {
			if (e instanceof CryptoError) throw new KeyPermanentlyInvalidatedError(`Could not decrypt credentials: ${e.stack ?? e.message}`);
else throw e;
		}
	}
	async encryptUsingKeychain(data, encryptionMode) {
		try {
			assertSupportedEncryptionMode(encryptionMode);
			const keyChainKey = await this.desktopKeyStoreFacade.getKeyChainKey();
			const encryptedData = this.crypto.aes256EncryptKey(keyChainKey, data);
			return this.appPassHandler.addAppPassWrapper(encryptedData, encryptionMode);
		} catch (e) {
			if (e instanceof CryptoError) throw new KeyPermanentlyInvalidatedError(`Could not encrypt credentials: ${e.stack ?? e.message}`);
else throw e;
		}
	}
};

//#endregion
//#region tests/desktop/credentials/KeychainEncryptionTest.ts
var import_testdouble = __toESM(require_testdouble(), 1);
dist_default.spec("KeychainEncryption", () => {
	let encryption;
	const appPassHandler = (0, import_testdouble.object)();
	const crypto = (0, import_testdouble.object)();
	const keystore = (0, import_testdouble.object)();
	const unencryptedData = new Uint8Array([
		13,
		10,
		7,
		10
	]);
	const encryptedData = new Uint8Array([
		14,
		4,
		12,
		1,
		3
	]);
	const wrappedData = new Uint8Array([
		3,
		1,
		3,
		10,
		7,
		7,
		14,
		13
	]);
	const keychainKey = [
		2,
		14,
		4,
		12,
		4,
		10,
		1,
		4
	];
	dist_default.beforeEach(() => {
		encryption = new KeychainEncryption(appPassHandler, crypto, keystore);
	});
	dist_default.test("encryptUsingKeychain", async () => {
		(0, import_testdouble.when)(keystore.getKeyChainKey()).thenResolve(keychainKey);
		(0, import_testdouble.when)(crypto.aes256EncryptKey(keychainKey, unencryptedData)).thenReturn(encryptedData);
		(0, import_testdouble.when)(appPassHandler.addAppPassWrapper(encryptedData, CredentialEncryptionMode.DEVICE_LOCK)).thenResolve(wrappedData);
		const result = await encryption.encryptUsingKeychain(unencryptedData, CredentialEncryptionMode.DEVICE_LOCK);
		dist_default(result).deepEquals(wrappedData);
	});
	dist_default.test("decryptUsingKeychain", async () => {
		(0, import_testdouble.when)(appPassHandler.removeAppPassWrapper(wrappedData, CredentialEncryptionMode.DEVICE_LOCK)).thenResolve(encryptedData);
		(0, import_testdouble.when)(keystore.getKeyChainKey()).thenResolve(keychainKey);
		(0, import_testdouble.when)(crypto.unauthenticatedAes256DecryptKey(keychainKey, encryptedData)).thenReturn(unencryptedData);
		const result = await encryption.decryptUsingKeychain(wrappedData, CredentialEncryptionMode.DEVICE_LOCK);
		dist_default(result).deepEquals(unencryptedData);
	});
	dist_default.test("when decrypt fails it throws correct error", async () => {
		(0, import_testdouble.when)(keystore.getKeyChainKey()).thenResolve(keychainKey);
		(0, import_testdouble.when)(appPassHandler.removeAppPassWrapper(wrappedData, CredentialEncryptionMode.DEVICE_LOCK)).thenResolve(encryptedData);
		(0, import_testdouble.when)(crypto.unauthenticatedAes256DecryptKey(keychainKey, encryptedData)).thenThrow(new CryptoError("test"));
		await dist_default(() => encryption.decryptUsingKeychain(wrappedData, CredentialEncryptionMode.DEVICE_LOCK)).asyncThrows(KeyPermanentlyInvalidatedError);
	});
});

//#endregion
//# sourceMappingURL=KeychainEncryptionTest-BKGX2Eet.js.map