
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { InvoiceTexts_default, InvoiceType, PaymentMethod, VatType, countryUsesGerman, getInvoiceItemTypeName } from "./InvoiceUtils-3xBqh6rg.js";

//#region ../src/common/api/worker/invoicegen/XRechnungUBLTemplate.ts
var XRechnungUBLTemplate_default = {
	RootInvoice: `
		<ubl:Invoice xmlns:ubl="urn:oasis:names:specification:ubl:schema:xsd:Invoice-2"
					 xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
					 xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
			<cbc:CustomizationID>urn:cen.eu:en16931:2017#compliant#urn:xeinkauf.de:kosit:xrechnung_3.0#conformant#urn:xeinkauf.de:kosit:extension:xrechnung_3.0</cbc:CustomizationID>
			{slotMain}
		</ubl:Invoice>`,
	RootCreditNote: `
		<ubl:CreditNote xmlns:ubl="urn:oasis:names:specification:ubl:schema:xsd:CreditNote-2"
						xmlns:cac="urn:oasis:names:specification:ubl:schema:xsd:CommonAggregateComponents-2"
						xmlns:cbc="urn:oasis:names:specification:ubl:schema:xsd:CommonBasicComponents-2">
			<cbc:CustomizationID>urn:cen.eu:en16931:2017#compliant#urn:xeinkauf.de:kosit:xrechnung_3.0</cbc:CustomizationID>
			{slotMain}
		</ubl:CreditNote>`,
	Main: `
		<cbc:ProfileID>urn:fdc:peppol.eu:2017:poacc:billing:01:1.0</cbc:ProfileID>
		<cbc:ID>{invoiceNumber}</cbc:ID>
		<cbc:IssueDate>{issueDate}</cbc:IssueDate>
		{slotInvoiceType}
		<cbc:DocumentCurrencyCode>EUR</cbc:DocumentCurrencyCode>
		<cbc:BuyerReference>{buyerId}</cbc:BuyerReference>
		{slotSeller}
		{slotBuyer}
		<cac:PaymentMeans>
			<cbc:PaymentMeansCode>{paymentMeansCode}</cbc:PaymentMeansCode>
			<cac:PayeeFinancialAccount>
				<cbc:ID>DE67250800200138040001</cbc:ID>
				<cbc:Name>Tutao GmbH</cbc:Name>
				<cac:FinancialInstitutionBranch>
					<cbc:ID>DRESDEFF250</cbc:ID>
				</cac:FinancialInstitutionBranch>
			</cac:PayeeFinancialAccount>
		</cac:PaymentMeans>
		{slotPaymentTerms}
		{slotAllowanceCharge}
		{slotTotalTax}
		{slotDocumentTotals}
		{slotInvoiceLines}`,
	Seller: `
		<cac:AccountingSupplierParty>
			<cac:Party>
				<cbc:EndpointID schemeID="EM">sales@tutao.de</cbc:EndpointID>
				<cac:PartyName>
					<cbc:Name>Tutao GmbH</cbc:Name>
				</cac:PartyName>
				<cac:PostalAddress>
					<cbc:StreetName>Deisterstra√üe 17a</cbc:StreetName>
					<cbc:CityName>Hannover</cbc:CityName>
					<cbc:PostalZone>30449</cbc:PostalZone>
					<cac:Country>
						<cbc:IdentificationCode>DE</cbc:IdentificationCode>
					</cac:Country>
				</cac:PostalAddress>
				<cac:PartyTaxScheme>
					<cbc:CompanyID>DE280903265</cbc:CompanyID>
					<cac:TaxScheme>
						<cbc:ID>VAT</cbc:ID>
					</cac:TaxScheme>
				</cac:PartyTaxScheme>
				<cac:PartyLegalEntity>
					<cbc:RegistrationName>Tutao GmbH</cbc:RegistrationName>
					<cbc:CompanyID>208014</cbc:CompanyID>
				</cac:PartyLegalEntity>
				<cac:Contact>
					<cbc:Name>Tutao GmbH</cbc:Name>
					<cbc:Telephone>+49 511202801-0</cbc:Telephone>
					<cbc:ElectronicMail>sales@tutao.de</cbc:ElectronicMail>
				</cac:Contact>
			</cac:Party>
		</cac:AccountingSupplierParty>`,
	Buyer: `
		<cac:AccountingCustomerParty>
			<cac:Party>
				<cbc:EndpointID schemeID="EM">{buyerMail}</cbc:EndpointID>
				<cac:PostalAddress>
					<cbc:StreetName>{buyerStreetName}</cbc:StreetName>
					<cbc:CityName>{buyerCityName}</cbc:CityName>
					<cbc:PostalZone>{buyerPostalZone}</cbc:PostalZone>
					<cac:AddressLine>
						<cbc:Line>{buyerAddressLine}</cbc:Line>
					</cac:AddressLine>
					<cac:Country>
						<cbc:IdentificationCode>{buyerCountryCode}</cbc:IdentificationCode>
					</cac:Country>
				</cac:PostalAddress>
				{slotBuyerVatInfo}
				<cac:PartyLegalEntity>
					<cbc:RegistrationName>{buyerName}</cbc:RegistrationName>
				</cac:PartyLegalEntity>
			</cac:Party>
		</cac:AccountingCustomerParty>`,
	BuyerVatInfo: `
		<cac:PartyTaxScheme>
			<cbc:CompanyID>{buyerVatId}</cbc:CompanyID>
			<cac:TaxScheme>
				<cbc:ID>VAT</cbc:ID>
			</cac:TaxScheme>
		</cac:PartyTaxScheme>`,
	AllowanceCharge: `
		<cac:AllowanceCharge>
			<cbc:ChargeIndicator>false</cbc:ChargeIndicator>
			<cbc:AllowanceChargeReasonCode>95</cbc:AllowanceChargeReasonCode>
			<cbc:Amount currencyID="EUR">{totalDiscount}</cbc:Amount>
			<cac:TaxCategory>
				<cbc:ID>{vatType}</cbc:ID>
				<cbc:Percent>{vatPercent}</cbc:Percent>
				{slotTaxExemptionReason}
				<cac:TaxScheme>
					<cbc:ID>VAT</cbc:ID>
				</cac:TaxScheme>
			</cac:TaxCategory>
		</cac:AllowanceCharge>
	`,
	TaxTotal: `
		<cac:TaxTotal>
			<cbc:TaxAmount currencyID="EUR">{vatAmount}</cbc:TaxAmount>
			<cac:TaxSubtotal>
				<cbc:TaxableAmount currencyID="EUR">{taxableAmount}</cbc:TaxableAmount>
				<cbc:TaxAmount currencyID="EUR">{vatAmount}</cbc:TaxAmount>
				<cac:TaxCategory>
					<cbc:ID>{vatType}</cbc:ID>
					<cbc:Percent>{vatPercent}</cbc:Percent>
					{slotTaxExemptionReason}
					<cac:TaxScheme>
						<cbc:ID>VAT</cbc:ID>
					</cac:TaxScheme>
				</cac:TaxCategory>
			</cac:TaxSubtotal>
		</cac:TaxTotal>`,
	DocumentTotals: `
		<cac:LegalMonetaryTotal>
			<cbc:LineExtensionAmount currencyID="EUR">{sumOfInvoiceLines}</cbc:LineExtensionAmount>
			<cbc:TaxExclusiveAmount currencyID="EUR">{invoiceExclusiveVat}</cbc:TaxExclusiveAmount>
			<cbc:TaxInclusiveAmount currencyID="EUR">{invoiceInclusiveVat}</cbc:TaxInclusiveAmount>
			<cbc:AllowanceTotalAmount currencyID="EUR">{totalDiscount}</cbc:AllowanceTotalAmount>
			<cbc:PayableAmount currencyID="EUR">{amountDueForPayment}</cbc:PayableAmount>
		</cac:LegalMonetaryTotal>`,
	InvoiceLine: `
		<cac:InvoiceLine>
			<cbc:ID>{invoiceLineId}</cbc:ID>
			<cbc:InvoicedQuantity unitCode="XPP">{invoiceLineQuantity}</cbc:InvoicedQuantity>
			<cbc:LineExtensionAmount currencyID="EUR">{invoiceLineTotal}</cbc:LineExtensionAmount>
			<cac:InvoicePeriod>
				<cbc:StartDate>{invoiceLineStartDate}</cbc:StartDate>
				<cbc:EndDate>{invoiceLineEndDate}</cbc:EndDate>
			</cac:InvoicePeriod>
			<cac:Item>
				<cbc:Name>{invoiceLineItemName}</cbc:Name>
				<cac:ClassifiedTaxCategory>
					<cbc:ID>{invoiceLineItemVatType}</cbc:ID>
					<cbc:Percent>{invoiceLineItemVatPercent}</cbc:Percent>
					<cac:TaxScheme>
						<cbc:ID>VAT</cbc:ID>
					</cac:TaxScheme>
				</cac:ClassifiedTaxCategory>
			</cac:Item>
			<cac:Price>
				<cbc:PriceAmount currencyID="EUR">{invoiceLineItemPrice}</cbc:PriceAmount>
			</cac:Price>
		</cac:InvoiceLine>`,
	CreditNoteLine: `
		<cac:CreditNoteLine>
			<cbc:ID>{invoiceLineId}</cbc:ID>
			<cbc:CreditedQuantity unitCode="XPP">{invoiceLineQuantity}</cbc:CreditedQuantity>
			<cbc:LineExtensionAmount currencyID="EUR">{invoiceLineTotal}</cbc:LineExtensionAmount>
			<cac:InvoicePeriod>
				<cbc:StartDate>{invoiceLineStartDate}</cbc:StartDate>
				<cbc:EndDate>{invoiceLineEndDate}</cbc:EndDate>
			</cac:InvoicePeriod>
			<cac:Item>
				<cbc:Name>{invoiceLineItemName}</cbc:Name>
				<cac:ClassifiedTaxCategory>
					<cbc:ID>{invoiceLineItemVatType}</cbc:ID>
					<cbc:Percent>{invoiceLineItemVatPercent}</cbc:Percent>
					<cac:TaxScheme>
						<cbc:ID>VAT</cbc:ID>
					</cac:TaxScheme>
				</cac:ClassifiedTaxCategory>
			</cac:Item>
			<cac:Price>
				<cbc:PriceAmount currencyID="EUR">{invoiceLineItemPrice}</cbc:PriceAmount>
			</cac:Price>
		</cac:CreditNoteLine>
	`
};

//#endregion
//#region ../src/common/api/worker/invoicegen/XRechnungInvoiceGenerator.ts
const DE_POSTAL_CODE_REGEX = new RegExp(/\d{5}/);
const CITY_NAME_REGEX = new RegExp(/\d{5}/);
const PaymentMethodTypeCodes = Object.freeze({
	[PaymentMethod.INVOICE]: "31",
	[PaymentMethod.CREDIT_CARD]: "97",
	[PaymentMethod.SEPA_UNUSED]: "59",
	[PaymentMethod.PAYPAL]: "68",
	[PaymentMethod.ACCOUNT_BALANCE]: "97"
});
const VatTypeCategoryCodes = Object.freeze({
	[VatType.NO_VAT]: "E",
	[VatType.ADD_VAT]: "S",
	[VatType.VAT_INCLUDED_SHOWN]: "S",
	[VatType.VAT_INCLUDED_HIDDEN]: "S",
	[VatType.NO_VAT_CHARGE_TUTAO]: "AE"
});
var XRechnungInvoiceGenerator = class {
	languageCode = "en";
	invoiceNumber;
	customerId;
	buyerMailAddress;
	invoice;
	itemIndex = 0;
	discountItems = [];
	totalDiscountSum = -1;
	constructor(invoice, invoiceNumber, customerId, buyerMailAddress) {
		this.invoice = invoice;
		this.invoiceNumber = invoiceNumber;
		this.customerId = customerId;
		this.languageCode = countryUsesGerman(this.invoice.country);
		this.buyerMailAddress = buyerMailAddress;
	}
	/**
	* Generate the XRechnung xml file
	*/
	generate() {
		let stringTemplate = `<?xml version="1.0" encoding="UTF-8"?>\n` + (this.invoice.invoiceType === InvoiceType.INVOICE ? XRechnungUBLTemplate_default.RootInvoice : XRechnungUBLTemplate_default.RootCreditNote);
		stringTemplate = stringTemplate.replace("{slotMain}", XRechnungUBLTemplate_default.Main).replace("{slotInvoiceLines}", this.resolveInvoiceLines()).replace("{invoiceNumber}", this.invoiceNumber).replace("{issueDate}", formatDate(this.invoice.date)).replace("{slotInvoiceType}", this.resolveInvoiceType()).replace("{buyerId}", this.customerId).replace("{slotSeller}", XRechnungUBLTemplate_default.Seller).replace("{slotBuyer}", this.resolveBuyer()).replace("{paymentMeansCode}", PaymentMethodTypeCodes[this.invoice.paymentMethod]).replace("{slotPaymentTerms}", this.resolvePaymentTerms()).replace("{slotAllowanceCharge}", this.resolveAllowanceCharge()).replace("{slotTotalTax}", this.resolveTotalTax()).replace("{slotDocumentTotals}", this.resolveDocumentsTotal()).replaceAll(/^\t\t/gm, "");
		return new TextEncoder().encode(stringTemplate);
	}
	/**
	* Resolves the root of the xml depending on invoice type (billing invoice or credit)
	* @private
	*/
	resolveInvoiceType() {
		if (this.invoice.invoiceType === InvoiceType.INVOICE) return `<cbc:InvoiceTypeCode>380</cbc:InvoiceTypeCode>`;
		return `<cbc:CreditNoteTypeCode>381</cbc:CreditNoteTypeCode>`;
	}
	/**
	* Resolves placeholders concerning the buyer (customer)
	* buyerMail - Electronic address of the customer
	* buyerStreetName - despite its name, also includes the street number
	* buyerCityName - self-explanatory
	* buyerPostalZone - despite its name, only refers to the postal code, not any associated city
	* buyerCountryCode - self-explanatory
	* buyerName - Legal name / company name of the customer -> The first line of the address field
	* @private
	*/
	resolveBuyer() {
		const addressParts = this.invoice.address.split("\n");
		return XRechnungUBLTemplate_default.Buyer.replace("{buyerMail}", this.buyerMailAddress).replace("{buyerStreetName}", addressParts[1] ?? "STREET NAME UNKNOWN").replace("{buyerCityName}", extractCityName(addressParts[2] ?? "")).replace("{buyerPostalZone}", extractPostalCode(addressParts[2] ?? "")).replace("{buyerCountryCode}", this.invoice.country).replace("{buyerAddressLine}", this.invoice.address.replaceAll("\n", " ")).replace("{slotBuyerVatInfo}", this.resolveBuyerVatInfo()).replace("{buyerName}", addressParts[0] ?? "BUYER NAME UNKNOWN");
	}
	/**
	* Resolves tax info about the buyer (customer). Only resolved if the buyer has a vatIdNumber.
	* buyerVatId - Customer's vatIdNumber
	* @private
	*/
	resolveBuyerVatInfo() {
		if (this.invoice.vatIdNumber != null) return XRechnungUBLTemplate_default.BuyerVatInfo.replace("{buyerVatId}", this.invoice.vatIdNumber);
		return "";
	}
	/**
	* Resolves the payment note, i.e. the instructions for the buyer
	* These are the same texts below the summary table of a PDF invoice
	* @private
	*/
	resolvePaymentNote() {
		let paymentNote = "";
		if (this.invoice.invoiceType === InvoiceType.INVOICE) {
			switch (this.invoice.paymentMethod) {
				case PaymentMethod.INVOICE:
					paymentNote += `${InvoiceTexts_default[this.languageCode].paymentInvoiceDue1} ${InvoiceTexts_default[this.languageCode].paymentInvoiceDue2} ${InvoiceTexts_default[this.languageCode].paymentInvoiceHolder} ${InvoiceTexts_default[this.languageCode].paymentInvoiceBank} ${InvoiceTexts_default[this.languageCode].paymentInvoiceIBAN} ${InvoiceTexts_default[this.languageCode].paymentInvoiceBIC} ${InvoiceTexts_default[this.languageCode].paymentInvoiceProvideNumber1} ${this.invoiceNumber} ${InvoiceTexts_default[this.languageCode].paymentInvoiceProvideNumber2}`;
					break;
				case PaymentMethod.CREDIT_CARD:
					paymentNote += `${InvoiceTexts_default[this.languageCode].paymentCreditCard}`;
					break;
				case PaymentMethod.PAYPAL:
					paymentNote += `${InvoiceTexts_default[this.languageCode].paymentPaypal}`;
					break;
				case PaymentMethod.ACCOUNT_BALANCE:
					paymentNote += `${InvoiceTexts_default[this.languageCode].paymentAccountBalance}`;
					break;
			}
			paymentNote += " " + InvoiceTexts_default[this.languageCode].thankYou;
		}
		return paymentNote;
	}
	/**
	* Resolves the payment terms (supplementary note to customer) if the invoice is a billing invoice
	* @private
	*/
	resolvePaymentTerms() {
		if (this.invoice.invoiceType === InvoiceType.INVOICE) return `
				<cac:PaymentTerms>
					<cbc:Note>${this.resolvePaymentNote()}</cbc:Note>
				</cac:PaymentTerms>
			`;
		return "";
	}
	/**
	* Resolves all information about potential discounts
	* totalDiscount - Inverted sum of all discount invoiceitems
	* vatType - Standardized VAT category code
	* vatPercent - Percentage of the vat applied. I.e. 19% -> vatPercent == 19
	* taxableAmount - Amount that is subject to the tax. Usually this is the entire amount, so the subTotal
	* vatAmount - The amount of the tax. This is equal to "taxableAmount * vatPercent"
	* @private
	*/
	resolveAllowanceCharge() {
		return XRechnungUBLTemplate_default.AllowanceCharge.replace("{totalDiscount}", this.calculateTotalDiscount().toFixed(2)).replace("{vatType}", VatTypeCategoryCodes[this.invoice.vatType]).replace("{vatPercent}", this.invoice.vatRate).replace("{slotTaxExemptionReason}", this.resolveTaxExemptionReason()).replace("{taxableAmount}", this.getVatExcludedPrice(this.invoice.subTotal)).replaceAll("{vatAmount}", this.invoice.vat);
	}
	/**
	* Resolves the total tax slot: summarized information of all applied taxes (vat)
	* vatType - Standardized VAT category code
	* vatPercent - Percentage of the vat applied. I.e. 19% -> vatPercent == 19
	* taxableAmount - Amount that is subject to the tax. Usually this is the entire amount, so the subTotal
	* vatAmount - The amount of the tax. This is equal to "taxableAmount * vatPercent"
	* @private
	*/
	resolveTotalTax() {
		return XRechnungUBLTemplate_default.TaxTotal.replace("{vatType}", VatTypeCategoryCodes[this.invoice.vatType]).replace("{vatPercent}", this.invoice.vatRate).replace("{slotTaxExemptionReason}", this.resolveTaxExemptionReason()).replace("{taxableAmount}", this.getVatExcludedPrice(this.invoice.subTotal)).replaceAll("{vatAmount}", this.invoice.vat);
	}
	/**
	* Resolves the textual reason why taxes are exempt. Only resolved if the vat type is reverse-charge
	* @private
	*/
	resolveTaxExemptionReason() {
		if (this.invoice.vatType === VatType.NO_VAT || this.invoice.vatType === VatType.NO_VAT_CHARGE_TUTAO) return `<cbc:TaxExemptionReason>Umkehrung der Steuerschuldnerschaft</cbc:TaxExemptionReason>`;
		return "";
	}
	/**
	* Resolves the document total slot: summarized information of the pricing
	* sumOfInvoiceLines - The total amount of all invoice items summed up alongside their quantity (amount): subTotal
	* invoiceExclusiveVat - The total amount of the entire invoice without vat: subTotal
	* invoiceInclusiveVat - The total amount of the entire invoice with vat: grandTotal
	* amountDueForPayment - The final amount the buyer is billed with: grandTotal
	* @private
	*/
	resolveDocumentsTotal() {
		return XRechnungUBLTemplate_default.DocumentTotals.replace("{sumOfInvoiceLines}", this.getVatExcludedPrice((parseFloat(this.invoice.subTotal) + this.calculateTotalDiscount()).toFixed(2))).replace("{invoiceExclusiveVat}", this.getVatExcludedPrice(this.invoice.subTotal)).replace("{invoiceInclusiveVat}", this.invoice.grandTotal).replace("{amountDueForPayment}", this.invoice.grandTotal).replace("{totalDiscount}", this.calculateTotalDiscount().toFixed(2));
	}
	/**
	* Resolves all invoice items (invoiceLines) by iterating over every invoice item and resolving a list for it
	* @private
	*/
	resolveInvoiceLines() {
		let invoiceLines = "";
		if (this.invoice.invoiceType === InvoiceType.INVOICE) for (const invoiceItem of this.invoice.items) invoiceLines += this.resolveInvoiceLine(invoiceItem);
else for (const invoiceItem of this.invoice.items) invoiceLines += this.resolveCreditNoteLine(invoiceItem);
		return invoiceLines;
	}
	/**
	* Resolves a singular invoice item (invoiceLine): information about one row in an invoice table
	* invoiceLineQuantity - The amount (quantity) of the item in the invoice line, so the invoiceItem's amount
	* invoiceLineTotal - The total price of the invoice line. This is equal to "itemPrice * quantity" == totalPrice
	* invoiceLineStartDate - self-explanatory
	* invoiceLineEndDate - self-explanatory
	* invoiceLineItemName - self-explanatory
	* invoiceLineItemVatType - Standardized Vat category code for this item. Equal to the vat type of the entire invoice
	* invoiceLineItemVatPercent - Percentage of vat applied to this item. Equal to the vat percentage of the entire invoice
	* invoiceLineItemPrice - Price of the singular item: singlePrice
	* @param invoiceItem
	* @private
	*/
	resolveInvoiceLine(invoiceItem) {
		this.itemIndex++;
		if (parseFloat(invoiceItem.totalPrice) < 0) {
			this.discountItems.push(invoiceItem);
			return "";
		}
		return XRechnungUBLTemplate_default.InvoiceLine.replace("{invoiceLineId}", this.itemIndex.toString()).replace("{invoiceLineQuantity}", invoiceItem.amount).replace("{invoiceLineTotal}", this.getVatExcludedPrice(invoiceItem.totalPrice)).replace("{invoiceLineStartDate}", formatDate(invoiceItem.startDate)).replace("{invoiceLineEndDate}", formatDate(invoiceItem.endDate)).replace("{invoiceLineItemName}", getInvoiceItemTypeName(invoiceItem.itemType, this.languageCode)).replace("{invoiceLineItemVatType}", VatTypeCategoryCodes[this.invoice.vatType]).replace("{invoiceLineItemVatPercent}", this.invoice.vatRate).replace("{invoiceLineItemPrice}", this.getVatExcludedPrice(getInvoiceItemPrice(invoiceItem)));
	}
	/**
	* Same as resolveInvoiceLine but for CreditNotes
	* @param invoiceItem
	* @private
	*/
	resolveCreditNoteLine(invoiceItem) {
		this.itemIndex++;
		return XRechnungUBLTemplate_default.CreditNoteLine.replace("{invoiceLineId}", this.itemIndex.toString()).replace("{invoiceLineQuantity}", invoiceItem.amount).replace("{invoiceLineTotal}", this.getVatExcludedPrice(invoiceItem.totalPrice)).replace("{invoiceLineStartDate}", formatDate(invoiceItem.startDate)).replace("{invoiceLineEndDate}", formatDate(invoiceItem.endDate)).replace("{invoiceLineItemName}", getInvoiceItemTypeName(invoiceItem.itemType, this.languageCode)).replace("{invoiceLineItemVatType}", VatTypeCategoryCodes[this.invoice.vatType]).replace("{invoiceLineItemVatPercent}", this.invoice.vatRate).replace("{invoiceLineItemPrice}", this.getVatExcludedPrice(getInvoiceItemPrice(invoiceItem)));
	}
	/**
	* Calculates the total discount applied to the entire invoice. The discount is a positive number that is to be subtracted from the invoice total
	* The discount is calculated by iterating over every invoiceItem that is of type "discount" and adding it up.
	* @private
	*/
	calculateTotalDiscount() {
		if (this.totalDiscountSum !== -1) return this.totalDiscountSum;
		this.totalDiscountSum = 0;
		for (const discountItem of this.discountItems) this.totalDiscountSum += parseFloat(discountItem.totalPrice);
		this.totalDiscountSum *= -1;
		return this.totalDiscountSum;
	}
	/**
	* Recalculates a price if the vat is already included. I.e. subtracts the applied vat
	* Returns the price with vat excluded
	* @param priceValue
	* @private
	*/
	getVatExcludedPrice(priceValue) {
		switch (this.invoice.vatType) {
			case VatType.VAT_INCLUDED_SHOWN:
			case VatType.VAT_INCLUDED_HIDDEN: {
				const nPriceValue = parseFloat(priceValue);
				const nVat = parseFloat(this.invoice.vat);
				return (nPriceValue - nVat).toFixed(2);
			}
			default: break;
		}
		return priceValue;
	}
};
/**
* Formats a date to be of the pattern "yyyy-mm-dd"
* @param date
*/
function formatDate(date) {
	if (date != null) return date.toISOString().split("T")[0];
	return "No date given.";
}
/**
* Returns the price of an invoice item.
* This is singlePrice if the amount of item is 1 or totalPrice if not.
* @param invoiceItem
*/
function getInvoiceItemPrice(invoiceItem) {
	if (invoiceItem.singlePrice != null) return invoiceItem.singlePrice;
	return invoiceItem.totalPrice;
}
function extractPostalCode(addressLine) {
	const match = addressLine.match(DE_POSTAL_CODE_REGEX);
	if (match && match[0]) return match[0].trim();
	return "Could not extract postal code. Please refer to full address line.";
}
function extractCityName(addressLine) {
	const cityName = addressLine.replace(CITY_NAME_REGEX, "").replace(",", "").trim();
	if (cityName === "") return "Could not extract city name. Please refer to full address line.";
	return cityName;
}

//#endregion
export { XRechnungInvoiceGenerator, extractCityName, extractPostalCode };
//# sourceMappingURL=XRechnungInvoiceGenerator-r5maK2cT.js.map