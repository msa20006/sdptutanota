
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { lang } from "./LanguageViewModel-BNC5ekpO.js";
import { log } from "./DesktopLog-yAgEoQsh.js";
import path from "node:path";

//#region ../src/common/desktop/integration/DesktopIntegratorLinux.ts
var DesktopIntegratorLinux = class {
	_electron;
	_fs;
	_childProcess;
	DATA_HOME;
	CONFIG_HOME;
	executablePath;
	packagePath;
	autoLaunchPath;
	desktopFilePath;
	iconTargetDir64;
	iconTargetDir512;
	iconTargetPath64;
	iconTargetPath512;
	iconSourcePath64;
	iconSourcePath512;
	nointegrationpath;
	constructor(electron, fs, childProcess) {
		this._electron = electron;
		this._fs = fs;
		this._childProcess = childProcess;
		const { app } = electron;
		this.DATA_HOME = process.env.XDG_DATA_HOME || path.join(app.getPath("home"), ".local/share");
		this.CONFIG_HOME = process.env.XDG_CONFIG_HOME || path.join(app.getPath("home"), ".config");
		this.executablePath = process.execPath;
		this.packagePath = process.env.APPIMAGE ? process.env.APPIMAGE : process.execPath;
		this.autoLaunchPath = path.join(this.CONFIG_HOME, `autostart/${app.name}.desktop`);
		this.desktopFilePath = path.join(this.DATA_HOME, `applications/${app.name}.desktop`);
		this.iconTargetDir64 = path.join(this.DATA_HOME, `icons/hicolor/64x64/apps/`);
		this.iconTargetDir512 = path.join(this.DATA_HOME, `icons/hicolor/512x512/apps/`);
		this.iconTargetPath64 = path.join(this.iconTargetDir64, `${app.name}.png`);
		this.iconTargetPath512 = path.join(this.iconTargetDir512, `${app.name}.png`);
		this.iconSourcePath64 = path.join(path.dirname(this.executablePath), `resources/icons/logo-solo-red-small.png`);
		this.iconSourcePath512 = path.join(path.dirname(this.executablePath), `resources/icons/logo-solo-red.png`);
		this.nointegrationpath = path.join(this.CONFIG_HOME, "tuta_integration/no_integration");
	}
	isAutoLaunchEnabled() {
		return this.checkFileIsThere(this.autoLaunchPath);
	}
	isIntegrated() {
		return this.checkFileIsThere(this.desktopFilePath);
	}
	checkFileIsThere(pathToCheck) {
		return this._fs.promises.access(pathToCheck, this._fs.constants.F_OK | this._fs.constants.W_OK | this._fs.constants.R_OK).then(() => true).catch(() => false);
	}
	enableAutoLaunch() {
		return this.isAutoLaunchEnabled().then((enabled) => {
			if (enabled) return;
			const autoLaunchDesktopEntry = `[Desktop Entry]
	Type=Application
	Version=${this._electron.app.getVersion()}
	Name=${this._electron.app.name}
	Comment=${this._electron.app.name} startup script
	Exec=${this.packagePath} -a
	StartupNotify=false
	Terminal=false`;
			this._fs.mkdirSync(path.dirname(this.autoLaunchPath), { recursive: true });
			this._fs.writeFileSync(this.autoLaunchPath, autoLaunchDesktopEntry, { encoding: "utf-8" });
		});
	}
	disableAutoLaunch() {
		return this.isAutoLaunchEnabled().then((enabled) => enabled ? this._fs.promises.unlink(this.autoLaunchPath) : Promise.resolve()).catch((e) => {
			if (e.code !== "ENOENT") throw e;
		});
	}
	async runIntegration(wm) {
		if (this.executablePath.includes("node_modules/electron/dist/electron")) return;
		const integrated = await this.isIntegrated();
		if (integrated) {
			log.debug(`desktop file exists, checking version...`);
			const desktopEntryVersion = this.getDesktopEntryVersion();
			if (desktopEntryVersion !== this._electron.app.getVersion()) {
				log.debug("version mismatch, reintegrating...");
				return this.integrate();
			}
		} else {
			log.debug(`${this.desktopFilePath} does not exist, checking for permission to ask for permission...`);
			const isThere = await this.checkFileIsThere(this.nointegrationpath);
			if (isThere) {
				const forbiddenPaths = this._fs.readFileSync(this.nointegrationpath, {
					encoding: "utf8",
					flag: "r"
				}).trim().split("\n");
				if (!forbiddenPaths.includes(this.packagePath)) return this.askPermission();
			} else return this.askPermission();
		}
	}
	/**
	* returns the version number from the desktop file
	* @returns {*}
	*/
	getDesktopEntryVersion() {
		const versionLine = this._fs.readFileSync(this.desktopFilePath, "utf8").split("\n").find((s) => s.includes("X-Tutanota-Version")) || "=0.0.0";
		return versionLine.split("=")[1];
	}
	integrate() {
		const prefix = this._electron.app.name.includes("test") ? "test " : "";
		return this.copyIcons().then(() => this.createDesktopEntry(prefix)).then(() => {
			if (process.env["XDG_CURRENT_DESKTOP"] !== "GNOME") return;
			try {
				this._childProcess.execFile("update-desktop-database", [path.join(this._electron.app.getPath("home"), ".local/share/applications")], logExecFile);
			} catch (e) {}
		});
	}
	unintegrate() {
		return Promise.all([this._fs.promises.unlink(this.iconTargetPath64), this._fs.promises.unlink(this.iconTargetPath512)]).catch((e) => {
			if (!e.message.startsWith("ENOENT")) throw e;
		}).then(() => this._fs.promises.unlink(this.desktopFilePath)).catch((e) => {
			if (!e.message.startsWith("ENOENT")) throw e;
		});
	}
	createDesktopEntry(prefix) {
		const desktopEntry = `[Desktop Entry]
Name=${prefix}Tuta Mail
Comment=The desktop client for Tuta Mail, the secure e-mail service.
GenericName=Mail Client
Keywords=Email;E-mail
Exec="${this.packagePath}" %U
Terminal=false
Type=Application
Icon=${this._electron.app.name}
StartupWMClass=${this._electron.app.name}
MimeType=x-scheme-handler/mailto;
Categories=Network;
X-Tutanota-Version=${this._electron.app.getVersion()}
TryExec=${this.packagePath}`;
		return this._fs.promises.mkdir(path.dirname(this.desktopFilePath), { recursive: true }).then(() => this._fs.promises.writeFile(this.desktopFilePath, desktopEntry, { encoding: "utf-8" }));
	}
	copyIcons() {
		return Promise.all([this._fs.promises.mkdir(this.iconTargetDir64, { recursive: true }), this._fs.promises.mkdir(this.iconTargetDir512, { recursive: true })]).then(() => {
			return Promise.all([this._fs.promises.copyFile(this.iconSourcePath64, this.iconTargetPath64), this._fs.promises.copyFile(this.iconSourcePath512, this.iconTargetPath512)]);
		}).then(() => {
			try {
				this._childProcess.execFile("touch", [path.join(this._electron.app.getPath("home"), ".local/share/icons/hicolor")], logExecFile);
			} catch (e) {}
		});
	}
	/**
	* asks the user for permission to integrate.
	* also gives the option to opt-out indefinitely, which
	* records the current path to the appImage in
	* ~/.config/tuta_integration/no_integration
	*/
	async askPermission() {
		const { response, checkboxChecked } = await this._electron.dialog.showMessageBox({
			title: lang.get("desktopIntegration_label"),
			buttons: [lang.get("no_label"), lang.get("yes_label")],
			defaultId: 1,
			message: lang.get("desktopIntegration_msg"),
			checkboxLabel: lang.get("doNotAskAgain_label"),
			checkboxChecked: false,
			type: "question"
		});
		if (checkboxChecked) {
			log.debug("updating no_integration blacklist...");
			await this._fs.promises.mkdir(path.dirname(this.nointegrationpath), { recursive: true });
			await this._fs.promises.writeFile(this.nointegrationpath, this.packagePath + "\n", {
				encoding: "utf-8",
				flag: "a"
			});
		}
		if (response === 1) await this.integrate();
	}
};
function logExecFile(err, stdout, stderr) {
	if (stdout && stdout !== "") log.debug("stdout:", stdout);
	if (err) log.error(err);
	if (stderr && stderr !== "") log.error("stderr:", stderr);
}

//#endregion
export { DesktopIntegratorLinux };
//# sourceMappingURL=DesktopIntegratorLinux-B-aJdsEF.js.map