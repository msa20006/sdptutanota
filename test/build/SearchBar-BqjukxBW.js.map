{"version":3,"file":"SearchBar-BqjukxBW.js","names":["state: SearchBarState","attrs: SearchBarOverlayAttrs","e: MouseEvent","failedIndexingUpTo: number","result: Entry","type: TypeRef<any> | null","result: ShowMoreAction","contact: Contact","event: CalendarEvent","mail: Mail","attrs: BaseSearchBarAttrs","e: KeyboardEvent","newPath: string","vnode: Vnode<SearchBarAttrs>","e: SubmitEvent","e: KeyboardEvent","m","oldEnd: number | null","aimedEnd: number","overlayRect: PositionRect","result: (Mail | null) | Contact | WhitelabelChild | CalendarEvent | ShowMoreAction","type: TypeRef<any> | null","query: string","selected?: ListElementEntity","query?: string","restriction: SearchRestriction","cb: () => void","result: SearchResult | null","limit: number | null","result: SearchResult","moreEntry: ShowMoreAction","instances: Array<Entry>","update: Partial<SearchBarState>"],"sources":["../../src/mail-app/search/SearchBarOverlay.ts","../../src/common/gui/base/BaseSearchBar.ts","../../src/mail-app/search/SearchBar.ts"],"sourcesContent":["import type { Entry, SearchBarState, ShowMoreAction } from \"./SearchBar\"\nimport { px, size } from \"../../common/gui/size\"\nimport { lang } from \"../../common/misc/LanguageViewModel\"\nimport { Button, ButtonType } from \"../../common/gui/base/Button.js\"\nimport { Icons } from \"../../common/gui/base/icons/Icons\"\nimport { downcast, isEmpty, isSameTypeRef, TypeRef } from \"@tutao/tutanota-utils\"\nimport { FULL_INDEXED_TIMESTAMP } from \"../../common/api/common/TutanotaConstants\"\nimport { formatDate, formatTimeOrDateOrYesterday } from \"../../common/misc/Formatter\"\nimport type { CalendarEvent, Contact, Mail } from \"../../common/api/entities/tutanota/TypeRefs.js\"\nimport { CalendarEventTypeRef, ContactTypeRef, MailTypeRef } from \"../../common/api/entities/tutanota/TypeRefs.js\"\nimport Badge from \"../../common/gui/base/Badge\"\nimport { Icon } from \"../../common/gui/base/Icon\"\nimport { client } from \"../../common/misc/ClientDetector\"\nimport m, { Children, Component, Vnode } from \"mithril\"\nimport { theme } from \"../../common/gui/theme\"\nimport { getMailFolderIcon, isTutanotaTeamMail } from \"../mail/view/MailGuiUtils\"\nimport { locator } from \"../../common/api/main/CommonLocator\"\nimport { IndexingErrorReason } from \"../../common/api/worker/search/SearchTypes\"\nimport { companyTeamLabel } from \"../../common/misc/ClientConstants.js\"\nimport { getTimeZone } from \"../../common/calendar/date/CalendarUtils.js\"\n\nimport { formatEventDuration } from \"../../calendar-app/calendar/gui/CalendarGuiUtils.js\"\nimport { getContactListName } from \"../../common/contactsFunctionality/ContactUtils.js\"\n\nimport { getSenderOrRecipientHeading } from \"../mail/view/MailViewerUtils.js\"\nimport { mailLocator } from \"../mailLocator.js\"\n\ntype SearchBarOverlayAttrs = {\n\tstate: SearchBarState\n\tisQuickSearch: boolean\n\tisFocused: boolean\n\tselectResult: (result: Entry | null) => void\n}\n\nexport class SearchBarOverlay implements Component<SearchBarOverlayAttrs> {\n\tview({ attrs }: Vnode<SearchBarOverlayAttrs>): Children {\n\t\tconst { state } = attrs\n\t\treturn [\n\t\t\tthis._renderIndexingStatus(state, attrs),\n\t\t\tstate.entities && !isEmpty(state.entities) && attrs.isQuickSearch && attrs.isFocused ? this.renderResults(state, attrs) : null,\n\t\t]\n\t}\n\n\trenderResults(state: SearchBarState, attrs: SearchBarOverlayAttrs): Children {\n\t\treturn m(\"ul.list.click.mail-list\", [\n\t\t\tstate.entities.map((result) => {\n\t\t\t\treturn m(\n\t\t\t\t\t\"li.plr-l.flex-v-center.\",\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\theight: px(52),\n\t\t\t\t\t\t\t\"border-left\": px(size.border_selection) + \" solid transparent\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\t// avoid closing overlay before the click event can be received\n\t\t\t\t\t\tonmousedown: (e: MouseEvent) => e.preventDefault(),\n\t\t\t\t\t\tonclick: () => attrs.selectResult(result),\n\t\t\t\t\t\tclass: state.selected === result ? \"row-selected\" : \"\",\n\t\t\t\t\t},\n\t\t\t\t\tthis.renderResult(state, result),\n\t\t\t\t)\n\t\t\t}),\n\t\t])\n\t}\n\n\t_renderIndexingStatus(state: SearchBarState, attrs: SearchBarOverlayAttrs): Children {\n\t\tif (attrs.isFocused || (!attrs.isQuickSearch && client.isDesktopDevice())) {\n\t\t\tif (state.indexState.failedIndexingUpTo != null) {\n\t\t\t\treturn this.renderError(state.indexState.failedIndexingUpTo, attrs)\n\t\t\t} else if (state.indexState.progress !== 0) {\n\t\t\t\treturn this._renderProgress(state, attrs)\n\t\t\t} else {\n\t\t\t\treturn null\n\t\t\t}\n\t\t} else {\n\t\t\treturn null\n\t\t}\n\t}\n\n\t_renderProgress(state: SearchBarState, attrs: SearchBarOverlayAttrs): Children {\n\t\treturn m(\".flex.col.rel\", [\n\t\t\tm(\n\t\t\t\t\".plr-l.pt-s.pb-s.flex.items-center.flex-space-between.mr-negative-s\",\n\t\t\t\t{\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\theight: px(52),\n\t\t\t\t\t\tborderLeft: `${px(size.border_selection)} solid transparent`,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t[\n\t\t\t\t\tm(\n\t\t\t\t\t\t\".top.flex-space-between.col\",\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\".bottom.flex-space-between\",\n\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\"\",\n\t\t\t\t\t\t\t\tlang.get(\"indexedMails_label\", {\n\t\t\t\t\t\t\t\t\t\"{count}\": state.indexState.indexedMailCount,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t),\n\t\t\t\t\t),\n\t\t\t\t\tstate.indexState.progress !== 100\n\t\t\t\t\t\t? m(\n\t\t\t\t\t\t\t\t\"div\",\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t// avoid closing overlay before the click event can be received\n\t\t\t\t\t\t\t\t\tonmousedown: (e: MouseEvent) => e.preventDefault(),\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tm(Button, {\n\t\t\t\t\t\t\t\t\tlabel: \"cancel_action\",\n\t\t\t\t\t\t\t\t\tclick: () => mailLocator.indexerFacade.cancelMailIndexing(),\n\t\t\t\t\t\t\t\t\t//icon: () => Icons.Cancel\n\t\t\t\t\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t  )\n\t\t\t\t\t\t: null, // avoid closing overlay before the click event can be received\n\t\t\t\t],\n\t\t\t),\n\t\t\tm(\".abs\", {\n\t\t\t\tstyle: {\n\t\t\t\t\tbackgroundColor: theme.content_accent,\n\t\t\t\t\theight: \"2px\",\n\t\t\t\t\twidth: state.indexState.progress + \"%\",\n\t\t\t\t\tbottom: 0,\n\t\t\t\t},\n\t\t\t}),\n\t\t])\n\t}\n\n\tprivate renderError(failedIndexingUpTo: number, attrs: SearchBarOverlayAttrs): Children {\n\t\tconst errorMessageKey = attrs.state.indexState.error === IndexingErrorReason.ConnectionLost ? \"indexingFailedConnection_error\" : \"indexing_error\"\n\n\t\treturn m(\".flex.rel\", [\n\t\t\tm(\n\t\t\t\t\".plr-l.pt-s.pb-s.flex.items-center.flex-space-between.mr-negative-s\",\n\t\t\t\t{\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\theight: px(52),\n\t\t\t\t\t\tborderLeft: `${px(size.border_selection)} solid transparent`,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t[\n\t\t\t\t\tm(\".small\", lang.get(errorMessageKey)),\n\t\t\t\t\tm(\n\t\t\t\t\t\t\"div\",\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t// avoid closing overlay before the click event can be received\n\t\t\t\t\t\t\tonmousedown: (e: MouseEvent) => e.preventDefault(),\n\t\t\t\t\t\t},\n\t\t\t\t\t\tm(Button, {\n\t\t\t\t\t\t\tlabel: \"retry_action\",\n\t\t\t\t\t\t\tclick: () => mailLocator.indexerFacade.extendMailIndex(failedIndexingUpTo),\n\t\t\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t\t\t}),\n\t\t\t\t\t),\n\t\t\t\t],\n\t\t\t),\n\t\t])\n\t}\n\n\trenderResult(state: SearchBarState, result: Entry): Children {\n\t\tlet type: TypeRef<any> | null = \"_type\" in result ? result._type : null\n\n\t\tif (!type) {\n\t\t\treturn this.renderShowMoreAction(downcast(result))\n\t\t} else if (isSameTypeRef(MailTypeRef, type)) {\n\t\t\treturn this.renderMailResult(downcast(result), state)\n\t\t} else if (isSameTypeRef(ContactTypeRef, type)) {\n\t\t\treturn this.renderContactResult(downcast(result))\n\t\t} else if (isSameTypeRef(CalendarEventTypeRef, type)) {\n\t\t\treturn this.renderCalendarEventResult(downcast(result))\n\t\t} else {\n\t\t\treturn []\n\t\t}\n\t}\n\n\tprivate renderShowMoreAction(result: ShowMoreAction): Children {\n\t\t// show more action\n\t\tlet showMoreAction = result as any as ShowMoreAction\n\t\tlet infoText\n\t\tlet indexInfo\n\n\t\tif (showMoreAction.resultCount === 0) {\n\t\t\tinfoText = lang.get(\"searchNoResults_msg\")\n\n\t\t\tif (locator.logins.getUserController().isFreeAccount()) {\n\t\t\t\tindexInfo = lang.get(\"changeTimeFrame_msg\")\n\t\t\t}\n\t\t} else if (showMoreAction.allowShowMore) {\n\t\t\tinfoText = lang.get(\"showMore_action\")\n\t\t} else {\n\t\t\tinfoText = lang.get(\"moreResultsFound_msg\", {\n\t\t\t\t\"{1}\": showMoreAction.resultCount - showMoreAction.shownCount,\n\t\t\t})\n\t\t}\n\n\t\tif (showMoreAction.indexTimestamp > FULL_INDEXED_TIMESTAMP && !indexInfo) {\n\t\t\tindexInfo = lang.get(\"searchedUntil_msg\") + \" \" + formatDate(new Date(showMoreAction.indexTimestamp))\n\t\t}\n\n\t\treturn indexInfo\n\t\t\t? [m(\".top.flex-center\", infoText), m(\".bottom.flex-center.small\", indexInfo)]\n\t\t\t: m(\"li.plr-l.pt-s.pb-s.items-center.flex-center\", m(\".flex-center\", infoText))\n\t}\n\n\tprivate renderContactResult(contact: Contact): Children {\n\t\treturn [\n\t\t\tm(\".top.flex-space-between\", m(\".name\", getContactListName(contact))),\n\t\t\tm(\n\t\t\t\t\".bottom.flex-space-between\",\n\t\t\t\tm(\"small.mail-address\", contact.mailAddresses && contact.mailAddresses.length > 0 ? contact.mailAddresses[0].address : \"\"),\n\t\t\t),\n\t\t]\n\t}\n\n\tprivate renderCalendarEventResult(event: CalendarEvent): Children {\n\t\treturn [\n\t\t\tm(\".top.flex-space-between\", m(\".name.text-ellipsis\", { title: event.summary }, event.summary)),\n\t\t\tm(\".bottom.flex-space-between\", m(\"small.mail-address\", formatEventDuration(event, getTimeZone(), false))),\n\t\t]\n\t}\n\n\tprivate renderMailResult(mail: Mail, state: SearchBarState): Children {\n\t\treturn [\n\t\t\tm(\".top.flex-space-between.badge-line-height\", [\n\t\t\t\tisTutanotaTeamMail(mail)\n\t\t\t\t\t? m(\n\t\t\t\t\t\t\tBadge,\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tclasses: \".small.mr-s\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tcompanyTeamLabel,\n\t\t\t\t\t  )\n\t\t\t\t\t: null,\n\t\t\t\tm(\"small.text-ellipsis\", getSenderOrRecipientHeading(mail, true)),\n\t\t\t\tm(\"small.text-ellipsis.flex-fixed\", formatTimeOrDateOrYesterday(mail.receivedDate)),\n\t\t\t]),\n\t\t\tm(\".bottom.flex-space-between\", [\n\t\t\t\tm(\".text-ellipsis\", mail.subject),\n\t\t\t\tm(\n\t\t\t\t\t\".icons.flex-fixed\",\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\"margin-right\": \"-3px\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t[\n\t\t\t\t\t\t// 3px to neutralize the svg icons internal border\n\t\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\t\ticon: getMailFolderIcon(mail),\n\t\t\t\t\t\t\tclass: state.selected === mail ? \"svg-content-accent-fg\" : \"svg-content-fg\",\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\t\ticon: Icons.Attachment,\n\t\t\t\t\t\t\tclass: state.selected === mail ? \"svg-content-accent-fg\" : \"svg-content-fg\",\n\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\tdisplay: mail.attachments.length > 0 ? \"\" : \"none\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}),\n\t\t\t\t\t],\n\t\t\t\t),\n\t\t\t]),\n\t\t]\n\t}\n}\n","import m, { Children, ClassComponent, Vnode } from \"mithril\"\nimport { AriaLandmarks, landmarkAttrs } from \"../AriaUtils.js\"\nimport { inputLineHeight, px, size } from \"../size.js\"\nimport { styles } from \"../styles.js\"\nimport { TabIndex } from \"../../api/common/TutanotaConstants.js\"\nimport { BootIcons } from \"./icons/BootIcons.js\"\nimport { DefaultAnimationTime } from \"../animation/Animations.js\"\nimport { Icons } from \"./icons/Icons.js\"\nimport { TextFieldType } from \"./TextField.js\"\nimport { Icon, IconAttrs, IconSize } from \"./Icon.js\"\nimport { theme } from \"../theme.js\"\nimport { lang } from \"../../misc/LanguageViewModel.js\"\nimport { BaseButton, BaseButtonAttrs } from \"./buttons/BaseButton.js\"\nimport { getOperatingClasses } from \"./GuiUtils.js\"\n\nexport interface BaseSearchBarAttrs {\n\tplaceholder?: string | null\n\ttext: string\n\tbusy: boolean\n\tdisabled?: boolean\n\tonInput: (text: string) => unknown\n\tonFocus?: () => unknown\n\tonBlur?: () => unknown\n\tonSearchClick?: () => unknown\n\tonClear?: () => unknown\n\tonInputCreated?: (dom: HTMLElement) => unknown\n\tonWrapperCreated?: (dom: HTMLElement) => unknown\n\tonKeyDown?: (keyboardEvent: KeyboardEvent) => unknown\n}\n\nexport class BaseSearchBar implements ClassComponent<BaseSearchBarAttrs> {\n\tprivate domInput!: HTMLInputElement\n\tprivate isFocused: boolean = false\n\n\tview({ attrs }: Vnode<BaseSearchBarAttrs>) {\n\t\treturn m(\n\t\t\t\".flex-end.items-center.border-radius.plr-s.pt-xs.pb-xs.search-bar.flex-grow.click\",\n\t\t\t{\n\t\t\t\tfocused: String(this.isFocused),\n\t\t\t\t...landmarkAttrs(AriaLandmarks.Search),\n\t\t\t\tclass: getOperatingClasses(attrs.disabled),\n\t\t\t\tstyle: {\n\t\t\t\t\t\"min-height\": px(inputLineHeight + 2),\n\t\t\t\t\t\"margin-top\": px(6),\n\t\t\t\t\t\"margin-bottom\": px(6),\n\t\t\t\t\t\"max-width\": styles.isUsingBottomNavigation() ? \"\" : px(350),\n\t\t\t\t},\n\t\t\t\toncreate: ({ dom }) => {\n\t\t\t\t\tattrs.onWrapperCreated?.(dom as HTMLElement)\n\t\t\t\t},\n\t\t\t\tonclick: () => {\n\t\t\t\t\tif (!attrs.disabled) {\n\t\t\t\t\t\tthis.domInput?.focus()\n\t\t\t\t\t\tattrs.onSearchClick?.()\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tstyles.isDesktopLayout()\n\t\t\t\t\t? m(Icon, {\n\t\t\t\t\t\t\ticon: BootIcons.Search,\n\t\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\tfill: theme.content_button,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t  } satisfies IconAttrs)\n\t\t\t\t\t: null,\n\t\t\t\tm(\n\t\t\t\t\t\".flex.items-center\",\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\twidth: \"100%\",\n\t\t\t\t\t\t\ttransition: `width ${DefaultAnimationTime}ms`,\n\t\t\t\t\t\t\t\"padding-left\": styles.isDesktopLayout() ? px(10) : px(6),\n\t\t\t\t\t\t\t\"padding-top\": \"3px\",\n\t\t\t\t\t\t\t\"padding-bottom\": \"3px\",\n\t\t\t\t\t\t\t\"overflow-x\": \"hidden\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t[this.renderInputField(attrs)],\n\t\t\t\t),\n\t\t\t\tattrs.busy || attrs.text\n\t\t\t\t\t? m(BaseButton, {\n\t\t\t\t\t\t\tlabel: attrs.busy ? \"loading_msg\" : \"close_alt\",\n\t\t\t\t\t\t\ticon: m(Icon, {\n\t\t\t\t\t\t\t\tcontainer: \"div\",\n\t\t\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t\t\t\ticon: attrs.busy ? BootIcons.Progress : Icons.Close,\n\t\t\t\t\t\t\t\tclass: \"center-h  \" + (attrs.busy ? \"icon-progress-search icon-progress\" : \"\"),\n\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\tfill: theme.header_button,\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\t\t\tif (!attrs.disabled) attrs.onClear?.()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tdisabled: attrs.busy,\n\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\twidth: size.icon_size_large,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t  } satisfies BaseButtonAttrs)\n\t\t\t\t\t: null,\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderInputField(attrs: BaseSearchBarAttrs): Children {\n\t\treturn m(\"input.input.input-no-clear\", {\n\t\t\t\"aria-autocomplete\": \"list\",\n\t\t\ttabindex: TabIndex.Default,\n\t\t\trole: \"combobox\",\n\t\t\tplaceholder: attrs.placeholder,\n\t\t\ttype: TextFieldType.Text,\n\t\t\tvalue: attrs.text,\n\t\t\tdisabled: attrs.disabled,\n\t\t\toncreate: (vnode) => {\n\t\t\t\tthis.domInput = vnode.dom as HTMLInputElement\n\t\t\t\tattrs.onInputCreated?.(this.domInput)\n\t\t\t},\n\t\t\tonfocus: () => {\n\t\t\t\tthis.isFocused = true\n\n\t\t\t\tattrs.onFocus?.()\n\t\t\t},\n\t\t\tonblur: () => {\n\t\t\t\tthis.isFocused = false\n\t\t\t\tattrs.onBlur?.()\n\t\t\t},\n\t\t\tonremove: () => {\n\t\t\t\tthis.domInput.onblur = null\n\t\t\t\tthis.isFocused = false\n\t\t\t},\n\t\t\toninput: () => {\n\t\t\t\tattrs.onInput(this.domInput.value)\n\t\t\t},\n\t\t\tonkeydown: (e: KeyboardEvent) => {\n\t\t\t\tattrs.onKeyDown?.(e)\n\t\t\t},\n\t\t\tstyle: {\n\t\t\t\t\"line-height\": px(inputLineHeight),\n\t\t\t},\n\t\t})\n\t}\n}\n","import m, { Component, Vnode } from \"mithril\"\nimport { px, size } from \"../../common/gui/size\"\nimport stream from \"mithril/stream\"\nimport Stream from \"mithril/stream\"\nimport type { PositionRect } from \"../../common/gui/base/Overlay\"\nimport { displayOverlay } from \"../../common/gui/base/Overlay\"\nimport type { CalendarEvent, Contact, Mail } from \"../../common/api/entities/tutanota/TypeRefs.js\"\nimport { CalendarEventTypeRef, ContactTypeRef, MailTypeRef } from \"../../common/api/entities/tutanota/TypeRefs.js\"\nimport type { Shortcut } from \"../../common/misc/KeyManager\"\nimport { isKeyPressed, keyManager } from \"../../common/misc/KeyManager\"\nimport { encodeCalendarSearchKey, getRestriction } from \"./model/SearchUtils\"\nimport { Dialog } from \"../../common/gui/base/Dialog\"\nimport type { WhitelabelChild } from \"../../common/api/entities/sys/TypeRefs.js\"\nimport { FULL_INDEXED_TIMESTAMP, Keys } from \"../../common/api/common/TutanotaConstants\"\nimport { assertMainOrNode, isApp } from \"../../common/api/common/Env\"\nimport { styles } from \"../../common/gui/styles\"\nimport { client } from \"../../common/misc/ClientDetector\"\nimport { debounce, downcast, isSameTypeRef, memoized, mod, ofClass, TypeRef } from \"@tutao/tutanota-utils\"\nimport { BrowserType } from \"../../common/misc/ClientConstants\"\nimport { hasMoreResults } from \"./model/SearchModel\"\nimport { SearchBarOverlay } from \"./SearchBarOverlay\"\nimport { IndexingNotSupportedError } from \"../../common/api/common/error/IndexingNotSupportedError\"\nimport type { SearchIndexStateInfo, SearchRestriction, SearchResult } from \"../../common/api/worker/search/SearchTypes\"\nimport { assertIsEntity, getElementId } from \"../../common/api/common/utils/EntityUtils\"\nimport { compareContacts } from \"../contacts/view/ContactGuiUtils\"\nimport { LayerType } from \"../../RootView\"\nimport { BaseSearchBar, BaseSearchBarAttrs } from \"../../common/gui/base/BaseSearchBar.js\"\nimport { SearchRouter } from \"../../common/search/view/SearchRouter.js\"\nimport { PageSize } from \"../../common/gui/base/ListUtils.js\"\nimport { generateCalendarInstancesInRange, isClientOnlyCalendar, retrieveClientOnlyEventsForUser } from \"../../common/calendar/date/CalendarUtils.js\"\nimport { ListElementEntity } from \"../../common/api/common/EntityTypes.js\"\n\nimport { loadMultipleFromLists } from \"../../common/api/common/EntityClient.js\"\nimport { mailLocator } from \"../mailLocator.js\"\n\nassertMainOrNode()\nexport type ShowMoreAction = {\n\tresultCount: number\n\tshownCount: number\n\tindexTimestamp: number\n\tallowShowMore: boolean\n}\nexport type SearchBarAttrs = {\n\tplaceholder?: string | null\n\treturnListener?: (() => unknown) | null\n\tdisabled?: boolean\n}\n\nconst MAX_SEARCH_PREVIEW_RESULTS = 10\nexport type Entry = Mail | Contact | CalendarEvent | WhitelabelChild | ShowMoreAction\ntype Entries = Array<Entry>\nexport type SearchBarState = {\n\tquery: string\n\tsearchResult: SearchResult | null\n\tindexState: SearchIndexStateInfo\n\tentities: Entries\n\tselected: Entry | null\n}\n\n// create our own copy which is not perfect because we don't benefit from the shared cache but currently there's no way to get async dependencies into\n// singletons like this (without top-level await at least)\n// once SearchBar is rewritten this should be removed\nconst searchRouter = new SearchRouter(mailLocator.throttledRouter())\n\nexport class SearchBar implements Component<SearchBarAttrs> {\n\tfocused: boolean = false\n\tprivate readonly state: Stream<SearchBarState>\n\tbusy: boolean = false\n\tprivate lastSelectedWhitelabelChildrenInfoResult: Stream<WhitelabelChild> = stream()\n\tprivate closeOverlayFunction: (() => void) | null = null\n\tprivate readonly overlayContentComponent: Component\n\tprivate confirmDialogShown: boolean = false\n\tprivate domWrapper!: HTMLElement\n\tprivate domInput!: HTMLElement\n\tprivate indexStateStream: Stream<unknown> | null = null\n\tprivate stateStream: Stream<unknown> | null = null\n\tprivate lastQueryStream: Stream<unknown> | null = null\n\n\tconstructor() {\n\t\tthis.state = stream<SearchBarState>({\n\t\t\tquery: \"\",\n\t\t\tsearchResult: null,\n\t\t\tindexState: mailLocator.search?.indexState(),\n\t\t\tentities: [] as Entries,\n\t\t\tselected: null,\n\t\t})\n\t\tthis.overlayContentComponent = {\n\t\t\tview: () => {\n\t\t\t\treturn m(SearchBarOverlay, {\n\t\t\t\t\tstate: this.state(),\n\t\t\t\t\tisQuickSearch: this.isQuickSearch(),\n\t\t\t\t\tisFocused: this.focused,\n\t\t\t\t\tselectResult: (selected) => this.selectResult(selected),\n\t\t\t\t})\n\t\t\t},\n\t\t}\n\n\t\tthis.view = this.view.bind(this)\n\t\tthis.oncreate = this.oncreate.bind(this)\n\t\tthis.onremove = this.onremove.bind(this)\n\t}\n\n\t/**\n\t * this reacts to URL changes by clearing the suggestions - the selected item may have changed (in the mail view maybe)\n\t * that shouldn't clear our current state, but if the URL changed in a way that makes the previous state outdated, we clear it.\n\t */\n\tprivate readonly onPathChange = memoized((newPath: string) => {\n\t\tif (mailLocator.search.isNewSearch(this.state().query, getRestriction(newPath))) {\n\t\t\tthis.updateState({\n\t\t\t\tsearchResult: null,\n\t\t\t\tselected: null,\n\t\t\t\tentities: [],\n\t\t\t})\n\t\t}\n\t})\n\n\tview(vnode: Vnode<SearchBarAttrs>) {\n\t\tthis.onPathChange(m.route.get())\n\n\t\treturn m(\n\t\t\t// form wrapper to isolate the search input and prevent it from being autofilled when unrelated buttons are clicked on chrome\n\t\t\t// this is done because chrome doesn't appear to respect `autocomplete=\"off\"` and will autofill the field anyway\n\t\t\t\"form.full-width\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\t\"max-width\": styles.isUsingBottomNavigation() ? \"\" : px(350),\n\t\t\t\t},\n\t\t\t\tonsubmit: (e: SubmitEvent) => {\n\t\t\t\t\te.stopPropagation()\n\t\t\t\t\te.preventDefault()\n\t\t\t\t},\n\t\t\t},\n\t\t\tm(BaseSearchBar, {\n\t\t\t\tplaceholder: vnode.attrs.placeholder,\n\t\t\t\ttext: this.state().query,\n\t\t\t\tbusy: this.busy,\n\t\t\t\tdisabled: vnode.attrs.disabled,\n\t\t\t\tonInput: (text) => this.search(text),\n\t\t\t\tonSearchClick: () => this.handleSearchClick(),\n\t\t\t\tonClear: () => {\n\t\t\t\t\tthis.clear()\n\t\t\t\t},\n\t\t\t\tonWrapperCreated: (dom) => {\n\t\t\t\t\tthis.domWrapper = dom\n\t\t\t\t\tthis.showOverlay()\n\t\t\t\t},\n\t\t\t\tonInputCreated: (dom) => {\n\t\t\t\t\tthis.domInput = dom\n\t\t\t\t},\n\t\t\t\tonFocus: () => (this.focused = true),\n\t\t\t\tonBlur: () => this.onBlur(),\n\t\t\t\tonKeyDown: (e) => this.onkeydown(e),\n\t\t\t} satisfies BaseSearchBarAttrs),\n\t\t)\n\t}\n\n\tprivate readonly onkeydown = (e: KeyboardEvent) => {\n\t\tconst { selected, entities } = this.state()\n\n\t\tconst keyHandlers = [\n\t\t\t{\n\t\t\t\tkey: Keys.F1,\n\t\t\t\texec: () => keyManager.openF1Help(),\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.ESC,\n\t\t\t\texec: () => this.clear(),\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.RETURN,\n\t\t\t\texec: () => {\n\t\t\t\t\tif (selected) {\n\t\t\t\t\t\tthis.selectResult(selected)\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.search()\n\t\t\t\t\t}\n\t\t\t\t\t// blur() is used to hide keyboard on return button click\n\t\t\t\t\tthis.domInput.blur()\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.UP,\n\t\t\t\texec: () => {\n\t\t\t\t\tif (entities.length > 0) {\n\t\t\t\t\t\tlet oldSelected = selected || entities[0]\n\n\t\t\t\t\t\tthis.updateState({\n\t\t\t\t\t\t\tselected: entities[mod(entities.indexOf(oldSelected) - 1, entities.length)],\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.DOWN,\n\t\t\t\texec: () => {\n\t\t\t\t\tif (entities.length > 0) {\n\t\t\t\t\t\tlet newSelected = selected || entities[0]\n\n\t\t\t\t\t\tthis.updateState({\n\t\t\t\t\t\t\tselected: entities[mod(entities.indexOf(newSelected) + 1, entities.length)],\n\t\t\t\t\t\t})\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t]\n\t\tlet keyHandler = keyHandlers.find((handler) => isKeyPressed(e.key, handler.key))\n\n\t\tif (keyHandler) {\n\t\t\tkeyHandler.exec()\n\t\t\te.preventDefault()\n\t\t}\n\n\t\t// disable shortcuts\n\t\te.stopPropagation()\n\t\treturn true\n\t}\n\n\toncreate() {\n\t\tif (isApp()) {\n\t\t\t// only focus in the mobile app, the search bar always exists in desktop/web and will always be grabbing attention\n\t\t\tthis.onFocus()\n\t\t}\n\t\tkeyManager.registerShortcuts(this.shortcuts)\n\t\tthis.indexStateStream = mailLocator.search.indexState.map((indexState) => {\n\t\t\t// When we finished indexing, search again forcibly to not confuse anyone with old results\n\t\t\tconst currentResult = this.state().searchResult\n\n\t\t\tif (\n\t\t\t\t!indexState.failedIndexingUpTo &&\n\t\t\t\tcurrentResult &&\n\t\t\t\tthis.state().indexState.progress !== 0 &&\n\t\t\t\tindexState.progress === 0 &&\n\t\t\t\t//if period is changed from search view a new search is triggered there,  and we do not want to overwrite its result\n\t\t\t\t!this.timePeriodHasChanged(currentResult.restriction.end, indexState.aimedMailIndexTimestamp)\n\t\t\t) {\n\t\t\t\tthis.doSearch(this.state().query, currentResult.restriction, m.redraw)\n\t\t\t}\n\n\t\t\tthis.updateState({\n\t\t\t\tindexState,\n\t\t\t})\n\t\t})\n\n\t\tthis.stateStream = this.state.map((state) => m.redraw())\n\t\tthis.lastQueryStream = mailLocator.search.lastQueryString.map((value) => {\n\t\t\t// Set value from the model when it's set from the URL e.g. reloading the page on the search screen\n\t\t\tif (value) {\n\t\t\t\tthis.updateState({\n\t\t\t\t\tquery: value,\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\t}\n\n\tonremove() {\n\t\tthis.focused = false\n\n\t\tif (this.shortcuts) keyManager.unregisterShortcuts(this.shortcuts)\n\n\t\tthis.stateStream?.end(true)\n\n\t\tthis.lastQueryStream?.end(true)\n\n\t\tthis.indexStateStream?.end(true)\n\n\t\tthis.closeOverlay()\n\t}\n\n\tprivate timePeriodHasChanged(oldEnd: number | null, aimedEnd: number): boolean {\n\t\treturn oldEnd !== aimedEnd\n\t}\n\n\t/**\n\t * Ensure that overlay exists in DOM\n\t */\n\tprivate showOverlay() {\n\t\tif (this.closeOverlayFunction == null && this.domWrapper != null) {\n\t\t\tthis.closeOverlayFunction = displayOverlay(\n\t\t\t\t() => this.makeOverlayRect(),\n\t\t\t\tthis.overlayContentComponent,\n\t\t\t\tundefined,\n\t\t\t\tundefined,\n\t\t\t\t\"dropdown-shadow border-radius\",\n\t\t\t)\n\t\t} else {\n\t\t\tm.redraw()\n\t\t}\n\t}\n\n\tprivate closeOverlay() {\n\t\tif (this.closeOverlayFunction) {\n\t\t\tthis.closeOverlayFunction()\n\n\t\t\tthis.closeOverlayFunction = null\n\t\t}\n\t}\n\n\tprivate makeOverlayRect(): PositionRect {\n\t\t// note: this is called on every render which probably thrashes our layout constantly.\n\t\t// we should at least not do it while we don't have anything to show\n\t\tlet overlayRect: PositionRect\n\n\t\tconst domRect = this.domWrapper.getBoundingClientRect()\n\n\t\tif (styles.isDesktopLayout()) {\n\t\t\toverlayRect = {\n\t\t\t\ttop: px(domRect.bottom + 5),\n\t\t\t\tright: px(window.innerWidth - domRect.right),\n\t\t\t\twidth: px(350),\n\t\t\t\tzIndex: LayerType.LowPriorityOverlay,\n\t\t\t}\n\t\t} else if (window.innerWidth < 500) {\n\t\t\toverlayRect = {\n\t\t\t\ttop: px(size.navbar_height_mobile + 6),\n\t\t\t\tleft: px(16),\n\t\t\t\tright: px(16),\n\t\t\t\tzIndex: LayerType.LowPriorityOverlay,\n\t\t\t}\n\t\t} else {\n\t\t\toverlayRect = {\n\t\t\t\ttop: px(size.navbar_height_mobile + 6),\n\t\t\t\tleft: px(domRect.left),\n\t\t\t\tright: px(window.innerWidth - domRect.right),\n\t\t\t\tzIndex: LayerType.LowPriorityOverlay,\n\t\t\t}\n\t\t}\n\n\t\treturn overlayRect\n\t}\n\n\tprivate readonly shortcuts: ReadonlyArray<Shortcut> = [\n\t\t{\n\t\t\tkey: Keys.F,\n\t\t\tenabled: () => true,\n\t\t\texec: () => {\n\t\t\t\tthis.onFocus()\n\t\t\t\tm.redraw()\n\t\t\t},\n\t\t\thelp: \"search_label\",\n\t\t},\n\t]\n\n\tprivate selectResult(result: (Mail | null) | Contact | WhitelabelChild | CalendarEvent | ShowMoreAction) {\n\t\tconst { query } = this.state()\n\n\t\tif (result != null) {\n\t\t\tlet type: TypeRef<any> | null = \"_type\" in result ? result._type : null\n\n\t\t\tif (!type) {\n\t\t\t\t// click on SHOW MORE button\n\t\t\t\tif ((result as ShowMoreAction).allowShowMore) {\n\t\t\t\t\tthis.updateSearchUrl(query)\n\t\t\t\t}\n\t\t\t} else if (isSameTypeRef(MailTypeRef, type)) {\n\t\t\t\tthis.updateSearchUrl(query, downcast(result))\n\t\t\t} else if (isSameTypeRef(ContactTypeRef, type)) {\n\t\t\t\tthis.updateSearchUrl(query, downcast(result))\n\t\t\t} else if (isSameTypeRef(CalendarEventTypeRef, type)) {\n\t\t\t\tthis.updateSearchUrl(query, downcast(result))\n\t\t\t}\n\t\t}\n\t}\n\n\thandleSearchClick() {\n\t\tif (!this.focused) {\n\t\t\tthis.onFocus()\n\t\t} else {\n\t\t\tthis.search()\n\t\t}\n\t}\n\n\tprivate getRestriction(): SearchRestriction {\n\t\treturn getRestriction(m.route.get())\n\t}\n\n\tprivate updateSearchUrl(query: string, selected?: ListElementEntity) {\n\t\tif (selected && assertIsEntity(selected, CalendarEventTypeRef)) {\n\t\t\tsearchRouter.routeTo(query, this.getRestriction(), selected && encodeCalendarSearchKey(selected))\n\t\t} else {\n\t\t\tsearchRouter.routeTo(query, this.getRestriction(), selected && getElementId(selected))\n\t\t}\n\t}\n\n\tprivate search(query?: string) {\n\t\tlet oldQuery = this.state().query\n\n\t\tif (query != null) {\n\t\t\tthis.updateState({\n\t\t\t\tquery,\n\t\t\t})\n\t\t} else {\n\t\t\tquery = oldQuery\n\t\t}\n\n\t\tlet restriction = this.getRestriction()\n\n\t\tif (!mailLocator.search.indexState().mailIndexEnabled && restriction && isSameTypeRef(restriction.type, MailTypeRef) && !this.confirmDialogShown) {\n\t\t\tthis.focused = false\n\t\t\tthis.confirmDialogShown = true\n\t\t\tDialog.confirm(\"enableSearchMailbox_msg\", \"search_label\")\n\t\t\t\t.then((confirmed) => {\n\t\t\t\t\tif (confirmed) {\n\t\t\t\t\t\tmailLocator.indexerFacade\n\t\t\t\t\t\t\t.enableMailIndexing()\n\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\tthis.search()\n\t\t\t\t\t\t\t\tthis.onFocus()\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.catch(\n\t\t\t\t\t\t\t\tofClass(IndexingNotSupportedError, () => {\n\t\t\t\t\t\t\t\t\tDialog.message(isApp() ? \"searchDisabledApp_msg\" : \"searchDisabled_msg\")\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.finally(() => (this.confirmDialogShown = false))\n\t\t} else {\n\t\t\t// Skip the search if the user is trying to bypass the search dialog\n\t\t\tif (!mailLocator.search.indexState().mailIndexEnabled && isSameTypeRef(restriction.type, MailTypeRef)) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tif (!mailLocator.search.isNewSearch(query, restriction) && oldQuery === query) {\n\t\t\t\tconst result = mailLocator.search.result()\n\n\t\t\t\tif (this.isQuickSearch() && result) {\n\t\t\t\t\tthis.showResultsInOverlay(result)\n\t\t\t\t}\n\n\t\t\t\tthis.busy = false\n\t\t\t} else {\n\t\t\t\tif (query.trim() !== \"\") {\n\t\t\t\t\tthis.busy = true\n\t\t\t\t}\n\n\t\t\t\tthis.doSearch(query, restriction, () => {\n\t\t\t\t\tthis.busy = false\n\t\t\t\t\tm.redraw()\n\t\t\t\t})\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate readonly doSearch = debounce(300, (query: string, restriction: SearchRestriction, cb: () => void) => {\n\t\tif (!this.isQuickSearch()) {\n\t\t\t// if we're already on the search view, we don't want to wait until there's a new result to update the\n\t\t\t// UI. we can directly go to the URL and let the SearchViewModel do its thing from there.\n\t\t\tsearchRouter.routeTo(query, restriction)\n\t\t\treturn cb()\n\t\t}\n\n\t\tlet useSuggestions = m.route.get().startsWith(\"/settings\")\n\t\t// We don't limit contacts because we need to download all of them to sort them. They should be cached anyway.\n\t\tconst limit = isSameTypeRef(MailTypeRef, restriction.type) ? (this.isQuickSearch() ? MAX_SEARCH_PREVIEW_RESULTS : PageSize) : null\n\n\t\tmailLocator.search\n\t\t\t.search(\n\t\t\t\t{\n\t\t\t\t\tquery: query ?? \"\",\n\t\t\t\t\trestriction,\n\t\t\t\t\tminSuggestionCount: useSuggestions ? 10 : 0,\n\t\t\t\t\tmaxResults: limit,\n\t\t\t\t},\n\t\t\t\tmailLocator.progressTracker,\n\t\t\t)\n\t\t\t.then((result) => this.loadAndDisplayResult(query, result ? result : null, limit))\n\t\t\t.finally(() => cb())\n\t})\n\n\t/** Given the result from the search load additional results if needed and then display them or set URL. */\n\tprivate loadAndDisplayResult(query: string, result: SearchResult | null, limit: number | null) {\n\t\tconst safeResult = result,\n\t\t\tsafeLimit = limit\n\n\t\tthis.updateState({\n\t\t\tsearchResult: safeResult,\n\t\t})\n\n\t\tif (!safeResult || mailLocator.search.isNewSearch(query, safeResult.restriction)) {\n\t\t\treturn\n\t\t}\n\n\t\tif (this.isQuickSearch()) {\n\t\t\tif (safeLimit && hasMoreResults(safeResult) && safeResult.results.length < safeLimit) {\n\t\t\t\tmailLocator.searchFacade.getMoreSearchResults(safeResult, safeLimit - safeResult.results.length).then((moreResults) => {\n\t\t\t\t\tif (mailLocator.search.isNewSearch(query, moreResults.restriction)) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.loadAndDisplayResult(query, moreResults, limit)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t} else {\n\t\t\t\tthis.showResultsInOverlay(safeResult)\n\t\t\t}\n\t\t} else {\n\t\t\t// instances will be displayed as part of the list of the search view, when the search view is displayed\n\t\t\tsearchRouter.routeTo(query, safeResult.restriction)\n\t\t}\n\t}\n\n\tprivate clear() {\n\t\tif (m.route.get().startsWith(\"/search\")) {\n\t\t\t// this needs to happen in this order, otherwise the list's result subscription will override our\n\t\t\t// routing.\n\t\t\tthis.updateSearchUrl(\"\")\n\t\t\tmailLocator.search.result(null)\n\t\t}\n\n\t\tthis.updateState({\n\t\t\tquery: \"\",\n\t\t\tentities: [],\n\t\t\tselected: null,\n\t\t\tsearchResult: null,\n\t\t})\n\t}\n\n\tprivate async showResultsInOverlay(result: SearchResult): Promise<void> {\n\t\tconst filteredEvents = result.results.filter(([calendarId, eventId]) => !isClientOnlyCalendar(calendarId))\n\n\t\tconst eventsRepository = await mailLocator.calendarEventsRepository()\n\t\tconst entries = [\n\t\t\t...(await loadMultipleFromLists(result.restriction.type, mailLocator.entityClient, filteredEvents)),\n\t\t\t...(await retrieveClientOnlyEventsForUser(mailLocator.logins, result.results, eventsRepository.getBirthdayEvents())),\n\t\t]\n\n\t\t// If there was no new search while we've been downloading the result\n\t\tif (!mailLocator.search.isNewSearch(result.query, result.restriction)) {\n\t\t\tconst { filteredEntries, couldShowMore } = this.filterResults(entries, result.restriction)\n\n\t\t\tif (\n\t\t\t\tresult.query.trim() !== \"\" &&\n\t\t\t\t(filteredEntries.length === 0 || hasMoreResults(result) || couldShowMore || result.currentIndexTimestamp !== FULL_INDEXED_TIMESTAMP)\n\t\t\t) {\n\t\t\t\tconst moreEntry: ShowMoreAction = {\n\t\t\t\t\tresultCount: result.results.length,\n\t\t\t\t\tshownCount: filteredEntries.length,\n\t\t\t\t\tindexTimestamp: result.currentIndexTimestamp,\n\t\t\t\t\tallowShowMore: true,\n\t\t\t\t}\n\t\t\t\tfilteredEntries.push(moreEntry)\n\t\t\t}\n\n\t\t\tthis.updateState({\n\t\t\t\tentities: filteredEntries,\n\t\t\t\tselected: filteredEntries[0],\n\t\t\t})\n\t\t}\n\t}\n\n\tprivate isQuickSearch(): boolean {\n\t\treturn !m.route.get().startsWith(\"/search\")\n\t}\n\n\tprivate filterResults(instances: Array<Entry>, restriction: SearchRestriction): { filteredEntries: Entries; couldShowMore: boolean } {\n\t\tif (isSameTypeRef(restriction.type, ContactTypeRef)) {\n\t\t\t// Sort contacts by name\n\t\t\treturn {\n\t\t\t\tfilteredEntries: instances\n\t\t\t\t\t.slice() // we can't modify the given array\n\t\t\t\t\t.sort((o1, o2) => compareContacts(o1 as any, o2 as any))\n\t\t\t\t\t.slice(0, MAX_SEARCH_PREVIEW_RESULTS),\n\t\t\t\tcouldShowMore: instances.length > MAX_SEARCH_PREVIEW_RESULTS,\n\t\t\t}\n\t\t} else if (isSameTypeRef(restriction.type, CalendarEventTypeRef)) {\n\t\t\tconst range = { start: restriction.start ?? 0, end: restriction.end ?? 0 }\n\t\t\tconst generatedInstances = generateCalendarInstancesInRange(downcast(instances), range, MAX_SEARCH_PREVIEW_RESULTS + 1)\n\t\t\treturn {\n\t\t\t\tfilteredEntries: generatedInstances.slice(0, MAX_SEARCH_PREVIEW_RESULTS),\n\t\t\t\tcouldShowMore: generatedInstances.length > MAX_SEARCH_PREVIEW_RESULTS,\n\t\t\t}\n\t\t}\n\t\treturn { filteredEntries: instances.slice(0, MAX_SEARCH_PREVIEW_RESULTS), couldShowMore: instances.length > MAX_SEARCH_PREVIEW_RESULTS }\n\t}\n\n\tprivate onFocus() {\n\t\tif (!mailLocator.search.indexingSupported) {\n\t\t\tDialog.message(isApp() ? \"searchDisabledApp_msg\" : \"searchDisabled_msg\")\n\t\t} else if (!this.focused) {\n\t\t\tthis.focused = true\n\t\t\t// setTimeout to fix bug in current Safari with losing focus\n\t\t\tsetTimeout(\n\t\t\t\t() => {\n\t\t\t\t\tthis.domInput.focus()\n\n\t\t\t\t\tthis.search()\n\t\t\t\t},\n\t\t\t\tclient.browser === BrowserType.SAFARI ? 200 : 0,\n\t\t\t)\n\t\t}\n\t}\n\n\tprivate onBlur() {\n\t\tthis.focused = false\n\n\t\tif (this.state().query === \"\") {\n\t\t\tif (m.route.get().startsWith(\"/search\")) {\n\t\t\t\tconst restriction = searchRouter.getRestriction()\n\t\t\t\tsearchRouter.routeTo(\"\", restriction)\n\t\t\t}\n\t\t}\n\t\tm.redraw()\n\t}\n\n\tprivate updateState(update: Partial<SearchBarState>): SearchBarState {\n\t\tconst newState = Object.assign({}, this.state(), update)\n\n\t\tthis.state(newState)\n\n\t\treturn newState\n\t}\n}\n\n// Should be changed to not be a singleton and be proper component (instantiated by mithril).\n// We need to extract some state of it into some kind of viewModel, pluggable depending on the current view but this requires complete rewrite of SearchBar.\nexport const searchBar = new SearchBar()\n"],"mappings":"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"}