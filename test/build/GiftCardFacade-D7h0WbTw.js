
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { assertNotNull, base64ExtToBase64, base64ToBase64Ext, base64ToBase64Url, base64UrlToBase64, getFirstOrThrow, isEmpty, uint8ArrayToBase64 } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import { ProgrammingError } from "./ProgrammingError-D8yJGVtm.js";
import "./Env-D5xGlXfw.js";
import { GroupType } from "./TutanotaConstants-3bwAESYA.js";
import "./CryptoError-PqdvQky4.js";
import { GENERATED_MAX_ID, elementIdPart } from "./EntityUtils-RQxXZlcV.js";
import "./TypeModels-BktRFNDN.js";
import { createGiftCardCreateData, createGiftCardRedeemData } from "./TypeRefs-BP1jvX9p.js";
import { aes256RandomKey, base64ToKey, bitArrayToUint8Array, sha256Hash } from "./dist-DcZ1Y4qd.js";
import { GiftCardRedeemService, GiftCardService } from "./Services-CZFE0084.js";
import { encryptKeyWithVersionedKey } from "./CryptoWrapper-BTtEczdP.js";

//#region ../src/common/api/worker/facades/lazy/GiftCardFacade.ts
const ID_LENGTH = GENERATED_MAX_ID.length;
const KEY_LENGTH_128_BIT_B64 = 24;
const KEY_LENGTH_256_BIT_B64 = 44;
var GiftCardFacade = class {
	constructor(user, customer, serviceExecutor, cryptoFacade, keyLoaderFacade) {
		this.user = user;
		this.customer = customer;
		this.serviceExecutor = serviceExecutor;
		this.cryptoFacade = cryptoFacade;
		this.keyLoaderFacade = keyLoaderFacade;
	}
	async generateGiftCard(message, value) {
		const adminGroupIds = this.user.getGroupIds(GroupType.Admin);
		if (isEmpty(adminGroupIds)) throw new Error("missing admin membership");
		const adminGroupId = getFirstOrThrow(adminGroupIds);
		const ownerKey = await this.keyLoaderFacade.getCurrentSymGroupKey(adminGroupId);
		const sessionKey = aes256RandomKey();
		const ownerEncSessionKey = encryptKeyWithVersionedKey(ownerKey, sessionKey);
		const { giftCard } = await this.serviceExecutor.post(GiftCardService, createGiftCardCreateData({
			message,
			keyHash: sha256Hash(bitArrayToUint8Array(sessionKey)),
			value,
			ownerEncSessionKey: ownerEncSessionKey.key,
			ownerKeyVersion: ownerEncSessionKey.encryptingKeyVersion.toString()
		}), { sessionKey });
		return giftCard;
	}
	getGiftCardInfo(id, key) {
		return this.serviceExecutor.get(GiftCardRedeemService, createGiftCardRedeemData({
			giftCardInfo: id,
			keyHash: sha256Hash(bitArrayToUint8Array(base64ToKey(key))),
			countryCode: ""
		}), { sessionKey: base64ToKey(key) });
	}
	async redeemGiftCard(giftCardInfoId, key, countryCode) {
		if ((await this.customer.loadAccountingInfo()).invoiceCountry == null && countryCode == null) throw new ProgrammingError("User must provide a country");
		await this.serviceExecutor.post(GiftCardRedeemService, createGiftCardRedeemData({
			giftCardInfo: giftCardInfoId,
			keyHash: sha256Hash(bitArrayToUint8Array(base64ToKey(key))),
			countryCode
		}));
	}
	async encodeGiftCardToken(giftCard) {
		const key = assertNotNull(await this.cryptoFacade.resolveSessionKeyForInstance(giftCard));
		return this.encodeToken(elementIdPart(giftCard._id), bitArrayToUint8Array(key));
	}
	async decodeGiftCardToken(token) {
		const id = base64ToBase64Ext(base64UrlToBase64(token.slice(0, ID_LENGTH)));
		const key = base64UrlToBase64(token.slice(ID_LENGTH, token.length));
		if (id.length !== ID_LENGTH || key.length !== KEY_LENGTH_128_BIT_B64 && key.length !== KEY_LENGTH_256_BIT_B64) throw new Error("invalid token");
		return {
			id,
			key
		};
	}
	encodeToken(id, key) {
		if (id.length !== ID_LENGTH) throw new Error("Invalid gift card params");
		const keyBase64 = uint8ArrayToBase64(key);
		if (keyBase64.length !== KEY_LENGTH_128_BIT_B64 && keyBase64.length !== KEY_LENGTH_256_BIT_B64) throw new Error("Invalid gift card key");
		const idPart = base64ToBase64Url(base64ExtToBase64(id));
		const keyPart = base64ToBase64Url(keyBase64);
		return idPart + keyPart;
	}
};

//#endregion
export { GiftCardFacade };
//# sourceMappingURL=GiftCardFacade-D7h0WbTw.js.map