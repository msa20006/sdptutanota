
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { mithril_default } from "./mithril-Csg4iNnm.js";
import { debounce, downcast, isEmpty, isSameTypeRef, memoized, mod, ofClass } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import { assertMainOrNode, isApp } from "./Env-D5xGlXfw.js";
import "./WhitelabelCustomizations-D1L5qbZi.js";
import { lang } from "./LanguageViewModel-BNC5ekpO.js";
import { DefaultAnimationTime, inputLineHeight, px, size, styles, theme } from "./HtmlUtils-C-ecR7U7.js";
import { BrowserType, client, companyTeamLabel } from "./ClientDetector-D0v6Vqu6.js";
import { FULL_INDEXED_TIMESTAMP, Keys, TabIndex } from "./TutanotaConstants-3bwAESYA.js";
import { BaseButton, BootIcons, Button, ButtonType, Icon, IconSize } from "./Icon-BuqNK7vz.js";
import { Icons } from "./Icons-Dl3nFav5.js";
import { isKeyPressed, keyManager } from "./KeyManager-B0OGXEyJ.js";
import "./WindowFacade-B9kSBKw7.js";
import { LayerType, displayOverlay } from "./Modal-g4c-b9IU.js";
import { AriaLandmarks, Dialog, TextFieldType, getOperatingClasses, landmarkAttrs } from "./Dialog-B6-HFvZd.js";
import "./CountryList-DkVQtcTj.js";
import "./IconButton-DsU60HJ_.js";
import "./RestError-D17JEBMr.js";
import "./SuspensionError-okvIjE4H.js";
import "./LoginIncompleteError-CpiW0a0l.js";
import "./CryptoError-PqdvQky4.js";
import "./error-DDmy0eAT.js";
import "./ErrorUtils-o1-v67Dd.js";
import "./RecipientsNotFoundError-D8oGE7A_.js";
import "./OfflineDbClosedError-CAwHTI6J.js";
import "./OutOfSyncError-Ck2yBBO8.js";
import "./DbError-CcwZaPG2.js";
import { IndexingNotSupportedError } from "./QuotaExceededError-nFM6SdTn.js";
import "./CancelledError-FjP5S_cR.js";
import "./FileOpenError-C1_8yoXr.js";
import "./DeviceStorageUnavailableError-m4Jk_0xN.js";
import "./MailBodyTooLargeError-C2i0rX_0.js";
import "./ImportError-CIXw37Kv.js";
import "./PermissionError-BGDsHuAh.js";
import "./KeyPermanentlyInvalidatedError-DJjt81rl.js";
import "./ParserCombinator-D38ofgFx.js";
import "./ExportError-DzgStBnl.js";
import { require_stream } from "./stream-u2PttBAC.js";
import "./luxon-D6cgmg6Q.js";
import "./CalendarEventWhenModel-DEedSoEH.js";
import { assertIsEntity, getElementId } from "./EntityUtils-RQxXZlcV.js";
import "./CommonCalendarUtils-DKaO7v1K.js";
import { formatDate, formatTimeOrDateOrYesterday } from "./Formatter-zB15D6XI.js";
import "./TypeModels-XIXYys8J.js";
import { CalendarEventTypeRef, ContactTypeRef, MailTypeRef } from "./TypeRefs-CR3TLWn0.js";
import "./TypeModels-BktRFNDN.js";
import "./TypeRefs-BP1jvX9p.js";
import { generateCalendarInstancesInRange, getTimeZone, isClientOnlyCalendar, retrieveClientOnlyEventsForUser } from "./CalendarUtils-C6jeYrj9.js";
import "./ProgressMonitor-HBfOF56H.js";
import "./Notifications-DLibQbV7.js";
import "./EntityFunctions-l6CncM5C.js";
import "./TypeModels-ZqCk-pGw.js";
import "./ModelInfo-DEa-Yxv2.js";
import { loadMultipleFromLists } from "./EntityClient-B0RSdk2i.js";
import "./SetupMultipleError-B6uY8P-x.js";
import "./dist-DcZ1Y4qd.js";
import "./Services-CZFE0084.js";
import "./Services-DCx-CeM7.js";
import "./CalendarFacade-CaovxyFN.js";
import "./CalendarModel-DK762b35.js";
import "./EntityUpdateUtils-B5iTKMk4.js";
import "./GroupUtils-CpT2lvVS.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import "./ImportExportUtils-B1MoOmZ0.js";
import "./FormatValidator-2BBermUe.js";
import "./UserError-DfXlMLTl.js";
import "./MailAddressParser-BgYy6oyp.js";
import "./GroupUtils-0ZkLIAeC.js";
import "./DataFile-CY7uuk9j.js";
import "./FileUtils-W-u2-gZz.js";
import "./ProgressDialog-CJfJjh62.js";
import "./BlobUtils-D5ADcckZ.js";
import "./SharedMailUtils-AmFaSJP6.js";
import "./PasswordUtils-C4jlV9GF.js";
import "./Recipient-BFxhfecW.js";
import "./BirthdayUtils-BcCMglSq.js";
import { getContactListName } from "./ContactUtils-Bbon2oOk.js";
import "./RecipientsModel-DxwXuUvL.js";
import { formatEventDuration } from "./CalendarGuiUtils-CkzhFM1K.js";
import "./UpgradeRequiredError-CbZr7beN.js";
import "./ColorPickerModel-C1q3CWkL.js";
import "./SubscriptionDialogs-DAlWs68I.js";
import "./ExternalLink-rsCBSC7U.js";
import "./ToggleButton-DxuDa0rS.js";
import "./ErrorHandler-DbW1lJbv.js";
import "./SnackBar-CoP3lSVs.js";
import "./Credentials-BM35X_na.js";
import "./NotificationOverlay-C-YNCUiT.js";
import "./Checkbox-WCw-l_7A.js";
import "./Expander-Bautb1_0.js";
import "./ClipboardUtils-mz40UK5S.js";
import "./ErrorReporter-7sfLhWZg.js";
import "./Services-CupYet_j.js";
import "./BubbleButton-DGGInJMg.js";
import "./SessionType-rxSDsswH.js";
import "./PasswordField-CPKPoLq8.js";
import "./PasswordRequestDialog-B7ZIVTVw.js";
import "./ErrorHandlerImpl-DRpk8tE9.js";
import "./DeviceConfig-payZM407.js";
import { PageSize } from "./List-CdKNFQkI.js";
import "./CustomerUtils-DmaZpb7Y.js";
import "./EventQueue-c-5UmjJa.js";
import "./EntityRestClient--6dT7ZRF.js";
import "./MessageDispatcher-wJwFhXWv.js";
import "./SqlValue-CkGu32Qd.js";
import "./Sql-C9YhYNym.js";
import "./RestClient-CmoHrId4.js";
import "./LoginViewModel-BX-8ry63.js";
import "./LoginButton-DzCRy0Yt.js";
import "./UsageTestModel-CjGx3RZo.js";
import "./inlineImagesUtils-BekMwI7k.js";
import "./CommonMailUtils-DNufl6ib.js";
import "./PermissionType-Bwii3hCe.js";
import "./AttachmentBubble-CloIefNF.js";
import "./RouteChange-im6yOAT2.js";
import { encodeCalendarSearchKey, getRestriction } from "./SearchUtils-Cu31OiTT.js";
import { SearchRouter } from "./SearchRouter-DLuBEl-3.js";
import { hasMoreResults, mailLocator } from "./mailLocator-CrvEYt1k.js";
import "./PageContextLoginListener-dgY8O-YX.js";
import "./Scheduler-B2H65_EO.js";
import "./MailUtils-ChhZAFAd.js";
import "./FolderSystem-DLrUB8MO.js";
import "./MailChecks-PhVUoR7f.js";
import { getMailFolderIcon, getSenderOrRecipientHeading, isTutanotaTeamMail } from "./MailViewerViewModel-D_nVDgz3.js";
import "./emlUtils-afBEUvhM.js";
import "./LoadingState-DqrMrOAm.js";
import { compareContacts } from "./ContactGuiUtils-BOj2qfyh.js";
import { Badge } from "./Badge-Z06TZUGC.js";
import { IndexingErrorReason } from "./SearchTypes-BQT7nl8f.js";

//#region ../src/mail-app/search/SearchBarOverlay.ts
var SearchBarOverlay = class {
	view({ attrs }) {
		const { state } = attrs;
		return [this._renderIndexingStatus(state, attrs), state.entities && !isEmpty(state.entities) && attrs.isQuickSearch && attrs.isFocused ? this.renderResults(state, attrs) : null];
	}
	renderResults(state, attrs) {
		return mithril_default("ul.list.click.mail-list", [state.entities.map((result) => {
			return mithril_default("li.plr-l.flex-v-center.", {
				style: {
					height: px(52),
					"border-left": px(size.border_selection) + " solid transparent"
				},
				onmousedown: (e) => e.preventDefault(),
				onclick: () => attrs.selectResult(result),
				class: state.selected === result ? "row-selected" : ""
			}, this.renderResult(state, result));
		})]);
	}
	_renderIndexingStatus(state, attrs) {
		if (attrs.isFocused || !attrs.isQuickSearch && client.isDesktopDevice()) if (state.indexState.failedIndexingUpTo != null) return this.renderError(state.indexState.failedIndexingUpTo, attrs);
else if (state.indexState.progress !== 0) return this._renderProgress(state, attrs);
else return null;
else return null;
	}
	_renderProgress(state, attrs) {
		return mithril_default(".flex.col.rel", [mithril_default(".plr-l.pt-s.pb-s.flex.items-center.flex-space-between.mr-negative-s", { style: {
			height: px(52),
			borderLeft: `${px(size.border_selection)} solid transparent`
		} }, [mithril_default(".top.flex-space-between.col", mithril_default(".bottom.flex-space-between", mithril_default("", lang.get("indexedMails_label", { "{count}": state.indexState.indexedMailCount })))), state.indexState.progress !== 100 ? mithril_default("div", { onmousedown: (e) => e.preventDefault() }, mithril_default(Button, {
			label: "cancel_action",
			click: () => mailLocator.indexerFacade.cancelMailIndexing(),
			type: ButtonType.Secondary
		})) : null]), mithril_default(".abs", { style: {
			backgroundColor: theme.content_accent,
			height: "2px",
			width: state.indexState.progress + "%",
			bottom: 0
		} })]);
	}
	renderError(failedIndexingUpTo, attrs) {
		const errorMessageKey = attrs.state.indexState.error === IndexingErrorReason.ConnectionLost ? "indexingFailedConnection_error" : "indexing_error";
		return mithril_default(".flex.rel", [mithril_default(".plr-l.pt-s.pb-s.flex.items-center.flex-space-between.mr-negative-s", { style: {
			height: px(52),
			borderLeft: `${px(size.border_selection)} solid transparent`
		} }, [mithril_default(".small", lang.get(errorMessageKey)), mithril_default("div", { onmousedown: (e) => e.preventDefault() }, mithril_default(Button, {
			label: "retry_action",
			click: () => mailLocator.indexerFacade.extendMailIndex(failedIndexingUpTo),
			type: ButtonType.Secondary
		}))])]);
	}
	renderResult(state, result) {
		let type = "_type" in result ? result._type : null;
		if (!type) return this.renderShowMoreAction(downcast(result));
else if (isSameTypeRef(MailTypeRef, type)) return this.renderMailResult(downcast(result), state);
else if (isSameTypeRef(ContactTypeRef, type)) return this.renderContactResult(downcast(result));
else if (isSameTypeRef(CalendarEventTypeRef, type)) return this.renderCalendarEventResult(downcast(result));
else return [];
	}
	renderShowMoreAction(result) {
		let showMoreAction = result;
		let infoText;
		let indexInfo;
		if (showMoreAction.resultCount === 0) {
			infoText = lang.get("searchNoResults_msg");
			if (locator.logins.getUserController().isFreeAccount()) indexInfo = lang.get("changeTimeFrame_msg");
		} else if (showMoreAction.allowShowMore) infoText = lang.get("showMore_action");
else infoText = lang.get("moreResultsFound_msg", { "{1}": showMoreAction.resultCount - showMoreAction.shownCount });
		if (showMoreAction.indexTimestamp > FULL_INDEXED_TIMESTAMP && !indexInfo) indexInfo = lang.get("searchedUntil_msg") + " " + formatDate(new Date(showMoreAction.indexTimestamp));
		return indexInfo ? [mithril_default(".top.flex-center", infoText), mithril_default(".bottom.flex-center.small", indexInfo)] : mithril_default("li.plr-l.pt-s.pb-s.items-center.flex-center", mithril_default(".flex-center", infoText));
	}
	renderContactResult(contact) {
		return [mithril_default(".top.flex-space-between", mithril_default(".name", getContactListName(contact))), mithril_default(".bottom.flex-space-between", mithril_default("small.mail-address", contact.mailAddresses && contact.mailAddresses.length > 0 ? contact.mailAddresses[0].address : ""))];
	}
	renderCalendarEventResult(event) {
		return [mithril_default(".top.flex-space-between", mithril_default(".name.text-ellipsis", { title: event.summary }, event.summary)), mithril_default(".bottom.flex-space-between", mithril_default("small.mail-address", formatEventDuration(event, getTimeZone(), false)))];
	}
	renderMailResult(mail, state) {
		return [mithril_default(".top.flex-space-between.badge-line-height", [
			isTutanotaTeamMail(mail) ? mithril_default(Badge, { classes: ".small.mr-s" }, companyTeamLabel) : null,
			mithril_default("small.text-ellipsis", getSenderOrRecipientHeading(mail, true)),
			mithril_default("small.text-ellipsis.flex-fixed", formatTimeOrDateOrYesterday(mail.receivedDate))
		]), mithril_default(".bottom.flex-space-between", [mithril_default(".text-ellipsis", mail.subject), mithril_default(".icons.flex-fixed", { style: { "margin-right": "-3px" } }, [mithril_default(Icon, {
			icon: getMailFolderIcon(mail),
			class: state.selected === mail ? "svg-content-accent-fg" : "svg-content-fg"
		}), mithril_default(Icon, {
			icon: Icons.Attachment,
			class: state.selected === mail ? "svg-content-accent-fg" : "svg-content-fg",
			style: { display: mail.attachments.length > 0 ? "" : "none" }
		})])])];
	}
};

//#endregion
//#region ../src/common/gui/base/BaseSearchBar.ts
var BaseSearchBar = class {
	domInput;
	isFocused = false;
	view({ attrs }) {
		return mithril_default(".flex-end.items-center.border-radius.plr-s.pt-xs.pb-xs.search-bar.flex-grow.click", {
			focused: String(this.isFocused),
			...landmarkAttrs(AriaLandmarks.Search),
			class: getOperatingClasses(attrs.disabled),
			style: {
				"min-height": px(inputLineHeight + 2),
				"margin-top": px(6),
				"margin-bottom": px(6),
				"max-width": styles.isUsingBottomNavigation() ? "" : px(350)
			},
			oncreate: ({ dom }) => {
				attrs.onWrapperCreated?.(dom);
			},
			onclick: () => {
				if (!attrs.disabled) {
					this.domInput?.focus();
					attrs.onSearchClick?.();
				}
			}
		}, [
			styles.isDesktopLayout() ? mithril_default(Icon, {
				icon: BootIcons.Search,
				size: IconSize.Medium,
				style: { fill: theme.content_button }
			}) : null,
			mithril_default(".flex.items-center", { style: {
				width: "100%",
				transition: `width ${DefaultAnimationTime}ms`,
				"padding-left": styles.isDesktopLayout() ? px(10) : px(6),
				"padding-top": "3px",
				"padding-bottom": "3px",
				"overflow-x": "hidden"
			} }, [this.renderInputField(attrs)]),
			attrs.busy || attrs.text ? mithril_default(BaseButton, {
				label: attrs.busy ? "loading_msg" : "close_alt",
				icon: mithril_default(Icon, {
					container: "div",
					size: IconSize.Medium,
					icon: attrs.busy ? BootIcons.Progress : Icons.Close,
					class: "center-h  " + (attrs.busy ? "icon-progress-search icon-progress" : ""),
					style: { fill: theme.header_button }
				}),
				onclick: () => {
					if (!attrs.disabled) attrs.onClear?.();
				},
				disabled: attrs.busy,
				style: { width: size.icon_size_large }
			}) : null
		]);
	}
	renderInputField(attrs) {
		return mithril_default("input.input.input-no-clear", {
			"aria-autocomplete": "list",
			tabindex: TabIndex.Default,
			role: "combobox",
			placeholder: attrs.placeholder,
			type: TextFieldType.Text,
			value: attrs.text,
			disabled: attrs.disabled,
			oncreate: (vnode) => {
				this.domInput = vnode.dom;
				attrs.onInputCreated?.(this.domInput);
			},
			onfocus: () => {
				this.isFocused = true;
				attrs.onFocus?.();
			},
			onblur: () => {
				this.isFocused = false;
				attrs.onBlur?.();
			},
			onremove: () => {
				this.domInput.onblur = null;
				this.isFocused = false;
			},
			oninput: () => {
				attrs.onInput(this.domInput.value);
			},
			onkeydown: (e) => {
				attrs.onKeyDown?.(e);
			},
			style: { "line-height": px(inputLineHeight) }
		});
	}
};

//#endregion
//#region ../src/mail-app/search/SearchBar.ts
var import_stream = __toESM(require_stream(), 1);
assertMainOrNode();
const MAX_SEARCH_PREVIEW_RESULTS = 10;
const searchRouter = new SearchRouter(mailLocator.throttledRouter());
var SearchBar = class {
	focused = false;
	state;
	busy = false;
	lastSelectedWhitelabelChildrenInfoResult = (0, import_stream.default)();
	closeOverlayFunction = null;
	overlayContentComponent;
	confirmDialogShown = false;
	domWrapper;
	domInput;
	indexStateStream = null;
	stateStream = null;
	lastQueryStream = null;
	constructor() {
		this.state = (0, import_stream.default)({
			query: "",
			searchResult: null,
			indexState: mailLocator.search?.indexState(),
			entities: [],
			selected: null
		});
		this.overlayContentComponent = { view: () => {
			return mithril_default(SearchBarOverlay, {
				state: this.state(),
				isQuickSearch: this.isQuickSearch(),
				isFocused: this.focused,
				selectResult: (selected) => this.selectResult(selected)
			});
		} };
		this.view = this.view.bind(this);
		this.oncreate = this.oncreate.bind(this);
		this.onremove = this.onremove.bind(this);
	}
	/**
	* this reacts to URL changes by clearing the suggestions - the selected item may have changed (in the mail view maybe)
	* that shouldn't clear our current state, but if the URL changed in a way that makes the previous state outdated, we clear it.
	*/
	onPathChange = memoized((newPath) => {
		if (mailLocator.search.isNewSearch(this.state().query, getRestriction(newPath))) this.updateState({
			searchResult: null,
			selected: null,
			entities: []
		});
	});
	view(vnode) {
		this.onPathChange(mithril_default.route.get());
		return mithril_default(
			// form wrapper to isolate the search input and prevent it from being autofilled when unrelated buttons are clicked on chrome
			// this is done because chrome doesn't appear to respect `autocomplete="off"` and will autofill the field anyway
			"form.full-width",
			{
				style: { "max-width": styles.isUsingBottomNavigation() ? "" : px(350) },
				onsubmit: (e) => {
					e.stopPropagation();
					e.preventDefault();
				}
			},
			mithril_default(BaseSearchBar, {
				placeholder: vnode.attrs.placeholder,
				text: this.state().query,
				busy: this.busy,
				disabled: vnode.attrs.disabled,
				onInput: (text) => this.search(text),
				onSearchClick: () => this.handleSearchClick(),
				onClear: () => {
					this.clear();
				},
				onWrapperCreated: (dom) => {
					this.domWrapper = dom;
					this.showOverlay();
				},
				onInputCreated: (dom) => {
					this.domInput = dom;
				},
				onFocus: () => this.focused = true,
				onBlur: () => this.onBlur(),
				onKeyDown: (e) => this.onkeydown(e)
			})
);
	}
	onkeydown = (e) => {
		const { selected, entities } = this.state();
		const keyHandlers = [
			{
				key: Keys.F1,
				exec: () => keyManager.openF1Help()
			},
			{
				key: Keys.ESC,
				exec: () => this.clear()
			},
			{
				key: Keys.RETURN,
				exec: () => {
					if (selected) this.selectResult(selected);
else this.search();
					this.domInput.blur();
				}
			},
			{
				key: Keys.UP,
				exec: () => {
					if (entities.length > 0) {
						let oldSelected = selected || entities[0];
						this.updateState({ selected: entities[mod(entities.indexOf(oldSelected) - 1, entities.length)] });
					}
				}
			},
			{
				key: Keys.DOWN,
				exec: () => {
					if (entities.length > 0) {
						let newSelected = selected || entities[0];
						this.updateState({ selected: entities[mod(entities.indexOf(newSelected) + 1, entities.length)] });
					}
				}
			}
		];
		let keyHandler = keyHandlers.find((handler) => isKeyPressed(e.key, handler.key));
		if (keyHandler) {
			keyHandler.exec();
			e.preventDefault();
		}
		e.stopPropagation();
		return true;
	};
	oncreate() {
		if (isApp()) this.onFocus();
		keyManager.registerShortcuts(this.shortcuts);
		this.indexStateStream = mailLocator.search.indexState.map((indexState) => {
			const currentResult = this.state().searchResult;
			if (!indexState.failedIndexingUpTo && currentResult && this.state().indexState.progress !== 0 && indexState.progress === 0 && !this.timePeriodHasChanged(currentResult.restriction.end, indexState.aimedMailIndexTimestamp)) this.doSearch(this.state().query, currentResult.restriction, mithril_default.redraw);
			this.updateState({ indexState });
		});
		this.stateStream = this.state.map((state) => mithril_default.redraw());
		this.lastQueryStream = mailLocator.search.lastQueryString.map((value) => {
			if (value) this.updateState({ query: value });
		});
	}
	onremove() {
		this.focused = false;
		if (this.shortcuts) keyManager.unregisterShortcuts(this.shortcuts);
		this.stateStream?.end(true);
		this.lastQueryStream?.end(true);
		this.indexStateStream?.end(true);
		this.closeOverlay();
	}
	timePeriodHasChanged(oldEnd, aimedEnd) {
		return oldEnd !== aimedEnd;
	}
	/**
	* Ensure that overlay exists in DOM
	*/
	showOverlay() {
		if (this.closeOverlayFunction == null && this.domWrapper != null) this.closeOverlayFunction = displayOverlay(() => this.makeOverlayRect(), this.overlayContentComponent, undefined, undefined, "dropdown-shadow border-radius");
else mithril_default.redraw();
	}
	closeOverlay() {
		if (this.closeOverlayFunction) {
			this.closeOverlayFunction();
			this.closeOverlayFunction = null;
		}
	}
	makeOverlayRect() {
		let overlayRect;
		const domRect = this.domWrapper.getBoundingClientRect();
		if (styles.isDesktopLayout()) overlayRect = {
			top: px(domRect.bottom + 5),
			right: px(window.innerWidth - domRect.right),
			width: px(350),
			zIndex: LayerType.LowPriorityOverlay
		};
else if (window.innerWidth < 500) overlayRect = {
			top: px(size.navbar_height_mobile + 6),
			left: px(16),
			right: px(16),
			zIndex: LayerType.LowPriorityOverlay
		};
else overlayRect = {
			top: px(size.navbar_height_mobile + 6),
			left: px(domRect.left),
			right: px(window.innerWidth - domRect.right),
			zIndex: LayerType.LowPriorityOverlay
		};
		return overlayRect;
	}
	shortcuts = [{
		key: Keys.F,
		enabled: () => true,
		exec: () => {
			this.onFocus();
			mithril_default.redraw();
		},
		help: "search_label"
	}];
	selectResult(result) {
		const { query } = this.state();
		if (result != null) {
			let type = "_type" in result ? result._type : null;
			if (!type) {
				if (result.allowShowMore) this.updateSearchUrl(query);
			} else if (isSameTypeRef(MailTypeRef, type)) this.updateSearchUrl(query, downcast(result));
else if (isSameTypeRef(ContactTypeRef, type)) this.updateSearchUrl(query, downcast(result));
else if (isSameTypeRef(CalendarEventTypeRef, type)) this.updateSearchUrl(query, downcast(result));
		}
	}
	handleSearchClick() {
		if (!this.focused) this.onFocus();
else this.search();
	}
	getRestriction() {
		return getRestriction(mithril_default.route.get());
	}
	updateSearchUrl(query, selected) {
		if (selected && assertIsEntity(selected, CalendarEventTypeRef)) searchRouter.routeTo(query, this.getRestriction(), selected && encodeCalendarSearchKey(selected));
else searchRouter.routeTo(query, this.getRestriction(), selected && getElementId(selected));
	}
	search(query) {
		let oldQuery = this.state().query;
		if (query != null) this.updateState({ query });
else query = oldQuery;
		let restriction = this.getRestriction();
		if (!mailLocator.search.indexState().mailIndexEnabled && restriction && isSameTypeRef(restriction.type, MailTypeRef) && !this.confirmDialogShown) {
			this.focused = false;
			this.confirmDialogShown = true;
			Dialog.confirm("enableSearchMailbox_msg", "search_label").then((confirmed) => {
				if (confirmed) mailLocator.indexerFacade.enableMailIndexing().then(() => {
					this.search();
					this.onFocus();
				}).catch(ofClass(IndexingNotSupportedError, () => {
					Dialog.message(isApp() ? "searchDisabledApp_msg" : "searchDisabled_msg");
				}));
			}).finally(() => this.confirmDialogShown = false);
		} else {
			if (!mailLocator.search.indexState().mailIndexEnabled && isSameTypeRef(restriction.type, MailTypeRef)) return;
			if (!mailLocator.search.isNewSearch(query, restriction) && oldQuery === query) {
				const result = mailLocator.search.result();
				if (this.isQuickSearch() && result) this.showResultsInOverlay(result);
				this.busy = false;
			} else {
				if (query.trim() !== "") this.busy = true;
				this.doSearch(query, restriction, () => {
					this.busy = false;
					mithril_default.redraw();
				});
			}
		}
	}
	doSearch = debounce(300, (query, restriction, cb) => {
		if (!this.isQuickSearch()) {
			searchRouter.routeTo(query, restriction);
			return cb();
		}
		let useSuggestions = mithril_default.route.get().startsWith("/settings");
		const limit = isSameTypeRef(MailTypeRef, restriction.type) ? this.isQuickSearch() ? MAX_SEARCH_PREVIEW_RESULTS : PageSize : null;
		mailLocator.search.search({
			query: query ?? "",
			restriction,
			minSuggestionCount: useSuggestions ? 10 : 0,
			maxResults: limit
		}, mailLocator.progressTracker).then((result) => this.loadAndDisplayResult(query, result ? result : null, limit)).finally(() => cb());
	});
	/** Given the result from the search load additional results if needed and then display them or set URL. */
	loadAndDisplayResult(query, result, limit) {
		const safeResult = result, safeLimit = limit;
		this.updateState({ searchResult: safeResult });
		if (!safeResult || mailLocator.search.isNewSearch(query, safeResult.restriction)) return;
		if (this.isQuickSearch()) if (safeLimit && hasMoreResults(safeResult) && safeResult.results.length < safeLimit) mailLocator.searchFacade.getMoreSearchResults(safeResult, safeLimit - safeResult.results.length).then((moreResults) => {
			if (mailLocator.search.isNewSearch(query, moreResults.restriction)) return;
else this.loadAndDisplayResult(query, moreResults, limit);
		});
else this.showResultsInOverlay(safeResult);
else searchRouter.routeTo(query, safeResult.restriction);
	}
	clear() {
		if (mithril_default.route.get().startsWith("/search")) {
			this.updateSearchUrl("");
			mailLocator.search.result(null);
		}
		this.updateState({
			query: "",
			entities: [],
			selected: null,
			searchResult: null
		});
	}
	async showResultsInOverlay(result) {
		const filteredEvents = result.results.filter(([calendarId, eventId]) => !isClientOnlyCalendar(calendarId));
		const eventsRepository = await mailLocator.calendarEventsRepository();
		const entries = [...await loadMultipleFromLists(result.restriction.type, mailLocator.entityClient, filteredEvents), ...await retrieveClientOnlyEventsForUser(mailLocator.logins, result.results, eventsRepository.getBirthdayEvents())];
		if (!mailLocator.search.isNewSearch(result.query, result.restriction)) {
			const { filteredEntries, couldShowMore } = this.filterResults(entries, result.restriction);
			if (result.query.trim() !== "" && (filteredEntries.length === 0 || hasMoreResults(result) || couldShowMore || result.currentIndexTimestamp !== FULL_INDEXED_TIMESTAMP)) {
				const moreEntry = {
					resultCount: result.results.length,
					shownCount: filteredEntries.length,
					indexTimestamp: result.currentIndexTimestamp,
					allowShowMore: true
				};
				filteredEntries.push(moreEntry);
			}
			this.updateState({
				entities: filteredEntries,
				selected: filteredEntries[0]
			});
		}
	}
	isQuickSearch() {
		return !mithril_default.route.get().startsWith("/search");
	}
	filterResults(instances, restriction) {
		if (isSameTypeRef(restriction.type, ContactTypeRef)) return {
			filteredEntries: instances.slice().sort((o1, o2) => compareContacts(o1, o2)).slice(0, MAX_SEARCH_PREVIEW_RESULTS),
			couldShowMore: instances.length > MAX_SEARCH_PREVIEW_RESULTS
		};
else if (isSameTypeRef(restriction.type, CalendarEventTypeRef)) {
			const range = {
				start: restriction.start ?? 0,
				end: restriction.end ?? 0
			};
			const generatedInstances = generateCalendarInstancesInRange(downcast(instances), range, MAX_SEARCH_PREVIEW_RESULTS + 1);
			return {
				filteredEntries: generatedInstances.slice(0, MAX_SEARCH_PREVIEW_RESULTS),
				couldShowMore: generatedInstances.length > MAX_SEARCH_PREVIEW_RESULTS
			};
		}
		return {
			filteredEntries: instances.slice(0, MAX_SEARCH_PREVIEW_RESULTS),
			couldShowMore: instances.length > MAX_SEARCH_PREVIEW_RESULTS
		};
	}
	onFocus() {
		if (!mailLocator.search.indexingSupported) Dialog.message(isApp() ? "searchDisabledApp_msg" : "searchDisabled_msg");
else if (!this.focused) {
			this.focused = true;
			setTimeout(() => {
				this.domInput.focus();
				this.search();
			}, client.browser === BrowserType.SAFARI ? 200 : 0);
		}
	}
	onBlur() {
		this.focused = false;
		if (this.state().query === "") {
			if (mithril_default.route.get().startsWith("/search")) {
				const restriction = searchRouter.getRestriction();
				searchRouter.routeTo("", restriction);
			}
		}
		mithril_default.redraw();
	}
	updateState(update) {
		const newState = Object.assign({}, this.state(), update);
		this.state(newState);
		return newState;
	}
};
const searchBar = new SearchBar();

//#endregion
export { searchBar };
//# sourceMappingURL=SearchBar-BqjukxBW.js.map