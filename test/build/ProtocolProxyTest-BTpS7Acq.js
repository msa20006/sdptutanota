
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { utf8Uint8ArrayToString } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import "./Env-D5xGlXfw.js";
import "./WhitelabelCustomizations-D1L5qbZi.js";
import "./LanguageViewModel-BNC5ekpO.js";
import "./RestError-D17JEBMr.js";
import "./SuspensionError-okvIjE4H.js";
import "./LoginIncompleteError-CpiW0a0l.js";
import "./CryptoError-PqdvQky4.js";
import "./error-DDmy0eAT.js";
import "./ErrorUtils-o1-v67Dd.js";
import "./RecipientsNotFoundError-D8oGE7A_.js";
import "./OfflineDbClosedError-CAwHTI6J.js";
import "./OutOfSyncError-Ck2yBBO8.js";
import "./DbError-CcwZaPG2.js";
import "./QuotaExceededError-nFM6SdTn.js";
import "./CancelledError-FjP5S_cR.js";
import "./FileOpenError-C1_8yoXr.js";
import "./DeviceStorageUnavailableError-m4Jk_0xN.js";
import "./MailBodyTooLargeError-C2i0rX_0.js";
import "./ImportError-CIXw37Kv.js";
import "./PermissionError-BGDsHuAh.js";
import "./KeyPermanentlyInvalidatedError-DJjt81rl.js";
import "./ParserCombinator-D38ofgFx.js";
import "./ExportError-DzgStBnl.js";
import "./EntityUtils-RQxXZlcV.js";
import "./TypeModels-XIXYys8J.js";
import "./TypeRefs-CR3TLWn0.js";
import "./dist-DcZ1Y4qd.js";
import "./FileUtils-W-u2-gZz.js";
import "./MessageDispatcher-wJwFhXWv.js";
import "./ConfigKeys-B1UD5FwS.js";
import "./DesktopLog-yAgEoQsh.js";
import { dist_default } from "./dist-Ci1bEzYU.js";
import { require_testdouble } from "./testdouble-IbRSnrC0.js";
import "./PathUtils-DFfSo_TG.js";
import "./DesktopFileFacade-o-Coc2Lq.js";
import { doHandleProtocols, handleProtocols } from "./ProtocolProxy-D3mwaAa4.js";
import path from "node:path";

//#region tests/desktop/net/ProtocolProxyTest.ts
var import_testdouble = __toESM(require_testdouble(), 1);
dist_default.spec("ProtocolProxy", function() {
	let fetchMock;
	dist_default.beforeEach(function() {
		fetchMock = (0, import_testdouble.func)();
	});
	dist_default("will only be intercepted once on a session", function() {
		const protocol = (0, import_testdouble.object)();
		const ses = { protocol };
		(0, import_testdouble.when)(protocol.isProtocolHandled("http")).thenReturn(true);
		(0, import_testdouble.when)(protocol.isProtocolHandled("https")).thenReturn(true);
		(0, import_testdouble.when)(protocol.isProtocolHandled("asset")).thenReturn(true);
		handleProtocols(ses, "none");
		(0, import_testdouble.verify)(protocol.handle("https", import_testdouble.matchers.anything()), { times: 0 });
		(0, import_testdouble.verify)(protocol.handle("http", import_testdouble.matchers.anything()), { times: 0 });
		(0, import_testdouble.verify)(protocol.handle("asset", import_testdouble.matchers.anything()), { times: 0 });
	});
	dist_default("protocol will be handled if it wasn't before", function() {
		const protocol = (0, import_testdouble.object)();
		const ses = { protocol };
		(0, import_testdouble.when)(protocol.isProtocolHandled("http")).thenReturn(false, true);
		(0, import_testdouble.when)(protocol.isProtocolHandled("https")).thenReturn(false, true);
		(0, import_testdouble.when)(protocol.isProtocolHandled("asset")).thenReturn(false, true);
		handleProtocols(ses, "none");
		(0, import_testdouble.verify)(protocol.handle("http", import_testdouble.matchers.anything()), { times: 1 });
		(0, import_testdouble.verify)(protocol.handle("https", import_testdouble.matchers.anything()), { times: 1 });
		(0, import_testdouble.verify)(protocol.handle("asset", import_testdouble.matchers.anything()), { times: 1 });
	});
	dist_default.spec("OPTIONS gets intercepted", function() {
		dist_default("fetch", async function() {
			const protocol = (0, import_testdouble.object)();
			const ses = { protocol };
			const httpCaptor = import_testdouble.matchers.captor();
			const httpsCaptor = import_testdouble.matchers.captor();
			(0, import_testdouble.when)(protocol.isProtocolHandled("http")).thenReturn(false, true);
			(0, import_testdouble.when)(protocol.isProtocolHandled("https")).thenReturn(false, true);
			(0, import_testdouble.when)(protocol.isProtocolHandled("asset")).thenReturn(true);
			(0, import_testdouble.when)(protocol.handle("http", httpCaptor.capture())).thenReturn(undefined);
			(0, import_testdouble.when)(protocol.handle("https", httpsCaptor.capture())).thenReturn(undefined);
			(0, import_testdouble.when)(protocol.handle("asset", import_testdouble.matchers.anything())).thenReturn(undefined);
			const path$1 = (0, import_testdouble.object)();
			const fs = (0, import_testdouble.object)();
			doHandleProtocols(ses, "none", fetchMock, path$1, fs);
			const request = (url) => ({
				method: "OPTIONS",
				headers: {},
				url
			});
			const responseHeaders = {
				"access-control-allow-origin": "*",
				"access-control-allow-methods": "POST, GET, PUT, DELETE",
				"access-control-allow-headers": "*"
			};
			const responseHttp = await httpCaptor.value(request("http://no/where"));
			const responseHttps = await httpsCaptor.value(request("https://no/where"));
			dist_default(responseHttp.status).equals(200);
			dist_default(headersToObject(responseHttp.headers)).deepEquals(responseHeaders);
			dist_default(responseHttps.status).equals(200);
			dist_default(headersToObject(responseHttps.headers)).deepEquals(responseHeaders);
		});
	});
	dist_default.spec("methods other than OPTIONS get proxied", function() {
		dist_default("GET http", async function() {
			const protocol = (0, import_testdouble.object)();
			const ses = { protocol };
			const captor = import_testdouble.matchers.captor();
			(0, import_testdouble.when)(protocol.isProtocolHandled(import_testdouble.matchers.anything())).thenReturn(false, true);
			(0, import_testdouble.when)(protocol.isProtocolHandled(import_testdouble.matchers.anything())).thenReturn(false, true);
			(0, import_testdouble.when)(protocol.handle("http", captor.capture())).thenReturn(undefined);
			(0, import_testdouble.when)(protocol.handle("https", import_testdouble.matchers.anything())).thenReturn(undefined);
			(0, import_testdouble.when)(protocol.handle("asset", import_testdouble.matchers.anything())).thenReturn(undefined);
			const request = {
				arrayBuffer: () => Promise.resolve(new Uint8Array()),
				method: "GET",
				headers: new Headers({ "some-header": "header-value" }),
				url: "http://no/where",
				referrer: ""
			};
			const path$1 = (0, import_testdouble.object)();
			const fs = (0, import_testdouble.object)();
			const responseSymbol = "abc";
			(0, import_testdouble.when)(fetchMock("http://no/where", import_testdouble.matchers.anything())).thenResolve(new Response("abc"));
			doHandleProtocols(ses, "none", fetchMock, path$1, fs);
			const responseFromSubject = await captor.value(request);
			dist_default(await readResponse(responseFromSubject)).deepEquals(responseSymbol);
		});
	});
	dist_default.spec("asset protocol works", function() {
		let protocol = (0, import_testdouble.object)();
		let ses;
		let promises = (0, import_testdouble.object)();
		let fs = { promises };
		dist_default.beforeEach(function() {
			(0, import_testdouble.when)(protocol.isProtocolHandled("http")).thenReturn(true);
			(0, import_testdouble.when)(protocol.isProtocolHandled("https")).thenReturn(true);
			(0, import_testdouble.when)(protocol.isProtocolHandled("asset")).thenReturn(false, true);
			ses = { protocol };
		});
		dist_default("returns files that can be found", async function() {
			const captor = import_testdouble.matchers.captor();
			(0, import_testdouble.when)(protocol.handle("asset", captor.capture())).thenReturn(undefined);
			(0, import_testdouble.when)(fs.promises.readFile("/tutanota/assets/noodles.txt")).thenResolve("hello OK");
			doHandleProtocols(ses, "/tutanota/assets", fetchMock, path, fs);
			const request = { url: "asset://app/noodles.txt" };
			const responseFromSubject = await captor.value(request);
			dist_default(await responseFromSubject.text()).deepEquals("hello OK");
		});
		dist_default("normalizes pathname before resolving", async function() {
			const captor = import_testdouble.matchers.captor();
			(0, import_testdouble.when)(protocol.handle("asset", captor.capture())).thenReturn(undefined);
			(0, import_testdouble.when)(fs.promises.readFile("/tutanota/assets/win32/noodles.exe")).thenResolve("hello OK");
			doHandleProtocols(ses, "/tutanota/assets", fetchMock, path, fs);
			const request = { url: "asset://app/subfolder/../../../win32/noodles.exe" };
			const responseFromSubject = await captor.value(request);
			dist_default(await responseFromSubject.text()).deepEquals("hello OK");
		});
		dist_default("rejects invalid protocol", async function() {
			const captor = import_testdouble.matchers.captor();
			(0, import_testdouble.when)(protocol.handle("asset", captor.capture())).thenReturn(undefined);
			doHandleProtocols(ses, "/tutanota/assets", fetchMock, path, fs);
			const request = { url: "basset://app/noodles.txt" };
			const responseFromSubject = await captor.value(request);
			dist_default(await responseFromSubject.status).deepEquals(404);
		});
		dist_default("rejects non-app hostname", async function() {
			const captor = import_testdouble.matchers.captor();
			(0, import_testdouble.when)(protocol.handle("asset", captor.capture())).thenReturn(undefined);
			doHandleProtocols(ses, "/tutanota/assets", fetchMock, path, fs);
			const request = { url: "asset://bop/noodles.txt" };
			const responseFromSubject = await captor.value(request);
			dist_default(await responseFromSubject.status).deepEquals(404);
		});
	});
});
function headersToObject(headers) {
	const returnObject = {};
	headers.forEach((value, key) => {
		returnObject[key] = value;
	});
	return returnObject;
}
async function readResponse(response) {
	let result = await response.body.getReader().read();
	return utf8Uint8ArrayToString(result.value);
}

//#endregion
//# sourceMappingURL=ProtocolProxyTest-BTpS7Acq.js.map