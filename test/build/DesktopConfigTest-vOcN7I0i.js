
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { defer, downcast, noOp } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import { ProgrammingError } from "./ProgrammingError-D8yJGVtm.js";
import "./Env-D5xGlXfw.js";
import { CryptoError } from "./CryptoError-PqdvQky4.js";
import "./error-DDmy0eAT.js";
import { DesktopConfigEncKey, DesktopConfigKey } from "./ConfigKeys-B1UD5FwS.js";
import { log } from "./DesktopLog-yAgEoQsh.js";
import { dist_default } from "./dist-Ci1bEzYU.js";
import { require_testdouble } from "./testdouble-IbRSnrC0.js";

//#region ../src/common/desktop/config/DesktopConfig.ts
var DesktopConfig = class {
	buildConfig;
	desktopConfig;
	desktopConfigFile;
	onValueSetListeners = {};
	constructor(migrator, keyStoreFacade, cryptoFacade) {
		this.migrator = migrator;
		this.keyStoreFacade = keyStoreFacade;
		this.cryptoFacade = cryptoFacade;
		this.buildConfig = defer();
		this.desktopConfig = defer();
	}
	async init(buildConfigFile, desktopConfigFile) {
		const packageJson = await buildConfigFile.readJSON();
		const buildConfig = packageJson["tutao-config"];
		this.buildConfig.resolve(buildConfig);
		this.desktopConfigFile = desktopConfigFile;
		const defaultConf = buildConfig["defaultDesktopConfig"];
		await this.desktopConfigFile.ensurePresence(defaultConf);
		const userConf = await this.desktopConfigFile.readJSON() || defaultConf;
		const populatedConfig = Object.assign({}, defaultConf, userConf);
		const desktopConfig = await this.migrator.applyMigrations(downcast(buildConfig["configMigrationFunction"]), populatedConfig);
		await this.desktopConfigFile.writeJSON(desktopConfig);
		this.desktopConfig.resolve(desktopConfig);
	}
	async getConst(key) {
		const config = await this.buildConfig.promise;
		return key ? config[key] : config;
	}
	async getVar(key) {
		const desktopConfig = await this.desktopConfig.promise;
		if (key in DesktopConfigKey) return desktopConfig[key];
else if (key in DesktopConfigEncKey) return this.getEncryptedVar(key);
	}
	async getEncryptedVar(key) {
		const desktopConfig = await this.desktopConfig.promise;
		const encryptedValue = desktopConfig[key];
		if (!encryptedValue) return null;
		const deviceKey = await this.keyStoreFacade.getDeviceKey();
		try {
			return this.cryptoFacade.aesDecryptObject(deviceKey, downcast(encryptedValue));
		} catch (e) {
			if (e instanceof CryptoError) {
				log.error(`Could not decrypt encrypted var ${key}`, e);
				await this.setVar(key, null);
				return null;
			}
		}
	}
	async setEncryptedVar(key, value) {
		const deviceKey = await this.keyStoreFacade.getDeviceKey();
		let encryptedValue;
		if (value != null) encryptedValue = this.cryptoFacade.aesEncryptObject(deviceKey, value);
else encryptedValue = null;
		const desktopConfig = await this.desktopConfig.promise;
		desktopConfig[key] = encryptedValue;
	}
	/**
	* change the runtime-defined config and write it to disk
	* @param key value to change. a key of "any" will replace the conf object with value.
	* @param value the new value
	* @returns {never|Promise<any>|Promise<void>|*}
	*/
	async setVar(key, value) {
		const desktopConfig = await this.desktopConfig.promise;
		if (Object.values(DesktopConfigKey).includes(downcast(key))) desktopConfig[key] = value;
else if (Object.values(DesktopConfigEncKey).includes(downcast(key))) if (value == null) desktopConfig[key] = value;
else await this.setEncryptedVar(key, value);
else throw new ProgrammingError("Unknown config key: " + key);
		await this.saveAndNotify(key, value);
	}
	async saveAndNotify(key, value) {
		const desktopConfig = await this.desktopConfig.promise;
		await this.desktopConfigFile.writeJSON(desktopConfig);
		this.notifyChangeListeners(key, value);
	}
	/**
	* listen to changes in the config
	* @param key the value you want to listen for. a key of "any" will be called with the complete config for any changes to the config.
	* @param cb a function that's called when the config changes. argument is the new value or the entire config object in case of the "any" event.
	* @returns {DesktopConfig}
	*/
	on(key, cb) {
		return this.addListener(key, {
			cb,
			once: false
		});
	}
	once(key, cb) {
		return this.addListener(key, {
			cb,
			once: true
		});
	}
	addListener(key, callback) {
		if (!this.onValueSetListeners[key]) this.onValueSetListeners[key] = [callback];
else this.onValueSetListeners[key].push(callback);
		return this;
	}
	removeAllListeners(key) {
		if (key) this.onValueSetListeners[key] = [];
else this.onValueSetListeners = {};
		return this;
	}
	removeListener(key, cb) {
		if (!this.onValueSetListeners[key]) return this;
		const indexOfListener = this.onValueSetListeners[key].findIndex((listener) => listener.cb === cb);
		this.onValueSetListeners[key].splice(indexOfListener, 1);
		return this;
	}
	notifyChangeListeners(key, value) {
		const listeners = this.onValueSetListeners[key];
		if (listeners == null) return;
		for (const { cb } of listeners) cb(value);
		this.onValueSetListeners[key] = listeners.filter((listener) => !listener.once);
	}
};

//#endregion
//#region tests/desktop/config/DesktopConfigTest.ts
var import_testdouble = __toESM(require_testdouble(), 1);
dist_default.spec("DesktopConfigTest", function() {
	let desktopConfig;
	let configMigrator;
	let keyStoreFacade;
	let desktopCrypto;
	let desktopConfigFile;
	dist_default.beforeEach(async function() {
		const buildConfigFile = (0, import_testdouble.object)();
		(0, import_testdouble.when)(buildConfigFile.readJSON()).thenResolve({ "tutao-config": {
			defaultDesktopConfig: {},
			configMigrationFunction: ""
		} });
		(0, import_testdouble.when)(buildConfigFile.writeJSON(import_testdouble.matchers.anything())).thenResolve(undefined);
		(0, import_testdouble.when)(buildConfigFile.ensurePresence(import_testdouble.matchers.anything())).thenResolve(undefined);
		desktopConfigFile = (0, import_testdouble.object)();
		(0, import_testdouble.when)(desktopConfigFile.readJSON()).thenResolve({ "tutao-config": {
			defaultDesktopConfig: {},
			configMigrationFunction: ""
		} });
		(0, import_testdouble.when)(desktopConfigFile.writeJSON(import_testdouble.matchers.anything())).thenResolve(undefined);
		(0, import_testdouble.when)(desktopConfigFile.ensurePresence(import_testdouble.matchers.anything())).thenResolve(undefined);
		configMigrator = (0, import_testdouble.object)();
		const configCaptor = import_testdouble.matchers.captor();
		(0, import_testdouble.when)(configMigrator.applyMigrations(import_testdouble.matchers.anything(), configCaptor.capture())).thenDo(() => Promise.resolve(configCaptor.value));
		keyStoreFacade = (0, import_testdouble.object)();
		(0, import_testdouble.when)(keyStoreFacade.getDeviceKey()).thenResolve([
			1,
			2,
			3
		]);
		(0, import_testdouble.when)(keyStoreFacade.getKeyChainKey()).thenResolve([
			4,
			5,
			6
		]);
		desktopCrypto = (0, import_testdouble.object)();
		(0, import_testdouble.when)(desktopCrypto.aesDecryptObject(import_testdouble.matchers.anything(), import_testdouble.matchers.anything())).thenReturn("decrypted");
		(0, import_testdouble.when)(desktopCrypto.aesEncryptObject(import_testdouble.matchers.anything(), import_testdouble.matchers.anything())).thenReturn("encrypted");
		desktopConfig = new DesktopConfig(configMigrator, keyStoreFacade, desktopCrypto);
		await desktopConfig.init(buildConfigFile, desktopConfigFile);
	});
	dist_default("setVar updates config value", async function() {
		const cb1 = (0, import_testdouble.function)();
		desktopConfig.on(DesktopConfigKey.lastBounds, cb1);
		await desktopConfig.setVar(DesktopConfigKey.lastBounds, "change");
		(0, import_testdouble.verify)(cb1("change"), { times: 1 });
		(0, import_testdouble.verify)(desktopConfigFile.writeJSON(import_testdouble.matchers.argThat((a) => a.lastBounds === "change")), { times: 2 });
	});
	dist_default("setVar updates correct config value", async function() {
		const cb1 = (0, import_testdouble.function)();
		const cb2 = (0, import_testdouble.function)();
		desktopConfig.on(DesktopConfigKey.lastBounds, cb1);
		desktopConfig.on(DesktopConfigKey.spellcheck, cb2);
		dist_default(await desktopConfig.getVar(DesktopConfigKey.lastBounds)).equals(undefined);
		dist_default(await desktopConfig.getVar(DesktopConfigKey.spellcheck)).equals(undefined);
		await desktopConfig.setVar(DesktopConfigKey.lastBounds, "change");
		dist_default(await desktopConfig.getVar(DesktopConfigKey.lastBounds)).equals("change");
		dist_default(await desktopConfig.getVar(DesktopConfigKey.spellcheck)).equals(undefined);
		(0, import_testdouble.verify)(cb1("change"), { times: 1 });
		(0, import_testdouble.verify)(cb2(import_testdouble.matchers.anything()), { times: 0 });
		(0, import_testdouble.verify)(desktopConfigFile.writeJSON(import_testdouble.matchers.argThat((a) => a.lastBounds === "change")), { times: 2 });
	});
	dist_default("removeAllListeners creates empty OnValueSetListeners object", function() {
		desktopConfig.on(DesktopConfigKey.lastBounds, () => {});
		desktopConfig.on(DesktopConfigKey.spellcheck, () => {});
		desktopConfig.removeAllListeners();
		dist_default(Object.keys(desktopConfig.onValueSetListeners).length).equals(0);
	});
	dist_default("removeAllListeners removes all listeners from correct key", function() {
		desktopConfig.on(DesktopConfigKey.lastBounds, () => {});
		desktopConfig.on(DesktopConfigKey.spellcheck, () => {});
		desktopConfig.removeAllListeners(DesktopConfigKey.lastBounds);
		dist_default(desktopConfig.onValueSetListeners[DesktopConfigKey.lastBounds].length).equals(0);
	});
	dist_default("removeListener removes correct listener from correct key", function() {
		const cb1 = () => noOp();
		const cb2 = () => noOp();
		desktopConfig.on(DesktopConfigKey.lastBounds, cb1);
		desktopConfig.on(DesktopConfigKey.lastBounds, cb2);
		desktopConfig.removeListener(DesktopConfigKey.lastBounds, cb2);
		dist_default(desktopConfig.onValueSetListeners[DesktopConfigKey.lastBounds].length).equals(1);
		dist_default(desktopConfig.onValueSetListeners[DesktopConfigKey.lastBounds][0]).deepEquals({
			cb: cb1,
			once: false
		});
	});
	dist_default("once listeners are only called once", async function() {
		const onceCb = (0, import_testdouble.function)();
		desktopConfig.once(DesktopConfigKey.runAsTrayApp, onceCb);
		(0, import_testdouble.verify)(onceCb(import_testdouble.matchers.anything()), { times: 0 });
		await desktopConfig.setVar(DesktopConfigKey.runAsTrayApp, true);
		(0, import_testdouble.verify)(onceCb(import_testdouble.matchers.anything()), { times: 1 });
		await desktopConfig.setVar(DesktopConfigKey.runAsTrayApp, false);
		(0, import_testdouble.verify)(onceCb(import_testdouble.matchers.anything()), { times: 1 });
	});
	dist_default("on listeners are called multiple times", async function() {
		const onCb = (0, import_testdouble.function)();
		desktopConfig.on(DesktopConfigKey.runAsTrayApp, onCb);
		(0, import_testdouble.verify)(onCb(import_testdouble.matchers.anything()), { times: 0 });
		await desktopConfig.setVar(DesktopConfigKey.runAsTrayApp, true);
		(0, import_testdouble.verify)(onCb(import_testdouble.matchers.anything()), { times: 1 });
		await desktopConfig.setVar(DesktopConfigKey.runAsTrayApp, false);
		(0, import_testdouble.verify)(onCb(import_testdouble.matchers.anything()), { times: 2 });
	});
});

//#endregion
//# sourceMappingURL=DesktopConfigTest-vOcN7I0i.js.map