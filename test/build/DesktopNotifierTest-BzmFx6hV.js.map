{"version":3,"file":"DesktopNotifierTest-BzmFx6hV.js","names":["appIcon: NativeImage","icon1: NativeImage","desktopTray: DesktopTray","notificationFactory: ElectronNotificationFactory"],"sources":["../tests/desktop/DesktopNotifierTest.ts"],"sourcesContent":["import o from \"@tutao/otest\"\nimport type { ElectronNotificationFactory } from \"../../../src/common/desktop/NotificatonFactory.js\"\nimport { defer, delay, downcast } from \"@tutao/tutanota-utils\"\nimport { DesktopNotifier } from \"../../../src/common/desktop/DesktopNotifier.js\"\nimport type { DesktopTray } from \"../../../src/common/desktop/tray/DesktopTray.js\"\nimport type { NativeImage } from \"electron\"\nimport { spy } from \"@tutao/tutanota-test-utils\"\n\n// just a placeholder, symbol to make sure it's the same instance\nconst appIcon: NativeImage = downcast(Symbol(\"appIcon\"))\nconst icon1: NativeImage = downcast(Symbol(\"icon1\"))\n\no.spec(\"Desktop Notifier Test\", function () {\n\tconst notificationStartDelay = 10\n\tlet createdNotifications\n\tlet desktopTray: DesktopTray\n\tlet notificationFactory: ElectronNotificationFactory\n\tlet notificationMade = defer<void>()\n\to.beforeEach(function () {\n\t\tcreatedNotifications = []\n\t\tdesktopTray = downcast({\n\t\t\tgetAppIcon: () => appIcon,\n\t\t\tupdate: spy(() => {}),\n\t\t\tsetBadge: spy(() => {}),\n\t\t})\n\t\tnotificationFactory = downcast({\n\t\t\tisSupported: () => true,\n\t\t\tmakeNotification: spy((props, click) => {\n\t\t\t\tconst n = {\n\t\t\t\t\tclose: spy(),\n\t\t\t\t\tclick,\n\t\t\t\t}\n\t\t\t\tcreatedNotifications.push(n)\n\t\t\t\tnotificationMade.resolve()\n\t\t\t\treturn () => n.close()\n\t\t\t}),\n\t\t})\n\t})\n\to(\"show no notifications before call to start()\", async function () {\n\t\tconst notifier = new DesktopNotifier(desktopTray, notificationFactory)\n\t\tnotifier.showOneShot({\n\t\t\ttitle: \"Title1\",\n\t\t\tbody: \"Body1\",\n\t\t\ticon: icon1,\n\t\t})\n\t\tnotifier.submitGroupedNotification(\"Title2\", \"Message\", \"gn1\", () => {})\n\t\to(notificationFactory.makeNotification.calls).deepEquals([])\n\t\tnotifier.start(notificationStartDelay)\n\t\tsetImmediate(() => {\n\t\t\to(notificationFactory.makeNotification.calls).deepEquals([])\n\t\t})\n\t\tawait delay(notificationStartDelay * 3)\n\t\to(notificationFactory.makeNotification.calls[0][0]).deepEquals({\n\t\t\ttitle: \"Title1\",\n\t\t\tbody: \"Body1\",\n\t\t\ticon: icon1,\n\t\t})\n\t\to(desktopTray.update.callCount).equals(1)\n\t})\n\to(\"show no notifications when no notifications available\", async function () {\n\t\tdowncast(notificationFactory).isSupported = () => false\n\n\t\tconst notifier = new DesktopNotifier(desktopTray, notificationFactory)\n\t\tnotifier\n\t\t\t.showOneShot({\n\t\t\t\ttitle: \"Title1\",\n\t\t\t\tbody: \"Body1\",\n\t\t\t\ticon: icon1,\n\t\t\t})\n\t\t\t.catch(() => {})\n\t\t// this should fail\n\t\tnotifier.submitGroupedNotification(\"Title2\", \"Message\", \"gn1\", () => {})\n\t\tnotifier.start(notificationStartDelay)\n\t\tawait delay(notificationStartDelay * 1.1)\n\t\to(notificationFactory.makeNotification.callCount).equals(0)\n\t})\n\to(\"grouped notifications replace each other\", async function () {\n\t\tconst notifier = new DesktopNotifier(desktopTray, notificationFactory)\n\t\tnotifier.start(notificationStartDelay)\n\t\tawait delay(notificationStartDelay * 1.1)\n\t\t// Notice the same \"gn1\". The second replaces the first and calls its \"close\"\n\t\tnotifier.submitGroupedNotification(\"Title1\", \"Message1\", \"gn1\", () => {})\n\t\tawait notificationMade.promise\n\t\tnotificationMade = defer()\n\t\tnotifier.submitGroupedNotification(\"Title2\", \"Message2\", \"gn1\", () => {})\n\t\tawait notificationMade.promise\n\t\tnotificationMade = defer()\n\t\tnotifier.submitGroupedNotification(\"Title3\", \"Message3\", \"gn2\", () => {})\n\t\tawait notificationMade.promise\n\t\to(createdNotifications.length).equals(3)\n\t\to(createdNotifications[0].close.callCount).equals(1)\n\t\to(createdNotifications[1].close.callCount).equals(0)\n\t\to(createdNotifications[1].close.callCount).equals(0)\n\t\to(desktopTray.update.callCount).equals(3)\n\t\to(desktopTray.setBadge.callCount).equals(3)\n\t\to(notifier.hasNotificationForId(\"gn1\")).equals(true)\n\t\to(notifier.hasNotificationForId(\"gn2\")).equals(true)\n\t})\n\to(\"grouped notification disappear after clicking\", async function () {\n\t\tconst notifier = new DesktopNotifier(desktopTray, notificationFactory)\n\t\tnotifier.start(notificationStartDelay)\n\t\tconst clickHandler = spy(() => notifier.resolveGroupedNotification(\"gn1\"))\n\t\tnotifier.submitGroupedNotification(\"Title1\", \"Message1\", \"gn1\", clickHandler)\n\t\t// not shown yet\n\t\to(createdNotifications.length).equals(0)\n\t\to(desktopTray.update.callCount).equals(0)\n\t\to(notifier.hasNotificationForId(\"gn1\")).equals(false)\n\t\to(clickHandler.callCount).equals(0)\n\t\tawait delay(notificationStartDelay * 2)\n\t\tcreatedNotifications[0].click()\n\t\t// shown and removed\n\t\to(clickHandler.callCount).equals(1)\n\t\to(createdNotifications.length).equals(1)\n\t\to(createdNotifications[0].close.callCount).equals(1)\n\t\to(desktopTray.update.callCount).equals(2)\n\t\to(desktopTray.setBadge.callCount).equals(1)\n\t\to(notifier.hasNotificationForId(\"gn1\")).equals(false)\n\t})\n})\n"],"mappings":"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"}