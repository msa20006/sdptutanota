
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { assertNotNull, noOp, ofClass } from "./dist-CJHwsXKY.js";
import { ProgrammingError } from "./ProgrammingError-D8yJGVtm.js";
import { lang } from "./LanguageViewModel-BNC5ekpO.js";
import { MailMethod, getAttendeeStatus, mailMethodToCalendarMethod } from "./TutanotaConstants-3bwAESYA.js";
import { windowFacade } from "./WindowFacade-B9kSBKw7.js";
import { RecipientsNotFoundError } from "./RecipientsNotFoundError-D8oGE7A_.js";
import { cleanMailAddress, findAttendeeInAddresses, findRecipientWithAddress } from "./CommonCalendarUtils-DKaO7v1K.js";
import { createCalendarEventAttendee } from "./TypeRefs-CR3TLWn0.js";
import { getTimeZone } from "./CalendarUtils-C6jeYrj9.js";
import { RecipientField } from "./SharedMailUtils-AmFaSJP6.js";
import { calendarAttendeeStatusSymbol, formatEventDuration } from "./CalendarGuiUtils-CkzhFM1K.js";
import { makeInvitationCalendarFile } from "./CalendarExporter-BXenr-zb.js";

//#region ../src/calendar-app/calendar/view/CalendarNotificationSender.ts
var CalendarNotificationSender = class {
	/** Used for knowing how many emails are in the process of being sent. */
	countDownLatch;
	constructor() {
		this.countDownLatch = 0;
	}
	sendInvite(event, sendMailModel) {
		const message = lang.get("eventInviteMail_msg", { "{event}": event.summary });
		const sender = assertOrganizer(event).address;
		return this.sendCalendarFile({
			sendMailModel,
			method: MailMethod.ICAL_REQUEST,
			subject: message,
			body: makeInviteEmailBody(sender, event, message),
			event,
			sender
		});
	}
	sendUpdate(event, sendMailModel) {
		const message = lang.get("eventUpdated_msg", { "{event}": event.summary });
		const sender = assertOrganizer(event).address;
		return this.sendCalendarFile({
			sendMailModel,
			method: MailMethod.ICAL_REQUEST,
			subject: message,
			body: makeInviteEmailBody(sender, event, message),
			event,
			sender
		});
	}
	sendCancellation(event, sendMailModel) {
		const message = lang.get("eventCancelled_msg", { "{event}": event.summary });
		const sender = assertOrganizer(event).address;
		return this.sendCalendarFile({
			sendMailModel,
			method: MailMethod.ICAL_CANCEL,
			subject: message,
			body: makeInviteEmailBody(sender, event, message),
			event,
			sender
		}).catch(ofClass(RecipientsNotFoundError, (e) => {
			const invalidRecipients = e.message.split("\n");
			let hasRemovedRecipient = false;
			for (const invalidRecipient of invalidRecipients) {
				const recipientInfo = findRecipientWithAddress(sendMailModel.bccRecipients(), invalidRecipient);
				if (recipientInfo) hasRemovedRecipient = sendMailModel.removeRecipient(recipientInfo, RecipientField.BCC, false) || hasRemovedRecipient;
			}
			if (hasRemovedRecipient && sendMailModel.allRecipients().length) return this.sendCancellation(event, sendMailModel);
		}));
	}
	/**
	* send a response mail to the organizer of an event
	* @param event the event to respond to (included as a .ics file attachment)
	* @param sendMailModel used to actually send the mail
	*/
	async sendResponse(event, sendMailModel) {
		const sendAs = sendMailModel.getSender();
		const message = lang.get("repliedToEventInvite_msg", { "{event}": event.summary });
		const organizer = assertOrganizer(event);
		const body = makeInviteEmailBody(organizer.address, event, message);
		return this.sendCalendarFile({
			event,
			sendMailModel,
			method: MailMethod.ICAL_REPLY,
			subject: message,
			body,
			sender: sendAs
		});
	}
	async sendCalendarFile({ sendMailModel, method, subject, event, body, sender }) {
		const inviteFile = makeInvitationCalendarFile(event, mailMethodToCalendarMethod(method), new Date(), getTimeZone());
		sendMailModel.setSender(sender);
		sendMailModel.attachFiles([inviteFile]);
		sendMailModel.setSubject(subject);
		sendMailModel.setBody(body);
		this.sendStart();
		await sendMailModel.send(method).finally(() => this.sendEnd());
	}
	_windowUnsubscribe = null;
	sendStart() {
		this.countDownLatch++;
		if (this.countDownLatch === 1) this._windowUnsubscribe = windowFacade.addWindowCloseListener(noOp);
	}
	sendEnd() {
		this.countDownLatch--;
		if (this.countDownLatch === 0 && this._windowUnsubscribe) {
			this._windowUnsubscribe();
			this._windowUnsubscribe = null;
		}
	}
};
function summaryLine(event) {
	return newLine(lang.get("name_label"), event.summary);
}
function whenLine(event) {
	const duration = formatEventDuration(event, getTimeZone(), true);
	return newLine(lang.get("when_label"), duration);
}
function organizerLabel(organizer, a) {
	return cleanMailAddress(organizer.address) === cleanMailAddress(a.address.address) ? `(${lang.get("organizer_label")})` : "";
}
function newLine(label, content) {
	return `<div style="display: flex; margin-top: 8px"><div style="min-width: 120px"><b style="float:right; margin-right:16px">${label}:</b></div>${content}</div>`;
}
function attendeesLine(event) {
	const { organizer } = event;
	let attendees = "";
	if (organizer && !findAttendeeInAddresses(event.attendees, [organizer.address])) attendees = makeAttendee(organizer, createCalendarEventAttendee({
		address: organizer,
		status: "0"
	}));
	attendees += event.attendees.map((a) => makeAttendee(assertNotNull(organizer), a)).join("\n");
	return newLine(lang.get("who_label"), `<div>${attendees}</div>`);
}
function makeAttendee(organizer, attendee) {
	return `<div>
${attendee.address.name || ""} ${attendee.address.address}
${organizerLabel(organizer, attendee)}
${calendarAttendeeStatusSymbol(getAttendeeStatus(attendee))}</div>`;
}
function locationLine(event) {
	return event.location ? newLine(lang.get("location_label"), event.location) : "";
}
function descriptionLine(event) {
	return event.description ? newLine(lang.get("description_label"), `<div>${event.description}</div>`) : "";
}
function makeInviteEmailBody(sender, event, message) {
	return `
	<div style="max-width: 685px; margin: 0 auto">
	  	<h2 style="text-align: center">${message}</h2>
  		<div style="margin: 0 auto">
  			${summaryLine(event)}
    		${whenLine(event)}
    		${locationLine(event)}
    		${attendeesLine(event)}
    		${descriptionLine(event)}
  		</div>
	</div>`;
}
function assertOrganizer(event) {
	if (event.organizer == null) throw new ProgrammingError("Cannot send event update without organizer");
	return event.organizer;
}
const calendarNotificationSender = new CalendarNotificationSender();

//#endregion
export { CalendarNotificationSender, calendarNotificationSender };
//# sourceMappingURL=CalendarNotificationSender-DBd9Ir3y.js.map