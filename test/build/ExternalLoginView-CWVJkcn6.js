
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { mithril_default } from "./mithril-Csg4iNnm.js";
import { assertNotNull, base64ToUint8Array, base64UrlToBase64, noOp } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import { assertMainOrNode } from "./Env-D5xGlXfw.js";
import "./WhitelabelCustomizations-D1L5qbZi.js";
import "./LanguageViewModel-BNC5ekpO.js";
import "./HtmlUtils-C-ecR7U7.js";
import { client } from "./ClientDetector-D0v6Vqu6.js";
import { KdfType, asKdfType } from "./TutanotaConstants-3bwAESYA.js";
import "./Icon-BuqNK7vz.js";
import "./Icons-Dl3nFav5.js";
import "./KeyManager-B0OGXEyJ.js";
import "./WindowFacade-B9kSBKw7.js";
import "./Modal-g4c-b9IU.js";
import "./Dialog-B6-HFvZd.js";
import "./CountryList-DkVQtcTj.js";
import "./IconButton-DsU60HJ_.js";
import { AccessExpiredError } from "./RestError-D17JEBMr.js";
import "./SuspensionError-okvIjE4H.js";
import "./LoginIncompleteError-CpiW0a0l.js";
import "./CryptoError-PqdvQky4.js";
import "./error-DDmy0eAT.js";
import "./ErrorUtils-o1-v67Dd.js";
import "./RecipientsNotFoundError-D8oGE7A_.js";
import "./OfflineDbClosedError-CAwHTI6J.js";
import "./OutOfSyncError-Ck2yBBO8.js";
import "./DbError-CcwZaPG2.js";
import "./QuotaExceededError-nFM6SdTn.js";
import "./CancelledError-FjP5S_cR.js";
import "./FileOpenError-C1_8yoXr.js";
import "./DeviceStorageUnavailableError-m4Jk_0xN.js";
import "./MailBodyTooLargeError-C2i0rX_0.js";
import "./ImportError-CIXw37Kv.js";
import "./PermissionError-BGDsHuAh.js";
import "./KeyPermanentlyInvalidatedError-DJjt81rl.js";
import "./ParserCombinator-D38ofgFx.js";
import "./ExportError-DzgStBnl.js";
import "./stream-u2PttBAC.js";
import { GENERATED_MIN_ID } from "./EntityUtils-RQxXZlcV.js";
import "./CommonCalendarUtils-DKaO7v1K.js";
import "./Formatter-zB15D6XI.js";
import "./TypeModels-XIXYys8J.js";
import "./TypeRefs-CR3TLWn0.js";
import "./TypeModels-BktRFNDN.js";
import "./TypeRefs-BP1jvX9p.js";
import "./EntityFunctions-l6CncM5C.js";
import "./TypeModels-ZqCk-pGw.js";
import "./ModelInfo-DEa-Yxv2.js";
import "./EntityClient-B0RSdk2i.js";
import "./SetupMultipleError-B6uY8P-x.js";
import "./dist-DcZ1Y4qd.js";
import "./Services-CZFE0084.js";
import "./EntityUpdateUtils-B5iTKMk4.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import "./FormatValidator-2BBermUe.js";
import "./UserError-DfXlMLTl.js";
import "./MailAddressParser-BgYy6oyp.js";
import "./GroupUtils-0ZkLIAeC.js";
import "./DataFile-CY7uuk9j.js";
import "./FileUtils-W-u2-gZz.js";
import { showProgressDialog } from "./ProgressDialog-CJfJjh62.js";
import "./BlobUtils-D5ADcckZ.js";
import "./SharedMailUtils-AmFaSJP6.js";
import "./PasswordUtils-C4jlV9GF.js";
import "./Recipient-BFxhfecW.js";
import "./SubscriptionDialogs-DAlWs68I.js";
import "./ExternalLink-rsCBSC7U.js";
import "./ToggleButton-DxuDa0rS.js";
import "./ErrorHandler-DbW1lJbv.js";
import "./SnackBar-CoP3lSVs.js";
import { credentialsToUnencrypted } from "./Credentials-BM35X_na.js";
import "./NotificationOverlay-C-YNCUiT.js";
import "./Checkbox-WCw-l_7A.js";
import "./Expander-Bautb1_0.js";
import "./ClipboardUtils-mz40UK5S.js";
import "./ErrorReporter-7sfLhWZg.js";
import "./Services-CupYet_j.js";
import "./BubbleButton-DGGInJMg.js";
import { SessionType } from "./SessionType-rxSDsswH.js";
import "./PasswordField-CPKPoLq8.js";
import "./PasswordRequestDialog-B7ZIVTVw.js";
import "./ErrorHandlerImpl-DRpk8tE9.js";
import "./EventQueue-c-5UmjJa.js";
import "./EntityRestClient--6dT7ZRF.js";
import "./MessageDispatcher-wJwFhXWv.js";
import "./SqlValue-CkGu32Qd.js";
import "./Sql-C9YhYNym.js";
import "./CryptoWrapper-BTtEczdP.js";
import { getLoginErrorMessage, handleExpectedLoginError } from "./LoginViewModel-BX-8ry63.js";
import "./LoginButton-DzCRy0Yt.js";
import "./CredentialType-DXeA2MQH.js";
import "./MessageBox-C_T1dO_P.js";
import "./PageContextLoginListener-dgY8O-YX.js";
import { ResumeSessionErrorReason } from "./LoginFacade-zvyZiAr1.js";

//#region ../src/mail-app/mail/view/ExternalLoginView.ts
assertMainOrNode();
var ExternalLoginViewModel = class {
	password = "";
	doSavePassword = false;
	helpText = "emptyString_msg";
	errorMessageId = null;
	autologinInProgress = false;
	showAutoLoginButton = false;
	_urlData = null;
	get urlData() {
		return assertNotNull(this._urlData);
	}
	constructor(credentialsProvider) {
		this.credentialsProvider = credentialsProvider;
	}
	formLogin() {
		if (this.password === "") this.helpText = "loginFailed_msg";
else {
			this.helpText = "login_msg";
			this.handleLoginPromise(showProgressDialog("login_msg", this.doFormLogin()), noOp);
		}
	}
	async doFormLogin() {
		const password = this.password;
		const clientIdentifier = client.browser + " " + client.device;
		const persistentSession = this.doSavePassword;
		const sessionType = persistentSession ? SessionType.Persistent : SessionType.Login;
		const { userId, salt, kdfType } = this.urlData;
		const newCredentials = await locator.logins.createExternalSession(userId, password, salt, kdfType, clientIdentifier, sessionType);
		this.password = "";
		const storedCredentials = await this.credentialsProvider.getDecryptedCredentialsByUserId(userId);
		if (persistentSession) await this.credentialsProvider.store(credentialsToUnencrypted(newCredentials, null));
		if (storedCredentials) {
			await locator.logins.deleteOldSession(storedCredentials);
			if (!persistentSession) await this.credentialsProvider.deleteByUserId(userId);
		}
	}
	async autologin(credentials) {
		this.autologinInProgress = true;
		await showProgressDialog("login_msg", this.handleLoginPromise(this.resumeSession(credentials), () => {
			this.autologinInProgress = false;
			mithril_default.redraw();
		}));
	}
	async resumeSession(credentials) {
		const result = await locator.logins.resumeSession(credentials, {
			salt: this.urlData.salt,
			kdfType: this.urlData.kdfType
		}, null);
		if (result.type === "error") switch (result.reason) {
			case ResumeSessionErrorReason.OfflineNotAvailableForFree: throw new Error("Cannot happen");
		}
	}
	async loginWithStoredCredentials() {
		try {
			const credentials = await this.credentialsProvider.getDecryptedCredentialsByUserId(this.urlData.userId);
			if (credentials) await this.autologin(credentials);
		} finally {
			this.showAutoLoginButton = false;
			mithril_default.redraw();
		}
	}
	async handleLoginPromise(loginPromise, errorAction) {
		try {
			await loginPromise;
			mithril_default.route.set(`/mail${location.hash}`);
			this.helpText = "emptyString_msg";
		} catch (e) {
			const messageId = getLoginErrorMessage(e, true);
			if (e instanceof AccessExpiredError) this.errorMessageId = messageId;
else this.helpText = messageId;
			mithril_default.redraw();
			handleExpectedLoginError(e, errorAction);
		}
	}
	async updateUrl(args) {
		try {
			const encodedExternalLoginData = decodeURIComponent(location.hash).substring(6);
			const userIdOffset = 0;
			const saltOffset = userIdOffset + GENERATED_MIN_ID.length;
			const encodedSaltLength = 22;
			const kdfOffset = saltOffset + encodedSaltLength;
			let kdfType = KdfType.Bcrypt;
			if (encodedExternalLoginData.length > kdfOffset) kdfType = asKdfType(encodedExternalLoginData.substring(kdfOffset, kdfOffset + 1));
			this._urlData = {
				userId: encodedExternalLoginData.substring(userIdOffset, saltOffset),
				salt: base64ToUint8Array(base64UrlToBase64(encodedExternalLoginData.substring(saltOffset, kdfOffset))),
				kdfType
			};
			const credentials = await this.credentialsProvider.getDecryptedCredentialsByUserId(this.urlData.userId);
			if (credentials && args.noAutoLogin !== true) await this.autologin(credentials);
else {
				this.showAutoLoginButton = credentials != null;
				mithril_default.redraw();
			}
		} catch (e) {
			this.errorMessageId = "invalidLink_msg";
			mithril_default.redraw();
		}
	}
	dispose() {
		this.password = "";
	}
};

//#endregion
export { ExternalLoginViewModel };
//# sourceMappingURL=ExternalLoginView-CWVJkcn6.js.map