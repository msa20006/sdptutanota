
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { base64ToUint8Array, defer, delay, stringToBase64, uint8ArrayToBase64 } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import { CryptoError } from "./CryptoError-PqdvQky4.js";
import "./error-DDmy0eAT.js";
import { CancelledError } from "./CancelledError-FjP5S_cR.js";
import { KeyPermanentlyInvalidatedError } from "./KeyPermanentlyInvalidatedError-DJjt81rl.js";
import { KEY_LENGTH_BYTES_AES_256, generateKeyFromPassphrase } from "./dist-DcZ1Y4qd.js";
import { DesktopConfigKey } from "./ConfigKeys-B1UD5FwS.js";
import { CredentialEncryptionMode } from "./CredentialEncryptionMode-BR0DkQpJ.js";
import { dist_default } from "./dist-Ci1bEzYU.js";
import { require_testdouble } from "./testdouble-IbRSnrC0.js";
import { assertThrows } from "./dist-BY49f75m.js";
import { loadArgon2WASM } from "./WASMTestUtils-CN9pkVyq.js";

//#region ../src/common/desktop/credentials/AppPassHandler.ts
var AppPassHandler = class {
	constructor(crypto, conf, argon2idFacade, lang, getCurrentCommonNativeFacade) {
		this.crypto = crypto;
		this.conf = conf;
		this.argon2idFacade = argon2idFacade;
		this.lang = lang;
		this.getCurrentCommonNativeFacade = getCurrentCommonNativeFacade;
	}
	async addAppPassWrapper(dataWithoutAppPassWrapper, encryptionMode) {
		if (encryptionMode === CredentialEncryptionMode.APP_PASSWORD) {
			const appPassKey = await this.deriveKeyFromAppPass() ?? await this.enrollForAppPass();
			return this.crypto.aesEncryptBytes(appPassKey, dataWithoutAppPassWrapper);
		} else {
			await this.conf.setVar(DesktopConfigKey.appPassSalt, null);
			return dataWithoutAppPassWrapper;
		}
	}
	async removeAppPassWrapper(dataWithAppPassWrapper, encryptionMode) {
		if (encryptionMode !== CredentialEncryptionMode.APP_PASSWORD) return dataWithAppPassWrapper;
		const appPassKey = await this.deriveKeyFromAppPass();
		if (appPassKey == null) throw new KeyPermanentlyInvalidatedError("can't remove app pass wrapper without salt");
		try {
			return this.crypto.aesDecryptBytes(appPassKey, dataWithAppPassWrapper);
		} catch (e) {
			if (e instanceof CryptoError) {
				const nativeFacade = await this.getCurrentCommonNativeFacade();
				nativeFacade.showAlertDialog("invalidPassword_msg");
				throw new CancelledError("app Pass verification failed");
			} else throw e;
		}
	}
	/**
	* if there is a salt stored, use it and a password prompt to derive the app Pass key.
	* if there isn't, ask for a new password, generate a salt & store it, then derive the key.
	* @return the derived 256-bit key or null if none is found
	*/
	async deriveKeyFromAppPass() {
		const storedAppPassSaltB64 = await this.conf.getVar(DesktopConfigKey.appPassSalt);
		if (storedAppPassSaltB64 == null) return null;
		const commonNativeFacade = await this.getCurrentCommonNativeFacade();
		const pw = await this.tryWhileSaltNotChanged(commonNativeFacade.promptForPassword(this.lang.get("credentialsEncryptionModeAppPassword_label")));
		const salt = base64ToUint8Array(storedAppPassSaltB64);
		return generateKeyFromPassphrase(await this.argon2idFacade, pw, salt);
	}
	async enrollForAppPass() {
		const newSalt = this.crypto.randomBytes(KEY_LENGTH_BYTES_AES_256);
		const commonNativeFacade = await this.getCurrentCommonNativeFacade();
		const newPw = await this.tryWhileSaltNotChanged(commonNativeFacade.promptForNewPassword(this.lang.get("credentialsEncryptionModeAppPassword_label"), null));
		const newAppPassSaltB64 = uint8ArrayToBase64(newSalt);
		await this.conf.setVar(DesktopConfigKey.appPassSalt, newAppPassSaltB64);
		return generateKeyFromPassphrase(await this.argon2idFacade, newPw, newSalt);
	}
	async tryWhileSaltNotChanged(pwPromise) {
		const commonNativeFacade = await this.getCurrentCommonNativeFacade();
		return resolveChecked(pwPromise, new Promise((_, reject) => this.conf.once(DesktopConfigKey.appPassSalt, () => {
			reject(new CancelledError("salt changed during pw prompt"));
		})), () => commonNativeFacade.showAlertDialog("retry_action"));
	}
};
async function resolveChecked(promise, whileNotRejected, otherWiseAlso) {
	let cancelled = false;
	return await Promise.race([promise.then((value) => {
		if (cancelled) otherWiseAlso();
		return value;
	}), whileNotRejected.catch((e) => {
		cancelled = true;
		throw e;
	})]);
}

//#endregion
//#region tests/desktop/credentials/AppPassHandlerTest.ts
var import_testdouble = __toESM(require_testdouble(), 1);
dist_default.spec("AppPassHandler", () => {
	let crypto;
	let lang;
	let conf;
	let commonNativeFacade;
	let appPassHandler;
	dist_default.beforeEach(async () => {
		crypto = (0, import_testdouble.object)();
		lang = (0, import_testdouble.object)();
		conf = (0, import_testdouble.object)();
		commonNativeFacade = (0, import_testdouble.object)();
		const argon2 = loadArgon2WASM();
		appPassHandler = new AppPassHandler(crypto, conf, argon2, lang, () => Promise.resolve(commonNativeFacade));
	});
	dist_default("does not throw when using right encryption mode, app pw", async function() {
		(0, import_testdouble.when)(conf.getVar(DesktopConfigKey.appPassSalt)).thenResolve(stringToBase64("saltsalt"));
		(0, import_testdouble.when)(commonNativeFacade.promptForPassword(import_testdouble.matchers.anything())).thenResolve("password!");
		await appPassHandler.removeAppPassWrapper("base64", CredentialEncryptionMode.APP_PASSWORD);
	});
	dist_default("throws a CancelledError for all pending requests if the salt changes", async function() {
		(0, import_testdouble.when)(conf.getVar(DesktopConfigKey.appPassSalt)).thenResolve(stringToBase64("saltsalt"));
		const pwPromise = defer();
		(0, import_testdouble.when)(commonNativeFacade.promptForPassword(import_testdouble.matchers.anything())).thenReturn(pwPromise.promise);
		const cbs = [];
		conf.once = (key, cb) => {
			dist_default(key).equals(DesktopConfigKey.appPassSalt);
			cb("saltsalt2");
			return conf;
		};
		const promise1 = appPassHandler.removeAppPassWrapper(Uint8Array.from([
			1,
			2,
			3,
			4
		]), CredentialEncryptionMode.APP_PASSWORD);
		const promise2 = appPassHandler.removeAppPassWrapper(Uint8Array.from([
			1,
			2,
			3,
			4
		]), CredentialEncryptionMode.APP_PASSWORD);
		(0, import_testdouble.verify)(commonNativeFacade.showAlertDialog(import_testdouble.matchers.anything()), { times: 0 });
		await assertThrows(CancelledError, () => promise1);
		await assertThrows(CancelledError, () => promise2);
		pwPromise.resolve("make it call the alternative");
		await delay(0);
		(0, import_testdouble.verify)(commonNativeFacade.showAlertDialog(import_testdouble.matchers.anything()), { times: 2 });
	});
	dist_default("throws a KeyPermanentlyInvalidatedError if there is no salt", async function() {
		(0, import_testdouble.when)(conf.getVar(DesktopConfigKey.appPassSalt)).thenResolve(null);
		const pwPromise = defer();
		(0, import_testdouble.when)(commonNativeFacade.promptForPassword(import_testdouble.matchers.anything())).thenReturn(pwPromise.promise);
		await assertThrows(KeyPermanentlyInvalidatedError, () => appPassHandler.removeAppPassWrapper(Uint8Array.from([
			1,
			2,
			3,
			4
		]), CredentialEncryptionMode.APP_PASSWORD));
	});
});
dist_default.spec("resolveChecked", function() {
	dist_default("rejects if whileNot rejects, also calls otherwise", async function() {
		const otherWise = (0, import_testdouble.function)();
		const { promise, resolve } = defer();
		const rejector = defer();
		const subject = assertThrows(Error, () => resolveChecked(promise, rejector.promise, otherWise));
		rejector.reject(new Error("aw"));
		resolve(0);
		await subject;
		(0, import_testdouble.verify)(otherWise(), { times: 1 });
	});
	dist_default("rejects if promise rejects", async function() {
		const otherWise = (0, import_testdouble.function)();
		const { promise, reject } = defer();
		const rejector = defer();
		const subject = assertThrows(Error, () => resolveChecked(promise, rejector.promise, otherWise));
		reject(new Error("aw"));
		await subject;
		(0, import_testdouble.verify)(otherWise(), { times: 0 });
	});
	dist_default("resolves if promise resolves", async function() {
		const otherWise = (0, import_testdouble.function)();
		const { promise, resolve } = defer();
		const rejector = defer();
		const subject = resolveChecked(promise, rejector.promise, otherWise);
		resolve("hello");
		const value = await subject;
		(0, import_testdouble.verify)(otherWise(), { times: 0 });
		dist_default(value).equals("hello");
	});
});

//#endregion
//# sourceMappingURL=AppPassHandlerTest-c0bEB59T.js.map