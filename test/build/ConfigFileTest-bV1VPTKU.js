
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { delay, numberRange } from "./dist-CJHwsXKY.js";
import { dist_default } from "./dist-Ci1bEzYU.js";
import "./testdouble-IbRSnrC0.js";
import "./dist-BY49f75m.js";
import { nodemocker_default } from "./nodemocker-Bh_RUICG.js";
import path from "node:path";

//#region ../src/common/desktop/config/ConfigFile.ts
const instances = {};
function getConfigFile(p, f, fs) {
	const fullpath = path.join(p, f);
	if (!Object.keys(instances).includes(fullpath)) instances[fullpath] = new ConfigFile(p, fullpath, fs);
	return instances[fullpath];
}
var ConfigFile = class {
	accessPromise;
	/**
	* @param filePath path to the file the json objects should be stored in
	**/
	constructor(filePath, fullpath, fs) {
		this.filePath = filePath;
		this.fullpath = fullpath;
		this.fs = fs;
		this.accessPromise = Promise.resolve();
	}
	ensurePresence(defaultObj) {
		try {
			this.fs.accessSync(this.fullpath, this.fs.constants.F_OK);
		} catch (e) {
			return this.writeJSON(defaultObj || {});
		}
		return Promise.resolve();
	}
	readJSON() {
		this.accessPromise = this.accessPromise.then(() => this.fs.promises.readFile(this.fullpath, "utf8")).then((t) => JSON.parse(t)).catch((e) => {
			console.error("failed to read config!", e);
		});
		return this.accessPromise;
	}
	/**
	* asynchronously write an object to a file.
	* multiple writes are handled in a fifo manner to prevent race conditions that could
	* cause the file to contain invalid json
	* deliberately not using async to make sure the chain of writes doesn't branch.
	*
	* @param obj the object to serialize
	* @returns {Promise<void>} resolves when the object has been written
	*/
	writeJSON(obj) {
		this.accessPromise = this.accessPromise.then(() => this.fs.promises.mkdir(this.filePath, { recursive: true })).then(() => JSON.stringify(obj, null, 2)).then((json) => this.fs.promises.writeFile(this.fullpath, json)).catch((e) => {
			console.error("failed to write conf:", e);
		});
		return this.accessPromise;
	}
};

//#endregion
//#region tests/desktop/config/ConfigFileTest.ts
const MAX_LATENCY = 20;
const rndDelay = () => delay(Math.floor(Math.random() * MAX_LATENCY));
const fsMock = {
	accessSync: function(p) {
		if (Object.keys(this.promises.fs).includes(p)) return;
		throw new Error("404");
	},
	constants: {},
	promises: {
		fs: { "path/present.json": JSON.stringify({
			a: "hello",
			b: ""
		}) },
		writeFile: function(p, v) {
			return rndDelay().then(() => this.fs[p] = v);
		},
		readFile: function(p) {
			return rndDelay().then(() => this.fs[p]);
		},
		mkdir: function(p, o) {
			Promise.resolve();
		}
	}
};
dist_default.spec("ConfigFileTest", function() {
	dist_default("ensurePresence works", async function() {
		const newV = {
			a: "bye",
			b: "hello"
		};
		const cf = getConfigFile("path", "present.json", nodemocker_default.mock("fs", fsMock).set());
		await cf.ensurePresence(newV);
		const v = await cf.readJSON();
		dist_default(v).notDeepEquals(newV);
	});
	dist_default("ensurePresence works 2", async function() {
		const cf = getConfigFile("path", "not-present.json", nodemocker_default.mock("fs", fsMock).set());
		const newV = {
			a: "bye",
			b: "hello"
		};
		await cf.ensurePresence(newV);
		const v = await cf.readJSON();
		dist_default(v).deepEquals(newV);
	});
	dist_default("interleaved reads/writes work", async function() {
		dist_default.timeout(500);
		const cf = getConfigFile("path", "conf.json", nodemocker_default.mock("fs", fsMock).set());
		const cycles = 19;
		const res = [];
		for (let i = 0; i < cycles + 1;) {
			await Promise.resolve();
			cf.writeJSON({ a: i++ });
			await Promise.resolve();
			cf.readJSON().then((v) => {
				i = v.a;
				res.push(i);
			});
		}
		await cf.readJSON();
		dist_default(res).deepEquals(numberRange(0, cycles));
	});
	dist_default("instance pool works", async function() {
		const fs = nodemocker_default.mock("fs", fsMock).set();
		const first = getConfigFile("path", "somepath.json", fs);
		await first.ensurePresence({ mork: 123 });
		const second = getConfigFile("path", "somepath.json", fs);
		await second.ensurePresence({ mork: 321 });
		const unchanged_content = await first.readJSON();
		dist_default(unchanged_content).deepEquals({ mork: 123 });
		second.writeJSON({ a: false });
		const changed_content = await first.readJSON();
		dist_default(changed_content).deepEquals({ a: false });
		first.t = true;
		dist_default(second.t).equals(true);
	});
});

//#endregion
export { fsMock };
//# sourceMappingURL=ConfigFileTest-bV1VPTKU.js.map