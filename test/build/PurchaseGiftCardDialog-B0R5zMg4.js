
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { mithril_default } from "./mithril-Csg4iNnm.js";
import { assertNotNull, count, filterInt, noOp, ofClass } from "./dist-CJHwsXKY.js";
import { isAndroidApp, isApp, isIOSApp } from "./Env-D5xGlXfw.js";
import { InfoLink, lang } from "./LanguageViewModel-BNC5ekpO.js";
import { DefaultAnimationTime, px, size, theme } from "./HtmlUtils-C-ecR7U7.js";
import { client } from "./ClientDetector-D0v6Vqu6.js";
import { Const, Keys, PaymentMethodType, PlanType } from "./TutanotaConstants-3bwAESYA.js";
import { BootIcons, ButtonType, Icon, IconSize } from "./Icon-BuqNK7vz.js";
import { Icons } from "./Icons-Dl3nFav5.js";
import { Dialog } from "./Dialog-B6-HFvZd.js";
import { IconButton } from "./IconButton-DsU60HJ_.js";
import { BadGatewayError, PreconditionFailedError } from "./RestError-D17JEBMr.js";
import { urlEncodeHtmlTags } from "./Formatter-zB15D6XI.js";
import { GiftCardTypeRef } from "./TypeRefs-BP1jvX9p.js";
import { GiftCardService } from "./Services-CZFE0084.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import { UserError } from "./UserError-DfXlMLTl.js";
import { showProgressDialog } from "./ProgressDialog-CJfJjh62.js";
import { Checkbox } from "./Checkbox-WCw-l_7A.js";
import { copyToClipboard } from "./ClipboardUtils-mz40UK5S.js";
import { showUserError } from "./ErrorHandlerImpl-DRpk8tE9.js";
import { htmlSanitizer } from "./HtmlSanitizer-CA1YjlPp.js";
import { LoginButton } from "./LoginButton-DzCRy0Yt.js";
import { SegmentControl } from "./SegmentControl-DpoAc28w.js";
import { getPreconditionFailedPaymentMsg } from "./SubscriptionUtils-D0qLWHbE.js";
import { InfoIcon } from "./InfoIcon-BCwidYvN.js";
import { PaymentInterval, PriceAndConfigProvider, UpgradePriceType, formatPrice, isReferenceDateWithinCyberMondayCampaign } from "./PriceUtils-DA-dFW8L.js";
import { require_qrcode } from "./qrcode-C0eFPi61.js";

//#region ../src/common/subscription/BuyOptionBox.ts
function getActiveSubscriptionActionButtonReplacement() {
	return () => mithril_default(".buyOptionBox.content-accent-fg.center-vertically.text-center", { style: { "border-radius": px(size.border_radius_small) } }, lang.get("pricing.currentPlan_label"));
}
const BOX_MARGIN = 10;
var BuyOptionDetails = class {
	featuresExpanded = false;
	featureListItemSelector = ".flex";
	onbeforeupdate(vnode, old) {
		if (vnode.attrs.featuresExpanded && !old.attrs.featuresExpanded) this.featureListItemSelector = ".flex.expand";
else this.featureListItemSelector = ".flex";
	}
	view(vnode) {
		const { attrs } = vnode;
		this.featuresExpanded = attrs.featuresExpanded || false;
		return mithril_default(".mt.pl", attrs.categories.map((fc) => {
			return [
				this.renderCategoryTitle(fc, attrs.renderCategoryTitle),
				fc.features.filter((f) => !f.omit || this.featuresExpanded).map((f) => mithril_default(this.featureListItemSelector, { key: f.key }, [
					f.heart ? mithril_default(Icon, {
						icon: BootIcons.Heart,
						style: attrs.iconStyle
					}) : mithril_default(Icon, {
						icon: f.antiFeature ? Icons.Cancel : Icons.Checkmark,
						style: attrs.iconStyle
					}),
					mithril_default(".small.text-left.align-self-center.pl-s.button-height.flex-grow.min-width-0.break-word", [mithril_default("span", f.text)]),
					f.toolTip ? mithril_default(InfoIcon, { text: f.toolTip }) : null
				])),
				this.renderPlaceholders(fc)
			];
		}));
	}
	renderCategoryTitle(fc, renderCategoryTitle) {
		if (fc.title && this.featuresExpanded) return [mithril_default(".b.text-left.align-self-center.pl-s.button-height.flex-grow.min-width-0.break-word", ""), mithril_default(".b.text-left.align-self-center.pl-s.button-height.flex-grow.min-width-0.break-word", renderCategoryTitle ? fc.title : "")];
else return [];
	}
	renderPlaceholders(fc) {
		if (!this.featuresExpanded) return [];
else {
			const placeholderCount = fc.featureCount.max - fc.features.length;
			return [...Array(placeholderCount)].map(() => mithril_default(".button-height", ""));
		}
	}
};
var BuyOptionBox = class {
	view(vnode) {
		const { attrs } = vnode;
		const isCyberMonday = isReferenceDateWithinCyberMondayCampaign(Const.CURRENT_DATE ?? new Date());
		const isLegendPlan = attrs.targetSubscription === PlanType.Legend;
		const isYearly = (attrs.selectedPaymentInterval == null ? attrs.accountPaymentInterval : attrs.selectedPaymentInterval()) === PaymentInterval.Yearly;
		const shouldApplyCyberMondayDesign = isLegendPlan && isCyberMonday && isYearly;
		return mithril_default(".fg-black", { style: {
			width: px(attrs.width),
			padding: "10px",
			height: "100%"
		} }, [mithril_default(".buyOptionBox" + (attrs.highlighted ? shouldApplyCyberMondayDesign ? ".highlighted.cyberMonday" : ".highlighted" : ""), { style: {
			display: "flex",
			"flex-direction": "column",
			"min-height": px(attrs.height),
			"border-radius": "3px",
			height: "100%"
		} }, [
			shouldApplyCyberMondayDesign ? this.renderCyberMondayRibbon() : this.renderBonusMonthsRibbon(attrs.bonusMonths),
			typeof attrs.heading === "string" ? this.renderHeading(attrs.heading) : attrs.heading,
			this.renderPrice(attrs.price, isYearly ? attrs.referencePrice : undefined),
			mithril_default(".small.text-center", attrs.priceHint ? lang.getTranslationText(attrs.priceHint) : lang.get("emptyString_msg")),
			mithril_default(".small.text-center.pb-ml", lang.getTranslationText(attrs.helpLabel)),
			this.renderPaymentIntervalControl(attrs.selectedPaymentInterval, shouldApplyCyberMondayDesign),
			attrs.actionButton ? mithril_default(".button-min-height", { style: { "margin-top": "auto" } }, attrs.actionButton()) : null
		])]);
	}
	renderPrice(price, strikethroughPrice) {
		return mithril_default(".pt-ml.text-center", { style: {
			display: "grid",
			"grid-template-columns": "1fr auto 1fr",
			"align-items": "center"
		} }, strikethroughPrice != null && strikethroughPrice.trim() !== "" ? mithril_default(".span.strike", { style: {
			color: theme.content_button,
			fontSize: px(size.font_size_base),
			justifySelf: "end",
			margin: "auto 0.4em 0 0",
			padding: "0.4em 0"
		} }, strikethroughPrice) : mithril_default(""), mithril_default(".h1", price), mithril_default(""));
	}
	renderBonusMonthsRibbon(bonusMonths) {
		return bonusMonths > 0 ? this.renderRibbon(`+${bonusMonths} ${lang.get("pricing.months_label")}`) : null;
	}
	renderRibbon(text) {
		return mithril_default(".ribbon-horizontal", mithril_default(".text-center.b", { style: { padding: px(3) } }, text));
	}
	renderCyberMondayRibbon() {
		const text = isIOSApp() ? "DEAL" : lang.get("pricing.cyberMonday_label");
		return mithril_default(".ribbon-horizontal.ribbon-horizontal-cyber-monday", mithril_default(".text-center.b", { style: { padding: px(3) } }, text));
	}
	renderPaymentIntervalControl(paymentInterval, shouldApplyCyberMonday) {
		const paymentIntervalItems = [{
			name: lang.get("pricing.yearly_label"),
			value: PaymentInterval.Yearly
		}, {
			name: lang.get("pricing.monthly_label"),
			value: PaymentInterval.Monthly
		}];
		return paymentInterval ? mithril_default(SegmentControl, {
			selectedValue: paymentInterval(),
			items: paymentIntervalItems,
			onValueSelected: (v) => {
				paymentInterval?.(v);
				mithril_default.redraw();
			},
			shouldApplyCyberMonday
		}) : null;
	}
	renderHeading(heading) {
		return mithril_default(
			// we need some margin for the discount banner for longer translations shown on the website
			`.h4.text-center.mb-small-line-height.flex.col.center-horizontally.mlr-l.dialog-header`,
			{ style: { "font-size": heading.length > 20 ? "smaller" : undefined } },
			heading
);
	}
};

//#endregion
//#region ../src/common/misc/Website.ts
async function requestFromWebsite(path, domainConfig) {
	const url = new URL(path, domainConfig.websiteBaseUrl);
	return fetch(url.href);
}

//#endregion
//#region ../src/common/subscription/TermsAndConditions.ts
const CURRENT_TERMS_VERSION = "3.2";
const CURRENT_PRIVACY_VERSION = "3.1";
const CURRENT_GIFT_CARD_TERMS_VERSION = "1.0";
function renderTermsAndConditionsButton(terms, version) {
	let label;
	let link;
	switch (terms) {
		case TermsSection.GiftCards:
			label = lang.get("giftCardTerms_label");
			link = InfoLink.GiftCardsTerms;
			break;
		case TermsSection.Terms:
			label = lang.get("termsAndConditionsLink_label");
			link = InfoLink.Terms;
			break;
		case TermsSection.Privacy:
			label = lang.get("privacyLink_label");
			link = InfoLink.Privacy;
			break;
	}
	return mithril_default(`a[href=${link}][target=_blank]`, { onclick: (e) => {
		if (isApp()) {
			showServiceTerms(terms, version);
			e.preventDefault();
		}
	} }, label);
}
let TermsSection = function(TermsSection$1) {
	TermsSection$1["Terms"] = "terms-entries";
	TermsSection$1["Privacy"] = "privacy-policy-entries";
	TermsSection$1["GiftCards"] = "giftCardsTerms-entries";
	return TermsSection$1;
}({});
async function showServiceTerms(section, version) {
	const path = `/${section}/${version}.json`;
	const termsFromWebsite = await requestFromWebsite(path, locator.domainConfigProvider().getCurrentDomainConfig()).then((res) => res.json());
	let visibleLang = lang.code.startsWith("de") ? "de" : "en";
	let dialog;
	let sanitizedTerms;
	function getSection() {
		return htmlSanitizer.sanitizeHTML(termsFromWebsite[visibleLang], { blockExternalContent: false }).html;
	}
	let headerBarAttrs = {
		left: [{
			label: lang.makeTranslation("lang_toggle", "EN/DE"),
			click: () => {
				visibleLang = visibleLang === "de" ? "en" : "de";
				sanitizedTerms = getSection();
				mithril_default.redraw();
			},
			type: ButtonType.Secondary
		}],
		right: [{
			label: "ok_action",
			click: () => dialog.close(),
			type: ButtonType.Primary
		}]
	};
	sanitizedTerms = getSection();
	dialog = Dialog.largeDialog(headerBarAttrs, { view: () => mithril_default(".text-break", mithril_default.trust(sanitizedTerms)) }).show();
}

//#endregion
//#region ../src/common/subscription/giftcards/GiftCardUtils.ts
var import_qrcode = __toESM(require_qrcode(), 1);
let GiftCardStatus = function(GiftCardStatus$1) {
	GiftCardStatus$1["Deactivated"] = "0";
	GiftCardStatus$1["Usable"] = "1";
	GiftCardStatus$1["Redeemed"] = "2";
	GiftCardStatus$1["Refunded"] = "3";
	GiftCardStatus$1["Disputed"] = "4";
	return GiftCardStatus$1;
}({});
async function getTokenFromUrl(url) {
	const token = url.substring(url.indexOf("#") + 1);
	try {
		if (!token) throw new Error();
		return await locator.giftCardFacade.decodeGiftCardToken(token);
	} catch (e) {
		throw new UserError("invalidGiftCard_msg");
	}
}
async function generateGiftCardLink(giftCard) {
	const token = await locator.giftCardFacade.encodeGiftCardToken(giftCard);
	const giftCardBaseUrl = locator.domainConfigProvider().getCurrentDomainConfig().giftCardBaseUrl;
	const giftCardUrl = new URL(giftCardBaseUrl);
	giftCardUrl.hash = token;
	return giftCardUrl.href;
}
function showGiftCardToShare(giftCard) {
	generateGiftCardLink(giftCard).then((link) => {
		let infoMessage = "emptyString_msg";
		const dialog = Dialog.largeDialog({
			right: [{
				type: ButtonType.Secondary,
				label: "close_alt",
				click: () => dialog.close()
			}],
			middle: "giftCard_label"
		}, { view: () => [
			mithril_default(".flex-center.full-width.pt.pb", mithril_default(".pt-l", { style: { width: "480px" } }, renderGiftCardSvg(parseFloat(giftCard.value), link, giftCard.message))),
			mithril_default(".flex-center", [
				mithril_default(IconButton, {
					click: () => {
						dialog.close();
						setTimeout(() => import("./MailEditor-BuqlXNUT.js").then((editor) => editor.writeGiftCardMail(link)), DefaultAnimationTime);
					},
					title: "shareViaEmail_action",
					icon: BootIcons.Mail
				}),
				isAndroidApp() ? mithril_default(IconButton, {
					click: () => {
						locator.systemFacade.shareText(lang.get("nativeShareGiftCard_msg", { "{link}": link }), lang.get("nativeShareGiftCard_label"));
					},
					title: "share_action",
					icon: BootIcons.Share
				}) : mithril_default(IconButton, {
					click: () => {
						copyToClipboard(link).then(() => {
							infoMessage = "giftCardCopied_msg";
						}).catch(() => {
							infoMessage = "copyLinkError_msg";
						});
					},
					title: "copyToClipboard_action",
					icon: Icons.Clipboard
				}),
				!isApp() ? mithril_default(IconButton, {
					click: () => {
						infoMessage = "emptyString_msg";
						window.print();
					},
					title: "print_action",
					icon: Icons.Print
				}) : null
			]),
			mithril_default(".flex-center", mithril_default("small.noprint", lang.getTranslationText(infoMessage)))
		] }).addShortcut({
			key: Keys.ESC,
			exec: () => dialog.close(),
			help: "close_alt"
		}).show();
	});
}
const giftCardSVGGetter = new class GiftCardSVGGetter {
	static giftCardSvg = null;
	static giftCardNoQrSvg = null;
	getWithQr() {
		if (GiftCardSVGGetter.giftCardSvg == null) {
			GiftCardSVGGetter.downloadSVG("gift-card", (rawSVG) => {
				GiftCardSVGGetter.giftCardSvg = rawSVG;
				mithril_default.redraw();
			});
			return GiftCardSVGGetter.getPlaceHolder("<rect id='qr-code' width='80' height='80' x='0' y='70'></rect>");
		}
		return GiftCardSVGGetter.giftCardSvg;
	}
	getNoQr() {
		if (GiftCardSVGGetter.giftCardNoQrSvg == null) {
			GiftCardSVGGetter.downloadSVG("gift-card-no-qr", (rawSVG) => {
				GiftCardSVGGetter.giftCardNoQrSvg = rawSVG;
				mithril_default.redraw();
			});
			return GiftCardSVGGetter.getPlaceHolder();
		}
		return GiftCardSVGGetter.giftCardNoQrSvg;
	}
	static downloadSVG(fileName, onComplete) {
		fetch(`${window.tutao.appState.prefixWithoutFile}/images/${fileName}.svg`).then(async (res) => {
			onComplete(await res.text());
		}, () => {});
	}
	static getPlaceHolder(extraElements = "") {
		return `
			<svg width='480' height='600'>
				<text id='card-label' x='0' y='20'></text>
				<text id='message' x='0' y='40' fill='#fff'></text>
				<text id='price' x='0' y='60'></text>
				${extraElements}
			</svg>`;
	}
}();
function renderGiftCardSvg(price, link, message) {
	const svg = link == null ? giftCardSVGGetter.getNoQr() : giftCardSVGGetter.getWithQr();
	const svgDocument = new DOMParser().parseFromString(svg, "image/svg+xml");
	if (link != null) {
		const qrCodeElement = getGiftCardElement(svgDocument, "qr-code");
		const qrCodeWidth = getNumberAttribute(qrCodeElement, "width");
		const qrCodeHeight = getNumberAttribute(qrCodeElement, "height");
		const qrCodeXPosition = getNumberAttribute(qrCodeElement, "x");
		const qrCodeYPosition = getNumberAttribute(qrCodeElement, "y");
		qrCodeElement.outerHTML = renderQRCode(qrCodeXPosition, qrCodeYPosition, qrCodeWidth, qrCodeHeight, link);
	}
	const labelElement = getGiftCardElement(svgDocument, "card-label");
	labelElement.textContent = lang.get("giftCard_label").toUpperCase();
	const priceElement = getGiftCardElement(svgDocument, "price");
	priceElement.textContent = formatPrice(price, false).replace(/\s+/g, "") + "€";
	const messageElement = getGiftCardElement(svgDocument, "message");
	const messageColor = getAttribute(messageElement, "fill");
	messageElement.outerHTML = renderMessage(19, 61, 108, 70, messageColor, message);
	return mithril_default.trust(svgDocument.documentElement.outerHTML);
}
function getNumberAttribute(element, attributeName) {
	const raw = element.getAttribute(attributeName);
	if (raw == null) throw new Error(`Error while rendering gift card: missing attribute ${attributeName} from ${element.id}`);
	return Number(raw);
}
function getAttribute(element, attributeName) {
	const raw = element.getAttribute(attributeName);
	if (raw == null) throw new Error(`Error while rendering gift card: missing attribute ${attributeName} from ${element.id}`);
	return raw;
}
function getGiftCardElement(svgDocument, id) {
	const element = svgDocument.getElementById(id);
	if (element == null) throw new Error(`Error while rendering gift card: missing element ${id}`);
	return element;
}
/**
* Renders a text with word wrapping in an SVG element. (0,0) is the top left.
* @param x The position of the element on the X Axis.
* @param y The position of the element on the Y Axis.
* @param width The width of the text element.
* @param height The height of the text element.
* @param color The fill colour of the text element.
* @param message The text to be displayed in the element.
*/
function renderMessage(x, y, width, height, color, message) {
	const cleanMessage = htmlSanitizer.sanitizeHTML(urlEncodeHtmlTags(message)).html;
	const lineBreaks = cleanMessage.split(/\r\n|\r|\n/).length;
	const charLength = cleanMessage.length;
	const fontSizePx = lineBreaks > 4 || charLength > 80 ? "6px" : "7px";
	return `
		<foreignObject x="${x}" y="${y}" width="${width}" height="${height}" fill="${color}">
			<p xmlns="http://www.w3.org/1999/xhtml"
			   class="text-preline text-break color-adjust-exact monospace"
			   style="font-size: ${fontSizePx}; color: ${color}; margin: auto 0 0 0">
				${cleanMessage}
			</p>
		</foreignObject>`;
}
/**
* Generates a black-on-white QR Code in SVG form
* @param x The position on the X Axis of the QR Code. 0 is the far left.
* @param y The position on the Y Axis of the QR Code. 0 is the top.
* @param link The link that the generated QR code will lead to when scanned
* @param height The height in pixels of the resulting QR code
* @param width The width in pixels of the resulting QR code
* @return the SVG element of the generated QR code as a `string`
*/
function renderQRCode(x, y, width, height, link) {
	const svg = new import_qrcode.default({
		height,
		width,
		content: link,
		background: "#ffffff",
		color: "#000000",
		xmlDeclaration: false,
		container: "none",
		padding: 0,
		join: true,
		pretty: false
	}).svg();
	const qrCode = htmlSanitizer.sanitizeSVG(svg).html;
	return `<svg x="${x}" y="${y}" width="${width}" height="${height}">${qrCode}</svg>`;
}
function renderAcceptGiftCardTermsCheckbox(checked, onChecked, classes) {
	return mithril_default(Checkbox, {
		checked,
		onChecked,
		class: classes,
		label: () => [lang.get("termsAndConditions_label"), mithril_default("div", renderTermsAndConditionsButton(TermsSection.GiftCards, CURRENT_GIFT_CARD_TERMS_VERSION))]
	});
}

//#endregion
//#region ../src/common/subscription/giftcards/GiftCardMessageEditorField.ts
const GIFT_CARD_MESSAGE_COLS = 26;
const GIFT_CARD_MESSAGE_HEIGHT = 5;
var GiftCardMessageEditorField = class {
	textAreaDom = null;
	isActive = false;
	view(vnode) {
		const a = vnode.attrs;
		return mithril_default("label.small.mt-form.i.flex-center.flex-column", [lang.get("yourMessage_label"), mithril_default("textarea.monospace.normal-font-size.overflow-hidden.resize-none" + (this.isActive ? ".editor-border-active" : ".editor-border"), {
			wrap: "hard",
			cols: a.cols || GIFT_CARD_MESSAGE_COLS,
			rows: a.rows || GIFT_CARD_MESSAGE_HEIGHT,
			oncreate: (vnode$1) => {
				this.textAreaDom = vnode$1.dom;
				this.textAreaDom.value = a.message;
			},
			onfocus: () => {
				this.isActive = true;
			},
			onblur: () => {
				this.isActive = false;
			},
			oninput: () => {
				const textAreaDom = assertNotNull(this.textAreaDom);
				const origStart = textAreaDom.selectionStart;
				const origEnd = textAreaDom.selectionEnd;
				while (textAreaDom.clientHeight < textAreaDom.scrollHeight) textAreaDom.value = textAreaDom.value.substring(0, textAreaDom.value.length - 1);
				a.onMessageChanged(textAreaDom.value);
				if (textAreaDom.selectionStart - origStart > 1) {
					textAreaDom.selectionStart = origStart;
					textAreaDom.selectionEnd = origEnd;
				}
			}
		})]);
	}
};

//#endregion
//#region ../src/common/subscription/giftcards/PurchaseGiftCardDialog.ts
var PurchaseGiftCardModel = class {
	message = lang.get("defaultGiftCardMessage_msg");
	confirmed = false;
	constructor(config) {
		this.config = config;
	}
	get availablePackages() {
		return this.config.availablePackages;
	}
	get purchaseLimit() {
		return this.config.purchaseLimit;
	}
	get purchasePeriodMonths() {
		return this.config.purchasePeriodMonths;
	}
	get selectedPackage() {
		return this.config.selectedPackage;
	}
	set selectedPackage(selection) {
		this.config.selectedPackage = selection;
	}
	get revolutionaryPrice() {
		return this.config.revolutionaryPrice;
	}
	async purchaseGiftCard() {
		if (!this.confirmed) throw new UserError("termsAcceptedNeutral_msg");
		return locator.giftCardFacade.generateGiftCard(this.message, this.availablePackages[this.selectedPackage].value).then((createdGiftCardId) => locator.entityClient.load(GiftCardTypeRef, createdGiftCardId)).catch((e) => this.handlePurchaseError(e));
	}
	handlePurchaseError(e) {
		if (e instanceof PreconditionFailedError) {
			const message = e.data;
			switch (message) {
				case "giftcard.limitreached": throw new UserError(lang.getTranslation("tooManyGiftCards_msg", {
					"{amount}": `${this.purchaseLimit}`,
					"{period}": `${this.purchasePeriodMonths} months`
				}));
				case "giftcard.noaccountinginfo": throw new UserError("providePaymentDetails_msg");
				case "giftcard.invalidpaymentmethod": throw new UserError("invalidGiftCardPaymentMethod_msg");
				default: throw new UserError(getPreconditionFailedPaymentMsg(e.data));
			}
		} else if (e instanceof BadGatewayError) throw new UserError("paymentProviderNotAvailableError_msg");
else throw e;
	}
};
var GiftCardPurchaseView = class {
	view(vnode) {
		const { model, onGiftCardPurchased } = vnode.attrs;
		return [mithril_default(".flex.center-horizontally.wrap.pt-ml", { style: { "column-gap": px(BOX_MARGIN) } }, model.availablePackages.map((option, index) => {
			const value = parseFloat(option.value);
			return mithril_default(BuyOptionBox, {
				heading: mithril_default(".flex-center", Array(Math.pow(2, index)).fill(mithril_default(Icon, {
					icon: Icons.Gift,
					size: IconSize.Medium
				}))),
				actionButton: () => mithril_default(LoginButton, {
					label: "pricing.select_action",
					onclick: () => {
						model.selectedPackage = index;
					}
				}),
				price: formatPrice(value, true),
				helpLabel: this.getGiftCardHelpText(model.revolutionaryPrice, value),
				width: 230,
				height: 250,
				selectedPaymentInterval: null,
				accountPaymentInterval: null,
				highlighted: model.selectedPackage === index,
				mobile: false,
				bonusMonths: 0
			});
		})), mithril_default(".flex-column.flex-center.center-h.width-min-content", [
			mithril_default(GiftCardMessageEditorField, {
				message: model.message,
				onMessageChanged: (message) => model.message = message
			}),
			renderAcceptGiftCardTermsCheckbox(model.confirmed, (checked) => model.confirmed = checked, "pt-l"),
			mithril_default(LoginButton, {
				label: "buy_action",
				class: "mt-l mb-l",
				onclick: () => this.onBuyButtonPressed(model, onGiftCardPurchased).catch(ofClass(UserError, showUserError))
			})
		])];
	}
	async onBuyButtonPressed(model, onPurchaseSuccess) {
		const giftCard = await showProgressDialog("loading_msg", model.purchaseGiftCard());
		onPurchaseSuccess(giftCard);
	}
	getGiftCardHelpText(upgradePrice, giftCardValue) {
		let helpTextId;
		if (giftCardValue < upgradePrice) helpTextId = "giftCardOptionTextC_msg";
else if (giftCardValue == upgradePrice) helpTextId = "giftCardOptionTextD_msg";
else helpTextId = "giftCardOptionTextE_msg";
		return lang.getTranslation(helpTextId, {
			"{remainingCredit}": formatPrice(giftCardValue - upgradePrice, true),
			"{fullCredit}": formatPrice(giftCardValue, true)
		});
	}
};
async function showPurchaseGiftCardDialog() {
	if (isIOSApp()) return Dialog.message("notAvailableInApp_msg");
	const model = await showProgressDialog("loading_msg", loadGiftCardModel()).catch(ofClass(UserError, (e) => {
		showUserError(e);
		return null;
	}));
	if (model == null) return;
	let dialog;
	const header = {
		left: [{
			label: "close_alt",
			type: ButtonType.Secondary,
			click: () => dialog.close()
		}],
		middle: "buyGiftCard_label"
	};
	const content = { view: () => mithril_default(GiftCardPurchaseView, {
		model,
		onGiftCardPurchased: (giftCard) => {
			dialog.close();
			showGiftCardToShare(giftCard);
		}
	}) };
	dialog = Dialog.largeDialog(header, content).addShortcut({
		key: Keys.ESC,
		exec: () => dialog.close(),
		help: "close_alt"
	});
	if (client.isMobileDevice()) dialog.setFocusOnLoadFunction(noOp);
	dialog.show();
}
async function loadGiftCardModel() {
	const accountingInfo = await locator.logins.getUserController().loadAccountingInfo();
	if (!accountingInfo || accountingInfo.paymentMethod === PaymentMethodType.Invoice || accountingInfo.paymentMethod === PaymentMethodType.AccountBalance) throw new UserError("invalidGiftCardPaymentMethod_msg");
	const [giftCardInfo, customerInfo] = await Promise.all([locator.serviceExecutor.get(GiftCardService, null), locator.logins.getUserController().loadCustomerInfo()]);
	const existingGiftCards = customerInfo.giftCards ? await locator.entityClient.loadAll(GiftCardTypeRef, customerInfo.giftCards.items) : [];
	const sixMonthsAgo = new Date();
	sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - parseInt(giftCardInfo.period));
	const numPurchasedGiftCards = count(existingGiftCards, (giftCard) => giftCard.orderDate > sixMonthsAgo);
	if (numPurchasedGiftCards >= parseInt(giftCardInfo.maxPerPeriod)) throw new UserError(lang.getTranslation("tooManyGiftCards_msg", {
		"{amount}": giftCardInfo.maxPerPeriod,
		"{period}": `${giftCardInfo.period} months`
	}));
	const priceDataProvider = await PriceAndConfigProvider.getInitializedInstance(null, locator.serviceExecutor, null);
	return new PurchaseGiftCardModel({
		purchaseLimit: filterInt(giftCardInfo.maxPerPeriod),
		purchasePeriodMonths: filterInt(giftCardInfo.period),
		availablePackages: giftCardInfo.options,
		selectedPackage: Math.floor(giftCardInfo.options.length / 2),
		revolutionaryPrice: priceDataProvider.getSubscriptionPrice(PaymentInterval.Yearly, PlanType.Revolutionary, UpgradePriceType.PlanActualPrice)
	});
}

//#endregion
export { BOX_MARGIN, BuyOptionBox, BuyOptionDetails, CURRENT_PRIVACY_VERSION, CURRENT_TERMS_VERSION, TermsSection, getActiveSubscriptionActionButtonReplacement, getTokenFromUrl, renderAcceptGiftCardTermsCheckbox, renderGiftCardSvg, renderTermsAndConditionsButton, showPurchaseGiftCardDialog };
//# sourceMappingURL=PurchaseGiftCardDialog-B0R5zMg4.js.map