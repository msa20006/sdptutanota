{"version":3,"file":"PurchaseGiftCardDialog-B0R5zMg4.js","names":["vnode: Vnode<BuyOptionDetailsAttr>","old: VnodeDOM<BuyOptionDetailsAttr>","fc: BuyOptionDetailsAttr[\"categories\"][0]","renderCategoryTitle: boolean","vnode: Vnode<BuyOptionBoxAttr>","price: string","strikethroughPrice?: string","bonusMonths: number","text: string","paymentInterval: Stream<PaymentInterval> | null","shouldApplyCyberMonday: boolean","v: PaymentInterval","heading: string","path: string","domainConfig: DomainConfig","terms: TermsSection","version: string","e: MouseEvent","section: TermsSection","visibleLang: \"en\" | \"de\"","dialog: Dialog","sanitizedTerms: string","headerBarAttrs: DialogHeaderBarAttrs","url: string","giftCard: GiftCard","infoMessage: MaybeTranslation","dialog: Dialog","fileName: string","onComplete: (rawSVG: string) => void","extraElements: string","price: number","link: string | null","message: string","svgDocument: Document","element: Element","attributeName: string","id: \"price\" | \"qr-code\" | \"message\" | \"card-label\"","x: number","y: number","width: number","height: number","color: string","cleanMessage: string","link: string","QRCode","checked: boolean","onChecked: (checked: boolean) => void","classes?: string","vnode: Vnode<GiftCardMessageEditorFieldAttrs>","vnode","config: {\n\t\t\tpurchaseLimit: number\n\t\t\tpurchasePeriodMonths: number\n\t\t\tavailablePackages: Array<GiftCardOption>\n\t\t\tselectedPackage: number\n\t\t\trevolutionaryPrice: number\n\t\t}","selection: number","e: Error","vnode: Vnode<GiftCardPurchaseViewAttrs>","model: PurchaseGiftCardModel","onPurchaseSuccess: (giftCard: GiftCard) => void","upgradePrice: number","giftCardValue: number","helpTextId: TranslationKeyType","dialog: Dialog","header: DialogHeaderBarAttrs"],"sources":["../../src/common/subscription/BuyOptionBox.ts","../../src/common/misc/Website.ts","../../src/common/subscription/TermsAndConditions.ts","../../src/common/subscription/giftcards/GiftCardUtils.ts","../../src/common/subscription/giftcards/GiftCardMessageEditorField.ts","../../src/common/subscription/giftcards/PurchaseGiftCardDialog.ts"],"sourcesContent":["import m, { Child, Children, Component, Vnode, VnodeDOM } from \"mithril\"\nimport { px, size } from \"../gui/size\"\nimport type { TranslationKey, MaybeTranslation } from \"../misc/LanguageViewModel\"\nimport { lang } from \"../misc/LanguageViewModel\"\nimport type { lazy } from \"@tutao/tutanota-utils\"\nimport { Icon } from \"../gui/base/Icon\"\nimport { SegmentControl } from \"../gui/base/SegmentControl\"\nimport { AvailablePlanType, Const, PlanType } from \"../api/common/TutanotaConstants\"\nimport { PaymentInterval } from \"./PriceUtils\"\nimport Stream from \"mithril/stream\"\nimport { Icons } from \"../gui/base/icons/Icons\"\nimport { BootIcons } from \"../gui/base/icons/BootIcons\"\nimport { InfoIcon } from \"../gui/base/InfoIcon.js\"\nimport { theme } from \"../gui/theme.js\"\nimport { isReferenceDateWithinCyberMondayCampaign } from \"../misc/CyberMondayUtils.js\"\nimport { client } from \"../misc/ClientDetector\"\nimport { isIOSApp } from \"../api/common/Env\"\n\nexport type BuyOptionBoxAttr = {\n\theading: string | Children\n\t// lazy<ButtonAttrs> because you can't do actionButton instanceof ButtonAttrs since ButtonAttrs doesn't exist in the javascript side\n\t// there is a strange interaction between the HTMLEditor in HTML mode and the ButtonN when you pass the ButtonN in via a component\n\t// that doesn't occur when you pass in the attrs\n\tactionButton?: lazy<Children>\n\tprice: string\n\t/**\n\t * Null when we do not want to show the difference between actual price and reference price.\n\t */\n\treferencePrice?: string\n\tpriceHint?: MaybeTranslation\n\thelpLabel: MaybeTranslation\n\twidth: number\n\theight: number\n\t/**\n\t * can be null if the subscription is free, or it's not an initial upgrade box\n\t */\n\tselectedPaymentInterval: Stream<PaymentInterval> | null\n\taccountPaymentInterval: PaymentInterval | null\n\thighlighted?: boolean\n\tmobile: boolean\n\tbonusMonths: number\n\t/**\n\t * Nullable because of the gift card component compatibility\n\t */\n\ttargetSubscription?: AvailablePlanType\n}\n\nexport type BuyOptionDetailsAttr = {\n\tcategories: Array<{\n\t\ttitle: string | null\n\t\tkey: string\n\t\tfeatureCount: { max: number }\n\t\tfeatures: Array<{ text: string; toolTip?: Child; key: string; antiFeature?: boolean; omit: boolean; heart: boolean }>\n\t}>\n\tfeaturesExpanded?: boolean\n\trenderCategoryTitle: boolean\n\ticonStyle?: Record<string, any>\n}\n\nexport function getActiveSubscriptionActionButtonReplacement(): () => Children {\n\treturn () =>\n\t\tm(\n\t\t\t\".buyOptionBox.content-accent-fg.center-vertically.text-center\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\t\"border-radius\": px(size.border_radius_small),\n\t\t\t\t},\n\t\t\t},\n\t\t\tlang.get(\"pricing.currentPlan_label\"),\n\t\t)\n}\n\nexport const BOX_MARGIN = 10\n\nexport class BuyOptionDetails implements Component<BuyOptionDetailsAttr> {\n\tprivate featuresExpanded: boolean = false\n\tprivate featureListItemSelector: string = \".flex\"\n\n\tonbeforeupdate(vnode: Vnode<BuyOptionDetailsAttr>, old: VnodeDOM<BuyOptionDetailsAttr>) {\n\t\t// the expand css class renders an animation which is used when the feature list is expanded\n\t\t// the animation should only be shown when the user clicked on the feature expansion button which changes the expanded state\n\t\t// thus to check whether the button was pressed, the BuyOptionBox before update must not be expanded but the BuyOptionBox after update is\n\t\t// otherwise mithril sometimes updates the view and renders the animation even though nothing changed\n\t\tif (vnode.attrs.featuresExpanded && !old.attrs.featuresExpanded) {\n\t\t\tthis.featureListItemSelector = \".flex.expand\"\n\t\t} else {\n\t\t\tthis.featureListItemSelector = \".flex\"\n\t\t}\n\t}\n\n\tview(vnode: Vnode<BuyOptionDetailsAttr>) {\n\t\tconst { attrs } = vnode\n\t\tthis.featuresExpanded = attrs.featuresExpanded || false\n\n\t\treturn m(\n\t\t\t\".mt.pl\",\n\t\t\tattrs.categories.map((fc) => {\n\t\t\t\treturn [\n\t\t\t\t\tthis.renderCategoryTitle(fc, attrs.renderCategoryTitle),\n\t\t\t\t\tfc.features\n\t\t\t\t\t\t.filter((f) => !f.omit || this.featuresExpanded)\n\t\t\t\t\t\t.map((f) =>\n\t\t\t\t\t\t\tm(this.featureListItemSelector, { key: f.key }, [\n\t\t\t\t\t\t\t\tf.heart\n\t\t\t\t\t\t\t\t\t? m(Icon, {\n\t\t\t\t\t\t\t\t\t\t\ticon: BootIcons.Heart,\n\t\t\t\t\t\t\t\t\t\t\tstyle: attrs.iconStyle,\n\t\t\t\t\t\t\t\t\t  })\n\t\t\t\t\t\t\t\t\t: m(Icon, { icon: f.antiFeature ? Icons.Cancel : Icons.Checkmark, style: attrs.iconStyle }),\n\t\t\t\t\t\t\t\tm(\".small.text-left.align-self-center.pl-s.button-height.flex-grow.min-width-0.break-word\", [m(\"span\", f.text)]),\n\t\t\t\t\t\t\t\tf.toolTip ? m(InfoIcon, { text: f.toolTip }) : null,\n\t\t\t\t\t\t\t]),\n\t\t\t\t\t\t),\n\t\t\t\t\tthis.renderPlaceholders(fc),\n\t\t\t\t]\n\t\t\t}),\n\t\t)\n\t}\n\n\tprivate renderCategoryTitle(fc: BuyOptionDetailsAttr[\"categories\"][0], renderCategoryTitle: boolean): Children {\n\t\tif (fc.title && this.featuresExpanded) {\n\t\t\treturn [\n\t\t\t\tm(\".b.text-left.align-self-center.pl-s.button-height.flex-grow.min-width-0.break-word\", \"\"),\n\t\t\t\tm(\".b.text-left.align-self-center.pl-s.button-height.flex-grow.min-width-0.break-word\", renderCategoryTitle ? fc.title : \"\"),\n\t\t\t]\n\t\t} else {\n\t\t\treturn []\n\t\t}\n\t}\n\n\tprivate renderPlaceholders(fc: BuyOptionDetailsAttr[\"categories\"][0]): Children {\n\t\tif (!this.featuresExpanded) {\n\t\t\treturn []\n\t\t} else {\n\t\t\tconst placeholderCount = fc.featureCount.max - fc.features.length\n\t\t\treturn [...Array(placeholderCount)].map(() => m(\".button-height\", \"\"))\n\t\t}\n\t}\n}\n\nexport class BuyOptionBox implements Component<BuyOptionBoxAttr> {\n\tview(vnode: Vnode<BuyOptionBoxAttr>) {\n\t\tconst { attrs } = vnode\n\n\t\tconst isCyberMonday = isReferenceDateWithinCyberMondayCampaign(Const.CURRENT_DATE ?? new Date())\n\t\tconst isLegendPlan = attrs.targetSubscription === PlanType.Legend\n\t\tconst isYearly = (attrs.selectedPaymentInterval == null ? attrs.accountPaymentInterval : attrs.selectedPaymentInterval()) === PaymentInterval.Yearly\n\t\tconst shouldApplyCyberMondayDesign = isLegendPlan && isCyberMonday && isYearly\n\n\t\treturn m(\n\t\t\t\".fg-black\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\twidth: px(attrs.width),\n\t\t\t\t\tpadding: \"10px\",\n\t\t\t\t\theight: \"100%\",\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(\n\t\t\t\t\t\".buyOptionBox\" + (attrs.highlighted ? (shouldApplyCyberMondayDesign ? \".highlighted.cyberMonday\" : \".highlighted\") : \"\"),\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tdisplay: \"flex\",\n\t\t\t\t\t\t\t\"flex-direction\": \"column\",\n\t\t\t\t\t\t\t\"min-height\": px(attrs.height),\n\t\t\t\t\t\t\t\"border-radius\": \"3px\",\n\t\t\t\t\t\t\theight: \"100%\",\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t[\n\t\t\t\t\t\tshouldApplyCyberMondayDesign ? this.renderCyberMondayRibbon() : this.renderBonusMonthsRibbon(attrs.bonusMonths),\n\t\t\t\t\t\ttypeof attrs.heading === \"string\" ? this.renderHeading(attrs.heading) : attrs.heading,\n\t\t\t\t\t\tthis.renderPrice(attrs.price, isYearly ? attrs.referencePrice : undefined),\n\t\t\t\t\t\tm(\".small.text-center\", attrs.priceHint ? lang.getTranslationText(attrs.priceHint) : lang.get(\"emptyString_msg\")),\n\t\t\t\t\t\tm(\".small.text-center.pb-ml\", lang.getTranslationText(attrs.helpLabel)),\n\t\t\t\t\t\tthis.renderPaymentIntervalControl(attrs.selectedPaymentInterval, shouldApplyCyberMondayDesign),\n\t\t\t\t\t\tattrs.actionButton\n\t\t\t\t\t\t\t? m(\n\t\t\t\t\t\t\t\t\t\".button-min-height\",\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\t\t\"margin-top\": \"auto\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\tattrs.actionButton(),\n\t\t\t\t\t\t\t  )\n\t\t\t\t\t\t\t: null,\n\t\t\t\t\t],\n\t\t\t\t),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderPrice(price: string, strikethroughPrice?: string) {\n\t\treturn m(\n\t\t\t\".pt-ml.text-center\",\n\t\t\t{ style: { display: \"grid\", \"grid-template-columns\": \"1fr auto 1fr\", \"align-items\": \"center\" } },\n\t\t\tstrikethroughPrice != null && strikethroughPrice.trim() !== \"\"\n\t\t\t\t? m(\n\t\t\t\t\t\t\".span.strike\",\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\tcolor: theme.content_button,\n\t\t\t\t\t\t\t\tfontSize: px(size.font_size_base),\n\t\t\t\t\t\t\t\tjustifySelf: \"end\",\n\t\t\t\t\t\t\t\tmargin: \"auto 0.4em 0 0\",\n\t\t\t\t\t\t\t\tpadding: \"0.4em 0\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\tstrikethroughPrice,\n\t\t\t\t  )\n\t\t\t\t: m(\"\"),\n\t\t\tm(\".h1\", price),\n\t\t\tm(\"\"),\n\t\t)\n\t}\n\n\tprivate renderBonusMonthsRibbon(bonusMonths: number): Children {\n\t\treturn bonusMonths > 0 ? this.renderRibbon(`+${bonusMonths} ${lang.get(\"pricing.months_label\")}`) : null\n\t}\n\n\tprivate renderRibbon(text: string) {\n\t\treturn m(\".ribbon-horizontal\", m(\".text-center.b\", { style: { padding: px(3) } }, text))\n\t}\n\n\tprivate renderCyberMondayRibbon(): Children {\n\t\tconst text = isIOSApp() ? \"DEAL\" : lang.get(\"pricing.cyberMonday_label\")\n\t\treturn m(\".ribbon-horizontal.ribbon-horizontal-cyber-monday\", m(\".text-center.b\", { style: { padding: px(3) } }, text))\n\t}\n\n\tprivate renderPaymentIntervalControl(paymentInterval: Stream<PaymentInterval> | null, shouldApplyCyberMonday: boolean): Children {\n\t\tconst paymentIntervalItems = [\n\t\t\t{ name: lang.get(\"pricing.yearly_label\"), value: PaymentInterval.Yearly },\n\t\t\t{ name: lang.get(\"pricing.monthly_label\"), value: PaymentInterval.Monthly },\n\t\t]\n\t\treturn paymentInterval\n\t\t\t? m(SegmentControl, {\n\t\t\t\t\tselectedValue: paymentInterval(),\n\t\t\t\t\titems: paymentIntervalItems,\n\t\t\t\t\tonValueSelected: (v: PaymentInterval) => {\n\t\t\t\t\t\tpaymentInterval?.(v)\n\t\t\t\t\t\tm.redraw()\n\t\t\t\t\t},\n\t\t\t\t\tshouldApplyCyberMonday,\n\t\t\t  })\n\t\t\t: null\n\t}\n\n\tprivate renderHeading(heading: string): Children {\n\t\treturn m(\n\t\t\t// we need some margin for the discount banner for longer translations shown on the website\n\t\t\t`.h4.text-center.mb-small-line-height.flex.col.center-horizontally.mlr-l.dialog-header`,\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\t\"font-size\": heading.length > 20 ? \"smaller\" : undefined,\n\t\t\t\t},\n\t\t\t},\n\t\t\theading,\n\t\t)\n\t}\n}\n","export async function requestFromWebsite(path: string, domainConfig: DomainConfig): Promise<Response> {\n\tconst url = new URL(path, domainConfig.websiteBaseUrl)\n\treturn fetch(url.href)\n}\n","/**\n * The most recently published version of the terms and conditions\n */\nimport m, { Children } from \"mithril\"\nimport { InfoLink, lang } from \"../misc/LanguageViewModel\"\nimport { isApp } from \"../api/common/Env\"\nimport { requestFromWebsite } from \"../misc/Website\"\nimport { Dialog } from \"../gui/base/Dialog\"\nimport { htmlSanitizer } from \"../misc/HtmlSanitizer\"\nimport { DialogHeaderBarAttrs } from \"../gui/base/DialogHeaderBar\"\nimport { ButtonType } from \"../gui/base/Button.js\"\nimport { locator } from \"../api/main/CommonLocator.js\"\n\n/**\n * The most up-to-date versions of the terms and conditions, privacy statement, and gift card terms\n * must be in sync with the website\n */\nexport const CURRENT_TERMS_VERSION = \"3.2\" as const\nexport const CURRENT_PRIVACY_VERSION = \"3.1\" as const\nexport const CURRENT_GIFT_CARD_TERMS_VERSION = \"1.0\" as const\n\n/**\n * Show a link to the terms and conditions page on the website.\n * In the mobile apps, it will instead open a dialog containing the text\n */\nexport function renderTermsAndConditionsButton(terms: TermsSection, version: string): Children {\n\tlet label\n\tlet link\n\tswitch (terms) {\n\t\tcase TermsSection.GiftCards:\n\t\t\tlabel = lang.get(\"giftCardTerms_label\")\n\t\t\tlink = InfoLink.GiftCardsTerms\n\t\t\tbreak\n\t\tcase TermsSection.Terms:\n\t\t\tlabel = lang.get(\"termsAndConditionsLink_label\")\n\t\t\tlink = InfoLink.Terms\n\t\t\tbreak\n\t\tcase TermsSection.Privacy:\n\t\t\tlabel = lang.get(\"privacyLink_label\")\n\t\t\tlink = InfoLink.Privacy\n\t\t\tbreak\n\t}\n\treturn m(\n\t\t`a[href=${link}][target=_blank]`,\n\t\t{\n\t\t\tonclick: (e: MouseEvent) => {\n\t\t\t\tif (isApp()) {\n\t\t\t\t\tshowServiceTerms(terms, version)\n\t\t\t\t\te.preventDefault()\n\t\t\t\t}\n\t\t\t},\n\t\t},\n\t\tlabel,\n\t)\n}\n\n/**\n * An enum denoting a section of the tutanota terms to request.\n * The value of the enum is the path that is used in the request to the website\n */\nexport const enum TermsSection {\n\tTerms = \"terms-entries\",\n\tPrivacy = \"privacy-policy-entries\",\n\tGiftCards = \"giftCardsTerms-entries\",\n}\n\nexport async function showServiceTerms(section: TermsSection, version: string) {\n\tconst path = `/${section}/${version}.json`\n\tconst termsFromWebsite = await requestFromWebsite(path, locator.domainConfigProvider().getCurrentDomainConfig()).then((res) => res.json())\n\tlet visibleLang: \"en\" | \"de\" = lang.code.startsWith(\"de\") ? \"de\" : \"en\"\n\tlet dialog: Dialog\n\tlet sanitizedTerms: string\n\n\tfunction getSection(): string {\n\t\treturn htmlSanitizer.sanitizeHTML(termsFromWebsite[visibleLang], {\n\t\t\tblockExternalContent: false,\n\t\t}).html\n\t}\n\n\tlet headerBarAttrs: DialogHeaderBarAttrs = {\n\t\tleft: [\n\t\t\t{\n\t\t\t\tlabel: lang.makeTranslation(\"lang_toggle\", \"EN/DE\"),\n\t\t\t\tclick: () => {\n\t\t\t\t\tvisibleLang = visibleLang === \"de\" ? \"en\" : \"de\"\n\t\t\t\t\tsanitizedTerms = getSection()\n\t\t\t\t\tm.redraw()\n\t\t\t\t},\n\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t},\n\t\t],\n\t\tright: [\n\t\t\t{\n\t\t\t\tlabel: \"ok_action\",\n\t\t\t\tclick: () => dialog.close(),\n\t\t\t\ttype: ButtonType.Primary,\n\t\t\t},\n\t\t],\n\t}\n\tsanitizedTerms = getSection()\n\tdialog = Dialog.largeDialog(headerBarAttrs, {\n\t\tview: () => m(\".text-break\", m.trust(sanitizedTerms)),\n\t}).show()\n}\n","import m, { Children } from \"mithril\"\nimport { Icons } from \"../../gui/base/icons/Icons\"\nimport type { CustomerInfo, GiftCard } from \"../../api/entities/sys/TypeRefs.js\"\nimport { CustomerInfoTypeRef, CustomerTypeRef, GiftCardTypeRef } from \"../../api/entities/sys/TypeRefs.js\"\nimport { locator } from \"../../api/main/CommonLocator\"\nimport { lang, MaybeTranslation } from \"../../misc/LanguageViewModel\"\nimport { UserError } from \"../../api/main/UserError\"\nimport { Dialog } from \"../../gui/base/Dialog\"\nimport { ButtonType } from \"../../gui/base/Button.js\"\nimport { DefaultAnimationTime } from \"../../gui/animation/Animations\"\nimport { copyToClipboard } from \"../../misc/ClipboardUtils\"\nimport { BootIcons } from \"../../gui/base/icons/BootIcons\"\nimport { isAndroidApp, isApp } from \"../../api/common/Env\"\nimport { Checkbox } from \"../../gui/base/Checkbox.js\"\nimport { Keys } from \"../../api/common/TutanotaConstants\"\nimport { CURRENT_GIFT_CARD_TERMS_VERSION, renderTermsAndConditionsButton, TermsSection } from \"../TermsAndConditions\"\nimport { IconButton } from \"../../gui/base/IconButton.js\"\nimport { formatPrice } from \"../PriceUtils.js\"\nimport { htmlSanitizer } from \"../../misc/HtmlSanitizer.js\"\nimport { urlEncodeHtmlTags } from \"../../misc/Formatter.js\"\nimport QRCode from \"qrcode-svg\"\n\nexport const enum GiftCardStatus {\n\tDeactivated = \"0\",\n\tUsable = \"1\",\n\tRedeemed = \"2\",\n\tRefunded = \"3\",\n\tDisputed = \"4\",\n}\n\nexport async function getTokenFromUrl(url: string): Promise<{ id: Id; key: string }> {\n\tconst token = url.substring(url.indexOf(\"#\") + 1)\n\n\ttry {\n\t\tif (!token) {\n\t\t\tthrow new Error()\n\t\t}\n\n\t\treturn await locator.giftCardFacade.decodeGiftCardToken(token)\n\t} catch (e) {\n\t\tthrow new UserError(\"invalidGiftCard_msg\")\n\t}\n}\n\nexport function loadGiftCards(customerId: Id): Promise<GiftCard[]> {\n\tconst entityClient = locator.entityClient\n\treturn entityClient\n\t\t.load(CustomerTypeRef, customerId)\n\t\t.then((customer) => entityClient.load(CustomerInfoTypeRef, customer.customerInfo))\n\t\t.then((customerInfo: CustomerInfo) => {\n\t\t\tif (customerInfo.giftCards) {\n\t\t\t\treturn entityClient.loadAll(GiftCardTypeRef, customerInfo.giftCards.items)\n\t\t\t} else {\n\t\t\t\treturn Promise.resolve([])\n\t\t\t}\n\t\t})\n}\n\nexport async function generateGiftCardLink(giftCard: GiftCard): Promise<string> {\n\tconst token = await locator.giftCardFacade.encodeGiftCardToken(giftCard)\n\tconst giftCardBaseUrl = locator.domainConfigProvider().getCurrentDomainConfig().giftCardBaseUrl\n\tconst giftCardUrl = new URL(giftCardBaseUrl)\n\tgiftCardUrl.hash = token\n\treturn giftCardUrl.href\n}\n\nexport function showGiftCardToShare(giftCard: GiftCard) {\n\tgenerateGiftCardLink(giftCard).then((link) => {\n\t\tlet infoMessage: MaybeTranslation = \"emptyString_msg\"\n\t\tconst dialog: Dialog = Dialog.largeDialog(\n\t\t\t{\n\t\t\t\tright: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t\t\tlabel: \"close_alt\",\n\t\t\t\t\t\tclick: () => dialog.close(),\n\t\t\t\t\t},\n\t\t\t\t],\n\t\t\t\tmiddle: \"giftCard_label\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tview: () => [\n\t\t\t\t\tm(\n\t\t\t\t\t\t\".flex-center.full-width.pt.pb\",\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\".pt-l\", // Needed to center SVG\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\twidth: \"480px\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\trenderGiftCardSvg(parseFloat(giftCard.value), link, giftCard.message),\n\t\t\t\t\t\t),\n\t\t\t\t\t),\n\t\t\t\t\tm(\".flex-center\", [\n\t\t\t\t\t\tm(IconButton, {\n\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\tdialog.close()\n\t\t\t\t\t\t\t\tsetTimeout(\n\t\t\t\t\t\t\t\t\t() => import(\"../../../mail-app/mail/editor/MailEditor\").then((editor) => editor.writeGiftCardMail(link)),\n\t\t\t\t\t\t\t\t\tDefaultAnimationTime,\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttitle: \"shareViaEmail_action\",\n\t\t\t\t\t\t\ticon: BootIcons.Mail,\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tisAndroidApp()\n\t\t\t\t\t\t\t? m(IconButton, {\n\t\t\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t\t\tlocator.systemFacade.shareText(\n\t\t\t\t\t\t\t\t\t\t\tlang.get(\"nativeShareGiftCard_msg\", {\n\t\t\t\t\t\t\t\t\t\t\t\t\"{link}\": link,\n\t\t\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t\t\t\tlang.get(\"nativeShareGiftCard_label\"),\n\t\t\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\ttitle: \"share_action\",\n\t\t\t\t\t\t\t\t\ticon: BootIcons.Share,\n\t\t\t\t\t\t\t  })\n\t\t\t\t\t\t\t: m(IconButton, {\n\t\t\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t\t\tcopyToClipboard(link)\n\t\t\t\t\t\t\t\t\t\t\t.then(() => {\n\t\t\t\t\t\t\t\t\t\t\t\tinfoMessage = \"giftCardCopied_msg\"\n\t\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t\t\t.catch(() => {\n\t\t\t\t\t\t\t\t\t\t\t\tinfoMessage = \"copyLinkError_msg\"\n\t\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\ttitle: \"copyToClipboard_action\",\n\t\t\t\t\t\t\t\t\ticon: Icons.Clipboard,\n\t\t\t\t\t\t\t  }),\n\t\t\t\t\t\t!isApp()\n\t\t\t\t\t\t\t? m(IconButton, {\n\t\t\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t\t\tinfoMessage = \"emptyString_msg\"\n\t\t\t\t\t\t\t\t\t\twindow.print()\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\ttitle: \"print_action\",\n\t\t\t\t\t\t\t\t\ticon: Icons.Print,\n\t\t\t\t\t\t\t  })\n\t\t\t\t\t\t\t: null,\n\t\t\t\t\t]),\n\t\t\t\t\tm(\".flex-center\", m(\"small.noprint\", lang.getTranslationText(infoMessage))),\n\t\t\t\t],\n\t\t\t},\n\t\t)\n\t\t\t.addShortcut({\n\t\t\t\tkey: Keys.ESC,\n\t\t\t\texec: () => dialog.close(),\n\t\t\t\thelp: \"close_alt\",\n\t\t\t})\n\t\t\t.show()\n\t})\n}\n\n// Used to get gift-card.svg when `renderGiftCardSvg()` is called and cache it.\nconst giftCardSVGGetter = new (class GiftCardSVGGetter {\n\tprivate static giftCardSvg: string | null = null\n\tprivate static giftCardNoQrSvg: string | null = null\n\n\t// Returns a cached `gift-card.svg` or downloads it if online. Returns a placeholder if offline.\n\tgetWithQr(): string {\n\t\tif (GiftCardSVGGetter.giftCardSvg == null) {\n\t\t\tGiftCardSVGGetter.downloadSVG(\"gift-card\", (rawSVG) => {\n\t\t\t\tGiftCardSVGGetter.giftCardSvg = rawSVG\n\t\t\t\tm.redraw() // Rerender any calling views that use the SVG\n\t\t\t})\n\t\t\treturn GiftCardSVGGetter.getPlaceHolder(\"<rect id='qr-code' width='80' height='80' x='0' y='70'></rect>\")\n\t\t}\n\t\treturn GiftCardSVGGetter.giftCardSvg\n\t}\n\n\t// Returns a cached `gift-card-no-qr.svg` or downloads it if online. Returns a placeholder if offline.\n\tgetNoQr(): string {\n\t\tif (GiftCardSVGGetter.giftCardNoQrSvg == null) {\n\t\t\tGiftCardSVGGetter.downloadSVG(\"gift-card-no-qr\", (rawSVG) => {\n\t\t\t\tGiftCardSVGGetter.giftCardNoQrSvg = rawSVG\n\t\t\t\tm.redraw()\n\t\t\t})\n\t\t\treturn GiftCardSVGGetter.getPlaceHolder()\n\t\t}\n\t\treturn GiftCardSVGGetter.giftCardNoQrSvg\n\t}\n\n\t// Downloads an SVG from the images folder without returning a promise via using a callback\n\tprivate static downloadSVG(fileName: string, onComplete: (rawSVG: string) => void) {\n\t\tfetch(`${window.tutao.appState.prefixWithoutFile}/images/${fileName}.svg`).then(\n\t\t\tasync (res) => {\n\t\t\t\tonComplete(await res.text())\n\t\t\t},\n\t\t\t() => {},\n\t\t)\n\t}\n\n\t// Renders the placeholder gift card, optionally with extra HTML\n\tprivate static getPlaceHolder(extraElements: string = \"\"): string {\n\t\treturn `\n\t\t\t<svg width='480' height='600'>\n\t\t\t\t<text id='card-label' x='0' y='20'></text>\n\t\t\t\t<text id='message' x='0' y='40' fill='#fff'></text>\n\t\t\t\t<text id='price' x='0' y='60'></text>\n\t\t\t\t${extraElements}\n\t\t\t</svg>`\n\t}\n})()\n\nexport function renderGiftCardSvg(price: number, link: string | null, message: string): Children {\n\tconst svg = link == null ? giftCardSVGGetter.getNoQr() : giftCardSVGGetter.getWithQr()\n\tconst svgDocument: Document = new DOMParser().parseFromString(svg, \"image/svg+xml\")\n\n\t// Generate and replace the qrcode placeholder a QR Code to the link if provided\n\tif (link != null) {\n\t\tconst qrCodeElement = getGiftCardElement(svgDocument, \"qr-code\")\n\t\tconst qrCodeWidth = getNumberAttribute(qrCodeElement, \"width\")\n\t\tconst qrCodeHeight = getNumberAttribute(qrCodeElement, \"height\")\n\t\tconst qrCodeXPosition = getNumberAttribute(qrCodeElement, \"x\")\n\t\tconst qrCodeYPosition = getNumberAttribute(qrCodeElement, \"y\")\n\t\tqrCodeElement.outerHTML = renderQRCode(qrCodeXPosition, qrCodeYPosition, qrCodeWidth, qrCodeHeight, link)\n\t}\n\n\tconst labelElement = getGiftCardElement(svgDocument, \"card-label\")\n\tlabelElement.textContent = lang.get(\"giftCard_label\").toUpperCase()\n\n\tconst priceElement = getGiftCardElement(svgDocument, \"price\")\n\tpriceElement.textContent = formatPrice(price, false).replace(/\\s+/g, \"\") + \"€\"\n\t// Append the € symbol manually because in one particular language the € sign is being translated into \"EUR\" using `formatPrice` method\n\n\t// SVG text elements do not have word wrap, so we use an HTML `p` element to avoid word wrapping via JS ourselves\n\t// It would be nice to have this decoupled from the current design of the gift card\n\tconst messageElement = getGiftCardElement(svgDocument, \"message\")\n\tconst messageColor = getAttribute(messageElement, \"fill\")\n\tmessageElement.outerHTML = renderMessage(19, 61, 108, 70, messageColor, message)\n\n\treturn m.trust(svgDocument.documentElement.outerHTML)\n}\n\n// Gets an attribute of an element that has a type of number\nfunction getNumberAttribute(element: Element, attributeName: string): number {\n\tconst raw = element.getAttribute(attributeName)\n\tif (raw == null) {\n\t\tthrow new Error(`Error while rendering gift card: missing attribute ${attributeName} from ${element.id}`)\n\t}\n\treturn Number(raw)\n}\n\nfunction getAttribute(element: Element, attributeName: string): string {\n\tconst raw = element.getAttribute(attributeName)\n\tif (raw == null) {\n\t\tthrow new Error(`Error while rendering gift card: missing attribute ${attributeName} from ${element.id}`)\n\t}\n\treturn raw\n}\n\n// Gets one of the standard gift card elements from an SVG.\nfunction getGiftCardElement(svgDocument: Document, id: \"price\" | \"qr-code\" | \"message\" | \"card-label\"): SVGElement {\n\tconst element = svgDocument.getElementById(id) as SVGElement | null\n\tif (element == null) {\n\t\tthrow new Error(`Error while rendering gift card: missing element ${id}`)\n\t}\n\treturn element\n}\n\n/**\n * Renders a text with word wrapping in an SVG element. (0,0) is the top left.\n * @param x The position of the element on the X Axis.\n * @param y The position of the element on the Y Axis.\n * @param width The width of the text element.\n * @param height The height of the text element.\n * @param color The fill colour of the text element.\n * @param message The text to be displayed in the element.\n */\nfunction renderMessage(x: number, y: number, width: number, height: number, color: string, message: string): string {\n\tconst cleanMessage: string = htmlSanitizer.sanitizeHTML(urlEncodeHtmlTags(message)).html\n\n\tconst lineBreaks = cleanMessage.split(/\\r\\n|\\r|\\n/).length\n\tconst charLength = cleanMessage.length\n\n\tconst fontSizePx = lineBreaks > 4 || charLength > 80 ? \"6px\" : \"7px\"\n\n\treturn `\n\t\t<foreignObject x=\"${x}\" y=\"${y}\" width=\"${width}\" height=\"${height}\" fill=\"${color}\">\n\t\t\t<p xmlns=\"http://www.w3.org/1999/xhtml\"\n\t\t\t   class=\"text-preline text-break color-adjust-exact monospace\"\n\t\t\t   style=\"font-size: ${fontSizePx}; color: ${color}; margin: auto 0 0 0\">\n\t\t\t\t${cleanMessage}\n\t\t\t</p>\n\t\t</foreignObject>`\n}\n\n/**\n * Generates a black-on-white QR Code in SVG form\n * @param x The position on the X Axis of the QR Code. 0 is the far left.\n * @param y The position on the Y Axis of the QR Code. 0 is the top.\n * @param link The link that the generated QR code will lead to when scanned\n * @param height The height in pixels of the resulting QR code\n * @param width The width in pixels of the resulting QR code\n * @return the SVG element of the generated QR code as a `string`\n */\nfunction renderQRCode(x: number, y: number, width: number, height: number, link: string): string {\n\tconst svg = new QRCode({\n\t\theight,\n\t\twidth,\n\t\tcontent: link,\n\t\tbackground: \"#ffffff\",\n\t\tcolor: \"#000000\",\n\t\txmlDeclaration: false,\n\t\tcontainer: \"none\",\n\t\tpadding: 0,\n\t\tjoin: true,\n\t\tpretty: false,\n\t}).svg()\n\tconst qrCode = htmlSanitizer.sanitizeSVG(svg).html\n\n\treturn `<svg x=\"${x}\" y=\"${y}\" width=\"${width}\" height=\"${height}\">${qrCode}</svg>`\n}\n\nexport function renderAcceptGiftCardTermsCheckbox(checked: boolean, onChecked: (checked: boolean) => void, classes?: string): Children {\n\treturn m(Checkbox, {\n\t\tchecked,\n\t\tonChecked,\n\t\tclass: classes,\n\t\tlabel: () => [lang.get(\"termsAndConditions_label\"), m(\"div\", renderTermsAndConditionsButton(TermsSection.GiftCards, CURRENT_GIFT_CARD_TERMS_VERSION))],\n\t})\n}\n","import m, { Children, Component, Vnode } from \"mithril\"\nimport { lang } from \"../../misc/LanguageViewModel\"\nimport { assertNotNull } from \"@tutao/tutanota-utils\"\nimport { px, size } from \"../../gui/size.js\"\n\nexport const GIFT_CARD_MESSAGE_COLS = 26\nconst GIFT_CARD_MESSAGE_HEIGHT = 5\ntype GiftCardMessageEditorFieldAttrs = {\n\tmessage: string\n\tonMessageChanged: (message: string) => void\n\tcols?: number\n\trows?: number\n}\n/**\n * A text area that allows you to edit some text that is limited to fit within a certain rows/columns boundary\n */\nexport class GiftCardMessageEditorField implements Component<GiftCardMessageEditorFieldAttrs> {\n\tprivate textAreaDom: HTMLTextAreaElement | null = null\n\tprivate isActive: boolean = false\n\n\tview(vnode: Vnode<GiftCardMessageEditorFieldAttrs>): Children {\n\t\tconst a = vnode.attrs\n\t\treturn m(\"label.small.mt-form.i.flex-center.flex-column\", [\n\t\t\t// Cannot wrap the label in a span to apply the `small` class as it will break screen readers\n\t\t\tlang.get(\"yourMessage_label\"),\n\t\t\tm(\"textarea.monospace.normal-font-size.overflow-hidden.resize-none\" + (this.isActive ? \".editor-border-active\" : \".editor-border\"), {\n\t\t\t\twrap: \"hard\",\n\t\t\t\tcols: a.cols || GIFT_CARD_MESSAGE_COLS,\n\t\t\t\trows: a.rows || GIFT_CARD_MESSAGE_HEIGHT,\n\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\tthis.textAreaDom = vnode.dom as HTMLTextAreaElement\n\t\t\t\t\tthis.textAreaDom.value = a.message\n\t\t\t\t},\n\t\t\t\tonfocus: () => {\n\t\t\t\t\tthis.isActive = true\n\t\t\t\t},\n\t\t\t\tonblur: () => {\n\t\t\t\t\tthis.isActive = false\n\t\t\t\t},\n\t\t\t\toninput: () => {\n\t\t\t\t\tconst textAreaDom = assertNotNull(this.textAreaDom)\n\t\t\t\t\tconst origStart = textAreaDom.selectionStart\n\t\t\t\t\tconst origEnd = textAreaDom.selectionEnd\n\n\t\t\t\t\t// remove characters from the end\n\t\t\t\t\twhile (textAreaDom.clientHeight < textAreaDom.scrollHeight) {\n\t\t\t\t\t\ttextAreaDom.value = textAreaDom.value.substring(0, textAreaDom.value.length - 1)\n\t\t\t\t\t}\n\n\t\t\t\t\ta.onMessageChanged(textAreaDom.value)\n\n\t\t\t\t\t// the cursor gets pushed to the end when we chew up tailing characters, so we put it back where it started in that case\n\t\t\t\t\tif (textAreaDom.selectionStart - origStart > 1) {\n\t\t\t\t\t\ttextAreaDom.selectionStart = origStart\n\t\t\t\t\t\ttextAreaDom.selectionEnd = origEnd\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t}),\n\t\t])\n\t}\n}\n","import m, { Children, Component, Vnode } from \"mithril\"\nimport { Dialog } from \"../../gui/base/Dialog\"\nimport type { GiftCard, GiftCardOption } from \"../../api/entities/sys/TypeRefs.js\"\nimport { GiftCardTypeRef } from \"../../api/entities/sys/TypeRefs.js\"\nimport { showProgressDialog } from \"../../gui/dialogs/ProgressDialog\"\nimport { locator } from \"../../api/main/CommonLocator\"\nimport { BOX_MARGIN, BuyOptionBox } from \"../BuyOptionBox\"\nimport { ButtonType } from \"../../gui/base/Button.js\"\nimport { getPreconditionFailedPaymentMsg } from \"../SubscriptionUtils\"\nimport { renderAcceptGiftCardTermsCheckbox, showGiftCardToShare } from \"./GiftCardUtils\"\nimport type { DialogHeaderBarAttrs } from \"../../gui/base/DialogHeaderBar\"\nimport { showUserError } from \"../../misc/ErrorHandlerImpl\"\nimport { UserError } from \"../../api/main/UserError\"\nimport { Keys, PaymentMethodType, PlanType } from \"../../api/common/TutanotaConstants\"\nimport { lang, Translation } from \"../../misc/LanguageViewModel\"\nimport { BadGatewayError, PreconditionFailedError } from \"../../api/common/error/RestError\"\nimport { GiftCardMessageEditorField } from \"./GiftCardMessageEditorField\"\nimport { client } from \"../../misc/ClientDetector\"\nimport { count, filterInt, noOp, ofClass } from \"@tutao/tutanota-utils\"\nimport { isIOSApp } from \"../../api/common/Env\"\nimport { formatPrice, PaymentInterval, PriceAndConfigProvider } from \"../PriceUtils\"\nimport { GiftCardService } from \"../../api/entities/sys/Services\"\nimport { UpgradePriceType } from \"../FeatureListProvider\"\nimport { TranslationKeyType } from \"../../misc/TranslationKey.js\"\nimport { px } from \"../../gui/size\"\nimport { Icon, IconSize } from \"../../gui/base/Icon\"\nimport { Icons } from \"../../gui/base/icons/Icons\"\nimport { LoginButton } from \"../../gui/base/buttons/LoginButton.js\"\n\nclass PurchaseGiftCardModel {\n\tmessage = lang.get(\"defaultGiftCardMessage_msg\")\n\tconfirmed = false\n\n\tconstructor(\n\t\tprivate readonly config: {\n\t\t\tpurchaseLimit: number\n\t\t\tpurchasePeriodMonths: number\n\t\t\tavailablePackages: Array<GiftCardOption>\n\t\t\tselectedPackage: number\n\t\t\trevolutionaryPrice: number\n\t\t},\n\t) {}\n\n\tget availablePackages(): ReadonlyArray<GiftCardOption> {\n\t\treturn this.config.availablePackages\n\t}\n\n\tget purchaseLimit(): number {\n\t\treturn this.config.purchaseLimit\n\t}\n\n\tget purchasePeriodMonths(): number {\n\t\treturn this.config.purchasePeriodMonths\n\t}\n\n\tget selectedPackage(): number {\n\t\treturn this.config.selectedPackage\n\t}\n\n\tset selectedPackage(selection: number) {\n\t\tthis.config.selectedPackage = selection\n\t}\n\n\tget revolutionaryPrice(): number {\n\t\treturn this.config.revolutionaryPrice\n\t}\n\n\tasync purchaseGiftCard(): Promise<GiftCard> {\n\t\tif (!this.confirmed) {\n\t\t\tthrow new UserError(\"termsAcceptedNeutral_msg\")\n\t\t}\n\n\t\treturn locator.giftCardFacade\n\t\t\t.generateGiftCard(this.message, this.availablePackages[this.selectedPackage].value)\n\t\t\t.then((createdGiftCardId) => locator.entityClient.load(GiftCardTypeRef, createdGiftCardId))\n\t\t\t.catch((e) => this.handlePurchaseError(e))\n\t}\n\n\tprivate handlePurchaseError(e: Error): never {\n\t\tif (e instanceof PreconditionFailedError) {\n\t\t\tconst message = e.data\n\n\t\t\tswitch (message) {\n\t\t\t\tcase \"giftcard.limitreached\":\n\t\t\t\t\tthrow new UserError(\n\t\t\t\t\t\tlang.getTranslation(\"tooManyGiftCards_msg\", {\n\t\t\t\t\t\t\t\"{amount}\": `${this.purchaseLimit}`,\n\t\t\t\t\t\t\t\"{period}\": `${this.purchasePeriodMonths} months`,\n\t\t\t\t\t\t}),\n\t\t\t\t\t)\n\n\t\t\t\tcase \"giftcard.noaccountinginfo\":\n\t\t\t\t\tthrow new UserError(\"providePaymentDetails_msg\")\n\n\t\t\t\tcase \"giftcard.invalidpaymentmethod\":\n\t\t\t\t\tthrow new UserError(\"invalidGiftCardPaymentMethod_msg\")\n\n\t\t\t\tdefault:\n\t\t\t\t\tthrow new UserError(getPreconditionFailedPaymentMsg(e.data))\n\t\t\t}\n\t\t} else if (e instanceof BadGatewayError) {\n\t\t\tthrow new UserError(\"paymentProviderNotAvailableError_msg\")\n\t\t} else {\n\t\t\tthrow e\n\t\t}\n\t}\n}\n\ninterface GiftCardPurchaseViewAttrs {\n\tmodel: PurchaseGiftCardModel\n\tonGiftCardPurchased: (giftCard: GiftCard) => void\n}\n\nclass GiftCardPurchaseView implements Component<GiftCardPurchaseViewAttrs> {\n\tview(vnode: Vnode<GiftCardPurchaseViewAttrs>): Children {\n\t\tconst { model, onGiftCardPurchased } = vnode.attrs\n\t\treturn [\n\t\t\tm(\n\t\t\t\t\".flex.center-horizontally.wrap.pt-ml\",\n\t\t\t\t{\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\"column-gap\": px(BOX_MARGIN),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tmodel.availablePackages.map((option, index) => {\n\t\t\t\t\tconst value = parseFloat(option.value)\n\n\t\t\t\t\treturn m(BuyOptionBox, {\n\t\t\t\t\t\theading: m(\n\t\t\t\t\t\t\t\".flex-center\",\n\t\t\t\t\t\t\tArray(Math.pow(2, index)).fill(\n\t\t\t\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\t\t\t\ticon: Icons.Gift,\n\t\t\t\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t),\n\t\t\t\t\t\tactionButton: () =>\n\t\t\t\t\t\t\tm(LoginButton, {\n\t\t\t\t\t\t\t\tlabel: \"pricing.select_action\",\n\t\t\t\t\t\t\t\tonclick: () => {\n\t\t\t\t\t\t\t\t\tmodel.selectedPackage = index\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\tprice: formatPrice(value, true),\n\t\t\t\t\t\thelpLabel: this.getGiftCardHelpText(model.revolutionaryPrice, value),\n\t\t\t\t\t\twidth: 230,\n\t\t\t\t\t\theight: 250,\n\t\t\t\t\t\tselectedPaymentInterval: null,\n\t\t\t\t\t\taccountPaymentInterval: null,\n\t\t\t\t\t\thighlighted: model.selectedPackage === index,\n\t\t\t\t\t\tmobile: false,\n\t\t\t\t\t\tbonusMonths: 0,\n\t\t\t\t\t})\n\t\t\t\t}),\n\t\t\t),\n\t\t\tm(\".flex-column.flex-center.center-h.width-min-content\", [\n\t\t\t\tm(GiftCardMessageEditorField, {\n\t\t\t\t\tmessage: model.message,\n\t\t\t\t\tonMessageChanged: (message) => (model.message = message),\n\t\t\t\t}),\n\t\t\t\trenderAcceptGiftCardTermsCheckbox(model.confirmed, (checked) => (model.confirmed = checked), \"pt-l\"),\n\t\t\t\tm(LoginButton, {\n\t\t\t\t\tlabel: \"buy_action\",\n\t\t\t\t\tclass: \"mt-l mb-l\",\n\t\t\t\t\tonclick: () => this.onBuyButtonPressed(model, onGiftCardPurchased).catch(ofClass(UserError, showUserError)),\n\t\t\t\t}),\n\t\t\t]),\n\t\t]\n\t}\n\n\tasync onBuyButtonPressed(model: PurchaseGiftCardModel, onPurchaseSuccess: (giftCard: GiftCard) => void) {\n\t\tconst giftCard = await showProgressDialog(\"loading_msg\", model.purchaseGiftCard())\n\t\tonPurchaseSuccess(giftCard)\n\t}\n\n\tprivate getGiftCardHelpText(upgradePrice: number, giftCardValue: number): Translation {\n\t\tlet helpTextId: TranslationKeyType\n\t\tif (giftCardValue < upgradePrice) {\n\t\t\thelpTextId = \"giftCardOptionTextC_msg\"\n\t\t} else if (giftCardValue == upgradePrice) {\n\t\t\thelpTextId = \"giftCardOptionTextD_msg\"\n\t\t} else {\n\t\t\thelpTextId = \"giftCardOptionTextE_msg\"\n\t\t}\n\t\treturn lang.getTranslation(helpTextId, {\n\t\t\t\"{remainingCredit}\": formatPrice(giftCardValue - upgradePrice, true),\n\t\t\t\"{fullCredit}\": formatPrice(giftCardValue, true),\n\t\t})\n\t}\n}\n\n/**\n * Create a dialog to buy a giftcard or show error if the user cannot do so\n * @returns {Promise<unknown>|Promise<void>|Promise<Promise<void>>}\n */\n\nexport async function showPurchaseGiftCardDialog() {\n\tif (isIOSApp()) {\n\t\treturn Dialog.message(\"notAvailableInApp_msg\")\n\t}\n\n\tconst model = await showProgressDialog(\"loading_msg\", loadGiftCardModel()).catch(\n\t\tofClass(UserError, (e) => {\n\t\t\tshowUserError(e)\n\t\t\treturn null\n\t\t}),\n\t)\n\n\tif (model == null) {\n\t\treturn\n\t}\n\n\tlet dialog: Dialog\n\n\tconst header: DialogHeaderBarAttrs = {\n\t\tleft: [\n\t\t\t{\n\t\t\t\tlabel: \"close_alt\",\n\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\tclick: () => dialog.close(),\n\t\t\t},\n\t\t],\n\t\tmiddle: \"buyGiftCard_label\",\n\t}\n\n\tconst content = {\n\t\tview: () =>\n\t\t\tm(GiftCardPurchaseView, {\n\t\t\t\tmodel,\n\t\t\t\tonGiftCardPurchased: (giftCard) => {\n\t\t\t\t\tdialog.close()\n\t\t\t\t\tshowGiftCardToShare(giftCard)\n\t\t\t\t},\n\t\t\t}),\n\t}\n\n\tdialog = Dialog.largeDialog(header, content).addShortcut({\n\t\tkey: Keys.ESC,\n\t\texec: () => dialog.close(),\n\t\thelp: \"close_alt\",\n\t})\n\n\tif (client.isMobileDevice()) {\n\t\t// Prevent focusing text field automatically on mobile. It opens keyboard and you don't see all details.\n\t\tdialog.setFocusOnLoadFunction(noOp)\n\t}\n\n\tdialog.show()\n}\n\nasync function loadGiftCardModel(): Promise<PurchaseGiftCardModel> {\n\tconst accountingInfo = await locator.logins.getUserController().loadAccountingInfo()\n\n\t// Only allow purchase with supported payment methods\n\tif (!accountingInfo || accountingInfo.paymentMethod === PaymentMethodType.Invoice || accountingInfo.paymentMethod === PaymentMethodType.AccountBalance) {\n\t\tthrow new UserError(\"invalidGiftCardPaymentMethod_msg\")\n\t}\n\n\tconst [giftCardInfo, customerInfo] = await Promise.all([\n\t\tlocator.serviceExecutor.get(GiftCardService, null),\n\t\tlocator.logins.getUserController().loadCustomerInfo(),\n\t])\n\n\t// User can't buy too many gift cards so we have to load their giftcards in order to check how many they ordered\n\tconst existingGiftCards = customerInfo.giftCards ? await locator.entityClient.loadAll(GiftCardTypeRef, customerInfo.giftCards.items) : []\n\n\tconst sixMonthsAgo = new Date()\n\tsixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - parseInt(giftCardInfo.period))\n\tconst numPurchasedGiftCards = count(existingGiftCards, (giftCard) => giftCard.orderDate > sixMonthsAgo)\n\n\tif (numPurchasedGiftCards >= parseInt(giftCardInfo.maxPerPeriod)) {\n\t\tthrow new UserError(\n\t\t\tlang.getTranslation(\"tooManyGiftCards_msg\", {\n\t\t\t\t\"{amount}\": giftCardInfo.maxPerPeriod,\n\t\t\t\t\"{period}\": `${giftCardInfo.period} months`,\n\t\t\t}),\n\t\t)\n\t}\n\n\tconst priceDataProvider = await PriceAndConfigProvider.getInitializedInstance(null, locator.serviceExecutor, null)\n\treturn new PurchaseGiftCardModel({\n\t\tpurchaseLimit: filterInt(giftCardInfo.maxPerPeriod),\n\t\tpurchasePeriodMonths: filterInt(giftCardInfo.period),\n\t\tavailablePackages: giftCardInfo.options,\n\t\tselectedPackage: Math.floor(giftCardInfo.options.length / 2),\n\t\trevolutionaryPrice: priceDataProvider.getSubscriptionPrice(PaymentInterval.Yearly, PlanType.Revolutionary, UpgradePriceType.PlanActualPrice),\n\t})\n}\n"],"mappings":"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"}