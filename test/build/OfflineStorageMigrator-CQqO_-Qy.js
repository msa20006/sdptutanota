
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { assertNotNull, typedEntries, typedKeys } from "./dist-CJHwsXKY.js";
import { ProgrammingError } from "./ProgrammingError-D8yJGVtm.js";
import { CryptoProtocolVersion, GroupType, KdfType } from "./TutanotaConstants-3bwAESYA.js";
import { OutOfSyncError } from "./OutOfSyncError-Ck2yBBO8.js";
import { GENERATED_MIN_ID, getElementId, getListId } from "./EntityUtils-RQxXZlcV.js";
import { CalendarEventTypeRef, CalendarEventUpdateTypeRef, CalendarGroupRootTypeRef, ContactListEntryTypeRef, ContactListGroupRootTypeRef, ContactListTypeRef, ContactTypeRef, EmailTemplateTypeRef, FileSystemTypeRef, FileTypeRef, KnowledgeBaseEntryTypeRef, MailBoxTypeRef, MailDetailsBlobTypeRef, MailDetailsDraftTypeRef, MailFolderTypeRef, MailTypeRef, MailboxGroupRootTypeRef, MailboxPropertiesTypeRef, TemplateGroupRootTypeRef, TutanotaPropertiesTypeRef, UserSettingsGroupRootTypeRef, createMail, createMailBox } from "./TypeRefs-CR3TLWn0.js";
import { AccountingInfoTypeRef, AuditLogEntryTypeRef, BucketPermissionTypeRef, CustomerInfoTypeRef, CustomerServerPropertiesTypeRef, CustomerTypeRef, GiftCardTypeRef, GroupInfoTypeRef, GroupKeyTypeRef, GroupTypeRef, InvoiceTypeRef, MissedNotificationTypeRef, OrderProcessingAgreementTypeRef, PushIdentifierTypeRef, ReceivedGroupInvitationTypeRef, RecoverCodeTypeRef, SentGroupInvitationTypeRef, UserAlarmInfoTypeRef, UserGroupRootTypeRef, UserTypeRef, WhitelabelChildTypeRef, createCustomerInfo } from "./TypeRefs-BP1jvX9p.js";
import { addOwnerKeyVersion, addValue, changeCardinalityFromAnyToZeroOrOne, deleteInstancesOfType, migrateAllElements, migrateAllListElements, removeValue, renameAttribute } from "./StandardMigrations-7xZlHwBq.js";

//#region ../src/common/api/worker/offline/migrations/sys-v94.ts
const sys94 = {
	app: "sys",
	version: 94,
	async migrate(storage) {
		await deleteInstancesOfType(storage, MailTypeRef);
		await deleteInstancesOfType(storage, UserTypeRef);
		await migrateAllListElements(CustomerInfoTypeRef, storage, [createCustomerInfo]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v66.ts
const tutanota66 = {
	app: "tutanota",
	version: 66,
	async migrate(storage) {
		await migrateAllListElements(MailTypeRef, storage, [createMail]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v92.ts
const sys92 = {
	app: "sys",
	version: 92,
	async migrate(storage) {
		await migrateAllListElements(BucketPermissionTypeRef, storage, [addProtocolVersion]);
		await migrateAllListElements(MailTypeRef, storage, [(e) => {
			if (e.bucketKey) addProtocolVersion(e.bucketKey);
			return e;
		}]);
		await deleteInstancesOfType(storage, GroupTypeRef);
		await deleteInstancesOfType(storage, UserTypeRef);
	}
};
function addProtocolVersion(entity) {
	if (entity.pubEncBucketKey) entity.protocolVersion = CryptoProtocolVersion.RSA;
else entity.protocolVersion = CryptoProtocolVersion.SYMMETRIC_ENCRYPTION;
	return entity;
}

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v65.ts
const tutanota65 = {
	app: "tutanota",
	version: 65,
	async migrate(storage) {
		migrateAllListElements(MailTypeRef, storage, [removeValue("restrictions")]);
		migrateAllElements(MailboxGroupRootTypeRef, storage, [
			removeValue("contactFormUserContactForm"),
			removeValue("targetMailGroupContactForm"),
			removeValue("participatingContactForms")
		]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v91.ts
const sys91 = {
	app: "sys",
	version: 91,
	async migrate(storage) {
		await migrateAllElements(CustomerTypeRef, storage, [removeValue("contactFormUserGroups"), removeValue("contactFormUserAreaGroups")]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v90.ts
const sys90 = {
	app: "sys",
	version: 90,
	async migrate(storage) {
		await migrateAllListElements(CustomerInfoTypeRef, storage, [(oldCustomerInfo) => {
			if (oldCustomerInfo.customPlan) oldCustomerInfo.customPlan.contactList = false;
			return oldCustomerInfo;
		}]);
		await migrateAllElements(UserTypeRef, storage, [(user) => {
			if (!user.kdfVersion) user.kdfVersion = KdfType.Bcrypt;
			return user;
		}]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v64.ts
const tutanota64 = {
	app: "tutanota",
	version: 64,
	async migrate(storage) {
		migrateAllListElements(FileTypeRef, storage, [removeValue("data")]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v67.ts
const tutanota67 = {
	app: "tutanota",
	version: 67,
	async migrate(storage) {
		await deleteInstancesOfType(storage, ContactTypeRef);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v96.ts
const sys96 = {
	app: "sys",
	version: 96,
	async migrate(storage) {
		const encryptedElementTypes = [
			AccountingInfoTypeRef,
			CustomerServerPropertiesTypeRef,
			InvoiceTypeRef,
			MissedNotificationTypeRef
		];
		const encryptedListElementTypes = [
			GroupInfoTypeRef,
			AuditLogEntryTypeRef,
			WhitelabelChildTypeRef,
			OrderProcessingAgreementTypeRef,
			UserAlarmInfoTypeRef,
			ReceivedGroupInvitationTypeRef,
			GiftCardTypeRef,
			PushIdentifierTypeRef
		];
		for (const type of encryptedElementTypes) await migrateAllElements(type, storage, [addOwnerKeyVersion()]);
		for (const type of encryptedListElementTypes) await migrateAllListElements(type, storage, [addOwnerKeyVersion()]);
		await migrateAllElements(GroupTypeRef, storage, [
			renameAttribute("keys", "currentKeys"),
			changeCardinalityFromAnyToZeroOrOne("currentKeys"),
			removeKeyPairVersion(),
			addValue("formerGroupKeys", null),
			addValue("pubAdminGroupEncGKey", null),
			addValue("groupKeyVersion", "0"),
			addAdminGroupKeyVersion()
		]);
		await migrateAllElements(UserTypeRef, storage, [addVersionsToGroupMemberships(), removeValue("userEncClientKey")]);
		await migrateAllListElements(ReceivedGroupInvitationTypeRef, storage, [addValue("sharedGroupKeyVersion", "0")]);
		await migrateAllElements(RecoverCodeTypeRef, storage, [addValue("userKeyVersion", "0")]);
		await migrateAllElements(UserGroupRootTypeRef, storage, [addValue("keyRotations", null)]);
	}
};
function addVersionsToGroupMemberships() {
	return function(entity) {
		const userGroupMembership = entity["userGroup"];
		userGroupMembership["groupKeyVersion"] = "0";
		userGroupMembership["symKeyVersion"] = "0";
		for (const membership of entity["memberships"]) {
			membership["groupKeyVersion"] = "0";
			membership["symKeyVersion"] = "0";
		}
		return entity;
	};
}
function addAdminGroupKeyVersion() {
	return function(entity) {
		entity["adminGroupKeyVersion"] = entity["adminGroupEncGKey"] == null ? null : "0";
		return entity;
	};
}
function removeKeyPairVersion() {
	return function(entity) {
		const currentKeys = entity["currentKeys"];
		if (currentKeys) delete currentKeys["version"];
		return entity;
	};
}

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v69.ts
const tutanota69 = {
	app: "tutanota",
	version: 69,
	async migrate(storage) {
		const encryptedElementTypes = [
			FileSystemTypeRef,
			MailBoxTypeRef,
			ContactListTypeRef,
			TutanotaPropertiesTypeRef,
			CalendarGroupRootTypeRef,
			UserSettingsGroupRootTypeRef,
			ContactListGroupRootTypeRef,
			MailboxPropertiesTypeRef,
			TemplateGroupRootTypeRef
		];
		const encryptedListElementTypes = [
			FileTypeRef,
			ContactTypeRef,
			MailTypeRef,
			MailFolderTypeRef,
			CalendarEventTypeRef,
			CalendarEventUpdateTypeRef,
			EmailTemplateTypeRef,
			MailDetailsDraftTypeRef,
			MailDetailsBlobTypeRef,
			ContactListEntryTypeRef,
			KnowledgeBaseEntryTypeRef
		];
		for (const type of encryptedElementTypes) await migrateAllElements(type, storage, [addOwnerKeyVersion()]);
		for (const type of encryptedListElementTypes) await migrateAllListElements(type, storage, [addOwnerKeyVersion()]);
		await migrateAllListElements(MailTypeRef, storage, [addVersionsToBucketKey()]);
		await migrateAllElements(TutanotaPropertiesTypeRef, storage, [renameAttribute("groupEncEntropy", "userEncEntropy"), addValue("userKeyVersion", null)]);
		await migrateAllElements(MailBoxTypeRef, storage, [removeValue("symEncShareBucketKey")]);
	}
};
function addVersionsToBucketKey() {
	return function(entity) {
		const bucketKey = entity["bucketKey"];
		if (bucketKey != null) {
			bucketKey["recipientKeyVersion"] = "0";
			bucketKey["senderKeyVersion"] = bucketKey["protocolVersion"] === CryptoProtocolVersion.TUTA_CRYPT ? "0" : null;
			for (const instanceSessionKey of bucketKey["bucketEncSessionKeys"]) instanceSessionKey["symKeyVersion"] = "0";
		}
		return entity;
	};
}

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v97.ts
const sys97 = {
	app: "sys",
	version: 97,
	async migrate(storage) {
		await migrateAllElements(CustomerTypeRef, storage, [removeValue("canceledPremiumAccount")]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v71.ts
const tutanota71 = {
	app: "tutanota",
	version: 71,
	async migrate(storage) {
		await deleteInstancesOfType(storage, UserGroupRootTypeRef);
		await deleteInstancesOfType(storage, ReceivedGroupInvitationTypeRef);
		await deleteInstancesOfType(storage, SentGroupInvitationTypeRef);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v99.ts
const sys99 = {
	app: "sys",
	version: 99,
	async migrate(storage) {}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v101.ts
const sys101 = {
	app: "sys",
	version: 101,
	async migrate(storage, sqlCipherFacade) {}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v102.ts
const sys102 = {
	app: "sys",
	version: 102,
	async migrate(storage, sqlCipherFacade) {
		await deleteInstancesOfType(storage, UserGroupRootTypeRef);
		await deleteInstancesOfType(storage, GroupTypeRef);
		await deleteInstancesOfType(storage, UserTypeRef);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v72.ts
const tutanota72 = {
	app: "tutanota",
	version: 72,
	async migrate(storage) {}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v103.ts
const sys103 = {
	app: "sys",
	version: 103,
	async migrate(storage, sqlCipherFacade) {
		await deleteInstancesOfType(storage, AccountingInfoTypeRef);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v73.ts
const tutanota73 = {
	app: "tutanota",
	version: 73,
	async migrate(storage) {
		await migrateAllListElements(MailTypeRef, storage, [
			removeValue("body"),
			removeValue("toRecipients"),
			removeValue("ccRecipients"),
			removeValue("bccRecipients"),
			removeValue("replyTos"),
			removeValue("headers"),
			removeValue("sentDate")
		]);
		await migrateAllElements(MailBoxTypeRef, storage, [removeValue("mails")]);
		await migrateAllListElements(MailFolderTypeRef, storage, [removeValue("subFolders")]);
		await migrateAllListElements(FileTypeRef, storage, [removeValue("_owner"), removeValue("_area")]);
		await migrateAllListElements(ContactTypeRef, storage, [
			removeValue("_owner"),
			removeValue("_area"),
			removeValue("autoTransmitPassword")
		]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v104.ts
const sys104 = {
	app: "sys",
	version: 104,
	async migrate(storage, _) {
		await migrateAllElements(UserTypeRef, storage, [removeValue("phoneNumbers")]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v105.ts
const sys105 = {
	app: "sys",
	version: 105,
	async migrate(storage, _) {
		await deleteInstancesOfType(storage, PushIdentifierTypeRef);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v106.ts
const sys106 = {
	app: "sys",
	version: 106,
	async migrate(storage) {}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v74.ts
const tutanota74 = {
	app: "tutanota",
	version: 74,
	async migrate(storage) {
		await migrateAllListElements(MailFolderTypeRef, storage, [
			addValue("isLabel", false),
			addValue("isMailSet", false),
			addValue("entries", GENERATED_MIN_ID)
		]);
		await migrateAllElements(MailBoxTypeRef, storage, [createMailBox]);
		await migrateAllListElements(MailTypeRef, storage, [createMail]);
		await deleteInstancesOfType(storage, CalendarEventTypeRef);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v107.ts
const sys107 = {
	app: "sys",
	version: 107,
	async migrate(storage) {}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v75.ts
const tutanota75 = {
	app: "tutanota",
	version: 75,
	async migrate(storage) {
		await deleteInstancesOfType(storage, UserSettingsGroupRootTypeRef);
		const groupInfos = await storage.getRawListElementsOfType(GroupInfoTypeRef);
		for (const groupInfo of groupInfos) {
			if (groupInfo.groupType !== GroupType.User) continue;
			await storage.deleteIfExists(GroupInfoTypeRef, getListId(groupInfo), getElementId(groupInfo));
		}
		await deleteInstancesOfType(storage, AuditLogEntryTypeRef);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v111.ts
const sys111 = {
	app: "sys",
	version: 111,
	async migrate(storage) {
		await migrateAllElements(GroupTypeRef, storage, [removeValue("pubAdminGroupEncGKey"), addValue("pubAdminGroupEncGKey", null)]);
		await migrateAllListElements(GroupKeyTypeRef, storage, [removeValue("pubAdminGroupEncGKey"), addValue("pubAdminGroupEncGKey", null)]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v76.ts
const tutanota76 = {
	app: "tutanota",
	version: 76,
	async migrate(storage) {
		await migrateAllElements(MailboxGroupRootTypeRef, storage, [removeValue("whitelistRequests")]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v112.ts
const sys112 = {
	app: "sys",
	version: 112,
	async migrate(storage) {
		await migrateAllElements(MailboxGroupRootTypeRef, storage, [removeValue("whitelistedDomains")]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v77.ts
const tutanota77 = {
	app: "tutanota",
	version: 77,
	async migrate(storage) {
		await migrateAllListElements(MailFolderTypeRef, storage, [removeValue("isLabel"), addValue("color", null)]);
		await deleteInstancesOfType(storage, TutanotaPropertiesTypeRef);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v114.ts
const sys114 = {
	app: "sys",
	version: 114,
	async migrate(storage) {
		await migrateAllListElements(CustomerInfoTypeRef, storage, [addUnlimitedLabelsToPlanConfiguration()]);
	}
};
function addUnlimitedLabelsToPlanConfiguration() {
	return function addUnlimitedLabelsToPlanConfigurationMigration(entity) {
		if (entity.customPlan != null) entity.customPlan.unlimitedLabels = false;
		return entity;
	};
}

//#endregion
//#region ../src/common/api/worker/offline/migrations/offline2.ts
const offline2 = {
	app: "offline",
	version: 2,
	async migrate(storage, _) {
		await migrateAllElements(TutanotaPropertiesTypeRef, storage, [addValue("defaultLabelCreated", false)]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v115.ts
const sys115 = {
	app: "sys",
	version: 115,
	async migrate(storage) {}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v78.ts
const tutanota78 = {
	app: "tutanota",
	version: 78,
	async migrate(storage) {}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v116.ts
const sys116 = {
	app: "sys",
	version: 116,
	async migrate(storage) {}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v79.ts
const tutanota79 = {
	app: "tutanota",
	version: 79,
	async migrate(storage) {
		await migrateAllElements(MailBoxTypeRef, storage, [addValue("importedAttachments", GENERATED_MIN_ID), addValue("mailImportStates", GENERATED_MIN_ID)]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/offline3.ts
const offline3 = {
	app: "offline",
	version: 3,
	async migrate(storage, _) {
		let mailboxes = await storage.getElementsOfType(MailBoxTypeRef);
		let needsOfflineDisable = false;
		for (const mailbox of mailboxes) {
			if (mailbox.importedAttachments !== GENERATED_MIN_ID && mailbox.mailImportStates !== GENERATED_MIN_ID) continue;
			await storage.deleteIfExists(MailBoxTypeRef, null, mailbox._id);
			needsOfflineDisable = true;
		}
		if (needsOfflineDisable) {
			await deleteInstancesOfType(storage, UserSettingsGroupRootTypeRef);
			const groupInfos = await storage.getRawListElementsOfType(GroupInfoTypeRef);
			for (const groupInfo of groupInfos) {
				if (groupInfo.groupType !== GroupType.User) continue;
				await storage.deleteIfExists(GroupInfoTypeRef, getListId(groupInfo), getElementId(groupInfo));
			}
		}
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/sys-v118.ts
const sys118 = {
	app: "sys",
	version: 118,
	async migrate(storage) {
		await migrateAllListElements(CalendarEventTypeRef, storage, [(calendarEvent) => {
			if (calendarEvent.repeatRule) calendarEvent.repeatRule.advancedRules = [];
			return calendarEvent;
		}]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/tutanota-v80.ts
const tutanota80 = {
	app: "tutanota",
	version: 80,
	async migrate(storage) {
		await migrateAllListElements(CalendarEventTypeRef, storage, [(calendarEvent) => {
			if (calendarEvent.repeatRule) calendarEvent.repeatRule.advancedRules = [];
			return calendarEvent;
		}]);
	}
};

//#endregion
//#region ../src/common/api/worker/offline/migrations/storage-v11.ts
const storage11 = {
	app: "storage",
	version: 11,
	async migrate(storage) {}
};

//#endregion
//#region ../src/common/api/worker/offline/OfflineStorageMigrator.ts
const OFFLINE_STORAGE_MIGRATIONS = [
	sys90,
	tutanota64,
	sys91,
	tutanota65,
	sys92,
	tutanota66,
	sys94,
	tutanota67,
	sys96,
	tutanota69,
	sys97,
	tutanota71,
	sys99,
	sys101,
	sys102,
	tutanota72,
	sys103,
	tutanota73,
	sys104,
	sys105,
	sys106,
	tutanota74,
	tutanota75,
	sys107,
	tutanota75,
	sys111,
	tutanota76,
	sys112,
	tutanota77,
	sys114,
	offline2,
	sys115,
	tutanota78,
	sys116,
	tutanota79,
	offline3,
	sys118,
	tutanota80,
	storage11
];
const CURRENT_OFFLINE_VERSION = 3;
var OfflineStorageMigrator = class {
	constructor(migrations, modelInfos) {
		this.migrations = migrations;
		this.modelInfos = modelInfos;
	}
	async migrate(storage, sqlCipherFacade) {
		const meta = await storage.dumpMetadata();
		if (Object.keys(meta).length === 1 && meta.lastUpdateTime != null) throw new OutOfSyncError("Invalid DB state, missing model versions");
		const populatedMeta = await this.populateModelVersions(meta, storage);
		if (this.isDbNewerThanCurrentClient(populatedMeta)) throw new OutOfSyncError(`offline database has newer schema than client`);
		await this.runMigrations(meta, storage, sqlCipherFacade);
		await this.checkStateAfterMigrations(storage);
	}
	async checkStateAfterMigrations(storage) {
		const meta = await storage.dumpMetadata();
		for (const app of typedKeys(this.modelInfos)) {
			const compatibleSince = this.modelInfos[app].compatibleSince;
			let metaVersion = meta[`${app}-version`];
			if (metaVersion < compatibleSince) throw new ProgrammingError(`You forgot to migrate your databases! ${app}.version should be >= ${this.modelInfos[app].compatibleSince} but in db it is ${metaVersion}`);
		}
	}
	async runMigrations(meta, storage, sqlCipherFacade) {
		for (const { app, version, migrate } of this.migrations) {
			const storedVersion = meta[`${app}-version`];
			if (storedVersion < version) {
				console.log(`running offline db migration for ${app} from ${storedVersion} to ${version}`);
				await migrate(storage, sqlCipherFacade);
				console.log("migration finished");
				await storage.setStoredModelVersion(app, version);
			}
		}
	}
	async populateModelVersions(meta, storage) {
		const newMeta = { ...meta };
		for (const app of typedKeys(this.modelInfos)) await this.prepopulateVersionIfAbsent(app, this.modelInfos[app].version, newMeta, storage);
		await this.prepopulateVersionIfAbsent("offline", CURRENT_OFFLINE_VERSION, newMeta, storage);
		return newMeta;
	}
	/**
	* update the metadata table to initialize the row of the app with the given model version
	*
	* NB: mutates meta
	*/
	async prepopulateVersionIfAbsent(app, version, meta, storage) {
		const key = `${app}-version`;
		const storedVersion = meta[key];
		if (storedVersion == null) {
			meta[key] = version;
			await storage.setStoredModelVersion(app, version);
		}
	}
	/**
	* it's possible that the user installed an older client over a newer one, and we don't have backwards migrations.
	* in that case, it's likely that the client can't even understand the contents of the db.
	* we're going to delete it and not migrate at all.
	* @private
	*
	* @returns true if the database we're supposed to migrate has any higher model versions than our highest migration for that model, false otherwise
	*/
	isDbNewerThanCurrentClient(meta) {
		for (const [app, { version }] of typedEntries(this.modelInfos)) {
			const storedVersion = meta[`${app}-version`];
			if (storedVersion > version) return true;
		}
		return assertNotNull(meta[`offline-version`]) > CURRENT_OFFLINE_VERSION;
	}
};

//#endregion
export { OFFLINE_STORAGE_MIGRATIONS, OfflineStorageMigrator };
//# sourceMappingURL=OfflineStorageMigrator-CQqO_-Qy.js.map