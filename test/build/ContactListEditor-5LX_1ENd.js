
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { mithril_default } from "./mithril-Csg4iNnm.js";
import { NBSP, assertNotNull, downcast, memoized, neverNull, noOp, stringToUtf8Uint8Array } from "./dist-CJHwsXKY.js";
import { assertMainOrNode } from "./Env-D5xGlXfw.js";
import { lang } from "./LanguageViewModel-BNC5ekpO.js";
import { px, size, styles, theme } from "./HtmlUtils-C-ecR7U7.js";
import { ContactAddressType, ContactComparisonResult, ContactPhoneNumberType, IndifferentContactComparisonResult, Keys, getContactSocialType, getCustomDateType, getRelationshipType } from "./TutanotaConstants-3bwAESYA.js";
import { BaseButton, ButtonType } from "./Icon-BuqNK7vz.js";
import { Icons } from "./Icons-Dl3nFav5.js";
import { Dialog, TextField, TextFieldType, attachDropdown, getContactTitle } from "./Dialog-B6-HFvZd.js";
import { ButtonSize, IconButton } from "./IconButton-DsU60HJ_.js";
import { isSameId } from "./EntityUtils-RQxXZlcV.js";
import { cleanMailAddress } from "./CommonCalendarUtils-DKaO7v1K.js";
import { createFile } from "./TypeRefs-CR3TLWn0.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import { isMailAddress } from "./FormatValidator-2BBermUe.js";
import { convertToDataFile } from "./DataFile-CY7uuk9j.js";
import { isoDateToBirthday } from "./BirthdayUtils-BcCMglSq.js";
import { formatContactDate, getMessengerHandleUrl, getSocialUrl, getWebsiteUrl } from "./ContactUtils-Bbon2oOk.js";
import { MailRecipientsTextField } from "./MailRecipientsTextField-BmI2qlpf.js";
import { getContactAddressTypeLabel, getContactCustomDateTypeToLabel, getContactCustomWebsiteTypeToLabel, getContactMessengerHandleTypeToLabel, getContactPhoneNumberTypeLabel, getContactRelationshipTypeToLabel, getContactSocialTypeLabel } from "./ContactGuiUtils-BOj2qfyh.js";

//#region ../src/mail-app/contacts/ContactMergeUtils.ts
function getMergeableContacts(inputContacts) {
	let mergableContacts = [];
	let duplicateContacts = [];
	let contacts = inputContacts.slice();
	let firstContactIndex = 0;
	while (firstContactIndex < contacts.length - 1) {
		let currentMergableContacts = [];
		let firstContact = contacts[firstContactIndex];
		currentMergableContacts.push(firstContact);
		let secondContactIndex = firstContactIndex + 1;
		while (secondContactIndex < contacts.length) {
			let secondContact = contacts[secondContactIndex];
			if (firstContact._id[1] !== secondContact._id[1]) {
				let overallResult = ContactComparisonResult.Unique;
				for (let i = 0; i < currentMergableContacts.length; i++) {
					let result = _compareContactsForMerge(currentMergableContacts[i], secondContact);
					if (result === ContactComparisonResult.Equal) {
						overallResult = ContactComparisonResult.Equal;
						break;
					} else if (result === ContactComparisonResult.Similar) overallResult = ContactComparisonResult.Similar;
else break;
				}
				if (overallResult === ContactComparisonResult.Equal) {
					duplicateContacts.push(secondContact);
					contacts.splice(secondContactIndex, 1);
				} else if (overallResult === ContactComparisonResult.Similar) {
					currentMergableContacts.push(secondContact);
					contacts.splice(secondContactIndex, 1);
				} else secondContactIndex++;
			}
		}
		if (currentMergableContacts.length > 1) mergableContacts.push(currentMergableContacts);
		firstContactIndex++;
	}
	return {
		mergeable: mergableContacts,
		deletable: duplicateContacts
	};
}
function mergeContacts(keptContact, eliminatedContact) {
	keptContact.firstName = _getMergedNameField(keptContact.firstName, eliminatedContact.firstName);
	keptContact.lastName = _getMergedNameField(keptContact.lastName, eliminatedContact.lastName);
	keptContact.title = neverNull(_getMergedOtherField(keptContact.title, eliminatedContact.title, ", "));
	keptContact.comment = neverNull(_getMergedOtherField(keptContact.comment, eliminatedContact.comment, "\n\n"));
	keptContact.company = neverNull(_getMergedOtherField(keptContact.company, eliminatedContact.company, ", "));
	keptContact.nickname = _getMergedOtherField(keptContact.nickname, eliminatedContact.nickname, ", ");
	keptContact.role = neverNull(_getMergedOtherField(keptContact.role, eliminatedContact.role, ", "));
	keptContact.birthdayIso = _getMergedBirthdays(keptContact.birthdayIso, eliminatedContact.birthdayIso);
	keptContact.mailAddresses = _getMergedEmailAddresses(keptContact.mailAddresses, eliminatedContact.mailAddresses);
	keptContact.phoneNumbers = _getMergedPhoneNumbers(keptContact.phoneNumbers, eliminatedContact.phoneNumbers);
	keptContact.socialIds = _getMergedSocialIds(keptContact.socialIds, eliminatedContact.socialIds);
	keptContact.addresses = _getMergedAddresses(keptContact.addresses, eliminatedContact.addresses);
	keptContact.presharedPassword = neverNull(_getMergedOtherField(keptContact.presharedPassword, eliminatedContact.presharedPassword, ""));
}
function _compareContactsForMerge(contact1, contact2) {
	let nameResult = _compareFullName(contact1, contact2);
	let mailResult = _compareMailAddresses(contact1.mailAddresses, contact2.mailAddresses);
	let phoneResult = _comparePhoneNumbers(contact1.phoneNumbers, contact2.phoneNumbers);
	let birthdayResult = _compareBirthdays(contact1, contact2);
	let residualContactFieldsEqual = _areResidualContactFieldsEqual(contact1, contact2);
	if (birthdayResult !== ContactComparisonResult.Unique && (!contact1.presharedPassword || !contact2.presharedPassword || contact1.presharedPassword === contact2.presharedPassword)) if ((nameResult === ContactComparisonResult.Equal || nameResult === IndifferentContactComparisonResult.BothEmpty) && (mailResult === ContactComparisonResult.Equal || mailResult === IndifferentContactComparisonResult.BothEmpty) && (phoneResult === ContactComparisonResult.Equal || phoneResult === IndifferentContactComparisonResult.BothEmpty) && residualContactFieldsEqual) if (birthdayResult === IndifferentContactComparisonResult.BothEmpty || birthdayResult === ContactComparisonResult.Equal) return ContactComparisonResult.Equal;
else return ContactComparisonResult.Similar;
else if (nameResult === ContactComparisonResult.Equal || nameResult === ContactComparisonResult.Similar) return ContactComparisonResult.Similar;
else if ((nameResult === IndifferentContactComparisonResult.BothEmpty || nameResult === IndifferentContactComparisonResult.OneEmpty) && (mailResult === ContactComparisonResult.Similar || phoneResult === ContactComparisonResult.Similar || mailResult === ContactComparisonResult.Equal || phoneResult === ContactComparisonResult.Equal)) return ContactComparisonResult.Similar;
else return ContactComparisonResult.Unique;
else return ContactComparisonResult.Unique;
}
function _compareFullName(contact1, contact2) {
	if (contact1.firstName === contact2.firstName && contact1.lastName === contact2.lastName && (contact1.lastName || contact1.firstName)) return ContactComparisonResult.Equal;
else if (!contact1.firstName && !contact1.lastName && !contact2.firstName && !contact2.lastName) return IndifferentContactComparisonResult.BothEmpty;
else if (!contact1.firstName && !contact1.lastName || !contact2.firstName && !contact2.lastName) return IndifferentContactComparisonResult.OneEmpty;
else if (contact1.firstName.toLowerCase() === contact2.firstName.toLowerCase() && contact1.lastName.toLowerCase() === contact2.lastName.toLowerCase() && contact1.lastName) return ContactComparisonResult.Similar;
else if ((!contact1.firstName || !contact2.firstName) && contact1.lastName.toLowerCase() === contact2.lastName.toLowerCase() && contact1.lastName) return ContactComparisonResult.Similar;
else return ContactComparisonResult.Unique;
}
function _getMergedNameField(name1, name2) {
	if (name1) return name1;
else return name2;
}
function _compareMailAddresses(contact1MailAddresses, contact2MailAddresses) {
	return _compareValues(contact1MailAddresses.map((m) => m.address), contact2MailAddresses.map((m) => m.address));
}
function _getMergedEmailAddresses(mailAddresses1, mailAddresses2) {
	let filteredMailAddresses2 = mailAddresses2.filter((ma2) => {
		return !mailAddresses1.some((ma1) => ma1.address.toLowerCase() === ma2.address.toLowerCase());
	});
	return mailAddresses1.concat(filteredMailAddresses2);
}
function _comparePhoneNumbers(contact1PhoneNumbers, contact2PhoneNumbers) {
	return _compareValues(contact1PhoneNumbers.map((m) => m.number), contact2PhoneNumbers.map((m) => m.number));
}
function _getMergedPhoneNumbers(phoneNumbers1, phoneNumbers2) {
	let filteredNumbers2 = phoneNumbers2.filter((ma2) => {
		const isIncludedInPhoneNumbers1 = phoneNumbers1.find((ma1) => ma1.number.replace(/\s/g, "") === ma2.number.replace(/\s/g, ""));
		return !isIncludedInPhoneNumbers1;
	});
	return phoneNumbers1.concat(filteredNumbers2);
}
function _areResidualContactFieldsEqual(contact1, contact2) {
	return _isEqualOtherField(contact1.comment, contact2.comment) && _isEqualOtherField(contact1.company, contact2.company) && _isEqualOtherField(contact1.nickname, contact2.nickname) && _isEqualOtherField(contact1.role, contact2.role) && _isEqualOtherField(contact1.title, contact2.title) && _isEqualOtherField(contact1.presharedPassword, contact2.presharedPassword) && _areSocialIdsEqual(contact1.socialIds, contact2.socialIds) && _areAddressesEqual(contact1.addresses, contact2.addresses);
}
function _areSocialIdsEqual(contact1SocialIds, contact2SocialIds) {
	let result = _compareValues(contact1SocialIds.map((m) => m.socialId), contact2SocialIds.map((m) => m.socialId));
	return result === IndifferentContactComparisonResult.BothEmpty || result === ContactComparisonResult.Equal;
}
function _getMergedSocialIds(socialIds1, socialIds2) {
	let filteredSocialIds2 = socialIds2.filter((ma2) => {
		return !socialIds1.some((ma1) => ma1.socialId === ma2.socialId);
	});
	return socialIds1.concat(filteredSocialIds2);
}
function _areAddressesEqual(contact1Addresses, contact2Addresses) {
	let result = _compareValues(contact1Addresses.map((m) => m.address), contact2Addresses.map((m) => m.address));
	return result === IndifferentContactComparisonResult.BothEmpty || result === ContactComparisonResult.Equal;
}
function _getMergedAddresses(addresses1, addresses2) {
	let filteredAddresses2 = addresses2.filter((ma2) => {
		return !addresses1.some((ma1) => ma1.address === ma2.address);
	});
	return addresses1.concat(filteredAddresses2);
}
function _compareBirthdays(contact1, contact2) {
	const b1 = _convertIsoBirthday(contact1.birthdayIso);
	const b2 = _convertIsoBirthday(contact2.birthdayIso);
	if (b1 && b2) if (b1.day === b2.day && b1.month === b2.month) if (b1.year === b2.year) return ContactComparisonResult.Equal;
else if (b1.year && b2.year && b1.year !== b2.year) return ContactComparisonResult.Unique;
else return ContactComparisonResult.Similar;
else return ContactComparisonResult.Unique;
else if (contact1.birthdayIso && !contact2.birthdayIso || !contact1.birthdayIso && contact2.birthdayIso) return IndifferentContactComparisonResult.OneEmpty;
else return IndifferentContactComparisonResult.BothEmpty;
}
function _convertIsoBirthday(isoBirthday) {
	if (isoBirthday) try {
		return isoDateToBirthday(isoBirthday);
	} catch (e) {
		console.log("failed to parse birthday", e);
		return null;
	}
else return null;
}
function _compareValues(values1, values2) {
	if (values1.length === 0 && values2.length === 0) return IndifferentContactComparisonResult.BothEmpty;
else if (values1.length === 0 || values2.length === 0) return IndifferentContactComparisonResult.OneEmpty;
	let equalAddresses = values2.filter((c2) => values1.find((c1) => c1.trim() === c2.trim()));
	if (values1.length === values2.length && values1.length === equalAddresses.length) return ContactComparisonResult.Equal;
	let equalAddressesInsensitive = values2.filter((c2) => values1.find((c1) => c1.trim().toLowerCase() === c2.trim().toLowerCase()));
	if (equalAddressesInsensitive.length > 0) return ContactComparisonResult.Similar;
	return ContactComparisonResult.Unique;
}
/**
* Returns equal if both values are equal and unique otherwise
*/
function _isEqualOtherField(otherAttribute1, otherAttribute2) {
	if (otherAttribute1 == null) otherAttribute1 = "";
	if (otherAttribute2 == null) otherAttribute2 = "";
	return otherAttribute1 === otherAttribute2;
}
function _getMergedOtherField(otherAttribute1, otherAttribute2, separator) {
	if (otherAttribute1 === otherAttribute2) return otherAttribute2;
else if (otherAttribute1 && otherAttribute2) return otherAttribute1 + separator + otherAttribute2;
else if (!otherAttribute1 && otherAttribute2) return otherAttribute2;
else return otherAttribute1;
}
function _getMergedBirthdays(birthday1, birthday2) {
	const b1 = _convertIsoBirthday(birthday1);
	const b2 = _convertIsoBirthday(birthday2);
	if (b1 && b2) if (b1.year) return birthday1;
else if (b2.year) return birthday2;
else return birthday1;
else if (birthday1) return birthday1;
else if (birthday2) return birthday2;
else return null;
}

//#endregion
//#region ../src/mail-app/contacts/VCardExporter.ts
assertMainOrNode();
function exportContacts(contacts) {
	let vCardFile = contactsToVCard(contacts);
	let data = stringToUtf8Uint8Array(vCardFile);
	let tmpFile = createFile({
		name: "vCard3.0.vcf",
		mimeType: "vCard/rfc2426",
		size: String(data.byteLength),
		blobs: [],
		cid: null,
		parent: null,
		subFiles: null
	});
	return locator.fileController.saveDataFile(convertToDataFile(tmpFile, data));
}
function contactsToVCard(contacts) {
	let vCardFile = "";
	for (const contact of contacts) vCardFile += _contactToVCard(contact);
	return vCardFile;
}
function _contactToVCard(contact) {
	let contactToVCardString = "BEGIN:VCARD\nVERSION:3.0\n";
	let fnString = "FN:";
	fnString += contact.title ? _getVCardEscaped(contact.title) + " " : "";
	fnString += contact.firstName ? _getVCardEscaped(contact.firstName) + " " : "";
	fnString += contact.middleName ? _getVCardEscaped(contact.middleName) + " " : "";
	fnString += contact.lastName ? _getVCardEscaped(contact.lastName) : "";
	fnString += contact.nameSuffix ? ", " + _getVCardEscaped(contact.nameSuffix) : "";
	contactToVCardString += _getFoldedString(fnString.trim()) + "\n";
	let nString = "N:";
	nString += contact.lastName ? _getVCardEscaped(contact.lastName) + ";" : ";";
	nString += contact.firstName ? _getVCardEscaped(contact.firstName) + ";" : ";";
	nString += contact.middleName ? _getVCardEscaped(contact.middleName) + ";" : ";";
	nString += contact.title ? _getVCardEscaped(contact.title) + ";" : ";";
	nString += contact.nameSuffix ? _getVCardEscaped(contact.nameSuffix) + "" : "";
	contactToVCardString += _getFoldedString(nString) + "\n";
	contactToVCardString += contact.nickname ? _getFoldedString("NICKNAME:" + _getVCardEscaped(contact.nickname)) + "\n" : "";
	if (contact.birthdayIso) {
		const bday = contact.birthdayIso;
		const bdayExported = bday.startsWith("--") ? bday.replace("--", "1111-") : bday;
		contactToVCardString += "BDAY:" + bdayExported + "\n";
	}
	contactToVCardString += _vCardFormatArrayToString(_addressesToVCardAddresses(contact.addresses), "ADR");
	contactToVCardString += _vCardFormatArrayToString(_addressesToVCardAddresses(contact.mailAddresses), "EMAIL");
	contactToVCardString += _vCardFormatArrayToString(_phoneNumbersToVCardPhoneNumbers(contact.phoneNumbers), "TEL");
	contactToVCardString += _vCardFormatArrayToString(_socialIdsToVCardSocialUrls(contact.socialIds), "URL");
	contactToVCardString += contact.role != "" ? _getFoldedString("TITLE:" + _getVCardEscaped(contact.role)) + "\n" : "";
	contact.websites.map((website) => {
		contactToVCardString += _getFoldedString("URL:" + getWebsiteUrl(website.url) + "\n");
	});
	const company = contact.company ? _getFoldedString("ORG:" + _getVCardEscaped(contact.company)) : "";
	if (contact.department) contactToVCardString += company + ";" + _getVCardEscaped(contact.department) + "\n";
else contactToVCardString += contact.company ? _getFoldedString("ORG:" + _getVCardEscaped(contact.company)) + "\n" : "";
	contactToVCardString += contact.comment ? _getFoldedString("NOTE:" + _getVCardEscaped(contact.comment)) + "\n" : "";
	contactToVCardString += "END:VCARD\n\n";
	return contactToVCardString;
}
function _addressesToVCardAddresses(addresses) {
	return addresses.map((ad) => {
		let kind = "";
		switch (ad.type) {
			case ContactAddressType.PRIVATE:
				kind = "home";
				break;
			case ContactAddressType.WORK:
				kind = "work";
				break;
			default:
		}
		return {
			KIND: kind,
			CONTENT: ad.address
		};
	});
}
function _phoneNumbersToVCardPhoneNumbers(numbers) {
	return numbers.map((num) => {
		let kind = "";
		switch (num.type) {
			case ContactPhoneNumberType.PRIVATE:
				kind = "home";
				break;
			case ContactPhoneNumberType.WORK:
				kind = "work";
				break;
			case ContactPhoneNumberType.MOBILE:
				kind = "cell";
				break;
			case ContactPhoneNumberType.FAX:
				kind = "fax";
				break;
			default:
		}
		return {
			KIND: kind,
			CONTENT: num.number
		};
	});
}
function _socialIdsToVCardSocialUrls(socialIds) {
	return socialIds.map((sId) => {
		return {
			KIND: "",
			CONTENT: getSocialUrl(sId)
		};
	});
}
function _vCardFormatArrayToString(typeAndContentArray, tagContent) {
	return typeAndContentArray.reduce((result, elem) => {
		if (elem.KIND) return result + _getFoldedString(tagContent + ";TYPE=" + elem.KIND + ":" + _getVCardEscaped(elem.CONTENT)) + "\n";
else return result + _getFoldedString(tagContent + ":" + _getVCardEscaped(elem.CONTENT)) + "\n";
	}, "");
}
/**
* Adds line breaks and padding in a CONTENT line to adhere to the vCard
* specifications.
*
* @param text The text to fold.
* @returns The same text but folded every 75 characters.
* @see https://datatracker.ietf.org/doc/html/rfc6350#section-3.2
*/
function _getFoldedString(text) {
	let separateLinesArray = [];
	while (text.length > 75) {
		separateLinesArray.push(text.substring(0, 75));
		text = text.substring(75, text.length);
	}
	separateLinesArray.push(text);
	text = separateLinesArray.join("\n ");
	return text;
}
function _getVCardEscaped(content) {
	content = content.replace(/\n/g, "\\n");
	content = content.replace(/;/g, "\\;");
	content = content.replace(/,/g, "\\,");
	return content;
}

//#endregion
//#region ../src/common/gui/MainCreateButton.ts
var MainCreateButton = class {
	view(vnode) {
		return mithril_default(BaseButton, {
			label: vnode.attrs.label,
			text: lang.get(vnode.attrs.label),
			onclick: vnode.attrs.click,
			class: `full-width border-radius-big center b flash ${vnode.attrs.class}`,
			style: {
				border: `2px solid ${theme.content_accent}`,
				height: px(size.button_height + size.vpad_xs * 2),
				color: theme.content_accent
			}
		});
	}
};

//#endregion
//#region ../src/mail-app/contacts/view/ContactViewer.ts
assertMainOrNode();
var ContactViewer = class {
	contactAppellation = memoized(getContactTitle);
	contactPhoneticName = memoized((contact) => {
		const firstName = contact.phoneticFirst ?? "";
		const middleName = contact.phoneticMiddle ? ` ${contact.phoneticMiddle}` : "";
		const lastName = contact.phoneticLast ? ` ${contact.phoneticLast}` : "";
		const phoneticName = (firstName + middleName + lastName).trim();
		return phoneticName.length > 0 ? phoneticName : null;
	});
	formattedBirthday = memoized((contact) => {
		return this.hasBirthday(contact) ? formatContactDate(contact.birthdayIso) : null;
	});
	hasBirthday(contact) {
		return contact.birthdayIso != null;
	}
	view({ attrs }) {
		const { contact, onWriteMail } = attrs;
		const phoneticName = this.contactPhoneticName(attrs.contact);
		return mithril_default(".plr-l.pb-floating.mlr-safe-inset", [
			mithril_default("", [mithril_default(".flex-space-between.flex-wrap.mt-m", mithril_default(".left.flex-grow-shrink-150", [
				mithril_default(".h2.selectable.text-break", [this.contactAppellation(contact), NBSP]),
				phoneticName ? mithril_default("", phoneticName) : null,
				contact.pronouns.length > 0 ? this.renderPronounsInfo(contact) : null,
				contact.nickname ? mithril_default("", `"${contact.nickname}"`) : null,
				mithril_default("", this.renderJobInformation(contact)),
				this.hasBirthday(contact) ? mithril_default("", this.formattedBirthday(contact)) : null
			]), this.renderActions(contact, attrs)), mithril_default("hr.hr.mt.mb")]),
			this.renderCustomDatesAndRelationships(contact),
			this.renderMailAddressesAndPhones(contact, onWriteMail),
			this.renderAddressesAndSocialIds(contact),
			this.renderWebsitesAndInstantMessengers(contact),
			this.renderComment(contact)
		]);
	}
	renderExtendedActions(contact, attrs) {
		return mithril_default.fragment({}, [this.renderEditButton(contact, attrs), this.renderDeleteButton(contact, attrs)]);
	}
	renderEditButton(contact, attrs) {
		if (!attrs.editAction) return null;
		return mithril_default(IconButton, {
			title: "edit_action",
			icon: Icons.Edit,
			click: () => assertNotNull(attrs.editAction, "Invalid Edit action in Contact Viewer")(contact)
		});
	}
	renderDeleteButton(contact, attrs) {
		if (!attrs.deleteAction) return null;
		return mithril_default(IconButton, {
			title: "delete_action",
			icon: Icons.Trash,
			click: () => assertNotNull(attrs.deleteAction, "Invalid Delete action in Contact Viewer")([contact])
		});
	}
	renderActionsDropdown(contact, attrs) {
		const actions = [];
		if (attrs.editAction) actions.push({
			label: "edit_action",
			icon: Icons.Edit,
			click: () => {
				assertNotNull(attrs.editAction, "Edit action in Contact Viewer has disappeared")(contact);
			}
		});
		if (attrs.deleteAction) actions.push({
			label: "delete_action",
			icon: Icons.Trash,
			click: () => {
				assertNotNull(attrs.deleteAction, "Delete action in Contact Viewer has disappeared")([contact]);
			}
		});
		if (actions.length === 0) return null;
		return mithril_default(".flex-end", mithril_default(IconButton, attachDropdown({
			mainButtonAttrs: {
				title: "more_label",
				icon: Icons.More
			},
			childAttrs: () => actions
		})));
	}
	renderActions(contact, attrs) {
		if (!contact || !(attrs.editAction || attrs.deleteAction)) return null;
		if (attrs.extendedActions) return this.renderExtendedActions(contact, attrs);
		return this.renderActionsDropdown(contact, attrs);
	}
	renderJobInformation(contact) {
		const spacerFunction = () => mithril_default("span.plr-s", { style: { fontWeight: "900" } }, " · ");
		return insertBetween([
			contact.role ? mithril_default("span", contact.role) : null,
			contact.department ? mithril_default("span", contact.department) : null,
			contact.company ? mithril_default("span", contact.company) : null
		], spacerFunction);
	}
	renderPronounsInfo(contact) {
		const spacerFunction = () => mithril_default("span.plr-s", { style: { fontWeight: "900" } }, " · ");
		return insertBetween(contact.pronouns.map((pronouns) => {
			let language = "";
			if (pronouns.language != "") language = `${pronouns.language}: `;
			return mithril_default("span", `${language}${pronouns.pronouns}`);
		}), spacerFunction);
	}
	renderAddressesAndSocialIds(contact) {
		const addresses = contact.addresses.map((element) => this.renderAddress(element));
		const socials = contact.socialIds.map((element) => this.renderSocialId(element));
		return addresses.length > 0 || socials.length > 0 ? mithril_default(".wrapping-row", [mithril_default(".address.mt-l", addresses.length > 0 ? [mithril_default(".h4", lang.get("address_label")), mithril_default(".aggregateEditors", addresses)] : null), mithril_default(".social.mt-l", socials.length > 0 ? [mithril_default(".h4", lang.get("social_label")), mithril_default(".aggregateEditors", socials)] : null)]) : null;
	}
	renderWebsitesAndInstantMessengers(contact) {
		const websites = contact.websites.map((element) => this.renderWebsite(element));
		const instantMessengers = contact.messengerHandles.map((element) => this.renderMessengerHandle(element));
		return websites.length > 0 || instantMessengers.length > 0 ? mithril_default(".wrapping-row", [mithril_default(".website.mt-l", websites.length > 0 ? [mithril_default(".h4", lang.get("websites_label")), mithril_default(".aggregateEditors", websites)] : null), mithril_default(".messenger-handles.mt-l", instantMessengers.length > 0 ? [mithril_default(".h4", lang.get("messenger_handles_label")), mithril_default(".aggregateEditors", instantMessengers)] : null)]) : null;
	}
	renderCustomDatesAndRelationships(contact) {
		const dates = contact.customDate.map((element) => mithril_default(TextField, {
			label: getContactCustomDateTypeToLabel(getCustomDateType(element), element.customTypeName),
			value: formatContactDate(element.dateIso),
			isReadOnly: true
		}));
		const relationships = contact.relationships.map((element) => mithril_default(TextField, {
			label: getContactRelationshipTypeToLabel(getRelationshipType(element), element.customTypeName),
			value: element.person,
			isReadOnly: true
		}));
		return dates.length > 0 || relationships.length > 0 ? mithril_default(".wrapping-row", [mithril_default(".dates.mt-l", dates.length > 0 ? [mithril_default(".h4", lang.get("dates_label")), mithril_default(".aggregateEditors", dates)] : null), mithril_default(".relationships.mt-l", relationships.length > 0 ? [mithril_default(".h4", lang.get("relationships_label")), mithril_default(".aggregateEditors", relationships)] : null)]) : null;
	}
	renderMailAddressesAndPhones(contact, onWriteMail) {
		const mailAddresses = contact.mailAddresses.map((element) => this.renderMailAddress(contact, element, onWriteMail));
		const phones = contact.phoneNumbers.map((element) => this.renderPhoneNumber(element));
		return mailAddresses.length > 0 || phones.length > 0 ? mithril_default(".wrapping-row", [mithril_default(".mail.mt-l", mailAddresses.length > 0 ? [mithril_default(".h4", lang.get("email_label")), mithril_default(".aggregateEditors", [mailAddresses])] : null), mithril_default(".phone.mt-l", phones.length > 0 ? [mithril_default(".h4", lang.get("phone_label")), mithril_default(".aggregateEditors", [phones])] : null)]) : null;
	}
	renderComment(contact) {
		return contact.comment && contact.comment.trim().length > 0 ? [mithril_default(".h4.mt-l", lang.get("comment_label")), mithril_default("p.mt-l.text-prewrap.text-break.selectable", contact.comment)] : null;
	}
	renderSocialId(contactSocialId) {
		const showButton = mithril_default(IconButton, {
			title: "showURL_alt",
			click: noOp,
			icon: Icons.ArrowForward,
			size: ButtonSize.Compact
		});
		return mithril_default(TextField, {
			label: getContactSocialTypeLabel(getContactSocialType(contactSocialId), contactSocialId.customTypeName),
			value: contactSocialId.socialId,
			isReadOnly: true,
			injectionsRight: () => mithril_default(`a[href=${getSocialUrl(contactSocialId)}][target=_blank]`, showButton)
		});
	}
	renderWebsite(website) {
		const showButton = mithril_default(IconButton, {
			title: "showURL_alt",
			click: noOp,
			icon: Icons.ArrowForward,
			size: ButtonSize.Compact
		});
		return mithril_default(TextField, {
			label: getContactCustomWebsiteTypeToLabel(downcast(website.type), website.customTypeName),
			value: website.url,
			isReadOnly: true,
			injectionsRight: () => mithril_default(`a[href=${getWebsiteUrl(website.url)}][target=_blank]`, showButton)
		});
	}
	renderMessengerHandle(messengerHandle) {
		const showButton = mithril_default(IconButton, {
			title: "showURL_alt",
			click: noOp,
			icon: Icons.ArrowForward,
			size: ButtonSize.Compact
		});
		return mithril_default(TextField, {
			label: getContactMessengerHandleTypeToLabel(downcast(messengerHandle.type), messengerHandle.customTypeName),
			value: messengerHandle.handle,
			isReadOnly: true,
			injectionsRight: () => mithril_default(`a[href=${getMessengerHandleUrl(messengerHandle)}][target=_blank]`, showButton)
		});
	}
	renderMailAddress(contact, address, onWriteMail) {
		const newMailButton = mithril_default(IconButton, {
			title: "sendMail_alt",
			click: () => onWriteMail({
				name: `${contact.firstName} ${contact.lastName}`.trim(),
				address: address.address,
				contact
			}),
			icon: Icons.PencilSquare,
			size: ButtonSize.Compact
		});
		return mithril_default(TextField, {
			label: getContactAddressTypeLabel(address.type, address.customTypeName),
			value: address.address,
			isReadOnly: true,
			injectionsRight: () => [newMailButton]
		});
	}
	renderPhoneNumber(phone) {
		const callButton = mithril_default(IconButton, {
			title: "callNumber_alt",
			click: () => null,
			icon: Icons.Call,
			size: ButtonSize.Compact
		});
		return mithril_default(TextField, {
			label: getContactPhoneNumberTypeLabel(phone.type, phone.customTypeName),
			value: phone.number,
			isReadOnly: true,
			injectionsRight: () => mithril_default(`a[href="tel:${phone.number}"][target=_blank]`, callButton)
		});
	}
	renderAddress(address) {
		let prepAddress;
		if (address.address.indexOf("\n") !== -1) prepAddress = encodeURIComponent(address.address.split("\n").join(" "));
else prepAddress = encodeURIComponent(address.address);
		const showButton = mithril_default(IconButton, {
			title: "showAddress_alt",
			click: () => null,
			icon: Icons.Pin,
			size: ButtonSize.Compact
		});
		return mithril_default(TextField, {
			label: getContactAddressTypeLabel(downcast(address.type), address.customTypeName),
			value: address.address,
			isReadOnly: true,
			type: TextFieldType.Area,
			injectionsRight: () => mithril_default(`a[href="https://www.openstreetmap.org/search?query=${prepAddress}"][target=_blank]`, showButton)
		});
	}
};
function insertBetween(array, spacer) {
	let ret = [];
	for (let e of array) if (e != null) {
		if (ret.length > 0) ret.push(spacer());
		ret.push(e);
	}
	return ret;
}

//#endregion
//#region ../src/common/gui/cards.ts
function responsiveCardHMargin() {
	return styles.isSingleColumnLayout() ? "mlr" : "mlr-l";
}

//#endregion
//#region ../src/mail-app/contacts/view/ContactCardViewer.ts
var ContactCardViewer = class {
	view({ attrs }) {
		const { contact, onWriteMail, editAction, deleteAction, extendedActions } = attrs;
		return [mithril_default(".border-radius-big.rel", {
			class: responsiveCardHMargin(),
			style: {
				backgroundColor: theme.content_bg,
				...attrs.style
			}
		}, mithril_default(ContactViewer, {
			contact,
			onWriteMail,
			editAction,
			deleteAction,
			extendedActions
		})), mithril_default(".mt-l")];
	}
};

//#endregion
//#region ../src/mail-app/contacts/ContactListEditor.ts
async function showContactListEditor(contactListGroupRoot, headerText, save, addressesOnList) {
	let showNameInput = true;
	const recipientsSearch = await locator.recipientsSearchModel();
	if (contactListGroupRoot) {
		showNameInput = false;
		recipientsSearch.setFilter((item) => {
			return !(item.type === "contactlist" && isSameId(item.value.groupRoot._id, contactListGroupRoot._id));
		});
	}
	const editorModel = new ContactListEditorModel(addressesOnList ?? []);
	const dialogCloseAction = () => {
		dialog.close();
	};
	let headerBarAttrs = {
		left: [{
			label: "cancel_action",
			click: dialogCloseAction,
			type: ButtonType.Secondary
		}],
		right: [{
			label: "save_action",
			click: () => {
				save(editorModel.name, editorModel.newAddresses);
				dialog.close();
			},
			type: ButtonType.Primary
		}],
		middle: headerText
	};
	const dialog = Dialog.editDialog(headerBarAttrs, ContactListEditor, {
		model: editorModel,
		contactSearch: recipientsSearch,
		showNameInput
	}).addShortcut({
		key: Keys.ESC,
		exec: () => dialog.close(),
		help: "close_alt"
	});
	dialog.show();
}
async function showContactListNameEditor(name, save) {
	let nameInput = name;
	let form = () => [mithril_default(TextField, {
		label: "name_label",
		value: nameInput,
		oninput: (newInput) => {
			nameInput = newInput;
		}
	})];
	const okAction = async (dialog) => {
		dialog.close();
		save(nameInput);
	};
	Dialog.showActionDialog({
		title: "editContactList_action",
		child: form,
		allowOkWithReturn: true,
		okAction
	});
}
var ContactListEditorModel = class {
	name;
	newAddresses;
	currentAddresses;
	constructor(addresses) {
		this.name = "";
		this.newAddresses = [];
		this.currentAddresses = addresses;
	}
	addRecipient(address) {
		this.newAddresses = [address, ...this.newAddresses];
	}
	removeRecipient(address) {
		this.newAddresses = this.newAddresses.filter((a) => address !== a);
	}
};
var ContactListEditor = class {
	model;
	search;
	newAddress = "";
	showNameInput = true;
	constructor(vnode) {
		this.model = vnode.attrs.model;
		this.search = vnode.attrs.contactSearch;
		this.showNameInput = vnode.attrs.showNameInput ?? true;
	}
	view() {
		let helpLabel = null;
		if (this.newAddress.trim().length > 0 && !isMailAddress(this.newAddress.trim(), false)) helpLabel = () => lang.get("invalidInputFormat_msg");
else if (this.model.currentAddresses.includes(cleanMailAddress(this.newAddress)) || this.model.newAddresses.includes(cleanMailAddress(this.newAddress))) helpLabel = () => lang.get("addressAlreadyExistsOnList_msg");
		return mithril_default("", [
			this.showNameInput ? mithril_default(TextField, {
				label: "name_label",
				class: "big-input pt flex-grow",
				value: this.model.name,
				oninput: (name) => this.model.name = name
			}) : null,
			mithril_default(MailRecipientsTextField, {
				label: "addEntries_action",
				text: this.newAddress,
				onTextChanged: (v) => this.newAddress = v,
				recipients: [],
				disabled: false,
				onRecipientAdded: (address) => {
					if (!this.model.newAddresses.includes(address) && !this.model.currentAddresses.includes(address)) this.model.addRecipient(address);
					mithril_default.redraw();
				},
				onRecipientRemoved: noOp,
				search: this.search,
				helpLabel
			}),
			this.model.newAddresses.map((address) => this.renderAddress(address))
		]);
	}
	renderAddress(address) {
		return mithril_default(".flex", { style: {
			height: px(size.button_height),
			borderBottom: "1px transparent",
			marginTop: px(size.vpad)
		} }, [
			mithril_default(".flex.col.flex-grow.overflow-hidden.flex-no-grow-shrink-auto", [address]),
			mithril_default(".flex-grow"),
			mithril_default(IconButton, {
				title: "remove_action",
				icon: Icons.Cancel,
				click: () => this.model.removeRecipient(address)
			})
		]);
	}
};

//#endregion
export { ContactCardViewer, ContactListEditorModel, MainCreateButton, _addressesToVCardAddresses, _areResidualContactFieldsEqual, _compareBirthdays, _compareContactsForMerge, _compareFullName, _compareMailAddresses, _comparePhoneNumbers, _contactToVCard, _getMergedAddresses, _getMergedEmailAddresses, _getMergedNameField, _getMergedOtherField, _getMergedPhoneNumbers, _getMergedSocialIds, _phoneNumbersToVCardPhoneNumbers, _socialIdsToVCardSocialUrls, _vCardFormatArrayToString, contactsToVCard, exportContacts, getMergeableContacts, mergeContacts, responsiveCardHMargin, showContactListEditor, showContactListNameEditor };
//# sourceMappingURL=ContactListEditor-5LX_1ENd.js.map