
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { mithril_default } from "./mithril-Csg4iNnm.js";
import { assertNotNull, clone, downcast, findAndRemove, lastIndex, lastThrow, noOp, typedEntries } from "./dist-CJHwsXKY.js";
import { ProgrammingError } from "./ProgrammingError-D8yJGVtm.js";
import { assertMainOrNode } from "./Env-D5xGlXfw.js";
import { lang } from "./LanguageViewModel-BNC5ekpO.js";
import { DefaultAnimationTime, animations, height, opacity } from "./HtmlUtils-C-ecR7U7.js";
import { ContactAddressType, ContactCustomDateType, ContactMessengerHandleType, ContactPhoneNumberType, ContactRelationshipType, ContactSocialType, ContactWebsiteType, GroupType, Keys } from "./TutanotaConstants-3bwAESYA.js";
import { BootIcons, ButtonType } from "./Icon-BuqNK7vz.js";
import { Icons } from "./Icons-Dl3nFav5.js";
import { windowFacade } from "./WindowFacade-B9kSBKw7.js";
import { Autocapitalize, Autocomplete, Dialog, TextField, TextFieldType, attachDropdown } from "./Dialog-B6-HFvZd.js";
import { ButtonSize, IconButton } from "./IconButton-DsU60HJ_.js";
import { LockedError, NotFoundError, PayloadTooLargeError } from "./RestError-D17JEBMr.js";
import { timestampToGeneratedId } from "./EntityUtils-RQxXZlcV.js";
import { formatDate } from "./Formatter-zB15D6XI.js";
import { createBirthday, createContact, createContactAddress, createContactCustomDate, createContactMailAddress, createContactMessengerHandle, createContactPhoneNumber, createContactPronouns, createContactRelationship, createContactSocialId, createContactWebsite } from "./TypeRefs-CR3TLWn0.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import { isMailAddress } from "./FormatValidator-2BBermUe.js";
import { birthdayToIsoDate } from "./BirthdayUtils-BcCMglSq.js";
import { formatBirthdayNumeric, formatContactDate } from "./ContactUtils-Bbon2oOk.js";
import { parseBirthday } from "./DateParser-DIjdXKhX.js";
import { PasswordField } from "./PasswordField-CPKPoLq8.js";
import { ContactCustomDateTypeToLabel, ContactCustomWebsiteTypeToLabel, ContactMailAddressTypeToLabel, ContactMessengerHandleTypeToLabel, ContactPhoneNumberTypeToLabel, ContactRelationshipTypeToLabel, ContactSocialTypeToLabel, getContactAddressTypeLabel, getContactCustomDateTypeToLabel, getContactCustomWebsiteTypeToLabel, getContactMessengerHandleTypeToLabel, getContactPhoneNumberTypeLabel, getContactRelationshipTypeToLabel, getContactSocialTypeLabel } from "./ContactGuiUtils-BOj2qfyh.js";

//#region ../src/mail-app/contacts/ContactAggregateEditor.ts
var ContactAggregateEditor = class {
	oncreate(vnode) {
		const animate = typeof vnode.attrs.animateCreate === "boolean" ? vnode.attrs.animateCreate : true;
		if (animate) this.animate(vnode.dom, true);
	}
	async onbeforeremove(vnode) {
		await this.animate(vnode.dom, false);
	}
	view(vnode) {
		const attrs = vnode.attrs;
		return mithril_default(".flex.items-center.child-grow", [mithril_default(TextField, {
			value: attrs.value,
			label: attrs.label,
			type: attrs.fieldType,
			autocapitalize: attrs.autocapitalizeTextField,
			helpLabel: () => lang.getTranslationText(attrs.helpLabel),
			injectionsRight: () => this._moreButtonFor(attrs),
			oninput: (value) => attrs.onUpdate(value)
		}), this._cancelButtonFor(attrs)]);
	}
	_doesAllowCancel(attrs) {
		return typeof attrs.allowCancel === "boolean" ? attrs.allowCancel : true;
	}
	_cancelButtonFor(attrs) {
		if (this._doesAllowCancel(attrs)) return mithril_default(IconButton, {
			title: "remove_action",
			click: () => attrs.cancelAction(),
			icon: Icons.Cancel
		});
else return mithril_default(".icon-button");
	}
	_moreButtonFor(attrs) {
		return mithril_default(IconButton, attachDropdown({
			mainButtonAttrs: {
				title: "more_label",
				icon: BootIcons.Expand,
				size: ButtonSize.Compact
			},
			childAttrs: () => attrs.typeLabels.map(([key, value]) => {
				return {
					label: value,
					click: () => attrs.onTypeSelected(key)
				};
			})
		}));
	}
	animate(domElement, fadein) {
		let childHeight = domElement.offsetHeight;
		if (fadein) domElement.style.opacity = "0";
		const opacityP = animations.add(domElement, fadein ? opacity(0, 1, true) : opacity(1, 0, true));
		const heightP = animations.add(domElement, fadein ? height(0, childHeight) : height(childHeight, 0));
		heightP.then(() => {
			domElement.style.height = "";
		});
		return Promise.all([opacityP, heightP]);
	}
};

//#endregion
//#region ../src/mail-app/contacts/ContactEditor.ts
assertMainOrNode();
const TAG = "[ContactEditor]";
var ContactEditor = class {
	dialog;
	hasInvalidBirthday;
	mailAddresses;
	phoneNumbers;
	addresses;
	socialIds;
	websites;
	relationships;
	messengerHandles;
	pronouns;
	customDates;
	birthday;
	windowCloseUnsubscribe;
	isNewContact;
	contact;
	listId;
	saving = false;
	constructor(entityClient, contact, listId, newContactIdReceiver = null) {
		this.entityClient = entityClient;
		this.newContactIdReceiver = newContactIdReceiver;
		this.contact = contact ? clone(contact) : createContact({
			mailAddresses: [],
			title: null,
			socialIds: [],
			role: "",
			presharedPassword: null,
			photo: null,
			phoneNumbers: [],
			oldBirthdayDate: null,
			nickname: null,
			lastName: "",
			firstName: "",
			company: "",
			comment: "",
			birthdayIso: null,
			addresses: [],
			oldBirthdayAggregate: null,
			department: null,
			middleName: null,
			nameSuffix: null,
			phoneticFirst: null,
			phoneticLast: null,
			phoneticMiddle: null,
			customDate: [],
			messengerHandles: [],
			pronouns: [],
			relationships: [],
			websites: []
		});
		this.isNewContact = contact?._id == null;
		if (this.isNewContact && listId == null) throw new ProgrammingError("must provide contact with Id to edit or listId for the new contact");
else this.listId = listId ? listId : assertNotNull(contact, "got an existing contact without id")._id[0];
		const id = (entity) => entity._id || this.newId();
		this.mailAddresses = this.contact.mailAddresses.map((address) => [address, id(address)]);
		this.mailAddresses.push(this.newMailAddress());
		this.phoneNumbers = this.contact.phoneNumbers.map((phoneNumber) => [phoneNumber, id(phoneNumber)]);
		this.phoneNumbers.push(this.newPhoneNumber());
		this.addresses = this.contact.addresses.map((address) => [address, id(address)]);
		this.addresses.push(this.newAddress());
		this.socialIds = this.contact.socialIds.map((socialId) => [socialId, id(socialId)]);
		this.socialIds.push(this.newSocialId());
		this.websites = this.contact.websites.map((website) => [website, id(website)]);
		this.websites.push(this.newWebsite());
		this.relationships = this.contact.relationships.map((relation) => [relation, id(relation)]);
		this.relationships.push(this.newRelationship());
		this.messengerHandles = this.contact.messengerHandles.map((handler) => [handler, id(handler)]);
		this.messengerHandles.push(this.newMessengerHandler());
		this.pronouns = this.contact.pronouns.map((pronoun) => [pronoun, id(pronoun)]);
		this.pronouns.push(this.newPronoun());
		this.customDates = this.contact.customDate.map((date) => [{
			...date,
			date: formatContactDate(date.dateIso),
			isValid: true
		}, id(date)]);
		this.customDates.push(this.newCustomDate());
		this.hasInvalidBirthday = false;
		this.birthday = formatContactDate(this.contact.birthdayIso) || "";
		this.dialog = this.createDialog();
		this.windowCloseUnsubscribe = noOp;
	}
	oncreate() {
		this.windowCloseUnsubscribe = windowFacade.addWindowCloseListener(() => {});
	}
	onremove() {
		this.windowCloseUnsubscribe();
	}
	view() {
		return mithril_default("#contact-editor", [
			mithril_default(".wrapping-row", [this.renderFirstNameField(), this.renderLastNameField()]),
			mithril_default(".wrapping-row", [this.renderField("middleName", "middleName_placeholder"), this.renderTitleField()]),
			mithril_default(".wrapping-row", [this.renderField("nameSuffix", "nameSuffix_placeholder"), this.renderField("phoneticFirst", "phoneticFirst_placeholder")]),
			mithril_default(".wrapping-row", [this.renderField("phoneticMiddle", "phoneticMiddle_placeholder"), this.renderField("phoneticLast", "phoneticLast_placeholder")]),
			mithril_default(".wrapping-row", [this.renderField("nickname", "nickname_placeholder"), this.renderBirthdayField()]),
			mithril_default(".wrapping-row", [
				this.renderRoleField(),
				this.renderField("department", "department_placeholder"),
				this.renderCompanyField(),
				this.renderCommentField()
			]),
			mithril_default(".wrapping-row", [
				mithril_default(".custom-dates.mt-xl", [mithril_default(".h4", lang.get("dates_label")), mithril_default(".aggregateEditors", [this.customDates.map(([date, id], index) => {
					const lastEditor = index === lastIndex(this.customDates);
					return this.renderCustomDatesEditor(id, !lastEditor, date);
				})])]),
				mithril_default(".mail.mt-xl", [mithril_default(".h4", lang.get("email_label")), mithril_default(".aggregateEditors", [this.mailAddresses.map(([address, id], index) => {
					const lastEditor = index === lastIndex(this.mailAddresses);
					return this.renderMailAddressesEditor(id, !lastEditor, address);
				})])]),
				mithril_default(".phone.mt-xl", [mithril_default(".h4", lang.get("phone_label")), mithril_default(".aggregateEditors", [this.phoneNumbers.map(([phoneNumber, id], index) => {
					const lastEditor = index === lastIndex(this.phoneNumbers);
					return this.renderPhonesEditor(id, !lastEditor, phoneNumber);
				})])]),
				mithril_default(".relationship.mt-xl", [mithril_default(".h4", lang.get("relationships_label")), mithril_default(".aggregateEditors", [this.relationships.map(([relationship, id], index) => {
					const lastEditor = index === lastIndex(this.relationships);
					return this.renderRelationshipsEditor(id, !lastEditor, relationship);
				})])]),
				mithril_default(".address.mt-xl", [mithril_default(".h4", lang.get("address_label")), mithril_default(".aggregateEditors", [this.addresses.map(([address, id], index) => {
					const lastEditor = index === lastIndex(this.addresses);
					return this.renderAddressesEditor(id, !lastEditor, address);
				})])])
			]),
			mithril_default(".wrapping-row", [
				mithril_default(".pronouns.mt-xl", [mithril_default(".h4", lang.get("pronouns_label")), mithril_default(".aggregateEditors", [this.pronouns.map(([pronouns, id], index) => {
					const lastEditor = index === lastIndex(this.pronouns);
					return this.renderPronounsEditor(id, !lastEditor, pronouns);
				})])]),
				mithril_default(".social.mt-xl", [mithril_default(".h4", lang.get("social_label")), mithril_default(".aggregateEditors", [this.socialIds.map(([socialId, id], index) => {
					const lastEditor = index === lastIndex(this.socialIds);
					return this.renderSocialsEditor(id, !lastEditor, socialId);
				})])]),
				mithril_default(".website.mt-xl", [mithril_default(".h4", lang.get("websites_label")), mithril_default(".aggregateEditors", [this.websites.map(([website, id], index) => {
					const lastEditor = index === lastIndex(this.websites);
					return this.renderWebsitesEditor(id, !lastEditor, website);
				})])]),
				mithril_default(".instant-message.mt-xl", [mithril_default(".h4", lang.get("messenger_handles_label")), mithril_default(".aggregateEditors", [this.messengerHandles.map(([handle, id], index) => {
					const lastEditor = index === lastIndex(this.messengerHandles);
					return this.renderMessengerHandleEditor(id, !lastEditor, handle);
				})])])
			]),
			this.renderPresharedPasswordField(),
			mithril_default(".pb")
		]);
	}
	show() {
		this.dialog.show();
	}
	close() {
		this.dialog.close();
	}
	/**
	* * validate the input data
	* * create or update the contact, depending on status
	* * if successful, close the dialog.
	*
	* will not call the save function again if the operation is already running
	* @private
	*/
	async validateAndSave() {
		if (this.hasInvalidBirthday) return Dialog.message("invalidBirthday_msg");
		if (this.saving) return;
		this.saving = true;
		this.contact.mailAddresses = this.mailAddresses.map((e) => e[0]).filter((e) => e.address.trim().length > 0);
		this.contact.phoneNumbers = this.phoneNumbers.map((e) => e[0]).filter((e) => e.number.trim().length > 0);
		this.contact.addresses = this.addresses.map((e) => e[0]).filter((e) => e.address.trim().length > 0);
		this.contact.socialIds = this.socialIds.map((e) => e[0]).filter((e) => e.socialId.trim().length > 0);
		this.contact.customDate = this.customDates.map((e) => e[0]).filter((e) => e.dateIso.trim().length > 0);
		this.contact.relationships = this.relationships.map((e) => e[0]).filter((e) => e.person.trim().length > 0);
		this.contact.websites = this.websites.map((e) => e[0]).filter((e) => e.url.length > 0);
		this.contact.messengerHandles = this.messengerHandles.map((e) => e[0]).filter((e) => e.handle.length > 0);
		this.contact.pronouns = this.pronouns.map((e) => e[0]).filter((e) => e.pronouns.length > 0);
		try {
			if (this.isNewContact) await this.saveNewContact();
else await this.updateExistingContact();
			this.close();
		} catch (e) {
			this.saving = false;
			if (e instanceof PayloadTooLargeError) return Dialog.message("requestTooLarge_msg");
			if (e instanceof LockedError) return Dialog.message("operationStillActive_msg");
		}
	}
	async updateExistingContact() {
		try {
			await this.entityClient.update(this.contact);
		} catch (e) {
			if (e instanceof NotFoundError) console.log(TAG, `could not update contact ${this.contact._id}: not found`);
		}
	}
	async saveNewContact() {
		this.contact._ownerGroup = assertNotNull(locator.logins.getUserController().user.memberships.find((m) => m.groupType === GroupType.Contact), "did not find contact group membership").group;
		const contactId = await this.entityClient.setup(this.listId, this.contact);
		if (this.newContactIdReceiver) this.newContactIdReceiver(contactId);
	}
	renderCustomDatesEditor(id, allowCancel, date) {
		let dateHelpText = () => {
			let bday = createBirthday({
				day: "22",
				month: "9",
				year: "2000"
			});
			return !date.isValid ? lang.getTranslation("invalidDateFormat_msg", { "{1}": formatBirthdayNumeric(bday) }) : lang.getTranslation("emptyString_msg");
		};
		const typeLabels = typedEntries(ContactCustomDateTypeToLabel);
		return mithril_default(ContactAggregateEditor, {
			value: date.date,
			fieldType: TextFieldType.Text,
			label: getContactCustomDateTypeToLabel(downcast(date.type), date.customTypeName),
			helpLabel: dateHelpText(),
			cancelAction: () => {
				findAndRemove(this.customDates, (t) => t[1] === id);
			},
			onUpdate: (value) => {
				date.date = value;
				if (value.trim().length > 0) {
					let parsedDate = parseBirthday(value, (referenceDate) => formatDate(referenceDate));
					if (parsedDate) try {
						date.dateIso = birthdayToIsoDate(parsedDate);
						if (date === lastThrow(this.customDates)[0]) this.customDates.push(this.newCustomDate());
						date.isValid = true;
					} catch (e) {
						date.isValid = false;
					}
else date.isValid = false;
				} else date.isValid = true;
			},
			animateCreate: !date.dateIso,
			allowCancel,
			key: id,
			typeLabels,
			onTypeSelected: (type) => this.onTypeSelected(type === ContactCustomDateType.CUSTOM, type, date)
		});
	}
	renderMailAddressesEditor(id, allowCancel, mailAddress) {
		let helpLabel;
		if (mailAddress.address.trim().length > 0 && !isMailAddress(mailAddress.address.trim(), false)) helpLabel = "invalidInputFormat_msg";
else helpLabel = "emptyString_msg";
		const typeLabels = typedEntries(ContactMailAddressTypeToLabel);
		return mithril_default(ContactAggregateEditor, {
			value: mailAddress.address,
			fieldType: TextFieldType.Email,
			label: getContactAddressTypeLabel(downcast(mailAddress.type), mailAddress.customTypeName),
			helpLabel,
			cancelAction: () => {
				findAndRemove(this.mailAddresses, (t) => t[1] === id);
			},
			onUpdate: (value) => {
				mailAddress.address = value;
				if (mailAddress === lastThrow(this.mailAddresses)[0]) this.mailAddresses.push(this.newAddress());
			},
			animateCreate: !mailAddress.address,
			allowCancel,
			key: id,
			typeLabels,
			onTypeSelected: (type) => this.onTypeSelected(type === ContactAddressType.CUSTOM, type, mailAddress)
		});
	}
	renderPhonesEditor(id, allowCancel, phoneNumber) {
		const typeLabels = typedEntries(ContactPhoneNumberTypeToLabel);
		return mithril_default(ContactAggregateEditor, {
			value: phoneNumber.number,
			fieldType: TextFieldType.Text,
			label: getContactPhoneNumberTypeLabel(downcast(phoneNumber.type), phoneNumber.customTypeName),
			helpLabel: "emptyString_msg",
			cancelAction: () => {
				findAndRemove(this.phoneNumbers, (t) => t[1] === id);
			},
			onUpdate: (value) => {
				phoneNumber.number = value;
				if (phoneNumber === lastThrow(this.phoneNumbers)[0]) this.phoneNumbers.push(this.newPhoneNumber());
			},
			animateCreate: !phoneNumber.number,
			allowCancel,
			key: id,
			typeLabels,
			onTypeSelected: (type) => this.onTypeSelected(type === ContactPhoneNumberType.CUSTOM, type, phoneNumber)
		});
	}
	renderAddressesEditor(id, allowCancel, address) {
		const typeLabels = typedEntries(ContactMailAddressTypeToLabel);
		return mithril_default(ContactAggregateEditor, {
			value: address.address,
			fieldType: TextFieldType.Area,
			label: getContactAddressTypeLabel(downcast(address.type), address.customTypeName),
			helpLabel: "emptyString_msg",
			cancelAction: () => {
				findAndRemove(this.addresses, (t) => t[1] === id);
			},
			onUpdate: (value) => {
				address.address = value;
				if (address === lastThrow(this.addresses)[0]) this.addresses.push(this.newAddress());
			},
			animateCreate: !address.address,
			allowCancel,
			key: id,
			typeLabels,
			onTypeSelected: (type) => this.onTypeSelected(type === ContactAddressType.CUSTOM, type, address)
		});
	}
	renderSocialsEditor(id, allowCancel, socialId) {
		const typeLabels = typedEntries(ContactSocialTypeToLabel);
		return mithril_default(ContactAggregateEditor, {
			value: socialId.socialId,
			fieldType: TextFieldType.Text,
			label: getContactSocialTypeLabel(downcast(socialId.type), socialId.customTypeName),
			helpLabel: "emptyString_msg",
			autocapitalizeTextField: Autocapitalize.none,
			cancelAction: () => {
				findAndRemove(this.socialIds, (t) => t[1] === id);
			},
			onUpdate: (value) => {
				socialId.socialId = value;
				if (socialId === lastThrow(this.socialIds)[0]) this.socialIds.push(this.newSocialId());
			},
			animateCreate: !socialId.socialId,
			allowCancel,
			key: id,
			typeLabels,
			onTypeSelected: (type) => this.onTypeSelected(type === ContactSocialType.CUSTOM, type, socialId)
		});
	}
	renderWebsitesEditor(id, allowCancel, website) {
		const typeLabels = typedEntries(ContactCustomWebsiteTypeToLabel);
		return mithril_default(ContactAggregateEditor, {
			value: website.url,
			fieldType: TextFieldType.Text,
			label: getContactCustomWebsiteTypeToLabel(downcast(website.type), website.customTypeName),
			helpLabel: "emptyString_msg",
			autocapitalizeTextField: Autocapitalize.none,
			cancelAction: () => {
				findAndRemove(this.websites, (t) => t[1] === id);
			},
			onUpdate: (value) => {
				website.url = value;
				if (website === lastThrow(this.websites)[0]) this.websites.push(this.newWebsite());
			},
			animateCreate: !website.url,
			allowCancel,
			key: id,
			typeLabels,
			onTypeSelected: (type) => this.onTypeSelected(type === ContactWebsiteType.CUSTOM, type, website)
		});
	}
	renderRelationshipsEditor(id, allowCancel, relationship) {
		const typeLabels = typedEntries(ContactRelationshipTypeToLabel);
		return mithril_default(ContactAggregateEditor, {
			value: relationship.person,
			fieldType: TextFieldType.Text,
			label: getContactRelationshipTypeToLabel(downcast(relationship.type), relationship.customTypeName),
			helpLabel: "emptyString_msg",
			cancelAction: () => {
				findAndRemove(this.relationships, (t) => t[1] === id);
			},
			onUpdate: (value) => {
				relationship.person = value;
				if (relationship === lastThrow(this.relationships)[0]) this.relationships.push(this.newRelationship());
			},
			animateCreate: !relationship.person,
			allowCancel,
			key: id,
			typeLabels,
			onTypeSelected: (type) => this.onTypeSelected(type === ContactRelationshipType.CUSTOM, type, relationship)
		});
	}
	renderMessengerHandleEditor(id, allowCancel, messengerHandle) {
		const typeLabels = typedEntries(ContactMessengerHandleTypeToLabel);
		return mithril_default(ContactAggregateEditor, {
			value: messengerHandle.handle,
			fieldType: TextFieldType.Text,
			label: getContactMessengerHandleTypeToLabel(downcast(messengerHandle.type), messengerHandle.customTypeName),
			helpLabel: "emptyString_msg",
			autocapitalizeTextField: Autocapitalize.none,
			cancelAction: () => {
				findAndRemove(this.messengerHandles, (t) => t[1] === id);
			},
			onUpdate: (value) => {
				messengerHandle.handle = value;
				if (messengerHandle === lastThrow(this.messengerHandles)[0]) this.messengerHandles.push(this.newMessengerHandler());
			},
			animateCreate: !messengerHandle.handle,
			allowCancel,
			key: id,
			typeLabels,
			onTypeSelected: (type) => this.onTypeSelected(type === ContactMessengerHandleType.CUSTOM, type, messengerHandle)
		});
	}
	renderPronounsEditor(id, allowCancel, pronouns) {
		const typeLabels = typedEntries({ "0": "language_label" });
		return mithril_default(ContactAggregateEditor, {
			value: pronouns.pronouns,
			fieldType: TextFieldType.Text,
			label: lang.makeTranslation("lang", pronouns.language),
			helpLabel: "emptyString_msg",
			autocapitalizeTextField: Autocapitalize.none,
			cancelAction: () => {
				findAndRemove(this.pronouns, (t) => t[1] === id);
			},
			onUpdate: (value) => {
				pronouns.pronouns = value;
				if (pronouns === lastThrow(this.pronouns)[0]) this.pronouns.push(this.newPronoun());
			},
			animateCreate: !pronouns.pronouns,
			allowCancel,
			key: id,
			typeLabels,
			onTypeSelected: () => this.onLanguageSelect(pronouns)
		});
	}
	renderCommentField() {
		return mithril_default(StandaloneField, {
			label: "comment_label",
			value: this.contact.comment,
			oninput: (value) => this.contact.comment = value,
			type: TextFieldType.Area
		});
	}
	renderFirstNameField() {
		return mithril_default(StandaloneField, {
			label: "firstName_placeholder",
			value: this.contact.firstName,
			oninput: (value) => this.contact.firstName = value
		});
	}
	renderField(fieldName, label) {
		return mithril_default(StandaloneField, {
			label,
			value: this.contact[fieldName] ?? "",
			oninput: (value) => {
				if (typeof value === "string") this.contact[fieldName] = downcast(value);
			}
		});
	}
	renderLastNameField() {
		return mithril_default(StandaloneField, {
			label: "lastName_placeholder",
			value: this.contact.lastName,
			oninput: (value) => this.contact.lastName = value
		});
	}
	renderBirthdayField() {
		let birthdayHelpText = () => {
			let bday = createBirthday({
				day: "22",
				month: "9",
				year: "2000"
			});
			return this.hasInvalidBirthday ? lang.get("invalidDateFormat_msg", { "{1}": formatBirthdayNumeric(bday) }) : "";
		};
		return mithril_default(StandaloneField, {
			label: "birthday_alt",
			value: this.birthday,
			helpLabel: birthdayHelpText,
			oninput: (value) => {
				this.birthday = value;
				if (value.trim().length === 0) {
					this.contact.birthdayIso = null;
					this.hasInvalidBirthday = false;
				} else {
					let birthday = parseBirthday(value, (referenceDate) => formatDate(referenceDate));
					if (birthday) try {
						this.contact.birthdayIso = birthdayToIsoDate(birthday);
						this.hasInvalidBirthday = false;
					} catch (e) {
						this.hasInvalidBirthday = true;
					}
else this.hasInvalidBirthday = true;
				}
			}
		});
	}
	renderCompanyField() {
		return mithril_default(StandaloneField, {
			label: "company_label",
			value: this.contact.company,
			oninput: (value) => this.contact.company = value
		});
	}
	renderRoleField() {
		return mithril_default(StandaloneField, {
			label: "role_placeholder",
			value: this.contact.role,
			oninput: (value) => this.contact.role = value
		});
	}
	renderTitleField() {
		return mithril_default(StandaloneField, {
			label: "title_placeholder",
			value: this.contact.title || "",
			oninput: (value) => this.contact.title = value
		});
	}
	renderPresharedPasswordField() {
		if (!this.isNewContact && !this.contact.presharedPassword) return null;
		return mithril_default(".wrapping-row", [mithril_default(".passwords.mt-xl", [mithril_default(".h4", lang.get("presharedPassword_label")), mithril_default(PasswordField, {
			value: this.contact.presharedPassword ?? "",
			autocompleteAs: Autocomplete.newPassword,
			oninput: (value) => this.contact.presharedPassword = value
		})]), mithril_default(".spacer")]);
	}
	createCloseButtonAttrs() {
		return {
			label: "close_alt",
			click: () => this.close(),
			type: ButtonType.Secondary
		};
	}
	newPhoneNumber() {
		const phoneNumber = createContactPhoneNumber({
			type: ContactPhoneNumberType.MOBILE,
			customTypeName: "",
			number: ""
		});
		return [phoneNumber, this.newId()];
	}
	newMailAddress() {
		const mailAddress = createContactMailAddress({
			type: ContactAddressType.WORK,
			customTypeName: "",
			address: ""
		});
		return [mailAddress, this.newId()];
	}
	newAddress() {
		const address = createContactAddress({
			type: ContactAddressType.WORK,
			customTypeName: "",
			address: ""
		});
		return [address, this.newId()];
	}
	newSocialId() {
		const socialId = createContactSocialId({
			type: ContactSocialType.TWITTER,
			customTypeName: "",
			socialId: ""
		});
		return [socialId, this.newId()];
	}
	newRelationship() {
		const relationship = createContactRelationship({
			person: "",
			type: ContactRelationshipType.ASSISTANT,
			customTypeName: ""
		});
		return [relationship, this.newId()];
	}
	newMessengerHandler() {
		const messengerHandler = createContactMessengerHandle({
			handle: "",
			type: ContactMessengerHandleType.SIGNAL,
			customTypeName: ""
		});
		return [messengerHandler, this.newId()];
	}
	newPronoun() {
		const contactPronouns = createContactPronouns({
			language: "",
			pronouns: ""
		});
		return [contactPronouns, this.newId()];
	}
	newCustomDate() {
		const contactDate = createContactCustomDate({
			dateIso: "",
			type: ContactCustomDateType.ANNIVERSARY,
			customTypeName: ""
		});
		return [{
			...contactDate,
			date: "",
			isValid: true
		}, this.newId()];
	}
	newWebsite() {
		const website = createContactWebsite({
			type: ContactWebsiteType.PRIVATE,
			url: "",
			customTypeName: ""
		});
		return [website, this.newId()];
	}
	newId() {
		return timestampToGeneratedId(Date.now());
	}
	onTypeSelected(isCustom, key, aggregate) {
		if (isCustom) setTimeout(() => {
			Dialog.showTextInputDialog({
				title: "customLabel_label",
				label: "customLabel_label",
				defaultValue: aggregate.customTypeName
			}).then((name) => {
				aggregate.customTypeName = name;
				aggregate.type = key;
			});
		}, DefaultAnimationTime);
else aggregate.type = key;
	}
	onLanguageSelect(pronouns) {
		setTimeout(() => {
			Dialog.showTextInputDialog({
				title: "language_label",
				label: "language_label",
				defaultValue: pronouns.language.length > 0 ? pronouns.language : ""
			}).then((name) => {
				pronouns.language = name;
			});
		}, DefaultAnimationTime);
	}
	createDialog() {
		const headerBarAttrs = {
			left: [this.createCloseButtonAttrs()],
			middle: lang.makeTranslation("name", this.contact.firstName + " " + this.contact.lastName),
			right: [{
				label: "save_action",
				click: () => this.validateAndSave(),
				type: ButtonType.Primary
			}]
		};
		return Dialog.largeDialog(headerBarAttrs, this).addShortcut({
			key: Keys.ESC,
			exec: () => this.close(),
			help: "close_alt"
		}).addShortcut({
			key: Keys.S,
			ctrlOrCmd: true,
			exec: () => {
				this.validateAndSave();
			},
			help: "save_action"
		}).setCloseHandler(() => this.close());
	}
};
var StandaloneField = class {
	view({ attrs }) {
		return mithril_default(".flex.child-grow", [mithril_default(TextField, attrs), mithril_default(".icon-button")]);
	}
};

//#endregion
export { ContactEditor };
//# sourceMappingURL=ContactEditor-qV5wi7tT.js.map