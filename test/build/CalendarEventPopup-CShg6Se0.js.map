{"version":3,"file":"CalendarEventPopup-CShg6Se0.js","names":["model: CalendarEventPreviewViewModel","eventBubbleRect: PosRect","htmlSanitizer: HtmlSanitizer","ev: MouseEvent","receiver: HTMLElement","e: MouseEvent","e: Event","close: Shortcut","edit: Shortcut","sendUpdates: Shortcut","remove: Shortcut"],"sources":["../../src/calendar-app/calendar/gui/eventpopup/CalendarEventPopup.ts"],"sourcesContent":["import type { Shortcut } from \"../../../../common/misc/KeyManager.js\"\nimport m, { Children } from \"mithril\"\nimport { px } from \"../../../../common/gui/size.js\"\nimport { Icons } from \"../../../../common/gui/base/icons/Icons.js\"\nimport type { ModalComponent } from \"../../../../common/gui/base/Modal.js\"\nimport { modal } from \"../../../../common/gui/base/Modal.js\"\nimport { EventPreviewView, EventPreviewViewAttrs } from \"./EventPreviewView.js\"\nimport { Dialog } from \"../../../../common/gui/base/Dialog.js\"\nimport { createAsyncDropdown, DROPDOWN_MARGIN, PosRect, showDropdown } from \"../../../../common/gui/base/Dropdown.js\"\nimport { Keys } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport type { HtmlSanitizer } from \"../../../../common/misc/HtmlSanitizer.js\"\nimport { prepareCalendarDescription } from \"../../../../common/calendar/date/CalendarUtils.js\"\nimport { BootIcons } from \"../../../../common/gui/base/icons/BootIcons.js\"\nimport { IconButton } from \"../../../../common/gui/base/IconButton.js\"\nimport { convertTextToHtml } from \"../../../../common/misc/Formatter.js\"\nimport { CalendarEventPreviewViewModel } from \"./CalendarEventPreviewViewModel.js\"\nimport { showDeletePopup } from \"../CalendarGuiUtils.js\"\n\n/**\n * small modal displaying all relevant information about an event in a compact fashion. offers limited editing capabilities to participants in the\n * form of quick response buttons to set attendance and adding exclusions.\n *\n * It is the first line of defense against invalid edit operations since it's the only way to open a\n * calendar editor for an event that's not brand new or to delete an event/parts of it.\n *\n * it is also responsible for divining the users intent before starting any operations so we can make sure we have the right\n * information available, like when editing all event occurrences or only some.\n */\nexport class CalendarEventPopup implements ModalComponent {\n\tprivate readonly _shortcuts: Shortcut[] = []\n\tprivate readonly sanitizedDescription: string\n\tprivate dom: HTMLElement | null = null\n\tprivate focusedBeforeShown: HTMLElement | null = null\n\n\t/**\n\t * @param model\n\t * @param eventBubbleRect the rect where the event bubble was displayed that was clicked (if any)\n\t * @param htmlSanitizer\n\t */\n\tconstructor(private readonly model: CalendarEventPreviewViewModel, private readonly eventBubbleRect: PosRect, htmlSanitizer: HtmlSanitizer) {\n\t\t// We receive the HtmlSanitizer from outside and do the sanitization inside, so that we don't have to just assume it was already done\n\t\tthis.sanitizedDescription = prepareCalendarDescription(\n\t\t\tmodel.calendarEvent.description,\n\t\t\t(s) =>\n\t\t\t\thtmlSanitizer.sanitizeHTML(convertTextToHtml(s), {\n\t\t\t\t\tblockExternalContent: true,\n\t\t\t\t}).html,\n\t\t)\n\n\t\tthis.setupShortcuts()\n\t\tthis.view = this.view.bind(this)\n\t}\n\n\tprivate readonly handleDeleteButtonClick: (ev: MouseEvent, receiver: HTMLElement) => void = async (ev: MouseEvent, receiver: HTMLElement) => {\n\t\tshowDeletePopup(this.model, ev, receiver, () => this.close())\n\t}\n\n\tprivate readonly handleEditButtonClick: (ev: MouseEvent, receiver: HTMLElement) => void = (ev: MouseEvent, receiver: HTMLElement) => {\n\t\tif (this.model.isRepeatingForEditing) {\n\t\t\tcreateAsyncDropdown({\n\t\t\t\tlazyButtons: () =>\n\t\t\t\t\tPromise.resolve([\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: \"updateOneCalendarEvent_action\",\n\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t// noinspection JSIgnoredPromiseFromCall\n\t\t\t\t\t\t\t\tthis.model.editSingle()\n\t\t\t\t\t\t\t\tthis.close()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: \"updateAllCalendarEvents_action\",\n\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t// noinspection JSIgnoredPromiseFromCall\n\t\t\t\t\t\t\t\tthis.model.editAll()\n\t\t\t\t\t\t\t\tthis.close()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t]),\n\t\t\t\twidth: 300,\n\t\t\t})(ev, receiver)\n\t\t} else {\n\t\t\t// noinspection JSIgnoredPromiseFromCall\n\t\t\tthis.model.editAll()\n\t\t\tthis.close()\n\t\t}\n\t}\n\n\t// we handle askForUpdates here to avoid making a request if not necessary\n\tprivate readonly handleSendUpdatesClick: () => void = async () => {\n\t\tconst confirmed = await Dialog.confirm(\"sendUpdates_msg\")\n\t\tif (confirmed) await this.model.sendUpdates()\n\t\tthis.close()\n\t}\n\n\tview(): Children {\n\t\treturn m(\n\t\t\t\".abs.elevated-bg.plr.pb.border-radius.dropdown-shadow.flex.flex-column\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\t// minus margin, need to apply it now to not overflow later\n\t\t\t\t\twidth: px(Math.min(window.innerWidth - DROPDOWN_MARGIN * 2, 400)),\n\t\t\t\t\t// see hack description below\n\t\t\t\t\topacity: \"0\",\n\t\t\t\t\t// because calendar event bubbles have 1px border, we want to align\n\t\t\t\t\tmargin: \"1px\",\n\t\t\t\t},\n\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\tthis.dom = vnode.dom as HTMLElement\n\t\t\t\t\t// This is a hack to get \"natural\" view size but render it without opacity first and then show dropdown with inferred\n\t\t\t\t\t// size.\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tshowDropdown(this.eventBubbleRect, this.dom!, this.dom!.offsetHeight, 400)\n\t\t\t\t\t\t// Move the keyboard focus into the popup's buttons when it is shown\n\t\t\t\t\t\tconst firstButton = vnode.dom.firstElementChild?.firstElementChild as HTMLInputElement | null\n\t\t\t\t\t\tfirstButton?.focus()\n\t\t\t\t\t}, 24)\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(\".flex.flex-end\", [this.renderSendUpdateButton(), this.renderEditButton(), this.renderDeleteButton(), this.renderCloseButton()]),\n\t\t\t\tm(\".flex-grow.scroll.visible-scrollbar\", [\n\t\t\t\t\tm(EventPreviewView, {\n\t\t\t\t\t\tevent: this.model.calendarEvent,\n\t\t\t\t\t\tsanitizedDescription: this.sanitizedDescription,\n\t\t\t\t\t\t// closing this since repeated edit operations from the popup would always\n\t\t\t\t\t\t// use the version of the event the popup was opened with, which means the next\n\t\t\t\t\t\t// click uses an outdated version.\n\t\t\t\t\t\tparticipation: this.model.getParticipationSetterAndThen(() => this.close()),\n\t\t\t\t\t} satisfies EventPreviewViewAttrs),\n\t\t\t\t]),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderEditButton(): Children {\n\t\tif (!this.model.canEdit) return null\n\t\treturn m(IconButton, { title: \"edit_action\", icon: Icons.Edit, click: this.handleEditButtonClick })\n\t}\n\n\tprivate renderDeleteButton(): Children {\n\t\tif (!this.model.canDelete) return null\n\t\treturn m(IconButton, { title: \"delete_action\", icon: Icons.Trash, click: this.handleDeleteButtonClick })\n\t}\n\n\tprivate renderSendUpdateButton(): Children {\n\t\tif (!this.model.canSendUpdates) return null\n\t\treturn m(IconButton, {\n\t\t\ttitle: \"sendUpdates_label\",\n\t\t\tclick: () => this.handleSendUpdatesClick(),\n\t\t\ticon: BootIcons.Mail,\n\t\t})\n\t}\n\n\tprivate renderCloseButton(): Children {\n\t\treturn m(IconButton, {\n\t\t\ttitle: \"close_alt\",\n\t\t\tclick: () => this.close(),\n\t\t\ticon: Icons.Cancel,\n\t\t})\n\t}\n\n\tshow() {\n\t\tthis.focusedBeforeShown = document.activeElement as HTMLElement\n\t\tmodal.display(this, false)\n\t}\n\n\tprivate close() {\n\t\tmodal.remove(this)\n\t}\n\n\tbackgroundClick(e: MouseEvent): void {\n\t\tmodal.remove(this)\n\t}\n\n\thideAnimation(): Promise<void> {\n\t\treturn Promise.resolve()\n\t}\n\n\tonClose(): void {\n\t\tthis.close()\n\t}\n\n\tshortcuts(): Shortcut[] {\n\t\treturn this._shortcuts\n\t}\n\n\tpopState(e: Event): boolean {\n\t\tmodal.remove(this)\n\t\treturn false\n\t}\n\n\tcallingElement(): HTMLElement | null {\n\t\treturn this.focusedBeforeShown\n\t}\n\n\tprivate setupShortcuts() {\n\t\tconst close: Shortcut = {\n\t\t\tkey: Keys.ESC,\n\t\t\texec: () => this.close(),\n\t\t\thelp: \"close_alt\",\n\t\t}\n\t\tconst edit: Shortcut = {\n\t\t\tkey: Keys.E,\n\t\t\texec: () => this.handleEditButtonClick(new MouseEvent(\"click\", {}), this.dom!),\n\t\t\thelp: \"edit_action\",\n\t\t}\n\t\tconst sendUpdates: Shortcut = {\n\t\t\tkey: Keys.R,\n\t\t\texec: this.handleSendUpdatesClick,\n\t\t\thelp: \"sendUpdates_label\",\n\t\t}\n\t\tconst remove: Shortcut = {\n\t\t\tkey: Keys.DELETE,\n\t\t\texec: () => this.handleDeleteButtonClick(new MouseEvent(\"click\", {}), this.dom!),\n\t\t\thelp: \"delete_action\",\n\t\t}\n\n\t\tthis._shortcuts.push(close)\n\n\t\tif (this.model.canSendUpdates) {\n\t\t\tthis._shortcuts.push(sendUpdates)\n\t\t}\n\n\t\tif (this.model.canEdit) {\n\t\t\tthis._shortcuts.push(edit)\n\t\t}\n\n\t\tif (this.model.canDelete) {\n\t\t\tthis._shortcuts.push(remove)\n\t\t}\n\t}\n}\n"],"mappings":"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"}