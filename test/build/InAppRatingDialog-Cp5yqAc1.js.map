{"version":3,"file":"InAppRatingDialog-Cp5yqAc1.js","names":["selectedValue: AppRatingValue","choice: AppRatingValue","headerBarProps: DialogHeaderBarAttrs"],"sources":["../../src/common/ratings/InAppRatingDialog.ts"],"sourcesContent":["import { Dialog, DialogType } from \"../gui/base/Dialog.js\"\nimport m from \"mithril\"\nimport { deviceConfig } from \"../misc/DeviceConfig.js\"\nimport { createEvent, getRatingAllowed, isEventHappyMoment, RatingCheckResult } from \"./InAppRatingUtils.js\"\nimport { isIOSApp } from \"../api/common/Env.js\"\nimport { locator } from \"../api/main/CommonLocator.js\"\nimport { Button, ButtonType } from \"../gui/base/Button.js\"\nimport { DefaultAnimationTime } from \"../gui/animation/Animations.js\"\nimport { neverNull, resolveMaybeLazy } from \"@tutao/tutanota-utils\"\nimport { Keys } from \"../api/common/TutanotaConstants.js\"\nimport { DialogHeaderBarAttrs } from \"../gui/base/DialogHeaderBar.js\"\nimport { BaseButton, BaseButtonAttrs } from \"../gui/base/buttons/BaseButton.js\"\nimport { theme } from \"../gui/theme.js\"\nimport { px, size } from \"../gui/size.js\"\nimport { client } from \"../misc/ClientDetector.js\"\nimport { lang } from \"../misc/LanguageViewModel.js\"\nimport { DateTime } from \"luxon\"\n\nconst enum AppRatingValue {\n\tHappy = \"happy\",\n\tUnhappy = \"unhappy\",\n\tNotNow = \"notNow\",\n}\n\n/**\n * Displays the application rating dialog to the user and handles their selection.\n *\n * The dialog provides options for users to rate their experience as positive or negative,\n * or to dismiss the dialog with actions such as \"Not now\".\" Based on\n * the user's choice, appropriate follow-up actions are taken:\n *\n * - **Happy**: Prompts the user to leave a review on the App Store. Will not ask for a review again within one year.\n * - **Unhappy**: No immediate action; the user is not redirected. Will not ask for a review again within one year.\n * - **Not now**: Prevents the dialog from being shown for one month.\n *\n * @returns {Promise<void>} Resolves after the user makes a selection and associated actions are completed.\n */\nexport async function showAppRatingDialog(): Promise<void> {\n\tconst selectedValue: AppRatingValue = await new Promise((resolve) => {\n\t\tconst choose = (choice: AppRatingValue) => {\n\t\t\tdialog.close()\n\t\t\tsetTimeout(() => resolve(choice), DefaultAnimationTime)\n\t\t}\n\n\t\tconst headerBarProps: DialogHeaderBarAttrs = {\n\t\t\tright: [\n\t\t\t\t{\n\t\t\t\t\tlabel: \"notNow_label\",\n\t\t\t\t\tclick: () => choose(AppRatingValue.NotNow),\n\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t},\n\t\t\t],\n\t\t}\n\n\t\tconst columnClass = \".flex-half.overflow-hidden\"\n\n\t\tconst dialog = new Dialog(DialogType.EditSmall, {\n\t\t\tview: () =>\n\t\t\t\tm(\"\", [\n\t\t\t\t\tm(\".dialog-header.plr-l.flex-space-between.dialog-header-line-height\", [\n\t\t\t\t\t\tm(columnClass + \".ml-negative-s\"),\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\tcolumnClass + \".mr-negative-s.flex.justify-end\",\n\t\t\t\t\t\t\tresolveMaybeLazy(neverNull(headerBarProps.right)).map((a) => m(Button, a)),\n\t\t\t\t\t\t),\n\t\t\t\t\t]),\n\t\t\t\t\tm(\n\t\t\t\t\t\t\".plr-l.pb-ml.text-break\",\n\t\t\t\t\t\tm(\".flex.flex-column\", [\n\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\"#dialog-message.dialog-max-height.text-break.text-prewrap.selectable.scroll\",\n\t\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\t\"\",\n\t\t\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\t\t\".flex-center.mt-m\",\n\t\t\t\t\t\t\t\t\t\tm(\"img.pb.pt.block.height-100p\", {\n\t\t\t\t\t\t\t\t\t\t\tsrc: `${window.tutao.appState.prefixWithoutFile}/images/rating/${client.isCalendarApp() ? \"calendar\" : \"mail\"}.png`,\n\t\t\t\t\t\t\t\t\t\t\talt: \"\",\n\t\t\t\t\t\t\t\t\t\t\trel: \"noreferrer\",\n\t\t\t\t\t\t\t\t\t\t\tloading: \"lazy\",\n\t\t\t\t\t\t\t\t\t\t\tdecoding: \"async\",\n\t\t\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\t\t\twidth: \"80%\",\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\tm(\"h1.text-center\", lang.get(\"ratingHowAreWeDoing_title\")),\n\t\t\t\t\t\t\t\t\tm(\"p.text-center\", lang.get(\"ratingExplanation_msg\")),\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\".flex.flex-column.mt\",\n\t\t\t\t\t\t\t\t{ style: { gap: \"1em\" } },\n\t\t\t\t\t\t\t\tm(BaseButton, {\n\t\t\t\t\t\t\t\t\tlabel: \"ratingLoveIt_label\",\n\t\t\t\t\t\t\t\t\ttext: lang.get(\"ratingLoveIt_label\"),\n\t\t\t\t\t\t\t\t\tonclick: () => choose(AppRatingValue.Happy),\n\t\t\t\t\t\t\t\t\tclass: `full-width border-radius-small center b flash accent-bg button-content`,\n\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\theight: px(size.button_height + size.vpad_xs * 1.5),\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t} satisfies BaseButtonAttrs),\n\n\t\t\t\t\t\t\t\tm(BaseButton, {\n\t\t\t\t\t\t\t\t\tlabel: \"ratingNeedsWork_label\",\n\t\t\t\t\t\t\t\t\ttext: lang.get(\"ratingNeedsWork_label\"),\n\t\t\t\t\t\t\t\t\tonclick: () => choose(AppRatingValue.Unhappy),\n\t\t\t\t\t\t\t\t\tclass: `full-width border-radius-small center b flash`,\n\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\tborder: `2px solid ${theme.content_accent}`,\n\t\t\t\t\t\t\t\t\t\theight: px(size.button_height + size.vpad_xs * 1.5),\n\t\t\t\t\t\t\t\t\t\tcolor: theme.content_accent,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t} satisfies BaseButtonAttrs),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t]),\n\t\t\t\t\t),\n\t\t\t\t]),\n\t\t}).addShortcut({\n\t\t\thelp: \"close_alt\",\n\t\t\tkey: Keys.ESC,\n\t\t\texec: () => choose(AppRatingValue.NotNow),\n\t\t})\n\n\t\tdialog.show()\n\t})\n\n\thandleRatingDialogSelection(selectedValue)\n}\n\nfunction handleRatingDialogSelection(selectedValue: AppRatingValue) {\n\tswitch (selectedValue) {\n\t\tcase AppRatingValue.Unhappy:\n\t\t\tdeviceConfig.setLastRatingPromptedDate(new Date())\n\t\t\tbreak\n\t\tcase AppRatingValue.NotNow:\n\t\t\t// Ask again in minimum one month from now.\n\t\t\tdeviceConfig.setRetryRatingPromptAfter(DateTime.now().plus({ months: 1 }).toJSDate())\n\t\t\tbreak\n\t\tcase AppRatingValue.Happy: {\n\t\t\tdeviceConfig.setLastRatingPromptedDate(new Date())\n\n\t\t\tvoid locator.systemFacade.requestInAppRating()\n\t\t\tbreak\n\t\t}\n\t}\n}\n\n/**\n * If the client is on iOS, we save the current date as an event to determine if we want to trigger a \"rate Tuta\" dialog.\n */\nexport async function handleRatingByEvent() {\n\tconst isTheIOSApp = isIOSApp()\n\n\tif (isTheIOSApp) {\n\t\tcreateEvent(deviceConfig)\n\t}\n\n\tconst now = new Date()\n\n\tif ((await getRatingAllowed(now, deviceConfig, isTheIOSApp)) === RatingCheckResult.RATING_ALLOWED) {\n\t\tif (isEventHappyMoment(now, deviceConfig)) {\n\t\t\tvoid showAppRatingDialog()\n\t\t}\n\t}\n}\n"],"mappings":"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"}