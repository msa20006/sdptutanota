
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { mithril_default } from "./mithril-Csg4iNnm.js";
import { downcast, errorToString, neverNull, stringToUtf8Uint8Array, typedKeys, uint8ArrayToString } from "./dist-CJHwsXKY.js";
import { Mode, isApp, isDesktop } from "./Env-D5xGlXfw.js";
import { lang } from "./LanguageViewModel-BNC5ekpO.js";
import { px } from "./HtmlUtils-C-ecR7U7.js";
import { ErrorReportClientType, client } from "./ClientDetector-D0v6Vqu6.js";
import { AccountType, ConversationType, Keys, MailMethod } from "./TutanotaConstants-3bwAESYA.js";
import { Button, ButtonType } from "./Icon-BuqNK7vz.js";
import { Dialog, DialogType, TextField, TextFieldType } from "./Dialog-B6-HFvZd.js";
import { require_stream } from "./stream-u2PttBAC.js";
import { convertTextToHtml } from "./Formatter-zB15D6XI.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import { RecipientType } from "./Recipient-BFxhfecW.js";
import { show } from "./NotificationOverlay-C-YNCUiT.js";
import { Checkbox } from "./Checkbox-WCw-l_7A.js";
import { ExpanderButton, ExpanderPanel } from "./Expander-Bautb1_0.js";
import { copyToClipboard } from "./ClipboardUtils-mz40UK5S.js";
import { ReportErrorService, createErrorReportData, createErrorReportFile, createReportErrorIn } from "./Services-CupYet_j.js";
import { BubbleButton } from "./BubbleButton-DGGInJMg.js";

//#region ../src/common/api/common/Logger.ts
const LOG_SIZE = 1e3;
var Logger = class {
	_entries;
	_index;
	_dateProvider;
	constructor(dateProvider = () => new Date()) {
		this._entries = new Array(LOG_SIZE);
		this._index = 0;
		this._dateProvider = dateProvider;
	}
	logInfo(...args) {
		this.log("I", args);
	}
	logError(...args) {
		this.log("E", args);
	}
	logWarn(...args) {
		this.log("W", args);
	}
	log(level, args) {
		const entry = [this._dateProvider(), level];
		entry.push(...args);
		this._entries[this._index] = entry;
		this._index++;
		if (this._index === LOG_SIZE) this._index = 0;
	}
	formatLogEntry(date, level, ...rest) {
		const formattedArgs = rest.map((obj) => {
			try {
				return obj instanceof Error ? errorToString(Object.assign({ stack: null }, obj)) : JSON.stringify(obj);
			} catch (e) {
				return "[cyclic object]";
			}
		});
		const message = formattedArgs.join(",");
		return `${date.toISOString()} ${level} ${message}`;
	}
	getEntries() {
		const newerPart = this._entries.slice(0, this._index);
		const olderPart = this._entries.slice(this._index);
		return olderPart.concat(newerPart).filter(Boolean).map(([date, level, ...rest]) => {
			return this.formatLogEntry(date, level, ...rest);
		});
	}
};
function createLogFile(content, scope, timestamp) {
	const data = stringToUtf8Uint8Array(content);
	const timestampString = timestamp ? timestamp + "_" : "";
	return {
		_type: "DataFile",
		name: timestampString + scope + "_tutanota.log",
		mimeType: "text/plain",
		data,
		size: data.byteLength,
		id: undefined
	};
}

//#endregion
//#region ../src/common/misc/ErrorReporter.ts
var import_stream = __toESM(require_stream(), 1);
async function showErrorNotification(e) {
	const loggedIn = locator.logins.isUserLoggedIn();
	const logs = await getLogAttachments();
	const { decision, ignore } = await showErrorOverlay();
	if (decision === "cancel") return { ignored: ignore };
	const preparedContent = prepareFeedbackContent(e, loggedIn);
	const reportDialogResult = await showReportDialog(preparedContent.subject, preparedContent.message, logs);
	if (reportDialogResult.decision === "cancel") return { ignored: ignore };
	preparedContent.logs = reportDialogResult.sendLogs ? logs : [];
	preparedContent.message = reportDialogResult.userMessage + "\n" + preparedContent.message;
	sendToServer(e, reportDialogResult.userMessage, reportDialogResult.sendLogs ? logs : []);
	sendFeedbackMail(preparedContent);
	return { ignored: ignore };
}
async function showErrorOverlay() {
	let ignore = false;
	const decision = await new Promise((resolve) => {
		show({ view: () => mithril_default("", ["An error occurred", mithril_default(Checkbox, {
			label: () => "Ignore the error for this session",
			checked: ignore,
			onChecked: (checked) => ignore = checked
		})]) }, {
			label: "close_alt",
			click: () => resolve("cancel")
		}, [{
			label: "sendReport_label",
			click: () => resolve("send"),
			type: ButtonType.Secondary
		}]);
	});
	return {
		decision,
		ignore
	};
}
function showReportDialog(subject, message, logs) {
	let sendLogs = true;
	let detailsExpanded = false;
	let userMessage = "";
	const dialogContent = { view: () => {
		return [
			mithril_default(TextField, {
				label: "yourMessage_label",
				helpLabel: () => lang.get("feedbackOnErrorInfo_msg"),
				value: userMessage,
				type: TextFieldType.Area,
				oninput: (value) => userMessage = value
			}),
			mithril_default(Checkbox, {
				label: () => lang.get("sendLogs_action"),
				helpLabel: "sendLogsInfo_msg",
				checked: sendLogs,
				onChecked: (checked) => sendLogs = checked
			}),
			mithril_default(".flex.flex-column.space-around.items-center", logs.map((l) => mithril_default(BubbleButton, {
				label: lang.makeTranslation("filename", l.name),
				onclick: () => showLogDialog(l.name, uint8ArrayToString("utf-8", l.data))
			}))),
			mithril_default(".flex-end", mithril_default(".right", mithril_default(ExpanderButton, {
				label: "details_label",
				expanded: detailsExpanded,
				onExpandedChange: (expanded) => detailsExpanded = expanded
			}))),
			mithril_default(ExpanderPanel, { expanded: detailsExpanded }, mithril_default(".selectable", [mithril_default(".selectable", subject), message.split("\n").map((l) => l.trim() === "" ? mithril_default(".pb", "") : mithril_default("", l))]))
		];
	} };
	return new Promise((resolve) => {
		Dialog.showActionDialog({
			okActionTextId: "send_action",
			title: "sendErrorReport_action",
			type: DialogType.EditMedium,
			child: dialogContent,
			okAction: (dialog) => {
				resolve({
					decision: "send",
					sendLogs,
					userMessage
				});
				dialog.close();
			},
			cancelAction: () => resolve({ decision: "cancel" })
		});
	});
}
/**
* show the contents of a log file in a large dialog.
* @param heading the title of the dialog
* @param text the text to display
*/
async function showLogDialog(heading, text) {
	let logDialog;
	const closeLogDialog = () => logDialog?.close();
	logDialog = Dialog.largeDialog({
		right: [{
			label: "ok_action",
			click: closeLogDialog,
			type: ButtonType.Secondary
		}],
		middle: lang.makeTranslation("heading", heading)
	}, { view: () => mithril_default(".white-space-pre.pt.pb.selectable", text) }).addShortcut({
		key: Keys.ESC,
		exec: closeLogDialog,
		help: "close_alt"
	}).setCloseHandler(closeLogDialog).show();
}
async function showErrorDialogNotLoggedIn(e) {
	const content = prepareFeedbackContent(e, false);
	const expanded = (0, import_stream.default)(false);
	const message = content.subject + "\n\n" + content.message;
	const info = () => [mithril_default(".flex.col.items-end.plr", { style: { marginTop: "-16px" } }, [mithril_default("div.mr-negative-xs", mithril_default(ExpanderButton, {
		expanded: expanded(),
		onExpandedChange: expanded,
		label: "showMore_action"
	}))]), mithril_default(ExpanderPanel, { expanded: expanded() }, [mithril_default(".flex-end.plr", mithril_default(Button, {
		label: "copy_action",
		click: () => copyToClipboard(message),
		type: ButtonType.Secondary
	})), mithril_default(".plr.selectable.pb.scroll.text-pre", { style: { height: px(200) } }, message)])];
	return Dialog.message("unknownError_msg", info);
}
async function sendFeedbackMail(content) {
	const name = "";
	const mailAddress = "reports@tutao.de";
	const escapedBody = new Option(content.message).innerHTML;
	const logins = locator.logins;
	const draft = await locator.mailFacade.createDraft({
		subject: content.subject,
		bodyText: convertTextToHtml(escapedBody),
		senderMailAddress: neverNull(logins.getUserController().userGroupInfo.mailAddress),
		senderName: "",
		toRecipients: [{
			name,
			address: mailAddress
		}],
		ccRecipients: [],
		bccRecipients: [],
		conversationType: ConversationType.NEW,
		previousMessageId: null,
		attachments: content.logs,
		confidential: true,
		replyTos: [],
		method: MailMethod.NONE
	});
	await locator.mailFacade.sendDraft(draft, [{
		name,
		address: mailAddress,
		type: RecipientType.INTERNAL,
		contact: null
	}], "de");
}
async function sendToServer(error, userMessage, logs) {
	function getReportingClientType() {
		if (env.mode === Mode.Browser) return ErrorReportClientType.Browser;
else switch (env.platformId) {
			case "ios": return ErrorReportClientType.Ios;
			case "android": return ErrorReportClientType.Android;
			case "darwin": return ErrorReportClientType.MacOS;
			case "linux": return ErrorReportClientType.Linux;
			case "win32": return ErrorReportClientType.Windows;
			default: return ErrorReportClientType.Linux;
		}
	}
	const clientType = getReportingClientType();
	const errorData = createReportErrorIn({
		data: createErrorReportData({
			clientType,
			appVersion: env.versionNumber,
			userId: locator.logins.getUserController().userId,
			errorClass: error.name ?? "?",
			errorMessage: error.message,
			userMessage,
			stackTrace: error.stack ?? "",
			additionalInfo: client.userAgent,
			time: new Date()
		}),
		files: logs.map((log) => {
			const stringData = uint8ArrayToString("utf-8", log.data);
			return createErrorReportFile({
				name: log.name,
				content: stringData
			});
		})
	});
	await locator.serviceExecutor.post(ReportErrorService, errorData);
}
function prepareFeedbackContent(error, loggedIn) {
	const timestamp = new Date();
	let { message, client: client$1, type } = clientInfoString(timestamp, loggedIn);
	if (error) message += errorToString(error);
	const subject = `Feedback v${env.versionNumber} - ${error && error.name ? error.name : "?"} - ${type} - ${client$1}`;
	return {
		message,
		subject,
		logs: []
	};
}
function clientInfoString(timestamp, loggedIn) {
	const type = loggedIn ? neverNull(typedKeys(AccountType).find((typeName) => AccountType[typeName] === locator.logins.getUserController().user.accountType)) : "UNKNOWN";
	const client$1 = (() => {
		switch (env.mode) {
			case Mode.Browser:
			case Mode.Test: return env.mode;
			default: return env.platformId ?? "";
		}
	})();
	let message = `\n\n Client: ${client$1}`;
	message += `\n Type: ${type}`;
	message += `\n Tutanota version: ${env.versionNumber}`;
	message += `\n Timestamp (UTC): ${timestamp.toUTCString()}`;
	message += `\n User agent:\n${navigator.userAgent}` + "\n";
	return {
		message,
		client: client$1,
		type
	};
}
async function getLogAttachments(timestamp) {
	const logs = [];
	const global = downcast(window);
	if (global.logger) {
		const mainEntries = global.logger.getEntries();
		const mainLogFile = createLogFile(mainEntries.join("\n"), "main", timestamp?.getTime());
		logs.push(mainLogFile);
		const workerLogEntries = await locator.workerFacade.getLog();
		const workerLogFile = await createLogFile(workerLogEntries.join("\n"), "worker", timestamp?.getTime());
		logs.push(workerLogFile);
	}
	if (isDesktop() || isApp()) {
		const nativeLog = await locator.commonSystemFacade.getLog();
		const nativeLogFile = createLogFile(nativeLog, isDesktop() ? "desktop" : "device", timestamp?.getTime());
		logs.push(nativeLogFile);
	}
	return logs;
}

//#endregion
export { LOG_SIZE, Logger, clientInfoString, getLogAttachments, sendFeedbackMail, showErrorDialogNotLoggedIn, showErrorNotification };
//# sourceMappingURL=ErrorReporter-7sfLhWZg.js.map