{"version":3,"file":"CalendarEventPreviewViewModel-CWG_-5I4.js","names":["event: MouseEvent","classes: Array<string>","disabled: boolean","expanded: boolean","placeholder?: Children","options: Stream<Array<U>>","dom: HTMLElement","onSelect: (option: U) => void","renderOptions: (option: U) => Children","keepFocus: boolean","selected?: T","onClose?: () => void","dropdownPosition?: \"top\" | \"bottom\"","optionListContainer: OptionListContainer","option: U","dom","selected: T | undefined","e: KeyboardEvent","callback: (option: U) => void","container: OptionListContainer","items: Stream<Array<unknown>>","buildFunction: (option: unknown) => Children","width: number","vnode: VnodeDOM<HTMLElement>","children","ev: EventRedraw<Event>","e: MouseEvent","origin: PosRect","e: Event","attrs: InputAttrs<T>","inputPadding?: string","vnode: VnodeDOM<InputAttrs<T>>","classes: Array<string>","disabled: boolean","node: VnodeDOM<SelectAttributes<GuestItem, RecipientSearchResultItem>>","selected: boolean","option: GuestItem","attrs: GuestPickerAttrs","guest: RecipientSearchResultItem","e: MouseEvent","val: string","event: FocusEvent","e: any","event: KeyboardEvent","forward: boolean","selectSuggestion: boolean","vnode: Vnode<PasswordInputAttributes, this>","e: KeyboardEvent","checked: boolean","onclick: (checked: boolean) => unknown","disabled: boolean | undefined","classes: Array<string>","disabled: boolean","variant: SwitchVariant","attrs: AttendeeListEditorAttrs","organizer: Guest | null","guestItems: (() => Children)[]","password: string","strength: number","whoModel: CalendarEventWhoModel","logins: LoginController","recipientsSearch: RecipientsSearchModel","model: CalendarEventWhoModel","model: CalendarEventModel","organizer","guest: Guest","password?: string","strength?: number","rightContent: Children","address: string","status: CalendarAttendeeStatus","forward: boolean","size: number","onClick: ClickHandler","size","event: MouseEvent","variant?: InputButtonVariant","variant: InputButtonVariant","classes: Array<string>","disabled: boolean","event: InputEvent","newValue: string","input: any","event: KeyboardEvent","key: KeyPress","date: Date | null | undefined","nullSelectionText: MaybeTranslation | null","e: MouseEvent","text: string","onDateSelected: DatePickerAttrs[\"onDateSelected\"]","date: Date","disabled: boolean | undefined","onDateSelected: (date: Date) => unknown","vnode: Vnode<VisualDatePickerAttrs>","size","index: number","attrs: VisualDatePickerAttrs","previousElement: HTMLElement","dayElement: globalThis.Element | null | undefined","target: HTMLInputElement","weekDay: number","week: ReadonlyArray<CalendarDay>","wide: boolean","weekdays: readonly string[]","times: string[]","attrs: TimePickerAttrs","event: InputEvent","option: TimeOption","val: string","e: MouseEvent","event: FocusEvent","e: any","vnode: Vnode<EventTimeEditorAttrs>","vnode: Vnode<RemindersEditorAttrs>","newAlarm: AlarmInterval","alarms: readonly AlarmInterval[]","removeAlarm: (alarm: AlarmInterval) => unknown","addNewAlarm: (newAlarm: AlarmInterval) => void","textFieldAttrs: Array<TextFieldAttrs>","addAlarm: (alarm: AlarmInterval) => unknown","option: RemindersSelectOption","hasAlarms: boolean","isDisplay: boolean","onAddAction: (value: number, unit: AlarmIntervalUnit) => void","timeReminderUnit: AlarmIntervalUnit","selectedValue: AlarmIntervalUnit","dialog: Dialog","groupName: MaybeTranslation","option: RadioGroupOption<T>","selectedOption: T | null","optionClass: string | undefined","onOptionSelected: (arg0: T) => unknown","injectionMap?: Map<string, Child>","event: KeyboardEvent","key: string","period: RepeatPeriod","interval: number","endTime: EndType","option: RepeatRuleOption","attrs: RepeatRuleEditorAttrs","option: EndType","customRuleOptions: RadioGroupOption<RepeatPeriod>[]","option: RepeatPeriod","whenModel: CalendarEventWhenModel","customRule: Partial<{ interval: number; intervalFrequency: RepeatPeriod }>","val: string","e: MouseEvent","event: FocusEvent","vnode: Vnode<CalendarEventEditViewAttrs>","allowRendering: boolean","vnode: VnodeDOM<CalendarEventEditViewAttrs>","attrs: CalendarEventEditViewAttrs","newValue: any","message: TranslationKey","event: MouseEvent","target: EditorPages","navigationCallback: (targetPage: EditorPages) => unknown","options: CalendarSelectItem[]","selected: CalendarSelectItem","option: CalendarSelectItem","isSelected: boolean","isDisplay: boolean","newValue: string","rule: CalendarRepeatRule | null","isAllDay: boolean","okAction: (dom: HTMLElement) => unknown","event: MouseEvent","dom: HTMLElement","model: CalendarEventModel","responseMail: Mail | null","handler: EditDialogOkHandler","groupColors: Map<Id, string>","defaultAlarms: Map<Id, AlarmInterval[]>","descriptionEditor: HtmlEditor","targetPage: EditorPages","dialog: Dialog","okAction: EditDialogOkHandler","identity: CalendarEventIdentity","calendarEvent: Readonly<CalendarEvent>","calendarModel: CalendarModel","eventType: EventType","hasBusinessFeature: boolean","ownAttendee: CalendarEventAttendee | null","lazyIndexEntry: () => Promise<CalendarEventUidIndexEntry | null>","eventModelFactory: (mode: CalendarOperation) => Promise<CalendarEventModel | null>","uiUpdateCallback: () => void","m","action: Thunk","status: CalendarAttendeeStatus"],"sources":["../../src/common/gui/base/Card.ts","../../src/common/gui/base/Select.ts","../../src/common/gui/base/SingleLineTextField.ts","../../src/calendar-app/calendar/gui/pickers/GuestPicker.ts","../../src/common/gui/PasswordInput.ts","../../src/common/gui/base/Switch.ts","../../src/common/gui/Divider.ts","../../src/calendar-app/calendar/gui/eventeditor-view/AttendeeListEditor.ts","../../src/common/gui/base/buttons/ArrowButton.ts","../../src/common/gui/base/InputButton.ts","../../src/calendar-app/calendar/gui/pickers/DatePicker.ts","../../src/calendar-app/calendar/gui/pickers/TimePicker.ts","../../src/calendar-app/calendar/gui/eventeditor-view/EventTimeEditor.ts","../../src/calendar-app/calendar/gui/RemindersEditor.ts","../../src/common/gui/base/RadioGroup.ts","../../src/calendar-app/calendar/gui/eventeditor-view/RepeatRuleEditor.ts","../../src/calendar-app/calendar/gui/eventeditor-view/CalendarEventEditView.ts","../../src/calendar-app/calendar/gui/eventeditor-view/CalendarEventEditDialog.ts","../../src/calendar-app/calendar/gui/eventpopup/CalendarEventPreviewViewModel.ts"],"sourcesContent":["import m, { Children, ClassComponent, Vnode } from \"mithril\"\n\nexport interface CardAttrs {\n\trootElementType?: \"div\" | \"section\"\n\tclasses?: Array<string>\n\tstyle?: Partial<Pick<CSSStyleDeclaration, \"padding\">>\n}\n\ntype HTMLElementWithAttrs = Partial<Pick<m.Attributes, \"class\"> & Omit<HTMLElement, \"style\"> & CardAttrs>\n\n/**\n * Simple card component\n * @see Component attributes: {CardAttrs}\n * @example\n * m(Card, {\n *     rootElementType: \"section\", // Changing the default root element\n *     classes: [\"mt\"], // Adding new styles\n *     style: {\n *         \"font-size\": px(size.font_size_base * 1.25) // Overriding the component style\n *     }\n * }, m(\"span\", \"Child span text\")),\n */\nexport class Card implements ClassComponent<CardAttrs> {\n\tview({ attrs, children }: Vnode<CardAttrs, this>): Children | void | null {\n\t\treturn m(\n\t\t\t`${attrs.rootElementType ?? \"div\"}.tutaui-card-container`,\n\t\t\t{\n\t\t\t\tclass: attrs.classes?.join(\" \"),\n\t\t\t\tstyle: attrs.style,\n\t\t\t} satisfies HTMLElementWithAttrs,\n\t\t\tchildren,\n\t\t)\n\t}\n}\n","import m, { Children, ClassComponent, Vnode, VnodeDOM } from \"mithril\"\nimport { modal, ModalComponent } from \"./Modal.js\"\nimport { assertNotNull } from \"@tutao/tutanota-utils\"\nimport { px, size } from \"../size.js\"\nimport { Keys, TabIndex } from \"../../api/common/TutanotaConstants.js\"\nimport { focusNext, focusPrevious, isKeyPressed, Shortcut } from \"../../misc/KeyManager.js\"\nimport { type PosRect, showDropdown } from \"./Dropdown.js\"\nimport { lang } from \"../../misc/LanguageViewModel.js\"\nimport { Icon, IconSize } from \"./Icon.js\"\nimport { ButtonColor, getColors } from \"./Button.js\"\nimport { AriaRole } from \"../AriaUtils.js\"\nimport Stream from \"mithril/stream\"\nimport { getSafeAreaInsetBottom, getSafeAreaInsetTop } from \"../HtmlUtils.js\"\nimport { theme } from \"../theme.js\"\nimport { BootIcons } from \"./icons/BootIcons.js\"\n\nexport interface SelectOption<T> {\n\t// Here we declare everything that is important to use at the select option\n\tvalue: T\n\tariaValue: string\n}\n\nexport interface SelectAttributes<U extends SelectOption<T>, T> {\n\tonchange: (newValue: U) => void\n\toptions: Stream<Array<U>>\n\t/**\n\t * This attribute is responsible to render the options inside the dropdown.\n\t * @example\n\t * const renderOption = (option: U) => m(\"span\", option.text);\n\t * ...\n\t * renderOption(currentOption)\n\t * ...\n\t * @param {U} option - Option to be rendered\n\t * @returns {Children} Returns the rendered option\n\t */\n\trenderOption: (option: U) => Children\n\t/**\n\t * This attribute is responsible to render the selected option inside the trigger.\n\t * @example\n\t * const renderSelected = (option: U) => m(\"span\", option.text);\n\t * ...\n\t * renderSelected(currentOption)\n\t * ...\n\t * @param {U} option - Option to be rendered\n\t * @returns {Children} Returns the rendered option\n\t */\n\trenderDisplay: (option: U) => Children\n\tariaLabel: string\n\tid?: string\n\tclasses?: Array<string>\n\tselected?: U\n\tplaceholder?: Children\n\texpanded?: boolean\n\tdisabled?: boolean\n\tnoIcon?: boolean\n\t/**\n\t * @example\n\t * const attrs = {\n\t *     ...\n\t *     iconColor: \"#202020\"\n\t *     ...\n\t * }\n\t */\n\ticonColor?: string\n\tkeepFocus?: boolean\n\ttabIndex?: number\n\tonclose?: () => void\n\toncreate?: (...args: any[]) => unknown\n\tdropdownPosition?: \"top\" | \"bottom\"\n}\n\ntype HTMLElementWithAttrs = Partial<Pick<m.Attributes, \"class\"> & Omit<HTMLButtonElement, \"style\"> & SelectAttributes<SelectOption<unknown>, unknown>>\n\nexport interface SelectState {\n\tdropdownContainer?: OptionListContainer\n}\n\n/**\n * Select component\n * @see Component attributes: {SelectAttributes}\n * @example\n *\n * interface CalendarSelectItem extends SelectOption<string> {\n *   color: string\n * \t name: string\n * }\n *\n * m(Select<CalendarSelectItem, string>, {\n *   classes: [\"custom-margins\"],\n *   onChange: (val) => {\n * \t   this.selected = val\n *   },\n * \t options: this.options,\n * \t expanded: true,\n * \t selected: this.selected,\n * \t renderOption: (option) => {\n * \t   return m(\".flex.items-center.gap-vpad-xs\", [\n * \t     m(\"div\", { style: { width: \"24px\", height: \"24px\", borderRadius: \"50%\", backgroundColor: option.color } }),\n *       m(\"span\", option.name),\n * \t   ])\n * \t },\n * \t renderDisplay: (option) => m(\"span\", { style: { color: \"red\" } }, option.name),\n * \t ariaLabel: \"Calendar\"\n * }),\n */\nexport class Select<U extends SelectOption<T>, T> implements ClassComponent<SelectAttributes<U, T>> {\n\tprivate isExpanded: boolean = false\n\tprivate dropdownContainer?: OptionListContainer\n\tprivate key: number = 0\n\n\tview({\n\t\tattrs: {\n\t\t\tonchange,\n\t\t\toptions,\n\t\t\trenderOption,\n\t\t\trenderDisplay,\n\t\t\tclasses,\n\t\t\tselected,\n\t\t\tplaceholder,\n\t\t\texpanded,\n\t\t\tdisabled,\n\t\t\tariaLabel,\n\t\t\ticonColor,\n\t\t\tid,\n\t\t\tnoIcon,\n\t\t\tkeepFocus,\n\t\t\ttabIndex,\n\t\t\tonclose,\n\t\t\tdropdownPosition,\n\t\t},\n\t}: Vnode<SelectAttributes<U, T>, this>) {\n\t\treturn m(\n\t\t\t\"button.tutaui-select-trigger.clickable\",\n\t\t\t{\n\t\t\t\tid,\n\t\t\t\tclass: this.resolveClasses(classes, disabled, expanded),\n\t\t\t\tonclick: (event: MouseEvent) =>\n\t\t\t\t\tevent.currentTarget &&\n\t\t\t\t\tthis.renderDropdown(\n\t\t\t\t\t\toptions,\n\t\t\t\t\t\tevent.currentTarget as HTMLElement,\n\t\t\t\t\t\tonchange,\n\t\t\t\t\t\trenderOption,\n\t\t\t\t\t\tkeepFocus ?? false,\n\t\t\t\t\t\tselected?.value,\n\t\t\t\t\t\tonclose,\n\t\t\t\t\t\tdropdownPosition,\n\t\t\t\t\t),\n\t\t\t\trole: AriaRole.Combobox,\n\t\t\t\tariaLabel,\n\t\t\t\tdisabled: disabled,\n\t\t\t\tariaExpanded: String(this.isExpanded),\n\t\t\t\ttabIndex: tabIndex ?? Number(disabled ? TabIndex.Programmatic : TabIndex.Default),\n\t\t\t\tvalue: selected?.ariaValue,\n\t\t\t} satisfies HTMLElementWithAttrs,\n\t\t\t[\n\t\t\t\tselected != null ? renderDisplay(selected) : this.renderPlaceholder(placeholder),\n\t\t\t\tnoIcon !== true\n\t\t\t\t\t? m(Icon, {\n\t\t\t\t\t\t\ticon: BootIcons.Expand,\n\t\t\t\t\t\t\tcontainer: \"div\",\n\t\t\t\t\t\t\tclass: `fit-content transition-transform`,\n\t\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\tfill: iconColor ?? getColors(ButtonColor.Content).button,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t  })\n\t\t\t\t\t: null,\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate resolveClasses(classes: Array<string> = [], disabled: boolean = false, expanded: boolean = false) {\n\t\tconst classList = [...classes]\n\t\tif (disabled) {\n\t\t\tclassList.push(\"disabled\", \"click-disabled\")\n\t\t} else {\n\t\t\tclassList.push(\"flash\")\n\t\t}\n\n\t\tif (expanded) {\n\t\t\tclassList.push(\"full-width\")\n\t\t} else {\n\t\t\tclassList.push(\"fit-content\")\n\t\t}\n\n\t\treturn classList.join(\" \")\n\t}\n\n\tprivate renderPlaceholder(placeholder?: Children): Children {\n\t\tif (placeholder == null || typeof placeholder === \"string\") {\n\t\t\treturn m(\"span.placeholder\", placeholder ?? lang.get(\"noSelection_msg\"))\n\t\t}\n\n\t\treturn placeholder\n\t}\n\n\tprivate renderDropdown(\n\t\toptions: Stream<Array<U>>,\n\t\tdom: HTMLElement,\n\t\tonSelect: (option: U) => void,\n\t\trenderOptions: (option: U) => Children,\n\t\tkeepFocus: boolean,\n\t\tselected?: T,\n\t\tonClose?: () => void,\n\t\tdropdownPosition?: \"top\" | \"bottom\",\n\t) {\n\t\tconst optionListContainer: OptionListContainer = new OptionListContainer(\n\t\t\toptions,\n\t\t\t(option: U) => {\n\t\t\t\treturn m.fragment(\n\t\t\t\t\t{\n\t\t\t\t\t\tkey: ++this.key,\n\t\t\t\t\t\toncreate: ({ dom }: VnodeDOM<U>) => this.setupOption(dom as HTMLElement, onSelect, option, optionListContainer, selected),\n\t\t\t\t\t},\n\t\t\t\t\t[renderOptions(option)],\n\t\t\t\t)\n\t\t\t},\n\t\t\tdom.getBoundingClientRect().width,\n\t\t\tkeepFocus,\n\t\t\tdropdownPosition,\n\t\t)\n\n\t\toptionListContainer.onClose = () => {\n\t\t\toptionListContainer.close()\n\t\t\tonClose?.()\n\t\t\tthis.isExpanded = false\n\t\t}\n\n\t\toptionListContainer.setOrigin(dom.getBoundingClientRect())\n\n\t\tthis.isExpanded = true\n\t\tthis.dropdownContainer = optionListContainer\n\t\tmodal.displayUnique(optionListContainer, false)\n\t}\n\n\tprivate setupOption(dom: HTMLElement, onSelect: (option: U) => void, option: U, optionListContainer: OptionListContainer, selected: T | undefined) {\n\t\tdom.onclick = this.wrapOnChange.bind(this, onSelect, option, optionListContainer)\n\n\t\tif (!(\"disabled\" in dom)) {\n\t\t\t// We have to set the tabIndex to make sure that it'll be focusable by tabbing\n\t\t\tdom.tabIndex = Number(TabIndex.Default)\n\n\t\t\t// We have to set the cursor pointer as a fallback of renderOptions that doesn't set it\n\t\t\tif (!dom.style.cursor) {\n\t\t\t\tdom.style.cursor = \"pointer\"\n\t\t\t}\n\n\t\t\tif (!dom.role) {\n\t\t\t\tdom.role = AriaRole.Option\n\t\t\t}\n\n\t\t\tdom.ariaSelected = `${selected === option.value}`\n\t\t}\n\n\t\tdom.onkeydown = (e: KeyboardEvent) => {\n\t\t\tif (isKeyPressed(e.key, Keys.SPACE, Keys.RETURN)) {\n\t\t\t\te.preventDefault()\n\t\t\t\tthis.wrapOnChange(onSelect, option, optionListContainer)\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate wrapOnChange(callback: (option: U) => void, option: U, container: OptionListContainer) {\n\t\tcallback(option)\n\t\tcontainer.onClose()\n\t}\n}\n\nclass OptionListContainer implements ModalComponent {\n\tprivate domDropdown: HTMLElement | null = null\n\tview: ModalComponent[\"view\"]\n\torigin: PosRect | null = null\n\tshortcuts: (...args: Array<any>) => any\n\tprivate readonly width: number\n\tprivate domContents: HTMLElement | null = null\n\tprivate maxHeight: number | null = null\n\tprivate focusedBeforeShown: HTMLElement | null = document.activeElement as HTMLElement\n\tprivate children: Children[] = []\n\n\tconstructor(\n\t\tprivate readonly items: Stream<Array<unknown>>,\n\t\tprivate readonly buildFunction: (option: unknown) => Children,\n\t\twidth: number,\n\t\tkeepFocus: boolean,\n\t\tdropdownPosition?: \"top\" | \"bottom\",\n\t) {\n\t\tthis.width = width\n\t\tthis.shortcuts = this.buildShortcuts\n\n\t\tthis.items.map((newItems) => {\n\t\t\tthis.children = []\n\t\t\tthis.children.push(newItems.length === 0 ? this.renderNoItem() : newItems.map((item) => this.buildFunction(item)))\n\t\t})\n\n\t\tthis.view = () => {\n\t\t\treturn m(\n\t\t\t\t\".dropdown-panel-scrollable.elevated-bg.border-radius.dropdown-shadow.fit-content\",\n\t\t\t\t{\n\t\t\t\t\toncreate: (vnode: VnodeDOM<HTMLElement>) => {\n\t\t\t\t\t\tthis.domDropdown = vnode.dom as HTMLElement\n\t\t\t\t\t\t// It is important to set initial opacity so that user doesn't see it with full opacity before animating.\n\t\t\t\t\t\tthis.domDropdown.style.opacity = \"0\"\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tm(\n\t\t\t\t\t\".dropdown-content.scroll.flex.flex-column\",\n\t\t\t\t\t{\n\t\t\t\t\t\trole: AriaRole.Listbox,\n\t\t\t\t\t\ttabindex: TabIndex.Programmatic,\n\t\t\t\t\t\toncreate: (vnode: VnodeDOM<HTMLElement>) => {\n\t\t\t\t\t\t\tthis.domContents = vnode.dom as HTMLElement\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonupdate: (vnode: VnodeDOM<HTMLElement>) => {\n\t\t\t\t\t\t\tif (this.maxHeight == null) {\n\t\t\t\t\t\t\t\tconst children = Array.from(vnode.dom.children) as Array<HTMLElement>\n\t\t\t\t\t\t\t\tthis.maxHeight = Math.min(\n\t\t\t\t\t\t\t\t\t400 + size.vpad,\n\t\t\t\t\t\t\t\t\tchildren.reduce((accumulator, children) => accumulator + children.offsetHeight, 0) + size.vpad,\n\t\t\t\t\t\t\t\t) // size.pad accounts for top and bottom padding\n\n\t\t\t\t\t\t\t\tif (this.origin) {\n\t\t\t\t\t\t\t\t\t// The dropdown-content element is added to the dom has a hidden element first.\n\t\t\t\t\t\t\t\t\t// The maxHeight is available after the first onupdate call. Then this promise will resolve and we can safely\n\t\t\t\t\t\t\t\t\t// show the dropdown.\n\t\t\t\t\t\t\t\t\t// Modal always schedules redraw in oncreate() of a component so we are guaranteed to have onupdate() call.\n\t\t\t\t\t\t\t\t\tshowDropdown(this.origin, assertNotNull(this.domDropdown), this.maxHeight, this.width, dropdownPosition).then(() => {\n\t\t\t\t\t\t\t\t\t\tconst selectedOption = vnode.dom.querySelector(\"[aria-selected='true']\") as HTMLElement | null\n\t\t\t\t\t\t\t\t\t\tif (selectedOption && !keepFocus) {\n\t\t\t\t\t\t\t\t\t\t\tselectedOption.focus()\n\t\t\t\t\t\t\t\t\t\t} else if (!keepFocus && (!this.domDropdown || focusNext(this.domDropdown))) {\n\t\t\t\t\t\t\t\t\t\t\tthis.domContents?.focus()\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.updateDropdownSize(vnode)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tonscroll: (ev: EventRedraw<Event>) => {\n\t\t\t\t\t\t\tconst target = ev.target as HTMLElement\n\t\t\t\t\t\t\t// needed here to prevent flickering on ios\n\t\t\t\t\t\t\tev.redraw =\n\t\t\t\t\t\t\t\tthis.domContents != null && target.scrollTop < 0 && target.scrollTop + this.domContents.offsetHeight > target.scrollHeight\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tthis.children,\n\t\t\t\t),\n\t\t\t)\n\t\t}\n\t}\n\n\tprivate updateDropdownSize(vnode: VnodeDOM<HTMLElement>) {\n\t\tif (!(this.origin && this.domDropdown)) {\n\t\t\treturn\n\t\t}\n\n\t\tconst upperSpace = this.origin.top - getSafeAreaInsetTop()\n\t\tconst lowerSpace = window.innerHeight - this.origin.bottom - getSafeAreaInsetBottom()\n\n\t\tconst children = Array.from(vnode.dom.children) as Array<HTMLElement>\n\t\tconst contentHeight = Math.min(400 + size.vpad, children.reduce((accumulator, children) => accumulator + children.offsetHeight, 0) + size.vpad)\n\n\t\tthis.maxHeight = lowerSpace > upperSpace ? Math.min(contentHeight, lowerSpace) : Math.min(contentHeight, upperSpace)\n\t\tconst newHeight = px(this.maxHeight)\n\t\tif (this.domDropdown.style.height !== newHeight) this.domDropdown.style.height = newHeight\n\t}\n\n\tprivate renderNoItem(): Children {\n\t\treturn m(\"span.placeholder.text-center\", { color: theme.list_message_bg }, lang.get(\"noEntries_msg\"))\n\t}\n\n\tbackgroundClick = (e: MouseEvent) => {\n\t\tif (\n\t\t\tthis.domDropdown &&\n\t\t\t!(e.target as HTMLElement).classList.contains(\"doNotClose\") &&\n\t\t\t(this.domDropdown.contains(e.target as HTMLElement) || this.domDropdown.parentNode === e.target)\n\t\t) {\n\t\t\tthis.onClose()\n\t\t}\n\t}\n\n\tbuildShortcuts(): Array<Shortcut> {\n\t\treturn [\n\t\t\t{\n\t\t\t\tkey: Keys.ESC,\n\t\t\t\texec: () => this.onClose(),\n\t\t\t\thelp: \"close_alt\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.TAB,\n\t\t\t\tshift: true,\n\t\t\t\texec: () => (this.domDropdown ? focusPrevious(this.domDropdown) : false),\n\t\t\t\thelp: \"selectPrevious_action\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.TAB,\n\t\t\t\tshift: false,\n\t\t\t\texec: () => (this.domDropdown ? focusNext(this.domDropdown) : false),\n\t\t\t\thelp: \"selectNext_action\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.UP,\n\t\t\t\texec: () => (this.domDropdown ? focusPrevious(this.domDropdown) : false),\n\t\t\t\thelp: \"selectPrevious_action\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tkey: Keys.DOWN,\n\t\t\t\texec: () => (this.domDropdown ? focusNext(this.domDropdown) : false),\n\t\t\t\thelp: \"selectNext_action\",\n\t\t\t},\n\t\t]\n\t}\n\n\tsetOrigin(origin: PosRect): this {\n\t\tthis.origin = origin\n\t\treturn this\n\t}\n\n\tclose(): void {\n\t\tmodal.remove(this)\n\t}\n\n\thideAnimation(): Promise<void> {\n\t\treturn Promise.resolve()\n\t}\n\n\tonClose(): void {\n\t\tthis.close()\n\t}\n\n\tpopState(e: Event): boolean {\n\t\tthis.onClose()\n\t\treturn false\n\t}\n\n\tcallingElement(): HTMLElement | null {\n\t\treturn this.focusedBeforeShown\n\t}\n}\n","import m, { Children, ClassComponent, Component, Vnode, VnodeDOM } from \"mithril\"\nimport { TextFieldType } from \"./TextField.js\"\nimport { AllIcons, Icon, IconSize } from \"./Icon.js\"\nimport { px, size } from \"../size.js\"\nimport { filterInt } from \"@tutao/tutanota-utils\"\n\nexport enum InputMode {\n\tNONE = \"none\",\n\tNUMERIC = \"numeric\",\n\tTEXT = \"text\",\n}\n\nexport interface SingleLineTextFieldAttrs<T extends TextFieldType> extends Pick<Component, \"oncreate\"> {\n\tvalue: string | number\n\tariaLabel: string\n\tdisabled?: boolean\n\t/**\n\t * Callback fired whenever the input is interacted with.\n\t * This property is mandatory if the input is interactive (disabled = false).\n\t * @example\n\t * // Save the typed value to a model object\n\t * const callback = (typedValue: string) => model.value = typedValue;\n\t * m(SingleLineTextField, {oninput: callback})\n\t * @param {string} newValue - String value typed on the input field\n\t * @returns {unknown} Return type depends on the callback provided\n\t */\n\toninput?: (newValue: string) => unknown\n\tplaceholder?: string\n\tclasses?: Array<string>\n\tstyle?: Partial<Pick<CSSStyleDeclaration, \"padding\" | \"fontSize\" | \"textAlign\">>\n\tonclick?: (...args: unknown[]) => unknown\n\tonfocus?: (...args: unknown[]) => unknown\n\tonblur?: (...args: unknown[]) => unknown\n\tonkeydown?: (...args: unknown[]) => unknown\n\ttype: T\n\tleadingIcon?: {\n\t\ticon: AllIcons\n\t\tcolor: string\n\t}\n\tinputMode?: InputMode\n\treadonly?: boolean\n}\n\nexport interface SingleLineNumberFieldAttrs<T extends TextFieldType> extends SingleLineTextFieldAttrs<T> {\n\tmax?: number\n\tmin?: number\n}\n\nexport type InputAttrs<T extends TextFieldType> = T extends TextFieldType.Number ? SingleLineNumberFieldAttrs<T> : SingleLineTextFieldAttrs<T>\n\n/**\n * Simple single line input field component\n * @see Component attributes: {SingleLineTextFieldAttrs}\n * @example\n * m(SingleLineTextField, {\n *     value: model.value,\n *     ariaLabel: lange.get(\"placeholder\"),\n *     oninput: (newValue: string) => {\n *         model.value = newValue\n *     },\n *     placeholder: lang.get(\"placeholder\"),\n *     disabled: model.isReadonly,\n *     classes: [\"custom-text-color\"], // Adding new styles\n *     style: {\n *         \"font-size\": px(size.font_size_base * 1.25) // Overriding the component style\n *     }\n * }),\n */\nexport class SingleLineTextField<T extends TextFieldType> implements ClassComponent<InputAttrs<T>> {\n\tdomInput!: HTMLInputElement\n\n\tview({ attrs }: Vnode<InputAttrs<T>, this>): Children | void | null {\n\t\treturn attrs.leadingIcon ? this.renderInputWithIcon(attrs) : this.renderInput(attrs)\n\t}\n\n\tprivate renderInputWithIcon(attrs: InputAttrs<T>) {\n\t\tif (!attrs.leadingIcon) {\n\t\t\treturn\n\t\t}\n\n\t\tconst fontSizeString = attrs.style?.fontSize\n\t\tconst fontSizeNumber = fontSizeString ? filterInt(fontSizeString.replace(\"px\", \"\")) : NaN\n\t\tconst fontSize = isNaN(fontSizeNumber) ? 16 : fontSizeNumber\n\t\tlet iconSize\n\t\tlet padding\n\n\t\tif (fontSize > 16 && fontSize < 32) {\n\t\t\ticonSize = IconSize.Large\n\t\t\tpadding = size.icon_size_large\n\t\t} else if (fontSize > 32) {\n\t\t\ticonSize = IconSize.XL\n\t\t\tpadding = size.icon_size_xl\n\t\t} else {\n\t\t\ticonSize = IconSize.Medium\n\t\t\tpadding = size.icon_size_medium_large\n\t\t}\n\n\t\treturn m(\".rel.flex.flex-grow\", [\n\t\t\tm(\n\t\t\t\t\".abs.pl-vpad-s.flex.items-center\",\n\t\t\t\t{ style: { top: 0, bottom: 0 } },\n\t\t\t\tm(Icon, {\n\t\t\t\t\tsize: iconSize,\n\t\t\t\t\ticon: attrs.leadingIcon.icon,\n\t\t\t\t\tstyle: { fill: attrs.leadingIcon.color },\n\t\t\t\t}),\n\t\t\t),\n\t\t\tthis.renderInput(attrs, px(padding + size.vpad)),\n\t\t])\n\t}\n\n\tprivate renderInput(attrs: InputAttrs<T>, inputPadding?: string) {\n\t\treturn m(\"input.tutaui-text-field\", {\n\t\t\tariaLabel: attrs.ariaLabel,\n\t\t\tvalue: attrs.value,\n\t\t\tdisabled: attrs.disabled ?? false,\n\t\t\tonblur: attrs.onblur,\n\t\t\tonfocus: attrs.onfocus,\n\t\t\tonkeydown: attrs.onkeydown,\n\t\t\tonclick: attrs.onclick,\n\t\t\toninput: () => {\n\t\t\t\tif (!attrs.oninput) {\n\t\t\t\t\tconsole.error(\"oninput fired without a handler function\")\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tattrs.oninput(this.domInput.value)\n\t\t\t},\n\t\t\toncreate: (vnode: VnodeDOM<InputAttrs<T>>) => {\n\t\t\t\tthis.domInput = vnode.dom as HTMLInputElement\n\t\t\t\tif (attrs.oncreate) {\n\t\t\t\t\tattrs.oncreate(vnode)\n\t\t\t\t}\n\t\t\t},\n\t\t\tplaceholder: attrs.placeholder,\n\t\t\tclass: this.resolveClasses(attrs.classes, attrs.disabled),\n\t\t\tstyle: {\n\t\t\t\t...(inputPadding ? { paddingLeft: inputPadding } : {}),\n\t\t\t\t...attrs.style,\n\t\t\t},\n\t\t\ttype: attrs.inputMode === InputMode.NONE ? undefined : attrs.type,\n\t\t\tinputMode: attrs.inputMode,\n\t\t\treadonly: attrs.readonly,\n\t\t\t...this.getInputProperties(attrs),\n\t\t})\n\t}\n\n\tprivate getInputProperties(attrs: InputAttrs<T>): Pick<SingleLineNumberFieldAttrs<TextFieldType.Number>, \"min\" | \"max\"> | undefined {\n\t\tif (attrs.type === TextFieldType.Number) {\n\t\t\tconst numberAttrs = attrs as SingleLineNumberFieldAttrs<TextFieldType.Number>\n\t\t\treturn { min: numberAttrs.min, max: numberAttrs.max }\n\t\t}\n\n\t\treturn undefined\n\t}\n\n\tprivate resolveClasses(classes: Array<string> = [], disabled: boolean = false): string {\n\t\tconst classList = [...classes]\n\t\tif (disabled) {\n\t\t\tclassList.push(\"disabled\")\n\t\t}\n\n\t\treturn classList.join(\" \")\n\t}\n}\n","import m, { ClassComponent, Vnode, VnodeDOM } from \"mithril\"\nimport { Select, SelectAttributes, SelectOption, SelectState } from \"../../../../common/gui/base/Select.js\"\nimport { Keys, TabIndex } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport { SingleLineTextField } from \"../../../../common/gui/base/SingleLineTextField.js\"\nimport { debounceStart, getFirstOrThrow } from \"@tutao/tutanota-utils\"\nimport { Dialog } from \"../../../../common/gui/base/Dialog.js\"\nimport { lang, TranslationKey } from \"../../../../common/misc/LanguageViewModel.js\"\nimport { parseMailAddress, parsePastedInput, parseTypedInput } from \"../../../../common/gui/MailRecipientsTextField.js\"\nimport { Contact } from \"../../../../common/api/entities/tutanota/TypeRefs.js\"\nimport { RecipientSearchResultItem, RecipientsSearchModel } from \"../../../../common/misc/RecipientsSearchModel.js\"\nimport stream from \"mithril/stream\"\nimport { keyboardEventToKeyPress } from \"../../../../common/misc/KeyManager.js\"\nimport { theme } from \"../../../../common/gui/theme.js\"\nimport { Icons } from \"../../../../common/gui/base/icons/Icons.js\"\nimport { Icon } from \"../../../../common/gui/base/Icon.js\"\nimport { px, size } from \"../../../../common/gui/size.js\"\nimport { DefaultAnimationTime } from \"../../../../common/gui/animation/Animations.js\"\nimport { TextFieldType } from \"../../../../common/gui/base/TextField.js\"\n\nexport interface GuestPickerAttrs {\n\tariaLabel: TranslationKey\n\tonRecipientAdded: (address: string, name: string | null, contact: Contact | null) => void\n\tdisabled: boolean\n\tsearch: RecipientsSearchModel\n}\n\ninterface GuestItem extends SelectOption<RecipientSearchResultItem> {\n\tname: string\n\taddress?: string\n\ttype: string\n}\n\nexport class GuestPicker implements ClassComponent<GuestPickerAttrs> {\n\tprivate isExpanded: boolean = false\n\tprivate isFocused: boolean = false\n\tprivate value: string = \"\"\n\tprivate selected?: GuestItem\n\tprivate options: stream<Array<GuestItem>> = stream([])\n\tprivate selectDOM: VnodeDOM<SelectAttributes<GuestItem, RecipientSearchResultItem>> | null = null\n\n\tview({ attrs }: Vnode<GuestPickerAttrs>) {\n\t\treturn m(Select<GuestItem, RecipientSearchResultItem>, {\n\t\t\tclasses: [\"flex-grow\"],\n\t\t\tdropdownPosition: \"bottom\",\n\t\t\tonchange: ({ value: guest }) => {\n\t\t\t\tthis.handleSelection(attrs, guest)\n\t\t\t},\n\t\t\tonclose: () => {\n\t\t\t\tthis.isExpanded = false\n\t\t\t},\n\t\t\toncreate: (node: VnodeDOM<SelectAttributes<GuestItem, RecipientSearchResultItem>>) => {\n\t\t\t\tthis.selectDOM = node\n\t\t\t},\n\t\t\tselected: this.selected,\n\t\t\tariaLabel: attrs.ariaLabel,\n\t\t\tdisabled: attrs.disabled,\n\t\t\toptions: this.options,\n\t\t\tnoIcon: true,\n\t\t\texpanded: true,\n\t\t\ttabIndex: Number(TabIndex.Programmatic),\n\t\t\tplaceholder: this.renderSearchInput(attrs),\n\t\t\trenderDisplay: () => this.renderSearchInput(attrs),\n\t\t\trenderOption: (option) => this.renderSuggestionItem(option === this.selected, option),\n\t\t\tkeepFocus: true,\n\t\t} satisfies SelectAttributes<GuestItem, RecipientSearchResultItem>)\n\t}\n\n\tprivate renderSuggestionItem(selected: boolean, option: GuestItem) {\n\t\tconst firstRow =\n\t\t\toption.value.type === \"recipient\"\n\t\t\t\t? option.value.value.name\n\t\t\t\t: m(Icon, {\n\t\t\t\t\t\ticon: Icons.People,\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tfill: theme.content_fg,\n\t\t\t\t\t\t\t\"aria-describedby\": lang.get(\"contactListName_label\"),\n\t\t\t\t\t\t},\n\t\t\t\t  })\n\t\tconst secondRow = option.value.type === \"recipient\" ? option.value.value.address : option.value.value.name\n\t\treturn m(\n\t\t\t\".pt-s.pb-s.click.content-hover.button-min-height\",\n\t\t\t{\n\t\t\t\tclass: selected ? \"content-accent-fg row-selected icon-accent\" : \"\",\n\t\t\t\tstyle: {\n\t\t\t\t\t\"padding-left\": selected ? px(size.hpad_large - 3) : px(size.hpad_large),\n\t\t\t\t\t\"border-left\": selected ? \"3px solid\" : null,\n\t\t\t\t},\n\t\t\t},\n\t\t\t[m(\".small.full-width.text-ellipsis\", firstRow), m(\".name.full-width.text-ellipsis\", secondRow)],\n\t\t)\n\t}\n\n\tprivate async handleSelection(attrs: GuestPickerAttrs, guest: RecipientSearchResultItem) {\n\t\tif (guest.value != null) {\n\t\t\tif (guest.type === \"recipient\") {\n\t\t\t\tconst { address, name, contact } = guest.value\n\t\t\t\tattrs.onRecipientAdded(address, name, contact)\n\t\t\t\tattrs.search.clear()\n\t\t\t\tthis.value = \"\"\n\t\t\t} else {\n\t\t\t\tthis.value = \"\"\n\t\t\t\tconst recipients = await attrs.search.resolveContactList(guest.value)\n\t\t\t\tfor (const { address, name, contact } of recipients) {\n\t\t\t\t\tattrs.onRecipientAdded(address, name, contact)\n\t\t\t\t}\n\t\t\t\tattrs.search.clear()\n\t\t\t\tm.redraw()\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate renderSearchInput(attrs: GuestPickerAttrs) {\n\t\treturn m(SingleLineTextField, {\n\t\t\tclasses: [\"height-100p\"],\n\t\t\tvalue: this.value,\n\t\t\tplaceholder: lang.get(\"addGuest_label\"),\n\t\t\tonclick: (e: MouseEvent) => {\n\t\t\t\te.stopImmediatePropagation()\n\t\t\t\tif (!this.isExpanded && this.value.length > 0 && this.selectDOM) {\n\t\t\t\t\t;(this.selectDOM.dom as HTMLElement).click()\n\t\t\t\t\tthis.isExpanded = true\n\t\t\t\t}\n\t\t\t},\n\t\t\toninput: (val: string) => {\n\t\t\t\tif (val.length > 0 && !this.isExpanded && this.selectDOM) {\n\t\t\t\t\t;(this.selectDOM.dom as HTMLElement).click()\n\t\t\t\t\tthis.isExpanded = true\n\t\t\t\t}\n\n\t\t\t\t// if the new text length is more than one character longer,\n\t\t\t\t// it means the user pasted the text in, so we want to try and resolve a list of contacts\n\t\t\t\tconst { remainingText, newRecipients, errors } = val.length - this.value.length > 1 ? parsePastedInput(val) : parseTypedInput(val)\n\n\t\t\t\tfor (const { address, name } of newRecipients) {\n\t\t\t\t\tattrs.onRecipientAdded(address, name, null)\n\t\t\t\t}\n\n\t\t\t\tif (errors.length === 1 && newRecipients.length === 0) {\n\t\t\t\t\t// if there was a single recipient and it was invalid then just pretend nothing happened\n\t\t\t\t\tthis.value = getFirstOrThrow(errors)\n\t\t\t\t} else {\n\t\t\t\t\tif (errors.length > 0) {\n\t\t\t\t\t\tDialog.message(lang.makeTranslation(\"error_message\", `${lang.get(\"invalidPastedRecipients_msg\")}\\n\\n${errors.join(\"\\n\")}`))\n\t\t\t\t\t}\n\t\t\t\t\tthis.value = remainingText\n\t\t\t\t}\n\n\t\t\t\tthis.doSearch(val, attrs)\n\t\t\t},\n\t\t\tdisabled: attrs.disabled,\n\t\t\tariaLabel: attrs.ariaLabel,\n\t\t\tonfocus: (event: FocusEvent) => {\n\t\t\t\tthis.isFocused = true\n\t\t\t},\n\t\t\tonblur: (e: any) => {\n\t\t\t\tif (this.isFocused) {\n\t\t\t\t\tthis.resolveInput(attrs, false)\n\t\t\t\t\tthis.isFocused = false\n\t\t\t\t}\n\n\t\t\t\te.redraw = false\n\t\t\t},\n\t\t\tonkeydown: (event: KeyboardEvent) => this.handleKeyDown(event, attrs),\n\t\t\ttype: TextFieldType.Text,\n\t\t})\n\t}\n\n\tprivate doSearch = debounceStart(DefaultAnimationTime, (val: string, attrs: GuestPickerAttrs) => {\n\t\tattrs.search.search(val).then(() => {\n\t\t\tconst searchResult = attrs.search.results()\n\n\t\t\tif (searchResult.length === 0) {\n\t\t\t\tthis.selected = undefined\n\t\t\t}\n\n\t\t\tthis.options(\n\t\t\t\tsearchResult.map((option) => ({\n\t\t\t\t\tname: option.value.name,\n\t\t\t\t\tvalue: option,\n\t\t\t\t\ttype: option.type,\n\t\t\t\t\tariaValue: option.value.name,\n\t\t\t\t})),\n\t\t\t)\n\n\t\t\tm.redraw()\n\t\t})\n\t})\n\n\tprivate handleKeyDown(event: KeyboardEvent, attrs: GuestPickerAttrs) {\n\t\tconst keyPress = keyboardEventToKeyPress(event)\n\n\t\tswitch (keyPress.key.toLowerCase()) {\n\t\t\tcase Keys.RETURN.code:\n\t\t\t\tthis.resolveInput(attrs, true)\n\t\t\t\tbreak\n\t\t\tcase Keys.DOWN.code:\n\t\t\t\tthis.moveSelection(true)\n\t\t\t\tevent.stopImmediatePropagation()\n\t\t\t\treturn false\n\t\t\tcase Keys.UP.code:\n\t\t\t\tthis.moveSelection(false)\n\t\t\t\tevent.stopImmediatePropagation()\n\t\t\t\treturn false\n\t\t}\n\n\t\treturn true\n\t}\n\n\tprivate moveSelection(forward: boolean) {\n\t\tconst selectedIndex = this.selected ? this.options().indexOf(this.selected) : -1\n\t\tconst optionsLength = this.options().length\n\n\t\tlet newIndex\n\t\tif (forward) {\n\t\t\tnewIndex = selectedIndex + 1 < optionsLength ? selectedIndex + 1 : 0\n\t\t} else {\n\t\t\tnewIndex = selectedIndex - 1 >= 0 ? selectedIndex - 1 : optionsLength - 1\n\t\t}\n\n\t\tthis.selected = this.options()[newIndex]\n\t}\n\n\tprivate async selectSuggestion(attrs: GuestPickerAttrs) {\n\t\tif (this.selected == null) {\n\t\t\treturn\n\t\t}\n\n\t\tif (this.selected.value.type === \"recipient\") {\n\t\t\tconst { address, name, contact } = this.selected.value.value\n\t\t\tattrs.onRecipientAdded(address, name, contact)\n\t\t\tattrs.search.clear()\n\t\t\tthis.value = \"\"\n\t\t} else {\n\t\t\tattrs.search.clear()\n\t\t\tthis.value = \"\"\n\t\t\tconst recipients = await attrs.search.resolveContactList(this.selected.value.value)\n\t\t\tfor (const { address, name, contact } of recipients) {\n\t\t\t\tattrs.onRecipientAdded(address, name, contact)\n\t\t\t}\n\t\t\tm.redraw()\n\t\t}\n\n\t\tthis.closePicker()\n\t}\n\n\t/**\n\t * Resolves a typed in mail address or one of the suggested ones.\n\t * @param attrs\n\t * @param selectSuggestion boolean value indicating whether a suggestion should be selected or not. Should be true if a suggestion is explicitly selected by\n\t * for example hitting the enter key and false e.g. if the dialog is closed\n\t */\n\tprivate resolveInput(attrs: GuestPickerAttrs, selectSuggestion: boolean) {\n\t\tconst suggestions = attrs.search.results()\n\t\tif (suggestions.length > 0 && selectSuggestion) {\n\t\t\tthis.selectSuggestion(attrs)\n\t\t} else {\n\t\t\tconst parsed = parseMailAddress(this.value)\n\t\t\tif (parsed != null) {\n\t\t\t\tattrs.onRecipientAdded(parsed.address, parsed.name, null)\n\t\t\t\tthis.value = \"\"\n\t\t\t\tthis.closePicker()\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate closePicker() {\n\t\tif (this.selectDOM) {\n\t\t\t;(this.selectDOM.state as SelectState).dropdownContainer?.onClose()\n\t\t}\n\t}\n}\n","import m, { Children, ClassComponent, Vnode } from \"mithril\"\nimport { SingleLineTextField } from \"./base/SingleLineTextField.js\"\nimport { TextFieldType } from \"./base/TextField.js\"\nimport { IconButton } from \"./base/IconButton.js\"\nimport { ButtonSize } from \"./base/ButtonSize.js\"\nimport { Icons } from \"./base/icons/Icons.js\"\nimport { theme } from \"./theme.js\"\nimport { scaleToVisualPasswordStrength } from \"../misc/passwords/PasswordUtils.js\"\nimport { px, size } from \"./size.js\"\nimport { lang } from \"../misc/LanguageViewModel.js\"\n\nexport interface PasswordInputAttributes {\n\tariaLabel: string\n\tpassword: string\n\tstrength: number\n\toninput: (newValue: string) => unknown\n\tshowStrength?: boolean\n}\n\nexport class PasswordInput implements ClassComponent<PasswordInputAttributes> {\n\tprivate showPassword: boolean = false\n\n\tview(vnode: Vnode<PasswordInputAttributes, this>): Children {\n\t\treturn m(\".flex.flex-grow.full-width.justify-between.items-center.gap-vpad-s\", [\n\t\t\tvnode.attrs.showStrength\n\t\t\t\t? m(\"div\", {\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\twidth: px(size.icon_size_medium),\n\t\t\t\t\t\t\theight: px(size.icon_size_medium),\n\t\t\t\t\t\t\tborder: `1px solid ${theme.content_button}`,\n\t\t\t\t\t\t\tborderRadius: \"50%\",\n\t\t\t\t\t\t\tbackground: `conic-gradient(from .25turn, ${theme.content_button} ${scaleToVisualPasswordStrength(\n\t\t\t\t\t\t\t\tvnode.attrs.strength,\n\t\t\t\t\t\t\t)}%, transparent 0%)`,\n\t\t\t\t\t\t},\n\t\t\t\t  })\n\t\t\t\t: null,\n\t\t\tm(SingleLineTextField, {\n\t\t\t\tclasses: [\"flex-grow\"],\n\t\t\t\tariaLabel: vnode.attrs.ariaLabel,\n\t\t\t\ttype: this.showPassword ? TextFieldType.Text : TextFieldType.Password,\n\t\t\t\tvalue: vnode.attrs.password,\n\t\t\t\toninput: vnode.attrs.oninput,\n\t\t\t\tstyle: {\n\t\t\t\t\tpadding: `${px(size.vpad_xsm)} ${px(size.vpad_small)}`,\n\t\t\t\t},\n\t\t\t\tplaceholder: lang.get(\"password_label\"),\n\t\t\t}),\n\t\t\tm(IconButton, {\n\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\ttitle: this.showPassword ? \"concealPassword_action\" : \"revealPassword_action\",\n\t\t\t\ticon: this.showPassword ? Icons.NoEye : Icons.Eye,\n\t\t\t\tclick: () => (this.showPassword = !this.showPassword),\n\t\t\t}),\n\t\t])\n\t}\n}\n","import m, { ClassComponent, Vnode, VnodeDOM } from \"mithril\"\nimport { Keys, TabIndex } from \"../../api/common/TutanotaConstants.js\"\nimport { isKeyPressed } from \"../../misc/KeyManager.js\"\nimport { AriaRole } from \"../AriaUtils.js\"\n\ntype SwitchVariant = \"normal\" | \"expanded\"\ntype TogglePillPosition = \"left\" | \"right\"\ntype HTMLElementWithAttrs = Partial<Pick<m.Attributes, \"class\"> & Omit<HTMLElement, \"style\"> & SwitchAttrs>\n\nexport interface SwitchAttrs {\n\tchecked: boolean\n\tonclick: (checked: boolean) => unknown\n\tariaLabel: string\n\tdisabled?: boolean\n\ttogglePillPosition?: TogglePillPosition\n\tclasses?: Array<string>\n\tvariant?: SwitchVariant\n}\n\n/**\n * Switch component with variants\n * @see Component attributes: {SwitchAttrs}\n * @example\n * m(Switch,\n *     {\n *         classes: [\"my-custom-switch-class\"],\n *         checked: this.checked,\n *         onclick: (checked: boolean) => {\n *             this.checked = checked\n *             console.log(this.checked)\n *         },\n *         togglePillPosition: \"right\",\n *         ariaLabel: \"Test Switch\",\n *         disabled: false,\n *         variant: \"normal\",\n *     },\n *     \"My label\",\n * ),\n */\nexport class Switch implements ClassComponent<SwitchAttrs> {\n\tprivate checkboxDom?: HTMLInputElement\n\n\tview({ attrs: { disabled, variant, ariaLabel, checked, onclick, togglePillPosition, classes }, children }: Vnode<SwitchAttrs>) {\n\t\tconst childrenArr = [children, this.buildTogglePillComponent(checked, onclick, disabled)]\n\t\tif (togglePillPosition === \"left\") {\n\t\t\tchildrenArr.reverse()\n\t\t}\n\n\t\treturn m(\n\t\t\t\"label.tutaui-switch.flash\",\n\t\t\t{\n\t\t\t\tclass: this.resolveClasses(classes, disabled, variant),\n\t\t\t\trole: AriaRole.Switch,\n\t\t\t\tariaLabel: ariaLabel,\n\t\t\t\tariaChecked: String(checked),\n\t\t\t\tariaDisabled: disabled ? \"true\" : undefined,\n\t\t\t\ttabIndex: Number(disabled ? TabIndex.Programmatic : TabIndex.Default),\n\t\t\t\tonkeydown: (e: KeyboardEvent) => {\n\t\t\t\t\tif (isKeyPressed(e.key, Keys.SPACE, Keys.RETURN)) {\n\t\t\t\t\t\te.preventDefault()\n\t\t\t\t\t\tthis.checkboxDom?.click()\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t} satisfies HTMLElementWithAttrs,\n\t\t\tchildrenArr,\n\t\t)\n\t}\n\n\tprivate buildTogglePillComponent(checked: boolean = false, onclick: (checked: boolean) => unknown, disabled: boolean | undefined) {\n\t\treturn m(\n\t\t\t\"span.tutaui-toggle-pill\",\n\t\t\t{\n\t\t\t\tclass: this.checkboxDom?.checked ? \"checked\" : \"unchecked\",\n\t\t\t},\n\t\t\tm(\"input[type='checkbox']\", {\n\t\t\t\trole: AriaRole.Switch,\n\t\t\t\tonclick: () => {\n\t\t\t\t\tonclick(this.checkboxDom?.checked ?? false)\n\t\t\t\t},\n\t\t\t\toncreate: ({ dom }: VnodeDOM<HTMLInputElement>) => {\n\t\t\t\t\tthis.checkboxDom = dom as HTMLInputElement\n\t\t\t\t\tthis.checkboxDom.checked = checked\n\t\t\t\t},\n\t\t\t\ttabIndex: TabIndex.Programmatic,\n\t\t\t\tdisabled: disabled ? true : undefined,\n\t\t\t}),\n\t\t)\n\t}\n\n\tprivate resolveClasses(classes: Array<string> = [], disabled: boolean = false, variant: SwitchVariant = \"normal\") {\n\t\tconst classList = [...classes]\n\n\t\tif (disabled) classList.push(\"disabled\", \"click-disabled\")\n\t\telse classList.push(\"click\")\n\n\t\tif (variant === \"expanded\") classList.push(\"justify-between\", \"full-width\")\n\t\telse classList.push(\"fit-content\")\n\n\t\treturn classList.join(\" \")\n\t}\n}\n","import m, { ClassComponent, Vnode } from \"mithril\"\n\nexport interface DividerAttrs {\n\tcolor: string\n\tstyle?: Pick<CSSStyleDeclaration, \"margin\">\n}\n\nexport class Divider implements ClassComponent<DividerAttrs> {\n\tview({ attrs }: Vnode<DividerAttrs>) {\n\t\treturn m(\"hr.m-0.border-none.full-width\", {\n\t\t\tstyle: {\n\t\t\t\theight: \"1px\",\n\t\t\t\tbackgroundColor: attrs.color,\n\t\t\t\tcolor: attrs.color,\n\t\t\t\t...attrs.style,\n\t\t\t},\n\t\t})\n\t}\n}\n","import m, { Children, Component, Vnode } from \"mithril\"\nimport { RecipientType } from \"../../../../common/api/common/recipients/Recipient.js\"\nimport { ToggleButton } from \"../../../../common/gui/base/buttons/ToggleButton.js\"\nimport { Icons } from \"../../../../common/gui/base/icons/Icons.js\"\nimport { ButtonSize } from \"../../../../common/gui/base/ButtonSize.js\"\nimport { lang } from \"../../../../common/misc/LanguageViewModel.js\"\nimport { AccountType, CalendarAttendeeStatus } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport { RecipientsSearchModel } from \"../../../../common/misc/RecipientsSearchModel.js\"\nimport { Guest } from \"../../view/CalendarInvites.js\"\nimport { Icon, IconSize } from \"../../../../common/gui/base/Icon.js\"\nimport { theme } from \"../../../../common/gui/theme.js\"\nimport { IconButton } from \"../../../../common/gui/base/IconButton.js\"\nimport { px, size } from \"../../../../common/gui/size.js\"\nimport { CalendarEventWhoModel } from \"../eventeditor-model/CalendarEventWhoModel.js\"\nimport { LoginController } from \"../../../../common/api/main/LoginController.js\"\nimport { CalendarEventModel, CalendarOperation } from \"../eventeditor-model/CalendarEventModel.js\"\nimport { showPlanUpgradeRequiredDialog } from \"../../../../common/misc/SubscriptionDialogs.js\"\nimport { hasPlanWithInvites } from \"../eventeditor-model/CalendarNotificationModel.js\"\nimport { Dialog } from \"../../../../common/gui/base/Dialog.js\"\n\nimport { AttendingItem, createAttendingItems, iconForAttendeeStatus } from \"../CalendarGuiUtils.js\"\nimport { Card } from \"../../../../common/gui/base/Card.js\"\nimport { Select, SelectAttributes } from \"../../../../common/gui/base/Select.js\"\nimport stream from \"mithril/stream\"\nimport { OrganizerSelectItem } from \"./CalendarEventEditView.js\"\nimport { GuestPicker } from \"../pickers/GuestPicker.js\"\nimport { IconMessageBox } from \"../../../../common/gui/base/ColumnEmptyMessageBox.js\"\nimport { PasswordInput } from \"../../../../common/gui/PasswordInput.js\"\nimport { Switch } from \"../../../../common/gui/base/Switch.js\"\nimport { Divider } from \"../../../../common/gui/Divider.js\"\n\nexport type AttendeeListEditorAttrs = {\n\t/** the event that is currently being edited */\n\tmodel: CalendarEventModel\n\n\t/** these are needed to show suggestions and external passwords. */\n\trecipientsSearch: RecipientsSearchModel\n\tlogins: LoginController\n\twidth: number\n}\n\n/**\n * an editor that can edit the attendees list of a calendar event with suggestions,\n * including the own attendance, the own organizer address and external passwords.\n */\nexport class AttendeeListEditor implements Component<AttendeeListEditorAttrs> {\n\tprivate hasPlanWithInvites: boolean = false\n\n\tview({ attrs }: Vnode<AttendeeListEditorAttrs>): Children {\n\t\tconst { whoModel } = attrs.model.editModels\n\t\tconst organizer = whoModel.organizer\n\t\treturn [\n\t\t\tm(\".flex-grow.flex.flex-column.gap-vpad.pb.pt.fit-height\", { style: { width: px(attrs.width) } }, [\n\t\t\t\tthis.renderOrganizer(attrs.model, organizer),\n\t\t\t\tm(\".flex.flex-column.gap-vpad-s\", [\n\t\t\t\t\tm(\"small.uppercase.b.text-ellipsis\", { style: { color: theme.navigation_button } }, lang.get(\"guests_label\")),\n\t\t\t\t\twhoModel.canModifyGuests ? this.renderGuestsInput(whoModel, attrs.logins, attrs.recipientsSearch) : null,\n\t\t\t\t\tthis.renderSendUpdateCheckbox(attrs.model.editModels.whoModel),\n\t\t\t\t\tthis.renderGuestList(attrs, organizer),\n\t\t\t\t]),\n\t\t\t]),\n\t\t]\n\t}\n\n\tprivate renderGuestList(attrs: AttendeeListEditorAttrs, organizer: Guest | null): Children {\n\t\tconst { whoModel } = attrs.model.editModels\n\t\tconst guestItems: (() => Children)[] = []\n\n\t\tfor (const guest of whoModel.guests) {\n\t\t\tlet password: string\n\t\t\tlet strength: number\n\n\t\t\tif (guest.type === RecipientType.EXTERNAL) {\n\t\t\t\tconst presharedPassword = whoModel.getPresharedPassword(guest.address)\n\t\t\t\tpassword = presharedPassword.password\n\t\t\t\tstrength = presharedPassword.strength\n\t\t\t}\n\n\t\t\tguestItems.push(() => this.renderGuest(guest, attrs, password, strength))\n\t\t}\n\n\t\t// ownGuest is never in the guest list, but it may be identical to organizer.\n\t\tconst ownGuest = whoModel.ownGuest\n\t\tif (ownGuest != null && ownGuest.address !== organizer?.address) {\n\t\t\tguestItems.push(() => this.renderGuest(ownGuest, attrs))\n\t\t}\n\n\t\tconst verticalPadding = guestItems.length > 0 ? size.vpad_small : 0\n\n\t\treturn guestItems.length === 0\n\t\t\t? m(\n\t\t\t\t\tCard,\n\t\t\t\t\t{\n\t\t\t\t\t\tclasses: [\"min-h-s flex flex-column gap-vpad-s\"],\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tpadding: `${px(verticalPadding)} ${px(guestItems.length === 0 ? size.vpad_small : 0)} ${px(size.vpad_small)} ${px(\n\t\t\t\t\t\t\t\tverticalPadding,\n\t\t\t\t\t\t\t)}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tm(\".flex.items-center.justify-center.min-h-s\", [\n\t\t\t\t\t\tm(IconMessageBox, {\n\t\t\t\t\t\t\tmessage: \"noEntries_msg\",\n\t\t\t\t\t\t\ticon: Icons.People,\n\t\t\t\t\t\t\tcolor: theme.list_message_bg,\n\t\t\t\t\t\t}),\n\t\t\t\t\t]),\n\t\t\t  )\n\t\t\t: guestItems.map((r, index) => r())\n\t}\n\n\tprivate renderGuestsInput(whoModel: CalendarEventWhoModel, logins: LoginController, recipientsSearch: RecipientsSearchModel): Children {\n\t\tconst guests = whoModel.guests\n\t\tconst hasExternalGuests = guests.some((a) => a.type === RecipientType.EXTERNAL)\n\n\t\treturn m(\".flex.items-center.flex-grow.gap-vpad-s\", [\n\t\t\tm(Card, { style: { padding: \"0\" }, classes: [\"flex-grow\"] }, [\n\t\t\t\tm(\".flex.flex-grow.rel.button-height\", [\n\t\t\t\t\tm(GuestPicker, {\n\t\t\t\t\t\tariaLabel: \"addGuest_label\",\n\t\t\t\t\t\tdisabled: false,\n\t\t\t\t\t\tonRecipientAdded: async (address, name, contact) => {\n\t\t\t\t\t\t\tif (!(await hasPlanWithInvites(logins)) && !this.hasPlanWithInvites) {\n\t\t\t\t\t\t\t\tif (logins.getUserController().user.accountType === AccountType.EXTERNAL) return\n\t\t\t\t\t\t\t\tif (logins.getUserController().isGlobalAdmin()) {\n\t\t\t\t\t\t\t\t\tconst { getAvailablePlansWithEventInvites } = await import(\"../../../../common/subscription/SubscriptionUtils.js\")\n\t\t\t\t\t\t\t\t\tconst plansWithEventInvites = await getAvailablePlansWithEventInvites()\n\t\t\t\t\t\t\t\t\tif (plansWithEventInvites.length === 0) return\n\t\t\t\t\t\t\t\t\t//entity event updates are too slow to call updateBusinessFeature()\n\t\t\t\t\t\t\t\t\tthis.hasPlanWithInvites = await showPlanUpgradeRequiredDialog(plansWithEventInvites)\n\t\t\t\t\t\t\t\t\t// the user could have, but did not upgrade.\n\t\t\t\t\t\t\t\t\tif (!this.hasPlanWithInvites) return\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tDialog.message(\"contactAdmin_msg\")\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\twhoModel.addAttendee(address, contact)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tsearch: recipientsSearch,\n\t\t\t\t\t}),\n\t\t\t\t]),\n\t\t\t]),\n\t\t\thasExternalGuests\n\t\t\t\t? m(\n\t\t\t\t\t\tCard,\n\t\t\t\t\t\t{ style: { padding: \"0\" } },\n\t\t\t\t\t\tm(ToggleButton, {\n\t\t\t\t\t\t\ttitle: \"confidential_action\",\n\t\t\t\t\t\t\tonToggled: (_, e) => {\n\t\t\t\t\t\t\t\twhoModel.isConfidential = !whoModel.isConfidential\n\t\t\t\t\t\t\t\te.stopPropagation()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ticon: whoModel.isConfidential ? Icons.Lock : Icons.Unlock,\n\t\t\t\t\t\t\ttoggled: whoModel.isConfidential,\n\t\t\t\t\t\t\tsize: ButtonSize.Normal,\n\t\t\t\t\t\t}),\n\t\t\t\t  )\n\t\t\t\t: null,\n\t\t])\n\t}\n\n\tprivate renderAttendeeStatus(model: CalendarEventWhoModel, organizer: Guest | null): Children {\n\t\tconst { status } = organizer ?? { status: CalendarAttendeeStatus.TENTATIVE }\n\n\t\tconst attendingOptions = createAttendingItems().filter((option) => option.selectable !== false)\n\t\tconst attendingStatus = attendingOptions.find((option) => option.value === status)\n\n\t\treturn m(\".flex.flex-column.pl-vpad-s.pr-vpad-s\", [\n\t\t\tm(Select<AttendingItem, CalendarAttendeeStatus>, {\n\t\t\t\tonchange: (option) => {\n\t\t\t\t\tif (option.selectable === false) return\n\t\t\t\t\tmodel.setOwnAttendance(option.value)\n\t\t\t\t},\n\t\t\t\tclasses: [\"button-min-height\"],\n\t\t\t\tselected: attendingStatus,\n\t\t\t\tdisabled: organizer == null,\n\t\t\t\tariaLabel: lang.get(\"attending_label\"),\n\t\t\t\trenderOption: (option) =>\n\t\t\t\t\tm(\n\t\t\t\t\t\t\"button.items-center.flex-grow.state-bg.button-content.dropdown-button.pt-s.pb-s.button-min-height\",\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tclass: option.selectable === false ? `no-hover` : \"\",\n\t\t\t\t\t\t\tstyle: { color: option.value === status ? theme.content_button_selected : undefined },\n\t\t\t\t\t\t},\n\t\t\t\t\t\toption.name,\n\t\t\t\t\t),\n\t\t\t\trenderDisplay: (option) => m(\"\", option.name),\n\t\t\t\toptions: stream(attendingOptions),\n\t\t\t\texpanded: true,\n\t\t\t\tnoIcon: organizer == null,\n\t\t\t} satisfies SelectAttributes<AttendingItem, CalendarAttendeeStatus>),\n\t\t])\n\t}\n\n\tprivate renderOrganizer(model: CalendarEventModel, organizer: Guest | null): Children {\n\t\tconst { whoModel } = model.editModels\n\n\t\tif (!(whoModel.possibleOrganizers.length > 0 || organizer)) {\n\t\t\tconsole.log(\"Trying to access guest without organizer\")\n\t\t\treturn null\n\t\t}\n\n\t\tconst { address, name, status } = organizer ?? {}\n\t\tconst hasGuest = whoModel.guests.length > 0\n\t\tconst isMe = organizer?.address === whoModel.ownGuest?.address\n\t\tconst editableOrganizer = whoModel.possibleOrganizers.length > 1 && isMe\n\n\t\tconst options = whoModel.possibleOrganizers.map((organizer) => {\n\t\t\treturn {\n\t\t\t\tname: organizer.name,\n\t\t\t\taddress: organizer.address,\n\t\t\t\tariaValue: organizer.address,\n\t\t\t\tvalue: organizer.address,\n\t\t\t}\n\t\t})\n\n\t\tconst disabled = !editableOrganizer || !hasGuest\n\t\tconst selected = options.find((option) => option.address === address) ?? options[0]\n\n\t\treturn m(\".flex.col\", [\n\t\t\tm(\"small.uppercase.pb-s.b.text-ellipsis\", { style: { color: theme.navigation_button } }, lang.get(\"organizer_label\")),\n\t\t\tm(Card, { style: { padding: `0` } }, [\n\t\t\t\tm(\".flex.flex-column\", [\n\t\t\t\t\tm(\".flex.pl-vpad-s.pr-vpad-s\", [\n\t\t\t\t\t\tm(Select<OrganizerSelectItem, string>, {\n\t\t\t\t\t\t\tclasses: [\"flex-grow\", \"button-min-height\"],\n\t\t\t\t\t\t\tonchange: (option) => {\n\t\t\t\t\t\t\t\tconst organizer = whoModel.possibleOrganizers.find((organizer) => organizer.address === option.address)\n\t\t\t\t\t\t\t\tif (organizer) {\n\t\t\t\t\t\t\t\t\twhoModel.addAttendee(organizer.address, null)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tselected,\n\t\t\t\t\t\t\tdisabled,\n\t\t\t\t\t\t\tariaLabel: lang.get(\"organizer_label\"),\n\t\t\t\t\t\t\trenderOption: (option) =>\n\t\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\t\"button.items-center.flex-grow.state-bg.button-content.dropdown-button.pt-s.pb-s.button-min-height\",\n\t\t\t\t\t\t\t\t\t{ style: { color: selected.address === option.address ? theme.content_button_selected : undefined } },\n\t\t\t\t\t\t\t\t\toption.address,\n\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\trenderDisplay: (option) => m(\"\", option.name ? `${option.name} <${option.address}>` : option.address),\n\t\t\t\t\t\t\toptions: stream(\n\t\t\t\t\t\t\t\twhoModel.possibleOrganizers.map((organizer) => {\n\t\t\t\t\t\t\t\t\treturn {\n\t\t\t\t\t\t\t\t\t\tname: organizer.name,\n\t\t\t\t\t\t\t\t\t\taddress: organizer.address,\n\t\t\t\t\t\t\t\t\t\tariaValue: organizer.address,\n\t\t\t\t\t\t\t\t\t\tvalue: organizer.address,\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tnoIcon: disabled,\n\t\t\t\t\t\t\texpanded: true,\n\t\t\t\t\t\t} satisfies SelectAttributes<OrganizerSelectItem, string>),\n\t\t\t\t\t\tmodel.operation !== CalendarOperation.EditThis && organizer && !isMe\n\t\t\t\t\t\t\t? m(IconButton, {\n\t\t\t\t\t\t\t\t\ttitle: \"sendMail_alt\",\n\t\t\t\t\t\t\t\t\tclick: async () =>\n\t\t\t\t\t\t\t\t\t\t(await import(\"../../../../mail-app/contacts/view/ContactView.js\")).writeMail(\n\t\t\t\t\t\t\t\t\t\t\torganizer,\n\t\t\t\t\t\t\t\t\t\t\tlang.get(\"repliedToEventInvite_msg\", {\n\t\t\t\t\t\t\t\t\t\t\t\t\"{event}\": model.editModels.summary.content,\n\t\t\t\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\tsize: ButtonSize.Compact,\n\t\t\t\t\t\t\t\t\ticon: Icons.PencilSquare,\n\t\t\t\t\t\t\t  })\n\t\t\t\t\t\t\t: null,\n\t\t\t\t\t]),\n\t\t\t\t\tisMe && model.operation !== CalendarOperation.EditThis\n\t\t\t\t\t\t? [m(Divider, { color: theme.button_bubble_bg }), this.renderAttendeeStatus(whoModel, organizer)]\n\t\t\t\t\t\t: null,\n\t\t\t\t]),\n\t\t\t]),\n\t\t])\n\t}\n\n\tprivate renderSendUpdateCheckbox(whoModel: CalendarEventWhoModel): Children {\n\t\treturn !whoModel.initiallyHadOtherAttendees || !whoModel.canModifyGuests\n\t\t\t? null\n\t\t\t: m(\n\t\t\t\t\tCard,\n\t\t\t\t\tm(\n\t\t\t\t\t\tSwitch,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tchecked: whoModel.shouldSendUpdates,\n\t\t\t\t\t\t\tonclick: (value) => (whoModel.shouldSendUpdates = value),\n\t\t\t\t\t\t\tariaLabel: lang.get(\"sendUpdates_label\"),\n\t\t\t\t\t\t\tdisabled: false,\n\t\t\t\t\t\t\tvariant: \"expanded\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlang.get(\"sendUpdates_label\"),\n\t\t\t\t\t),\n\t\t\t  )\n\t}\n\n\tprivate renderGuest(guest: Guest, { model }: Pick<AttendeeListEditorAttrs, \"model\">, password?: string, strength?: number): Children {\n\t\tconst { whoModel } = model.editModels\n\t\tconst { address, name, status } = guest\n\t\tconst isMe = guest.address === whoModel.ownGuest?.address\n\t\tconst roleLabel = isMe ? `${lang.get(\"guest_label\")} | ${lang.get(\"you_label\")}` : lang.get(\"guest_label\")\n\t\tconst renderPasswordField = whoModel.isConfidential && password != null && guest.type === RecipientType.EXTERNAL\n\n\t\tlet rightContent: Children = null\n\n\t\tif (isMe) {\n\t\t\trightContent = m(\"\", { style: { paddingRight: px(size.vpad_small) } }, this.renderAttendeeStatus(model.editModels.whoModel, guest))\n\t\t} else if (whoModel.canModifyGuests) {\n\t\t\trightContent = m(IconButton, {\n\t\t\t\ttitle: \"remove_action\",\n\t\t\t\ticon: Icons.Cancel,\n\t\t\t\tclick: () => whoModel.removeAttendee(guest.address),\n\t\t\t})\n\t\t}\n\n\t\treturn m(\n\t\t\tCard,\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\tpadding: `${px(size.vpad_small)} ${px(0)} ${px(size.vpad_small)} ${px(size.vpad_small)}`,\n\t\t\t\t},\n\t\t\t},\n\t\t\tm(\".flex.flex-column.items-center\", [\n\t\t\t\tm(\".flex.items-center.flex-grow.full-width\", [\n\t\t\t\t\tthis.renderStatusIcon(status),\n\t\t\t\t\tm(\".flex.flex-column.flex-grow.min-width-0\", [\n\t\t\t\t\t\tm(\".small\", { style: { lineHeight: px(size.vpad_small) } }, roleLabel),\n\t\t\t\t\t\tm(\".text-ellipsis\", name.length > 0 ? `${name} ${address}` : address),\n\t\t\t\t\t]),\n\t\t\t\t\trightContent,\n\t\t\t\t]),\n\t\t\t\trenderPasswordField\n\t\t\t\t\t? [\n\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\".flex.full-width\",\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\tpadding: `0 0 ${px(size.vpad_xsm)} ${px(size.vpad_small + size.icon_size_medium_large)}`,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tm(Divider, {\n\t\t\t\t\t\t\t\t\tcolor: theme.button_bubble_bg,\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tthis.renderPasswordField(address, password, strength ?? 0, whoModel),\n\t\t\t\t\t  ]\n\t\t\t\t\t: null,\n\t\t\t]),\n\t\t)\n\t}\n\n\tprivate renderPasswordField(address: string, password: string, strength: number, whoModel: CalendarEventWhoModel): Children {\n\t\tconst label = lang.get(\"passwordFor_label\", {\n\t\t\t\"{1}\": address,\n\t\t})\n\t\treturn [\n\t\t\tm(\".flex.flex-grow.full-width.justify-between.items-end\", [\n\t\t\t\tm(\n\t\t\t\t\t\".flex.flex-column.full-width\",\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tpaddingLeft: px(size.hpad_medium + size.vpad_small),\n\t\t\t\t\t\t\tpaddingRight: px((size.button_height - size.button_height_compact) / 2),\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t[\n\t\t\t\t\t\tm(PasswordInput, {\n\t\t\t\t\t\t\tariaLabel: label,\n\t\t\t\t\t\t\tpassword,\n\t\t\t\t\t\t\tstrength,\n\t\t\t\t\t\t\toninput: (newPassword) => {\n\t\t\t\t\t\t\t\twhoModel.setPresharedPassword(address, newPassword)\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}),\n\t\t\t\t\t],\n\t\t\t\t),\n\t\t\t]),\n\t\t]\n\t}\n\n\tprivate renderStatusIcon(status: CalendarAttendeeStatus): Children {\n\t\tconst icon = iconForAttendeeStatus[status]\n\t\treturn m(Icon, {\n\t\t\ticon,\n\t\t\tsize: IconSize.Large,\n\t\t\tclass: \"mr-s\",\n\t\t\tstyle: {\n\t\t\t\tfill: theme.content_fg,\n\t\t\t},\n\t\t})\n\t}\n}\n","import m, { Children } from \"mithril\"\nimport { Icons } from \"../icons/Icons.js\"\nimport { BootIcons } from \"../icons/BootIcons.js\"\nimport { ClickHandler } from \"../GuiUtils.js\"\nimport { px } from \"../../size.js\"\nimport { BaseButton } from \"./BaseButton.js\"\nimport { lang } from \"../../../misc/LanguageViewModel.js\"\nimport { Icon, IconSize } from \"../Icon.js\"\nimport { theme } from \"../../theme.js\"\n\nexport default function renderSwitchMonthArrowIcon(forward: boolean, size: number, onClick: ClickHandler): Children {\n\treturn m(BaseButton, {\n\t\tlabel: forward ? \"nextMonth_label\" : \"prevMonth_label\",\n\t\ticon: m(Icon, {\n\t\t\ticon: forward ? Icons.ArrowForward : BootIcons.Back,\n\t\t\tcontainer: \"div\",\n\t\t\tclass: \"center-h\",\n\t\t\tsize: IconSize.Normal,\n\t\t\tstyle: {\n\t\t\t\tfill: theme.content_fg,\n\t\t\t},\n\t\t}),\n\t\tstyle: {\n\t\t\twidth: px(size),\n\t\t\theight: px(size),\n\t\t},\n\t\tclass: \"state-bg circle\",\n\t\tonclick: onClick,\n\t})\n}\n","import m, { ClassComponent, Component, Vnode } from \"mithril\"\nimport { theme } from \"../theme.js\"\nimport { SingleLineTextField } from \"./SingleLineTextField.js\"\nimport { px, size } from \"../size.js\"\nimport { TextFieldType } from \"./TextField.js\"\nimport { TabIndex } from \"../../api/common/TutanotaConstants.js\"\n\nexport enum InputButtonVariant {\n\tOUTLINE = \"outline\",\n}\n\nexport interface InputButtonAttributes extends Pick<Component, \"oncreate\"> {\n\tinputValue: string\n\tdisplay: string\n\tariaLabel: string\n\tdisabled?: boolean\n\tclasses?: Array<string>\n\tvariant?: InputButtonVariant\n\tcontainerStyle?: Partial<CSSStyleDeclaration>\n\tdisplayStyle?: Partial<CSSStyleDeclaration>\n\tonclick?: (event: MouseEvent) => unknown\n\toninput: (newValue: string) => unknown\n\tonblur?: (...args: unknown[]) => unknown\n\tonfocus?: (...args: unknown[]) => unknown\n\tonkeydown?: (...args: unknown[]) => unknown\n\ttype?: TextFieldType\n\ttabIndex?: number\n}\n\n/**\n * A button with an input that can be activated when clicked or focused\n * @see Component attributes: {InputButtonAttributes}\n * @example\n * m(InputButton, {\n *   ariaLabel: lang.get(\"dateFrom_label\")\n *   inputValue: this.value,\n * \t oninput: (newValue) => (model.value = newValue),\n * \t display: lang.get(\"placeholder\"),\n * \t variant: InputButtonVariant.OUTLINE,\n * \t onclick: console.log,\n * \t disabled: false,\n *   displayStyle: {\n *     color: \"blue\"\n *   }\n * }),\n */\nexport class InputButton implements ClassComponent<InputButtonAttributes> {\n\tprivate isFocused: boolean = false\n\tprivate inputDOM?: HTMLInputElement\n\tprivate buttonDOM?: HTMLButtonElement\n\n\tview({ attrs }: Vnode<InputButtonAttributes, this>) {\n\t\treturn m(\n\t\t\t\"button\",\n\t\t\t{\n\t\t\t\ttitle: attrs.ariaLabel,\n\t\t\t\t\"aria-live\": \"off\", // Button contents and label will be handled by the input field\n\t\t\t\tclass: this.resolveContainerClasses(attrs.variant, attrs.classes, attrs.disabled),\n\t\t\t\ttabIndex: attrs.tabIndex,\n\t\t\t\tstyle: {\n\t\t\t\t\tborderColor: theme.content_message_bg,\n\t\t\t\t\tpadding: 0,\n\t\t\t\t\t...attrs.containerStyle,\n\t\t\t\t},\n\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\tthis.buttonDOM = vnode.dom as HTMLButtonElement\n\t\t\t\t},\n\t\t\t\tonclick: (event: MouseEvent) => {\n\t\t\t\t\tthis.isFocused = true\n\t\t\t\t\tif (this.inputDOM) {\n\t\t\t\t\t\tthis.inputDOM.style.display = \"block\"\n\t\t\t\t\t\tthis.inputDOM.click()\n\t\t\t\t\t}\n\n\t\t\t\t\tattrs.onclick?.(event)\n\t\t\t\t},\n\t\t\t\tonfocus: () => {\n\t\t\t\t\tthis.isFocused = true\n\t\t\t\t\tif (this.inputDOM) {\n\t\t\t\t\t\tthis.inputDOM.style.display = \"block\"\n\t\t\t\t\t\tif (this.buttonDOM) {\n\t\t\t\t\t\t\tthis.buttonDOM.tabIndex = Number(TabIndex.Programmatic)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tthis.inputDOM.focus()\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tdisabled: attrs.disabled,\n\t\t\t},\n\t\t\t[\n\t\t\t\tm.fragment({}, [\n\t\t\t\t\tm(SingleLineTextField, {\n\t\t\t\t\t\tariaLabel: attrs.ariaLabel,\n\t\t\t\t\t\tonblur: () => {\n\t\t\t\t\t\t\tthis.isFocused = false\n\t\t\t\t\t\t\tthis.inputDOM!.style.display = \"none\"\n\t\t\t\t\t\t\tif (this.buttonDOM) {\n\t\t\t\t\t\t\t\tthis.buttonDOM.tabIndex = Number(attrs.tabIndex ?? TabIndex.Default)\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tattrs.onblur?.()\n\t\t\t\t\t\t},\n\t\t\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\t\t\tthis.inputDOM = vnode.dom as HTMLInputElement\n\t\t\t\t\t\t\tthis.inputDOM.style.display = \"none\"\n\n\t\t\t\t\t\t\tattrs.oncreate?.(vnode)\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdisabled: attrs.disabled,\n\t\t\t\t\t\tvalue: attrs.inputValue,\n\t\t\t\t\t\toninput: attrs.oninput,\n\t\t\t\t\t\tonkeydown: attrs.onkeydown,\n\t\t\t\t\t\tonfocus: attrs.onfocus,\n\t\t\t\t\t\tclasses: this.resolveInputClasses(attrs.variant),\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tpadding: `${px(size.vpad_small)} 0`,\n\t\t\t\t\t\t},\n\t\t\t\t\t\ttype: TextFieldType.Text,\n\t\t\t\t\t}),\n\t\t\t\t]),\n\t\t\t\tm(\n\t\t\t\t\t\"span.tutaui-text-field\",\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tdisplay: this.isFocused ? \"none\" : \"block\",\n\t\t\t\t\t\t\tpadding: `${px(size.vpad_small)} 0`,\n\t\t\t\t\t\t\t...attrs.displayStyle,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tattrs.display,\n\t\t\t\t),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate resolveInputClasses(variant?: InputButtonVariant) {\n\t\tconst resolvedClasses = [\"text-center\", \"noselect\"]\n\t\tif (variant === InputButtonVariant.OUTLINE && this.isFocused) {\n\t\t\tresolvedClasses.push(\"tutaui-button-outline\", \"border-content-message-bg\")\n\t\t}\n\n\t\treturn resolvedClasses\n\t}\n\n\tprivate resolveContainerClasses(variant: InputButtonVariant = InputButtonVariant.OUTLINE, classes: Array<string> = [], disabled: boolean = false) {\n\t\tconst resolvedClasses = [...classes, \"full-width\"]\n\n\t\tif (disabled) resolvedClasses.push(\"disabled\", \"click-disabled\")\n\t\tif (variant === InputButtonVariant.OUTLINE && !this.isFocused) {\n\t\t\tresolvedClasses.push(\"tutaui-button-outline\")\n\t\t}\n\n\t\treturn resolvedClasses.join(\" \")\n\t}\n}\n","import m, { Children, Component, Vnode } from \"mithril\"\nimport { client } from \"../../../../common/misc/ClientDetector.js\"\nimport { formatDate, formatDateWithWeekdayAndYear, formatMonthWithFullYear } from \"../../../../common/misc/Formatter.js\"\nimport type { TranslationKey, MaybeTranslation } from \"../../../../common/misc/LanguageViewModel.js\"\nimport { lang } from \"../../../../common/misc/LanguageViewModel.js\"\nimport { px } from \"../../../../common/gui/size.js\"\nimport { theme } from \"../../../../common/gui/theme.js\"\n\nimport { getStartOfDay, isSameDayOfDate, memoized } from \"@tutao/tutanota-utils\"\nimport { DateTime } from \"luxon\"\nimport { getAllDayDateLocal } from \"../../../../common/api/common/utils/CommonCalendarUtils.js\"\nimport { TextField, TextFieldType } from \"../../../../common/gui/base/TextField.js\"\nimport type { CalendarDay } from \"../../../../common/calendar/date/CalendarUtils.js\"\nimport { parseDate } from \"../../../../common/misc/DateParser.js\"\nimport renderSwitchMonthArrowIcon from \"../../../../common/gui/base/buttons/ArrowButton.js\"\nimport { getCalendarMonth } from \"../CalendarGuiUtils.js\"\nimport { isKeyPressed, keyboardEventToKeyPress, keyHandler, KeyPress, useKeyHandler } from \"../../../../common/misc/KeyManager.js\"\nimport { Keys, TabIndex } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport { AriaPopupType } from \"../../../../common/gui/AriaUtils.js\"\nimport { isApp } from \"../../../../common/api/common/Env.js\"\nimport { InputButton, InputButtonAttributes, InputButtonVariant } from \"../../../../common/gui/base/InputButton.js\"\n\nexport enum PickerPosition {\n\tTOP,\n\tBOTTOM,\n}\n\nexport interface DatePickerAttrs {\n\tdate?: Date\n\tonDateSelected: (date: Date) => unknown\n\tstartOfTheWeekOffset: number\n\tlabel: TranslationKey\n\tnullSelectionText?: MaybeTranslation\n\tdisabled?: boolean\n\trightAlignDropdown?: boolean\n\tuseInputButton?: boolean\n\tposition?: PickerPosition\n\tclasses?: Array<string>\n}\n\n/**\n * Date picker component. Looks like a text field until interacted. On mobile it will be native browser picker, on desktop a {@class VisualDatePicker}.\n *\n * The HTML input[type=date] is not usable on desktops because:\n * * it always displays a placeholder (mm/dd/yyyy) and several buttons and\n * * the picker can't be opened programmatically and\n * * the date format is based on the operating systems locale and not on the one set in the browser (and used by us)\n *\n * That is why we only use the picker on mobile devices. They provide native picker components\n * and allow opening the picker by forwarding the click event to the input.\n */\nexport class DatePicker implements Component<DatePickerAttrs> {\n\tprivate inputText: string = \"\"\n\tprivate showingDropdown: boolean = false\n\tprivate domInput: HTMLElement | null = null\n\tprivate documentInteractionListener: ((e: MouseEvent) => unknown) | null = null\n\tprivate textFieldHasFocus: boolean = false\n\tprivate previousPassedDownDate?: Date\n\n\tconstructor({ attrs }: Vnode<DatePickerAttrs>) {\n\t\tthis.inputText = attrs.date ? formatDate(attrs.date) : \"\"\n\t\tthis.previousPassedDownDate = attrs.date\n\t}\n\n\tview({ attrs }: Vnode<DatePickerAttrs>): Children {\n\t\tconst date = attrs.date\n\n\t\t// If the user is interacting with the textfield, then we want the textfield to accept their input, so never override the text\n\t\t// Otherwise, we want to it to reflect whatever date has been passed in, because it may have been changed programmatically\n\t\t// The same day check is because sometimes focus is lost when trying to update the date. handleInput\n\t\t//  or handleSelectedDate should be called first, but it is not and the date trying to be selected is\n\t\t//  lost. So checking if the date was actually passed in \"from above\" is a band-aid solution for now.\n\t\tif (!this.textFieldHasFocus && !isSameDayOfDate(date, this.previousPassedDownDate)) {\n\t\t\tthis.inputText = date ? formatDate(date) : \"\"\n\t\t\tthis.previousPassedDownDate = date\n\t\t}\n\n\t\treturn m(\".rel\", { class: attrs.classes?.join(\" \") }, [\n\t\t\t!attrs.useInputButton ? this.renderTextField(attrs) : this.renderInputButtonPicker(attrs),\n\t\t\tthis.showingDropdown ? this.renderDropdown(attrs) : null,\n\t\t\t// For mobile devices we render a native date picker, it's easier to use and more accessible.\n\t\t\t// We render invisible input which opens native picker on interaction.\n\t\t\tclient.isMobileDevice() && !attrs.useInputButton ? this.renderMobileDateInput(attrs) : null,\n\t\t])\n\t}\n\n\tprivate renderInputButtonPicker({ disabled, date, onDateSelected, label }: DatePickerAttrs): Children {\n\t\treturn m.fragment({}, [\n\t\t\tisApp()\n\t\t\t\t? m(\"input.fill-absolute.invisible.tutaui-button-outline\", {\n\t\t\t\t\t\tdisabled,\n\t\t\t\t\t\ttype: TextFieldType.Date,\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tzIndex: 1,\n\t\t\t\t\t\t\tborder: `2px solid ${theme.content_message_bg}`,\n\t\t\t\t\t\t\twidth: \"auto\",\n\t\t\t\t\t\t\theight: \"auto\",\n\t\t\t\t\t\t\tpadding: 0,\n\t\t\t\t\t\t\tappearance: \"none\",\n\t\t\t\t\t\t\topacity: disabled ? 0.7 : 1.0,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tvalue: date != null ? DateTime.fromJSDate(date).toISODate() : \"\",\n\t\t\t\t\t\toninput: (event: InputEvent) => {\n\t\t\t\t\t\t\tthis.handleNativeInput(event, onDateSelected)\n\t\t\t\t\t\t},\n\t\t\t\t  })\n\t\t\t\t: null,\n\t\t\tm(InputButton, {\n\t\t\t\ttabIndex: Number(isApp() ? TabIndex.Programmatic : TabIndex.Default),\n\t\t\t\tariaLabel: lang.getTranslationText(label),\n\t\t\t\tinputValue: this.inputText,\n\t\t\t\toninput: (newValue: string) => (this.inputText = newValue),\n\t\t\t\tdisplay: formatDateWithWeekdayAndYear(date ?? new Date()),\n\t\t\t\tvariant: InputButtonVariant.OUTLINE,\n\t\t\t\tdisabled,\n\t\t\t\ttype: TextFieldType.Text,\n\t\t\t\tonclick: () => {\n\t\t\t\t\tif (!disabled) {\n\t\t\t\t\t\tthis.showingDropdown = true\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tonfocus: (_, input) => {\n\t\t\t\t\tif (!disabled) {\n\t\t\t\t\t\tthis.showingDropdown = true\n\t\t\t\t\t}\n\t\t\t\t\tthis.textFieldHasFocus = true\n\t\t\t\t},\n\t\t\t\toncreate: (input: any) => {\n\t\t\t\t\tif (this.domInput == null) {\n\t\t\t\t\t\tthis.domInput = input.dom as HTMLInputElement\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tonblur: () => {\n\t\t\t\t\tthis.textFieldHasFocus = false\n\t\t\t\t},\n\t\t\t\tonkeydown: (event: KeyboardEvent) => {\n\t\t\t\t\tconst key = keyboardEventToKeyPress(event)\n\t\t\t\t\treturn this.handleInputKeyEvents(key, disabled, onDateSelected)\n\t\t\t\t},\n\t\t\t\tcontainerStyle: isApp()\n\t\t\t\t\t? {\n\t\t\t\t\t\t\tzIndex: \"2\",\n\t\t\t\t\t\t\tposition: \"inherit\",\n\t\t\t\t\t\t\tborderColor: \"transparent\",\n\t\t\t\t\t\t\tpointerEvents: \"none\",\n\t\t\t\t\t  }\n\t\t\t\t\t: {},\n\t\t\t} satisfies InputButtonAttributes),\n\t\t])\n\t}\n\n\tprivate renderTextField({ date, onDateSelected, label, nullSelectionText, disabled }: DatePickerAttrs): Children {\n\t\treturn m(\n\t\t\t\"\",\n\t\t\t{\n\t\t\t\tonclick: () => {\n\t\t\t\t\tif (!disabled) {\n\t\t\t\t\t\tthis.showingDropdown = true\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\tm(TextField, {\n\t\t\t\tvalue: this.inputText,\n\t\t\t\tlabel,\n\t\t\t\thelpLabel: () => this.renderHelpLabel(date, nullSelectionText ?? null),\n\t\t\t\tdisabled,\n\t\t\t\thasPopup: AriaPopupType.Dialog,\n\t\t\t\toninput: (text) => {\n\t\t\t\t\t// we want to hold on to the text for when we actually want to process it\n\t\t\t\t\tthis.inputText = text\n\t\t\t\t},\n\t\t\t\tonfocus: (_, input) => {\n\t\t\t\t\tif (!disabled) {\n\t\t\t\t\t\tthis.showingDropdown = true\n\t\t\t\t\t}\n\t\t\t\t\tthis.textFieldHasFocus = true\n\t\t\t\t},\n\t\t\t\tonDomInputCreated: (input) => {\n\t\t\t\t\tif (this.domInput == null) {\n\t\t\t\t\t\tthis.domInput = input\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tonblur: () => {\n\t\t\t\t\tthis.textFieldHasFocus = false\n\t\t\t\t},\n\t\t\t\tkeyHandler: (key) => {\n\t\t\t\t\treturn this.handleInputKeyEvents(key, disabled, onDateSelected)\n\t\t\t\t},\n\t\t\t}),\n\t\t)\n\t}\n\n\tprivate handleEscapePress(key: KeyPress): boolean {\n\t\tif (isKeyPressed(key.key, Keys.ESC) && this.showingDropdown) {\n\t\t\tthis.domInput?.focus()\n\t\t\tthis.showingDropdown = false\n\t\t\treturn false\n\t\t}\n\t\treturn true\n\t}\n\n\tprivate renderHelpLabel(date: Date | null | undefined, nullSelectionText: MaybeTranslation | null): Children {\n\t\tif (this.showingDropdown) {\n\t\t\treturn null\n\t\t} else if (date != null) {\n\t\t\treturn [m(\"\", formatDateWithWeekdayAndYear(date)), nullSelectionText ? m(\"\", lang.getTranslationText(nullSelectionText)) : null]\n\t\t} else {\n\t\t\treturn lang.getTranslationText(nullSelectionText ?? \"emptyString_msg\")\n\t\t}\n\t}\n\n\tprivate renderDropdown({ date, onDateSelected, startOfTheWeekOffset, rightAlignDropdown, label, position }: DatePickerAttrs): Children {\n\t\t// We would like to show the date being typed in the dropdown\n\t\tconst dropdownDate = this.parseDate(this.inputText) ?? date ?? new Date()\n\t\treturn m(\n\t\t\t\".content-bg.z3.menu-shadow.plr.pb-s\",\n\t\t\t{\n\t\t\t\t\"aria-modal\": \"true\",\n\t\t\t\t\"aria-label\": lang.get(label),\n\t\t\t\tstyle: {\n\t\t\t\t\twidth: \"240px\",\n\t\t\t\t\tright: rightAlignDropdown ? \"0\" : null,\n\t\t\t\t},\n\t\t\t\tclass: position === PickerPosition.TOP ? \"abs\" : \"fixed\",\n\t\t\t\toncreate: (vnode) => {\n\t\t\t\t\tconst listener = (e: MouseEvent) => {\n\t\t\t\t\t\tif (!vnode.dom.contains(e.target as HTMLElement) && !this.domInput?.contains(e.target as HTMLElement)) {\n\t\t\t\t\t\t\t// We are subscribed to two events so this listener *will* be invoked twice, but we only need to do the work once.\n\t\t\t\t\t\t\tif (this.showingDropdown) {\n\t\t\t\t\t\t\t\tthis.showingDropdown = false\n\t\t\t\t\t\t\t\tthis.handleInput(this.inputText, onDateSelected)\n\t\t\t\t\t\t\t\tm.redraw()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (position === PickerPosition.TOP && vnode.dom.parentElement) {\n\t\t\t\t\t\tconst bottomMargin = vnode.dom.parentElement.getBoundingClientRect().height\n\t\t\t\t\t\t;(vnode.dom as HTMLElement).style.bottom = px(bottomMargin)\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.documentInteractionListener = listener\n\t\t\t\t\tdocument.addEventListener(\"click\", listener, true)\n\t\t\t\t\tdocument.addEventListener(\"focus\", listener, true)\n\t\t\t\t},\n\t\t\t\tonremove: () => {\n\t\t\t\t\tif (this.documentInteractionListener) {\n\t\t\t\t\t\tdocument.removeEventListener(\"click\", this.documentInteractionListener, true)\n\t\t\t\t\t\tdocument.removeEventListener(\"focus\", this.documentInteractionListener, true)\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\tm(VisualDatePicker, {\n\t\t\t\tselectedDate: dropdownDate,\n\t\t\t\tonDateSelected: (newDate, dayClick) => {\n\t\t\t\t\t// We differentiate between different selections as we sometimes* want to keep the dropdown open but still want to select the date\n\t\t\t\t\t// * with keyboard-based navigation space selects the date but keeps it open while return key will work like click\n\t\t\t\t\tthis.handleSelectedDate(newDate, onDateSelected)\n\t\t\t\t\tif (dayClick) {\n\t\t\t\t\t\t// We want to retain the focus on the input for accessibility, but we still want to close the dropdown.\n\t\t\t\t\t\tif (this.domInput) {\n\t\t\t\t\t\t\t// Focus the dom input but then override the showingDropdown right after focus.\n\t\t\t\t\t\t\t// It should be invoked after the normal listener since the listeners are appended to the end.\n\n\t\t\t\t\t\t\t// One would think that \"focus\" listeners would be called on the next event loop after we call focus() but alas.\n\t\t\t\t\t\t\t// So make sure to add the listener first.\n\t\t\t\t\t\t\tthis.domInput.addEventListener(\n\t\t\t\t\t\t\t\t\"focus\",\n\t\t\t\t\t\t\t\t() => {\n\t\t\t\t\t\t\t\t\tthis.showingDropdown = false\n\t\t\t\t\t\t\t\t\tm.redraw()\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{ once: true },\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\tthis.domInput.focus()\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tkeyHandler: (key: KeyPress) => this.handleEscapePress(key),\n\t\t\t\twide: false,\n\t\t\t\tstartOfTheWeekOffset: startOfTheWeekOffset,\n\t\t\t}),\n\t\t)\n\t}\n\n\tprivate renderMobileDateInput({ date, onDateSelected, disabled }: DatePickerAttrs): Children {\n\t\treturn m(\"input.fill-absolute\", {\n\t\t\tdisabled: disabled,\n\t\t\ttype: \"date\",\n\t\t\tstyle: {\n\t\t\t\topacity: 0,\n\t\t\t\t// This overrides platform-specific width setting, we want to cover the whole field\n\t\t\t\tminWidth: \"100%\",\n\t\t\t\tminHeight: \"100%\",\n\t\t\t},\n\t\t\t// Format as ISO date format (YYYY-MM-dd). We use luxon for that because JS Date only supports full format with time.\n\t\t\tvalue: date != null ? DateTime.fromJSDate(date).toISODate() : \"\",\n\t\t\toninput: (event: InputEvent) => {\n\t\t\t\tthis.handleNativeInput(event, onDateSelected)\n\t\t\t},\n\t\t})\n\t}\n\n\tprivate handleInput(text: string, onDateSelected: DatePickerAttrs[\"onDateSelected\"]) {\n\t\tthis.inputText = text\n\t\tconst parsedDate = this.parseDate(text)\n\t\tif (parsedDate) {\n\t\t\tonDateSelected(parsedDate)\n\t\t}\n\t}\n\n\tprivate handleSelectedDate(date: Date, onDateSelected: DatePickerAttrs[\"onDateSelected\"]) {\n\t\tthis.inputText = formatDate(date)\n\t\tonDateSelected(date)\n\t}\n\n\tprivate parseDate = memoized((text: string): Date | null => {\n\t\tconst trimmedValue = text.trim()\n\n\t\tif (trimmedValue !== \"\") {\n\t\t\ttry {\n\t\t\t\treturn parseDate(trimmedValue, (referenceDate) => formatDate(referenceDate))\n\t\t\t} catch (e) {\n\t\t\t\t// Parsing failed so the user is probably typing\n\t\t\t}\n\t\t}\n\t\treturn null\n\t})\n\n\tprivate handleInputKeyEvents(key: KeyPress, disabled: boolean | undefined, onDateSelected: (date: Date) => unknown) {\n\t\tif (isKeyPressed(key.key, Keys.DOWN)) {\n\t\t\tif (!disabled && !key.shift && !key.ctrl && !key.meta) {\n\t\t\t\tthis.showingDropdown = true\n\t\t\t}\n\t\t} else if (isKeyPressed(key.key, Keys.RETURN)) {\n\t\t\tthis.handleInput(this.inputText, onDateSelected)\n\t\t}\n\t\treturn this.handleEscapePress(key)\n\t}\n\n\tprivate handleNativeInput(event: InputEvent, onDateSelected: (date: Date) => unknown) {\n\t\t// valueAsDate is always 00:00 UTC\n\t\t// https://www.w3.org/TR/html52/sec-forms.html#date-state-typedate\n\t\tconst htmlDate = (event.target as HTMLInputElement).valueAsDate\n\t\t// It can be null if user clicks \"clear\". Ignore it.\n\t\tif (htmlDate != null) {\n\t\t\tthis.handleSelectedDate(getAllDayDateLocal(htmlDate), onDateSelected)\n\t\t}\n\t}\n}\n\ntype VisualDatePickerAttrs = {\n\tselectedDate: Date | null\n\tonDateSelected?: (date: Date, dayClick: boolean) => unknown\n\tkeyHandler?: keyHandler\n\twide: boolean\n\tstartOfTheWeekOffset: number\n}\n\n/** Date picker used on desktop. Displays a month and ability to select a month. */\nexport class VisualDatePicker implements Component<VisualDatePickerAttrs> {\n\tprivate displayingDate: Date\n\tprivate lastSelectedDate: Date | null = null\n\n\tconstructor(vnode: Vnode<VisualDatePickerAttrs>) {\n\t\tthis.displayingDate = vnode.attrs.selectedDate || getStartOfDay(new Date())\n\t}\n\n\tview(vnode: Vnode<VisualDatePickerAttrs>): Children {\n\t\tconst selectedDate = vnode.attrs.selectedDate\n\t\tif (selectedDate && !isSameDayOfDate(this.lastSelectedDate, selectedDate)) {\n\t\t\tthis.lastSelectedDate = selectedDate\n\t\t\tthis.displayingDate = new Date(selectedDate)\n\n\t\t\tthis.displayingDate.setDate(1)\n\t\t}\n\n\t\tlet date = new Date(this.displayingDate)\n\t\tlet { weeks, weekdays } = getCalendarMonth(this.displayingDate, vnode.attrs.startOfTheWeekOffset, true)\n\t\treturn m(\n\t\t\t\".flex.flex-column\",\n\t\t\t{\n\t\t\t\tonkeydown: (event: KeyboardEvent) => useKeyHandler(event, vnode.attrs.keyHandler),\n\t\t\t},\n\t\t\t[\n\t\t\t\tthis.renderPickerHeader(vnode, date),\n\t\t\t\tm(\".flex.flex-space-between\", this.renderWeekDays(vnode.attrs.wide, weekdays)),\n\t\t\t\tm(\n\t\t\t\t\t\".flex.flex-column.flex-space-around\",\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tfontSize: px(14),\n\t\t\t\t\t\t\tlineHeight: px(this.getElementWidth(vnode.attrs)),\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tweeks.map((w) => this.renderWeek(w, vnode.attrs)),\n\t\t\t\t),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderPickerHeader(vnode: Vnode<VisualDatePickerAttrs>, date: Date): Children {\n\t\tconst size = this.getElementWidth(vnode.attrs)\n\t\treturn m(\".flex.flex-space-between.pt-s.pb-s.items-center\", [\n\t\t\trenderSwitchMonthArrowIcon(false, size, () => this.onPrevMonthSelected()),\n\t\t\tm(\n\t\t\t\t\".b\",\n\t\t\t\t{\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tfontSize: px(14),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tformatMonthWithFullYear(date),\n\t\t\t),\n\t\t\trenderSwitchMonthArrowIcon(true, size, () => this.onNextMonthSelected()),\n\t\t])\n\t}\n\n\tprivate onPrevMonthSelected() {\n\t\tthis.displayingDate.setMonth(this.displayingDate.getMonth() - 1)\n\t}\n\n\tprivate onNextMonthSelected() {\n\t\tthis.displayingDate.setMonth(this.displayingDate.getMonth() + 1)\n\t}\n\n\tprivate renderDay({ date, day, isPaddingDay }: CalendarDay, index: number, attrs: VisualDatePickerAttrs): Children {\n\t\tconst isSelectedDay = isSameDayOfDate(date, attrs.selectedDate)\n\t\t// We need a day to tab onto if the selected day is not visible, so we use the first day of the month\n\t\tconst isSubstituteDay = attrs.selectedDate?.getMonth() !== date.getMonth() && date.getDate() === 1\n\t\tconst isTabbable = !isPaddingDay && (isSelectedDay || isSubstituteDay)\n\n\t\tconst size = this.getElementWidth(attrs)\n\t\tconst selector = isSelectedDay && !isPaddingDay ? \".circle.accent-bg\" : \"\"\n\t\treturn m(\n\t\t\t\".rel.flex.items-center.justify-center\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\theight: px(size),\n\t\t\t\t\twidth: px(size),\n\t\t\t\t},\n\t\t\t\tclass: isPaddingDay ? undefined : \"click\",\n\t\t\t\t\"aria-hidden\": `${isPaddingDay}`,\n\t\t\t\t\"aria-label\": date.toLocaleDateString(),\n\t\t\t\t\"aria-selected\": `${isSelectedDay}`,\n\t\t\t\trole: \"option\",\n\t\t\t\ttabindex: isTabbable ? TabIndex.Default : TabIndex.Programmatic,\n\t\t\t\tonclick: isPaddingDay ? undefined : () => attrs.onDateSelected?.(date, true),\n\t\t\t\tonkeydown: (event: KeyboardEvent) => {\n\t\t\t\t\tconst key = keyboardEventToKeyPress(event)\n\t\t\t\t\tconst target = event.target as HTMLInputElement\n\n\t\t\t\t\tif (isKeyPressed(key.key, Keys.LEFT)) {\n\t\t\t\t\t\tlet targetDay\n\n\t\t\t\t\t\tif (target.previousElementSibling == null) {\n\t\t\t\t\t\t\t// If the user presses left on the first day of the week, go to the last day of the previous week\n\t\t\t\t\t\t\ttargetDay = target.parentElement?.previousElementSibling?.children.item(6)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\ttargetDay = target.previousElementSibling\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!this.focusDayIfPossible(target, targetDay)) {\n\t\t\t\t\t\t\tthis.onPrevMonthSelected()\n\t\t\t\t\t\t\tm.redraw.sync()\n\t\t\t\t\t\t\tthis.focusLastDay(target)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isKeyPressed(key.key, Keys.RIGHT)) {\n\t\t\t\t\t\tlet targetDay\n\n\t\t\t\t\t\tif (target.nextElementSibling == null) {\n\t\t\t\t\t\t\ttargetDay = target.parentElement?.nextElementSibling?.children.item(0)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\ttargetDay = target.nextElementSibling\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!this.focusDayIfPossible(target, targetDay)) {\n\t\t\t\t\t\t\tthis.onNextMonthSelected()\n\t\t\t\t\t\t\tm.redraw.sync()\n\t\t\t\t\t\t\tthis.focusFirstDay(target)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isKeyPressed(key.key, Keys.UP)) {\n\t\t\t\t\t\tconst dayAbove = target.parentElement?.previousElementSibling?.children.item(index)\n\t\t\t\t\t\tif (!this.focusDayIfPossible(target, dayAbove)) {\n\t\t\t\t\t\t\t// If the user presses up on the first week, go to the same day of the previous week\n\t\t\t\t\t\t\tthis.onPrevMonthSelected()\n\t\t\t\t\t\t\tm.redraw.sync()\n\t\t\t\t\t\t\tthis.focusLastWeekDay(target, index)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isKeyPressed(key.key, Keys.DOWN)) {\n\t\t\t\t\t\tconst dayBelow = target.parentElement?.nextElementSibling?.children.item(index)\n\t\t\t\t\t\tif (!this.focusDayIfPossible(target, dayBelow)) {\n\t\t\t\t\t\t\tthis.onNextMonthSelected()\n\t\t\t\t\t\t\tm.redraw.sync()\n\t\t\t\t\t\t\tthis.focusFirstWeekDay(target, index)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isKeyPressed(key.key, Keys.HOME) && !isPaddingDay) {\n\t\t\t\t\t\tthis.focusFirstDay(target)\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isKeyPressed(key.key, Keys.END) && !isPaddingDay) {\n\t\t\t\t\t\tthis.focusLastDay(target)\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isKeyPressed(key.key, Keys.PAGE_UP) && !isPaddingDay) {\n\t\t\t\t\t\tif (key.shift) {\n\t\t\t\t\t\t\tthis.displayingDate.setFullYear(this.displayingDate.getFullYear() - 1)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.onPrevMonthSelected()\n\t\t\t\t\t\t}\n\t\t\t\t\t\tm.redraw.sync()\n\t\t\t\t\t\tthis.focusFirstDay(target)\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isKeyPressed(key.key, Keys.PAGE_DOWN) && !isPaddingDay) {\n\t\t\t\t\t\tif (key.shift) {\n\t\t\t\t\t\t\tthis.displayingDate.setFullYear(this.displayingDate.getFullYear() + 1)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.onNextMonthSelected()\n\t\t\t\t\t\t}\n\t\t\t\t\t\tm.redraw.sync()\n\t\t\t\t\t\tthis.focusFirstDay(target)\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isKeyPressed(key.key, Keys.RETURN) && !isPaddingDay) {\n\t\t\t\t\t\tattrs.onDateSelected?.(date, true)\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t}\n\n\t\t\t\t\tif (isKeyPressed(key.key, Keys.SPACE) && !isPaddingDay) {\n\t\t\t\t\t\tattrs.onDateSelected?.(date, false)\n\t\t\t\t\t\tevent.preventDefault()\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(\".abs.z1\" + selector, {\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\twidth: px(size),\n\t\t\t\t\t\theight: px(size),\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tm(selector + \".full-width.height-100p.center.z2\", { style: { \"background-color\": \"transparent\" } }, isPaddingDay ? null : day),\n\t\t\t],\n\t\t)\n\t}\n\n\t// Focuses on a day if it is not a padding day & returns whether it focused on the day\n\tprivate focusDayIfPossible(previousElement: HTMLElement, dayElement: globalThis.Element | null | undefined): boolean {\n\t\tconst element = dayElement as HTMLInputElement | null | undefined\n\t\tif (element != null && element.ariaHidden === \"false\") {\n\t\t\telement.focus()\n\t\t\t// Put the currently focused element into the tab index so the next tab press follows the tab index\n\t\t\telement.tabIndex = 0\n\t\t\tpreviousElement.tabIndex = -1\n\t\t\treturn true\n\t\t}\n\t\treturn false\n\t}\n\n\t// Focus the last day of the month in the calendar\n\tprivate focusLastDay(target: HTMLInputElement) {\n\t\tconst weeks = target.parentElement?.parentElement?.children\n\t\tif (weeks != null) {\n\t\t\tfor (let i = weeks.length - 1; i >= 0; i--) {\n\t\t\t\tconst week = weeks.item(i)?.children\n\t\t\t\tlet isDateFound = false\n\t\t\t\tif (week != null) {\n\t\t\t\t\tfor (let j = week.length - 1; j >= 0; j--) {\n\t\t\t\t\t\tconst child = week.item(j)\n\t\t\t\t\t\tif (this.focusDayIfPossible(target, child)) {\n\t\t\t\t\t\t\tisDateFound = true\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (isDateFound) break\n\t\t\t}\n\t\t}\n\t}\n\n\t// Focus a day in the final week of the calendar\n\tprivate focusLastWeekDay(target: HTMLInputElement, weekDay: number) {\n\t\tconst weeks = target.parentElement?.parentElement?.children\n\t\tif (weeks != null) {\n\t\t\tfor (let i = weeks.length - 1; i >= 0; i--) {\n\t\t\t\tconst week = weeks.item(i)?.children\n\t\t\t\tif (week != null) {\n\t\t\t\t\tconst child = week.item(weekDay)\n\t\t\t\t\tif (this.focusDayIfPossible(target, child)) {\n\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// Focus the first day of the month in the calendar\n\tprivate focusFirstDay(target: HTMLInputElement) {\n\t\tconst weeks = target.parentElement?.parentElement?.children\n\t\tif (weeks != null) {\n\t\t\tfor (let i = 0; i < weeks.length; i++) {\n\t\t\t\tconst week = weeks.item(i)?.children\n\t\t\t\tlet isDateFound = false\n\t\t\t\tif (week != null) {\n\t\t\t\t\tfor (let j = 0; j < week.length; j++) {\n\t\t\t\t\t\tconst child = week.item(j)\n\t\t\t\t\t\tif (this.focusDayIfPossible(target, child)) {\n\t\t\t\t\t\t\tisDateFound = true\n\t\t\t\t\t\t\tbreak\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (isDateFound) break\n\t\t\t}\n\t\t}\n\t}\n\n\t// Focus a day in the first week of the calendar\n\tprivate focusFirstWeekDay(target: HTMLInputElement, weekDay: number) {\n\t\tconst weeks = target.parentElement?.parentElement?.children\n\t\tif (weeks != null) {\n\t\t\tfor (let i = 0; i < weeks.length; i++) {\n\t\t\t\tconst week = weeks.item(i)?.children\n\t\t\t\tif (week != null) {\n\t\t\t\t\tconst child = week.item(weekDay)\n\t\t\t\t\tif (this.focusDayIfPossible(target, child)) {\n\t\t\t\t\t\tbreak\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate getElementWidth(attrs: VisualDatePickerAttrs): number {\n\t\treturn attrs.wide ? 40 : 24\n\t}\n\n\tprivate renderWeek(week: ReadonlyArray<CalendarDay>, attrs: VisualDatePickerAttrs): Children {\n\t\treturn m(\n\t\t\t\".flex.flex-space-between\",\n\t\t\tweek.map((d, i) => this.renderDay(d, i, attrs)),\n\t\t)\n\t}\n\n\tprivate renderWeekDays(wide: boolean, weekdays: readonly string[]): Children {\n\t\tconst size = px(wide ? 40 : 24)\n\t\tconst fontSize = px(14)\n\t\treturn weekdays.map((wd) =>\n\t\t\tm(\n\t\t\t\t\".center\",\n\t\t\t\t{\n\t\t\t\t\t\"aria-hidden\": \"true\",\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tfontSize,\n\t\t\t\t\t\theight: size,\n\t\t\t\t\t\twidth: size,\n\t\t\t\t\t\tlineHeight: size,\n\t\t\t\t\t\tcolor: theme.navigation_menu_icon,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\twd,\n\t\t\t),\n\t\t)\n\t}\n}\n","import m, { Children, Component, Vnode } from \"mithril\"\nimport { TextFieldType as TextFieldType } from \"../../../../common/gui/base/TextField.js\"\nimport { theme } from \"../../../../common/gui/theme.js\"\nimport { TabIndex, TimeFormat } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport { timeStringFromParts } from \"../../../../common/misc/Formatter.js\"\nimport { Time } from \"../../../../common/calendar/date/Time.js\"\nimport { Select, SelectAttributes } from \"../../../../common/gui/base/Select.js\"\nimport { SingleLineTextField } from \"../../../../common/gui/base/SingleLineTextField.js\"\nimport { isApp } from \"../../../../common/api/common/Env.js\"\nimport { px, size } from \"../../../../common/gui/size.js\"\nimport stream from \"mithril/stream\"\n\nexport type TimePickerAttrs = {\n\ttime: Time | null\n\tonTimeSelected: (arg0: Time | null) => unknown\n\ttimeFormat: TimeFormat\n\tdisabled?: boolean\n\tariaLabel: string\n\tclasses?: Array<string>\n}\n\ninterface TimeOption {\n\tvalue: string\n\tariaValue: string\n\tname: string\n}\n\nexport class TimePicker implements Component<TimePickerAttrs> {\n\tprivate values: ReadonlyArray<string>\n\tprivate focused: boolean\n\tprivate isExpanded: boolean = false\n\tprivate oldValue: string\n\tprivate value: string\n\tprivate readonly amPm: boolean\n\n\tconstructor({ attrs }: Vnode<TimePickerAttrs>) {\n\t\tthis.focused = false\n\t\tthis.value = \"\"\n\t\tthis.amPm = attrs.timeFormat === TimeFormat.TWELVE_HOURS\n\t\tconst times: string[] = []\n\n\t\tfor (let hour = 0; hour < 24; hour++) {\n\t\t\tfor (let minute = 0; minute < 60; minute += 30) {\n\t\t\t\ttimes.push(timeStringFromParts(hour, minute, this.amPm))\n\t\t\t}\n\t\t}\n\t\tthis.oldValue = attrs.time?.toString(false) ?? \"--\"\n\t\tthis.values = times\n\t}\n\n\tview({ attrs }: Vnode<TimePickerAttrs>): Children {\n\t\tif (attrs.time) {\n\t\t\tconst timeAsString = attrs.time?.toString(this.amPm) ?? \"\"\n\n\t\t\tif (!this.focused) {\n\t\t\t\tthis.value = timeAsString\n\t\t\t}\n\t\t}\n\n\t\tif (isApp()) {\n\t\t\treturn this.renderNativeTimePicker(attrs)\n\t\t} else {\n\t\t\treturn this.renderCustomTimePicker(attrs)\n\t\t}\n\t}\n\n\tprivate renderNativeTimePicker(attrs: TimePickerAttrs): Children {\n\t\tif (this.oldValue !== attrs.time?.toString(false)) {\n\t\t\tthis.onSelected(attrs)\n\t\t}\n\n\t\t// input[type=time] wants time in 24h format, no matter what is actually displayed. Otherwise it will be empty.\n\t\tconst timeAsString = attrs.time?.toString(false) ?? \"\"\n\t\tthis.oldValue = timeAsString\n\t\tthis.value = timeAsString\n\n\t\tconst displayTime = attrs.time?.toString(this.amPm)\n\n\t\treturn m(\".rel\", [\n\t\t\tm(\"input.fill-absolute.invisible.tutaui-button-outline\", {\n\t\t\t\tdisabled: attrs.disabled,\n\t\t\t\ttype: TextFieldType.Time,\n\t\t\t\tstyle: {\n\t\t\t\t\tzIndex: 1,\n\t\t\t\t\tborder: `2px solid ${theme.content_message_bg}`,\n\t\t\t\t\twidth: \"auto\",\n\t\t\t\t\theight: \"auto\",\n\t\t\t\t\tappearance: \"none\",\n\t\t\t\t\topacity: attrs.disabled ? 0.7 : 1.0,\n\t\t\t\t},\n\t\t\t\tvalue: this.value,\n\t\t\t\toninput: (event: InputEvent) => {\n\t\t\t\t\tconst inputValue = (event.target as HTMLInputElement).value\n\t\t\t\t\tif (this.value === inputValue) {\n\t\t\t\t\t\treturn\n\t\t\t\t\t}\n\t\t\t\t\tthis.value = inputValue\n\t\t\t\t\tattrs.onTimeSelected(Time.parseFromString(inputValue))\n\t\t\t\t},\n\t\t\t}),\n\t\t\tm(\n\t\t\t\t\".tutaui-button-outline\",\n\t\t\t\t{\n\t\t\t\t\tclass: attrs.classes?.join(\" \"),\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tzIndex: \"2\",\n\t\t\t\t\t\tposition: \"inherit\",\n\t\t\t\t\t\tborderColor: \"transparent\",\n\t\t\t\t\t\tpointerEvents: \"none\",\n\t\t\t\t\t\tpadding: `${px(size.vpad_small)} 0`,\n\t\t\t\t\t\topacity: attrs.disabled ? 0.7 : 1.0,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tdisplayTime,\n\t\t\t),\n\t\t])\n\t}\n\n\tprivate renderCustomTimePicker(attrs: TimePickerAttrs): Children {\n\t\tconst options = this.values.map((time) => ({\n\t\t\tvalue: time,\n\t\t\tname: time,\n\t\t\tariaValue: time,\n\t\t}))\n\n\t\treturn m(Select<TimeOption, string>, {\n\t\t\tonchange: (newValue) => {\n\t\t\t\tif (this.value === newValue.value) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tthis.value = newValue.value\n\t\t\t\tthis.onSelected(attrs)\n\t\t\t\tm.redraw.sync()\n\t\t\t},\n\t\t\tonclose: () => {\n\t\t\t\tthis.isExpanded = false\n\t\t\t},\n\t\t\tselected: { value: this.value, name: this.value, ariaValue: this.value },\n\t\t\tariaLabel: attrs.ariaLabel,\n\t\t\tdisabled: attrs.disabled,\n\t\t\toptions: stream(options),\n\t\t\tnoIcon: true,\n\t\t\texpanded: true,\n\t\t\ttabIndex: Number(TabIndex.Programmatic),\n\t\t\trenderDisplay: () => this.renderTimeSelectInput(attrs),\n\t\t\trenderOption: (option) => this.renderTimeOptions(option),\n\t\t\tkeepFocus: true,\n\t\t} satisfies SelectAttributes<TimeOption, string>)\n\t}\n\n\tprivate renderTimeOptions(option: TimeOption) {\n\t\treturn m(\n\t\t\t\"button.items-center.flex-grow\",\n\t\t\t{\n\t\t\t\tclass: \"state-bg button-content dropdown-button pt-s pb-s button-min-height\",\n\t\t\t},\n\t\t\toption.name,\n\t\t)\n\t}\n\n\tprivate renderTimeSelectInput(attrs: TimePickerAttrs) {\n\t\treturn m(SingleLineTextField, {\n\t\t\tclasses: [...(attrs.classes ?? []), \"tutaui-button-outline\", \"text-center\", \"border-content-message-bg\"],\n\t\t\tvalue: this.value,\n\t\t\toninput: (val: string) => {\n\t\t\t\tif (this.value === val) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tthis.value = val\n\t\t\t},\n\t\t\tdisabled: attrs.disabled,\n\t\t\tariaLabel: attrs.ariaLabel,\n\t\t\tstyle: {\n\t\t\t\ttextAlign: \"center\",\n\t\t\t},\n\t\t\tonclick: (e: MouseEvent) => {\n\t\t\t\te.stopImmediatePropagation()\n\t\t\t\tif (!this.isExpanded) {\n\t\t\t\t\t;(e.target as HTMLElement).parentElement?.click()\n\t\t\t\t\tthis.isExpanded = true\n\t\t\t\t}\n\t\t\t},\n\t\t\tonfocus: (event: FocusEvent) => {\n\t\t\t\tthis.focused = true\n\t\t\t\tif (!this.isExpanded) {\n\t\t\t\t\t;(event.target as HTMLElement).parentElement?.click()\n\t\t\t\t\tthis.isExpanded = true\n\t\t\t\t}\n\t\t\t},\n\t\t\tonblur: (e: any) => {\n\t\t\t\tif (this.focused) {\n\t\t\t\t\tthis.onSelected(attrs)\n\t\t\t\t}\n\n\t\t\t\te.redraw = false\n\t\t\t},\n\t\t\ttype: TextFieldType.Text,\n\t\t})\n\t}\n\n\tprivate onSelected(attrs: TimePickerAttrs) {\n\t\tthis.focused = false\n\n\t\tattrs.onTimeSelected(Time.parseFromString(this.value))\n\t}\n}\n","import m, { Component, Vnode } from \"mithril\"\nimport { TimeFormat } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport { lang } from \"../../../../common/misc/LanguageViewModel.js\"\nimport { CalendarEventWhenModel } from \"../eventeditor-model/CalendarEventWhenModel.js\"\nimport { Switch } from \"../../../../common/gui/base/Switch.js\"\nimport { Icon, IconSize } from \"../../../../common/gui/base/Icon.js\"\nimport { Icons } from \"../../../../common/gui/base/icons/Icons.js\"\nimport { theme } from \"../../../../common/gui/theme.js\"\nimport { isApp } from \"../../../../common/api/common/Env.js\"\nimport { DatePicker } from \"../pickers/DatePicker.js\"\nimport { TimePicker } from \"../pickers/TimePicker.js\"\nimport { px, size } from \"../../../../common/gui/size.js\"\nimport { Divider } from \"../../../../common/gui/Divider.js\"\n\nexport type EventTimeEditorAttrs = {\n\tstartOfTheWeekOffset: number\n\ttimeFormat: TimeFormat\n\teditModel: CalendarEventWhenModel\n\tdisabled: boolean\n}\n\n/**\n * an editor component to edit the start date and end date of a calendar event.\n * also allows to edit start time and end time for events where that makes sense (ie not all-day)\n */\nexport class EventTimeEditor implements Component<EventTimeEditorAttrs> {\n\tview(vnode: Vnode<EventTimeEditorAttrs>) {\n\t\tconst { attrs } = vnode\n\t\tconst { startOfTheWeekOffset, editModel, timeFormat, disabled } = attrs\n\n\t\tconst appClasses = isApp() ? [\"smaller\"] : []\n\n\t\treturn m(\".flex\", [\n\t\t\tm(\".flex.col.flex-grow.gap-vpad-s\", [\n\t\t\t\tm(\".flex.gap-vpad-s.items-center.pr-vpad-s\", [\n\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\ticon: Icons.Time,\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tfill: theme.content_fg,\n\t\t\t\t\t\t},\n\t\t\t\t\t\ttitle: lang.get(\"timeSection_label\"),\n\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t}),\n\t\t\t\t\tm(\n\t\t\t\t\t\tSwitch,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tchecked: editModel.isAllDay,\n\t\t\t\t\t\t\tonclick: (value) => (editModel.isAllDay = value),\n\t\t\t\t\t\t\tariaLabel: lang.get(\"allDay_label\"),\n\t\t\t\t\t\t\tdisabled: disabled,\n\t\t\t\t\t\t\tvariant: \"expanded\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\tlang.get(\"allDay_label\"),\n\t\t\t\t\t),\n\t\t\t\t]),\n\t\t\t\tm(\".flex.col.full-width.flex-grow.gap-vpad-s\", { style: { paddingLeft: px(size.icon_size_large + size.vpad_small) } }, [\n\t\t\t\t\tm(Divider, { color: theme.button_bubble_bg }),\n\t\t\t\t\tm(\".time-selection-grid.pr-vpad-s\", [\n\t\t\t\t\t\tm(\"\", lang.get(\"dateFrom_label\")),\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t`${isApp() ? \"\" : \".pl-vpad-l\"}`,\n\t\t\t\t\t\t\tm(DatePicker, {\n\t\t\t\t\t\t\t\tclasses: appClasses,\n\t\t\t\t\t\t\t\tdate: attrs.editModel.startDate,\n\t\t\t\t\t\t\t\tonDateSelected: (date) => date && (editModel.startDate = date),\n\t\t\t\t\t\t\t\tstartOfTheWeekOffset,\n\t\t\t\t\t\t\t\tlabel: \"dateFrom_label\",\n\t\t\t\t\t\t\t\tuseInputButton: true,\n\t\t\t\t\t\t\t\tdisabled: attrs.disabled,\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t),\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\"\",\n\t\t\t\t\t\t\tm(TimePicker, {\n\t\t\t\t\t\t\t\tclasses: appClasses,\n\t\t\t\t\t\t\t\ttime: editModel.startTime,\n\t\t\t\t\t\t\t\tonTimeSelected: (time) => (editModel.startTime = time),\n\t\t\t\t\t\t\t\ttimeFormat,\n\t\t\t\t\t\t\t\tdisabled: attrs.disabled || attrs.editModel.isAllDay,\n\t\t\t\t\t\t\t\tariaLabel: lang.get(\"startTime_label\"),\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t),\n\t\t\t\t\t\tm(\"\", lang.get(\"dateTo_label\")),\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t`${isApp() ? \"\" : \".pl-vpad-l\"}`,\n\t\t\t\t\t\t\tm(DatePicker, {\n\t\t\t\t\t\t\t\tclasses: appClasses,\n\t\t\t\t\t\t\t\tdate: attrs.editModel.endDate,\n\t\t\t\t\t\t\t\tonDateSelected: (date) => date && (editModel.endDate = date),\n\t\t\t\t\t\t\t\tstartOfTheWeekOffset,\n\t\t\t\t\t\t\t\tlabel: \"dateTo_label\",\n\t\t\t\t\t\t\t\tuseInputButton: true,\n\t\t\t\t\t\t\t\tdisabled: attrs.disabled,\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t),\n\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\"\",\n\t\t\t\t\t\t\tm(TimePicker, {\n\t\t\t\t\t\t\t\tclasses: appClasses,\n\t\t\t\t\t\t\t\ttime: editModel.endTime,\n\t\t\t\t\t\t\t\tonTimeSelected: (time) => (editModel.endTime = time),\n\t\t\t\t\t\t\t\ttimeFormat,\n\t\t\t\t\t\t\t\tdisabled: attrs.disabled || attrs.editModel.isAllDay,\n\t\t\t\t\t\t\t\tariaLabel: lang.get(\"endTime_label\"),\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t),\n\t\t\t\t\t]),\n\t\t\t\t]),\n\t\t\t]),\n\t\t])\n\t}\n}\n","import m, { Children, Component, Vnode } from \"mithril\"\nimport { TextField, TextFieldAttrs, TextFieldType } from \"../../../common/gui/base/TextField.js\"\nimport { createAlarmIntervalItems, createCustomRepeatRuleUnitValues, humanDescriptionForAlarmInterval } from \"./CalendarGuiUtils.js\"\nimport { lang, TranslationKey } from \"../../../common/misc/LanguageViewModel.js\"\nimport { IconButton } from \"../../../common/gui/base/IconButton.js\"\nimport { Icons } from \"../../../common/gui/base/icons/Icons.js\"\nimport { attachDropdown } from \"../../../common/gui/base/Dropdown.js\"\nimport { AlarmInterval, AlarmIntervalUnit } from \"../../../common/calendar/date/CalendarUtils.js\"\nimport { Dialog } from \"../../../common/gui/base/Dialog.js\"\nimport { DropDownSelector } from \"../../../common/gui/base/DropDownSelector.js\"\nimport { deepEqual } from \"@tutao/tutanota-utils\"\nimport { Select, SelectAttributes, SelectOption } from \"../../../common/gui/base/Select.js\"\nimport { Icon, IconSize } from \"../../../common/gui/base/Icon.js\"\nimport { BaseButton } from \"../../../common/gui/base/buttons/BaseButton.js\"\nimport { ButtonColor, getColors } from \"../../../common/gui/base/Button.js\"\nimport stream from \"mithril/stream\"\nimport { TabIndex } from \"../../../common/api/common/TutanotaConstants.js\"\n\nexport type RemindersEditorAttrs = {\n\taddAlarm: (alarm: AlarmInterval) => unknown\n\tremoveAlarm: (alarm: AlarmInterval) => unknown\n\talarms: readonly AlarmInterval[]\n\tlabel: TranslationKey\n\tuseNewEditor: boolean\n}\n\nexport interface RemindersSelectOption extends SelectOption<AlarmInterval> {\n\ttext: string\n}\n\nexport class RemindersEditor implements Component<RemindersEditorAttrs> {\n\tview(vnode: Vnode<RemindersEditorAttrs>): Children {\n\t\tconst { addAlarm, removeAlarm, alarms, useNewEditor } = vnode.attrs\n\t\tconst addNewAlarm = (newAlarm: AlarmInterval) => {\n\t\t\tconst hasAlarm = alarms.find((alarm) => deepEqual(alarm, newAlarm))\n\t\t\tif (hasAlarm) return\n\t\t\taddAlarm(newAlarm)\n\t\t}\n\t\treturn useNewEditor ? this.renderNewEditor(alarms, removeAlarm, addNewAlarm, addAlarm) : this.renderOldEditor(alarms, removeAlarm, addNewAlarm, vnode)\n\t}\n\n\tprivate renderOldEditor(\n\t\talarms: readonly AlarmInterval[],\n\t\tremoveAlarm: (alarm: AlarmInterval) => unknown,\n\t\taddNewAlarm: (newAlarm: AlarmInterval) => void,\n\t\tvnode: Vnode<RemindersEditorAttrs>,\n\t) {\n\t\tconst textFieldAttrs: Array<TextFieldAttrs> = alarms.map((a) => ({\n\t\t\tvalue: humanDescriptionForAlarmInterval(a, lang.languageTag),\n\t\t\tlabel: \"emptyString_msg\",\n\t\t\tisReadOnly: true,\n\t\t\tinjectionsRight: () =>\n\t\t\t\tm(IconButton, {\n\t\t\t\t\ttitle: \"delete_action\",\n\t\t\t\t\ticon: Icons.Cancel,\n\t\t\t\t\tclick: () => removeAlarm(a),\n\t\t\t\t}),\n\t\t}))\n\n\t\ttextFieldAttrs.push({\n\t\t\tvalue: lang.get(\"add_action\"),\n\t\t\tlabel: \"emptyString_msg\",\n\t\t\tisReadOnly: true,\n\t\t\tinjectionsRight: () =>\n\t\t\t\tm(\n\t\t\t\t\tIconButton,\n\t\t\t\t\tattachDropdown({\n\t\t\t\t\t\tmainButtonAttrs: {\n\t\t\t\t\t\t\ttitle: \"add_action\",\n\t\t\t\t\t\t\ticon: Icons.Add,\n\t\t\t\t\t\t},\n\t\t\t\t\t\tchildAttrs: () => [\n\t\t\t\t\t\t\t...createAlarmIntervalItems(lang.languageTag).map((i) => ({\n\t\t\t\t\t\t\t\tlabel: lang.makeTranslation(i.name, i.name),\n\t\t\t\t\t\t\t\tclick: () => addNewAlarm(i.value),\n\t\t\t\t\t\t\t})),\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlabel: \"calendarReminderIntervalDropdownCustomItem_label\",\n\t\t\t\t\t\t\t\tclick: () => {\n\t\t\t\t\t\t\t\t\tthis.showCustomReminderIntervalDialog((value, unit) => {\n\t\t\t\t\t\t\t\t\t\taddNewAlarm({\n\t\t\t\t\t\t\t\t\t\t\tvalue,\n\t\t\t\t\t\t\t\t\t\t\tunit,\n\t\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t],\n\t\t\t\t\t}),\n\t\t\t\t),\n\t\t})\n\n\t\ttextFieldAttrs[0].label = vnode.attrs.label\n\n\t\treturn m(\n\t\t\t\".flex.col.flex-half.pl-s\",\n\t\t\ttextFieldAttrs.map((a) => m(TextField, a)),\n\t\t)\n\t}\n\n\tprivate renderNewEditor(\n\t\talarms: readonly AlarmInterval[],\n\t\tremoveAlarm: (alarm: AlarmInterval) => unknown,\n\t\taddNewAlarm: (newAlarm: AlarmInterval) => void,\n\t\taddAlarm: (alarm: AlarmInterval) => unknown,\n\t) {\n\t\tconst alarmOptions = createAlarmIntervalItems(lang.languageTag).map(\n\t\t\t(alarm) =>\n\t\t\t\t({\n\t\t\t\t\ttext: alarm.name,\n\t\t\t\t\tvalue: alarm.value,\n\t\t\t\t\tariaValue: alarm.name,\n\t\t\t\t} satisfies RemindersSelectOption),\n\t\t)\n\n\t\talarmOptions.push({\n\t\t\ttext: lang.get(\"calendarReminderIntervalDropdownCustomItem_label\"),\n\t\t\tariaValue: lang.get(\"calendarReminderIntervalDropdownCustomItem_label\"),\n\t\t\tvalue: { value: -1, unit: AlarmIntervalUnit.MINUTE },\n\t\t})\n\n\t\tconst defaultSelected = {\n\t\t\ttext: lang.get(\"addReminder_label\"),\n\t\t\tvalue: { value: -2, unit: AlarmIntervalUnit.MINUTE },\n\t\t\tariaValue: lang.get(\"addReminder_label\"),\n\t\t}\n\n\t\treturn m(\"ul.unstyled-list.flex.col.flex-grow.gap-vpad-s\", [\n\t\t\talarms.map((alarm) =>\n\t\t\t\tm(\"li.flex.justify-between.flew-grow.items-center.gap-vpad-s\", [\n\t\t\t\t\tm(\"span.flex.justify-between\", humanDescriptionForAlarmInterval(alarm, lang.languageTag)),\n\t\t\t\t\tm(\n\t\t\t\t\t\tBaseButton,\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t//This might not make sense in other languages, but is better than what we have now\n\t\t\t\t\t\t\tlabel: lang.makeTranslation(\n\t\t\t\t\t\t\t\t\"delete_action\",\n\t\t\t\t\t\t\t\t`${lang.get(\"delete_action\")} ${humanDescriptionForAlarmInterval(alarm, lang.languageTag)}`,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\tonclick: () => removeAlarm(alarm),\n\t\t\t\t\t\t\tclass: \"flex items-center\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\t\ticon: Icons.Cancel,\n\t\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\tfill: getColors(ButtonColor.Content).button,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}),\n\t\t\t\t\t),\n\t\t\t\t]),\n\t\t\t),\n\t\t\tm(\n\t\t\t\t\"li.items-center\",\n\t\t\t\tm(Select<RemindersSelectOption, AlarmInterval>, {\n\t\t\t\t\tariaLabel: lang.get(\"calendarReminderIntervalValue_label\"),\n\t\t\t\t\tselected: defaultSelected,\n\t\t\t\t\toptions: stream(alarmOptions),\n\t\t\t\t\trenderOption: (option) => this.renderReminderOptions(option, false, false),\n\t\t\t\t\trenderDisplay: (option) => this.renderReminderOptions(option, alarms.length > 0, true),\n\t\t\t\t\tonchange: (newValue) => {\n\t\t\t\t\t\tif (newValue.value.value === -1) {\n\t\t\t\t\t\t\t// timeout needed to prevent the custom interval dialog to be closed by the key event triggered inside the select component\n\t\t\t\t\t\t\treturn setTimeout(() => {\n\t\t\t\t\t\t\t\tthis.showCustomReminderIntervalDialog((value, unit) => {\n\t\t\t\t\t\t\t\t\taddNewAlarm({\n\t\t\t\t\t\t\t\t\t\tvalue,\n\t\t\t\t\t\t\t\t\t\tunit,\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t}, 0)\n\t\t\t\t\t\t}\n\t\t\t\t\t\taddAlarm(newValue.value)\n\t\t\t\t\t},\n\t\t\t\t\texpanded: true,\n\t\t\t\t\ticonColor: getColors(ButtonColor.Content).button,\n\t\t\t\t\tnoIcon: true,\n\t\t\t\t} satisfies SelectAttributes<RemindersSelectOption, AlarmInterval>),\n\t\t\t),\n\t\t])\n\t}\n\n\tprivate renderReminderOptions(option: RemindersSelectOption, hasAlarms: boolean, isDisplay: boolean) {\n\t\treturn m(\n\t\t\t\"button.items-center.flex-grow\",\n\t\t\t{\n\t\t\t\ttabIndex: isDisplay ? TabIndex.Programmatic : undefined,\n\t\t\t\tclass: isDisplay ? `flex ${hasAlarms ? \"text-fade\" : \"\"}` : \"state-bg button-content button-min-height dropdown-button pt-s pb-s\",\n\t\t\t},\n\t\t\toption.text,\n\t\t)\n\t}\n\n\tprivate showCustomReminderIntervalDialog(onAddAction: (value: number, unit: AlarmIntervalUnit) => void) {\n\t\tlet timeReminderValue = 0\n\t\tlet timeReminderUnit: AlarmIntervalUnit = AlarmIntervalUnit.MINUTE\n\n\t\tDialog.showActionDialog({\n\t\t\ttitle: \"calendarReminderIntervalCustomDialog_title\",\n\t\t\tallowOkWithReturn: true,\n\t\t\tchild: {\n\t\t\t\tview: () => {\n\t\t\t\t\tconst unitItems = createCustomRepeatRuleUnitValues() ?? []\n\t\t\t\t\treturn m(\".flex full-width pt-s\", [\n\t\t\t\t\t\tm(TextField, {\n\t\t\t\t\t\t\ttype: TextFieldType.Number,\n\t\t\t\t\t\t\tmin: 0,\n\t\t\t\t\t\t\tlabel: \"calendarReminderIntervalValue_label\",\n\t\t\t\t\t\t\tvalue: timeReminderValue.toString(),\n\t\t\t\t\t\t\toninput: (v) => {\n\t\t\t\t\t\t\t\tconst time = Number.parseInt(v)\n\t\t\t\t\t\t\t\tconst isEmpty = v === \"\"\n\t\t\t\t\t\t\t\tif (!Number.isNaN(time) || isEmpty) timeReminderValue = isEmpty ? 0 : Math.abs(time)\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tclass: \"flex-half no-appearance\", //Removes the up/down arrow from input number. Pressing arrow up/down key still working\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tm(DropDownSelector, {\n\t\t\t\t\t\t\tlabel: \"emptyString_msg\",\n\t\t\t\t\t\t\tselectedValue: timeReminderUnit,\n\t\t\t\t\t\t\titems: unitItems,\n\t\t\t\t\t\t\tclass: \"flex-half pl-s\",\n\t\t\t\t\t\t\tselectionChangedHandler: (selectedValue: AlarmIntervalUnit) => (timeReminderUnit = selectedValue as AlarmIntervalUnit),\n\t\t\t\t\t\t\tdisabled: false,\n\t\t\t\t\t\t}),\n\t\t\t\t\t])\n\t\t\t\t},\n\t\t\t},\n\t\t\tokActionTextId: \"add_action\",\n\t\t\tokAction: (dialog: Dialog) => {\n\t\t\t\tonAddAction(timeReminderValue, timeReminderUnit)\n\t\t\t\tdialog.close()\n\t\t\t},\n\t\t})\n\t}\n}\n","import type { MaybeTranslation } from \"../../misc/LanguageViewModel\"\nimport { lang } from \"../../misc/LanguageViewModel\"\nimport m, { Child, Children, Component, Vnode } from \"mithril\"\nimport { isKeyPressed } from \"../../misc/KeyManager.js\"\nimport { Keys } from \"../../api/common/TutanotaConstants.js\"\nimport { AriaRole } from \"../AriaUtils.js\"\n\nexport interface SingularOrPluralLabel {\n\tsingular: MaybeTranslation\n\tplural: MaybeTranslation\n}\n\nexport type RadioGroupOption<T> = {\n\treadonly name: MaybeTranslation\n\treadonly value: T\n}\n\nexport type RadioGroupAttrs<T> = {\n\t// The unique name of the radio button group. The browser uses it to group the radio buttons together.\n\tname: MaybeTranslation\n\toptions: ReadonlyArray<RadioGroupOption<T>>\n\tariaLabel: MaybeTranslation\n\tclasses?: Array<string>\n\tselectedOption: T | null\n\tonOptionSelected: (arg0: T) => unknown\n\tinjectionMap?: Map<string, Child>\n}\n\n/**\n * Component which shows selection for a single choice.\n */\nexport class RadioGroup<T> implements Component<RadioGroupAttrs<T>> {\n\tview({ attrs }: Vnode<RadioGroupAttrs<T>>): Children {\n\t\treturn m(\n\t\t\t\"ul.unstyled-list.flex.col.gap-vpad\",\n\t\t\t{\n\t\t\t\tariaLabel: lang.getTranslationText(attrs.ariaLabel),\n\t\t\t\trole: AriaRole.RadioGroup,\n\t\t\t},\n\t\t\tattrs.options.map((option) =>\n\t\t\t\tthis.renderOption(attrs.name, option, attrs.selectedOption, attrs.classes?.join(\" \"), attrs.onOptionSelected, attrs.injectionMap),\n\t\t\t),\n\t\t)\n\t}\n\n\tprivate renderOption(\n\t\tgroupName: MaybeTranslation,\n\t\toption: RadioGroupOption<T>,\n\t\tselectedOption: T | null,\n\t\toptionClass: string | undefined,\n\t\tonOptionSelected: (arg0: T) => unknown,\n\t\tinjectionMap?: Map<string, Child>,\n\t): Children {\n\t\tconst name = lang.getTranslationText(groupName)\n\t\tconst valueString = String(option.value)\n\t\tconst isSelected = option.value === selectedOption\n\n\t\t// IDs used to link the label and description for accessibility\n\t\tconst optionId = `${name}-${valueString}`\n\n\t\t// The wrapper is needed because <input> is self-closing and will not take the label as a child\n\t\treturn m(\n\t\t\t\"li.flex.gap-vpad.cursor-pointer.full-width.flash\",\n\t\t\t{\n\t\t\t\tclass: optionClass ?? \"\",\n\t\t\t\tonclick: () => {\n\t\t\t\t\tconsole.log(\"Clicked?\")\n\t\t\t\t\tonOptionSelected(option.value)\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(\"input[type=radio].m-0.big-radio.content-accent-accent\", {\n\t\t\t\t\t/* The `name` attribute defines the group the radio button belongs to. Not the name/label of the radio button itself.\n\t\t\t\t\t * See https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/radio#defining_a_radio_group\n\t\t\t\t\t */\n\t\t\t\t\tname: lang.getTranslationText(groupName),\n\t\t\t\t\tvalue: valueString,\n\t\t\t\t\tid: optionId,\n\t\t\t\t\t// Handle changes in value from the attributes\n\t\t\t\t\tchecked: isSelected ? true : null,\n\t\t\t\t\tonkeydown: (event: KeyboardEvent) => {\n\t\t\t\t\t\tif (isKeyPressed(event.key, Keys.RETURN)) {\n\t\t\t\t\t\t\tonOptionSelected(option.value)\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn true\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tm(\".flex.flex-column.full-width\", [\n\t\t\t\t\tm(\"label.cursor-pointer\", { for: optionId }, lang.getTranslationText(option.name)),\n\t\t\t\t\tthis.getInjection(String(option.value), injectionMap),\n\t\t\t\t]),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate getInjection(key: string, injectionMap?: Map<string, Child>): Child {\n\t\tif (!injectionMap || !injectionMap.has(key)) {\n\t\t\treturn null\n\t\t}\n\n\t\treturn injectionMap.get(key)\n\t}\n}\n","import m, { Child, Children, Component, Vnode } from \"mithril\"\nimport { CalendarEventWhenModel } from \"../eventeditor-model/CalendarEventWhenModel.js\"\nimport { TextFieldType } from \"../../../../common/gui/base/TextField.js\"\nimport { lang } from \"../../../../common/misc/LanguageViewModel.js\"\nimport { EndType, RepeatPeriod, TabIndex } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport { DatePicker, DatePickerAttrs, PickerPosition } from \"../pickers/DatePicker.js\"\n\nimport { createCustomEndTypeOptions, createIntervalValues, createRepeatRuleOptions, customFrequenciesOptions, IntervalOption } from \"../CalendarGuiUtils.js\"\nimport { px, size } from \"../../../../common/gui/size.js\"\nimport { Card } from \"../../../../common/gui/base/Card.js\"\nimport { RadioGroup, RadioGroupAttrs, RadioGroupOption } from \"../../../../common/gui/base/RadioGroup.js\"\nimport { InputMode, SingleLineTextField } from \"../../../../common/gui/base/SingleLineTextField.js\"\nimport { Select, SelectAttributes } from \"../../../../common/gui/base/Select.js\"\nimport stream from \"mithril/stream\"\nimport { Divider } from \"../../../../common/gui/Divider.js\"\nimport { theme } from \"../../../../common/gui/theme.js\"\nimport { isApp } from \"../../../../common/api/common/Env.js\"\n\nexport type RepeatRuleEditorAttrs = {\n\tmodel: CalendarEventWhenModel\n\tstartOfTheWeekOffset: number\n\twidth: number\n\tbackAction: () => void\n}\n\ntype RepeatRuleOption = RepeatPeriod | \"CUSTOM\" | null\n\nexport class RepeatRuleEditor implements Component<RepeatRuleEditorAttrs> {\n\tprivate repeatRuleType: RepeatRuleOption | null = null\n\tprivate repeatInterval: number = 0\n\tprivate intervalOptions: stream<IntervalOption[]> = stream([])\n\tprivate intervalExpanded: boolean = false\n\n\tprivate numberValues: IntervalOption[] = createIntervalValues()\n\n\tprivate occurrencesOptions: stream<IntervalOption[]> = stream([])\n\tprivate occurrencesExpanded: boolean = false\n\tprivate repeatOccurrences: number\n\n\tconstructor({ attrs }: Vnode<RepeatRuleEditorAttrs>) {\n\t\tif (attrs.model.repeatPeriod != null) {\n\t\t\tthis.repeatRuleType = this.getRepeatType(attrs.model.repeatPeriod, attrs.model.repeatInterval, attrs.model.repeatEndType)\n\t\t}\n\n\t\tthis.intervalOptions(this.numberValues)\n\t\tthis.occurrencesOptions(this.numberValues)\n\n\t\tthis.repeatInterval = attrs.model.repeatInterval\n\t\tthis.repeatOccurrences = attrs.model.repeatEndOccurrences\n\t}\n\n\tprivate getRepeatType(period: RepeatPeriod, interval: number, endTime: EndType) {\n\t\tif (interval > 1 || endTime !== EndType.Never) {\n\t\t\treturn \"CUSTOM\"\n\t\t}\n\n\t\treturn period\n\t}\n\n\tview({ attrs }: Vnode<RepeatRuleEditorAttrs>): Children {\n\t\tconst customRuleOptions = customFrequenciesOptions.map((option) => ({\n\t\t\t...option,\n\t\t\tname: attrs.model.repeatInterval > 1 ? option.name.plural : option.name.singular,\n\t\t})) as RadioGroupOption<RepeatPeriod>[]\n\n\t\treturn m(\n\t\t\t\".pb.pt.flex.col.gap-vpad.fit-height\",\n\t\t\t{\n\t\t\t\tclass: this.repeatRuleType === \"CUSTOM\" ? \"box-content\" : \"\",\n\t\t\t\tstyle: {\n\t\t\t\t\twidth: px(attrs.width),\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tm(\n\t\t\t\t\tCard,\n\t\t\t\t\t{\n\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\tpadding: `${size.vpad}px`,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tm(RadioGroup, {\n\t\t\t\t\t\tariaLabel: \"calendarRepeating_label\",\n\t\t\t\t\t\tname: \"calendarRepeating_label\",\n\t\t\t\t\t\toptions: createRepeatRuleOptions(),\n\t\t\t\t\t\tselectedOption: this.repeatRuleType,\n\t\t\t\t\t\tonOptionSelected: (option: RepeatRuleOption) => {\n\t\t\t\t\t\t\tthis.repeatRuleType = option\n\t\t\t\t\t\t\tif (option === \"CUSTOM\") {\n\t\t\t\t\t\t\t\tattrs.model.repeatPeriod = attrs.model.repeatPeriod ?? RepeatPeriod.DAILY\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tattrs.model.repeatInterval = 1\n\t\t\t\t\t\t\t\tattrs.model.repeatEndType = EndType.Never\n\t\t\t\t\t\t\t\tattrs.model.repeatPeriod = option as RepeatPeriod\n\t\t\t\t\t\t\t\tattrs.backAction()\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\tclasses: [\"cursor-pointer\"],\n\t\t\t\t\t} satisfies RadioGroupAttrs<RepeatRuleOption>),\n\t\t\t\t),\n\t\t\t\tthis.renderFrequencyOptions(attrs, customRuleOptions),\n\t\t\t\tthis.renderEndOptions(attrs),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderEndOptions(attrs: RepeatRuleEditorAttrs) {\n\t\tif (this.repeatRuleType !== \"CUSTOM\") {\n\t\t\treturn null\n\t\t}\n\n\t\treturn m(\".flex.col\", [\n\t\t\tm(\"small.uppercase.pb-s.b.text-ellipsis\", { style: { color: theme.navigation_button } }, lang.get(\"calendarRepeatStopCondition_label\")),\n\t\t\tm(\n\t\t\t\tCard,\n\t\t\t\t{\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tpadding: `${size.vpad}px`,\n\t\t\t\t\t},\n\t\t\t\t\tclasses: [\"flex\", \"col\", \"gap-vpad-s\"],\n\t\t\t\t},\n\t\t\t\t[\n\t\t\t\t\tm(RadioGroup, {\n\t\t\t\t\t\tariaLabel: \"calendarRepeatStopCondition_label\",\n\t\t\t\t\t\tname: \"calendarRepeatStopCondition_label\",\n\t\t\t\t\t\toptions: createCustomEndTypeOptions(),\n\t\t\t\t\t\tselectedOption: attrs.model.repeatEndType,\n\t\t\t\t\t\tonOptionSelected: (option: EndType) => {\n\t\t\t\t\t\t\tattrs.model.repeatEndType = option\n\t\t\t\t\t\t},\n\t\t\t\t\t\tclasses: [\"cursor-pointer\"],\n\t\t\t\t\t\tinjectionMap: this.buildInjections(attrs),\n\t\t\t\t\t} satisfies RadioGroupAttrs<EndType>),\n\t\t\t\t],\n\t\t\t),\n\t\t])\n\t}\n\n\tprivate renderFrequencyOptions(attrs: RepeatRuleEditorAttrs, customRuleOptions: RadioGroupOption<RepeatPeriod>[]) {\n\t\tif (this.repeatRuleType !== \"CUSTOM\") {\n\t\t\treturn null\n\t\t}\n\n\t\treturn m(\".flex.col\", [\n\t\t\tm(\"small.uppercase.pb-s.b.text-ellipsis\", { style: { color: theme.navigation_button } }, lang.get(\"intervalFrequency_label\")),\n\t\t\tm(\n\t\t\t\tCard,\n\t\t\t\t{\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\tpadding: `0 0 ${size.vpad}px`,\n\t\t\t\t\t},\n\t\t\t\t\tclasses: [\"flex\", \"col\"],\n\t\t\t\t},\n\t\t\t\t[\n\t\t\t\t\tthis.renderIntervalPicker(attrs),\n\t\t\t\t\tm(Divider, { color: theme.button_bubble_bg, style: { margin: `0 0 ${size.vpad}px` } }),\n\t\t\t\t\tm(RadioGroup, {\n\t\t\t\t\t\tariaLabel: \"intervalFrequency_label\",\n\t\t\t\t\t\tname: \"intervalFrequency_label\",\n\t\t\t\t\t\toptions: customRuleOptions,\n\t\t\t\t\t\tselectedOption: attrs.model.repeatPeriod,\n\t\t\t\t\t\tonOptionSelected: (option: RepeatPeriod) => {\n\t\t\t\t\t\t\tthis.updateCustomRule(attrs.model, { intervalFrequency: option })\n\t\t\t\t\t\t},\n\t\t\t\t\t\tclasses: [\"cursor-pointer\", \"capitalize\", \"pl-vpad-m\", \"pr-vpad-m\"],\n\t\t\t\t\t} satisfies RadioGroupAttrs<RepeatPeriod>),\n\t\t\t\t],\n\t\t\t),\n\t\t])\n\t}\n\n\tprivate buildInjections(attrs: RepeatRuleEditorAttrs) {\n\t\tconst injectionMap = new Map<string, Child>()\n\t\tinjectionMap.set(EndType.Count, this.renderEndsPicker(attrs))\n\n\t\tinjectionMap.set(\n\t\t\tEndType.UntilDate,\n\t\t\tm(DatePicker, {\n\t\t\t\tdate: attrs.model.repeatEndDateForDisplay,\n\t\t\t\tonDateSelected: (date) => date && (attrs.model.repeatEndDateForDisplay = date),\n\t\t\t\tlabel: \"endDate_label\",\n\t\t\t\tuseInputButton: true,\n\t\t\t\tstartOfTheWeekOffset: attrs.startOfTheWeekOffset,\n\t\t\t\tposition: PickerPosition.TOP,\n\t\t\t\tclasses: [\"full-width\", \"flex-grow\", attrs.model.repeatEndType !== EndType.UntilDate ? \"disabled\" : \"\"],\n\t\t\t} satisfies DatePickerAttrs),\n\t\t)\n\n\t\treturn injectionMap\n\t}\n\n\tprivate updateCustomRule(whenModel: CalendarEventWhenModel, customRule: Partial<{ interval: number; intervalFrequency: RepeatPeriod }>) {\n\t\tconst { interval, intervalFrequency } = customRule\n\n\t\tif (interval && !isNaN(interval)) {\n\t\t\twhenModel.repeatInterval = interval\n\t\t}\n\n\t\tif (intervalFrequency) {\n\t\t\twhenModel.repeatPeriod = intervalFrequency\n\t\t}\n\t}\n\n\tprivate renderIntervalPicker(attrs: RepeatRuleEditorAttrs): Children {\n\t\treturn m(Select<IntervalOption, number>, {\n\t\t\tonchange: (newValue) => {\n\t\t\t\tif (this.repeatInterval === newValue.value) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tthis.repeatInterval = newValue.value\n\t\t\t\tthis.updateCustomRule(attrs.model, { interval: this.repeatInterval })\n\t\t\t\tm.redraw.sync()\n\t\t\t},\n\t\t\tonclose: () => {\n\t\t\t\tthis.intervalExpanded = false\n\t\t\t\tthis.intervalOptions(this.numberValues)\n\t\t\t},\n\t\t\tselected: { value: this.repeatInterval, name: this.repeatInterval.toString(), ariaValue: this.repeatInterval.toString() },\n\t\t\tariaLabel: lang.get(\"repeatsEvery_label\"),\n\t\t\toptions: this.intervalOptions,\n\t\t\tnoIcon: true,\n\t\t\texpanded: true,\n\t\t\ttabIndex: isApp() ? Number(TabIndex.Default) : Number(TabIndex.Programmatic),\n\t\t\tclasses: [\"no-appearance\"],\n\t\t\trenderDisplay: () =>\n\t\t\t\tm(SingleLineTextField, {\n\t\t\t\t\tclasses: [\"border-radius-bottom-0\"],\n\t\t\t\t\tvalue: isNaN(this.repeatInterval) ? \"\" : this.repeatInterval.toString(),\n\t\t\t\t\tinputMode: isApp() ? InputMode.NONE : InputMode.TEXT,\n\t\t\t\t\treadonly: isApp(),\n\t\t\t\t\toninput: (val: string) => {\n\t\t\t\t\t\tif (val !== \"\" && this.repeatInterval === Number(val)) {\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.repeatInterval = val === \"\" ? NaN : Number(val)\n\t\t\t\t\t\tif (!isNaN(this.repeatInterval)) {\n\t\t\t\t\t\t\tthis.intervalOptions(this.numberValues.filter((opt) => opt.value.toString().startsWith(val)))\n\t\t\t\t\t\t\tthis.updateCustomRule(attrs.model, { interval: this.repeatInterval })\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.intervalOptions(this.numberValues)\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tariaLabel: lang.get(\"repeatsEvery_label\"),\n\t\t\t\t\tonclick: (e: MouseEvent) => {\n\t\t\t\t\t\te.stopImmediatePropagation()\n\t\t\t\t\t\tif (!this.intervalExpanded) {\n\t\t\t\t\t\t\t;(e.target as HTMLElement).parentElement?.click()\n\t\t\t\t\t\t\tthis.intervalExpanded = true\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tonfocus: (event: FocusEvent) => {\n\t\t\t\t\t\tif (!this.intervalExpanded) {\n\t\t\t\t\t\t\t;(event.target as HTMLElement).parentElement?.click()\n\t\t\t\t\t\t\tthis.intervalExpanded = true\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tonblur: (event: FocusEvent) => {\n\t\t\t\t\t\tif (isNaN(this.repeatInterval)) {\n\t\t\t\t\t\t\tthis.repeatInterval = this.numberValues[0].value\n\t\t\t\t\t\t\tthis.updateCustomRule(attrs.model, { interval: this.repeatInterval })\n\t\t\t\t\t\t} else if (this.repeatInterval === 0) {\n\t\t\t\t\t\t\tthis.repeatInterval = this.numberValues[0].value\n\t\t\t\t\t\t\tthis.updateCustomRule(attrs.model, { interval: this.repeatInterval })\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\ttextAlign: \"center\",\n\t\t\t\t\t},\n\t\t\t\t\tmax: 256,\n\t\t\t\t\tmin: 1,\n\t\t\t\t\ttype: TextFieldType.Number,\n\t\t\t\t}),\n\t\t\trenderOption: (option) =>\n\t\t\t\tm(\n\t\t\t\t\t\"button.items-center.flex-grow\",\n\t\t\t\t\t{\n\t\t\t\t\t\tclass: \"state-bg button-content dropdown-button pt-s pb-s button-min-height\",\n\t\t\t\t\t},\n\t\t\t\t\toption.name,\n\t\t\t\t),\n\t\t\tkeepFocus: true,\n\t\t} satisfies SelectAttributes<IntervalOption, number>)\n\t}\n\n\tprivate renderEndsPicker(attrs: RepeatRuleEditorAttrs): Child {\n\t\treturn m(Select<IntervalOption, number>, {\n\t\t\tonchange: (newValue) => {\n\t\t\t\tif (this.repeatOccurrences === newValue.value) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\n\t\t\t\tthis.repeatOccurrences = newValue.value\n\t\t\t\tattrs.model.repeatEndOccurrences = newValue.value\n\t\t\t},\n\t\t\tonclose: () => {\n\t\t\t\tthis.occurrencesExpanded = false\n\t\t\t\tthis.occurrencesOptions(this.numberValues)\n\t\t\t},\n\t\t\tselected: { value: this.repeatOccurrences, name: this.repeatOccurrences.toString(), ariaValue: this.repeatOccurrences.toString() },\n\t\t\tariaLabel: lang.get(\"occurrencesCount_label\"),\n\t\t\toptions: this.occurrencesOptions,\n\t\t\tnoIcon: true,\n\t\t\texpanded: true,\n\t\t\ttabIndex: isApp() ? Number(TabIndex.Default) : Number(TabIndex.Programmatic),\n\t\t\tclasses: [\"no-appearance\"],\n\t\t\trenderDisplay: () =>\n\t\t\t\tm(SingleLineTextField, {\n\t\t\t\t\tclasses: [\"tutaui-button-outline\", \"text-center\", \"border-content-message-bg\"],\n\t\t\t\t\tvalue: isNaN(this.repeatOccurrences) ? \"\" : this.repeatOccurrences.toString(),\n\t\t\t\t\tinputMode: isApp() ? InputMode.NONE : InputMode.TEXT,\n\t\t\t\t\treadonly: isApp(),\n\t\t\t\t\toninput: (val: string) => {\n\t\t\t\t\t\tif (val !== \"\" && this.repeatOccurrences === Number(val)) {\n\t\t\t\t\t\t\treturn\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.repeatOccurrences = val === \"\" ? NaN : Number(val)\n\n\t\t\t\t\t\tif (!isNaN(this.repeatOccurrences)) {\n\t\t\t\t\t\t\tthis.occurrencesOptions(this.numberValues.filter((opt) => opt.value.toString().startsWith(val)))\n\t\t\t\t\t\t\tattrs.model.repeatEndOccurrences = this.repeatOccurrences\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.occurrencesOptions(this.numberValues)\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tariaLabel: lang.get(\"occurrencesCount_label\"),\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\ttextAlign: \"center\",\n\t\t\t\t\t},\n\t\t\t\t\tonclick: (e: MouseEvent) => {\n\t\t\t\t\t\te.stopImmediatePropagation()\n\t\t\t\t\t\tif (!this.occurrencesExpanded) {\n\t\t\t\t\t\t\t;(e.target as HTMLElement).parentElement?.click()\n\t\t\t\t\t\t\tthis.occurrencesExpanded = true\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tonfocus: (event: FocusEvent) => {\n\t\t\t\t\t\tif (!this.occurrencesExpanded) {\n\t\t\t\t\t\t\t;(event.target as HTMLElement).parentElement?.click()\n\t\t\t\t\t\t\tthis.occurrencesExpanded = true\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tonblur: (event: FocusEvent) => {\n\t\t\t\t\t\tif (isNaN(this.repeatOccurrences)) {\n\t\t\t\t\t\t\tthis.repeatOccurrences = this.numberValues[0].value\n\t\t\t\t\t\t\tattrs.model.repeatEndOccurrences = this.repeatOccurrences\n\t\t\t\t\t\t} else if (this.repeatOccurrences === 0) {\n\t\t\t\t\t\t\tthis.repeatOccurrences = this.numberValues[0].value\n\t\t\t\t\t\t\tattrs.model.repeatEndOccurrences = this.repeatOccurrences\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tmax: 256,\n\t\t\t\t\tmin: 1,\n\t\t\t\t\ttype: TextFieldType.Number,\n\t\t\t\t}),\n\t\t\trenderOption: (option) =>\n\t\t\t\tm(\n\t\t\t\t\t\"button.items-center.flex-grow\",\n\t\t\t\t\t{\n\t\t\t\t\t\tclass: \"state-bg button-content dropdown-button pt-s pb-s button-min-height\",\n\t\t\t\t\t},\n\t\t\t\t\toption.name,\n\t\t\t\t),\n\t\t\tkeepFocus: true,\n\t\t} satisfies SelectAttributes<IntervalOption, number>)\n\t}\n}\n","import m, { Children, Component, Vnode, VnodeDOM } from \"mithril\"\nimport { AttendeeListEditor } from \"./AttendeeListEditor.js\"\nimport { locator } from \"../../../../common/api/main/CommonLocator.js\"\nimport { EventTimeEditor, EventTimeEditorAttrs } from \"./EventTimeEditor.js\"\nimport { defaultCalendarColor, TabIndex, TimeFormat } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport { lang, TranslationKey } from \"../../../../common/misc/LanguageViewModel.js\"\nimport { RecipientsSearchModel } from \"../../../../common/misc/RecipientsSearchModel.js\"\nimport { CalendarInfo } from \"../../model/CalendarModel.js\"\nimport { AlarmInterval } from \"../../../../common/calendar/date/CalendarUtils.js\"\nimport { HtmlEditor } from \"../../../../common/gui/editor/HtmlEditor.js\"\nimport { BannerType, InfoBanner, InfoBannerAttrs } from \"../../../../common/gui/base/InfoBanner.js\"\nimport { CalendarEventModel, CalendarOperation, ReadonlyReason } from \"../eventeditor-model/CalendarEventModel.js\"\nimport { getSharedGroupName } from \"../../../../common/sharing/GroupUtils.js\"\nimport { RemindersEditor, RemindersEditorAttrs } from \"../RemindersEditor.js\"\nimport { SingleLineTextField } from \"../../../../common/gui/base/SingleLineTextField.js\"\nimport { px, size } from \"../../../../common/gui/size.js\"\nimport { Card } from \"../../../../common/gui/base/Card.js\"\nimport { Select, SelectAttributes, SelectOption } from \"../../../../common/gui/base/Select.js\"\nimport { Icon, IconSize } from \"../../../../common/gui/base/Icon.js\"\nimport { theme } from \"../../../../common/gui/theme.js\"\nimport { deepEqual } from \"@tutao/tutanota-utils\"\nimport { ButtonColor, getColors } from \"../../../../common/gui/base/Button.js\"\nimport stream from \"mithril/stream\"\nimport { RepeatRuleEditor, RepeatRuleEditorAttrs } from \"./RepeatRuleEditor.js\"\nimport type { CalendarRepeatRule } from \"../../../../common/api/entities/tutanota/TypeRefs.js\"\nimport { formatRepetitionEnd, formatRepetitionFrequency } from \"../eventpopup/EventPreviewView.js\"\nimport { TextFieldType } from \"../../../../common/gui/base/TextField.js\"\nimport { DefaultAnimationTime } from \"../../../../common/gui/animation/Animations.js\"\nimport { Icons } from \"../../../../common/gui/base/icons/Icons.js\"\n\nexport type CalendarEventEditViewAttrs = {\n\tmodel: CalendarEventModel\n\tgroupColors: Map<Id, string>\n\trecipientsSearch: RecipientsSearchModel\n\tdescriptionEditor: HtmlEditor\n\tstartOfTheWeekOffset: number\n\ttimeFormat: TimeFormat\n\tdefaultAlarms: Map<Id, AlarmInterval[]>\n\tnavigationCallback: (targetPage: EditorPages, callBack?: (...args: any) => unknown) => unknown\n\tcurrentPage: stream<EditorPages>\n}\n\nexport interface CalendarSelectItem extends SelectOption<CalendarInfo> {\n\tcolor: string\n\tname: string\n}\n\nexport interface OrganizerSelectItem extends SelectOption<string> {\n\tname: string\n\taddress: string\n}\n\nexport enum EditorPages {\n\tMAIN,\n\tREPEAT_RULES,\n\tGUESTS,\n}\n\n/**\n * combines several semi-related editor components into a full editor for editing calendar events\n * to be displayed in a dialog.\n *\n * controls the enabling/disabling of certain editor components and the display of additional info\n * in the dialog depending on the type of the event being edited.\n */\nexport class CalendarEventEditView implements Component<CalendarEventEditViewAttrs> {\n\tprivate readonly timeFormat: TimeFormat\n\tprivate readonly startOfTheWeekOffset: number\n\tprivate readonly defaultAlarms: Map<Id, AlarmInterval[]>\n\n\tprivate transitionPage: EditorPages | null = null\n\tprivate hasAnimationEnded = true\n\tprivate pages: Map<EditorPages, (...args: any) => Children> = new Map()\n\tprivate pagesWrapperDomElement!: HTMLElement\n\tprivate allowRenderMainPage: stream<boolean> = stream(true)\n\tprivate dialogHeight: number | null = null\n\tprivate pageWidth: number = -1\n\tprivate translate = 0\n\n\tconstructor(vnode: Vnode<CalendarEventEditViewAttrs>) {\n\t\tthis.timeFormat = vnode.attrs.timeFormat\n\t\tthis.startOfTheWeekOffset = vnode.attrs.startOfTheWeekOffset\n\t\tthis.defaultAlarms = vnode.attrs.defaultAlarms\n\n\t\tif (vnode.attrs.model.operation == CalendarOperation.Create) {\n\t\t\tconst initialAlarms = vnode.attrs.defaultAlarms.get(vnode.attrs.model.editModels.whoModel.selectedCalendar.group._id) ?? []\n\t\t\tvnode.attrs.model.editModels.alarmModel.addAll(initialAlarms)\n\t\t}\n\n\t\tthis.pages.set(EditorPages.REPEAT_RULES, this.renderRepeatRulesPage)\n\t\tthis.pages.set(EditorPages.GUESTS, this.renderGuestsPage)\n\n\t\tvnode.attrs.currentPage.map((page) => {\n\t\t\tthis.hasAnimationEnded = false\n\n\t\t\tif (page === EditorPages.MAIN) {\n\t\t\t\tthis.allowRenderMainPage(true)\n\t\t\t\tthis.translate = 0\n\t\t\t}\n\t\t})\n\n\t\tthis.allowRenderMainPage.map((allowRendering) => {\n\t\t\treturn this.handleEditorStatus(allowRendering, vnode)\n\t\t})\n\t}\n\n\tonremove(vnode: Vnode<CalendarEventEditViewAttrs>) {\n\t\tvnode.attrs.currentPage.end(true)\n\t\tthis.allowRenderMainPage.end(true)\n\t}\n\n\tprivate handleEditorStatus(allowRendering: boolean, vnode: Vnode<CalendarEventEditViewAttrs>) {\n\t\tif (allowRendering && vnode.attrs.currentPage() === EditorPages.MAIN) {\n\t\t\tif (vnode.attrs.descriptionEditor.editor.domElement) {\n\t\t\t\tvnode.attrs.descriptionEditor.editor.domElement.tabIndex = Number(TabIndex.Default)\n\t\t\t}\n\t\t\treturn vnode.attrs.descriptionEditor.setEnabled(true)\n\t\t}\n\t\tif (vnode.attrs.descriptionEditor.editor.domElement) {\n\t\t\tvnode.attrs.descriptionEditor.editor.domElement.tabIndex = Number(TabIndex.Programmatic)\n\t\t}\n\t\tvnode.attrs.descriptionEditor.setEnabled(false)\n\t}\n\n\toncreate(vnode: VnodeDOM<CalendarEventEditViewAttrs>): any {\n\t\tthis.pagesWrapperDomElement = vnode.dom as HTMLElement\n\n\t\tthis.pagesWrapperDomElement.addEventListener(\"transitionend\", () => {\n\t\t\tif (vnode.attrs.currentPage() !== EditorPages.MAIN) {\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tthis.allowRenderMainPage(false)\n\t\t\t\t}, DefaultAnimationTime)\n\t\t\t\tm.redraw()\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tthis.transitionPage = vnode.attrs.currentPage()\n\t\t\tthis.hasAnimationEnded = true\n\n\t\t\tsetTimeout(() => {\n\t\t\t\tthis.allowRenderMainPage(true)\n\t\t\t\tm.redraw()\n\t\t\t}, DefaultAnimationTime)\n\t\t})\n\t}\n\n\tonupdate(vnode: VnodeDOM<CalendarEventEditViewAttrs>): any {\n\t\tconst dom = vnode.dom as HTMLElement\n\t\tif (this.dialogHeight == null && dom.parentElement) {\n\t\t\tthis.dialogHeight = dom.parentElement.clientHeight\n\t\t\t;(vnode.dom as HTMLElement).style.height = px(this.dialogHeight)\n\t\t}\n\n\t\tif (this.pageWidth == -1 && dom.parentElement) {\n\t\t\tthis.pageWidth = dom.parentElement.clientWidth - size.hpad_large * 2\n\t\t\t// Twice the page width (Main Page + Guests/Repeat) plus the gap between pages (64px)\n\t\t\t;(vnode.dom as HTMLElement).style.width = px(this.pageWidth * 2 + size.vpad_xxl)\n\t\t\tm.redraw()\n\t\t}\n\t}\n\n\tview(vnode: Vnode<CalendarEventEditViewAttrs>): Children {\n\t\treturn m(\n\t\t\t\".flex.gap-vpad-xxl.fit-content.transition-transform\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\ttransform: `translateX(${this.translate}px)`,\n\t\t\t\t},\n\t\t\t},\n\t\t\t[this.renderMainPage(vnode), this.renderPage(vnode)],\n\t\t)\n\t}\n\n\tprivate renderPage(vnode: Vnode<CalendarEventEditViewAttrs>) {\n\t\tif (this.hasAnimationEnded || this.transitionPage == null) {\n\t\t\treturn this.pages.get(vnode.attrs.currentPage())?.apply(this, [vnode])\n\t\t}\n\n\t\treturn this.pages.get(this.transitionPage)?.apply(this, [vnode])\n\t}\n\n\tprivate renderGuestsPage({ attrs: { model, recipientsSearch } }: Vnode<CalendarEventEditViewAttrs>) {\n\t\treturn m(AttendeeListEditor, {\n\t\t\trecipientsSearch,\n\t\t\tlogins: locator.logins,\n\t\t\tmodel,\n\t\t\twidth: this.pageWidth,\n\t\t})\n\t}\n\n\tprivate renderTitle(attrs: CalendarEventEditViewAttrs): Children {\n\t\tconst { model } = attrs\n\t\treturn m(\n\t\t\tCard,\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\tpadding: \"0\",\n\t\t\t\t},\n\t\t\t},\n\t\t\tm(SingleLineTextField, {\n\t\t\t\tvalue: model.editModels.summary.content,\n\t\t\t\toninput: (newValue: any) => {\n\t\t\t\t\tmodel.editModels.summary.content = newValue\n\t\t\t\t},\n\t\t\t\tariaLabel: lang.get(\"title_placeholder\"),\n\t\t\t\tplaceholder: lang.get(\"title_placeholder\"),\n\t\t\t\tdisabled: !model.isFullyWritable(),\n\t\t\t\tstyle: {\n\t\t\t\t\tfontSize: px(size.font_size_base * 1.25), // Overriding the component style\n\t\t\t\t},\n\t\t\t\ttype: TextFieldType.Text,\n\t\t\t}),\n\t\t)\n\t}\n\n\tprivate renderReadonlyMessage(attrs: CalendarEventEditViewAttrs): Children {\n\t\tconst { model } = attrs\n\t\tconst makeMessage = (message: TranslationKey): Children =>\n\t\t\tm(InfoBanner, {\n\t\t\t\tmessage: () => m(\".small.selectable\", lang.get(message)),\n\t\t\t\ticon: Icons.People,\n\t\t\t\ttype: BannerType.Info,\n\t\t\t\tbuttons: [],\n\t\t\t} satisfies InfoBannerAttrs)\n\n\t\tswitch (model.getReadonlyReason()) {\n\t\t\tcase ReadonlyReason.SHARED:\n\t\t\t\treturn makeMessage(\"cannotEditFullEvent_msg\")\n\t\t\tcase ReadonlyReason.SINGLE_INSTANCE:\n\t\t\t\treturn makeMessage(\"cannotEditSingleInstance_msg\")\n\t\t\tcase ReadonlyReason.NOT_ORGANIZER:\n\t\t\t\treturn makeMessage(\"cannotEditNotOrganizer_msg\")\n\t\t\tcase ReadonlyReason.UNKNOWN:\n\t\t\t\treturn makeMessage(\"cannotEditEvent_msg\")\n\t\t\tcase ReadonlyReason.NONE:\n\t\t\t\treturn null\n\t\t}\n\t}\n\n\tprivate renderEventTimeEditor(attrs: CalendarEventEditViewAttrs): Children {\n\t\tconst padding = px(size.vpad_small)\n\t\treturn m(\n\t\t\tCard,\n\t\t\t{ style: { padding: `${padding} 0 ${padding} ${padding}` } },\n\t\t\tm(EventTimeEditor, {\n\t\t\t\teditModel: attrs.model.editModels.whenModel,\n\t\t\t\ttimeFormat: this.timeFormat,\n\t\t\t\tstartOfTheWeekOffset: this.startOfTheWeekOffset,\n\t\t\t\tdisabled: !attrs.model.isFullyWritable(),\n\t\t\t} satisfies EventTimeEditorAttrs),\n\t\t)\n\t}\n\n\tprivate renderRepeatRuleNavButton({ model, navigationCallback }: CalendarEventEditViewAttrs): Children {\n\t\tconst disabled = !model.canEditSeries()\n\t\treturn m(\n\t\t\tCard,\n\t\t\t{ classes: [\"button-min-height\", \"flex\", \"items-center\"] },\n\t\t\tm(\".flex.gap-vpad-s.items-center.flex-grow\", [\n\t\t\t\tm(\".flex.items-center\", [\n\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\ticon: Icons.Sync,\n\t\t\t\t\t\tstyle: { fill: getColors(ButtonColor.Content).button },\n\t\t\t\t\t\ttitle: lang.get(\"calendarRepeating_label\"),\n\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t}),\n\t\t\t\t]),\n\t\t\t\tm(\n\t\t\t\t\t\"button.flex.items-center.justify-between.flex-grow.flash\",\n\t\t\t\t\t{\n\t\t\t\t\t\tonclick: (event: MouseEvent) => {\n\t\t\t\t\t\t\tthis.transitionTo(EditorPages.REPEAT_RULES, navigationCallback)\n\t\t\t\t\t\t},\n\t\t\t\t\t\tdisabled,\n\t\t\t\t\t\tclass: disabled ? \"disabled cursor-disabled\" : \"\",\n\t\t\t\t\t},\n\t\t\t\t\t[\n\t\t\t\t\t\tthis.getTranslatedRepeatRule(model.editModels.whenModel.result.repeatRule, model.editModels.whenModel.isAllDay),\n\t\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\t\ticon: Icons.ArrowForward,\n\t\t\t\t\t\t\tclass: \"flex items-center\",\n\t\t\t\t\t\t\tstyle: { fill: getColors(ButtonColor.Content).button },\n\t\t\t\t\t\t\ttitle: lang.get(\"calendarRepeating_label\"),\n\t\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t\t}),\n\t\t\t\t\t],\n\t\t\t\t),\n\t\t\t]),\n\t\t)\n\t}\n\n\tprivate transitionTo(target: EditorPages, navigationCallback: (targetPage: EditorPages) => unknown) {\n\t\tthis.hasAnimationEnded = false\n\t\tthis.transitionPage = target\n\t\tthis.translate = -(this.pageWidth + size.vpad_xxl)\n\t\tnavigationCallback(target)\n\t}\n\n\tprivate renderGuestsNavButton({ navigationCallback, model }: CalendarEventEditViewAttrs): Children {\n\t\treturn m(\n\t\t\tCard,\n\t\t\t{ classes: [\"button-min-height\", \"flex\", \"items-center\"] },\n\t\t\tm(\".flex.gap-vpad-s.flash.items-center.flex-grow\", [\n\t\t\t\tm(\".flex.items-center\", [\n\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\ticon: Icons.People,\n\t\t\t\t\t\tstyle: { fill: getColors(ButtonColor.Content).button },\n\t\t\t\t\t\ttitle: lang.get(\"calendarRepeating_label\"),\n\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t}),\n\t\t\t\t]),\n\t\t\t\tm(\n\t\t\t\t\t\"button.flex.items-center.justify-between.flex-grow.flash\",\n\t\t\t\t\t{\n\t\t\t\t\t\tonclick: (event: MouseEvent) => {\n\t\t\t\t\t\t\tthis.transitionTo(EditorPages.GUESTS, navigationCallback)\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\t[\n\t\t\t\t\t\tlang.get(\"guests_label\"),\n\t\t\t\t\t\tm(\".flex\", [\n\t\t\t\t\t\t\tmodel.editModels.whoModel.guests.length > 0 ? m(\"span\", model.editModels.whoModel.guests.length) : null,\n\t\t\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\t\t\ticon: Icons.ArrowForward,\n\t\t\t\t\t\t\t\tclass: \"flex items-center\",\n\t\t\t\t\t\t\t\tstyle: { fill: getColors(ButtonColor.Content).button },\n\t\t\t\t\t\t\t\ttitle: lang.get(\"guests_label\"),\n\t\t\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t]),\n\t\t\t\t\t],\n\t\t\t\t),\n\t\t\t]),\n\t\t)\n\t}\n\n\tprivate renderCalendarPicker(vnode: Vnode<CalendarEventEditViewAttrs>): Children {\n\t\tconst { model, groupColors } = vnode.attrs\n\t\tconst availableCalendars = model.editModels.whoModel.getAvailableCalendars()\n\n\t\tconst options: CalendarSelectItem[] = availableCalendars.map((calendarInfo) => {\n\t\t\tconst name = getSharedGroupName(calendarInfo.groupInfo, model.userController, calendarInfo.shared)\n\t\t\treturn {\n\t\t\t\tname,\n\t\t\t\tcolor: \"#\" + (groupColors.get(calendarInfo.group._id) ?? defaultCalendarColor),\n\t\t\t\tvalue: calendarInfo,\n\t\t\t\tariaValue: name,\n\t\t\t}\n\t\t})\n\n\t\tconst selectedCalendarInfo = model.editModels.whoModel.selectedCalendar\n\t\tconst selectedCalendarName = getSharedGroupName(selectedCalendarInfo.groupInfo, model.userController, selectedCalendarInfo.shared)\n\t\tlet selected: CalendarSelectItem = {\n\t\t\tname: selectedCalendarName,\n\t\t\tcolor: \"#\" + (groupColors.get(selectedCalendarInfo.group._id) ?? defaultCalendarColor),\n\t\t\tvalue: model.editModels.whoModel.selectedCalendar,\n\t\t\tariaValue: selectedCalendarName,\n\t\t}\n\t\treturn m(\n\t\t\tCard,\n\t\t\t{ style: { padding: \"0\" } },\n\t\t\tm(Select<CalendarSelectItem, CalendarInfo>, {\n\t\t\t\tonchange: (val) => {\n\t\t\t\t\tmodel.editModels.alarmModel.removeAll()\n\t\t\t\t\tmodel.editModels.alarmModel.addAll(this.defaultAlarms.get(val.value.group._id) ?? [])\n\t\t\t\t\tmodel.editModels.whoModel.selectedCalendar = val.value\n\t\t\t\t},\n\t\t\t\toptions: stream(options),\n\t\t\t\texpanded: true,\n\t\t\t\tselected,\n\t\t\t\tclasses: [\"button-min-height\", \"pl-vpad-s\", \"pr-vpad-s\"],\n\t\t\t\trenderOption: (option) => this.renderCalendarOptions(option, deepEqual(option.value, selected.value), false),\n\t\t\t\trenderDisplay: (option) => this.renderCalendarOptions(option, false, true),\n\t\t\t\tariaLabel: lang.get(\"calendar_label\"),\n\t\t\t\tdisabled: !model.canChangeCalendar() || availableCalendars.length < 2,\n\t\t\t} satisfies SelectAttributes<CalendarSelectItem, CalendarInfo>),\n\t\t)\n\t}\n\n\tprivate renderCalendarOptions(option: CalendarSelectItem, isSelected: boolean, isDisplay: boolean) {\n\t\treturn m(\n\t\t\t\".flex.items-center.gap-vpad-s.flex-grow\",\n\t\t\t{ class: `${isDisplay ? \"\" : \"state-bg plr-button button-content dropdown-button pt-s pb-s button-min-height\"}` },\n\t\t\t[\n\t\t\t\tm(\"div\", {\n\t\t\t\t\tstyle: {\n\t\t\t\t\t\twidth: px(size.hpad_large),\n\t\t\t\t\t\theight: px(size.hpad_large),\n\t\t\t\t\t\tborderRadius: \"50%\",\n\t\t\t\t\t\tbackgroundColor: option.color,\n\t\t\t\t\t\tmarginInline: px(size.vpad_xsm / 2),\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tm(\"span\", { style: { color: isSelected ? theme.content_button_selected : undefined } }, option.name),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderRemindersEditor(vnode: Vnode<CalendarEventEditViewAttrs>): Children {\n\t\tif (!vnode.attrs.model.editModels.alarmModel.canEditReminders) return null\n\t\tconst { alarmModel } = vnode.attrs.model.editModels\n\n\t\treturn m(\n\t\t\tCard,\n\t\t\t{ classes: [\"button-min-height\", \"flex\", \"items-center\"] },\n\t\t\tm(\".flex.gap-vpad-s.items-start.flex-grow\", [\n\t\t\t\tm(\n\t\t\t\t\t\".flex\",\n\t\t\t\t\t{\n\t\t\t\t\t\tclass: alarmModel.alarms.length === 0 ? \"items-center\" : \"items-start\",\n\t\t\t\t\t},\n\t\t\t\t\t[\n\t\t\t\t\t\tm(Icon, {\n\t\t\t\t\t\t\ticon: Icons.Clock,\n\t\t\t\t\t\t\tstyle: { fill: getColors(ButtonColor.Content).button },\n\t\t\t\t\t\t\ttitle: lang.get(\"reminderBeforeEvent_label\"),\n\t\t\t\t\t\t\tsize: IconSize.Medium,\n\t\t\t\t\t\t}),\n\t\t\t\t\t],\n\t\t\t\t),\n\t\t\t\tm(RemindersEditor, {\n\t\t\t\t\talarms: alarmModel.alarms,\n\t\t\t\t\taddAlarm: alarmModel.addAlarm.bind(alarmModel),\n\t\t\t\t\tremoveAlarm: alarmModel.removeAlarm.bind(alarmModel),\n\t\t\t\t\tlabel: \"reminderBeforeEvent_label\",\n\t\t\t\t\tuseNewEditor: true,\n\t\t\t\t} satisfies RemindersEditorAttrs),\n\t\t\t]),\n\t\t)\n\t}\n\n\tprivate renderLocationField(vnode: Vnode<CalendarEventEditViewAttrs>): Children {\n\t\tconst { model } = vnode.attrs\n\t\treturn m(\n\t\t\tCard,\n\t\t\t{\n\t\t\t\tstyle: { padding: \"0\" },\n\t\t\t},\n\t\t\tm(\n\t\t\t\t\".flex.gap-vpad-s.items-center\",\n\t\t\t\tm(SingleLineTextField, {\n\t\t\t\t\tvalue: model.editModels.location.content,\n\t\t\t\t\toninput: (newValue: string) => {\n\t\t\t\t\t\tmodel.editModels.location.content = newValue\n\t\t\t\t\t},\n\t\t\t\t\tclasses: [\"button-min-height\"],\n\t\t\t\t\tariaLabel: lang.get(\"location_label\"),\n\t\t\t\t\tplaceholder: lang.get(\"location_label\"),\n\t\t\t\t\tdisabled: !model.isFullyWritable(),\n\t\t\t\t\tleadingIcon: {\n\t\t\t\t\t\ticon: Icons.Pin,\n\t\t\t\t\t\tcolor: getColors(ButtonColor.Content).button,\n\t\t\t\t\t},\n\t\t\t\t\ttype: TextFieldType.Text,\n\t\t\t\t}),\n\t\t\t),\n\t\t)\n\t}\n\n\tprivate renderDescriptionEditor(vnode: Vnode<CalendarEventEditViewAttrs>): Children {\n\t\treturn m(\n\t\t\tCard,\n\t\t\t{\n\t\t\t\tclasses: [\"child-text-editor\", \"rel\"],\n\t\t\t\tstyle: {\n\t\t\t\t\tpadding: \"0\",\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tvnode.attrs.descriptionEditor.isEmpty() && !vnode.attrs.descriptionEditor.isActive()\n\t\t\t\t\t? m(\"span.text-editor-placeholder\", lang.get(\"description_label\"))\n\t\t\t\t\t: null,\n\t\t\t\tm(vnode.attrs.descriptionEditor),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderMainPage(vnode: Vnode<CalendarEventEditViewAttrs>): Children {\n\t\treturn m(\n\t\t\t\".pb.pt.flex.col.gap-vpad.fit-height.box-content\",\n\t\t\t{\n\t\t\t\tstyle: {\n\t\t\t\t\t// The date picker dialogs have position: fixed, and they are fixed relative to the most recent ancestor with\n\t\t\t\t\t// a transform. So doing a no-op transform will make the dropdowns scroll with the dialog\n\t\t\t\t\t// without this, then the date picker dialogs will show at the same place on the screen regardless of whether the\n\t\t\t\t\t// editor has scrolled or not.\n\t\t\t\t\t// Ideally we could do this inside DatePicker itself, but the rendering breaks and the dialog appears below it's siblings\n\t\t\t\t\t// We also don't want to do this for all dialogs because it could potentially cause other issues\n\t\t\t\t\ttransform: \"translate(0)\",\n\t\t\t\t\tcolor: theme.button_bubble_fg,\n\t\t\t\t\t\"pointer-events\": `${this.allowRenderMainPage() ? \"auto\" : \"none\"}`,\n\t\t\t\t\twidth: px(this.pageWidth),\n\t\t\t\t},\n\t\t\t},\n\t\t\t[\n\t\t\t\tthis.allowRenderMainPage()\n\t\t\t\t\t? m.fragment({}, [\n\t\t\t\t\t\t\tthis.renderReadonlyMessage(vnode.attrs),\n\t\t\t\t\t\t\tthis.renderTitle(vnode.attrs),\n\t\t\t\t\t\t\tthis.renderEventTimeEditor(vnode.attrs),\n\t\t\t\t\t\t\tthis.renderCalendarPicker(vnode),\n\t\t\t\t\t\t\tthis.renderRepeatRuleNavButton(vnode.attrs),\n\t\t\t\t\t\t\tthis.renderRemindersEditor(vnode),\n\t\t\t\t\t\t\tthis.renderGuestsNavButton(vnode.attrs),\n\t\t\t\t\t\t\tthis.renderLocationField(vnode),\n\t\t\t\t\t  ])\n\t\t\t\t\t: null,\n\t\t\t\tthis.renderDescriptionEditor(vnode),\n\t\t\t],\n\t\t)\n\t}\n\n\tprivate renderRepeatRulesPage({ attrs: { model, navigationCallback } }: Vnode<CalendarEventEditViewAttrs>) {\n\t\tconst { whenModel } = model.editModels\n\n\t\treturn m(RepeatRuleEditor, {\n\t\t\tmodel: whenModel,\n\t\t\tstartOfTheWeekOffset: this.startOfTheWeekOffset,\n\t\t\twidth: this.pageWidth,\n\t\t\tbackAction: () => navigationCallback(EditorPages.MAIN),\n\t\t} satisfies RepeatRuleEditorAttrs)\n\t}\n\n\tprivate getTranslatedRepeatRule(rule: CalendarRepeatRule | null, isAllDay: boolean): string {\n\t\tif (rule == null) return lang.get(\"calendarRepeatIntervalNoRepeat_label\")\n\n\t\tconst frequency = formatRepetitionFrequency(rule)\n\t\treturn frequency ? frequency + formatRepetitionEnd(rule, isAllDay) : lang.get(\"unknownRepetition_msg\")\n\t}\n}\n","/**\n * This file contains the functions used to set up and tear down edit dialogs for calendar events.\n *\n * they're not responsible for upholding invariants or ensure valid events (CalendarEventModel.editModels\n * and CalendarEventEditView do that), but know what additional information to ask the user before saving\n * and which methods to call to save the changes.\n */\n\nimport { Dialog } from \"../../../../common/gui/base/Dialog.js\"\nimport { lang, MaybeTranslation } from \"../../../../common/misc/LanguageViewModel.js\"\nimport { ButtonAttrs, ButtonType } from \"../../../../common/gui/base/Button.js\"\nimport { Keys } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport { AlarmInterval, getStartOfTheWeekOffsetForUser, getTimeFormatForUser, parseAlarmInterval } from \"../../../../common/calendar/date/CalendarUtils.js\"\nimport { client } from \"../../../../common/misc/ClientDetector.js\"\nimport { assertNotNull, noOp, Thunk } from \"@tutao/tutanota-utils\"\nimport { PosRect } from \"../../../../common/gui/base/Dropdown.js\"\nimport { Mail } from \"../../../../common/api/entities/tutanota/TypeRefs.js\"\nimport type { HtmlEditor } from \"../../../../common/gui/editor/HtmlEditor.js\"\nimport { locator } from \"../../../../common/api/main/CommonLocator.js\"\nimport { CalendarEventEditView, EditorPages } from \"./CalendarEventEditView.js\"\nimport { askIfShouldSendCalendarUpdatesToAttendees } from \"../CalendarGuiUtils.js\"\nimport { CalendarEventIdentity, CalendarEventModel, EventSaveResult } from \"../eventeditor-model/CalendarEventModel.js\"\nimport { ProgrammingError } from \"../../../../common/api/common/error/ProgrammingError.js\"\nimport { UpgradeRequiredError } from \"../../../../common/api/main/UpgradeRequiredError.js\"\nimport { showPlanUpgradeRequiredDialog } from \"../../../../common/misc/SubscriptionDialogs.js\"\nimport { convertTextToHtml } from \"../../../../common/misc/Formatter.js\"\nimport { UserError } from \"../../../../common/api/main/UserError.js\"\nimport { showUserError } from \"../../../../common/misc/ErrorHandlerImpl.js\"\nimport { theme } from \"../../../../common/gui/theme.js\"\nimport stream from \"mithril/stream\"\n\nimport { handleRatingByEvent } from \"../../../../common/ratings/InAppRatingDialog.js\"\n\nconst enum ConfirmationResult {\n\tCancel,\n\tContinue,\n}\n\ntype EditDialogOkHandler = (posRect: PosRect, finish: Thunk) => Promise<unknown>\n\nexport class EventEditorDialog {\n\tprivate currentPage: stream<EditorPages> = stream(EditorPages.MAIN)\n\tprivate dialog: Dialog | null = null\n\tprivate headerDom: HTMLElement | null = null\n\n\tconstructor() {}\n\n\tprivate left(): ButtonAttrs[] {\n\t\tif (this.currentPage() === EditorPages.MAIN) {\n\t\t\treturn [\n\t\t\t\t{\n\t\t\t\t\tlabel: \"cancel_action\",\n\t\t\t\t\tclick: () => this.dialog?.close(),\n\t\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t\t},\n\t\t\t]\n\t\t}\n\n\t\treturn [\n\t\t\t{\n\t\t\t\tlabel: \"back_action\",\n\t\t\t\tclick: () => this.currentPage(EditorPages.MAIN),\n\t\t\t\ttype: ButtonType.Secondary,\n\t\t\t},\n\t\t]\n\t}\n\n\tprivate right(okAction: (dom: HTMLElement) => unknown): ButtonAttrs[] {\n\t\tif (this.currentPage() === EditorPages.MAIN) {\n\t\t\treturn [\n\t\t\t\t{\n\t\t\t\t\tlabel: \"save_action\",\n\t\t\t\t\tclick: (event: MouseEvent, dom: HTMLElement) => okAction(dom),\n\t\t\t\t\ttype: ButtonType.Primary,\n\t\t\t\t},\n\t\t\t]\n\t\t}\n\n\t\treturn []\n\t}\n\n\t/**\n\t * the generic way to open any calendar edit dialog. the caller should know what to do after the\n\t * dialog is closed.\n\t */\n\tasync showCalendarEventEditDialog(model: CalendarEventModel, responseMail: Mail | null, handler: EditDialogOkHandler): Promise<void> {\n\t\tconst recipientsSearch = await locator.recipientsSearchModel()\n\t\tconst { HtmlEditor } = await import(\"../../../../common/gui/editor/HtmlEditor.js\")\n\t\tconst groupSettings = locator.logins.getUserController().userSettingsGroupRoot.groupSettings\n\n\t\tconst groupColors: Map<Id, string> = groupSettings.reduce((acc, gc) => {\n\t\t\tacc.set(gc.group, gc.color)\n\t\t\treturn acc\n\t\t}, new Map())\n\n\t\tconst defaultAlarms: Map<Id, AlarmInterval[]> = groupSettings.reduce((acc, gc) => {\n\t\t\tacc.set(\n\t\t\t\tgc.group,\n\t\t\t\tgc.defaultAlarmsList.map((alarm) => parseAlarmInterval(alarm.trigger)),\n\t\t\t)\n\t\t\treturn acc\n\t\t}, new Map())\n\n\t\tconst descriptionText = convertTextToHtml(model.editModels.description.content)\n\t\tconst descriptionEditor: HtmlEditor = new HtmlEditor()\n\t\t\t.setShowOutline(true)\n\t\t\t.setMinHeight(200)\n\t\t\t.setEnabled(true)\n\t\t\t// We only set it once, we don't viewModel on every change, that would be slow\n\t\t\t.setValue(descriptionText)\n\n\t\tconst okAction = (dom: HTMLElement) => {\n\t\t\tmodel.editModels.description.content = descriptionEditor.getTrimmedValue()\n\t\t\thandler(dom.getBoundingClientRect(), () => dialog.close())\n\t\t}\n\n\t\tconst summary = model.editModels.summary.content\n\t\tconst heading = summary.trim().length > 0 ? lang.makeTranslation(\"summary\", summary) : \"createEvent_label\"\n\n\t\tconst navigationCallback = (targetPage: EditorPages) => {\n\t\t\tthis.currentPage(targetPage)\n\t\t}\n\n\t\tconst dialog: Dialog = Dialog.editMediumDialog(\n\t\t\t{\n\t\t\t\tleft: this.left.bind(this),\n\t\t\t\tmiddle: heading,\n\t\t\t\tright: this.right.bind(this, okAction),\n\t\t\t\tcreate: (dom) => {\n\t\t\t\t\tthis.headerDom = dom\n\t\t\t\t},\n\t\t\t},\n\t\t\tCalendarEventEditView,\n\t\t\t{\n\t\t\t\tmodel,\n\t\t\t\trecipientsSearch,\n\t\t\t\tdescriptionEditor,\n\t\t\t\tstartOfTheWeekOffset: getStartOfTheWeekOffsetForUser(locator.logins.getUserController().userSettingsGroupRoot),\n\t\t\t\ttimeFormat: getTimeFormatForUser(locator.logins.getUserController().userSettingsGroupRoot),\n\t\t\t\tgroupColors,\n\t\t\t\tdefaultAlarms,\n\t\t\t\tnavigationCallback,\n\t\t\t\tcurrentPage: this.currentPage,\n\t\t\t},\n\t\t\t{\n\t\t\t\theight: \"100%\",\n\t\t\t\t\"background-color\": theme.navigation_bg,\n\t\t\t},\n\t\t)\n\t\t\t.addShortcut({\n\t\t\t\tkey: Keys.ESC,\n\t\t\t\texec: () => dialog.close(),\n\t\t\t\thelp: \"close_alt\",\n\t\t\t})\n\t\t\t.addShortcut({\n\t\t\t\tkey: Keys.S,\n\t\t\t\tctrlOrCmd: true,\n\t\t\t\texec: () => okAction(assertNotNull(this.headerDom, \"headerDom was null\")),\n\t\t\t\thelp: \"save_action\",\n\t\t\t})\n\n\t\tif (client.isMobileDevice()) {\n\t\t\t// Prevent focusing text field automatically on mobile. It opens keyboard and you don't see all details.\n\t\t\tdialog.setFocusOnLoadFunction(noOp)\n\t\t}\n\n\t\tthis.dialog = dialog\n\n\t\tdialog.show()\n\t}\n\n\t/**\n\t * show an edit dialog for an event that does not exist on the server yet (or anywhere else)\n\t *\n\t * will unconditionally send invites on save.\n\t * @param model the calendar event model used to edit and save the event\n\t */\n\tasync showNewCalendarEventEditDialog(model: CalendarEventModel): Promise<void> {\n\t\tlet finished = false\n\n\t\tconst okAction: EditDialogOkHandler = async (posRect, finish) => {\n\t\t\t/** new event, so we always want to send invites. */\n\t\t\tmodel.editModels.whoModel.shouldSendUpdates = true\n\t\t\tif (finished) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst result = await model.apply()\n\t\t\t\tif (result === EventSaveResult.Saved) {\n\t\t\t\t\tfinished = true\n\t\t\t\t\tfinish()\n\n\t\t\t\t\tawait handleRatingByEvent()\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tif (e instanceof UserError) {\n\t\t\t\t\t// noinspection ES6MissingAwait\n\t\t\t\t\tshowUserError(e)\n\t\t\t\t} else if (e instanceof UpgradeRequiredError) {\n\t\t\t\t\tawait showPlanUpgradeRequiredDialog(e.plans)\n\t\t\t\t} else {\n\t\t\t\t\tthrow e\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn this.showCalendarEventEditDialog(model, null, okAction)\n\t}\n\n\t/**\n\t * show a dialog that allows to edit a calendar event that already exists.\n\t *\n\t * on save, will validate external passwords, account type and user intent before actually saving and sending updates/invites/cancellations.\n\t *\n\t * @param model the calendar event model used to edit & save the event\n\t * @param identity the identity of the event to edit\n\t * @param responseMail a mail containing an invite and/or update for this event in case we need to reply to the organizer\n\t */\n\tasync showExistingCalendarEventEditDialog(model: CalendarEventModel, identity: CalendarEventIdentity, responseMail: Mail | null = null): Promise<void> {\n\t\tlet finished = false\n\n\t\tif (identity.uid == null) {\n\t\t\tthrow new ProgrammingError(\"tried to edit existing event without uid, this is impossible for certain edit operations.\")\n\t\t}\n\n\t\tconst okAction: EditDialogOkHandler = async (posRect, finish) => {\n\t\t\tif (finished || (await this.askUserIfUpdatesAreNeededOrCancel(model)) === ConfirmationResult.Cancel) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst result = await model.apply()\n\t\t\t\tif (result === EventSaveResult.Saved || result === EventSaveResult.NotFound) {\n\t\t\t\t\tfinished = true\n\t\t\t\t\tfinish()\n\n\t\t\t\t\t// Inform the user that the event was deleted, avoiding misunderstanding that the event was saved\n\t\t\t\t\tif (result === EventSaveResult.NotFound) Dialog.message(\"eventNoLongerExists_msg\")\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\tif (e instanceof UserError) {\n\t\t\t\t\t// noinspection ES6MissingAwait\n\t\t\t\t\tshowUserError(e)\n\t\t\t\t} else if (e instanceof UpgradeRequiredError) {\n\t\t\t\t\tawait showPlanUpgradeRequiredDialog(e.plans)\n\t\t\t\t} else {\n\t\t\t\t\tthrow e\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tawait this.showCalendarEventEditDialog(model, responseMail, okAction)\n\t}\n\n\t/** if there are update worthy changes on the model, ask the user what to do with them.\n\t * @returns {ConfirmationResult} Cancel if the whole process should be cancelled, Continue if the user selected whether to send updates and the saving\n\t * should proceed.\n\t * */\n\tasync askUserIfUpdatesAreNeededOrCancel(model: CalendarEventModel): Promise<ConfirmationResult> {\n\t\tif (model.isAskingForUpdatesNeeded()) {\n\t\t\tswitch (await askIfShouldSendCalendarUpdatesToAttendees()) {\n\t\t\t\tcase \"yes\":\n\t\t\t\t\tmodel.editModels.whoModel.shouldSendUpdates = true\n\t\t\t\t\tbreak\n\t\t\t\tcase \"no\":\n\t\t\t\t\tbreak\n\t\t\t\tcase \"cancel\":\n\t\t\t\t\tconsole.log(\"not saving event: user cancelled update sending.\")\n\t\t\t\t\treturn ConfirmationResult.Cancel\n\t\t\t}\n\t\t}\n\n\t\treturn ConfirmationResult.Continue\n\t}\n}\n","import { CalendarEvent, CalendarEventAttendee } from \"../../../../common/api/entities/tutanota/TypeRefs.js\"\nimport { calendarEventHasMoreThanOneOccurrencesLeft } from \"../../../../common/calendar/date/CalendarUtils.js\"\nimport { CalendarEventModel, CalendarOperation, EventSaveResult, EventType, getNonOrganizerAttendees } from \"../eventeditor-model/CalendarEventModel.js\"\nimport { NotFoundError } from \"../../../../common/api/common/error/RestError.js\"\nimport { CalendarModel } from \"../../model/CalendarModel.js\"\nimport { ProgrammingError } from \"../../../../common/api/common/error/ProgrammingError.js\"\nimport { CalendarAttendeeStatus } from \"../../../../common/api/common/TutanotaConstants.js\"\nimport m from \"mithril\"\nimport { clone, Thunk } from \"@tutao/tutanota-utils\"\nimport { CalendarEventUidIndexEntry } from \"../../../../common/api/worker/facades/lazy/CalendarFacade.js\"\nimport { EventEditorDialog } from \"../eventeditor-view/CalendarEventEditDialog.js\"\n\n/**\n * makes decisions about which operations are available from the popup and knows how to implement them depending on the event's type.\n */\nexport class CalendarEventPreviewViewModel {\n\treadonly canEdit: boolean\n\treadonly canDelete: boolean\n\treadonly canSendUpdates: boolean\n\t/** for editing, an event that has only one non-deleted instance is still considered repeating\n\t * because we might reschedule that instance and then unexclude some deleted instances.\n\t *\n\t * the ability to edit a single instance also depends on the event type:\n\t *    * OWN -> I can do what I want\n\t *    * SHARED_RW -> can edit single instance as if it was my own (since single instance editing locks attendees anyway)\n\t *    * SHARED_RO, LOCKED, EXTERNAL -> cannot edit at all\n\t *    * INVITE -> we're not the organizer, we can only set our own attendance globally and send it back to the organizer.\n\t *          probably the best reason to make single-instance attendee editing possible asap.\n\t */\n\treadonly isRepeatingForEditing: boolean\n\n\tprivate sanitizedDescription: string | null = null\n\n\tprivate processing: boolean = false\n\tprivate readonly _ownAttendee: CalendarEventAttendee | null\n\n\t/**\n\t *\n\t * @param calendarEvent the event to display in the popup\n\t * @param calendarModel the calendar model where the event can be updated/deleted\n\t * @param eventType\n\t * @param hasBusinessFeature if the current user is allowed to do certain operations.\n\t * @param ownAttendee will be cloned to have a copy that's not influencing the actual event but can be changed to quickly update the UI\n\t * @param lazyIndexEntry async function to resolve the progenitor of the shown event\n\t * @param eventModelFactory\n\t * @param uiUpdateCallback\n\t */\n\tconstructor(\n\t\treadonly calendarEvent: Readonly<CalendarEvent>,\n\t\tprivate readonly calendarModel: CalendarModel,\n\t\treadonly eventType: EventType,\n\t\tprivate readonly hasBusinessFeature: boolean,\n\t\townAttendee: CalendarEventAttendee | null,\n\t\tprivate readonly lazyIndexEntry: () => Promise<CalendarEventUidIndexEntry | null>,\n\t\tprivate readonly eventModelFactory: (mode: CalendarOperation) => Promise<CalendarEventModel | null>,\n\t\tprivate readonly uiUpdateCallback: () => void = m.redraw,\n\t) {\n\t\tthis._ownAttendee = clone(ownAttendee)\n\t\tif (this.calendarEvent._ownerGroup == null) {\n\t\t\tthis.canEdit = false\n\t\t\tthis.canDelete = false\n\t\t\tthis.canSendUpdates = false\n\t\t} else {\n\t\t\t// partially editable (adding alarms) counts as editable.\n\t\t\tthis.canEdit =\n\t\t\t\tthis.eventType === EventType.OWN ||\n\t\t\t\tthis.eventType === EventType.SHARED_RW ||\n\t\t\t\tthis.eventType === EventType.LOCKED ||\n\t\t\t\tthis.eventType === EventType.INVITE\n\t\t\tthis.canDelete = this.canEdit || this.eventType === EventType.INVITE\n\t\t\tthis.canSendUpdates = hasBusinessFeature && this.eventType === EventType.OWN && getNonOrganizerAttendees(calendarEvent).length > 0\n\t\t}\n\n\t\tthis.isRepeatingForEditing =\n\t\t\t(calendarEvent.repeatRule != null || calendarEvent.recurrenceId != null) && (eventType === EventType.OWN || eventType === EventType.SHARED_RW)\n\t}\n\n\t/** for deleting, an event that has only one non-deleted instance behaves as if it wasn't repeating\n\t * because deleting the last instance is the same as deleting the whole event from the pov of the user.\n\t */\n\tasync isRepeatingForDeleting(): Promise<boolean> {\n\t\tconst index = await this.lazyIndexEntry()\n\t\tif (index == null) return false\n\t\treturn calendarEventHasMoreThanOneOccurrencesLeft(index)\n\t}\n\n\tget ownAttendee(): CalendarEventAttendee | null {\n\t\treturn this._ownAttendee\n\t}\n\n\t/** return an object enabling us to set and display the participation correctly if this is an event we're invited to, null otherwise.\n\t * note that the Promise<unknown> type on setParticipation prevents us from leaking errors when consumers call it and try to catch errors without\n\t * awaiting it (they get an async call without await warning) */\n\tgetParticipationSetterAndThen(action: Thunk): null | {\n\t\townAttendee: CalendarEventAttendee\n\t\tsetParticipation: (status: CalendarAttendeeStatus) => Promise<unknown>\n\t} {\n\t\tif (this.ownAttendee == null || this.eventType !== EventType.INVITE) return null\n\t\treturn {\n\t\t\townAttendee: this.ownAttendee,\n\t\t\tsetParticipation: async (status) => {\n\t\t\t\tawait this.setOwnAttendance(status)\n\t\t\t\taction()\n\t\t\t},\n\t\t}\n\t}\n\n\tprivate async setOwnAttendance(status: CalendarAttendeeStatus): Promise<void> {\n\t\tif (this.calendarEvent.organizer == null || this.ownAttendee == null || this.processing || this._ownAttendee?.status === status) return\n\t\tconst oldStatus = this.ownAttendee.status\n\t\tthis.processing = true\n\t\ttry {\n\t\t\tthis.ownAttendee.status = status\n\t\t\tthis.uiUpdateCallback()\n\t\t\t// no per-instance attendees yet.\n\t\t\tconst model = await this.eventModelFactory(CalendarOperation.EditAll)\n\t\t\tif (model) {\n\t\t\t\tmodel.editModels.whoModel.setOwnAttendance(status)\n\t\t\t\tmodel.editModels.whoModel.isConfidential = this.calendarEvent.invitedConfidentially ?? false\n\t\t\t\tawait model.apply()\n\t\t\t} else {\n\t\t\t\tthis.ownAttendee.status = oldStatus\n\t\t\t}\n\t\t} catch (e) {\n\t\t\tthis.ownAttendee.status = oldStatus\n\t\t\tthrow e\n\t\t} finally {\n\t\t\tthis.processing = false\n\t\t}\n\t}\n\n\t/** add an exclusion for this event instances start time on the original event.\n\t * if this is a rescheduled instance, we will just delete the event because the progenitor already\n\t * has an exclusion for this time.\n\t * */\n\tasync deleteSingle() {\n\t\ttry {\n\t\t\tconst model = await this.eventModelFactory(CalendarOperation.DeleteThis)\n\t\t\tawait model?.apply()\n\t\t} catch (e) {\n\t\t\tif (!(e instanceof NotFoundError)) {\n\t\t\t\tthrow e\n\t\t\t}\n\t\t}\n\t}\n\n\tasync deleteAll(): Promise<void> {\n\t\ttry {\n\t\t\tconst model = await this.eventModelFactory(CalendarOperation.DeleteAll)\n\t\t\tawait model?.apply()\n\t\t} catch (e) {\n\t\t\tif (!(e instanceof NotFoundError)) {\n\t\t\t\tthrow e\n\t\t\t}\n\t\t}\n\t}\n\n\tasync editSingle() {\n\t\tconst model = await this.eventModelFactory(CalendarOperation.EditThis)\n\t\tif (model == null) {\n\t\t\treturn\n\t\t}\n\t\ttry {\n\t\t\tconst eventEditor = new EventEditorDialog()\n\t\t\treturn await eventEditor.showExistingCalendarEventEditDialog(model, {\n\t\t\t\tuid: this.calendarEvent.uid,\n\t\t\t\tsequence: this.calendarEvent.sequence,\n\t\t\t\trecurrenceId: this.calendarEvent.startTime,\n\t\t\t})\n\t\t} catch (err) {\n\t\t\tif (err instanceof NotFoundError) {\n\t\t\t\tconsole.log(\"occurrence not found when clicking on the event\")\n\t\t\t} else {\n\t\t\t\tthrow err\n\t\t\t}\n\t\t}\n\n\t\tthrow new ProgrammingError(\"not implemented\")\n\t}\n\n\tasync editAll() {\n\t\tconst model = await this.eventModelFactory(CalendarOperation.EditAll)\n\t\tif (model == null) {\n\t\t\treturn\n\t\t}\n\t\ttry {\n\t\t\tconst eventEditor = new EventEditorDialog()\n\t\t\treturn await eventEditor.showExistingCalendarEventEditDialog(model, {\n\t\t\t\tuid: this.calendarEvent.uid,\n\t\t\t\tsequence: this.calendarEvent.sequence,\n\t\t\t\trecurrenceId: null,\n\t\t\t})\n\t\t} catch (err) {\n\t\t\tif (err instanceof NotFoundError) {\n\t\t\t\tconsole.log(\"calendar event not found when clicking on the event\")\n\t\t\t} else {\n\t\t\t\tthrow err\n\t\t\t}\n\t\t}\n\t}\n\n\tasync sendUpdates(): Promise<EventSaveResult> {\n\t\tconst model = await this.eventModelFactory(CalendarOperation.EditAll)\n\t\tif (model == null) {\n\t\t\treturn EventSaveResult.Failed\n\t\t}\n\t\ttry {\n\t\t\tmodel.editModels.whoModel.shouldSendUpdates = true\n\t\t\tawait model.apply()\n\t\t\treturn EventSaveResult.Saved\n\t\t} finally {\n\t\t\tmodel.editModels.whoModel.shouldSendUpdates = false\n\t\t}\n\t}\n\n\tasync sanitizeDescription(): Promise<void> {\n\t\tconst { htmlSanitizer } = await import(\"../../../../common/misc/HtmlSanitizer.js\")\n\t\tthis.sanitizedDescription = htmlSanitizer.sanitizeHTML(this.calendarEvent.description, {\n\t\t\tblockExternalContent: true,\n\t\t}).html\n\t}\n\n\tgetSanitizedDescription() {\n\t\treturn this.sanitizedDescription\n\t}\n}\n"],"mappings":"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"}