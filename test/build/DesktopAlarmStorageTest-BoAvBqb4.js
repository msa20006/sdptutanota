
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { assertNotNull, base64ToUint8Array, findAllAndRemove, uint8ArrayToBase64 } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import "./Env-D5xGlXfw.js";
import "./TutanotaConstants-3bwAESYA.js";
import "./CryptoError-PqdvQky4.js";
import "./CancelledError-FjP5S_cR.js";
import { elementIdPart } from "./EntityUtils-RQxXZlcV.js";
import "./TypeModels-XIXYys8J.js";
import "./TypeRefs-CR3TLWn0.js";
import "./TypeModels-BktRFNDN.js";
import "./EntityFunctions-l6CncM5C.js";
import "./TypeModels-ZqCk-pGw.js";
import "./ModelInfo-DEa-Yxv2.js";
import "./dist-DcZ1Y4qd.js";
import "./FileUtils-W-u2-gZz.js";
import "./IndexTables-C5S9WDY9.js";
import "./IndexUtils-K27esrGs.js";
import { DesktopConfigKey } from "./ConfigKeys-B1UD5FwS.js";
import { log } from "./DesktopLog-yAgEoQsh.js";
import "./IndexerCore-CrLYpsA5.js";
import { dist_default } from "./dist-Ci1bEzYU.js";
import { require_testdouble } from "./testdouble-IbRSnrC0.js";
import "./dist-BY49f75m.js";
import { makeKeyStoreFacade } from "./TestUtils-f_4UhLVE.js";
import "./PathUtils-DFfSo_TG.js";
import { DesktopNativeCryptoFacade } from "./DesktopNativeCryptoFacade-DsjWfqrR.js";

//#region ../src/common/desktop/sse/DesktopAlarmStorage.ts
var DesktopAlarmStorage = class {
	/** push identifier id to key */
	sessionKeys;
	constructor(conf, cryptoFacade, keyStoreFacade) {
		this.conf = conf;
		this.cryptoFacade = cryptoFacade;
		this.keyStoreFacade = keyStoreFacade;
		this.sessionKeys = {};
	}
	/**
	* encrypt & store a session key to disk
	* @param pushIdentifierId pushIdentifier the key belongs to
	* @param pushIdentifierSessionKey unencrypted B64 encoded key to store
	* @returns {*}
	*/
	async storePushIdentifierSessionKey(pushIdentifierId, pushIdentifierSessionKey) {
		const keys = await this.conf.getVar(DesktopConfigKey.pushEncSessionKeys) || {};
		if (!keys[pushIdentifierId]) {
			this.sessionKeys[pushIdentifierId] = uint8ArrayToBase64(pushIdentifierSessionKey);
			return this.keyStoreFacade.getDeviceKey().then((pw) => {
				keys[pushIdentifierId] = uint8ArrayToBase64(this.cryptoFacade.aes256EncryptKey(pw, pushIdentifierSessionKey));
				return this.conf.setVar(DesktopConfigKey.pushEncSessionKeys, keys);
			});
		}
		return Promise.resolve();
	}
	removePushIdentifierKeys() {
		this.sessionKeys = {};
		return this.conf.setVar(DesktopConfigKey.pushEncSessionKeys, null);
	}
	removePushIdentifierKey(piId) {
		log.debug("Remove push identifier key. elementId=" + piId);
		delete this.sessionKeys[piId];
		return this.conf.setVar(DesktopConfigKey.pushEncSessionKeys, this.sessionKeys);
	}
	/**
	* try to get a B64 encoded PushIdentifierSessionKey that can decrypt a notificationSessionKey from memory or decrypt it from disk storage
	* @param notificationSessionKey one notificationSessionKey from an alarmNotification.
	* @return {Promise<?Base64>} a stored pushIdentifierSessionKey that should be able to decrypt the given notificationSessionKey
	*/
	async getPushIdentifierSessionKey(notificationSessionKey) {
		const pw = await this.keyStoreFacade.getDeviceKey();
		const pushIdentifierId = elementIdPart(notificationSessionKey.pushIdentifier);
		if (this.sessionKeys[pushIdentifierId]) return base64ToUint8Array(this.sessionKeys[pushIdentifierId]);
else {
			const keys = await this.conf.getVar(DesktopConfigKey.pushEncSessionKeys) || {};
			const sessionKeyFromConf = keys[pushIdentifierId];
			if (sessionKeyFromConf == null) return null;
			try {
				const decryptedKey = this.cryptoFacade.unauthenticatedAes256DecryptKey(pw, base64ToUint8Array(sessionKeyFromConf));
				this.sessionKeys[pushIdentifierId] = uint8ArrayToBase64(decryptedKey);
				return decryptedKey;
			} catch (e) {
				console.warn("could not decrypt pushIdentifierSessionKey");
				return null;
			}
		}
	}
	async storeAlarm(alarm) {
		const allAlarms = await this.getScheduledAlarms();
		findAllAndRemove(allAlarms, (an) => an.alarmInfo.alarmIdentifier === alarm.alarmInfo.alarmIdentifier);
		allAlarms.push(alarm);
		await this._saveAlarms(allAlarms);
	}
	async deleteAlarm(identifier) {
		const allAlarms = await this.getScheduledAlarms();
		findAllAndRemove(allAlarms, (an) => an.alarmInfo.alarmIdentifier === identifier);
		await this._saveAlarms(allAlarms);
	}
	/**
	* If userId is null then we delete alarms for all users
	*/
	async deleteAllAlarms(userId) {
		if (userId == null) return this._saveAlarms([]);
else {
			const allScheduledAlarms = await this.getScheduledAlarms();
			findAllAndRemove(allScheduledAlarms, (alarm) => alarm.user === userId);
			return this._saveAlarms(allScheduledAlarms);
		}
	}
	async getScheduledAlarms() {
		const alarms = await this.conf.getVar(DesktopConfigKey.scheduledAlarms);
		return alarms?.map((a) => {
			if (!a.repeatRule) return a;
			a.repeatRule = {
				excludedDates: [],
				...a.repeatRule
			};
			return a;
		}) || [];
	}
	_saveAlarms(alarms) {
		return this.conf.setVar(DesktopConfigKey.scheduledAlarms, alarms);
	}
};

//#endregion
//#region tests/desktop/sse/DesktopAlarmStorageTest.ts
var import_testdouble = __toESM(require_testdouble(), 1);
dist_default.spec("DesktopAlarmStorageTest", function() {
	let cryptoMock;
	let confMock;
	const key1 = new Uint8Array([1]);
	const key2 = new Uint8Array([2]);
	const key3 = new Uint8Array([3]);
	const key4 = new Uint8Array([4]);
	const decryptedKey = new Uint8Array([0, 1]);
	const encryptedKey = new Uint8Array([1, 0]);
	dist_default.beforeEach(function() {
		cryptoMock = (0, import_testdouble.instance)(DesktopNativeCryptoFacade);
		(0, import_testdouble.when)(cryptoMock.unauthenticatedAes256DecryptKey(import_testdouble.matchers.anything(), key3)).thenReturn(decryptedKey);
		(0, import_testdouble.when)(cryptoMock.aes256EncryptKey(import_testdouble.matchers.anything(), import_testdouble.matchers.anything())).thenReturn(encryptedKey);
		confMock = (0, import_testdouble.object)();
		(0, import_testdouble.when)(confMock.getVar(DesktopConfigKey.pushEncSessionKeys)).thenResolve({
			user1: uint8ArrayToBase64(key1),
			user2: uint8ArrayToBase64(key2),
			twoId: uint8ArrayToBase64(key3),
			fourId: uint8ArrayToBase64(key4)
		});
	});
	dist_default("getPushIdentifierSessionKey with uncached sessionKey", async function() {
		const keyStoreFacade = makeKeyStoreFacade(new Uint8Array([
			1,
			2,
			3
		]));
		const desktopStorage = new DesktopAlarmStorage(confMock, cryptoMock, keyStoreFacade);
		const key = await desktopStorage.getPushIdentifierSessionKey({
			pushIdentifierSessionEncSessionKey: "abc",
			pushIdentifier: ["oneId", "twoId"]
		});
		(0, import_testdouble.verify)(confMock.getVar(DesktopConfigKey.pushEncSessionKeys), { times: 1 });
		dist_default(Array.from(assertNotNull(key))).deepEquals(Array.from(decryptedKey));
	});
	dist_default("getPushIdentifierSessionKey with cached sessionKey", async function() {
		const keyStoreFacade = makeKeyStoreFacade(new Uint8Array([
			1,
			2,
			3
		]));
		(0, import_testdouble.when)(confMock.getVar(import_testdouble.matchers.anything())).thenResolve(null);
		const desktopStorage = new DesktopAlarmStorage(confMock, cryptoMock, keyStoreFacade);
		await desktopStorage.storePushIdentifierSessionKey("fourId", key4);
		(0, import_testdouble.verify)(confMock.setVar(DesktopConfigKey.pushEncSessionKeys, { fourId: uint8ArrayToBase64(encryptedKey) }), { times: 1 });
		const key = await desktopStorage.getPushIdentifierSessionKey({
			pushIdentifierSessionEncSessionKey: "def",
			pushIdentifier: ["threeId", "fourId"]
		});
		dist_default(Array.from(assertNotNull(key))).deepEquals(Array.from(key4));
	});
	dist_default("getPushIdentifierSessionKey when sessionKey is unavailable", async function() {
		const keyStoreFacade = makeKeyStoreFacade(new Uint8Array([
			1,
			2,
			3
		]));
		const desktopStorage = new DesktopAlarmStorage(confMock, cryptoMock, keyStoreFacade);
		const key1$1 = await desktopStorage.getPushIdentifierSessionKey({
			pushIdentifierSessionEncSessionKey: "def",
			pushIdentifier: ["fiveId", "sixId"]
		});
		dist_default(key1$1).equals(null);
	});
});

//#endregion
//# sourceMappingURL=DesktopAlarmStorageTest-BoAvBqb4.js.map