
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { decodeBase64, decodeQuotedPrintable } from "./dist-CJHwsXKY.js";
import { assertMainOrNode } from "./Env-D5xGlXfw.js";
import { ContactAddressType, ContactMessengerHandleType, ContactPhoneNumberType, ContactRelationshipType, ContactWebsiteType } from "./TutanotaConstants-3bwAESYA.js";
import { createBirthday, createContact, createContactAddress, createContactMailAddress, createContactMessengerHandle, createContactPhoneNumber, createContactPronouns, createContactRelationship, createContactWebsite } from "./TypeRefs-CR3TLWn0.js";
import { ParsingError, birthdayToIsoDate, isValidBirthday } from "./BirthdayUtils-BcCMglSq.js";

//#region ../src/mail-app/contacts/VCardImporter.ts
assertMainOrNode();
function vCardFileToVCards(vCardFileData) {
	let V4 = "\nVERSION:4.0";
	let V3 = "\nVERSION:3.0";
	let V2 = "\nVERSION:2.1";
	let B = "BEGIN:VCARD\n";
	let E = "END:VCARD";
	vCardFileData = vCardFileData.replace(/begin:vcard/g, "BEGIN:VCARD");
	vCardFileData = vCardFileData.replace(/end:vcard/g, "END:VCARD");
	vCardFileData = vCardFileData.replace(/version:2.1/g, "VERSION:2.1");
	if (vCardFileData.indexOf("BEGIN:VCARD") > -1 && vCardFileData.indexOf(E) > -1 && (vCardFileData.indexOf(V4) > -1 || vCardFileData.indexOf(V3) > -1 || vCardFileData.indexOf(V2) > -1)) {
		vCardFileData = vCardFileData.replace(/\r/g, "");
		vCardFileData = vCardFileData.replace(/\n /g, "");
		vCardFileData = vCardFileData.replace(/\nEND:VCARD\n\n/g, "");
		vCardFileData = vCardFileData.replace(/\nEND:VCARD\n/g, "");
		vCardFileData = vCardFileData.replace(/\nEND:VCARD/g, "");
		vCardFileData = vCardFileData.substring(vCardFileData.indexOf(B) + B.length);
		return vCardFileData.split(B);
	} else return null;
}
function vCardEscapingSplit(details) {
	details = details.replace(/\\\\/g, "--bslashbslash++");
	details = details.replace(/\\;/g, "--semiColonsemiColon++");
	details = details.replace(/\\:/g, "--dPunktdPunkt++");
	let array = details.split(";");
	array = array.map((elem) => {
		return elem.trim();
	});
	return array;
}
function vCardReescapingArray(details) {
	return details.map((a) => {
		a = a.replace(/--bslashbslash\+\+/g, "\\");
		a = a.replace(/--semiColonsemiColon\+\+/g, ";");
		a = a.replace(/--dPunktdPunkt\+\+/g, ":");
		a = a.replace(/\\n/g, "\n");
		a = a.replace(/\\,/g, ",");
		return a;
	});
}
function vCardEscapingSplitAdr(addressDetails) {
	addressDetails = addressDetails.replace(/\\\\/g, "--bslashbslash++");
	addressDetails = addressDetails.replace(/\\;/g, "--semiColonsemiColon++");
	let array = addressDetails.split(";");
	return array.map((elem) => {
		if (elem.trim().length > 0) return elem.trim().concat("\n");
else return "";
	});
}
function _decodeTag(encoding, charset, text) {
	let decoder = (cs, l) => l;
	switch (encoding.toLowerCase()) {
		case "quoted-printable:":
			decoder = decodeQuotedPrintable;
			break;
		case "base64:": decoder = decodeBase64;
	}
	return text.split(";").map((line) => decoder(charset, line)).join(";");
}
function getPropertyValue(property, tagValue) {
	const exp = new RegExp(property + "=(.*?)[:;]", "gi");
	return (Array.from(tagValue.matchAll(exp), (m) => m[1])[0] ?? "").trim();
}
function vCardListToContacts(vCardList, ownerGroupId) {
	let contacts = [];
	for (let i = 0; i < vCardList.length; i++) {
		let lastName = "";
		let firstName = "";
		let title = null;
		let birthdayIso = null;
		let company = "";
		let comment = "";
		let nickname = null;
		let role = "";
		let department = "";
		let middleName = "";
		let suffix = "";
		const addresses = [];
		const mailAddresses = [];
		const phoneNumbers = [];
		const websites = [];
		const relationships = [];
		const pronouns = [];
		const messengerHandles = [];
		let vCardLines = vCardList[i].split("\n");
		for (let j = 0; j < vCardLines.length; j++) {
			let indexAfterTag = vCardLines[j].indexOf(":");
			let tagAndTypeString = vCardLines[j].substring(0, indexAfterTag).toUpperCase();
			let tagName = tagAndTypeString.split(";")[0];
			let tagValue = vCardLines[j].substring(indexAfterTag + 1);
			let encodingObj = vCardLines[j].split(";").find((line) => line.includes("ENCODING="));
			let encoding = encodingObj ? encodingObj.split("=")[1] : "";
			let charsetObj = vCardLines[j].split(";").find((line) => line.includes("CHARSET="));
			let charset = charsetObj ? charsetObj.split("=")[1] : "utf-8";
			tagValue = _decodeTag(encoding, charset, tagValue);
			switch (tagName) {
				case "N": {
					let nameDetails = vCardReescapingArray(vCardEscapingSplit(tagValue));
					for (let i$1 = nameDetails.length; nameDetails.length < 4; i$1++) nameDetails.push("");
					lastName = nameDetails[0];
					firstName = nameDetails[1];
					middleName = nameDetails[2];
					title = nameDetails[3];
					suffix = nameDetails[4];
					break;
				}
				case "FN":
					if (firstName === "" && lastName === "" && title == null && middleName === "" && suffix === "") {
						let fullName = vCardReescapingArray(vCardEscapingSplit(tagValue));
						firstName = fullName.join(" ").replace(/"/g, "");
					}
					break;
				case "BDAY": {
					let indexOfT = tagValue.indexOf("T");
					let bDayDetails = null;
					if (tagValue.match(/--\d{4}/g)) bDayDetails = createBirthday({
						month: tagValue.substring(2, 4),
						day: tagValue.substring(4, 6),
						year: null
					});
else if (tagValue.match(/\d{4}-\d{2}-\d{2}/g)) {
						let bDay = tagValue.substring(0, indexOfT !== -1 ? indexOfT : tagValue.length).split("-");
						bDayDetails = createBirthday({
							year: bDay[0].trim(),
							month: bDay[1].trim(),
							day: bDay[2].trim()
						});
					} else if (tagValue.match(/\d{8}/g)) bDayDetails = createBirthday({
						year: tagValue.substring(0, 4),
						month: tagValue.substring(4, 6),
						day: tagValue.substring(6, 8)
					});
					if (bDayDetails && bDayDetails.year === "1111") bDayDetails.year = null;
					try {
						birthdayIso = bDayDetails && isValidBirthday(bDayDetails) ? birthdayToIsoDate(bDayDetails) : null;
					} catch (e) {
						if (e instanceof ParsingError) console.log("failed to parse birthday", e);
else throw e;
					}
					break;
				}
				case "ORG": {
					let orgDetails = vCardReescapingArray(vCardEscapingSplit(tagValue));
					for (let i$1 = orgDetails.length; orgDetails.length < 2; i$1++) orgDetails.push("");
					department = orgDetails.pop() ?? "";
					company = orgDetails.join(" ");
					break;
				}
				case "NOTE": {
					let note = vCardReescapingArray(vCardEscapingSplit(tagValue));
					comment = note.join(" ");
					break;
				}
				case "ADR":
				case "ITEM1.ADR":
				case "ITEM2.ADR":
					if (tagAndTypeString.indexOf("HOME") > -1) _addAddress(tagValue, addresses, ContactAddressType.PRIVATE);
else if (tagAndTypeString.indexOf("WORK") > -1) _addAddress(tagValue, addresses, ContactAddressType.WORK);
else _addAddress(tagValue, addresses, ContactAddressType.OTHER);
					break;
				case "EMAIL":
				case "ITEM1.EMAIL":
				case "ITEM2.EMAIL":
					if (tagAndTypeString.indexOf("HOME") > -1) _addMailAddress(tagValue, mailAddresses, ContactAddressType.PRIVATE);
else if (tagAndTypeString.indexOf("WORK") > -1) _addMailAddress(tagValue, mailAddresses, ContactAddressType.WORK);
else _addMailAddress(tagValue, mailAddresses, ContactAddressType.OTHER);
					break;
				case "TEL":
				case "ITEM1.TEL":
				case "ITEM2.TEL":
					tagValue = tagValue.replace(/[\u2000-\u206F]/g, "");
					if (tagAndTypeString.indexOf("HOME") > -1) _addPhoneNumber(tagValue, phoneNumbers, ContactPhoneNumberType.PRIVATE);
else if (tagAndTypeString.indexOf("WORK") > -1) _addPhoneNumber(tagValue, phoneNumbers, ContactPhoneNumberType.WORK);
else if (tagAndTypeString.indexOf("FAX") > -1) _addPhoneNumber(tagValue, phoneNumbers, ContactPhoneNumberType.FAX);
else if (tagAndTypeString.indexOf("CELL") > -1) _addPhoneNumber(tagValue, phoneNumbers, ContactPhoneNumberType.MOBILE);
else _addPhoneNumber(tagValue, phoneNumbers, ContactPhoneNumberType.OTHER);
					break;
				case "URL":
				case "ITEM1.URL":
				case "ITEM2.URL":
					addWebsite(tagValue, websites);
					break;
				case "NICKNAME": {
					let nick = vCardReescapingArray(vCardEscapingSplit(tagValue));
					nickname = nick.join(" ");
					break;
				}
				case "PHOTO": break;
				case "ROLE":
				case "TITLE": {
					let vcardRole = vCardReescapingArray(vCardEscapingSplit(tagValue));
					role += (" " + vcardRole.join(" ")).trim();
					break;
				}
				case "RELATED": {
					let type = ContactRelationshipType.OTHER;
					const vCardPropertyType = getPropertyValue("TYPE", tagAndTypeString).toLowerCase();
					if (vCardPropertyType === "friend") type = ContactRelationshipType.FRIEND;
else if (vCardPropertyType === "child") type = ContactRelationshipType.CHILD;
else if (vCardPropertyType === "parent") type = ContactRelationshipType.PARENT;
else if (vCardPropertyType === "spouse") type = ContactRelationshipType.SPOUSE;
					addRelationship(tagValue, relationships, type);
					break;
				}
				case "PRONOUNS": {
					const lang = getPropertyValue("LANG", tagAndTypeString);
					addPronouns(tagValue, pronouns, lang);
					break;
				}
				case "IMPP": {
					const imRawType = getPropertyValue("TYPE", tagAndTypeString);
					let imType = ContactMessengerHandleType.OTHER;
					let customTypeName = "";
					if (imRawType.toLowerCase() === "telegram") imType = ContactMessengerHandleType.TELEGRAM;
else if (imRawType.toLowerCase() === "whatsapp") imType = ContactMessengerHandleType.WHATSAPP;
else if (imRawType.toLowerCase() === "signal") imType = ContactMessengerHandleType.SIGNAL;
else if (imRawType.toLowerCase() === "discord") imType = ContactMessengerHandleType.DISCORD;
else if (imRawType.trim() != "") {
						imType = ContactMessengerHandleType.CUSTOM;
						customTypeName = imRawType.trim();
					}
					const handleData = tagValue.indexOf(":") > -1 ? tagValue.substring(tagValue.indexOf(":") + 1) : tagValue;
					addMessengerHandle(handleData, messengerHandles, imType, customTypeName);
					break;
				}
				default:
			}
		}
		contacts[i] = createContact({
			_ownerGroup: ownerGroupId,
			lastName,
			firstName,
			title,
			birthdayIso,
			company,
			comment,
			nickname,
			role,
			addresses,
			mailAddresses,
			phoneNumbers,
			department,
			middleName,
			websites,
			relationships,
			pronouns,
			messengerHandles,
			nameSuffix: suffix,
			phoneticFirst: null,
			phoneticLast: null,
			phoneticMiddle: null,
			customDate: [],
			socialIds: [],
			presharedPassword: null,
			photo: null,
			oldBirthdayDate: null,
			oldBirthdayAggregate: null
		});
	}
	function _addAddress(vCardAddressValue, addresses, type) {
		let addressDetails = vCardReescapingArray(vCardEscapingSplitAdr(vCardAddressValue));
		let address = createContactAddress({
			type,
			address: addressDetails.join("").trim(),
			customTypeName: ""
		});
		addresses.push(address);
	}
	function _addPhoneNumber(vCardPhoneNumberValue, phoneNumbers, type) {
		let phoneNumber = createContactPhoneNumber({
			type,
			number: vCardPhoneNumberValue,
			customTypeName: ""
		});
		phoneNumbers.push(phoneNumber);
	}
	function _addMailAddress(vCardMailAddressValue, mailAddresses, type) {
		let email = createContactMailAddress({
			type,
			address: vCardMailAddressValue,
			customTypeName: ""
		});
		mailAddresses.push(email);
	}
	function addRelationship(relationshipPerson, relationships, type) {
		const relationship = createContactRelationship({
			type,
			person: relationshipPerson,
			customTypeName: ""
		});
		relationships.push(relationship);
	}
	function addPronouns(pronouns, pronounsArray, lang) {
		const pronounsToAdd = createContactPronouns({
			language: lang,
			pronouns
		});
		pronounsArray.push(pronounsToAdd);
	}
	function addMessengerHandle(handle, messengerHandleArray, type, customTypeName) {
		const newHandle = createContactMessengerHandle({
			handle,
			type,
			customTypeName
		});
		messengerHandleArray.push(newHandle);
	}
	function addWebsite(tagValue, websites) {
		let website = createContactWebsite({
			type: ContactWebsiteType.OTHER,
			url: vCardReescapingArray(vCardEscapingSplit(tagValue)).join(""),
			customTypeName: ""
		});
		websites.push(website);
	}
	return contacts;
}

//#endregion
export { vCardFileToVCards, vCardListToContacts };
//# sourceMappingURL=VCardImporter-D9iigKrh.js.map