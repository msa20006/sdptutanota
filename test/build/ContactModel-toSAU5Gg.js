
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import { LazyLoaded, getFirstOrThrow, isNotNull, ofClass, pMap } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import { assertMainOrNode } from "./Env-D5xGlXfw.js";
import { ShareCapability } from "./TutanotaConstants-3bwAESYA.js";
import { NotAuthorizedError, NotFoundError } from "./RestError-D17JEBMr.js";
import { LoginIncompleteError } from "./LoginIncompleteError-CpiW0a0l.js";
import { DbError } from "./DbError-CcwZaPG2.js";
import { require_stream } from "./stream-u2PttBAC.js";
import { compareOldestFirst, getEtId } from "./EntityUtils-RQxXZlcV.js";
import { cleanMailAddress } from "./CommonCalendarUtils-DKaO7v1K.js";
import "./TypeModels-XIXYys8J.js";
import { ContactListGroupRootTypeRef, ContactListTypeRef, ContactTypeRef } from "./TypeRefs-CR3TLWn0.js";
import "./TypeModels-BktRFNDN.js";
import { GroupInfoTypeRef, GroupTypeRef } from "./TypeRefs-BP1jvX9p.js";
import "./EntityFunctions-l6CncM5C.js";
import "./TypeModels-ZqCk-pGw.js";
import "./ModelInfo-DEa-Yxv2.js";
import { loadMultipleFromLists } from "./EntityClient-B0RSdk2i.js";

//#region ../src/common/contactsFunctionality/ContactModel.ts
var import_stream = __toESM(require_stream(), 1);
assertMainOrNode();
var ContactModel = class {
	contactListId;
	contactListInfo = (0, import_stream.default)();
	constructor(entityClient, loginController, eventController, contactSearch) {
		this.entityClient = entityClient;
		this.loginController = loginController;
		this.eventController = eventController;
		this.contactSearch = contactSearch;
		this.contactListId = lazyContactListId(loginController, this.entityClient);
		this.eventController.addEntityListener(this.entityEventsReceived);
	}
	async getLoadedContactListInfos() {
		if (this.contactListInfo() === undefined) await this.loadContactLists();
		return this.contactListInfo();
	}
	/** might be empty if not loaded yet */
	getOwnContactListInfos() {
		return this.contactListInfo.map((contactListInfos) => contactListInfos.filter((info) => info.isOwner));
	}
	/** might be empty if not loaded yet */
	getSharedContactListInfos() {
		return this.contactListInfo.map((contactListInfos) => contactListInfos.filter((info) => !info.isOwner));
	}
	/** Id of the contact list. Is null for external users. */
	getContactListId() {
		return this.contactListId.getAsync();
	}
	/**
	* Provides the first contact (starting with oldest contact) that contains the given email address. Uses the index search if available, otherwise loads all contacts.
	*/
	async searchForContact(mailAddress) {
		if (!this.loginController.isFullyLoggedIn()) throw new LoginIncompleteError("cannot search for contacts as online login is not completed");
		const cleanedMailAddress = cleanMailAddress(mailAddress);
		let result;
		try {
			result = await this.contactSearch("\"" + cleanedMailAddress + "\"", "mailAddress", 0);
		} catch (e) {
			if (e instanceof DbError) {
				const listId = await this.getContactListId();
				if (listId) {
					const contacts = await this.entityClient.loadAll(ContactTypeRef, listId);
					return contacts.find((contact) => contact.mailAddresses.some((a) => cleanMailAddress(a.address) === cleanedMailAddress)) ?? null;
				} else return null;
			} else throw e;
		}
		result.results.sort(compareOldestFirst);
		for (const contactId of result.results) try {
			const contact = await this.entityClient.load(ContactTypeRef, contactId);
			if (contact.mailAddresses.some((a) => cleanMailAddress(a.address) === cleanedMailAddress)) return contact;
		} catch (e) {
			if (e instanceof NotFoundError || e instanceof NotAuthorizedError) continue;
else throw e;
		}
		return null;
	}
	/**
	* @pre locator.search.indexState().indexingSupported
	*/
	async searchForContacts(query, field, minSuggestionCount) {
		if (!this.loginController.isFullyLoggedIn()) throw new LoginIncompleteError("cannot search for contacts as online login is not completed");
		const result = await this.contactSearch(query, field, minSuggestionCount);
		return await loadMultipleFromLists(ContactTypeRef, this.entityClient, result.results);
	}
	async searchForContactLists(query) {
		if (!this.loginController.isFullyLoggedIn()) throw new LoginIncompleteError("cannot search for contact lists as online login is not completed");
		const contactLists = await this.getLoadedContactListInfos();
		return contactLists.filter((contactList) => contactList.name.toLowerCase().includes(query));
	}
	async loadContactFromId(contactId) {
		if (!this.loginController.isFullyLoggedIn()) throw new LoginIncompleteError("cannot search for contact lists as online login is not completed");
		return await this.entityClient.load(ContactTypeRef, contactId);
	}
	async getContactGroupId() {
		return getFirstOrThrow(this.loginController.getUserController().getContactGroupMemberships()).group;
	}
	async loadContactLists() {
		const userController = this.loginController.getUserController();
		const contactListMemberships = userController.getContactListMemberships();
		const contactListInfo = (await pMap(
			await pMap(contactListMemberships, (rlm) => this.entityClient.load(GroupInfoTypeRef, rlm.groupInfo)),
			// need to catch both NotFoundError and NotAuthorizedError, as we might still have a membership for a short time
			// when the group root is already deleted, or we deleted our membership
			(groupInfo) => this.getContactListInfo(groupInfo).catch(ofClass(NotFoundError, () => null)).catch(ofClass(NotAuthorizedError, () => null))
)).filter(isNotNull);
		this.contactListInfo(contactListInfo);
	}
	async getContactListInfo(groupInfo) {
		const group = await this.entityClient.load(GroupTypeRef, groupInfo.group);
		const groupRoot = await this.entityClient.load(ContactListGroupRootTypeRef, groupInfo.group);
		const userController = this.loginController.getUserController();
		const { getSharedGroupName } = await import("./GroupUtils-DLrPrZdB.js");
		const { hasCapabilityOnGroup, isSharedGroupOwner } = await import("./GroupUtils-DLrPrZdB.js");
		return {
			name: getSharedGroupName(groupInfo, userController, true),
			group,
			groupInfo,
			groupRoot,
			isOwner: isSharedGroupOwner(group, getEtId(userController.user)),
			canEdit: hasCapabilityOnGroup(userController.user, group, ShareCapability.Write)
		};
	}
	entityEventsReceived = async (updates, eventOwnerGroupId) => {
		for (const update of updates) if (this.loginController.getUserController().isUpdateForLoggedInUserInstance(update, eventOwnerGroupId)) await this.loadContactLists();
	};
};
function lazyContactListId(logins, entityClient) {
	return new LazyLoaded(() => {
		return entityClient.loadRoot(ContactListTypeRef, logins.getUserController().user.userGroup.group).then((contactList) => {
			return contactList.contacts;
		}).catch(ofClass(NotFoundError, (e) => {
			if (!logins.getUserController().isInternalUser()) return null;
else throw e;
		}));
	});
}

//#endregion
export { ContactModel };
//# sourceMappingURL=ContactModel-toSAU5Gg.js.map