{"version":3,"file":"RecoverCodeDialog-nRHUDXK5.js","names":["vnode: Vnode<RecoverCodeFieldAttrs>"],"sources":["../../src/common/settings/login/RecoverCodeDialog.ts"],"sourcesContent":["import { InfoLink, lang, TranslationKey } from \"../../misc/LanguageViewModel.js\"\nimport { Dialog, DialogType } from \"../../gui/base/Dialog.js\"\nimport { assertNotNull, Hex, noOp, ofClass } from \"@tutao/tutanota-utils\"\nimport m, { Child, Children, Vnode } from \"mithril\"\nimport { assertMainOrNode, isApp } from \"../../api/common/Env.js\"\nimport { copyToClipboard } from \"../../misc/ClipboardUtils.js\"\nimport { AccessBlockedError, NotAuthenticatedError } from \"../../api/common/error/RestError.js\"\nimport { locator } from \"../../api/main/CommonLocator.js\"\nimport { Icons } from \"../../gui/base/icons/Icons.js\"\nimport { User } from \"../../api/entities/sys/TypeRefs.js\"\nimport { getEtId, isSameId } from \"../../api/common/utils/EntityUtils.js\"\nimport { GroupType } from \"../../api/common/TutanotaConstants.js\"\nimport { IconButton } from \"../../gui/base/IconButton.js\"\nimport { MoreInfoLink } from \"../../misc/news/MoreInfoLink.js\"\nimport { showRequestPasswordDialog } from \"../../misc/passwords/PasswordRequestDialog.js\"\n\ntype Action = \"get\" | \"create\"\nassertMainOrNode()\n\nexport function showRecoverCodeDialogAfterPasswordVerificationAndInfoDialog(user: User) {\n\t// We only show the recovery code if it is for the current user and it is a global admin\n\tif (!isSameId(getEtId(locator.logins.getUserController().user), getEtId(user)) || !user.memberships.some((gm) => gm.groupType === GroupType.Admin)) {\n\t\treturn\n\t}\n\n\tconst isRecoverCodeAvailable = user.auth && user.auth.recoverCode != null\n\tDialog.showActionDialog({\n\t\ttitle: \"recoveryCode_label\",\n\t\ttype: DialogType.EditMedium,\n\t\tchild: () => m(\".pt\", lang.get(\"recoveryCode_msg\")),\n\t\tallowOkWithReturn: true,\n\t\tokAction: (dialog: Dialog) => {\n\t\t\tdialog.close()\n\t\t\tshowRecoverCodeDialogAfterPasswordVerification(isRecoverCodeAvailable ? \"get\" : \"create\", false)\n\t\t},\n\t\tokActionTextId: isRecoverCodeAvailable ? \"show_action\" : \"setUp_action\",\n\t})\n}\n\nexport function showRecoverCodeDialogAfterPasswordVerification(action: Action, showMessage: boolean = true) {\n\tconst recoverCodeFacade = locator.recoverCodeFacade\n\tconst dialog = showRequestPasswordDialog({\n\t\taction: (pw) => {\n\t\t\treturn (action === \"get\" ? recoverCodeFacade.getRecoverCodeHex(pw) : recoverCodeFacade.createRecoveryCode(pw))\n\t\t\t\t.then((recoverCode) => {\n\t\t\t\t\tdialog.close()\n\t\t\t\t\tshowRecoverCodeDialog(recoverCode, showMessage)\n\t\t\t\t\treturn \"\"\n\t\t\t\t})\n\t\t\t\t.catch(ofClass(NotAuthenticatedError, () => lang.get(\"invalidPassword_msg\")))\n\t\t\t\t.catch(ofClass(AccessBlockedError, () => lang.get(\"tooManyAttempts_msg\")))\n\t\t},\n\t\tcancel: {\n\t\t\ttextId: \"cancel_action\",\n\t\t\taction: noOp,\n\t\t},\n\t})\n}\n\nexport function showRecoverCodeDialog(recoverCode: Hex, showMessage: boolean): Promise<void> {\n\treturn new Promise((resolve) => {\n\t\tDialog.showActionDialog({\n\t\t\ttitle: \"recoveryCode_label\",\n\t\t\tchild: {\n\t\t\t\tview: () => {\n\t\t\t\t\treturn m(RecoverCodeField, {\n\t\t\t\t\t\tshowMessage,\n\t\t\t\t\t\trecoverCode,\n\t\t\t\t\t})\n\t\t\t\t},\n\t\t\t},\n\t\t\tallowCancel: false,\n\t\t\tallowOkWithReturn: true,\n\t\t\tokAction: (dialog: Dialog) => {\n\t\t\t\tdialog.close()\n\t\t\t\tresolve()\n\t\t\t},\n\t\t\ttype: DialogType.EditMedium,\n\t\t})\n\t})\n}\n\nexport type RecoverCodeFieldAttrs = {\n\tshowMessage: boolean\n\trecoverCode: Hex\n\tshowButtons?: boolean\n\timage?: {\n\t\tsrc: string\n\t\talt: TranslationKey\n\t}\n}\n\nexport class RecoverCodeField {\n\tview(vnode: Vnode<RecoverCodeFieldAttrs>): Children {\n\t\tlet { recoverCode, showButtons, showMessage, image } = vnode.attrs\n\t\tshowButtons = showButtons ?? true\n\n\t\tconst splitRecoverCode = assertNotNull(recoverCode.match(/.{4}/g)).join(\" \")\n\t\treturn [\n\t\t\tshowMessage\n\t\t\t\t? image\n\t\t\t\t\t? m(\".flex-space-around.flex-wrap\", [\n\t\t\t\t\t\t\tm(\".flex-grow-shrink-half.plr-l.flex-center.align-self-center\", this.renderRecoveryText()),\n\t\t\t\t\t\t\tm(\n\t\t\t\t\t\t\t\t\".flex-grow-shrink-half.plr-l.flex-center.align-self-center\",\n\t\t\t\t\t\t\t\tm(\"img.pt.bg-white.pt.pb\", {\n\t\t\t\t\t\t\t\t\tsrc: image.src,\n\t\t\t\t\t\t\t\t\talt: lang.getTranslationText(image.alt),\n\t\t\t\t\t\t\t\t\tstyle: {\n\t\t\t\t\t\t\t\t\t\twidth: \"200px\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\t),\n\t\t\t\t\t  ])\n\t\t\t\t\t: this.renderRecoveryText()\n\t\t\t\t: m(\"\", lang.get(\"emptyString_msg\")),\n\t\t\tm(\".text-break.monospace.selectable.flex.flex-wrap.border.pt.pb.plr\", splitRecoverCode),\n\t\t\tshowButtons\n\t\t\t\t? m(\".flex.flex-end.mt-m\", [\n\t\t\t\t\t\tm(IconButton, {\n\t\t\t\t\t\t\ttitle: \"copy_action\",\n\t\t\t\t\t\t\ticon: Icons.Clipboard,\n\t\t\t\t\t\t\tclick: () => copyToClipboard(splitRecoverCode),\n\t\t\t\t\t\t}),\n\t\t\t\t\t\tisApp() || typeof window.print !== \"function\"\n\t\t\t\t\t\t\t? null\n\t\t\t\t\t\t\t: m(IconButton, {\n\t\t\t\t\t\t\t\t\ttitle: \"print_action\",\n\t\t\t\t\t\t\t\t\ticon: Icons.Print,\n\t\t\t\t\t\t\t\t\tclick: () => window.print(),\n\t\t\t\t\t\t\t  }),\n\t\t\t\t  ])\n\t\t\t\t: null,\n\t\t]\n\t}\n\n\tprivate renderRecoveryText(): Child {\n\t\tconst link = InfoLink.RecoverCode\n\t\treturn m(\".pt.pb\", [lang.get(\"recoveryCode_msg\"), m(\"\", [m(MoreInfoLink, { link, isSmall: true })])])\n\t}\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAiBA,kBAAkB;IA2EL,mBAAN,MAAuB;CAC7B,KAAKA,OAA+C;EACnD,IAAI,EAAE,aAAa,aAAa,aAAa,OAAO,GAAG,MAAM;AAC7D,gBAAc,eAAe;EAE7B,MAAM,mBAAmB,cAAc,YAAY,MAAM,QAAQ,CAAC,CAAC,KAAK,IAAI;AAC5E,SAAO;GACN,cACG,QACC,gBAAE,gCAAgC,CAClC,gBAAE,8DAA8D,KAAK,oBAAoB,CAAC,EAC1F,gBACC,8DACA,gBAAE,yBAAyB;IAC1B,KAAK,MAAM;IACX,KAAK,KAAK,mBAAmB,MAAM,IAAI;IACvC,OAAO,EACN,OAAO,QACP;GACD,EAAC,CACF,AACA,EAAC,GACF,KAAK,oBAAoB,GAC1B,gBAAE,IAAI,KAAK,IAAI,kBAAkB,CAAC;GACrC,gBAAE,oEAAoE,iBAAiB;GACvF,cACG,gBAAE,uBAAuB,CACzB,gBAAE,YAAY;IACb,OAAO;IACP,MAAM,MAAM;IACZ,OAAO,MAAM,gBAAgB,iBAAiB;GAC9C,EAAC,EACF,OAAO,WAAW,OAAO,UAAU,aAChC,OACA,gBAAE,YAAY;IACd,OAAO;IACP,MAAM,MAAM;IACZ,OAAO,MAAM,OAAO,OAAO;GAC1B,EAAC,AACJ,EAAC,GACF;EACH;CACD;CAED,AAAQ,qBAA4B;EACnC,MAAM,OAAO,SAAS;AACtB,SAAO,gBAAE,UAAU,CAAC,KAAK,IAAI,mBAAmB,EAAE,gBAAE,IAAI,CAAC,gBAAE,cAAc;GAAE;GAAM,SAAS;EAAM,EAAC,AAAC,EAAC,AAAC,EAAC;CACrG;AACD"}