
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { __toESM } from "./chunk-D_5_n1c4.js";
import "./mithril-Csg4iNnm.js";
import { arrayEquals, debounce, lazyMemoized, memoized } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import "./Env-D5xGlXfw.js";
import "./WhitelabelCustomizations-D1L5qbZi.js";
import "./LanguageViewModel-BNC5ekpO.js";
import "./HtmlUtils-C-ecR7U7.js";
import "./ClientDetector-D0v6Vqu6.js";
import "./TutanotaConstants-3bwAESYA.js";
import "./Icon-BuqNK7vz.js";
import "./KeyManager-B0OGXEyJ.js";
import "./WindowFacade-B9kSBKw7.js";
import "./RestError-D17JEBMr.js";
import "./SuspensionError-okvIjE4H.js";
import "./LoginIncompleteError-CpiW0a0l.js";
import "./CryptoError-PqdvQky4.js";
import "./error-DDmy0eAT.js";
import "./ErrorUtils-o1-v67Dd.js";
import "./RecipientsNotFoundError-D8oGE7A_.js";
import "./OfflineDbClosedError-CAwHTI6J.js";
import "./OutOfSyncError-Ck2yBBO8.js";
import "./DbError-CcwZaPG2.js";
import "./QuotaExceededError-nFM6SdTn.js";
import "./CancelledError-FjP5S_cR.js";
import "./FileOpenError-C1_8yoXr.js";
import "./DeviceStorageUnavailableError-m4Jk_0xN.js";
import "./MailBodyTooLargeError-C2i0rX_0.js";
import "./ImportError-CIXw37Kv.js";
import "./PermissionError-BGDsHuAh.js";
import "./KeyPermanentlyInvalidatedError-DJjt81rl.js";
import "./ParserCombinator-D38ofgFx.js";
import "./ExportError-DzgStBnl.js";
import { require_stream } from "./stream-u2PttBAC.js";
import "./luxon-D6cgmg6Q.js";
import { getEtId, isSameId } from "./EntityUtils-RQxXZlcV.js";
import "./CommonCalendarUtils-DKaO7v1K.js";
import "./TypeModels-XIXYys8J.js";
import { ContactListEntryTypeRef, ContactListGroupRootTypeRef, ContactTypeRef, createContactListEntry } from "./TypeRefs-CR3TLWn0.js";
import "./TypeModels-BktRFNDN.js";
import "./TypeRefs-BP1jvX9p.js";
import "./CalendarUtils-C6jeYrj9.js";
import { isUpdateForTypeRef } from "./EntityUpdateUtils-B5iTKMk4.js";
import { locator$1 as locator } from "./CommonLocator-Csg4iNnm.js";
import "./ImportExportUtils-B1MoOmZ0.js";
import "./FormatValidator-2BBermUe.js";
import { ListAutoSelectBehavior } from "./DeviceConfig-payZM407.js";
import "./List-CdKNFQkI.js";
import "./ListModel-jYF3dysm.js";
import { ListElementListModel } from "./ListElementListModel-DYHUNydL.js";

//#region ../src/mail-app/contacts/view/ContactListViewModel.ts
var import_stream = __toESM(require_stream(), 1);
var ContactListViewModel = class {
	selectedContactList = null;
	contactsForSelectedEntry = [];
	listModelStateStream = null;
	sortedContactListInfos = (0, import_stream.default)([]);
	sortedSharedContactListInfos = (0, import_stream.default)([]);
	constructor(entityClient, groupManagementFacade, loginController, eventController, contactModel, contactListInvitations, router, updateUi) {
		this.entityClient = entityClient;
		this.groupManagementFacade = groupManagementFacade;
		this.loginController = loginController;
		this.eventController = eventController;
		this.contactModel = contactModel;
		this.contactListInvitations = contactListInvitations;
		this.router = router;
		this.updateUi = updateUi;
	}
	async showListAndEntry(listId, entryId) {
		this.selectedContactList = listId ?? null;
		await this.init();
		if (this.selectedContactList === listId && !this.getContactListInfoForEntryListId(listId)) this.selectedContactList = null;
		await this.listModel?.loadInitial();
		if (listId && entryId) this.loadAndSelect(listId, entryId);
	}
	init = lazyMemoized(async () => {
		this.eventController.addEntityListener(this.entityEventsReceived);
		this.sortedContactListInfos = this.contactModel.getOwnContactListInfos().map((infos) => {
			this.updateUi();
			return infos.slice().sort((a, b) => a.name.localeCompare(b.name));
		});
		this.sortedSharedContactListInfos = this.contactModel.getSharedContactListInfos().map((infos) => {
			this.updateUi();
			return infos.slice().sort((a, b) => a.name.localeCompare(b.name));
		});
		this.contactListInvitations.init();
		this.contactListInvitations.invitations.map(this.updateUi);
		await this.contactModel.getLoadedContactListInfos();
	});
	get listModel() {
		return this.selectedContactList ? this._listModel(this.selectedContactList) : null;
	}
	_listModel = memoized((listId) => {
		const newListModel = new ListElementListModel({
			fetch: async () => {
				const items = await this.getRecipientsForList(listId);
				return {
					items,
					complete: true
				};
			},
			loadSingle: async (_listId, elementId) => {
				return this.entityClient.load(ContactListEntryTypeRef, [listId, elementId]);
			},
			sortCompare: (rl1, rl2) => rl1.emailAddress.localeCompare(rl2.emailAddress),
			autoSelectBehavior: () => ListAutoSelectBehavior.OLDER
		});
		this.listModelStateStream?.end(true);
		this.listModelStateStream = newListModel.stateStream.map(() => {
			this.contactsForSelectedEntry = [];
			this.updateUi();
			this.updateUrl();
			this.getContactsForSelectedContactListEntry();
		});
		return newListModel;
	});
	async loadAndSelect(listId, contactListEntryId) {
		await this.listModel?.loadAndSelect(contactListEntryId, () => this.selectedContactList !== listId);
	}
	getContactListId() {
		return this.contactModel.getContactListId();
	}
	getOwnContactListInfos() {
		return this.sortedContactListInfos() ?? [];
	}
	getSharedContactListInfos() {
		return this.sortedSharedContactListInfos() ?? [];
	}
	getContactListInvitations() {
		return this.contactListInvitations.invitations();
	}
	getContactsForSelectedContactListEntry = debounce(50, async () => {
		const selected = this.getSelectedContactListEntries();
		if (selected?.length === 1) {
			const searchedContacts = await this.contactModel.searchForContacts(selected[0].emailAddress, "mailAddress", 10);
			const contacts = searchedContacts.filter((contact) => contact.mailAddresses.map((mailAddress) => mailAddress.address).includes(selected[0].emailAddress));
			const nowSelected = this.getSelectedContactListEntries() ?? [];
			if (arrayEquals(selected, nowSelected)) this.contactsForSelectedEntry = contacts;
		} else return [];
		this.updateUi();
	});
	updateUrl() {
		if (!this.listModel?.state.inMultiselect) {
			const recipient = this.getSelectedContactListEntries();
			if (recipient && recipient.length === 1) {
				this.router.routeTo(`/contactlist/:listId/:itemId`, {
					listId: this.selectedContactList,
					itemId: recipient[0]._id[1]
				});
				return;
			}
		}
		if (this.selectedContactList) this.router.routeTo(`/contactlist/:listId`, { listId: this.selectedContactList });
else this.router.routeTo(`/contactlist`, {});
	}
	async canCreateContactList() {
		const planConfig = await this.loginController.getUserController().getPlanConfig();
		return planConfig.contactList;
	}
	async addContactList(name, recipients) {
		const newGroup = await this.groupManagementFacade.createContactListGroup(name);
		const newContactList = await this.entityClient.load(ContactListGroupRootTypeRef, newGroup._id);
		this.addRecipientstoContactList(recipients, newContactList);
	}
	async addRecipientstoContactList(addresses, contactListGroupRoot) {
		const currentRecipients = await this.getRecipientsForList(contactListGroupRoot.entries);
		const listAddresses = currentRecipients.map((entry) => entry.emailAddress);
		for (const address of addresses) if (!listAddresses.includes(address)) {
			const recipient = createContactListEntry({
				_ownerGroup: contactListGroupRoot._id,
				emailAddress: address
			});
			this.addEntryOnList(contactListGroupRoot.entries, recipient);
		}
	}
	addEntryOnList(recipientsId, recipient) {
		this.entityClient.setup(recipientsId, recipient);
	}
	entityEventsReceived = async (updates) => {
		for (const update of updates) {
			if (this.selectedContactList) {
				const { instanceListId, instanceId, operation } = update;
				if (isUpdateForTypeRef(ContactListEntryTypeRef, update) && isSameId(this.selectedContactList, instanceListId)) await this.listModel?.entityEventReceived(instanceListId, instanceId, operation);
else if (isUpdateForTypeRef(ContactTypeRef, update)) this.getContactsForSelectedContactListEntry();
			}
			this.updateUi();
		}
	};
	updateSelectedContactList(selected) {
		this.selectedContactList = selected;
		this.listModel?.loadInitial();
	}
	updateContactList(contactListInfo, name, addresses) {
		contactListInfo.name = name;
		contactListInfo.groupInfo.name = name;
		this.entityClient.update(contactListInfo.groupInfo);
	}
	getSelectedContactListInfo() {
		return this.selectedContactList ? this.getContactListInfoForEntryListId(this.selectedContactList) : null;
	}
	getSelectedContactListEntries() {
		return this.listModel?.getSelectedAsArray();
	}
	async getRecipientsForList(listId) {
		return await this.entityClient.loadAll(ContactListEntryTypeRef, listId);
	}
	deleteContactList(contactList) {
		this.groupManagementFacade.deleteContactListGroup(contactList.groupRoot);
	}
	async deleteContactListEntries(recipients) {
		for (const recipient of recipients) await this.entityClient.erase(recipient);
	}
	removeUserFromContactList(contactList) {
		return locator.groupManagementFacade.removeUserFromGroup(getEtId(this.loginController.getUserController().user), contactList.groupInfo.group);
	}
	async deleteSelectedEntries() {
		await this.deleteContactListEntries(this.getSelectedContactListEntries() ?? []);
	}
	getContactListInfoForEntryListId(listId) {
		return this.getOwnContactListInfos().find((contactList) => contactList.groupRoot.entries === listId) ?? this.getSharedContactListInfos().find((contactList) => contactList.groupRoot.entries === listId) ?? null;
	}
	dispose() {
		this.eventController.removeEntityListener(this.entityEventsReceived);
		this.sortedContactListInfos.end(true);
		this.sortedSharedContactListInfos.end(true);
		this.contactListInvitations.dispose();
	}
};

//#endregion
export { ContactListViewModel };
//# sourceMappingURL=ContactListViewModel-DP1b6VfQ.js.map