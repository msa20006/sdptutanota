
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import "./Env-D5xGlXfw.js";
import { isMailAddress } from "./FormatValidator-2BBermUe.js";
import { log } from "./DesktopLog-yAgEoQsh.js";
import { dist_default } from "./dist-Ci1bEzYU.js";
import "./testdouble-IbRSnrC0.js";
import { makeTimeoutMock, spy } from "./dist-BY49f75m.js";
import { nodemocker_default } from "./nodemocker-Bh_RUICG.js";

//#region ../src/common/desktop/Socketeer.ts
const SOCKET_PATH = "/tmp/tutadb.sock";
var Socketeer = class {
	_server = null;
	_connection = null;
	_delayHandler;
	_net;
	constructor(net, app, delayHandler = setTimeout) {
		this._net = net;
		this._delayHandler = delayHandler;
		app.on("will-quit", () => {
			if (this._server || this._connection) {
				if (this._connection) this._connection.end();
				if (this._server) this._server.close();
			}
		});
	}
	attach(wm) {
		this.startClient(async (msg) => {
			const mailAddress = JSON.parse(msg);
			if (typeof mailAddress === "string" && isMailAddress(mailAddress, false)) {
				const targetWindow = await wm.getLastFocused(false);
				targetWindow.desktopFacade.openCustomer(mailAddress);
			}
		});
	}
	startServer() {
		log.debug("opening admin socket");
		if (this._server) return;
		const server = this._server = this._net.createServer((c) => {
			log.debug("got connection");
			this._connection = c;
			c.on("data", () => {
				console.warn("Data was pushed through admin socket, aborting connection");
				c.destroy();
			}).on("end", () => {
				this._connection = null;
			});
		}).on("listening", () => {
			log.debug("Socketeer: server is listening");
		}).on("error", (e) => {
			log.warn("Socketeer: server error", e);
			if (e.code === "EADDRINUSE") this._delayHandler(() => {
				try {
					server.close();
					server.listen(SOCKET_PATH);
				} catch (e$1) {
					log.error("Socketeer: restart error: ", e$1);
				}
			}, 1e3);
		}).on("close", () => {
			log.debug("Socketeer: server is closed");
			this._server = null;
		});
		this._server.listen(SOCKET_PATH);
	}
	sendSocketMessage(msg) {
		if (this._connection) this._connection.write(JSON.stringify(msg), "utf8");
	}
	startClient(ondata) {
		if (this._connection) return;
		this._connection = this._net.createConnection(SOCKET_PATH).on("connect", () => {
			log.debug("socket connected");
		}).on("close", (hadError) => {
			if (hadError) this._tryReconnect(ondata);
		}).on("end", () => {
			log.debug("socket disconnected");
			this._tryReconnect(ondata);
		}).on("error", (e) => {
			if (e.code !== "ENOENT") console.error("Unexpected Socket Error:", e);
		}).on("data", ondata);
	}
	_tryReconnect(ondata) {
		this._connection = null;
		this._delayHandler(() => {
			this.startClient(ondata);
		}, 1e3);
	}
};

//#endregion
//#region tests/desktop/SocketeerTest.ts
dist_default.spec("Socketeer Test", function() {
	const electron = { app: {
		callbacks: {},
		on: function(ev, cb) {
			this.callbacks[ev] = cb;
			return nodemocker_default.spyify(electron.app);
		},
		dock: {
			show: () => {},
			setMenu: () => {},
			isVisible: () => false
		}
	} };
	let serverMock;
	let connectionMock;
	const standardMocks = () => {
		const net = {
			createServer: (connectionHandler) => {
				serverMock.connectionHandler = connectionHandler;
				return serverMock;
			},
			createConnection: () => connectionMock
		};
		serverMock = nodemocker_default.mock("__server", {
			connectionHandler: (connection) => {},
			callbacks: {},
			on: function(ev, cb) {
				this.callbacks[ev] = cb;
				return serverMock;
			},
			listen: () => {},
			close: () => {}
		}).set();
		connectionMock = nodemocker_default.mock("__connection", {
			callbacks: {},
			on: function(ev, cb) {
				this.callbacks[ev] = cb;
				return connectionMock;
			},
			write: () => {},
			end: () => {}
		}).set();
		return {
			netMock: nodemocker_default.mock("net", net).set(),
			electronMock: nodemocker_default.mock("electron", electron).set(),
			timeoutMock: makeTimeoutMock()
		};
	};
	dist_default("startServer & cleanup", function() {
		const { electronMock, netMock } = standardMocks();
		const sock = new Socketeer(netMock, electronMock.app);
		dist_default(electronMock.app.on.callCount).equals(1);
		dist_default(electronMock.app.on.args[0]).equals("will-quit");
		dist_default(electronMock.app.on.args.length).equals(2);
		sock.startServer();
		sock.startServer();
		dist_default(serverMock.callbacks["error"]).notEquals(undefined);
		dist_default(serverMock.callbacks["close"]).notEquals(undefined);
		dist_default(netMock.createServer.callCount).equals(1);
		dist_default(netMock.createConnection.callCount).equals(0);
		serverMock.connectionHandler(connectionMock);
		dist_default(connectionMock.callbacks["data"]).notEquals(undefined);
		dist_default(connectionMock.callbacks["end"]).notEquals(undefined);
		sock.sendSocketMessage({
			some: "data",
			to: "send"
		});
		dist_default(connectionMock.write.callCount).equals(1);
		dist_default(connectionMock.write.args[0]).equals("{\"some\":\"data\",\"to\":\"send\"}");
		dist_default(connectionMock.write.args[1]).equals("utf8");
		dist_default(connectionMock.write.args.length).equals(2);
		electronMock.app.callbacks["will-quit"]();
		dist_default(serverMock.listen.callCount).equals(1);
		dist_default(serverMock.listen.args[0]).equals("/tmp/tutadb.sock");
		dist_default(serverMock.listen.args.length).equals(1);
		dist_default(serverMock.close.callCount).equals(1);
		dist_default(serverMock.close.args.length).equals(0);
	});
	dist_default("startClient & cleanup", function() {
		const { electronMock, netMock } = standardMocks();
		const sock = new Socketeer(netMock, electronMock.app);
		const ondata = spy(() => {});
		const ondata2 = spy(() => {});
		sock.startClient(ondata);
		sock.startClient(ondata2);
		dist_default(netMock.createConnection.callCount).equals(1);
		dist_default(connectionMock.on.callCount).equals(5);
		dist_default(typeof connectionMock.callbacks["connect"]).equals("function");
		dist_default(typeof connectionMock.callbacks["error"]).equals("function");
		connectionMock.callbacks["data"]("somedata");
		dist_default(ondata.callCount).equals(1);
		dist_default(ondata.args[0]).equals("somedata");
		dist_default(ondata.args.length).equals(1);
		dist_default(ondata2.callCount).equals(0);
		electronMock.app.callbacks["will-quit"]();
		dist_default(netMock.createServer.callCount).equals(0);
		dist_default(netMock.createConnection.callCount).equals(1);
	});
	dist_default("reconnect on end", async function() {
		const { electronMock, netMock, timeoutMock } = standardMocks();
		const sock = new Socketeer(netMock, electronMock.app, timeoutMock);
		const ondata = spy(() => {});
		sock.startClient(ondata);
		connectionMock.callbacks["end"]();
		timeoutMock.next();
		await Promise.resolve();
		dist_default(connectionMock.on.callCount).equals(10);
		electronMock.app.callbacks["will-quit"]();
		dist_default(netMock.createServer.callCount).equals(0);
		dist_default(netMock.createConnection.callCount).equals(2);
	});
	dist_default("reconnect on close with error", async function() {
		const { electronMock, netMock, timeoutMock } = standardMocks();
		const sock = new Socketeer(netMock, electronMock.app, timeoutMock);
		const ondata = spy(() => {});
		sock.startClient(ondata);
		connectionMock.callbacks["close"](true);
		timeoutMock.next();
		await Promise.resolve();
		dist_default(connectionMock.on.callCount).equals(10);
		electronMock.app.callbacks["will-quit"]();
		dist_default(netMock.createServer.callCount).equals(0);
		dist_default(netMock.createConnection.callCount).equals(2);
	});
	dist_default("don't reconnect on close without error", async function() {
		const { electronMock, netMock, timeoutMock } = standardMocks();
		const sock = new Socketeer(netMock, electronMock.app, timeoutMock);
		const ondata = spy(() => {});
		sock.startClient(ondata);
		connectionMock.callbacks["close"](false);
		timeoutMock.next();
		await Promise.resolve();
		dist_default(connectionMock.on.callCount).equals(5);
		electronMock.app.callbacks["will-quit"]();
		dist_default(netMock.createServer.callCount).equals(0);
		dist_default(netMock.createConnection.callCount).equals(1);
	});
	dist_default("sendSocketMessage calls write", function() {
		const { electronMock, netMock } = standardMocks();
		const sock = new Socketeer(netMock, electronMock.app);
		const ondata = spy(() => {});
		sock.startClient(ondata);
		sock.sendSocketMessage({
			some: [
				"a",
				"b",
				"c"
			],
			stuff: 1337
		});
		dist_default(connectionMock.write.callCount).equals(1);
		dist_default(connectionMock.write.args[0]).equals("{\"some\":[\"a\",\"b\",\"c\"],\"stuff\":1337}");
		dist_default(connectionMock.write.args[1]).equals("utf8");
		dist_default(connectionMock.write.args.length).equals(2);
		electronMock.app.callbacks["will-quit"]();
	});
});

//#endregion
//# sourceMappingURL=SocketeerTest-Caj2tpg7.js.map