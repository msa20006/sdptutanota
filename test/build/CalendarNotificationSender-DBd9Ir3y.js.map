{"version":3,"file":"CalendarNotificationSender-DBd9Ir3y.js","names":["event: CalendarEvent","sendMailModel: SendMailModel","organizer: EncryptedMailAddress","a: CalendarEventAttendee","label: string","content: string","attendee: CalendarEventAttendee","sender: string","message: string","calendarNotificationSender: CalendarNotificationSender"],"sources":["../../src/calendar-app/calendar/view/CalendarNotificationSender.ts"],"sourcesContent":["import { lang } from \"../../../common/misc/LanguageViewModel.js\"\nimport { makeInvitationCalendarFile } from \"../export/CalendarExporter.js\"\nimport { getAttendeeStatus, MailMethod, mailMethodToCalendarMethod } from \"../../../common/api/common/TutanotaConstants.js\"\nimport { getTimeZone } from \"../../../common/calendar/date/CalendarUtils.js\"\nimport type { CalendarEvent, CalendarEventAttendee, EncryptedMailAddress } from \"../../../common/api/entities/tutanota/TypeRefs.js\"\nimport { createCalendarEventAttendee } from \"../../../common/api/entities/tutanota/TypeRefs.js\"\nimport { assertNotNull, noOp, ofClass } from \"@tutao/tutanota-utils\"\nimport type { SendMailModel } from \"../../../common/mailFunctionality/SendMailModel.js\"\nimport { windowFacade } from \"../../../common/misc/WindowFacade.js\"\nimport { RecipientsNotFoundError } from \"../../../common/api/common/error/RecipientsNotFoundError.js\"\nimport { cleanMailAddress, findAttendeeInAddresses, findRecipientWithAddress } from \"../../../common/api/common/utils/CommonCalendarUtils.js\"\nimport { ProgrammingError } from \"../../../common/api/common/error/ProgrammingError.js\"\n\nimport { calendarAttendeeStatusSymbol, formatEventDuration } from \"../gui/CalendarGuiUtils.js\"\nimport { RecipientField } from \"../../../common/mailFunctionality/SharedMailUtils.js\"\n\nexport class CalendarNotificationSender {\n\t/** Used for knowing how many emails are in the process of being sent. */\n\tprivate countDownLatch: number\n\n\tconstructor() {\n\t\tthis.countDownLatch = 0\n\t}\n\n\tsendInvite(event: CalendarEvent, sendMailModel: SendMailModel): Promise<void> {\n\t\tconst message = lang.get(\"eventInviteMail_msg\", {\n\t\t\t\"{event}\": event.summary,\n\t\t})\n\t\tconst sender = assertOrganizer(event).address\n\t\treturn this.sendCalendarFile({\n\t\t\tsendMailModel,\n\t\t\tmethod: MailMethod.ICAL_REQUEST,\n\t\t\tsubject: message,\n\t\t\tbody: makeInviteEmailBody(sender, event, message),\n\t\t\tevent,\n\t\t\tsender,\n\t\t})\n\t}\n\n\tsendUpdate(event: CalendarEvent, sendMailModel: SendMailModel): Promise<void> {\n\t\tconst message = lang.get(\"eventUpdated_msg\", {\n\t\t\t\"{event}\": event.summary,\n\t\t})\n\t\tconst sender = assertOrganizer(event).address\n\t\treturn this.sendCalendarFile({\n\t\t\tsendMailModel,\n\t\t\tmethod: MailMethod.ICAL_REQUEST,\n\t\t\tsubject: message,\n\t\t\tbody: makeInviteEmailBody(sender, event, message),\n\t\t\tevent,\n\t\t\tsender,\n\t\t})\n\t}\n\n\tsendCancellation(event: CalendarEvent, sendMailModel: SendMailModel): Promise<void> {\n\t\tconst message = lang.get(\"eventCancelled_msg\", {\n\t\t\t\"{event}\": event.summary,\n\t\t})\n\t\tconst sender = assertOrganizer(event).address\n\t\treturn this.sendCalendarFile({\n\t\t\tsendMailModel,\n\t\t\tmethod: MailMethod.ICAL_CANCEL,\n\t\t\tsubject: message,\n\t\t\tbody: makeInviteEmailBody(sender, event, message),\n\t\t\tevent,\n\t\t\tsender,\n\t\t}).catch(\n\t\t\tofClass(RecipientsNotFoundError, (e) => {\n\t\t\t\t// we want to delete the event even if the recipient is not an existing tutanota address\n\t\t\t\t// and just exclude them from sending out updates but leave the event untouched for other recipients\n\t\t\t\tconst invalidRecipients = e.message.split(\"\\n\")\n\t\t\t\tlet hasRemovedRecipient = false\n\t\t\t\tfor (const invalidRecipient of invalidRecipients) {\n\t\t\t\t\tconst recipientInfo = findRecipientWithAddress(sendMailModel.bccRecipients(), invalidRecipient)\n\n\t\t\t\t\tif (recipientInfo) {\n\t\t\t\t\t\thasRemovedRecipient = sendMailModel.removeRecipient(recipientInfo, RecipientField.BCC, false) || hasRemovedRecipient\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// only try sending again if we successfully removed a recipient and there are still other recipients\n\t\t\t\tif (hasRemovedRecipient && sendMailModel.allRecipients().length) {\n\t\t\t\t\treturn this.sendCancellation(event, sendMailModel)\n\t\t\t\t}\n\t\t\t}),\n\t\t)\n\t}\n\n\t/**\n\t * send a response mail to the organizer of an event\n\t * @param event the event to respond to (included as a .ics file attachment)\n\t * @param sendMailModel used to actually send the mail\n\t */\n\tasync sendResponse(event: CalendarEvent, sendMailModel: SendMailModel): Promise<void> {\n\t\tconst sendAs = sendMailModel.getSender()\n\t\tconst message = lang.get(\"repliedToEventInvite_msg\", {\n\t\t\t\"{event}\": event.summary,\n\t\t})\n\t\tconst organizer = assertOrganizer(event)\n\t\tconst body = makeInviteEmailBody(organizer.address, event, message)\n\t\treturn this.sendCalendarFile({\n\t\t\tevent,\n\t\t\tsendMailModel,\n\t\t\tmethod: MailMethod.ICAL_REPLY,\n\t\t\tsubject: message,\n\t\t\tbody: body,\n\t\t\tsender: sendAs,\n\t\t})\n\t}\n\n\tprivate async sendCalendarFile({\n\t\tsendMailModel,\n\t\tmethod,\n\t\tsubject,\n\t\tevent,\n\t\tbody,\n\t\tsender,\n\t}: {\n\t\tsendMailModel: SendMailModel\n\t\tmethod: MailMethod\n\t\tsubject: string\n\t\tevent: CalendarEvent\n\t\tbody: string\n\t\tsender: string\n\t}): Promise<void> {\n\t\tconst inviteFile = makeInvitationCalendarFile(event, mailMethodToCalendarMethod(method), new Date(), getTimeZone())\n\t\tsendMailModel.setSender(sender)\n\t\tsendMailModel.attachFiles([inviteFile])\n\t\tsendMailModel.setSubject(subject)\n\t\tsendMailModel.setBody(body)\n\n\t\tthis.sendStart()\n\n\t\tawait sendMailModel.send(method).finally(() => this.sendEnd())\n\t}\n\n\tprivate _windowUnsubscribe: (() => void) | null = null\n\n\tprivate sendStart() {\n\t\tthis.countDownLatch++\n\n\t\tif (this.countDownLatch === 1) {\n\t\t\tthis._windowUnsubscribe = windowFacade.addWindowCloseListener(noOp)\n\t\t}\n\t}\n\n\tprivate sendEnd() {\n\t\tthis.countDownLatch--\n\n\t\tif (this.countDownLatch === 0 && this._windowUnsubscribe) {\n\t\t\tthis._windowUnsubscribe()\n\n\t\t\tthis._windowUnsubscribe = null\n\t\t}\n\t}\n}\n\nfunction summaryLine(event: CalendarEvent): string {\n\treturn newLine(lang.get(\"name_label\"), event.summary)\n}\n\nfunction whenLine(event: CalendarEvent): string {\n\tconst duration = formatEventDuration(event, getTimeZone(), true)\n\treturn newLine(lang.get(\"when_label\"), duration)\n}\n\nfunction organizerLabel(organizer: EncryptedMailAddress, a: CalendarEventAttendee) {\n\treturn cleanMailAddress(organizer.address) === cleanMailAddress(a.address.address) ? `(${lang.get(\"organizer_label\")})` : \"\"\n}\n\nfunction newLine(label: string, content: string): string {\n\treturn `<div style=\"display: flex; margin-top: 8px\"><div style=\"min-width: 120px\"><b style=\"float:right; margin-right:16px\">${label}:</b></div>${content}</div>`\n}\n\nfunction attendeesLine(event: CalendarEvent): string {\n\tconst { organizer } = event\n\tlet attendees = \"\"\n\n\t// If organizer is already in the attendees, we don't have to add them separately.\n\tif (organizer && !findAttendeeInAddresses(event.attendees, [organizer.address])) {\n\t\tattendees = makeAttendee(\n\t\t\torganizer,\n\t\t\tcreateCalendarEventAttendee({\n\t\t\t\taddress: organizer,\n\t\t\t\tstatus: \"0\",\n\t\t\t}),\n\t\t)\n\t}\n\n\tattendees += event.attendees.map((a) => makeAttendee(assertNotNull(organizer), a)).join(\"\\n\")\n\treturn newLine(lang.get(\"who_label\"), `<div>${attendees}</div>`)\n}\n\nfunction makeAttendee(organizer: EncryptedMailAddress, attendee: CalendarEventAttendee): string {\n\treturn `<div>\n${attendee.address.name || \"\"} ${attendee.address.address}\n${organizerLabel(organizer, attendee)}\n${calendarAttendeeStatusSymbol(getAttendeeStatus(attendee))}</div>`\n}\n\nfunction locationLine(event: CalendarEvent): string {\n\treturn event.location ? newLine(lang.get(\"location_label\"), event.location) : \"\"\n}\n\nfunction descriptionLine(event: CalendarEvent): string {\n\treturn event.description ? newLine(lang.get(\"description_label\"), `<div>${event.description}</div>`) : \"\"\n}\n\nfunction makeInviteEmailBody(sender: string, event: CalendarEvent, message: string) {\n\treturn `\n\t<div style=\"max-width: 685px; margin: 0 auto\">\n\t  \t<h2 style=\"text-align: center\">${message}</h2>\n  \t\t<div style=\"margin: 0 auto\">\n  \t\t\t${summaryLine(event)}\n    \t\t${whenLine(event)}\n    \t\t${locationLine(event)}\n    \t\t${attendeesLine(event)}\n    \t\t${descriptionLine(event)}\n  \t\t</div>\n\t</div>`\n}\n\nfunction assertOrganizer(event: CalendarEvent): EncryptedMailAddress {\n\tif (event.organizer == null) {\n\t\tthrow new ProgrammingError(\"Cannot send event update without organizer\")\n\t}\n\n\treturn event.organizer\n}\n\nexport const calendarNotificationSender: CalendarNotificationSender = new CalendarNotificationSender()\n"],"mappings":"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"}