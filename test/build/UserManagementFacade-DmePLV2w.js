
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { freshVersioned, getFirstOrThrow, neverNull } from "./dist-CJHwsXKY.js";
import "./dist-Rk9U8Iqn.js";
import "./ProgrammingError-D8yJGVtm.js";
import { assertWorkerOrNode } from "./Env-D5xGlXfw.js";
import { AccountType, Const, CounterType, DEFAULT_KDF_TYPE, GroupType } from "./TutanotaConstants-3bwAESYA.js";
import "./CryptoError-PqdvQky4.js";
import "./EntityUtils-RQxXZlcV.js";
import "./TypeModels-XIXYys8J.js";
import { createUserAccountCreateData, createUserAccountUserData } from "./TypeRefs-CR3TLWn0.js";
import "./TypeModels-BktRFNDN.js";
import { GroupTypeRef, createMembershipAddData, createResetPasswordPostIn, createUserDataDelete } from "./TypeRefs-BP1jvX9p.js";
import { aes256RandomKey, createAuthVerifier, encryptKey, generateRandomSalt, random, uint8ArrayToKey } from "./dist-DcZ1Y4qd.js";
import { MembershipService, ResetPasswordService, SystemKeysService, UserService } from "./Services-CZFE0084.js";
import { UserAccountService } from "./Services-DCx-CeM7.js";
import { encryptBytes, encryptKeyWithVersionedKey, encryptString } from "./CryptoWrapper-BTtEczdP.js";

//#region ../src/common/api/worker/facades/lazy/UserManagementFacade.ts
assertWorkerOrNode();
var UserManagementFacade = class {
	constructor(userFacade, groupManagement, counters, entityClient, serviceExecutor, operationProgressTracker, loginFacade, pqFacade, keyLoaderFacade, recoverCodeFacade) {
		this.userFacade = userFacade;
		this.groupManagement = groupManagement;
		this.counters = counters;
		this.entityClient = entityClient;
		this.serviceExecutor = serviceExecutor;
		this.operationProgressTracker = operationProgressTracker;
		this.loginFacade = loginFacade;
		this.pqFacade = pqFacade;
		this.keyLoaderFacade = keyLoaderFacade;
		this.recoverCodeFacade = recoverCodeFacade;
	}
	async changeUserPassword(user, newPassword) {
		const userGroupKey = await this.groupManagement.getCurrentGroupKeyViaAdminEncGKey(user.userGroup.group);
		const salt = generateRandomSalt();
		const kdfType = DEFAULT_KDF_TYPE;
		const passwordKey = await this.loginFacade.deriveUserPassphraseKey({
			kdfType,
			passphrase: newPassword,
			salt
		});
		const pwEncUserGroupKey = encryptKey(passwordKey, userGroupKey.object);
		const passwordVerifier = createAuthVerifier(passwordKey);
		const data = createResetPasswordPostIn({
			user: user._id,
			salt,
			verifier: passwordVerifier,
			pwEncUserGroupKey,
			kdfVersion: kdfType,
			userGroupKeyVersion: String(userGroupKey.version)
		});
		await this.serviceExecutor.post(ResetPasswordService, data);
	}
	async changeAdminFlag(user, admin) {
		const adminGroupId = this.userFacade.getGroupId(GroupType.Admin);
		const userGroup = await this.entityClient.load(GroupTypeRef, user.userGroup.group);
		const userGroupKey = await this.groupManagement.getCurrentGroupKeyViaAdminEncGKey(userGroup._id);
		if (admin) {
			await this.groupManagement.addUserToGroup(user, adminGroupId);
			if (user.accountType !== AccountType.SYSTEM) {
				const keyData = await this._getAccountKeyData();
				const userEncAccountGroupKey = encryptKeyWithVersionedKey(userGroupKey, keyData.accountGroupKey);
				const addAccountGroup = createMembershipAddData({
					user: user._id,
					group: keyData.accountGroup,
					symEncGKey: userEncAccountGroupKey.key,
					symKeyVersion: userEncAccountGroupKey.encryptingKeyVersion.toString(),
					groupKeyVersion: keyData.accountGroupKeyVersion
				});
				await this.serviceExecutor.post(MembershipService, addAccountGroup);
			}
		} else {
			await this.groupManagement.removeUserFromGroup(user._id, adminGroupId);
			if (user.accountType !== AccountType.SYSTEM) {
				const keyData = await this._getAccountKeyData();
				return this.groupManagement.removeUserFromGroup(user._id, keyData.accountGroup);
			}
		}
	}
	/**
	* Get key and id of premium group.
	* @throws Error if account type is not paid
	*
	* @private
	*/
	async _getAccountKeyData() {
		const keysReturn = await this.serviceExecutor.get(SystemKeysService, null);
		const user = this.userFacade.getLoggedInUser();
		if (user.accountType === AccountType.PAID) return {
			accountGroup: neverNull(keysReturn.premiumGroup),
			accountGroupKey: uint8ArrayToKey(keysReturn.premiumGroupKey),
			accountGroupKeyVersion: keysReturn.premiumGroupKeyVersion
		};
else throw new Error(`Trying to get keyData for user with account type ${user.accountType}`);
	}
	async readUsedUserStorage(user) {
		const counterValue = await this.counters.readCounterValue(CounterType.UserStorageLegacy, neverNull(user.customer), user.userGroup.group);
		return Number(counterValue);
	}
	async deleteUser(user, restore) {
		const data = createUserDataDelete({
			user: user._id,
			restore,
			date: Const.CURRENT_DATE
		});
		await this.serviceExecutor.delete(UserService, data);
	}
	async createUser(name, mailAddress, password, userIndex, overallNbrOfUsersToCreate, operationId) {
		let adminGroupIds = this.userFacade.getGroupIds(GroupType.Admin);
		const adminGroupId = getFirstOrThrow(adminGroupIds);
		const adminGroupKey = await this.keyLoaderFacade.getCurrentSymGroupKey(adminGroupId);
		const customerGroupKey = await this.keyLoaderFacade.getCurrentSymGroupKey(this.userFacade.getGroupId(GroupType.Customer));
		const userGroupKey = freshVersioned(aes256RandomKey());
		const userGroupInfoSessionKey = aes256RandomKey();
		const keyPair = await this.pqFacade.generateKeyPairs();
		const userGroupData = this.groupManagement.generateInternalGroupData(keyPair, userGroupKey.object, userGroupInfoSessionKey, adminGroupId, adminGroupKey, customerGroupKey);
		await this.operationProgressTracker.onProgress(operationId, (userIndex + .8) / overallNbrOfUsersToCreate * 100);
		let data = createUserAccountCreateData({
			date: Const.CURRENT_DATE,
			userGroupData,
			userData: await this.generateUserAccountData(userGroupKey, userGroupInfoSessionKey, customerGroupKey, mailAddress, password, name, this.recoverCodeFacade.generateRecoveryCode(userGroupKey))
		});
		await this.serviceExecutor.post(UserAccountService, data);
		return this.operationProgressTracker.onProgress(operationId, (userIndex + 1) / overallNbrOfUsersToCreate * 100);
	}
	async generateUserAccountData(userGroupKey, userGroupInfoSessionKey, customerGroupKey, mailAddress, passphrase, userName, recoverData) {
		const kdfType = DEFAULT_KDF_TYPE;
		const salt = generateRandomSalt();
		const userPassphraseKey = await this.loginFacade.deriveUserPassphraseKey({
			kdfType,
			passphrase,
			salt
		});
		const mailGroupKey = freshVersioned(aes256RandomKey());
		const contactGroupKey = freshVersioned(aes256RandomKey());
		const fileGroupKey = freshVersioned(aes256RandomKey());
		const mailboxSessionKey = aes256RandomKey();
		const contactListSessionKey = aes256RandomKey();
		const fileSystemSessionKey = aes256RandomKey();
		const mailGroupInfoSessionKey = aes256RandomKey();
		const contactGroupInfoSessionKey = aes256RandomKey();
		const fileGroupInfoSessionKey = aes256RandomKey();
		const tutanotaPropertiesSessionKey = aes256RandomKey();
		const userEncCustomerGroupKey = encryptKeyWithVersionedKey(userGroupKey, customerGroupKey.object);
		const userEncMailGroupKey = encryptKeyWithVersionedKey(userGroupKey, mailGroupKey.object);
		const userEncContactGroupKey = encryptKeyWithVersionedKey(userGroupKey, contactGroupKey.object);
		const userEncFileGroupKey = encryptKeyWithVersionedKey(userGroupKey, fileGroupKey.object);
		const userEncTutanotaPropertiesSessionKey = encryptKeyWithVersionedKey(userGroupKey, tutanotaPropertiesSessionKey);
		const userEncEntropy = encryptBytes(userGroupKey.object, random.generateRandomData(32));
		const customerEncMailGroupInfoSessionKey = encryptKeyWithVersionedKey(customerGroupKey, mailGroupInfoSessionKey);
		const customerEncContactGroupInfoSessionKey = encryptKeyWithVersionedKey(customerGroupKey, contactGroupInfoSessionKey);
		const customerEncFileGroupInfoSessionKey = encryptKeyWithVersionedKey(customerGroupKey, fileGroupInfoSessionKey);
		const contactEncContactListSessionKey = encryptKeyWithVersionedKey(contactGroupKey, contactListSessionKey);
		const fileEncFileSystemSessionKey = encryptKeyWithVersionedKey(fileGroupKey, fileSystemSessionKey);
		const mailEncMailBoxSessionKey = encryptKeyWithVersionedKey(mailGroupKey, mailboxSessionKey);
		return createUserAccountUserData({
			mailAddress,
			encryptedName: encryptString(userGroupInfoSessionKey, userName),
			salt,
			kdfVersion: kdfType,
			verifier: createAuthVerifier(userPassphraseKey),
			pwEncUserGroupKey: encryptKey(userPassphraseKey, userGroupKey.object),
			userEncCustomerGroupKey: userEncCustomerGroupKey.key,
			userEncMailGroupKey: userEncMailGroupKey.key,
			userEncContactGroupKey: userEncContactGroupKey.key,
			userEncFileGroupKey: userEncFileGroupKey.key,
			userEncEntropy,
			userEncTutanotaPropertiesSessionKey: userEncTutanotaPropertiesSessionKey.key,
			contactEncContactListSessionKey: contactEncContactListSessionKey.key,
			fileEncFileSystemSessionKey: fileEncFileSystemSessionKey.key,
			mailEncMailBoxSessionKey: mailEncMailBoxSessionKey.key,
			customerEncMailGroupInfoSessionKey: customerEncMailGroupInfoSessionKey.key,
			customerEncContactGroupInfoSessionKey: customerEncContactGroupInfoSessionKey.key,
			customerEncFileGroupInfoSessionKey: customerEncFileGroupInfoSessionKey.key,
			customerKeyVersion: customerEncContactGroupInfoSessionKey.encryptingKeyVersion.toString(),
			recoverCodeEncUserGroupKey: recoverData.recoverCodeEncUserGroupKey,
			recoverCodeVerifier: recoverData.recoveryCodeVerifier,
			userEncRecoverCode: recoverData.userEncRecoverCode
		});
	}
};

//#endregion
export { UserManagementFacade };
//# sourceMappingURL=UserManagementFacade-DmePLV2w.js.map