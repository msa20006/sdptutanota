{"version":3,"file":"ApplicationWindowTest-BefKG9JY.js","names":["MINIMUM_WINDOW_SIZE: number","wm: WindowManager","absoluteAssetsPath: string","icon: NativeImage","electron: typeof Electron.CrossProcessExports","localShortcut: LocalShortcutManager","themeFacade: DesktopThemeFacade","remoteBridge: RemoteBridge","noAutoLogin?: boolean | null","preloadOverridePath?: string","noAutoLogin: boolean","f: number","opts: {\n\t\t\tpreloadPath: string\n\t\t\ticon: NativeImage\n\t\t}","callback: (_: boolean) => void","_: FocusEvent","url","ev","direction: \"in\" | \"out\"","queryParams: Record<string, string | boolean>","details: HandlerDetails","parsedUrl: URL","details: Electron.HandlerDetails","info: UserInfo","path?: string | null","path","handler: (arg0: ContextMenuParams) => void","id: Id | null","searchTerm: string","forward: boolean","matchCase: boolean","findNext: boolean","resolve: (_: Result) => void","res: Result","state: boolean","force: boolean","bounds: WindowBounds","additionalQueryParams: Record<string, string | boolean>","matchers","lang","themeId: ThemeId","themes: Array<Theme>","icon: NativeImage","ev: string","cb: () => void","n: number","x: number","y: number","sendingFacades: SendingFacades","bwInstance: BrowserWindow","url","shortcuts: Array<string>","assertion: (sm: ReturnType<typeof standardMocks>) => void","e"],"sources":["../../src/common/desktop/ApplicationWindow.ts","../tests/desktop/ApplicationWindowTest.ts"],"sourcesContent":["import type { BrowserWindow, ContextMenuParams, HandlerDetails, NativeImage, Result } from \"electron\"\nimport type { WindowBounds, WindowManager } from \"./DesktopWindowManager\"\nimport url from \"node:url\"\nimport type { lazy } from \"@tutao/tutanota-utils\"\nimport { capitalizeFirstLetter, noOp, typedEntries, typedKeys } from \"@tutao/tutanota-utils\"\nimport { Keys } from \"../api/common/TutanotaConstants\"\nimport type { Key } from \"../misc/KeyManager\"\nimport path from \"node:path\"\nimport type { TranslationKey } from \"../misc/LanguageViewModel\"\nimport { lang } from \"../misc/LanguageViewModel\"\nimport { log } from \"./DesktopLog\"\nimport { parseUrlOrNull } from \"./PathUtils\"\nimport type { LocalShortcutManager } from \"./electron-localshortcut/LocalShortcut\"\nimport { DesktopThemeFacade } from \"./DesktopThemeFacade\"\nimport { CancelledError } from \"../api/common/error/CancelledError\"\nimport { DesktopFacade } from \"../native/common/generatedipc/DesktopFacade.js\"\nimport { CommonNativeFacade } from \"../native/common/generatedipc/CommonNativeFacade.js\"\nimport { RemoteBridge, WindowCleanup } from \"./ipc/RemoteBridge.js\"\nimport { InterWindowEventFacadeSendDispatcher } from \"../native/common/generatedipc/InterWindowEventFacadeSendDispatcher.js\"\nimport { handleProtocols } from \"./net/ProtocolProxy.js\"\nimport { PerWindowSqlCipherFacade } from \"./db/PerWindowSqlCipherFacade.js\"\nimport { DesktopMailImportFacade } from \"./mailimport/DesktopMailImportFacade\"\n\nconst MINIMUM_WINDOW_SIZE: number = 350\nexport type UserInfo = {\n\tuserId: string\n\tmailAddress?: string\n}\ntype LocalShortcut = {\n\tkey: Key\n\t// undefined == false\n\tctrl?: boolean\n\t// undefined == false\n\talt?: boolean\n\t// undefined == false\n\tshift?: boolean\n\t// undefined == false\n\tmeta?: boolean\n\tenabled?: lazy<boolean>\n\t// must return true, if preventDefault should not be invoked\n\texec(): boolean | void\n\thelp: TranslationKey\n}\nconst TAG = \"[ApplicationWindow]\"\n\nconst VIRTUAL_APP_URL_BASE = \"asset://app\"\nconst VIRTUAL_APP_URL = VIRTUAL_APP_URL_BASE + \"/index-desktop.html\"\n\nexport class ApplicationWindow {\n\t// these depend on window and are initialized later\n\tprivate _desktopFacade!: DesktopFacade\n\tprivate _commonNativeFacade!: CommonNativeFacade\n\tprivate _interWindowEventSender!: InterWindowEventFacadeSendDispatcher\n\tprivate _desktopMailImportFacade!: DesktopMailImportFacade\n\tprivate windowCleanup!: WindowCleanup\n\n\t_browserWindow!: BrowserWindow\n\n\t/** User logged in in this window. Reset from WindowManager. */\n\tprivate userId: Id | null = null\n\tprivate setBoundsTimeout: ReturnType<typeof setTimeout> | null = null\n\tprivate findingInPage: boolean = false\n\tprivate skipNextSearchBarBlur: boolean = false\n\tprivate lastSearchRequest: [string, { forward: boolean; matchCase: boolean }] | null = null\n\tprivate lastSearchPromiseReject: (err: Error | null) => void\n\tprivate shortcuts: Array<LocalShortcut>\n\tid!: number\n\n\tconstructor(\n\t\twm: WindowManager,\n\t\t/** absolute path to web assets (html, js etc.) */\n\t\tprivate readonly absoluteAssetsPath: string,\n\t\ticon: NativeImage,\n\t\tprivate readonly electron: typeof Electron.CrossProcessExports,\n\t\tprivate readonly localShortcut: LocalShortcutManager,\n\t\tprivate readonly themeFacade: DesktopThemeFacade,\n\t\tprivate readonly remoteBridge: RemoteBridge,\n\t\tnoAutoLogin?: boolean | null,\n\t\tpreloadOverridePath?: string,\n\t) {\n\t\tthis.lastSearchPromiseReject = noOp\n\t\tconst isMac = process.platform === \"darwin\"\n\t\tthis.shortcuts = (\n\t\t\t[\n\t\t\t\t{\n\t\t\t\t\tkey: Keys.F,\n\t\t\t\t\tmeta: isMac,\n\t\t\t\t\tctrl: !isMac,\n\t\t\t\t\texec: () => this.openFindInPage(),\n\t\t\t\t\thelp: \"searchPage_label\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tkey: Keys.P,\n\t\t\t\t\tmeta: isMac,\n\t\t\t\t\tctrl: !isMac,\n\t\t\t\t\texec: () => this.printMail(),\n\t\t\t\t\thelp: \"print_action\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tkey: Keys.F12,\n\t\t\t\t\texec: () => this.toggleDevTools(),\n\t\t\t\t\thelp: \"toggleDevTools_action\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tkey: Keys[\"0\"],\n\t\t\t\t\tmeta: isMac,\n\t\t\t\t\tctrl: !isMac,\n\t\t\t\t\texec: () => {\n\t\t\t\t\t\twm.changeZoom(1)\n\t\t\t\t\t},\n\t\t\t\t\thelp: \"resetZoomFactor_action\",\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tkey: Keys.Q,\n\t\t\t\t\tctrl: !isMac,\n\t\t\t\t\tmeta: isMac,\n\t\t\t\t\tshift: !isMac,\n\t\t\t\t\texec: () => this.electron.app.quit(),\n\t\t\t\t\thelp: \"quit_action\",\n\t\t\t\t},\n\t\t\t] as Array<LocalShortcut>\n\t\t).concat(\n\t\t\tisMac\n\t\t\t\t? [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tkey: Keys.F,\n\t\t\t\t\t\t\tmeta: true,\n\t\t\t\t\t\t\tctrl: true,\n\t\t\t\t\t\t\texec: () => this.toggleFullScreen(),\n\t\t\t\t\t\t\thelp: \"toggleFullScreen_action\",\n\t\t\t\t\t\t},\n\t\t\t\t  ]\n\t\t\t\t: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tkey: Keys.F11,\n\t\t\t\t\t\t\texec: () => this.toggleFullScreen(),\n\t\t\t\t\t\t\thelp: \"toggleFullScreen_action\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tkey: Keys.RIGHT,\n\t\t\t\t\t\t\talt: true,\n\t\t\t\t\t\t\texec: () => this._browserWindow.webContents.goForward(),\n\t\t\t\t\t\t\thelp: \"pageForward_label\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tkey: Keys.LEFT,\n\t\t\t\t\t\t\talt: true,\n\t\t\t\t\t\t\texec: () => this.tryGoBack(),\n\t\t\t\t\t\t\thelp: \"pageBackward_label\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tkey: Keys.H,\n\t\t\t\t\t\t\tctrl: true,\n\t\t\t\t\t\t\texec: () => wm.minimize(),\n\t\t\t\t\t\t\thelp: \"hideWindows_action\",\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tkey: Keys.N,\n\t\t\t\t\t\t\tctrl: true,\n\t\t\t\t\t\t\texec: () => {\n\t\t\t\t\t\t\t\twm.newWindow(true)\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\thelp: \"openNewWindow_action\",\n\t\t\t\t\t\t},\n\t\t\t\t  ],\n\t\t)\n\t\tlog.debug(TAG, \"webAssetsPath: \", this.absoluteAssetsPath)\n\t\tconst preloadPath = preloadOverridePath ?? path.join(this.electron.app.getAppPath(), \"./desktop/preload.js\")\n\n\t\tthis.createBrowserWindow(wm, {\n\t\t\tpreloadPath,\n\t\t\ticon,\n\t\t})\n\t\tthis.initFacades()\n\n\t\tthis.loadInitialUrl(noAutoLogin ?? false)\n\n\t\tthis.electron.Menu.setApplicationMenu(null)\n\t}\n\n\tget desktopMailImportFacade(): DesktopMailImportFacade {\n\t\treturn this._desktopMailImportFacade\n\t}\n\n\tget desktopFacade(): DesktopFacade {\n\t\treturn this._desktopFacade\n\t}\n\n\tget commonNativeFacade(): CommonNativeFacade {\n\t\treturn this._commonNativeFacade\n\t}\n\n\tget interWindowEventSender(): InterWindowEventFacadeSendDispatcher {\n\t\treturn this._interWindowEventSender\n\t}\n\n\tprivate initFacades() {\n\t\tconst sendingFacades = this.remoteBridge.createBridge(this)\n\t\tthis._desktopFacade = sendingFacades.desktopFacade\n\t\tthis._commonNativeFacade = sendingFacades.commonNativeFacade\n\t\tthis._interWindowEventSender = sendingFacades.interWindowEventSender\n\t\tthis.windowCleanup = sendingFacades.windowCleanup\n\t}\n\n\tprivate async loadInitialUrl(noAutoLogin: boolean) {\n\t\tconst initialUrl = await this.getInitialUrl({\n\t\t\tnoAutoLogin,\n\t\t})\n\t\tawait this.updateBackgroundColor()\n\n\t\tthis._browserWindow.loadURL(initialUrl)\n\t}\n\n\tasync updateBackgroundColor() {\n\t\tconst theme = await this.themeFacade.getCurrentThemeWithFallback()\n\n\t\tif (theme) {\n\t\t\tthis._browserWindow.setBackgroundColor(theme.navigation_bg)\n\t\t}\n\t}\n\n\t//expose browserwindow api\n\t// on: (m, f: (arg0: Event) => void) => BrowserWindow = (m, f: (arg0: Event) => void) => this._browserWindow.on(m, f)\n\ton: typeof BrowserWindow.prototype.on = (...args) =>\n\t\t// @ts-ignore\n\t\tthis._browserWindow.on(...args)\n\tonce: typeof BrowserWindow.prototype.once = (...args) =>\n\t\t// @ts-ignore\n\t\tthis._browserWindow.once(...args)\n\tgetTitle: () => string = () => this._browserWindow.webContents.getTitle()\n\t// windows that get their zoom factor set from the config file don't report that\n\t// zoom factor back when queried via webContents.zoomFactor.\n\t// we set it ourselves in the renderer thread the same way we handle mouse wheel zoom\n\tsetZoomFactor: (f: number) => void = (f: number) => this._browserWindow.webContents.setZoomFactor(f)\n\tisFullScreen: () => boolean = () => this._browserWindow.isFullScreen()\n\tisMinimized: () => boolean = () => this._browserWindow.isMinimized()\n\tminimize: () => void = () => this._browserWindow.minimize()\n\thide: () => void = () => this._browserWindow.hide()\n\tcenter: () => void = () => this._browserWindow.center()\n\tshowInactive: () => void = () => this._browserWindow.showInactive()\n\tfocus: () => void = () => this._browserWindow.focus()\n\tisFocused: () => boolean = () => this._browserWindow.isFocused()\n\n\tshow() {\n\t\tif (!this._browserWindow) {\n\t\t\treturn\n\t\t}\n\n\t\tconst contents = this._browserWindow.webContents\n\t\tconst devToolsState = contents.isDevToolsOpened()\n\n\t\tthis._browserWindow.show()\n\n\t\tif (this._browserWindow.isMinimized()) {\n\t\t\tthis._browserWindow.restore()\n\n\t\t\t//TODO: there has to be a better way. fix for #691\n\t\t\tcontents.toggleDevTools()\n\n\t\t\tif (devToolsState) {\n\t\t\t\tcontents.openDevTools()\n\t\t\t} else {\n\t\t\t\tcontents.closeDevTools()\n\t\t\t}\n\t\t} else if (!this._browserWindow.isFocused()) {\n\t\t\tthis._browserWindow.focus()\n\t\t}\n\t}\n\n\tprivate createBrowserWindow(\n\t\twm: WindowManager,\n\t\topts: {\n\t\t\tpreloadPath: string\n\t\t\ticon: NativeImage\n\t\t},\n\t) {\n\t\tconst { preloadPath, icon } = opts\n\n\t\tthis._browserWindow = new this.electron.BrowserWindow({\n\t\t\ticon,\n\t\t\tshow: false,\n\t\t\tautoHideMenuBar: true,\n\t\t\twebPreferences: {\n\t\t\t\tnodeIntegration: false,\n\t\t\t\tnodeIntegrationInWorker: false,\n\t\t\t\tnodeIntegrationInSubFrames: false,\n\t\t\t\tsandbox: true,\n\t\t\t\tcontextIsolation: true,\n\t\t\t\twebSecurity: true,\n\t\t\t\t// @ts-ignore see: https://github.com/electron/electron/issues/30789\n\t\t\t\tenableRemoteModule: false,\n\t\t\t\tallowRunningInsecureContent: false,\n\t\t\t\tpreload: preloadPath,\n\t\t\t\twebgl: false,\n\t\t\t\tplugins: false,\n\t\t\t\texperimentalFeatures: false,\n\t\t\t\twebviewTag: false,\n\t\t\t\tdisableDialogs: true,\n\t\t\t\tnavigateOnDragDrop: false,\n\t\t\t\tautoplayPolicy: \"user-gesture-required\",\n\t\t\t\tenableWebSQL: false,\n\t\t\t\tspellcheck: true,\n\t\t\t},\n\t\t})\n\n\t\tconst session = this._browserWindow.webContents.session\n\t\tsession.setPermissionRequestHandler((webContents, permission, callback: (_: boolean) => void) => callback(false))\n\n\t\thandleProtocols(session, this.absoluteAssetsPath)\n\n\t\tthis._browserWindow.setMenuBarVisibility(false)\n\n\t\tthis._browserWindow.removeMenu()\n\n\t\tthis._browserWindow.setMinimumSize(MINIMUM_WINDOW_SIZE, MINIMUM_WINDOW_SIZE)\n\n\t\tthis.id = this._browserWindow.id\n\n\t\tthis._browserWindow\n\t\t\t.on(\"closed\", async () => {\n\t\t\t\tawait this.cleanup()\n\t\t\t})\n\t\t\t.on(\"focus\", () => this.localShortcut.enableAll(this._browserWindow))\n\t\t\t.on(\"blur\", (_: FocusEvent) => this.localShortcut.disableAll(this._browserWindow))\n\n\t\tthis._browserWindow.webContents\n\t\t\t.on(\"will-attach-webview\", (e) => e.preventDefault())\n\t\t\t.on(\"will-navigate\", (e, url) => {\n\t\t\t\t// >Emitted when a user or the page wants to start navigation. It can happen when the window.location object is changed or\n\t\t\t\t// a user clicks a link in the page.\n\t\t\t\t// >This event will not emit when the navigation is started programmatically with APIs like webContents.loadURL and\n\t\t\t\t// webContents.back.\n\t\t\t\t// >It is also not emitted for in-page navigations, such as clicking anchor links or updating the window.location.hash.\n\t\t\t\t// https://www.electronjs.org/docs/api/web-contents#event-will-navigate\n\t\t\t\t//\n\t\t\t\t// Basically the only scenarios left for us are:\n\t\t\t\t// Clicking on a link without target=\"_blank\"\n\t\t\t\t// Programmatically changing window.location to something else (we don't do this and it normally reloads the page)\n\t\t\t\t// In neither of those cases we want to navigate anywhere.\n\t\t\t\tlog.debug(TAG, \"will-navigate\", url)\n\t\t\t\te.preventDefault()\n\t\t\t})\n\t\t\t.on(\"before-input-event\", (ev, input) => {\n\t\t\t\tif (this.lastSearchRequest && this.findingInPage && input.type === \"keyDown\" && input.key === \"Enter\") {\n\t\t\t\t\tthis.skipNextSearchBarBlur = true\n\t\t\t\t\tconst [searchTerm, options] = this.lastSearchRequest\n\t\t\t\t\toptions.forward = true\n\n\t\t\t\t\tthis._browserWindow.webContents\n\t\t\t\t\t\t.once(\"found-in-page\", (ev, res) => {\n\t\t\t\t\t\t\tthis._desktopFacade.applySearchResultToOverlay(res)\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.findInPage(searchTerm, options)\n\t\t\t\t}\n\t\t\t})\n\t\t\t.on(\"did-finish-load\", () => {\n\t\t\t\t// This also covers the case when window was reloaded.\n\t\t\t\t// the webContents needs to know on which channel to listen\n\t\t\t\tthis.sendShortcutstoRender()\n\t\t\t})\n\t\t\t.on(\"did-fail-load\", (evt, errorCode, errorDesc, validatedURL) => {\n\t\t\t\tlog.debug(TAG, \"failed to load resource: \", validatedURL, errorDesc)\n\n\t\t\t\tif (errorDesc === \"ERR_FILE_NOT_FOUND\") {\n\t\t\t\t\tthis.getInitialUrl({\n\t\t\t\t\t\tnoAutoLogin: true,\n\t\t\t\t\t})\n\t\t\t\t\t\t.then((initialUrl) => {\n\t\t\t\t\t\t\tlog.debug(TAG, \"redirecting to start page...\", initialUrl)\n\t\t\t\t\t\t\treturn this._browserWindow.loadURL(initialUrl)\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(() => log.debug(TAG, \"...redirected\"))\n\t\t\t\t}\n\t\t\t})\n\t\t\t// @ts-ignore\n\t\t\t.on(\"remote-require\", (e) => e.preventDefault())\n\t\t\t// @ts-ignore\n\t\t\t.on(\"remote-get-global\", (e) => e.preventDefault())\n\t\t\t// @ts-ignore\n\t\t\t.on(\"remote-get-builtin\", (e) => e.preventDefault())\n\t\t\t// @ts-ignore\n\t\t\t.on(\"remote-get-current-web-contents\", (e) => e.preventDefault())\n\t\t\t// @ts-ignore\n\t\t\t.on(\"remote-get-current-window\", (e) => e.preventDefault())\n\t\t\t.on(\"did-navigate\", () => this._browserWindow.emit(\"did-navigate\"))\n\t\t\t.on(\"did-navigate-in-page\", () => this._browserWindow.emit(\"did-navigate\"))\n\t\t\t.on(\"zoom-changed\", (ev, direction: \"in\" | \"out\") => this._browserWindow.emit(\"zoom-changed\", ev, direction))\n\t\t\t.on(\"update-target-url\", (ev, url) => {\n\t\t\t\tthis._desktopFacade.updateTargetUrl(url, VIRTUAL_APP_URL_BASE)\n\t\t\t})\n\n\t\tthis._browserWindow.webContents.setWindowOpenHandler((details) => this.onNewWindow(details))\n\n\t\t// Shortcuts but be registered here, before \"focus\" or \"blur\" event fires, otherwise localShortcut fails\n\t\tthis.reRegisterShortcuts()\n\t}\n\n\tasync reload(queryParams: Record<string, string | boolean>) {\n\t\tawait this.cleanup()\n\t\t// try to do this asap as to not get the window destroyed on us\n\t\tthis.remoteBridge.unsubscribe(this._browserWindow.webContents.ipc)\n\t\tthis.userId = null\n\t\tthis.initFacades()\n\t\tconst url = await this.getInitialUrl(queryParams)\n\t\tawait this._browserWindow.loadURL(url)\n\t}\n\n\tprivate async cleanup() {\n\t\tif (this.userId) {\n\t\t\tawait this.windowCleanup.onCleanup(this.userId)\n\t\t}\n\t}\n\n\tprivate onNewWindow(details: HandlerDetails): { action: \"deny\" } {\n\t\tconst parsedUrl = parseUrlOrNull(details.url)\n\n\t\tif (parsedUrl == null) {\n\t\t\tlog.warn(TAG, \"Could not parse url for new-window, will not open\")\n\t\t} else if (parsedUrl.protocol === \"file:\") {\n\t\t\t// this also works for raw file paths without protocol\n\t\t\tlog.warn(TAG, \"prevented file url from being opened by shell\")\n\t\t} else if (parsedUrl.protocol !== \"http:\" && parsedUrl.protocol !== \"https:\") {\n\t\t\tthis.electron.dialog\n\t\t\t\t.showMessageBox({\n\t\t\t\t\ttype: \"warning\",\n\t\t\t\t\tbuttons: [lang.get(\"yes_label\"), lang.get(\"no_label\")],\n\t\t\t\t\ttitle: lang.get(\"suspiciousLink_title\"),\n\t\t\t\t\tmessage: lang.get(\"suspiciousLink_msg\", { \"{url}\": parsedUrl.toString() }),\n\t\t\t\t\tdefaultId: 1, // default button is \"no\"\n\t\t\t\t})\n\t\t\t\t.then(({ response }) => {\n\t\t\t\t\tif (response === 0) {\n\t\t\t\t\t\tthis.doOpenLink(parsedUrl, details)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t} else {\n\t\t\tthis.doOpenLink(parsedUrl, details)\n\t\t}\n\n\t\treturn {\n\t\t\taction: \"deny\",\n\t\t}\n\t}\n\n\tprivate doOpenLink(parsedUrl: URL, details: Electron.HandlerDetails) {\n\t\t// we never open any new windows directly from the renderer\n\t\t// except for links in mails etc. so open them in the browser\n\t\tthis.electron.shell.openExternal(parsedUrl.toString()).catch((e) => {\n\t\t\tlog.warn(\"failed to open external url\", details.url, e)\n\t\t\tthis.electron.dialog.showMessageBox({\n\t\t\t\ttitle: lang.get(\"showURL_alt\"),\n\t\t\t\tbuttons: [lang.get(\"ok_action\")],\n\t\t\t\tdefaultId: 0,\n\t\t\t\tmessage: lang.get(\"couldNotOpenLink_msg\", { \"{link}\": details.url }),\n\t\t\t\ttype: \"error\",\n\t\t\t})\n\t\t})\n\t}\n\n\tprivate reRegisterShortcuts() {\n\t\tthis.localShortcut.unregisterAll(this._browserWindow)\n\n\t\tfor (const s of this.shortcuts) {\n\t\t\t// build the accelerator string localShortcut understands\n\t\t\tlet shortcutString = \"\"\n\t\t\tshortcutString += s.meta ? \"Command+\" : \"\"\n\t\t\tshortcutString += s.ctrl ? \"Control+\" : \"\"\n\t\t\tshortcutString += s.alt ? \"Alt+\" : \"\"\n\t\t\tshortcutString += s.shift ? \"Shift+\" : \"\"\n\t\t\tshortcutString += capitalizeFirstLetter(typedKeys(Keys).filter((k) => s.key === Keys[k])[0])\n\n\t\t\tthis.localShortcut.register(this._browserWindow, shortcutString, s.exec)\n\t\t}\n\t}\n\n\tprivate sendShortcutstoRender(): void {\n\t\t// delete exec since functions don't cross IPC anyway.\n\t\t// it will be replaced by () => true in the renderer thread\n\t\tconst webShortcuts = this.shortcuts.map((s) =>\n\t\t\tObject.assign({}, s, {\n\t\t\t\texec: null,\n\t\t\t}),\n\t\t)\n\n\t\tthis._desktopFacade.addShortcuts(webShortcuts)\n\t}\n\n\tprivate tryGoBack(): void {\n\t\tconst parsedUrl = url.parse(this._browserWindow.webContents.getURL())\n\n\t\tif (parsedUrl.pathname && !parsedUrl.pathname.endsWith(\"login\")) {\n\t\t\tthis._browserWindow.webContents.goBack()\n\t\t} else {\n\t\t\tlog.debug(TAG, \"Ignore back events on login page\")\n\t\t}\n\t}\n\n\tasync openMailBox(info: UserInfo, path?: string | null): Promise<void> {\n\t\tawait this._commonNativeFacade.openMailBox(info.userId, info.mailAddress!, path ?? null)\n\t\tthis.show()\n\t}\n\n\t// open at date?\n\tasync openCalendar(info: UserInfo): Promise<void> {\n\t\tawait this._commonNativeFacade.openCalendar(info.userId)\n\t\tthis.show()\n\t}\n\n\tsetContextMenuHandler(handler: (arg0: ContextMenuParams) => void) {\n\t\tconst wc = this._browserWindow.webContents\n\t\twc.on(\"context-menu\", (e, params) => handler(params))\n\t}\n\n\tgetUserId(): Id | null {\n\t\treturn this.userId\n\t}\n\n\tsetUserId(id: Id | null) {\n\t\tthis.userId = id\n\t}\n\n\tfindInPage(searchTerm: string, forward: boolean, matchCase: boolean, findNext: boolean): Promise<Result | null> {\n\t\tconst options = { forward, matchCase, findNext }\n\t\tthis.findingInPage = true\n\n\t\tif (searchTerm !== \"\") {\n\t\t\tthis.lastSearchRequest = [searchTerm, options]\n\n\t\t\tthis._browserWindow.webContents.findInPage(searchTerm, options)\n\n\t\t\treturn new Promise((resolve: (_: Result) => void, reject) => {\n\t\t\t\t// if the last search request is still ongoing, this will reject that requests' promise\n\t\t\t\t// we obviously don't care about that requests' result since we are already handling a new one\n\t\t\t\t// if the last request is done, this is a noOp\n\t\t\t\tthis.lastSearchPromiseReject(new CancelledError(\"search request was superseded\"))\n\n\t\t\t\t// make sure we can cancel this promise if we get a new search request before this one is done.\n\t\t\t\tthis.lastSearchPromiseReject = reject\n\n\t\t\t\tthis._browserWindow.webContents // the last listener might not have fired yet\n\t\t\t\t\t.removeAllListeners(\"found-in-page\")\n\t\t\t\t\t.once(\"found-in-page\", (ev, res: Result) => {\n\t\t\t\t\t\tthis.lastSearchPromiseReject = noOp\n\t\t\t\t\t\tresolve(res)\n\t\t\t\t\t})\n\t\t\t}).catch((e) => {\n\t\t\t\t// findInPage might reject if requests come too quickly\n\t\t\t\t// if it's rejecting for another reason we'll have logs\n\t\t\t\tif (!(e instanceof CancelledError)) log.debug(\"findInPage reject: \", e)\n\t\t\t\treturn null\n\t\t\t})\n\t\t} else {\n\t\t\tthis.stopFindInPage()\n\t\t\treturn Promise.resolve(null)\n\t\t}\n\t}\n\n\tstopFindInPage() {\n\t\tthis.findingInPage = false\n\t\tthis.lastSearchRequest = null\n\n\t\tthis._browserWindow.webContents.stopFindInPage(\"keepSelection\")\n\t}\n\n\t/**\n\t * make it known to the window if the search overlay is focused.\n\t * used to check if enter events need to be caught to search the next result\n\t * @param state whether the search bar is focused right now\n\t * @param force ignores skipnextblur\n\t */\n\tsetSearchOverlayState(state: boolean, force: boolean) {\n\t\tif (!force && !state && this.skipNextSearchBarBlur) {\n\t\t\tthis.skipNextSearchBarBlur = false\n\t\t\treturn\n\t\t}\n\n\t\tthis.findingInPage = state\n\t}\n\n\tprivate toggleDevTools(): void {\n\t\tconst wc = this._browserWindow.webContents\n\n\t\tif (wc.isDevToolsOpened()) {\n\t\t\twc.closeDevTools()\n\t\t} else {\n\t\t\twc.openDevTools({\n\t\t\t\tmode: \"undocked\",\n\t\t\t})\n\t\t}\n\t}\n\n\tprivate toggleFullScreen(): void {\n\t\tthis._browserWindow.setFullScreen(!this._browserWindow.isFullScreen())\n\t}\n\n\tprivate printMail() {\n\t\tthis._desktopFacade.print()\n\t}\n\n\tprivate openFindInPage(): void {\n\t\tthis._desktopFacade.openFindInPage()\n\t}\n\n\tsetBounds(bounds: WindowBounds) {\n\t\tthis._browserWindow.setFullScreen(bounds.fullscreen)\n\n\t\tthis.setZoomFactor(bounds.scale)\n\t\tif (bounds.fullscreen) return\n\n\t\tthis._browserWindow.setBounds(bounds.rect)\n\n\t\tif (process.platform !== \"linux\") return\n\t\tif (this.setBoundsTimeout) clearTimeout(this.setBoundsTimeout)\n\t\tthis.setBoundsTimeout = setTimeout(() => {\n\t\t\tif (this._browserWindow.isDestroyed()) {\n\t\t\t\treturn\n\t\t\t}\n\n\t\t\tconst newRect = this._browserWindow.getBounds()\n\n\t\t\tif (bounds.rect.y !== newRect.y) {\n\t\t\t\t// window was moved by some bug/OS interaction, so we move it back twice the distance.\n\t\t\t\t// should end up right where we want it. https://github.com/electron/electron/issues/10388\n\t\t\t\tthis._browserWindow.setPosition(newRect.x, newRect.y + 2 * (bounds.rect.y - newRect.y))\n\t\t\t}\n\t\t}, 200)\n\t}\n\n\tgetBounds(): WindowBounds {\n\t\treturn {\n\t\t\tfullscreen: this._browserWindow.isFullScreen(),\n\t\t\trect: this._browserWindow.getBounds(),\n\t\t\tscale: 1, // turns out we can't really trust wc.getZoomFactor\n\t\t}\n\t}\n\n\tprivate async getInitialUrl(additionalQueryParams: Record<string, string | boolean>): Promise<string> {\n\t\tconst url = new URL(VIRTUAL_APP_URL)\n\n\t\tfor (const [key, value] of typedEntries(additionalQueryParams)) {\n\t\t\turl.searchParams.append(key, String(value))\n\t\t}\n\n\t\turl.searchParams.append(\"platformId\", process.platform)\n\t\tconst theme = await this.themeFacade.getCurrentThemeWithFallback()\n\t\turl.searchParams.append(\"theme\", JSON.stringify(theme))\n\t\treturn url.toString()\n\t}\n}\n","import o from \"@tutao/otest\"\nimport n from \"../nodemocker.js\"\nimport { defer, DeferredObject, delay, downcast } from \"@tutao/tutanota-utils\"\nimport { ApplicationWindow } from \"../../../src/common/desktop/ApplicationWindow.js\"\nimport type { BrowserWindow, NativeImage, Rectangle } from \"electron\"\nimport type { Theme, ThemeId } from \"../../../src/common/gui/theme.js\"\nimport { WindowManager } from \"../../../src/common/desktop/DesktopWindowManager.js\"\nimport { LocalShortcutManager } from \"../../../src/common/desktop/electron-localshortcut/LocalShortcut.js\"\nimport { matchers, object, when } from \"testdouble\"\nimport { spy, verify } from \"@tutao/tutanota-test-utils\"\nimport { ThemeFacade } from \"../../../src/common/native/common/generatedipc/ThemeFacade.js\"\nimport { DesktopThemeFacade } from \"../../../src/common/desktop/DesktopThemeFacade.js\"\nimport { RemoteBridge, SendingFacades } from \"../../../src/common/desktop/ipc/RemoteBridge.js\"\n\nconst { anything } = matchers\n\no.spec(\"ApplicationWindow Test\", function () {\n\tconst electronLocalshortcut = {\n\t\tcallbacks: Object.create(null),\n\t\tregister: function (bw, key, cb) {\n\t\t\tthis.callbacks[key] = cb\n\t\t},\n\t\tunregisterAll: function (key) {},\n\t}\n\tconst lang = {\n\t\tlang: {\n\t\t\tinitialized: {\n\t\t\t\tpromise: {\n\t\t\t\t\tthen: (cb) => {\n\t\t\t\t\t\tsetImmediate(() => cb())\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t},\n\t}\n\tconst wm = {\n\t\tipc: {\n\t\t\taddWindow: () => {},\n\t\t\tremoveWindow: () => {},\n\t\t\tsendRequest: () => Promise.resolve(),\n\t\t\tinitialized: () => Promise.resolve(),\n\t\t},\n\t\tdl: {\n\t\t\tmanageDownloadsForSession: () => {},\n\t\t},\n\t\tnewWindow: () => {},\n\t\thide: () => {},\n\t\tminimize: () => {},\n\t\tgetIcon: () => icon,\n\t} as const\n\tconst themeFacadeInstance = new (class implements ThemeFacade {\n\t\tasync getThemePreference(): Promise<ThemeId | null> {\n\t\t\treturn \"light\"\n\t\t}\n\n\t\tasync setThemePreference(themeId: ThemeId) {}\n\n\t\tasync getThemes(): Promise<Array<Theme>> {\n\t\t\treturn []\n\t\t}\n\n\t\tasync setThemes(themes: Array<Theme>) {}\n\n\t\tasync getCurrentTheme(): Promise<Theme | null> {\n\t\t\treturn null\n\t\t}\n\n\t\tasync prefersDark(): Promise<boolean> {\n\t\t\treturn false\n\t\t}\n\n\t\tasync getCurrentThemeWithFallback(): Promise<Theme> {\n\t\t\tlet theme = await this.getCurrentTheme()\n\n\t\t\tif (theme == null) {\n\t\t\t\ttheme = {\n\t\t\t\t\tthemeId: \"light-fallback\",\n\t\t\t\t\tcontent_bg: \"#ffffff\",\n\t\t\t\t\theader_bg: \"#ffffff\",\n\t\t\t\t} as Theme\n\t\t\t}\n\n\t\t\treturn theme\n\t\t}\n\t})()\n\tconst desktopHtml = \"desktophtml\"\n\tconst icon: NativeImage = downcast(Symbol(\"icon\"))\n\n\tconst standardMocks = () => {\n\t\tconst electron = {\n\t\t\tBrowserWindow: n.classify({\n\t\t\t\tprototype: {\n\t\t\t\t\tcallbacks: {},\n\t\t\t\t\tdevToolsOpened: false,\n\t\t\t\t\tdestroyed: false,\n\t\t\t\t\tfocused: true,\n\t\t\t\t\tminimized: false,\n\t\t\t\t\tbounds: {\n\t\t\t\t\t\theight: 0,\n\t\t\t\t\t\twidth: 0,\n\t\t\t\t\t\tx: 0,\n\t\t\t\t\t\ty: 0,\n\t\t\t\t\t},\n\t\t\t\t\tfullscreen: false,\n\t\t\t\t\tisDestroyed: function () {\n\t\t\t\t\t\treturn this.destroyed\n\t\t\t\t\t},\n\t\t\t\t\ton: function (ev: string, cb: () => void) {\n\t\t\t\t\t\tthis.callbacks[ev] = cb\n\t\t\t\t\t\treturn this\n\t\t\t\t\t},\n\t\t\t\t\tonce: function (ev: string, cb: () => void) {\n\t\t\t\t\t\tthis.callbacks[ev] = cb\n\t\t\t\t\t\treturn this\n\t\t\t\t\t},\n\t\t\t\t\temit: function (ev: string) {\n\t\t\t\t\t\tthis.callbacks[ev]()\n\t\t\t\t\t},\n\t\t\t\t\tconstructor: function (opts) {\n\t\t\t\t\t\tthis.opts = opts\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\tthis.id = electron.BrowserWindow.lastId\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\telectron.BrowserWindow.lastId = electron.BrowserWindow.lastId + 1\n\t\t\t\t\t\tthis.__loadedUrl = defer()\n\t\t\t\t\t\tthis.webContents = n.spyify({\n\t\t\t\t\t\t\tcallbacks: Object.create(null),\n\t\t\t\t\t\t\tdestroyed: false,\n\t\t\t\t\t\t\tzoomFactor: 1.0,\n\t\t\t\t\t\t\tisDestroyed: () => {\n\t\t\t\t\t\t\t\treturn this.webContents.destroyed\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tsend: (msg, val) => {},\n\t\t\t\t\t\t\ton: (ev: string, cb: () => void) => {\n\t\t\t\t\t\t\t\tthis.webContents.callbacks[ev] = cb\n\t\t\t\t\t\t\t\treturn this.webContents\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tonce: (ev: string, cb: () => void) => {\n\t\t\t\t\t\t\t\tthis.webContents.callbacks[ev] = cb\n\t\t\t\t\t\t\t\treturn this.webContents\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tisDevToolsOpened: function () {\n\t\t\t\t\t\t\t\treturn this.devToolsOpened\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\topenDevTools: function () {\n\t\t\t\t\t\t\t\tthis.devToolsOpened = true\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tcloseDevTools: function () {\n\t\t\t\t\t\t\t\tthis.devToolsOpened = false\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tgoBack: function () {},\n\t\t\t\t\t\t\tgoForward: function () {},\n\t\t\t\t\t\t\tsetZoomFactor: function (n: number) {\n\t\t\t\t\t\t\t\tthis.zoomFactor = n\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tgetZoomFactor: function () {\n\t\t\t\t\t\t\t\treturn 1\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttoggleDevTools: function () {\n\t\t\t\t\t\t\t\tthis.devToolsOpened = !this.devToolsOpened\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tgetTitle: () => \"webContents Title\",\n\t\t\t\t\t\t\tsession: {\n\t\t\t\t\t\t\t\tsetPermissionRequestHandler: () => {},\n\t\t\t\t\t\t\t\tsetSpellCheckerDictionaryDownloadURL: () => {},\n\t\t\t\t\t\t\t\tprotocol: {\n\t\t\t\t\t\t\t\t\thandled: true,\n\t\t\t\t\t\t\t\t\tisProtocolHandled: function () {\n\t\t\t\t\t\t\t\t\t\tthis.handled = !this.handled\n\t\t\t\t\t\t\t\t\t\treturn this.handled\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\thandle() {\n\t\t\t\t\t\t\t\t\t\treturn true\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\ton() {\n\t\t\t\t\t\t\t\t\treturn this\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tremoveAllListeners() {\n\t\t\t\t\t\t\t\t\treturn this\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tfindInPage: () => {},\n\t\t\t\t\t\t\tstopFindInPage: () => {},\n\t\t\t\t\t\t\tgetURL: () => \"file:///path/to/app/desktophtml/meh/more\",\n\t\t\t\t\t\t\tremoveAllListeners: (k) => {\n\t\t\t\t\t\t\t\tthis.webContents.callbacks[k] = []\n\t\t\t\t\t\t\t\treturn this\n\t\t\t\t\t\t\t},\n\n\t\t\t\t\t\t\tsetWindowOpenHandler(handler) {\n\t\t\t\t\t\t\t\tthis.windowOpenHandler = handler\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t})\n\t\t\t\t\t},\n\t\t\t\t\tremoveMenu: function () {},\n\t\t\t\t\tsetMenuBarVisibility: function () {},\n\t\t\t\t\tsetMinimumSize: function (x: number, y: number) {},\n\t\t\t\t\tloadURL: function (...args) {\n\t\t\t\t\t\tthis.__loadedUrl.resolve(args)\n\n\t\t\t\t\t\treturn Promise.resolve()\n\t\t\t\t\t},\n\t\t\t\t\tclose: function () {},\n\t\t\t\t\tshow: function () {},\n\t\t\t\t\thide: function () {},\n\t\t\t\t\tcenter: function () {},\n\t\t\t\t\tshowInactive: function () {},\n\t\t\t\t\tisFocused: function () {\n\t\t\t\t\t\treturn this.focused\n\t\t\t\t\t},\n\t\t\t\t\tsetFullScreen: function (fullscreen) {\n\t\t\t\t\t\tthis.fullscreen = fullscreen\n\t\t\t\t\t},\n\t\t\t\t\tisFullScreen: function () {\n\t\t\t\t\t\treturn this.fullscreen\n\t\t\t\t\t},\n\t\t\t\t\tisMinimized: function () {\n\t\t\t\t\t\treturn this.minimized\n\t\t\t\t\t},\n\t\t\t\t\tminimize: function () {},\n\t\t\t\t\tfocus: function () {},\n\t\t\t\t\trestore: function () {},\n\t\t\t\t\tgetBounds: function () {\n\t\t\t\t\t\treturn this.bounds\n\t\t\t\t\t},\n\t\t\t\t\tsetBounds: function (bounds) {\n\t\t\t\t\t\tthis.bounds = bounds\n\t\t\t\t\t},\n\t\t\t\t\tsetPosition: function (x, y) {\n\t\t\t\t\t\tthis.bounds.x = x\n\t\t\t\t\t\tthis.bounds.y = y\n\t\t\t\t\t},\n\t\t\t\t\tsetBackgroundColor: function () {},\n\t\t\t\t},\n\t\t\t\tstatics: {\n\t\t\t\t\tlastId: 0,\n\t\t\t\t},\n\t\t\t}),\n\t\t\tshell: {\n\t\t\t\topenExternal: () => Promise.resolve(),\n\t\t\t},\n\t\t\tMenu: {\n\t\t\t\tsetApplicationMenu: () => {},\n\t\t\t},\n\t\t\tapp: {\n\t\t\t\tgetAppPath: () => \"/path/to/app\",\n\t\t\t\tgetVersion: () => \"app version\",\n\t\t\t},\n\t\t} as const\n\t\t// node modules\n\t\ttype WebContentsMock = Electron.WebContents & { callbacks: any[]; devToolsOpened: boolean; destroyed: boolean }\n\t\ttype BrowserWindowInstanceMock = Electron.BrowserWindow & {\n\t\t\twebContents: WebContentsMock\n\t\t\tdestroyed: boolean\n\t\t\t__loadedUrl: DeferredObject<string>\n\t\t\tbounds: Rectangle\n\t\t\tdevToolsOpened: boolean\n\t\t\tminimized: boolean\n\t\t\tfocused: boolean\n\t\t}\n\t\ttype BrowserWindowMock = Class<Electron.BrowserWindow> & { mockedInstances: BrowserWindowInstanceMock[]; lastId: number }\n\t\ttype ElectronMock = typeof import(\"electron\") & { BrowserWindow: BrowserWindowMock }\n\n\t\tconst electronMock = n.mock<ElectronMock>(\"electron\", electron).set()\n\t\tconst electronLocalshortcutMock = n.mock<typeof electronLocalshortcut & LocalShortcutManager>(\"electron-localshortcut\", electronLocalshortcut).set()\n\t\t// our modules\n\t\tconst desktopTrayMock = n\n\t\t\t.mock(\"./DesktopTray.js\", {\n\t\t\t\tDesktopTray: {\n\t\t\t\t\tgetIcon: () => \"this is an icon\",\n\t\t\t\t},\n\t\t\t})\n\t\t\t.set()\n\t\tconst langMock = n.mock(\"../misc/LanguageViewModel\", lang).set()\n\t\t// instances\n\t\tconst wmMock = n.mock<WindowManager>(\"__wm\", wm).set()\n\t\tconst themeFacade = n.mock<DesktopThemeFacade>(\"__themeFacade\", themeFacadeInstance).set()\n\t\tconst remoteBridge = object<RemoteBridge>()\n\t\tconst sendingFacades: SendingFacades = {\n\t\t\tinterWindowEventSender: object(),\n\t\t\tdesktopFacade: object(),\n\t\t\tcommonNativeFacade: object(),\n\t\t\twindowCleanup: object(),\n\t\t}\n\t\twhen(remoteBridge.createBridge(anything())).thenReturn(sendingFacades)\n\t\treturn {\n\t\t\telectronMock,\n\t\t\telectronLocalshortcutMock,\n\t\t\tdesktopTrayMock,\n\t\t\tlangMock,\n\t\t\twmMock,\n\t\t\tthemeFacade,\n\t\t\tremoteBridge,\n\t\t\tdesktopFacade: sendingFacades.desktopFacade,\n\t\t\tinterWindowEventSender: sendingFacades.interWindowEventSender,\n\t\t\tcommonNativeFacade: sendingFacades.commonNativeFacade,\n\t\t\twindowCleanup: sendingFacades.windowCleanup,\n\t\t}\n\t}\n\n\to.test(\"construction\", async function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge } = standardMocks()\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\to(electronMock.BrowserWindow.mockedInstances.length).equals(1)\n\t\tconst bwInstance: BrowserWindow = electronMock.BrowserWindow.mockedInstances[0]\n\t\t// We load some things async before loading URL so we wait for it. __loadedUrl comes from our mock\n\t\tawait (bwInstance as any).__loadedUrl.promise\n\t\to(bwInstance.loadURL.callCount).equals(1)\n\t\tconst theme = await themeFacade.getCurrentThemeWithFallback()\n\t\tconst themeJson = JSON.stringify(theme)\n\t\tconst query = new URLSearchParams({\n\t\t\tnoAutoLogin: \"false\",\n\t\t\tplatformId: process.platform,\n\t\t\ttheme: themeJson,\n\t\t})\n\t\to(bwInstance.loadURL.args[0]).equals(`asset://app/index-desktop.html?${query.toString()}`)\n\t\to((bwInstance as any).opts).deepEquals({\n\t\t\ticon,\n\t\t\tshow: false,\n\t\t\tautoHideMenuBar: true,\n\t\t\twebPreferences: {\n\t\t\t\tnodeIntegration: false,\n\t\t\t\tnodeIntegrationInWorker: false,\n\t\t\t\tnodeIntegrationInSubFrames: false,\n\t\t\t\tsandbox: true,\n\t\t\t\tcontextIsolation: true,\n\t\t\t\twebSecurity: true,\n\t\t\t\tenableRemoteModule: false,\n\t\t\t\tallowRunningInsecureContent: false,\n\t\t\t\tpreload: \"/path/to/app/desktop/preload.js\",\n\t\t\t\tspellcheck: true,\n\t\t\t\twebgl: false,\n\t\t\t\tplugins: false,\n\t\t\t\texperimentalFeatures: false,\n\t\t\t\twebviewTag: false,\n\t\t\t\tdisableDialogs: true,\n\t\t\t\tnavigateOnDragDrop: false,\n\t\t\t\tautoplayPolicy: \"user-gesture-required\",\n\t\t\t\tenableWebSQL: false,\n\t\t\t},\n\t\t})\n\t\to(bwInstance.setMenuBarVisibility.callCount).equals(1)\n\t\to(bwInstance.setMenuBarVisibility.args[0]).equals(false)\n\t\to(bwInstance.removeMenu.callCount).equals(1)\n\t\to(Object.keys((bwInstance.webContents as any).callbacks)).deepEquals([\n\t\t\t\"will-attach-webview\",\n\t\t\t\"will-navigate\",\n\t\t\t\"before-input-event\",\n\t\t\t\"did-finish-load\",\n\t\t\t\"did-fail-load\",\n\t\t\t\"remote-require\",\n\t\t\t\"remote-get-global\",\n\t\t\t\"remote-get-builtin\",\n\t\t\t\"remote-get-current-web-contents\",\n\t\t\t\"remote-get-current-window\",\n\t\t\t\"did-navigate\",\n\t\t\t\"did-navigate-in-page\",\n\t\t\t\"zoom-changed\",\n\t\t\t\"update-target-url\",\n\t\t])(\"webContents registered callbacks dont match\")\n\t\to(bwInstance.webContents.session.protocol.handle.callCount).equals(3)\n\t})\n\to.test(\"construction, noAutoLogin\", async function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge } = standardMocks()\n\t\t// noAutoLogin=true\n\t\tconst w2 = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge, true)\n\t\tconst bwInstance2 = electronMock.BrowserWindow.mockedInstances[0]\n\t\tawait bwInstance2.__loadedUrl.promise\n\t\to(bwInstance2.loadURL.callCount).equals(1)\n\t\tconst themeJson = JSON.stringify(await themeFacade.getCurrentThemeWithFallback())\n\t\tconst url = new URL(bwInstance2.loadURL.args[0])\n\t\to(url.searchParams.get(\"noAutoLogin\")).equals(\"true\")\n\t\to(url.searchParams.get(\"platformId\")).equals(process.platform)\n\t\to(url.searchParams.get(\"theme\")).equals(themeJson)\n\t})\n\n\to.test(\"redirect to start page after failing to load a page due to 404\", async function () {\n\t\tconst { wmMock, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge } = standardMocks()\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\tawait bwInstance.__loadedUrl.promise\n\t\tbwInstance.__loadedUrl = defer()\n\t\tbwInstance.webContents.callbacks[\"did-fail-load\"]({}, -6, \"ERR_FILE_NOT_FOUND\")\n\t\tawait bwInstance.__loadedUrl.promise\n\t\to(bwInstance.loadURL.callCount).equals(2)\n\t\tconst themeJson = JSON.stringify(await themeFacade.getCurrentThemeWithFallback())\n\t\tconst url = new URL(bwInstance.loadURL.args[0])\n\t\to(url.searchParams.get(\"noAutoLogin\")).equals(\"true\")\n\t\to(url.searchParams.get(\"theme\")).equals(themeJson)\n\t\tdowncast(w._browserWindow.webContents).callbacks[\"did-fail-load\"]({}, -6, \"ERR_SOME_OTHER_ONE\")\n\t\tawait delay(10)\n\t\to(bwInstance.loadURL.callCount).equals(2)\n\t})\n\n\to.test(\"shortcut creation, linux\", function () {\n\t\tn.setPlatform(\"linux\")\n\t\tconst { electronLocalshortcutMock, wmMock, electronMock, themeFacade, remoteBridge } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tdowncast(w._browserWindow.webContents).callbacks[\"did-finish-load\"]()\n\t\to(Object.keys(electronLocalshortcutMock.callbacks)).deepEquals([\n\t\t\t\"Control+F\",\n\t\t\t\"Control+P\",\n\t\t\t\"F12\",\n\t\t\t\"Control+0\",\n\t\t\t\"Control+Shift+Q\",\n\t\t\t\"F11\",\n\t\t\t\"Alt+Right\",\n\t\t\t\"Alt+Left\",\n\t\t\t\"Control+H\",\n\t\t\t\"Control+N\",\n\t\t])\n\t})\n\to.test(\"shortcut creation, windows\", function () {\n\t\tn.setPlatform(\"win32\")\n\t\tconst { electronLocalshortcutMock, wmMock, electronMock, themeFacade, remoteBridge } = standardMocks()\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tdowncast(w._browserWindow.webContents).callbacks[\"did-finish-load\"]()\n\t\to(Object.keys(electronLocalshortcutMock.callbacks)).deepEquals([\n\t\t\t\"Control+F\",\n\t\t\t\"Control+P\",\n\t\t\t\"F12\",\n\t\t\t\"Control+0\",\n\t\t\t\"Control+Shift+Q\",\n\t\t\t\"F11\",\n\t\t\t\"Alt+Right\",\n\t\t\t\"Alt+Left\",\n\t\t\t\"Control+H\",\n\t\t\t\"Control+N\",\n\t\t])\n\t})\n\to.test(\"shortcut creation, mac\", function () {\n\t\tn.setPlatform(\"darwin\")\n\t\tconst { electronLocalshortcutMock, wmMock, electronMock, themeFacade, remoteBridge } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tdowncast(w._browserWindow.webContents).callbacks[\"did-finish-load\"]()\n\t\to(Object.keys(electronLocalshortcutMock.callbacks)).deepEquals([\"Command+F\", \"Command+P\", \"F12\", \"Command+0\", \"Command+Q\", \"Command+Control+F\"])\n\t})\n\n\tfunction testShortcut(shortcuts: Array<string>, assertion: (sm: ReturnType<typeof standardMocks>) => void) {\n\t\to.test(\"[\" + shortcuts.join(\" >> \") + \"]\", async function () {\n\t\t\tconst sm = standardMocks()\n\t\t\tconst { electronMock, electronLocalshortcutMock, wmMock, themeFacade, remoteBridge } = sm\n\n\t\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t\t;(bwInstance.webContents as any).callbacks[\"did-finish-load\"]()\n\t\t\t// ApplicationWindow waits for IPC and this is a reliable way to also wait for it\n\t\t\tfor (const shortcut of shortcuts) {\n\t\t\t\telectronLocalshortcutMock.callbacks[shortcut]()\n\t\t\t}\n\t\t\tassertion(sm)\n\t\t})\n\t}\n\n\to.spec(\"shortcuts are used, linux & win\", function () {\n\t\to.beforeEach(() => n.setPlatform(\"linux\"))\n\t\ttestShortcut([\"Control+F\"], ({ desktopFacade }) => {\n\t\t\tverify(desktopFacade.openFindInPage())\n\t\t})\n\t\ttestShortcut([\"Control+P\"], ({ desktopFacade }) => {\n\t\t\tverify(desktopFacade.print())\n\t\t})\n\t\ttestShortcut([\"F12\"], ({ electronMock }) => {\n\t\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t\to(bwInstance.webContents.isDevToolsOpened.callCount).equals(1)\n\t\t\to(bwInstance.webContents.openDevTools.callCount).equals(1)\n\t\t\to(bwInstance.webContents.closeDevTools.callCount).equals(0)\n\t\t\tbwInstance.webContents.devToolsOpened = true\n\t\t})\n\t\ttestShortcut([\"F12\", \"F12\"], ({ electronMock }) => {\n\t\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t\to(bwInstance.webContents.isDevToolsOpened.callCount).equals(2)\n\t\t\to(bwInstance.webContents.openDevTools.callCount).equals(1)\n\t\t\to(bwInstance.webContents.closeDevTools.callCount).equals(1)\n\t\t})\n\n\t\ttestShortcut([\"Control+H\"], ({ wmMock }) => o(wmMock.minimize.callCount).equals(1))\n\t\ttestShortcut([\"Control+N\"], ({ wmMock }) => {\n\t\t\to(wmMock.newWindow.callCount).equals(1)\n\t\t\to(wmMock.newWindow.args[0]).equals(true)\n\t\t})\n\t\ttestShortcut([\"F11\"], ({ electronMock }) => {\n\t\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t\to(bwInstance.setFullScreen.callCount).equals(1)\n\t\t\to(bwInstance.isFullScreen.callCount).equals(1)\n\t\t\to(bwInstance.setFullScreen.args[0]).equals(true)\n\t\t})\n\t\ttestShortcut([\"Alt+Left\"], ({ electronMock }) => {\n\t\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t\to(bwInstance.webContents.goBack.callCount).equals(1)\n\t\t})\n\t\ttestShortcut([\"Alt+Right\"], ({ electronMock }) => {\n\t\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t\to(bwInstance.webContents.goForward.callCount).equals(1)\n\t\t})\n\t})\n\n\to.spec(\"shortcuts are used, mac\", function () {\n\t\to.beforeEach(() => n.setPlatform(\"darwin\"))\n\t\ttestShortcut([\"Command+F\"], ({ desktopFacade }) => {\n\t\t\tverify(desktopFacade.openFindInPage())\n\t\t})\n\t\ttestShortcut([\"Command+P\"], ({ desktopFacade }) => {\n\t\t\tverify(desktopFacade.print())\n\t\t})\n\t\ttestShortcut([\"F12\"], ({ electronMock }) => {\n\t\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t\to(bwInstance.webContents.isDevToolsOpened.callCount).equals(1)\n\t\t\to(bwInstance.webContents.openDevTools.callCount).equals(1)\n\t\t\to(bwInstance.webContents.closeDevTools.callCount).equals(0)\n\t\t\tbwInstance.webContents.devToolsOpened = true\n\t\t})\n\t\ttestShortcut([\"F12\", \"F12\"], ({ electronMock }) => {\n\t\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t\to(bwInstance.webContents.isDevToolsOpened.callCount).equals(2)\n\t\t\to(bwInstance.webContents.openDevTools.callCount).equals(1)\n\t\t\to(bwInstance.webContents.closeDevTools.callCount).equals(1)\n\t\t})\n\t\ttestShortcut([\"Command+Control+F\"], ({ electronMock }) => {\n\t\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t\to(bwInstance.setFullScreen.callCount).equals(1)\n\t\t\to(bwInstance.isFullScreen.callCount).equals(1)\n\t\t\to(bwInstance.setFullScreen.args[0]).equals(true)\n\t\t})\n\t})\n\n\to.test(\"shortcuts are set on window reload\", async function () {\n\t\tn.setPlatform(\"linux\")\n\t\tconst { electronMock, electronLocalshortcutMock, wmMock, themeFacade, remoteBridge, desktopFacade } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\tbwInstance.webContents.callbacks[\"did-finish-load\"]()\n\t\tverify(desktopFacade.addShortcuts(anything()))\n\t\t// Simulating reload from here\n\t\t// Reset IPC\n\t\tconst initialized = defer<void>()\n\n\t\tbwInstance.webContents.callbacks[\"did-finish-load\"]()\n\t\t// Init IPC\n\t\tinitialized.resolve()\n\t\tawait initialized.promise\n\t\t// Shortcuts should be added again because page has been reloaded\n\t\tverify(desktopFacade.addShortcuts(anything()))\n\t})\n\n\to.test(\"will-navigate\", function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge } = standardMocks()\n\n\t\tconst e = {\n\t\t\tpreventDefault: spy(),\n\t\t}\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\tbwInstance.webContents.callbacks[\"will-navigate\"](e, \"http://test.com\")\n\t\to(e.preventDefault.callCount).equals(1)(\"Prevent default is called\")\n\t})\n\n\to.test(\"attaching webView is denied\", function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\tconst e = {\n\t\t\tpreventDefault: spy(),\n\t\t}\n\t\tbwInstance.webContents.callbacks[\"will-attach-webview\"](e)\n\t\to(e.preventDefault.callCount).equals(1)\n\t\tlet threw = false\n\n\t\ttry {\n\t\t\tbwInstance.webContents.callbacks[\"will-attach-webview\"]()\n\t\t} catch (e) {\n\t\t\tthrew = true\n\t\t}\n\n\t\to(threw).equals(true)\n\t})\n\n\to.spec(\"new window is redirected to openExternal\", function () {\n\t\tlet electronMock\n\t\tlet bwInstance\n\t\to.beforeEach(function () {\n\t\t\tconst sm = standardMocks()\n\t\t\telectronMock = sm.electronMock\n\t\t\tlet { wmMock, electronLocalshortcutMock, themeFacade, remoteBridge } = sm\n\n\t\t\tnew ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\t\tbwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t})\n\t\to.test(\"not url is not redirected\", function () {\n\t\t\tconst url = \"ba/\\\\.nanas\"\n\t\t\tconst result = bwInstance.webContents.windowOpenHandler({\n\t\t\t\turl,\n\t\t\t\tframeName: \"frameName\",\n\t\t\t\tfeatures: \"\",\n\t\t\t\tdisposition: \"default\",\n\t\t\t\treferrer: {},\n\t\t\t})\n\t\t\to(result).deepEquals({\n\t\t\t\taction: \"deny\",\n\t\t\t})\n\t\t\to(electronMock.shell.openExternal.callCount).equals(0)\n\t\t})\n\t\to.test(\"url without protocol is not redirected\", function () {\n\t\t\tconst url = \"dies.ist.ne/url\"\n\t\t\tconst result = bwInstance.webContents.windowOpenHandler({\n\t\t\t\turl,\n\t\t\t\tframeName: \"frameName\",\n\t\t\t\tfeatures: \"\",\n\t\t\t\tdisposition: \"default\",\n\t\t\t\treferrer: {},\n\t\t\t})\n\t\t\to(result).deepEquals({\n\t\t\t\taction: \"deny\",\n\t\t\t})\n\t\t\to(electronMock.shell.openExternal.callCount).equals(0)\n\t\t})\n\t\to.test(\"http url is redirected\", function () {\n\t\t\tconst url = \"http://example.com\"\n\t\t\tconst result = bwInstance.webContents.windowOpenHandler({\n\t\t\t\turl,\n\t\t\t\tframeName: \"frameName\",\n\t\t\t\tfeatures: \"\",\n\t\t\t\tdisposition: \"default\",\n\t\t\t\treferrer: {},\n\t\t\t})\n\t\t\to(result).deepEquals({\n\t\t\t\taction: \"deny\",\n\t\t\t})\n\t\t\to(electronMock.shell.openExternal.callCount).equals(1)\n\t\t\to(electronMock.shell.openExternal.args[0]).equals(\"http://example.com/\")\n\t\t})\n\t\to.test(\"file url is not opened nor redirected\", function () {\n\t\t\tconst url = \"file:///etc/shadow\"\n\t\t\tconst result = bwInstance.webContents.windowOpenHandler({\n\t\t\t\turl,\n\t\t\t\tframeName: \"frameName\",\n\t\t\t\tfeatures: \"\",\n\t\t\t\tdisposition: \"default\",\n\t\t\t\treferrer: {},\n\t\t\t})\n\t\t\to(result).deepEquals({\n\t\t\t\taction: \"deny\",\n\t\t\t})\n\t\t\to(electronMock.shell.openExternal.callCount).equals(0)\n\t\t})\n\t})\n\n\to.test(\"context-menu is passed to handler\", function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tconst handlerMock = n.spyify(() => {})\n\t\tw.setContextMenuHandler(handlerMock)\n\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\tconst e = {\n\t\t\tpreventDefault: spy(),\n\t\t}\n\t\tbwInstance.webContents.callbacks[\"context-menu\"](e, {\n\t\t\tlinkURL: \"dies.ist.ne/url\",\n\t\t\teditFlags: \"someflags\",\n\t\t})\n\t\to(bwInstance.webContents.send.callCount).equals(0)\n\t\to(e.preventDefault.callCount).equals(0)\n\t\to(handlerMock.callCount).equals(1)\n\t\to(handlerMock.args).deepEquals([\n\t\t\t{\n\t\t\t\tlinkURL: \"dies.ist.ne/url\",\n\t\t\t\teditFlags: \"someflags\",\n\t\t\t},\n\t\t])\n\t})\n\to.test(\"openMailbox sends mailbox info and shows window\", async function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge, commonNativeFacade } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tw.openMailBox(\n\t\t\t{\n\t\t\t\tuserId: \"userId\",\n\t\t\t\tmailAddress: \"a@b.c\",\n\t\t\t},\n\t\t\t\"path\",\n\t\t)\n\t\tawait delay(10)\n\t\tverify(commonNativeFacade.openMailBox(\"userId\", \"a@b.c\", \"path\"))\n\t\to(electronMock.BrowserWindow.mockedInstances[0].show.callCount).equals(1)\n\t})\n\to.test(\"setBounds and getBounds\", async function () {\n\t\to.timeout(300)\n\t\tn.setPlatform(\"linux\")\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\to(w.getBounds()).deepEquals({\n\t\t\trect: {\n\t\t\t\theight: 0,\n\t\t\t\twidth: 0,\n\t\t\t\tx: 0,\n\t\t\t\ty: 0,\n\t\t\t},\n\t\t\tfullscreen: false,\n\t\t\tscale: 1,\n\t\t})\n\t\tw.setBounds({\n\t\t\trect: {\n\t\t\t\twidth: 1,\n\t\t\t\theight: 1,\n\t\t\t\tx: 1,\n\t\t\t\ty: 1,\n\t\t\t},\n\t\t\tfullscreen: false,\n\t\t\tscale: 2,\n\t\t})\n\t\to(w.getBounds()).deepEquals({\n\t\t\trect: {\n\t\t\t\twidth: 1,\n\t\t\t\theight: 1,\n\t\t\t\tx: 1,\n\t\t\t\ty: 1,\n\t\t\t},\n\t\t\tfullscreen: false,\n\t\t\tscale: 1,\n\t\t})\n\t\tw.setBounds({\n\t\t\trect: {\n\t\t\t\twidth: 0,\n\t\t\t\theight: 0,\n\t\t\t\tx: 0,\n\t\t\t\ty: 0,\n\t\t\t},\n\t\t\tfullscreen: true,\n\t\t\tscale: 1,\n\t\t})\n\t\to(w.getBounds()).deepEquals({\n\t\t\trect: {\n\t\t\t\twidth: 1,\n\t\t\t\theight: 1,\n\t\t\t\tx: 1,\n\t\t\t\ty: 1,\n\t\t\t},\n\t\t\tfullscreen: true,\n\t\t\tscale: 1,\n\t\t})\n\t\tw.setBounds({\n\t\t\trect: {\n\t\t\t\twidth: 0,\n\t\t\t\theight: 0,\n\t\t\t\tx: 0,\n\t\t\t\ty: 0,\n\t\t\t},\n\t\t\tfullscreen: false,\n\t\t\tscale: 0.5,\n\t\t})\n\t\telectronMock.BrowserWindow.mockedInstances[0].bounds = {\n\t\t\twidth: 0,\n\t\t\theight: 0,\n\t\t\tx: 0,\n\t\t\ty: 10,\n\t\t}\n\t\tawait delay(250)\n\t\t// this is needed because of linux DEs moving windows after the fact and us correcting it\n\t\t// see ApplicationWindow.js\n\t\to(w.getBounds()).deepEquals({\n\t\t\trect: {\n\t\t\t\twidth: 0,\n\t\t\t\theight: 0,\n\t\t\t\tx: 0,\n\t\t\t\ty: -10,\n\t\t\t},\n\t\t\tfullscreen: false,\n\t\t\tscale: 1,\n\t\t})\n\t})\n\n\to.test(\"findInPage, setSearchOverlayState & stopFindInPage\", function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tconst wcMock = electronMock.BrowserWindow.mockedInstances[0].webContents\n\t\tw.stopFindInPage()\n\t\to(wcMock.stopFindInPage.callCount).equals(1)\n\t\to(wcMock.stopFindInPage.args[0]).equals(\"keepSelection\")\n\t\tw.findInPage(\"searchTerm\", false, false, true)\n\t\to(wcMock.findInPage.callCount).equals(1)\n\t\to(wcMock.findInPage.args[0]).equals(\"searchTerm\")\n\t\to(wcMock.findInPage.args[1]).deepEquals({\n\t\t\tforward: false,\n\t\t\tmatchCase: false,\n\t\t\tfindNext: true,\n\t\t})\n\t\to(wcMock.stopFindInPage.callCount).equals(1)\n\t\to(wcMock.stopFindInPage.args[0]).equals(\"keepSelection\")\n\t\t// enter keys get caught\n\t\twcMock.callbacks[\"before-input-event\"](\n\t\t\t{},\n\t\t\t{\n\t\t\t\ttype: \"keyDown\",\n\t\t\t\tkey: \"Enter\",\n\t\t\t},\n\t\t)\n\t\to(wcMock.findInPage.callCount).equals(2)\n\t\to(wcMock.findInPage.args[1]).deepEquals({\n\t\t\tforward: true,\n\t\t\tmatchCase: false,\n\t\t\tfindNext: true,\n\t\t})\n\t\t// don't react to key when search overlay is unfocused\n\t\tw.setSearchOverlayState(false, true)\n\t\twcMock.callbacks[\"before-input-event\"](\n\t\t\t{},\n\t\t\t{\n\t\t\t\ttype: \"keyDown\",\n\t\t\t\tkey: \"Enter\",\n\t\t\t},\n\t\t)\n\t\to(wcMock.findInPage.callCount).equals(2)\n\t\t// empty search term shouldn't be searched\n\t\tw.findInPage(\"\", false, false, true)\n\t\to(wcMock.findInPage.callCount).equals(2)\n\t\to(wcMock.findInPage.args[0]).equals(\"searchTerm\")\n\t\to(wcMock.findInPage.args[1]).deepEquals({\n\t\t\tforward: true,\n\t\t\tmatchCase: false,\n\t\t\tfindNext: true,\n\t\t})\n\t\to(wcMock.stopFindInPage.callCount).equals(2)\n\t\to(wcMock.stopFindInPage.args[0]).equals(\"keepSelection\")\n\t})\n\n\to.test(\"show\", function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tconst bwMock = electronMock.BrowserWindow.mockedInstances[0]\n\t\to(bwMock.devToolsOpened).equals(false)\n\t\tw.show()\n\t\to(bwMock.devToolsOpened).equals(false)\n\t\to(bwMock.show.callCount).equals(1)\n\t\tbwMock.devToolsOpened = true\n\t\tw.show()\n\t\to(bwMock.devToolsOpened).equals(true)\n\t\to(bwMock.show.callCount).equals(2)\n\t\tbwMock.devToolsOpened = false\n\t\tbwMock.minimized = true\n\t\tw.show()\n\t\to(bwMock.devToolsOpened).equals(false)\n\t\to(bwMock.restore.callCount).equals(1)\n\t\tbwMock.devToolsOpened = true\n\t\tw.show()\n\t\to(bwMock.devToolsOpened).equals(true)\n\t\to(bwMock.restore.callCount).equals(2)\n\t\tbwMock.focused = false\n\t\tw.show()\n\t\to(bwMock.focus.callCount).equals(0)\n\t\to(bwMock.restore.callCount).equals(3)\n\t\tbwMock.minimized = false\n\t\tw.show()\n\t\to(bwMock.focus.callCount).equals(1)\n\t\to(bwMock.restore.callCount).equals(3)\n\t})\n\to.test(\"on, once, getTitle, setZoomFactor, isFullScreen, isMinimized, minimize, hide, center, showInactive, isFocused\", function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\n\t\tlet f = () => {}\n\n\t\tw.on(downcast(\"one-event\"), f)\n\t\to(bwInstance.on.callCount).equals(4) // initial + now\n\n\t\to(bwInstance.on.args[0]).equals(\"one-event\")\n\t\to(bwInstance.on.args[1]).equals(f)\n\t\tw.once(downcast(\"two-event\"), f)\n\t\to(bwInstance.once.callCount).equals(1)\n\t\to(bwInstance.once.args[0]).equals(\"two-event\")\n\t\to(bwInstance.once.args[1]).equals(f)\n\t\to(w.getTitle()).equals(\"webContents Title\")\n\t\to(bwInstance.webContents.getTitle.callCount).equals(1)\n\t\to(bwInstance.webContents.getTitle.args).deepEquals([])\n\t\tw.setZoomFactor(42.42)\n\t\to(bwInstance.webContents.zoomFactor).equals(42.42)\n\t\to(w.isFullScreen()).equals(false)\n\t\to(bwInstance.isFullScreen.callCount).equals(1)\n\t\to(w.isMinimized()).equals(false)\n\t\to(bwInstance.isMinimized.callCount).equals(1)\n\t\tw.minimize()\n\t\to(bwInstance.minimize.callCount).equals(1)\n\t\tw.hide()\n\t\to(bwInstance.hide.callCount).equals(1)\n\t\tw.center()\n\t\to(bwInstance.center.callCount).equals(1)\n\t\tw.showInactive()\n\t\to(bwInstance.showInactive.callCount).equals(1)\n\t\to(w.isFocused()).equals(true)\n\t\to(bwInstance.isFocused.callCount).equals(1)\n\t})\n\n\to.test(\"when closing, windowCleanup.onCleanup is called\", function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge, windowCleanup } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tconst userId = \"123\"\n\t\tw.setUserId(userId)\n\t\tconst bwInstance = electronMock.BrowserWindow.mockedInstances[0]\n\t\t;(bwInstance as any).callbacks[\"closed\"]()\n\n\t\tverify(windowCleanup.onCleanup(userId))\n\t})\n\n\to.test(\"when reloading, windowCleanup.onCleanup is called\", async function () {\n\t\tconst { electronMock, wmMock, electronLocalshortcutMock, themeFacade, remoteBridge, windowCleanup } = standardMocks()\n\n\t\tconst w = new ApplicationWindow(wmMock, desktopHtml, icon, electronMock, electronLocalshortcutMock, themeFacade, remoteBridge)\n\t\tconst userId = \"123\"\n\t\tw.setUserId(userId)\n\n\t\tawait w.reload({})\n\n\t\tverify(windowCleanup.onCleanup(userId))\n\t})\n})\n"],"mappings":"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"}