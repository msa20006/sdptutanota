
globalThis.env = {
  "staticUrl": "http://localhost:9000",
  "versionNumber": "264.250130.1",
  "dist": false,
  "mode": "Test",
  "timeout": 20000,
  "domainConfigs": {
    "mail.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.tuta.com",
      "apiUrl": "https://mail.tutanota.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "test.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.test.tuta.com",
      "apiUrl": "https://test.tutanota.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://test.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://tutanota.com"
    },
    "app.local.tutanota.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tuta.com:9000",
      "apiUrl": "https://app.local.tutanota.com:9000",
      "paymentUrl": "https://local.tutanota.com:9000/client/build/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/client/build/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/client/build/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/client/build/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/client/build/webauthnmobile",
      "webauthnRpId": "tutanota.com",
      "u2fAppId": "https://local.tutanota.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tutanota.com:9000"
    },
    "app.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://mail.tutanota.com",
      "apiUrl": "https://app.tuta.com",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://mail.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://mail.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "app.test.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://test.tutanota.com",
      "apiUrl": "https://app.test.tuta.com",
      "paymentUrl": "https://pay.test.tutanota.com/braintree.html",
      "webauthnUrl": "https://app.test.tuta.com/webauthn",
      "legacyWebauthnUrl": "https://test.tutanota.com/webauthn",
      "webauthnMobileUrl": "https://app.test.tuta.com/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://test.tutanota.com/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.test.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.test.tuta.com/giftcard",
      "referralBaseUrl": "https://app.test.tuta.com/signup",
      "websiteBaseUrl": "https://test.tuta.com"
    },
    "app.local.tuta.com": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "https://app.local.tutanota.com:9000",
      "apiUrl": "https://app.local.tuta.com:9000",
      "paymentUrl": "https://app.local.tuta.com:9000/braintree.html",
      "webauthnUrl": "https://app.local.tuta.com:9000/webauthn",
      "legacyWebauthnUrl": "https://local.tutanota.com:9000/webauthn",
      "webauthnMobileUrl": "https://app.local.tuta.com:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "https://local.tutanota.com:9000/webauthnmobile",
      "webauthnRpId": "tuta.com",
      "u2fAppId": "https://app.local.tuta.com/u2f-appid.json",
      "giftCardBaseUrl": "https://app.local.tuta.com:9000/giftcard",
      "referralBaseUrl": "https://app.local.tuta.com:9000/signup",
      "websiteBaseUrl": "https://local.tuta.com:9000"
    },
    "localhost": {
      "firstPartyDomain": true,
      "partneredDomainTransitionUrl": "http://localhost:9000",
      "apiUrl": "http://localhost:9000",
      "paymentUrl": "http://localhost:9000/braintree.html",
      "webauthnUrl": "http://localhost:9000/webauthn",
      "legacyWebauthnUrl": "http://localhost:9000/webauthn",
      "webauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "legacyWebauthnMobileUrl": "http://localhost:9000/webauthnmobile",
      "webauthnRpId": "localhost",
      "u2fAppId": "http://localhost:9000/u2f-appid.json",
      "giftCardBaseUrl": "http://localhost:9000/giftcard",
      "referralBaseUrl": "http://localhost:9000/signup",
      "websiteBaseUrl": "https://tuta.com"
    },
    "{hostname}": {
      "firstPartyDomain": false,
      "partneredDomainTransitionUrl": "{protocol}//{hostname}",
      "apiUrl": "{protocol}//{hostname}",
      "paymentUrl": "https://pay.tutanota.com/braintree.html",
      "webauthnUrl": "{protocol}//{hostname}/webauthn",
      "legacyWebauthnUrl": "{protocol}//{hostname}/webauthn",
      "webauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "legacyWebauthnMobileUrl": "{protocol}//{hostname}/webauthnmobile",
      "webauthnRpId": "{hostname}",
      "u2fAppId": "{protocol}//{hostname}/u2f-appid.json",
      "giftCardBaseUrl": "https://app.tuta.com/giftcard",
      "referralBaseUrl": "https://app.tuta.com/signup",
      "websiteBaseUrl": "https://tuta.com"
    }
  },
  "platformId": null
};
const __NODE_GYP_better_sqlite3 = `./better-sqlite3.darwin-${typeof process !== 'undefined' ? process.arch : "unknown"}.node`
import { mapNullable, uint8ArrayToHex } from "./dist-CJHwsXKY.js";
import { ProgrammingError } from "./ProgrammingError-D8yJGVtm.js";
import { CryptoError } from "./CryptoError-PqdvQky4.js";
import { OfflineDbClosedError } from "./OfflineDbClosedError-CAwHTI6J.js";
import { tagSqlObject, untagSqlValue } from "./SqlValue-CkGu32Qd.js";
import { index } from "./better-sqlite3-BmG0PAc2.js";

//#region ../src/common/desktop/db/DesktopSqlCipher.ts
var DesktopSqlCipher = class {
	_db = null;
	get db() {
		if (this._db == null) throw new OfflineDbClosedError();
		return this._db;
	}
	/**
	* @param nativeBindingPath the path to the sqlite native module
	* @param dbPath the path to the database file to use
	* @param integrityCheck whether to check the integrity of the db file during initialization
	*/
	constructor(nativeBindingPath, dbPath, integrityCheck) {
		this.nativeBindingPath = nativeBindingPath;
		this.dbPath = dbPath;
		this.integrityCheck = integrityCheck;
		process.on("exit", () => this._db?.close());
	}
	async openDb(userId, dbKey) {
		this._db = new index(this.dbPath, { nativeBinding: this.nativeBindingPath });
		try {
			this.initSqlcipher({
				databaseKey: dbKey,
				enableMemorySecurity: true,
				integrityCheck: this.integrityCheck
			});
		} catch (e) {
			this.db.close();
			this._db = null;
			throw e;
		}
	}
	async closeDb() {
		try {
			this.db.pragma("incremental_vacuum");
		} finally {
			this.db.close();
			this._db = null;
		}
	}
	/**
	* not implemented because we delete the DB directly from the per-window facade
	*/
	deleteDb(userId) {
		throw new ProgrammingError("Not implemented");
	}
	/**
	* Initialise sqlcipher with a database key, configuration:
	* - Sqlcipher always uses aes-256 for encryption.
	* - Sqlcipher always creates per page hmac for integrity with sha512.
	* - Sqlcipher generates a database salt value randomly and stores in the first 16 bytes of the database.
	* - We pass the database key directly to sqlcipher rather than using a password and therefore do not configure key derivation.
	* - we assume that adding entropy to entropy pool of the crypto provide (cipher_add_random) "is not necessary [...], since [openssl] does (re-)seed itself automatically using trusted system entropy sources", https://www.openssl.org/docs/man1.1.1/man3/RAND_add.html
	* @param databaseKey
	* @param enableMemorySecurity if true the the memory security option (that was default until 4.5, https://www.zetetic.net/blog/2021/10/28/sqlcipher-4.5.0-release/) to wipe memory allocated by SQLite internally, including the page cache is enabled.
	* @param integrityCheck: if true the hmac stored with each page of the database is verified to detect modification.
	* @throws if an error is detected during the integrity check
	*/
	initSqlcipher({ databaseKey, enableMemorySecurity, integrityCheck }) {
		if (enableMemorySecurity) this.db.pragma("cipher_memory_security = ON");
		const key = `x'${uint8ArrayToHex(databaseKey)}'`;
		this.db.pragma(`KEY = "${key}"`);
		if (this.db.pragma("auto_vacuum", { simple: true }) != 2) {
			this.db.pragma("auto_vacuum = incremental");
			this.db.pragma("vacuum");
		}
		if (integrityCheck) this.checkIntegrity();
	}
	/**
	* Execute a query
	*/
	async run(query, params) {
		this.db.prepare(query).run(params.map(untagSqlValue));
	}
	/**
	* Execute a query
	* @returns a single object or undefined if the query returns nothing
	*/
	async get(query, params) {
		const result = this.db.prepare(query).get(params.map(untagSqlValue)) ?? null;
		return mapNullable(result, tagSqlObject);
	}
	/**
	* Execute a query
	* @returns a list of objects or an empty list if the query returns nothing
	*/
	async all(query, params) {
		const result = this.db.prepare(query).all(params.map(untagSqlValue));
		return result.map(tagSqlObject);
	}
	/**
	* not implemented because we lock the "ranges" DB directly from the per-window facade
	* we return Promise.resolve() in order to allow testing of the "clearExcludedData" function
	*/
	lockRangesDbAccess(userId) {
		return Promise.resolve();
	}
	/**
	* not implemented because we unlock the "ranges" DB directly from the per-window facade
	* we return Promise.resolve() in order to allow testing of the "clearExcludedData" function
	*/
	unlockRangesDbAccess(userId) {
		return Promise.resolve();
	}
	checkIntegrity() {
		/**
		* Throws a CryptoError if MAC verification fails
		*/
		const errors = this.db.pragma("cipher_integrity_check");
		if (errors.length > 0) throw new CryptoError(`Integrity check failed with result : ${JSON.stringify(errors)}`);
	}
};

//#endregion
export { DesktopSqlCipher };
//# sourceMappingURL=DesktopSqlCipher-BloqMDJx.js.map